<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>【51NOD刷题】1283 最小周长</title>
    <url>/posts/37987.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p><a href="http://www.51nod.com/onlineJudge/questionCode.html#!problemId=1283"><strong>1283 最小周长</strong></a><br>题目来源： Codility<br>基准时间限制：1 秒 空间限制：131072 KB 分值: 5 难度：1级算法题<br>一个矩形的面积为S，已知该矩形的边长都是整数，求所有满足条件的矩形中，周长的最小值。例如：S = 24，那么有{1 24} {2 12} {3 8} {4 6}这4种矩形，其中{4 6}的周长最小，为20。</p>
<span id="more"></span>
<h2 id="输入输出"><a href="#输入输出" class="headerlink" title="输入输出"></a>输入输出</h2><p><strong>Input</strong><br>输入1个数S(1 &lt;= S &lt;= 10^9)。</p>
<p><strong>Output</strong><br>输出最小周长。</p>
<p><strong>Input示例</strong></p>
<blockquote>
<p>24</p>
</blockquote>
<p><strong>Output示例</strong></p>
<blockquote>
<p>20</p>
</blockquote>
<h2 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h2><p>这个题可以说是相当眼熟了，相比在过去的义务教育期间一定做过类似的题目，只不过题目并没有要求矩形的边长是整数。<br>我们按照边长不一定是整数做一次推倒：<br>设矩形的长和宽分别是x、y，已知举行的面积为S，求周长l的最小值。</p>
<p>$S=x*y$</p>
<p>$l=2(x+y)&gt;=4\sqrt{xy}=4\sqrt{S}$</p>
<p>$l&gt;=4\sqrt{S}$</p>
<p>所以若不要求边长为整数，则最小周长为$4\sqrt{S}$。</p>
<p>当要求边长为整数时，对S开二次根的到数字w，找到在比w小的整数中，用S可以整除的最大的数，此时的w和S/w组成的矩形则为最小周长。</p>
<h2 id="Accepted"><a href="#Accepted" class="headerlink" title="Accepted"></a>Accepted</h2><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Sum</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> s = Convert.ToInt32(Console.ReadLine());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> w = Math.Sqrt(s);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = (<span class="built_in">int</span>)w; i &gt; <span class="number">0</span>; i--)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> res = s * <span class="number">1.0</span> / i;</span><br><span class="line">            <span class="keyword">if</span> (!(Math.Abs(res - (<span class="built_in">int</span>) res) &lt; <span class="number">0.000001</span>)) <span class="keyword">continue</span>;</span><br><span class="line">            Console.WriteLine((<span class="built_in">int</span>)((i + res) * <span class="number">2</span>));</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>算法刷题</category>
      </categories>
      <tags>
        <tag>51NOD</tag>
        <tag>刷题</tag>
        <tag>C#</tag>
      </tags>
  </entry>
  <entry>
    <title>C# TextBox Ctrl+A全选</title>
    <url>/posts/15970.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>Winform程序中光标在TextBox控件中时按下 Ctrl + A 快捷键，并不能选中全部文字，而是会发出警告音。本文给出实现方法。</p>
<span id="more"></span>
<p>在TextBox控件中使用快捷键，一般要求按下快捷键立刻产生效果，KeyUp事件显然不符合我们的要求，而KeyPress事件中不支持使用组合件，所以我们选用KeyDown事件，具体代码实现如下：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">tBBefore_KeyDown</span>(<span class="params"><span class="built_in">object</span> sender, KeyEventArgs e</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (e.Control &amp;&amp; e.KeyCode == Keys.A)</span><br><span class="line">    &#123;</span><br><span class="line">        ((TextBox)sender).SelectAll();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
      <tags>
        <tag>Winform</tag>
      </tags>
  </entry>
  <entry>
    <title>C# 发展历史</title>
    <url>/posts/46320.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>本文是从<span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC93aGF0cy1uZXcvY3NoYXJwLXZlcnNpb24taGlzdG9yeQ==">官方文档<i class="fa fa-external-link-alt"></i></span>加以摘录和修改而来，在语言版本的节点加入了对应框架版本的主要特征，主要用作记录以备作者自己查阅。<br>本页介绍了 C# 语言每个主要版本的发展历史。 C# 团队将继续创新，以添加新功能。 可以在 GitHub 上的 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2RvdG5ldC9yb3NseW4vYmxvYi9tYWluL2RvY3MvTGFuZ3VhZ2UlMjBGZWF0dXJlJTIwU3RhdHVzLm1k">dotnet/roslyn 存储库<i class="fa fa-external-link-alt"></i></span>上找到详细的语言功能状态，包括考虑在即将发布的版本中添加的功能。</p>
<span id="more"></span>
<blockquote>
<p><strong>重要</strong><br>为了提供一些功能，C# 语言依赖 C# 规范定义为标准库 所用的类型和方法。 .NET 平台通过许多包交付这些类型和方法。 例如，异常处理。 为了确保引发的对象派生自 <span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2FwaS9zeXN0ZW0uZXhjZXB0aW9u">Exception<i class="fa fa-external-link-alt"></i></span>，将会检查每个 throw 语句或表达式。 同样，还会检查每个 catch，以确保捕获的类型派生自 Exception。 每个版本都可能会新增要求。 若要在旧版环境中使用最新语言功能，可能需要安装特定库。 每个特定版本的页面中记录了这些依赖项。 若要了解此依赖项的背景信息，可以详细了解<span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC93aGF0cy1uZXcvcmVsYXRpb25zaGlwcy1iZXR3ZWVuLWxhbmd1YWdlLWFuZC1saWJyYXJ5">语言与库的关系<i class="fa fa-external-link-alt"></i></span>。</p>
</blockquote>
<h1 id="总览"><a href="#总览" class="headerlink" title="总览"></a>总览</h1><p><img data-src="http://qiniucdn.wayneshao.com/20220222073902307.png"><br>下图是总结了 C# 语言从发布到现在的各个版本和相应的发布时间、框架版本、VS版本<br>注意：<strong>C# 7.1 版本开始增加了<span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9sYW5ndWFnZS1yZWZlcmVuY2UvY29uZmlndXJlLWxhbmd1YWdlLXZlcnNpb24=">语言版本选择<i class="fa fa-external-link-alt"></i></span>配置元素，可以开始直接控制 C# 版本，所以从这个版本开始，要求一栏展示的是默认版本</strong></p>
<table>
<thead>
<tr>
<th align="center">语言版本</th>
<th align="center">发布时间</th>
<th align="center">框架版本</th>
<th align="center">CLR 版本</th>
<th align="center">Visual Studio 版本</th>
</tr>
</thead>
<tbody><tr>
<td align="center">C# 1.0</td>
<td align="center">2002.2.13</td>
<td align="center">.NET Framework 1.0</td>
<td align="center">CLR 1.0</td>
<td align="center">Visual Studio 2002 / Visual Studio 7</td>
</tr>
<tr>
<td align="center">C# 1.2</td>
<td align="center">2003.4.24</td>
<td align="center">.NET Framework 1.1</td>
<td align="center">CLR 1.1</td>
<td align="center">Visual Studio 2003</td>
</tr>
<tr>
<td align="center">C# 2.0</td>
<td align="center">2005.11.7</td>
<td align="center">.NET Framework 2.0</td>
<td align="center">CLR 2.0</td>
<td align="center">Visual Studio 2005</td>
</tr>
<tr>
<td align="center">C# 3.0-（不含Linq）</td>
<td align="center">2006.11.6</td>
<td align="center">.NET Framework 3.0</td>
<td align="center">CLR 2.0</td>
<td align="center">Visual Studio 2005</td>
</tr>
<tr>
<td align="center">C# 3.0</td>
<td align="center">2007.11.19</td>
<td align="center">.NET Framework 3.5</td>
<td align="center">CLR 2.0</td>
<td align="center">Visual Studio 2008</td>
</tr>
<tr>
<td align="center">C# 4.0</td>
<td align="center">2010.4.12</td>
<td align="center">.NET Framework 4.0</td>
<td align="center">CLR 4</td>
<td align="center">Visual Studio 2010</td>
</tr>
<tr>
<td align="center">C# 5.0</td>
<td align="center">2012.8.15</td>
<td align="center">.NET Framework 4.5</td>
<td align="center">CLR 4</td>
<td align="center">Visual Studio 2012</td>
</tr>
<tr>
<td align="center">C# 5.0</td>
<td align="center">2013.10.17</td>
<td align="center">.NET Framework 4.5.1</td>
<td align="center">CLR 4</td>
<td align="center">Visual Studio 2013</td>
</tr>
<tr>
<td align="center">C# 5.0</td>
<td align="center">2014.5.5</td>
<td align="center">.NET Framework 4.5.2</td>
<td align="center">CLR 4</td>
<td align="center">Visual Studio 2013</td>
</tr>
<tr>
<td align="center">C# 6.0</td>
<td align="center">2015.7.20</td>
<td align="center">.NET Framework 4.6</td>
<td align="center">CLR 4</td>
<td align="center">Visual Studio 2015</td>
</tr>
<tr>
<td align="center">C# 6.0</td>
<td align="center">2015.11.30</td>
<td align="center">.NET Framework 4.6.1</td>
<td align="center">CLR 4</td>
<td align="center">Visual Studio 2015</td>
</tr>
<tr>
<td align="center">C# 6.0</td>
<td align="center">2016.6.27</td>
<td align="center">.NET Core 1.0</td>
<td align="center">CoreCLR 1.0</td>
<td align="center">Visual Studio 2015</td>
</tr>
<tr>
<td align="center">C# 7.0</td>
<td align="center">2016.8.2</td>
<td align="center">.NET Framework 4.6.2</td>
<td align="center">CLR 4</td>
<td align="center">Visual Studio 2017</td>
</tr>
<tr>
<td align="center">C# 7.0</td>
<td align="center">2016.11.16</td>
<td align="center">.NET Core 1.1</td>
<td align="center">CoreCLR 1.1</td>
<td align="center">Visual Studio 2017</td>
</tr>
<tr>
<td align="center">C# 7.1</td>
<td align="center">2017.4.5</td>
<td align="center">.NET Framework 4.7</td>
<td align="center">CLR 4</td>
<td align="center">Visual Studio 2017 v15.3</td>
</tr>
<tr>
<td align="center">C# 7.1</td>
<td align="center">2017.8.14</td>
<td align="center">.NET Core 2.0</td>
<td align="center">CoreCLR 2.0</td>
<td align="center">Visual Studio 2017 v15.3</td>
</tr>
<tr>
<td align="center">C# 7.2</td>
<td align="center">2017.10.17</td>
<td align="center">.NET Framework 4.7.1</td>
<td align="center">CLR 4</td>
<td align="center">Visual Studio 2017 v15.5</td>
</tr>
<tr>
<td align="center">C# 7.2</td>
<td align="center">2018.5.30</td>
<td align="center">.NET Core 2.1</td>
<td align="center">CoreCLR 2.1</td>
<td align="center">Visual Studio 2017 v15.7</td>
</tr>
<tr>
<td align="center">C# 7.3</td>
<td align="center">2018.4.30</td>
<td align="center">.NET Framework 4.7.2</td>
<td align="center">CLR4</td>
<td align="center">Visual Studio 2017 v15.7</td>
</tr>
<tr>
<td align="center">C# 7.3</td>
<td align="center">2018.12.4</td>
<td align="center">.NET Core 2.2</td>
<td align="center">CoreCLR 2.2</td>
<td align="center">Visual Studio 2017 v15.7</td>
</tr>
<tr>
<td align="center">C# 8.0</td>
<td align="center">2019.4.18</td>
<td align="center">.NET Framework 4.8</td>
<td align="center">CLR 4</td>
<td align="center">Visual Studio 2019</td>
</tr>
<tr>
<td align="center">C# 8.0</td>
<td align="center">2019.9.23</td>
<td align="center">.NET Core 3.0</td>
<td align="center">CoreCLR 3.0</td>
<td align="center">Visual Studio 2019</td>
</tr>
<tr>
<td align="center">C# 8.0</td>
<td align="center">2019.12.3</td>
<td align="center">.NET Core 3.1</td>
<td align="center">CoreCLR 3.1</td>
<td align="center">Visual Studio 2019 v16.4</td>
</tr>
<tr>
<td align="center">C# 9.0</td>
<td align="center">2020.11.10</td>
<td align="center">.NET 5.0</td>
<td align="center">CoreCLR 5</td>
<td align="center">Visual Studio 2019 v16.8</td>
</tr>
<tr>
<td align="center">C# 10.0</td>
<td align="center">2021.11.8</td>
<td align="center">.NET 6.0</td>
<td align="center">CoreCLR 6</td>
<td align="center">Visual Studio 2022</td>
</tr>
<tr>
<td align="center">C# 11</td>
<td align="center">/</td>
<td align="center">.NET 7.0</td>
<td align="center"></td>
<td align="center">/</td>
</tr>
</tbody></table>
<h1 id="版本详情"><a href="#版本详情" class="headerlink" title="版本详情"></a>版本详情</h1><h2 id="2002-2003：Framework-1-0-C-1-x"><a href="#2002-2003：Framework-1-0-C-1-x" class="headerlink" title="2002-2003：Framework 1.0 + C# 1.x"></a>2002-2003：Framework 1.0 + C# 1.x</h2><p>　　在 .NET 出现之前，编写 Windows 上可以运行的程序都是要直接和 COM（微软的一套软件的接口标准） 打交道。 <strong>.NET 框架试图通过 CLR 代替 COM，并提供更多功能，令用户可以更轻松的使用 Windows 的资源进行软件开发。</strong><br>　　2002 年微软推出了 .NET Framework 1.0，相应的 Visual Studio 也升级到 7，称为 Visual Studio 2002（上一个版本叫做 Visual Studio 6）。该框架包含了 C# 和 VB.NET。同时，<strong>第一个版本的 ASP.NET 也在 .NET Framework 1.0 亮相，它作为网站的解决方案，一直是 .NET Framework 最重要的产品线之一。</strong></p>
<h3 id="C-1-0"><a href="#C-1-0" class="headerlink" title="C# 1.0"></a>C# 1.0</h3><p>回想起来，和 Visual Studio .NET 2002 一起发布的 C# 版本 1.0 非常像 Java。 作为 <span class="exturl" data-url="aHR0cHM6Ly9mZWVsZG90bmV0ZWFzeS5ibG9nc3BvdC5jb20vMjAxMS8wMS9jLWRlc2lnbi1nb2Fscy5odG1s">ECMA 既定设计目标的一部分<i class="fa fa-external-link-alt"></i></span>，其目标是成为一种 “简单、现代、通用的面向对象的语言”。当时，看起来像 Java 意味着它实现了早期的设计目标。</p>
<p>不过如果现在回顾 C# 1.0，你会觉得有点晕。 它没有习以为常的内置异步功能和以泛型为中心的巧妙功能。 其实它完全不具备泛型。 那 <span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9saW5xLw==">LINQ<i class="fa fa-external-link-alt"></i></span> 呢？ 尚不可用。 这些新增内容需要几年才能推出。</p>
<p>与现在的 C# 相比，C# 1.0 版少了很多功能。 你会发现自己的代码很冗长。 不过凡事总要有个开始。 在 Windows 平台上，C# 1.0 版是 Java 的一个可行的替代之选。</p>
<p>C# 1.0 的主要功能包括：</p>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9mdW5kYW1lbnRhbHMvdHlwZXMvY2xhc3Nlcw==">类<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9sYW5ndWFnZS1yZWZlcmVuY2UvYnVpbHRpbi10eXBlcy9zdHJ1Y3Q=">结构<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9mdW5kYW1lbnRhbHMvdHlwZXMvaW50ZXJmYWNlcw==">接口<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9ldmVudHMtb3ZlcnZpZXc=">事件<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9wcm9wZXJ0aWVz">属性<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9kZWxlZ2F0ZXMtb3ZlcnZpZXc=">委托<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9sYW5ndWFnZS1yZWZlcmVuY2Uvb3BlcmF0b3JzLw==">运算符和表达式<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9wcm9ncmFtbWluZy1ndWlkZS9zdGF0ZW1lbnRzLWV4cHJlc3Npb25zLW9wZXJhdG9ycy9zdGF0ZW1lbnRz">语句<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9wcm9ncmFtbWluZy1ndWlkZS9jb25jZXB0cy9hdHRyaWJ1dGVzLw==">特性<i class="fa fa-external-link-alt"></i></span></li>
</ul>
<h3 id="C-1-2"><a href="#C-1-2" class="headerlink" title="C# 1.2"></a>C# 1.2</h3><p>随 Visual Studio .NET 2003 一起提供的 C# 版本 1.2。 它对语言做了一些小改进。 最值得注意的是，从此版本开始，当 IEnumerator 实现 IDisposable 时，foreach 循环中生成的代码会在 IEnumerator 上调用 Dispose。</p>
<h2 id="2005：Framework-2-0-C-2-0"><a href="#2005：Framework-2-0-C-2-0" class="headerlink" title="2005：Framework 2.0 + C# 2.0"></a>2005：Framework 2.0 + C# 2.0</h2><p>2005年11月.NET Framework 2.0 发布。该框架包括了 C# 2.0，相比第一代添加了新的语法特征，其中最重要的就是泛型。<br>与此同时，CLR 的版本也相应的更新为 2.0，Visual Studio 也升级到 Visual Studio 2005。<br>.NET Framework 2.0 中，Web 应用解决方案仍然是 ASP.NET WebForm，WinForm 则作为 Windows 下的应用解决方案，数据库组件 ADO.NET 已经支持了 SQL Server 和 Oracle，Web Service的应用也多种多样，包括 .NET Remoting（TCP/HTTP/Pipeline communication）以及基础的Winsock等。</p>
<h3 id="C-2-0"><a href="#C-2-0" class="headerlink" title="C# 2.0"></a>C# 2.0</h3><p>从此以后事情变得有趣起来。 让我们看看 C# 2.0（2005 年发布）和 Visual Studio 2005 中的一些主要功能：</p>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9mdW5kYW1lbnRhbHMvdHlwZXMvZ2VuZXJpY3M=">泛型<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9wcm9ncmFtbWluZy1ndWlkZS9jbGFzc2VzLWFuZC1zdHJ1Y3RzL3BhcnRpYWwtY2xhc3Nlcy1hbmQtbWV0aG9kcyNwYXJ0aWFsLWNsYXNzZXM=">分部类型<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9sYW5ndWFnZS1yZWZlcmVuY2Uvb3BlcmF0b3JzL2RlbGVnYXRlLW9wZXJhdG9y">匿名方法<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9sYW5ndWFnZS1yZWZlcmVuY2UvYnVpbHRpbi10eXBlcy9udWxsYWJsZS12YWx1ZS10eXBlcw==">可以为 null 的值类型<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9wcm9ncmFtbWluZy1ndWlkZS9jb25jZXB0cy9pdGVyYXRvcnM=">迭代器<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9wcm9ncmFtbWluZy1ndWlkZS9jb25jZXB0cy9jb3ZhcmlhbmNlLWNvbnRyYXZhcmlhbmNlLw==">协变和逆变<i class="fa fa-external-link-alt"></i></span></li>
</ul>
<p>除现有功能以外的其他 C# 2.0 功能：</p>
<ul>
<li>getter/setter 单独可访问性</li>
<li>方法组转换（委托）</li>
<li>静态类</li>
<li>委托推断</li>
</ul>
<p>C# 一开始是面向对象的 (OO) 通用语言，而 C# 2.0 版很快改变了这一点。 做好基础准备后，他们开始追求解决一些严重影响开发者的难点。 且他们以显著的方式追求这些难点。</p>
<p>通过泛型，类型和方法可以操作任意类型，同时保持类型安全性。 例如，通过 <code>List&lt;T&gt;</code>，将获得 <code>List&lt;string&gt;</code> 或 <code>List&lt;int&gt;</code> 并且可以对这些字符串或整数执行类型安全操作，同时对其进行循环访问。 使用泛型优于创建派生自 <code>ArrayList</code> 的 <code>ListInt</code> 类型，也优于从每个操作的 <code>Object</code> 强制转换。</p>
<p>C# 2.0 版<strong>引入了迭代器</strong>。 简单来说，迭代器允许使用 <code>foreach</code> 循环来检查 <code>List（或其他可枚举类型）</code>中的所有项。 拥有迭代器是该语言最重要的一部分，显著提升了语言的可读性以及人们推出代码的能力。</p>
<p><strong>不过 C# 依然在追赶 Java 的道路上。</strong>当时 Java 已发布包含泛型和迭代器的版本。 但是随着语言各自的演化，形势很快发生了变化。</p>
<h2 id="2006：Framework-3-0-C-3-0-（不含-Linq）"><a href="#2006：Framework-3-0-C-3-0-（不含-Linq）" class="headerlink" title="2006：Framework 3.0 + C# 3.0-（不含 Linq）"></a>2006：Framework 3.0 + C# 3.0-（不含 Linq）</h2><p>.NET Framework 3.0 是框架<strong>最重大的一次升级</strong>，包含了<strong>三大产品线</strong>：</p>
<ul>
<li>WCF 统一了过去 Web 服务混乱的形式，形成了一个统一标准。</li>
<li>WPF 作为前端用户界面的解决方案，依靠 Siverlight 甚至入侵了 Web 领域。</li>
<li>WF 提供工作流的管理。</li>
</ul>
<p>.NET 3.0 标志着 Windows 平台开始全面转向 .NET 时代，在此之后的所有 Windows 都预装了 .NET ，在此之前，预装 .NET 的只有 Windows 的服务器版本。<br>当时的 .NET 只能在 Windows 上运行，通过 CLR 调用 Windows 的 API，从而控制电脑硬件。</p>
<p>.NET 3.0 的 CLR 和 .NET 2.0 的相同。</p>
<h2 id="2007：Framework-3-5-C-3-0"><a href="#2007：Framework-3-5-C-3-0" class="headerlink" title="2007：Framework 3.5 + C# 3.0"></a>2007：Framework 3.5 + C# 3.0</h2><p>.NET Franework 3.5 集成了包含 Linq 在内的完整 C# 3，Linq无疑是当前版本最重要的功能。相应的，为了Linq，此版本也加入了扩展方法、Lambda 表达式等新功能。从 C# 3 开始，C# 不再是 Java 的一个跟班小弟，某种意义上实现了对 Java 的超越（Java 直到 2014 年才在 Java 8 中加入了 Lambda 表达式）。<br>另外，.NET 3.5 SP1 新增了 ADO.NET Entity Framework 取代 ADO.NET，作为 ORM 的解决档案。在 ADO.NET Entity Framework 发表之前，NHibernate 是在 .NET Framework 经常使用的 ORM 实现，顾名思义，它是 Hibernate 在 .NET Framework 上的实现。相应的 Visual Studio 也升级到了 Visual Studio 2008。</p>
<h3 id="C-3-0"><a href="#C-3-0" class="headerlink" title="C# 3.0"></a>C# 3.0</h3><p>C# 3.0 版和 Visual Studio 2008 一起发布于 2007 年下半年，但完整的语言功能是在 .NET Framework 3.5 版中发布的。 此版本标示着 C# 发展过程中的重大更改。 C# 成为了真正强大的编程语言。 我们来看看此版本中的一些主要功能：</p>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9wcm9ncmFtbWluZy1ndWlkZS9jbGFzc2VzLWFuZC1zdHJ1Y3RzL2F1dG8taW1wbGVtZW50ZWQtcHJvcGVydGllcw==">自动实现的属性<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9mdW5kYW1lbnRhbHMvdHlwZXMvYW5vbnltb3VzLXR5cGVz">匿名类型<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9saW5xL3F1ZXJ5LWV4cHJlc3Npb24tYmFzaWNz">查询表达式<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9sYW5ndWFnZS1yZWZlcmVuY2Uvb3BlcmF0b3JzL2xhbWJkYS1leHByZXNzaW9ucw==">Lambda 表达式<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9leHByZXNzaW9uLXRyZWVz">表达式树<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9wcm9ncmFtbWluZy1ndWlkZS9jbGFzc2VzLWFuZC1zdHJ1Y3RzL2V4dGVuc2lvbi1tZXRob2Rz">扩展方法<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9sYW5ndWFnZS1yZWZlcmVuY2Uva2V5d29yZHMvdmFy">隐式类型本地变量<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9sYW5ndWFnZS1yZWZlcmVuY2Uva2V5d29yZHMvcGFydGlhbC1tZXRob2Q=">分部方法<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9wcm9ncmFtbWluZy1ndWlkZS9jbGFzc2VzLWFuZC1zdHJ1Y3RzL29iamVjdC1hbmQtY29sbGVjdGlvbi1pbml0aWFsaXplcnM=">对象和集合初始值设定项<i class="fa fa-external-link-alt"></i></span></li>
</ul>
<p>回顾过去，这些功能中大多数似乎都是不可或缺，难以分割的。 它们的组合都是经过巧妙布局。 我们认为 C# 版本的杀手锏是查询表达式，也就是语言集成查询 (LINQ)。</p>
<p>LINQ 的构造可以建立在更细微的视图检查表达式树、Lambda 表达式以及匿名类型的基础上。 不过无论如何 C# 3.0 都提出了革命性的概念。 C# 3.0 开始为 C# 转变为面向对象 / 函数式混合语言打下基础。</p>
<p>具体来说，你现在可以编写 SQL 样式的声明性查询对集合以及其他项目执行操作。 无需再编写 <code>for</code> 循环来计算整数列表的平均值，现在可改用简单的 <code>list.Average()</code> 方法。 组合使用查询表达式和扩展方法让各种数字变得智能多了。</p>
<p>人们需要一些时间来掌握和吸收这种概念，不过已经逐渐做到了。 现在又过了几年，代码变得更简洁，功能也更强大了。</p>
<h2 id="2010：Framework-4-0-C-4-0"><a href="#2010：Framework-4-0-C-4-0" class="headerlink" title="2010：Framework 4.0 + C# 4.0"></a>2010：Framework 4.0 + C# 4.0</h2><p>.NET 4.0 集成了 C# 4，主要增加了动态语言运行时（DLR）和任务并行库（TPL），它包括 PLINQ、任务等，优化了多线程的编程方式。CLR 由 2 直接升级到 4。相应地，Visual Studio 也升级到了 Visual Studio 2010。</p>
<h3 id="C-4-0"><a href="#C-4-0" class="headerlink" title="C# 4.0"></a>C# 4.0</h3><p>C# 版本 4.0 随 Visual Studio 2010 一起发布，很难达到版本 3.0 的创新水平。 在 3.0 版中，C# 已经完全从 Java 的阴影中脱颖而出，崭露头角。 很快成为一种简洁精炼的语言。</p>
<p>这一版本引入了一些有趣的新功能：</p>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9sYW5ndWFnZS1yZWZlcmVuY2UvYnVpbHRpbi10eXBlcy9yZWZlcmVuY2UtdHlwZXM=">动态绑定<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9wcm9ncmFtbWluZy1ndWlkZS9jbGFzc2VzLWFuZC1zdHJ1Y3RzL25hbWVkLWFuZC1vcHRpb25hbC1hcmd1bWVudHM=">命名参数 / 可选参数<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L3N0YW5kYXJkL2dlbmVyaWNzL2NvdmFyaWFuY2UtYW5kLWNvbnRyYXZhcmlhbmNl">泛型协变和逆变<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2ZyYW1ld29yay9pbnRlcm9wL3R5cGUtZXF1aXZhbGVuY2UtYW5kLWVtYmVkZGVkLWludGVyb3AtdHlwZXM=">嵌入的互操作类型<i class="fa fa-external-link-alt"></i></span></li>
</ul>
<p>嵌入式互操作类型缓解了为应用程序创建 COM 互操作程序集的部署难题。 泛型协变和逆变提供了更强的功能来使用泛型，但风格比较偏学术，应该最受框架和库创建者的喜爱。 命名参数和可选参数帮助消除了很多方法重载，让使用更方便。 但是这些功能都没有完全改变模式。</p>
<p>主要功能是引入 <code>dynamic</code> 关键字。 在 C# 4.0 版中引入 <code>dynamic</code> 关键字让用户可以替代编译时类型上的编译器。 通过使用 dynamic 关键字，可以创建和动态类型语言（例如 JavaScript）类似的构造。 可以创建 <code>dynamic x = &quot;a string&quot;</code> 再向它添加六，然后让运行时理清下一步操作。</p>
<p>动态绑定存在出错的可能性，不过同时也为你提供了强大的语言功能。</p>
<h2 id="2011：Framework-4-5-C-5-0"><a href="#2011：Framework-4-5-C-5-0" class="headerlink" title="2011：Framework 4.5 + C# 5.0"></a>2011：Framework 4.5 + C# 5.0</h2><p>.NET 4.5 和 C# 5一起发布，C# 5 基本上全部都是围绕 async/await 关键字的。<br>相应地，Visual Studio 也升级到了 Visual Studio 2012。<br>与此同时，各个 .NET 的主要产品线也没闲着，例如 ASP.NET MVC 作为 ASP.NET 的一组类库，从 2009 年发布开始一直稳定迭代，Web Service 也在不断进化，从基于 XML 的 WCF 发展到 RESTful 的 WebAPI。<br>在这个当下，<br>最上面的应用层，ASP.NET 茁壮成长，继续和 PHP/JSP 等技术分庭抗礼，用户有 WebForm 和 MVC 可供选择。在 JS 方面，选择了 JQuery 作为官方 JS。值得注意的是，MVC 中的 M 由 ADO.NET Entity Framework 负责。Windows 下的解决方案仍然是 WPF。<br>中间的服务和数据层中，Web 服务拥抱 RESTful ，数据库方面也是由 ADO.NET Entity Framework 唱主角。<br>最下面当然就是基础类库（BLC）。在 C# 5 中，增加了对异步编程的简化。</p>
<h3 id="C-5-0"><a href="#C-5-0" class="headerlink" title="C# 5.0"></a>C# 5.0</h3><p>C# 版本 5.0 随 Visual Studio 2012 一起发布，是该语言有针对性的一个版本。 对此版本中所做的几乎所有工作都归入另一个突破性语言概念：适用于异步编程的 async 和 await 模型。 下面是主要功能列表：</p>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9hc3luYw==">异步成员<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9sYW5ndWFnZS1yZWZlcmVuY2UvYXR0cmlidXRlcy9jYWxsZXItaW5mb3JtYXRpb24=">调用方信息特性<i class="fa fa-external-link-alt"></i></span><br>另请参阅</li>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cuY29kZXByb2plY3QuY29tL1RpcHMvNjA2Mzc5L0NhbGxlci1JbmZvLUF0dHJpYnV0ZXMtaW4tQ3NoYXJw">代码工程：C# 5.0 中的调用方信息属性<i class="fa fa-external-link-alt"></i></span><br>调用方信息特性让你可以轻松检索上下文的信息，不需要采用大量样本反射代码。 这在诊断和日志记录任务中也很有用。</li>
</ul>
<p>但是 async 和 await 才是此版本真正的主角。 C# 在 2012 年推出这些功能时，将异步引入语言作为最重要的组成部分，另现状大为改观。 如果你以前处理过冗长的运行操作以及实现回调的 Web，应该会爱上这项语言功能。</p>
<h2 id="2016：-NET-Core-1-0-C-6-0"><a href="#2016：-NET-Core-1-0-C-6-0" class="headerlink" title="2016：.NET Core 1.0 + C# 6.0"></a>2016：.NET Core 1.0 + C# 6.0</h2><p>.NET Core 是 .NET Framework 的新一代版本，也是另外一种实现方式，是微软开发的第一个跨平台的、开源的、模块化的应用程序开发框架。<br>.NET Core 并不算是 .NET Framework 的继承者，而更像是它的兄弟，所以现在他们各自有了不同的版本编号。<br>.NET Core 和 .NET Framework 共用一部分底层功能（例如一些 BCL），与.NET Framework 不同的是， .NET Core 采用组件化管理的方式，应用程序只要通过 nuget 获取需要的组件即可，而 .NET Framework 一上来就全部安装。<br>.NET Core 的应用层包括 UWP，用于开发 Windows 商店应用（部署到人和支持 Win10 的设备上，如XBox，智能眼镜等），和 ASP.NET Core ，用于开发网站应用（通常为微服务架构的 WebAPI ）。<br>中间层则是 CoreFX，它是 .NET Core 的基础类库，其作用类似于 .NET Framework 的基础类库 BLC。<br>底层则是两种运行时，Core RT 和 Core CLR。Core RT 将 C# 或者 VB.NET 代码直接转换为机器码运行在宿主机上，在不同平台上会使用不同的技术，Windows平台上使用的是 .NET Native，macOS 和 Linux 上使用的是 LLILC。而 Core CLR 就是 .NET Framework CLR 的移植，它包括一个全新的 JIT 编译器——RyuJIT，根据微软的测试报告，它的性能比旧版本提升了约 25%。<br>由于 .NET Core 极佳的跨平台表现，越来越多的网络应用使用 ASP.NET Core 来编写。<br>.NET Core 1.0 中，包含了专属的跨平台版 ORM : Entity Framework Core 1.0，Entity Framework Core 1.0 已获得 Apache License v2 的许可 , 并且完全在 GitHub 上开源。虽然 Entity Framework Core 1.0 与 Entity Framework 的早期版本具有一些概念上的相似之处，但是毫无疑问这是一个全新的代码库，旨在提高效率，它强大、灵活且可扩展并将支持一系列新的关系型数据库和非关系型数据库。</p>
<h3 id="C-6-0"><a href="#C-6-0" class="headerlink" title="C# 6.0"></a>C# 6.0</h3><p>C# 在 3.0 版和 5.0 版对面向对象的语言添加了主要的新功能。 版本 6.0 随 Visual Studio 2015 一起发布，通过该版本，它不再推出主导性的杀手锏，而是发布了很多使得 C# 编程更有效率的小功能。 以下介绍了部分功能：</p>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9sYW5ndWFnZS1yZWZlcmVuY2Uva2V5d29yZHMvdXNpbmctZGlyZWN0aXZl">静态导入<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9sYW5ndWFnZS1yZWZlcmVuY2Uva2V5d29yZHMvd2hlbg==">异常筛选器<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9wcm9wZXJ0aWVz">自动属性初始化表达式<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9sYW5ndWFnZS1yZWZlcmVuY2Uvb3BlcmF0b3JzL2xhbWJkYS1vcGVyYXRvciNleHByZXNzaW9uLWJvZHktZGVmaW5pdGlvbg==">Expression bodied 成员<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9sYW5ndWFnZS1yZWZlcmVuY2Uvb3BlcmF0b3JzL21lbWJlci1hY2Nlc3Mtb3BlcmF0b3JzI251bGwtY29uZGl0aW9uYWwtb3BlcmF0b3JzLS1hbmQt">Null 传播器<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9sYW5ndWFnZS1yZWZlcmVuY2UvdG9rZW5zL2ludGVycG9sYXRlZA==">字符串内插<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9sYW5ndWFnZS1yZWZlcmVuY2Uvb3BlcmF0b3JzL25hbWVvZg==">nameof 运算符<i class="fa fa-external-link-alt"></i></span></li>
</ul>
<p>其他新功能包括：</p>
<ul>
<li>索引初始化表达式</li>
<li>Catch/Finally 块中的 Await</li>
<li>仅限 getter 属性的默认值</li>
</ul>
<p>这些功能每一个都很有趣。 但从整体来看，可以发现一个有趣的模式。 在此版本中，C# 消除语言样本，让代码更简洁且更具可读性。 所以对喜欢简洁代码的用户来说，此语言版本非常成功。</p>
<p>除了发布此版本，他们还做了另一件事，虽然这件事本身与传统的语言功能无关。 他们发布了 Roslyn 编译器即服务。 C# 编译器现在是用 C# 编写的，你可以使用编译器作为编程工作的一部分。</p>
<h2 id="2016-NET-Core-1-1-C-7-0"><a href="#2016-NET-Core-1-1-C-7-0" class="headerlink" title="2016:.NET Core 1.1 + C# 7.0"></a>2016:.NET Core 1.1 + C# 7.0</h2><p>对于微软来说，.NET Core 1.0 (以及早期开发时) 使用 project.json 来处理包管理与版本相依的问题，是因为很多任务具还没赶上 (例如微软主力的建置工具 MSBuild)，再加上 project.json/xproj 架构并不兼容于以 MSBuild 为主的工具链 (Toolchain)，若是要修改成兼容 project.json/xproj 架构的话可能会付出极大成本，因此在 .NET Core 1.0 RC2 发布不久，官方就宣布要将 project.json/xproj 系统移回到以 MSBuild 为主的 csproj，由于 .NET Core 移回了 MSBuild 架构，因此在 Visual Studio 2017 的 .NET Core 工具内，已恢复可直接于 IDE 的 GUI 接口中编修包参考的功能。</p>
<h3 id="C-7-0"><a href="#C-7-0" class="headerlink" title="C# 7.0"></a>C# 7.0</h3><p>C# 7.0 版已与 Visual Studio 2017 一起发布。 虽然该版本继承和发展了 C# 6.0，但不包含编译器即服务。 以下介绍了部分新增功能：</p>
<ul>
<li><p>out 变量</p>
</li>
<li><p><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9sYW5ndWFnZS1yZWZlcmVuY2UvYnVpbHRpbi10eXBlcy92YWx1ZS10dXBsZXM=">元组和析构函数<i class="fa fa-external-link-alt"></i></span></p>
</li>
<li><p><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9mdW5kYW1lbnRhbHMvZnVuY3Rpb25hbC9wYXR0ZXJuLW1hdGNoaW5n">模式匹配<i class="fa fa-external-link-alt"></i></span></p>
</li>
<li><p>本地函数</p>
</li>
<li><p>扩展的 expression bodied 成员</p>
</li>
<li><p><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9wcm9ncmFtbWluZy1ndWlkZS9jbGFzc2VzLWFuZC1zdHJ1Y3RzL3JlZi1yZXR1cm5z">Ref 局部变量和返回结果<i class="fa fa-external-link-alt"></i></span><br>其他功能包括：</p>
</li>
<li><p><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9mdW5kYW1lbnRhbHMvZnVuY3Rpb25hbC9kaXNjYXJkcw==">弃元<i class="fa fa-external-link-alt"></i></span></p>
</li>
<li><p>二进制文本和数字分隔符</p>
</li>
<li><p><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9sYW5ndWFnZS1yZWZlcmVuY2Uva2V5d29yZHMvdGhyb3cjdGhlLXRocm93LWV4cHJlc3Npb24=">引发表达式<i class="fa fa-external-link-alt"></i></span><br>这些都为开发者提供了很棒的新功能，帮助编写比以往任何时候都简洁的代码。 重点是缩减了使用 <code>out</code> 关键字的变量声明，并通过元组实现了多个返回值。</p>
</li>
</ul>
<p>但 C# 的用途更加广泛了。 .NET Core 现在面向所有操作系统，着眼于云和可移植性。 语言设计者除了推出新功能外，也会在这些新功能方面付出时间和精力。</p>
<h2 id="2017：-NET-Core-2-0-C-7-1"><a href="#2017：-NET-Core-2-0-C-7-1" class="headerlink" title="2017：.NET Core 2.0 + C# 7.1"></a>2017：.NET Core 2.0 + C# 7.1</h2><p><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NvcmUvd2hhdHMtbmV3L2RvdG5ldC1jb3JlLTItMA==">.NET Core 2.0<i class="fa fa-external-link-alt"></i></span> 与 Visual Studio 2017 15.3，ASP.NET Core 2.0 和 Entity Framework Core 2.0 一起于2017 年 8 月 14 日发布。在这一阶段，.NET Core 已经逐渐成熟，成长为一个轻量高效的新型 Web 框架。<br>跨平台方面，在 Linux 上的体验更加良好，对于Linux 各种发行版本有了更清晰的定位方式，预览了对 ARM32 架构的 Linux 和 Windows 平台进行了支持。<br>体验方面增加了更好的对国际化的支持。</p>
<h3 id="C-7-1"><a href="#C-7-1" class="headerlink" title="C# 7.1"></a>C# 7.1</h3><p>C# 已开始随 C# 7.1 发布单点发行 。 此版本增加了<span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9sYW5ndWFnZS1yZWZlcmVuY2UvY29uZmlndXJlLWxhbmd1YWdlLXZlcnNpb24=">语言版本选择<i class="fa fa-external-link-alt"></i></span>配置元素、三个新的语言功能和新的编译器行为。</p>
<p>此版本中新增的语言功能包括：</p>
<ul>
<li>Main 方法<ul>
<li>应用程序的入口点可以含有 async 修饰符。</li>
</ul>
</li>
<li>文本表达式<ul>
<li>在可以推断目标类型的情况下，可在默认值表达式中使用默认文本表达式。</li>
</ul>
</li>
<li>推断元组元素名称<ul>
<li>在许多情况下，可通过元组初始化来推断元组元素的名称。</li>
</ul>
</li>
<li>泛型类型参数的模式匹配<ul>
<li>可以对类型为泛型类型参数的变量使用模式匹配表达式。</li>
</ul>
</li>
</ul>
<p>最后，编译器有 <span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9sYW5ndWFnZS1yZWZlcmVuY2UvY29tcGlsZXItb3B0aW9ucy9vdXRwdXQjcHJvZHVjZXJlZmVyZW5jZWFzc2VtYmx5">-refout<i class="fa fa-external-link-alt"></i></span> 和 <span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9sYW5ndWFnZS1yZWZlcmVuY2UvY29tcGlsZXItb3B0aW9ucy9jb2RlLWdlbmVyYXRpb24jcHJvZHVjZW9ubHlyZWZlcmVuY2Vhc3NlbWJseQ==">-refonly<i class="fa fa-external-link-alt"></i></span> 两个选项，可用于控制引用程序集生成</p>
<h2 id="2018：-NET-Core-2-1-C-7-2"><a href="#2018：-NET-Core-2-1-C-7-2" class="headerlink" title="2018：.NET Core 2.1 + C# 7.2"></a>2018：.NET Core 2.1 + C# 7.2</h2><p><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NvcmUvd2hhdHMtbmV3L2RvdG5ldC1jb3JlLTItMQ==">.NET Core 2.1<i class="fa fa-external-link-alt"></i></span>对性能、运行时和工具做了进一步，配套的 ASP.NET Core 2.1 和 Entity Framework Core 2.1 也一并发布。</p>
<ul>
<li>给命令行工具 dotnet cli 提升了扩展性，当前版本开始 dotnet cli 有了类似 npm 般丝滑的使用体验，可以将工具部署为NuGet软件包。</li>
<li>添加了了一种新的基元类型 Span <T>，该类型可以在没有分配的情况下对数据进行操作。</li>
<li>添加了许多其他新的API，专注于加密、压缩和Windows兼容性。</li>
<li>Self-contained 发布，可以在程序包中内置运行环境。</li>
<li>支持了 Alpine Linux 和 ARM32 结构的芯片。</li>
<li>Entity Framework Core 2.1 加入了延迟加载能力。</li>
</ul>
<h3 id="C-7-2"><a href="#C-7-2" class="headerlink" title="C# 7.2"></a>C# 7.2</h3><p>C# 7.2 版添加了几个小型语言功能：</p>
<ul>
<li><code>stackalloc</code> 数组上的初始值设定项。</li>
<li>对支持模式的任何类型使用 <code>fixed</code> 语句。</li>
<li>无需固定即可访问固定的字段。</li>
<li>重新分配 <code>ref</code> 本地变量。</li>
<li>声明 <code>readonly struct</code> 类型，以指示结构不可变且应作为 in 参数传递到其成员方法。</li>
<li>在实参上添加 <code>in</code> 修饰符，以指定形参通过引用传递，但不通过调用方法修改。</li>
<li>对方法返回项使用 <code>ref readonly</code> 修饰符，以指示方法通过引用返回其值，但不允许写入该对象。</li>
<li>声明 <code>ref struct</code> 类型，以指示结构类型直接访问托管的内存，且必须始终分配有堆栈。</li>
<li>使用其他泛型约束。</li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9wcm9ncmFtbWluZy1ndWlkZS9jbGFzc2VzLWFuZC1zdHJ1Y3RzL25hbWVkLWFuZC1vcHRpb25hbC1hcmd1bWVudHM=">非尾随命名参数<i class="fa fa-external-link-alt"></i></span><ul>
<li>命名的参数可后接位置参数。</li>
</ul>
</li>
<li>数值文字中的前导下划线</li>
<li>数值文字现可在任何打印数字前放置前导下划线。</li>
<li>访问修饰符<ul>
<li>private protected 访问修饰符允许访问同一程序集中的派生类。</li>
</ul>
</li>
<li>条件 ref 表达式<ul>
<li>现在可以引用条件表达式 (?:) 的结果。</li>
</ul>
</li>
</ul>
<h2 id="2018：-NET-Core-2-2-C-7-3"><a href="#2018：-NET-Core-2-2-C-7-3" class="headerlink" title="2018：.NET Core 2.2 + C# 7.3"></a>2018：.NET Core 2.2 + C# 7.3</h2><p><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NvcmUvd2hhdHMtbmV3L2RvdG5ldC1jb3JlLTItMg==">.NET Core 2.2 主要有以下改进：<i class="fa fa-external-link-alt"></i></span></p>
<ul>
<li>支持了分层编译</li>
<li>增加了对运行时时间的支持</li>
<li>ADO.NET 中增加了对 Azure Active Directory 认证方式的支持</li>
<li>支持了在 Main 函数之前注入代码</li>
<li>支持了 ARM32 架构的 Windows 系统</li>
</ul>
<h3 id="C-7-3"><a href="#C-7-3" class="headerlink" title="C# 7.3"></a>C# 7.3</h3><p>C# 7.3 版本有两个主要主题。 第一个主题提供使安全代码的性能与不安全代码的性能一样好的功能。 第二个主题提供对现有功能的增量改进。 此外，此版本中还添加了新的编译器选项。</p>
<p>以下新增功能支持使安全代码获得更好的性能的主题：</p>
<ul>
<li>无需固定即可访问固定的字段。</li>
<li>可以重新分配 ref 本地变量。</li>
<li>可以使用 stackalloc 数组上的初始值设定项。</li>
<li>可以对支持模式的任何类型使用 fixed 语句。</li>
<li>可以使用更多泛型约束。</li>
</ul>
<p>对现有功能进行了以下增强：</p>
<ul>
<li>可以使用元组类型测试 == 和 !=。</li>
<li>可以在多个位置使用表达式变量。</li>
<li>可以将属性附加到自动实现的属性的支持字段。</li>
<li>由 in 区分的参数的方法解析得到了改进。</li>
<li>重载解析的多义情况现在变得更少。</li>
</ul>
<p>新的编译器选项为：</p>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9sYW5ndWFnZS1yZWZlcmVuY2UvY29tcGlsZXItb3B0aW9ucy9zZWN1cml0eSNwdWJsaWNzaWdu">-publicsign<i class="fa fa-external-link-alt"></i></span>，用于启用程序集的开放源代码软件 (OSS) 签名。</li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9sYW5ndWFnZS1yZWZlcmVuY2UvY29tcGlsZXItb3B0aW9ucy9hZHZhbmNlZCNwYXRobWFw">-pathmap<i class="fa fa-external-link-alt"></i></span>用于提供源目录的映射。</li>
</ul>
<h2 id="2019：-NET-Core-3-0-3-1-C-8-0"><a href="#2019：-NET-Core-3-0-3-1-C-8-0" class="headerlink" title="2019：.NET Core 3.0/3.1 + C# 8.0"></a>2019：.NET Core 3.0/3.1 + C# 8.0</h2><p><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NvcmUvd2hhdHMtbmV3L2RvdG5ldC1jb3JlLTMtMA==">.NET Core 3.0<i class="fa fa-external-link-alt"></i></span> ：</p>
<ul>
<li>增加了对于 Windows 桌面程序的支持，还是熟悉的 Winform 和 WPF</li>
<li>支持了使用 .NET Core 构建 COM 组件</li>
<li>添加了新的 Json 组件 System.Text.Json</li>
<li>当前版本开始，编译结果为单独的可执行文件，而不再需要使用 dotnet xxx.dll 命令来执行</li>
<li>支持了将运行环境和依赖组件全部打包的单文件发布模式</li>
<li>支持使用程序集修剪来减小发布程序的大小</li>
</ul>
<p><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NvcmUvd2hhdHMtbmV3L2RvdG5ldC1jb3JlLTMtMQ==">.NET Core 3.1<i class="fa fa-external-link-alt"></i></span> ：</p>
<ul>
<li>macOS appHost 模式支持</li>
<li>WinForm 部分空间重构</li>
<li>支持在 Windows 平台创建托管 C++ 项目</li>
</ul>
<h3 id="C-8-0"><a href="#C-8-0" class="headerlink" title="C# 8.0"></a>C# 8.0</h3><p>C# 8.0 版是专门面向 .NET C# Core 的第一个主要 C# 版本。 一些功能依赖于新的 CLR 功能，而其他功能依赖于仅在 .NET Core 中添加的库类型。 C# 8.0 向 C# 语言添加了以下功能和增强功能：</p>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC93aGF0cy1uZXcvY3NoYXJwLTgjcmVhZG9ubHktbWVtYmVycw==">Readonly 成员<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC93aGF0cy1uZXcvY3NoYXJwLTgjZGVmYXVsdC1pbnRlcmZhY2UtbWV0aG9kcw==">默认接口方法<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC93aGF0cy1uZXcvY3NoYXJwLTgjbW9yZS1wYXR0ZXJucy1pbi1tb3JlLXBsYWNlcw==">模式匹配增强功能：<i class="fa fa-external-link-alt"></i></span><ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC93aGF0cy1uZXcvY3NoYXJwLTgjc3dpdGNoLWV4cHJlc3Npb25z">Switch 表达式<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC93aGF0cy1uZXcvY3NoYXJwLTgjcHJvcGVydHktcGF0dGVybnM=">属性模式<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC93aGF0cy1uZXcvY3NoYXJwLTgjdHVwbGUtcGF0dGVybnM=">元组模式<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC93aGF0cy1uZXcvY3NoYXJwLTgjcG9zaXRpb25hbC1wYXR0ZXJucw==">位置模式<i class="fa fa-external-link-alt"></i></span></li>
</ul>
</li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC93aGF0cy1uZXcvY3NoYXJwLTgjdXNpbmctZGVjbGFyYXRpb25z">Using 声明<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC93aGF0cy1uZXcvY3NoYXJwLTgjc3RhdGljLWxvY2FsLWZ1bmN0aW9ucw==">静态本地函数<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC93aGF0cy1uZXcvY3NoYXJwLTgjZGlzcG9zYWJsZS1yZWYtc3RydWN0cw==">可处置的 ref 结构<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9sYW5ndWFnZS1yZWZlcmVuY2UvYnVpbHRpbi10eXBlcy9udWxsYWJsZS1yZWZlcmVuY2UtdHlwZXM=">可为空引用类型<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC93aGF0cy1uZXcvY3NoYXJwLTgjYXN5bmNocm9ub3VzLXN0cmVhbXM=">异步流<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC93aGF0cy1uZXcvY3NoYXJwLTgjYXN5bmNocm9ub3VzLXN0cmVhbXM=">索引和范围<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC93aGF0cy1uZXcvY3NoYXJwLTgjbnVsbC1jb2FsZXNjaW5nLWFzc2lnbm1lbnQ=">Null 合并赋值<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC93aGF0cy1uZXcvY3NoYXJwLTgjdW5tYW5hZ2VkLWNvbnN0cnVjdGVkLXR5cGVz">非托管构造类型<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC93aGF0cy1uZXcvY3NoYXJwLTgjc3RhY2thbGxvYy1pbi1uZXN0ZWQtZXhwcmVzc2lvbnM=">嵌套表达式中的 Stackalloc<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC93aGF0cy1uZXcvY3NoYXJwLTgjZW5oYW5jZW1lbnQtb2YtaW50ZXJwb2xhdGVkLXZlcmJhdGltLXN0cmluZ3M=">内插逐字字符串的增强功能<i class="fa fa-external-link-alt"></i></span></li>
</ul>
<p>默认接口成员需要 CLR 中的增强功能。 这些功能已添加到 .NET Core 3.0 的 CLR 中。 范围和索引以及异步流需要 .NET Core 3.0 库中的新类型。 在编译器中实现时，可为 null 的引用类型在批注库时更有用，因为它可以提供有关参数和返回值的 null 状态的语义信息。 这些批注将添加到 .NET Core 库中。</p>
<h2 id="2020：-NET-5-C-9-0"><a href="#2020：-NET-5-C-9-0" class="headerlink" title="2020：.NET 5 + C# 9.0"></a>2020：.NET 5 + C# 9.0</h2><p><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NvcmUvd2hhdHMtbmV3L2RvdG5ldC01">当前版本<i class="fa fa-external-link-alt"></i></span>是 .NET Core 和 .NET Framework 的大一统。<br>主要包含以下更新：</p>
<ul>
<li>System.Text.Json增加新功能</li>
<li>单文件应用程序更好支持</li>
<li>程序剪裁</li>
<li>Windows ARM64 平台支持</li>
<li>支持使用工具转储调试</li>
<li>运行时库对无效的参考类型进行注释</li>
<li>在以下方面做了性能提升：<ul>
<li>垃圾收集(GC)</li>
<li>System.Text.Json</li>
<li>System.Text.RegularExpressions</li>
<li>Async ValueTask 池</li>
<li>容器尺寸优化</li>
</ul>
</li>
</ul>
<h3 id="C-9-0"><a href="#C-9-0" class="headerlink" title="C# 9.0"></a>C# 9.0</h3><p>C# 9 随 .NET 5 一起发布。 它是面向 .NET 5 版本的任何程序集的默认语言版本。 它包含以下新功能和增强功能：</p>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC93aGF0cy1uZXcvY3NoYXJwLTkjcmVjb3JkLXR5cGVz">record 类型<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC93aGF0cy1uZXcvY3NoYXJwLTkjaW5pdC1vbmx5LXNldHRlcnM=">仅限 Init 的资源库<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC93aGF0cy1uZXcvY3NoYXJwLTkjdG9wLWxldmVsLXN0YXRlbWVudHM=">顶级语句<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC93aGF0cy1uZXcvY3NoYXJwLTkjcGF0dGVybi1tYXRjaGluZy1lbmhhbmNlbWVudHM=">模式匹配增强功能<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC93aGF0cy1uZXcvY3NoYXJwLTkjcGVyZm9ybWFuY2UtYW5kLWludGVyb3A=">性能和互操作性<i class="fa fa-external-link-alt"></i></span><ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9sYW5ndWFnZS1yZWZlcmVuY2UvcHJvcG9zYWxzL2NzaGFycC05LjAvbmF0aXZlLWludGVnZXJz">本机大小的整数<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9sYW5ndWFnZS1yZWZlcmVuY2UvcHJvcG9zYWxzL2NzaGFycC05LjAvZnVuY3Rpb24tcG9pbnRlcnM=">函数指针<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9sYW5ndWFnZS1yZWZlcmVuY2UvcHJvcG9zYWxzL2NzaGFycC05LjAvc2tpcC1sb2NhbHNpbml0">禁止发出 localsinit 标志<i class="fa fa-external-link-alt"></i></span></li>
</ul>
</li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC93aGF0cy1uZXcvY3NoYXJwLTkjZml0LWFuZC1maW5pc2gtZmVhdHVyZXM=">调整和完成功能<i class="fa fa-external-link-alt"></i></span><ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9sYW5ndWFnZS1yZWZlcmVuY2UvcHJvcG9zYWxzL2NzaGFycC05LjAvdGFyZ2V0LXR5cGVkLW5ldw==">目标类型的 表达式<i class="fa fa-external-link-alt"></i></span></li>
<li><a href="">匿名函数</a></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9sYW5ndWFnZS1yZWZlcmVuY2UvcHJvcG9zYWxzL2NzaGFycC05LjAvdGFyZ2V0LXR5cGVkLWNvbmRpdGlvbmFsLWV4cHJlc3Npb24=">目标类型的条件表达式<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9sYW5ndWFnZS1yZWZlcmVuY2UvcHJvcG9zYWxzL2NzaGFycC05LjAvY292YXJpYW50LXJldHVybnM=">协变返回类型<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9sYW5ndWFnZS1yZWZlcmVuY2UvcHJvcG9zYWxzL2NzaGFycC05LjAvZXh0ZW5zaW9uLWdldGVudW1lcmF0b3I=">扩展 支持 foreach 循环<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9sYW5ndWFnZS1yZWZlcmVuY2UvcHJvcG9zYWxzL2NzaGFycC05LjAvbGFtYmRhLWRpc2NhcmQtcGFyYW1ldGVycw==">Lambda 弃元参数<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9sYW5ndWFnZS1yZWZlcmVuY2UvcHJvcG9zYWxzL2NzaGFycC05LjAvbG9jYWwtZnVuY3Rpb24tYXR0cmlidXRlcw==">本地函数的属性<i class="fa fa-external-link-alt"></i></span></li>
</ul>
</li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC93aGF0cy1uZXcvY3NoYXJwLTkjc3VwcG9ydC1mb3ItY29kZS1nZW5lcmF0b3Jz">支持代码生成器<i class="fa fa-external-link-alt"></i></span><ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9sYW5ndWFnZS1yZWZlcmVuY2UvcHJvcG9zYWxzL2NzaGFycC05LjAvbW9kdWxlLWluaXRpYWxpemVycw==">模块初始值设定项<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9sYW5ndWFnZS1yZWZlcmVuY2UvcHJvcG9zYWxzL2NzaGFycC05LjAvZXh0ZW5kaW5nLXBhcnRpYWwtbWV0aG9kcw==">分部方法的新功能<i class="fa fa-external-link-alt"></i></span></li>
</ul>
</li>
</ul>
<p>C# 9 继续以前版本中的三大主题：删除不必要的模式、将数据与算法分离，以及在更多位置提供更多模式。</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9mdW5kYW1lbnRhbHMvcHJvZ3JhbS1zdHJ1Y3R1cmUvdG9wLWxldmVsLXN0YXRlbWVudHM=">顶级语句<i class="fa fa-external-link-alt"></i></span>意味着主程序将更易于读取。 减少了不必要的模式：命名空间、<code>Program</code> 类和 <code>static void Main()</code> 都是不必要的。</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9sYW5ndWFnZS1yZWZlcmVuY2UvYnVpbHRpbi10eXBlcy9yZWNvcmQ=">records<i class="fa fa-external-link-alt"></i></span> 的引入为遵循值语义的引用类型提供了简洁的语法，以实现相等性。 你将使用这些类型来定义通常定义最小行为的数据容器。 <span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC93aGF0cy1uZXcvY3NoYXJwLTkjaW5pdC1vbmx5LXNldHRlcnM=">仅限 Init 的资源库<i class="fa fa-external-link-alt"></i></span>在记录中提供了非破坏性修改功能（表达式）。 C# 9 还添加了<span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9sYW5ndWFnZS1yZWZlcmVuY2UvcHJvcG9zYWxzL2NzaGFycC05LjAvY292YXJpYW50LXJldHVybnM=">协变返回类型<i class="fa fa-external-link-alt"></i></span>，以便派生记录可以重写虚拟方法，并返回从基方法的返回类型派生的类型。</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9mdW5kYW1lbnRhbHMvZnVuY3Rpb25hbC9wYXR0ZXJuLW1hdGNoaW5n">模式匹配<i class="fa fa-external-link-alt"></i></span>功能以多种方式进行了扩展。 数值类型现在支持范围模式。 可以使用 <code>and</code>、<code>or</code> 和 <code>not</code> 模式组合模式。 可以通过添加括号来阐明更复杂的模式。</p>
<p>另一组功能支持 C# 中的高性能计算：</p>
<ul>
<li><code>nint</code> 和 <code>nuint</code> 类型对目标 CPU 上的本机大小整数类型进行建模。</li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9sYW5ndWFnZS1yZWZlcmVuY2UvdW5zYWZlLWNvZGUjZnVuY3Rpb24tcG9pbnRlcnM=">函数指针<i class="fa fa-external-link-alt"></i></span>提供类似委托的功能，同时避免创建委托对象所需的分配。</li>
<li><code>localsinit</code> 指令可以省略以保存指令。</li>
</ul>
<p>另一组改进支持代码生成器添加功能的场景：</p>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9sYW5ndWFnZS1yZWZlcmVuY2UvYXR0cmlidXRlcy9nZW5lcmFsI21vZHVsZWluaXRpYWxpemVyLWF0dHJpYnV0ZQ==">模块初始化表达式<i class="fa fa-external-link-alt"></i></span>是程序集加载时运行时调用的方法。</li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC9sYW5ndWFnZS1yZWZlcmVuY2Uva2V5d29yZHMvcGFydGlhbC1tZXRob2Q=">分部方法<i class="fa fa-external-link-alt"></i></span>支持新的可访问修饰符和非 void 返回类型。 在这些情况下，必须提供一个实现。</li>
</ul>
<p>C# 9 添加了许多其他小功能，提高了开发人员的工作效率，包括编写和读取代码：</p>
<ul>
<li>目标类型 <code>new</code> 表达式</li>
<li><code>static</code> 匿名函数</li>
<li>目标类型的条件表达式</li>
<li>扩展 <code>GetEnumerator()</code> 支持 <code>foreach</code> 循环</li>
<li>Lambda 表达式可以声明弃元参数</li>
<li>特性可应用于本地函数</li>
</ul>
<p>C# 9 版本继续致力于让 C# 成为一种新式通用编程语言。 功能继续支持新式工作负载和应用程序类型。</p>
<h2 id="2021：-NET-6-C-10-0"><a href="#2021：-NET-6-C-10-0" class="headerlink" title="2021：.NET 6 + C# 10.0"></a>2021：.NET 6 + C# 10.0</h2><p><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NvcmUvd2hhdHMtbmV3L2RvdG5ldC02">.NET 6<i class="fa fa-external-link-alt"></i></span> 提供 .NET 统一计划的最终部分，该计划在 .NET 5 中启动。 .NET 6 在移动、桌面、IoT 和云应用之间统一了 SDK、基础库和运行时。 除了这方面的统一以外，.NET 6 生态系统还提供了以下功能：</p>
<ul>
<li><strong>简化开发</strong>：轻松入门。 C# 10 中的新语言功能可减少需要编写的代码量。 利用 Web 堆栈和最小 API 的投资，可以轻松地快速编写更小、更快速的微服务。</li>
<li><strong>更佳的性能</strong>：.NET 6 是最快的完整堆栈 Web 框架，如果在云中运行，则会降低计算成本。</li>
<li><strong>终极工作效率</strong>：.Net 6 和 Visual Studio 2022 提供热重载、新的 git 工具、智能代码编辑、可靠的诊断和测试工具以及更好的团队协作。</li>
</ul>
<h3 id="C-10"><a href="#C-10" class="headerlink" title="C# 10"></a>C# 10</h3><p>C# 10 向 C# 语言添加了以下功能和增强功能：</p>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC93aGF0cy1uZXcvY3NoYXJwLTEwI3JlY29yZC1zdHJ1Y3Rz">记录结构<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC93aGF0cy1uZXcvY3NoYXJwLTEwI2ltcHJvdmVtZW50cy1vZi1zdHJ1Y3R1cmUtdHlwZXM=">结构类型的改进<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC93aGF0cy1uZXcvY3NoYXJwLTEwI2ludGVycG9sYXRlZC1zdHJpbmctaGFuZGxlcg==">内插字符串处理程序<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC93aGF0cy1uZXcvY3NoYXJwLTEwI2dsb2JhbC11c2luZy1kaXJlY3RpdmVz">指令<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC93aGF0cy1uZXcvY3NoYXJwLTEwI2ZpbGUtc2NvcGVkLW5hbWVzcGFjZS1kZWNsYXJhdGlvbg==">文件范围的命名空间声明<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC93aGF0cy1uZXcvY3NoYXJwLTEwI2V4dGVuZGVkLXByb3BlcnR5LXBhdHRlcm5z">扩展属性模式<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC93aGF0cy1uZXcvY3NoYXJwLTEwI2xhbWJkYS1leHByZXNzaW9uLWltcHJvdmVtZW50cw==">对 Lambda 表达式的改进<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC93aGF0cy1uZXcvY3NoYXJwLTEwI2NvbnN0YW50LWludGVycG9sYXRlZC1zdHJpbmdz">可使用内插字符串<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC93aGF0cy1uZXcvY3NoYXJwLTEwI3JlY29yZC10eXBlcy1jYW4tc2VhbC10b3N0cmluZw==">记录类型可密封<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC93aGF0cy1uZXcvY3NoYXJwLTEwI2ltcHJvdmVkLWRlZmluaXRlLWFzc2lnbm1lbnQ=">改进型明确赋值<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC93aGF0cy1uZXcvY3NoYXJwLTEwI2Fzc2lnbm1lbnQtYW5kLWRlY2xhcmF0aW9uLWluLXNhbWUtZGVjb25zdHJ1Y3Rpb24=">在同一析构中可同时进行赋值和声明<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC93aGF0cy1uZXcvY3NoYXJwLTEwI2FsbG93LWFzeW5jbWV0aG9kYnVpbGRlci1hdHRyaWJ1dGUtb24tbWV0aG9kcw==">可在方法上使用属性<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC93aGF0cy1uZXcvY3NoYXJwLTEwI2NhbGxlcmFyZ3VtZW50ZXhwcmVzc2lvbi1hdHRyaWJ1dGUtZGlhZ25vc3RpY3M=">CallerArgumentExpression 属性<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2NzaGFycC93aGF0cy1uZXcvY3NoYXJwLTEwI2VuaGFuY2VkLWxpbmUtcHJhZ21h">增强的 pragma<i class="fa fa-external-link-alt"></i></span></li>
</ul>
<p>其他功能在预览模式下可用。 建议尝试使用这些功能并提供相关反馈。 它们可能会在最终发布之前发生更改。 为了使用这些功能，需要在项目中将 设置为 Preview。 阅读本文后面的关于泛型属性的信息。<br>.NET 6 支持 C# 10。 有关详细信息，请参阅 C# 语言版本控制。</p>
]]></content>
      <categories>
        <category>偶有所得</category>
      </categories>
      <tags>
        <tag>总结</tag>
        <tag>新特性</tag>
      </tags>
  </entry>
  <entry>
    <title>C#激爽特性——扩展方法</title>
    <url>/posts/35525.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>在最近的学习中，发现了一种用起来特别爽的C#特性——扩展方法，之前拜读《大话设计模式》一书的时候，书中提到这样一句话：“反射，反射，程序员的快乐”，本人菜鸟一只，到现在还未曾使用过反射，对于其是否真的快乐自然无从体会，不过扩展方法用起来称得上是相当快乐！</p>
<span id="more"></span>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>下面是MSDN中对于扩展方法的解释</p>
<blockquote>
<p> 扩展方法使你能够向现有类型”添加“方法,而无需创建新的派生类型、重新编译或以其他方法修改原始类型。扩展方法是一种特殊的静态方法，但可以像扩展类型上的实力方法一样进行调用。对于C#和Visual Basic 编写的客户端代码，调用扩展方法与调用在类型中实际定义的方法之间没有明显的差异。</p>
</blockquote>
<p>刚开始学习C#的时候,经常碰到各种需要状态转换的场合,那个时候代码里常常是大坨大坨的Convert.ToXX();当时非常羡慕String类可以直接调用ToString方法,省时省力,代码看起来还特别美观,之后学会了把Convert.ToXX()打包到一个方法里,代码不那么冗余了,但还是不甚美观,且费时费力,直到今天,我发现了C#中这个让人激爽无比的特性,这件事情终于有了完美的解决方案!</p>
<h2 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h2><p>下面来看一下基本的语法:</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> 返回类型 方法名(<span class="keyword">this</span> 需要添加扩展方法的类名 变量名,,,)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>首先我们写这样一个类: </p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">ExtensionMethods</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">ExtensionMethods</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">int</span> <span class="title">ToInt</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">string</span> s</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> Convert.ToInt32(s);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后只需要在另一个类中引用这个类的命名空间，就可以方便地使用我们写好的扩展方法进行类型转换了:</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> ExtensionMethods;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">xxx</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">xxxx</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">int</span> <span class="title">Test</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">int</span> i = <span class="string">&quot;123&quot;</span>.ToInt();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>怎么样？是不是感觉一股凉气当头灌下——<strong>真爽啊！</strong><br>别急，光这样怎么能够满足我们的需求呢，接下来我们继续优化。</p>
<h2 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h2><p>以上已经方便了不少，但还是有以下两个问题：</p>
<blockquote>
<p>** 每次还需要引用命名空间，太浪费时间精力。**</p>
</blockquote>
<p>解决方案：将扩展方法直接放到类型所在的命名空间下<br>依旧以上面的代码为例，就是：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">System</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">ExtensionMethods</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">int</span> <span class="title">ToInt</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">string</span> s</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> Convert.ToInt32(s);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>如果输入的String并不能转化为数字,会报错。</strong></p>
</blockquote>
<p>解决方案：加入另一个参数为默认值，若不能转化成功，则返回默认值。<br>代码如下:</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">int</span> <span class="title">ToInt32</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">string</span> s, <span class="built_in">int</span> def = <span class="literal">default</span>(<span class="built_in">int</span></span>))</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">int</span> result;</span><br><span class="line">    <span class="keyword">return</span> Int32.TryParse(s, <span class="keyword">out</span> result) ? result : def;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>按照上面的思路,我们可以打包一个包含各种常用类型转换的类,写程序的时候只要直接加入这个类,就可以方便地进行各种进制转换了.</p>
<p>下面提供一个自用的Convert类<span class="exturl" data-url="aHR0cHM6Ly9xaW5pdWNkbi53YXluZXNoYW8uY29tL0NvbnZlcnQuemlw">Convert.zip<i class="fa fa-external-link-alt"></i></span></p>
]]></content>
      <categories>
        <category>算法刷题</category>
      </categories>
      <tags>
        <tag>特性</tag>
        <tag>扩展方法</tag>
      </tags>
  </entry>
  <entry>
    <title>【下载】C# 调用迅雷、IDM下载方法汇总</title>
    <url>/posts/46213.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>在开发桌面软件时常常有下载文件的需求，小文件、少文件可以自己做相应的网络请求，但是当文件的大小或者数量达到一定规模时，自己封装网络请求就不是很划算的事情了，这时我们可以采取调用迅雷或者IDM、aria2c之类的专业下载软件来进行下载。</p>
<span id="more"></span>
<h2 id="迅雷"><a href="#迅雷" class="headerlink" title="迅雷"></a>迅雷</h2><h3 id="直接调用迅雷"><a href="#直接调用迅雷" class="headerlink" title="直接调用迅雷"></a>直接调用迅雷</h3><ol>
<li><p> 安装迅雷后可以再引用的com组件中找到名为 “ThunderAgent 1.0 Type Library” 的com组件，勾选引用之后，把类库属性中的嵌入互操作类型修改为false。<br><img data-src="https://qiniucdn.wayneshao.com/20180307172636630/20180307054659587.png"></p>
</li>
<li><p>使用代码调用AgentLib直接在迅雷中增加新任务</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">new</span> ThunderAgentLib.AgentClass().AddTask(<span class="string">&quot;http://s1.static.haoke258.info/attach_2/2018-1-30-5ZD6R0BZZ.rar&quot;</span>);</span><br></pre></td></tr></table></figure>
<p> 以上为最简单的调用方式，只是传入了下载地址，其他的属性为默认值，传入后续的几个参数或者才用AddTask2方法就可以手动修改任务属性。</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">extern</span> <span class="keyword">void</span> <span class="title">AddTask</span>(<span class="params">[MarshalAs(UnmanagedType.BStr</span>), In] <span class="built_in">string</span> bstrUrl, [<span class="title">MarshalAs</span>(<span class="params">UnmanagedType.BStr</span>), In] <span class="built_in">string</span> bstrFileName</span> = <span class="string">&quot;&quot;</span>, [MarshalAs(UnmanagedType.BStr), In] <span class="built_in">string</span> bstrPath = <span class="string">&quot;&quot;</span>, [MarshalAs(UnmanagedType.BStr), In] <span class="built_in">string</span> bstrComments = <span class="string">&quot;&quot;</span>, [MarshalAs(UnmanagedType.BStr), In] <span class="built_in">string</span> bstrReferUrl = <span class="string">&quot;&quot;</span>, [In] <span class="built_in">int</span> nStartMode = <span class="number">-1</span>, [In] <span class="built_in">int</span> nOnlyFromOrigin = <span class="number">0</span>, [In] <span class="built_in">int</span> nOriginThreadCount = <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">extern</span> <span class="keyword">void</span> <span class="title">AddTask2</span>(<span class="params">[MarshalAs(UnmanagedType.BStr</span>), In] <span class="built_in">string</span> bstrUrl, [<span class="title">MarshalAs</span>(<span class="params">UnmanagedType.BStr</span>), In] <span class="built_in">string</span> bstrFileName</span> = <span class="string">&quot;&quot;</span>, [MarshalAs(UnmanagedType.BStr), In] <span class="built_in">string</span> bstrPath = <span class="string">&quot;&quot;</span>, [MarshalAs(UnmanagedType.BStr), In] <span class="built_in">string</span> bstrComments = <span class="string">&quot;&quot;</span>, [MarshalAs(UnmanagedType.BStr), In] <span class="built_in">string</span> bstrReferUrl = <span class="string">&quot;&quot;</span>, [In] <span class="built_in">int</span> nStartMode = <span class="number">-1</span>, [In] <span class="built_in">int</span> nOnlyFromOrigin = <span class="number">0</span>, [In] <span class="built_in">int</span> nOriginThreadCount = <span class="number">-1</span>, [MarshalAs(UnmanagedType.BStr), In] <span class="built_in">string</span> bstrCookie = <span class="string">&quot;&quot;</span>);</span><br></pre></td></tr></table></figure>
<h3 id="迅雷开放平台"><a href="#迅雷开放平台" class="headerlink" title="迅雷开放平台"></a>迅雷开放平台</h3><p>迅雷官方曾经开放过一个mini版下载SDK，相当于一个无界面版本的mini迅雷，可以供程序直接调用，现在虽然已经停止服务，但是网上仍然有它的传说，<br>优点是不用下载迅雷，软件+dll总共只有1mb+，缺点就是没有迅雷完整版的那些加速功能，没有那么快。<br>我按照自己的理解把SDK封装了一下：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL1dheW5lU2hhby9UaHVuZGVyU2Rr">https://github.com/WayneShao/ThunderSdk<i class="fa fa-external-link-alt"></i></span><br>下面是调用代码：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> ThunderSdk;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ThunderSdkDemo</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> manager = <span class="keyword">new</span> DownloadManager(<span class="number">1</span>, <span class="string">@&quot;D:\&quot;</span>);</span><br><span class="line">            manager.CreateNewTask(<span class="string">&quot;https://ss2.baidu.com/6ONYsjip0QIZ8tyhnq/it/u=770549720,375505130&amp;fm=173&amp;s=612A66F94AA394CE4A84E71B030050D7&amp;w=218&amp;h=146&amp;img.JPEG&quot;</span>,</span><br><span class="line">                <span class="string">&quot;2018-1-30-5ZD6R0BZZ.jpg&quot;</span>);</span><br><span class="line"></span><br><span class="line">            manager.TaskDownload += (s, e) =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (!(s <span class="keyword">is</span> DownFileInfo info)) <span class="keyword">return</span>;</span><br><span class="line">                Console.WriteLine(info.TaskInfo.Percent);</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            manager.TaskCompleted += (s, e) =&gt;</span><br><span class="line">              &#123;</span><br><span class="line">                  <span class="keyword">if</span> (!(s <span class="keyword">is</span> DownFileInfo info)) <span class="keyword">return</span>;</span><br><span class="line">                  Console.WriteLine(info.FileName + <span class="string">&quot;下载完成&quot;</span>);</span><br><span class="line">              &#125;;</span><br><span class="line"></span><br><span class="line">            manager.StartAllTask();</span><br><span class="line">            Console.ReadKey();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Internet-Download-Manager"><a href="#Internet-Download-Manager" class="headerlink" title="Internet Download Manager"></a>Internet Download Manager</h2><p>这个是我用过之后体验最好的，推荐使用。<br>使用方法如下：</p>
<h3 id="获取DLL文件"><a href="#获取DLL文件" class="headerlink" title="获取DLL文件"></a>获取DLL文件</h3></li>
<li><p>下载 <span class="exturl" data-url="aHR0cDovL3d3dy5pbnRlcm5ldGRvd25sb2FkbWFuYWdlci5jb20vc3VwcG9ydC9kb3dubG9hZC9JRE1DT01BUEkuemlw">IDMCOMAPI.zip<i class="fa fa-external-link-alt"></i></span>。</p>
</li>
<li><p>解压 IDManTypeInfo.tlb 文件到任意位置。</p>
</li>
<li><p>打开 Visual Studio安装时附带的命令行工具。（任选一个即可，推荐第一个）<br><img data-src="https://qiniucdn.wayneshao.com/20180308000415303/20180308121452182.png"></p>
</li>
<li><p>使用 类型库导入程序 (Tlbimp.exe)将tlb文件转换成dll文件。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">TlbImp IDManTypeInfo.tlb</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Microsoft (R) .NET Framework Type Library to Assembly Converter 3.5.30729.1<br> Copyright (C) Microsoft Corporation.  All rights reserved.</p>
</blockquote>
<blockquote>
<p>Type library imported to ![IDManLib.dll]<br>This will create an IDManLib.dll</p>
</blockquote>
</li>
</ol>
<p>如果懒得完成上面的步骤，也可以直接下载我已经导入好的文件<span class="exturl" data-url="aHR0cHM6Ly9xaW5pdWNkbi53YXluZXNoYW8uY29tLzIwMTgwMzA4MDAwNDE1MzAzL0lETWFuTGliLjd6">IDManLib.7z<i class="fa fa-external-link-alt"></i></span></p>
<h2 id="引用DLL文件"><a href="#引用DLL文件" class="headerlink" title="引用DLL文件"></a>引用DLL文件</h2><p>手动选择 IDManLib.dll 文件进行引用，引用后同样也要把类库属性中的嵌入互操作类型修改为false，编译平台最好选择x86。 </p>
<h2 id="调用方法"><a href="#调用方法" class="headerlink" title="调用方法"></a>调用方法</h2><p>和迅雷的类似，将下载地址、文件路劲、文件名等参数传入方法中即可成功在IDM中建立新任务。</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">new</span> IDManLib.CIDMLinkTransmitterClass().SendLinkToIDM(<span class="string">&quot;http://s1.static.haoke258.info/attach_2/2018-1-30-5ZD6R0BZZ.rar&quot;</span>, <span class="string">&quot;http://ailushe95.info/&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">@&quot;D:\Backup\Downloads\LULULU&quot;</span>, <span class="string">&quot;【感謝擼友投稿】無名小姐姐 2V.rar&quot;</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>踩坑笔记</category>
      </categories>
      <tags>
        <tag>C#</tag>
        <tag>下载</tag>
        <tag>IDM</tag>
        <tag>迅雷</tag>
        <tag>爬虫</tag>
      </tags>
  </entry>
  <entry>
    <title>C#读取CPU序列号、硬盘ID、网卡MAC地址，生成机器码</title>
    <url>/posts/13625.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>话不多说，直接上代码，类库中的机器码使用序列号、硬盘ID、网卡MAC地址组合取MD5生成。</p>
<span id="more"></span>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Management;</span><br><span class="line"><span class="keyword">using</span> System.Security.Cryptography;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">WayneShao.Common</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">MachineCode</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">string</span> _machineCodeString;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> Value</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrWhiteSpace(_machineCodeString))</span><br><span class="line">                    _machineCodeString = GetMD5(<span class="string">$&quot;<span class="subst">&#123;CPUCode&#125;</span>_<span class="subst">&#123;HDId&#125;</span>_<span class="subst">&#123;MacAddress&#125;</span>&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> _machineCodeString;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">string</span> _cpuCode;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> CPUCode =&gt; _cpuCode ?? (_cpuCode = GetCPUInfo());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">string</span> _hdId;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> HDId =&gt; _hdId ?? (_hdId = GetHDid());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">string</span> _macAddress;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> MacAddress =&gt; _macAddress ?? (_macAddress = GetMACAddress());</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>   <span class="doctag">&lt;summary&gt;</span> </span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>   获取cpu序列号     </span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>   <span class="doctag">&lt;/summary&gt;</span> </span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>   <span class="doctag">&lt;returns&gt;</span> string <span class="doctag">&lt;/returns&gt;</span> </span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">GetCPUInfo</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">using</span> (<span class="keyword">var</span> cimobject = <span class="keyword">new</span> ManagementClass(<span class="string">&quot;Win32_Processor&quot;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> hdids = cimobject.GetInstances().Cast&lt;ManagementObject&gt;().Select(o =&gt; o.Properties[<span class="string">&quot;ProcessorId&quot;</span>].Value).Cast&lt;<span class="built_in">string</span>&gt;().ToArray();</span><br><span class="line">                <span class="keyword">return</span> hdids.Any() ? hdids.First() : <span class="built_in">string</span>.Empty;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>   <span class="doctag">&lt;summary&gt;</span> </span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>   获取硬盘ID     </span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>   <span class="doctag">&lt;/summary&gt;</span> </span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>   <span class="doctag">&lt;returns&gt;</span> string <span class="doctag">&lt;/returns&gt;</span> </span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">GetHDid</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">using</span> (<span class="keyword">var</span> cimobject1 = <span class="keyword">new</span> ManagementClass(<span class="string">&quot;Win32_DiskDrive&quot;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> hdids = cimobject1.GetInstances().Cast&lt;ManagementObject&gt;().Select(o =&gt; o.Properties[<span class="string">&quot;Model&quot;</span>].Value).Cast&lt;<span class="built_in">string</span>&gt;().ToArray();</span><br><span class="line">                <span class="keyword">return</span> hdids.Any() ? hdids.First() : <span class="built_in">string</span>.Empty;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>   <span class="doctag">&lt;summary&gt;</span> </span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>   获取网卡硬件地址 </span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>   <span class="doctag">&lt;/summary&gt;</span> </span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>   <span class="doctag">&lt;returns&gt;</span> string <span class="doctag">&lt;/returns&gt;</span> </span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">GetMACAddress</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">using</span> (<span class="keyword">var</span> mc = <span class="keyword">new</span> ManagementClass(<span class="string">&quot;Win32_NetworkAdapterConfiguration&quot;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> macs = mc.GetInstances().Cast&lt;ManagementObject&gt;().Where(o =&gt; (<span class="built_in">bool</span>)o[<span class="string">&quot;IPEnabled&quot;</span>]).Select(o =&gt; o[<span class="string">&quot;MacAddress&quot;</span>].ToString()).ToArray();</span><br><span class="line">                <span class="keyword">return</span> macs.Any() ? macs.First() : <span class="built_in">string</span>.Empty;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>   <span class="doctag">&lt;summary&gt;</span> </span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>   获取字符串的MD5值</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>   <span class="doctag">&lt;/summary&gt;</span> </span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>   <span class="doctag">&lt;returns&gt;</span> string <span class="doctag">&lt;/returns&gt;</span> </span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">GetMD5</span>(<span class="params"><span class="built_in">string</span> source</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> result = Encoding.Default.GetBytes(source);</span><br><span class="line">            <span class="keyword">var</span> md5 = <span class="keyword">new</span> MD5CryptoServiceProvider();</span><br><span class="line">            <span class="keyword">var</span> output = md5.ComputeHash(result);</span><br><span class="line">            <span class="keyword">return</span> BitConverter.ToString(output).Replace(<span class="string">&quot;-&quot;</span>, <span class="string">&quot;&quot;</span>).ToLower();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>另附MSDN中关于 WMI Class 的文档供大家参考<br><span class="exturl" data-url="aHR0cHM6Ly9tc2RuLm1pY3Jvc29mdC5jb20vemgtY24vbGlicmFyeS9hYTM5NDE3MyhWUy44NSkuYXNweA==">https://msdn.microsoft.com/zh-cn/library/aa394173(VS.85).aspx<i class="fa fa-external-link-alt"></i></span></p>
]]></content>
      <categories>
        <category>踩坑笔记</category>
      </categories>
      <tags>
        <tag>C#</tag>
        <tag>硬件信息</tag>
      </tags>
  </entry>
  <entry>
    <title>C#线性筛法快速求出范围内的所有质数</title>
    <url>/posts/1416.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>质数是指在大于1的自然数中，除了1和它本身以外不再有其他因数的数。本文列举了几种求区间内所有质数的算法。</p>
<span id="more"></span>
<h2 id="一般方法"><a href="#一般方法" class="headerlink" title="一般方法"></a>一般方法</h2><h3 id="验证质数"><a href="#验证质数" class="headerlink" title="验证质数"></a>验证质数</h3><p>我们根据<span class="exturl" data-url="aHR0cDovL2JhaWtlLmJhaWR1LmNvbS92aWV3LzE3NjcuaHRt">质数<i class="fa fa-external-link-alt"></i></span>的定义可以对某一自然数进行检测，方法如下：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 判断自然数是否是质数</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;n&quot;&gt;</span>需要判断的数<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>是/否<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">IsPrime</span>(<span class="params"><span class="built_in">int</span> n</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (n &lt; <span class="number">2</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = n - <span class="number">1</span>; i &gt; <span class="number">1</span>; i--)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//n除以每个比n小比1大的自然数</span></span><br><span class="line">        <span class="keyword">if</span> (n % i == <span class="number">0</span>)</span><br><span class="line">            <span class="comment">//如果有能被整除的，则不是质数</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//否则则为质数</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="获取范围内质数"><a href="#获取范围内质数" class="headerlink" title="获取范围内质数"></a>获取范围内质数</h3><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 获取自然数区间内的所有质数</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;startInt&quot;&gt;</span>自然数区间起始点<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;endInt&quot;&gt;</span>自然数区间终点<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>自然数区间内的所有质数的集合<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IEnumerable&lt;<span class="built_in">int</span>&gt; <span class="title">GetPrimes</span>(<span class="params"><span class="built_in">int</span> startInt, <span class="built_in">int</span> endInt</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = startInt; i &lt;= endInt; i++)</span><br><span class="line">        <span class="keyword">if</span> (IsPrime(i))</span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="筛法"><a href="#筛法" class="headerlink" title="筛法"></a>筛法</h2><h3 id="什么是筛法"><a href="#什么是筛法" class="headerlink" title="什么是筛法"></a>什么是筛法</h3><p>科普篇:筛法是一种简单检定<span class="exturl" data-url="aHR0cDovL2JhaWtlLmJhaWR1LmNvbS92aWV3LzE3NjcuaHRt">质数<i class="fa fa-external-link-alt"></i></span>的算法。据说是古希腊的<span class="exturl" data-url="aHR0cDovL2JhaWtlLmJhaWR1LmNvbS9zdWJ2aWV3LzQ2MDE1LzQ2MDE1Lmh0bQ==">埃拉托斯特尼（Eratosthenes）<i class="fa fa-external-link-alt"></i></span>发明的，又称<span class="exturl" data-url="aHR0cDovL2JhaWtlLmJhaWR1LmNvbS92aWV3LzE0MjUzNzkuaHRt">埃拉托斯特尼筛法（sieve of Eratosthenes）<i class="fa fa-external-link-alt"></i></span>.</p>
<h3 id="使用筛法求某上限内所有质数"><a href="#使用筛法求某上限内所有质数" class="headerlink" title="使用筛法求某上限内所有质数"></a>使用筛法求某上限内所有质数</h3><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 求某上限内的所有质数</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;j&quot;&gt;</span>上限自然数<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>上限内所有质数<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IEnumerable&lt;<span class="built_in">int</span>&gt; <span class="title">GenPrime</span>(<span class="params"><span class="built_in">int</span> j</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> bts = <span class="keyword">new</span> BitArray(j + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> x = <span class="number">2</span>; x &lt; bts.Length / <span class="number">2</span>; x++)</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> y = x + <span class="number">1</span>; y &lt; bts.Length; y++)</span><br><span class="line">            <span class="keyword">if</span> (bts[y] == <span class="literal">false</span> &amp;&amp; y % x == <span class="number">0</span>)</span><br><span class="line">                bts[y] = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> x = <span class="number">2</span>; x &lt; bts.Length; x++)</span><br><span class="line">        <span class="keyword">if</span> (bts[x] == <span class="literal">false</span>)</span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="使用筛法求某自然数区间内所有质数"><a href="#使用筛法求某自然数区间内所有质数" class="headerlink" title="使用筛法求某自然数区间内所有质数"></a>使用筛法求某自然数区间内所有质数</h3><p>使用两次上面的方法分别求取区间起始点和终点作为上限的所有质数后取差集</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 获取自然数区间内的所有质数</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;startInt&quot;&gt;</span>自然数区间起始点<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;endInt&quot;&gt;</span>自然数区间终点<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>自然数区间内的所有质数的集合<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IEnumerable&lt;<span class="built_in">int</span>&gt; <span class="title">GenPrimes</span>(<span class="params"><span class="built_in">int</span> startInt, <span class="built_in">int</span> endInt</span>)</span> =&gt; </span><br><span class="line">    GenPrime(endInt).Except(GenPrime(startInt));</span><br></pre></td></tr></table></figure>
<h3 id="快速线性筛法实现"><a href="#快速线性筛法实现" class="headerlink" title="快速线性筛法实现"></a>快速线性筛法实现</h3><p>在某位高手的博文中发现了复杂度更低的线性筛法</p>
<blockquote>
<p><span class="exturl" data-url="aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZGlub3NvZnQvYXJ0aWNsZS9kZXRhaWxzLzU4Mjk1NTAjdDM=">一般筛法求素数+快速线性筛法求素数<i class="fa fa-external-link-alt"></i></span></p>
</blockquote>
<p>下面是C#的实现</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 求某上限内的所有质数</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;x&quot;&gt;</span>上限自然数<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>上限内所有质数<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> IEnumerable&lt;<span class="built_in">int</span>&gt; <span class="title">LinearGenPrime</span>(<span class="params"><span class="built_in">int</span> x</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> numPrime = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">var</span> ints = <span class="keyword">new</span> List&lt;<span class="built_in">int</span>&gt;();</span><br><span class="line">    <span class="keyword">var</span> isNotPrime = <span class="keyword">new</span> BitArray(x);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">2</span>; i &lt; x; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isNotPrime[i])</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">return</span> i;</span><br><span class="line">            numPrime++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; numPrime &amp;&amp; i * ints[j] &lt; x; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            isNotPrime[i * ints[j]] = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (!Convert.ToBoolean(i % ints[j]))</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>算法笔记</category>
      </categories>
      <tags>
        <tag>算法</tag>
        <tag>质数</tag>
      </tags>
  </entry>
  <entry>
    <title>Docker原理解析——沙盒</title>
    <url>/posts/46316.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>　　上一篇，顺着云计算的发展史，我们看到了兴起于 PaaS 技术普及的容器技术，看到了容器技术通过容器镜像彻底解决了打包问题，按照连续思维，其实接下来应该讲讲 Docker 出现之后有哪些竞争对手，为什么 Docker 可以胜出，连带着让 Docker 几乎等同于容器技术本身，容器编排竞争中 Swarm 为什么输给了 Kubernetes，不过出于个人对整个云原生知识网络的感受，我觉得可以在这次开个分支，先不谈历史，讲一下 Docker 的实现原理。</p>
<p>本文主要是解释 Docker 沙盒的工作原理，回答诸如但不限于以下问题：</p>
<ul>
<li>为什么容器里只能跑“一个进程”？</li>
<li>容器和虚拟机有什么区别？</li>
</ul>
<span id="more"></span>
<h2 id="隔离魔术：Linux-NameSpace"><a href="#隔离魔术：Linux-NameSpace" class="headerlink" title="隔离魔术：Linux NameSpace"></a>隔离魔术：Linux NameSpace</h2><h3 id="什么是-Linux-NameSpace"><a href="#什么是-Linux-NameSpace" class="headerlink" title="什么是 Linux NameSpace"></a>什么是 Linux NameSpace</h3><p>　　Linux Namespace是Linux提供的一种内核级别环境隔离的方法，可以提供多种类别的环境隔离赋能，下面我们以 PID NameSpace 为例，看看容器是怎么样应用 Linux NameSpace 来构建独立的环境的。<br>　　Linux下的 root 进程的PID是 1，NameSpace 可以提供一种机制，让 NameSpace 内部的其他进程认为主进程的 PID 是 1，不同 NameSpace 之间的进程无法看到彼此。<br>　　执行<code>docker run -it busybox /bin/sh</code>，这句命令的具体作用是，启动一个<code>busybox</code>镜像的容器，在容器中执行 <code>/bin/sh</code>，并直接进入容器中。</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># docker run -it busybox /bin/sh</span></span><br><span class="line">Unable to find image <span class="string">&#x27;busybox:latest&#x27;</span> locally</span><br><span class="line">latest: Pulling from library/busybox</span><br><span class="line"><span class="number">24</span>fb2886d6f6: Pull complete </span><br><span class="line">Digest: sha256:f7ca5a32c10d51aeda3b4d01c61c6061f497893d7f6628b92f822f7117182a57</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> busybox:latest</span><br><span class="line">/ <span class="comment"># </span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>　　然后我们在容器中运行 ps 命令查看进程</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">/ <span class="comment"># ps</span></span><br><span class="line">PID   USER     TIME  COMMAND</span><br><span class="line">    <span class="number">1</span> root      <span class="number">0</span>:<span class="number">00</span> /bin/sh</span><br><span class="line">    <span class="number">8</span> root      <span class="number">0</span>:<span class="number">00</span> <span class="built_in">ps</span></span><br><span class="line">/ <span class="comment"># </span></span><br></pre></td></tr></table></figure>
<p>　　可以清晰地看到，容器中一共就两个进程，我们启动的 <code>/bin/sh</code> 为 1 号进程，ps 的进程为 2 号进程，这两个进程已经被隔绝到了跟宿主机不同的单独空间中。<br>　　而这就是 NameSpace 做的工作。</p>
<p>　　除了进程 ID 隔离（PID Namespace）之外，Linux NameSpace 还提供了多种隔离种类：</p>
<table>
<thead>
<tr>
<th>分类</th>
<th>系统调用参数</th>
<th>相关内核版本</th>
</tr>
</thead>
<tbody><tr>
<td>Mount namespaces</td>
<td>CLONE_NEWNS</td>
<td><span class="exturl" data-url="aHR0cHM6Ly9sd24ubmV0LzIwMDEvMDMwMS9hL25hbWVzcGFjZXMucGhwMw==">Linux 2.4.19<i class="fa fa-external-link-alt"></i></span></td>
</tr>
<tr>
<td>UTS namespaces</td>
<td>CLONE_NEWUTS</td>
<td><span class="exturl" data-url="aHR0cHM6Ly9sd24ubmV0L0FydGljbGVzLzE3OTM0NS8=">Linux 2.6.19<i class="fa fa-external-link-alt"></i></span></td>
</tr>
<tr>
<td>IPC namespaces</td>
<td>CLONE_NEWIPC</td>
<td><span class="exturl" data-url="aHR0cHM6Ly9sd24ubmV0L0FydGljbGVzLzE3OTM0NS8=">Linux 2.6.19<i class="fa fa-external-link-alt"></i></span></td>
</tr>
<tr>
<td>PID namespaces</td>
<td>CLONE_NEWPID</td>
<td><span class="exturl" data-url="aHR0cHM6Ly9sd24ubmV0L0FydGljbGVzLzI1OTIxNy8=">Linux 2.6.24<i class="fa fa-external-link-alt"></i></span></td>
</tr>
<tr>
<td>Network namespaces</td>
<td>CLONE_NEWNET</td>
<td><span class="exturl" data-url="aHR0cHM6Ly9sd24ubmV0L0FydGljbGVzLzIxOTc5NC8=">始于Linux 2.6.24 完成于 Linux 2.6.29<i class="fa fa-external-link-alt"></i></span></td>
</tr>
<tr>
<td>User namespaces</td>
<td>CLONE_NEWUSER</td>
<td><span class="exturl" data-url="aHR0cHM6Ly9sd24ubmV0L0FydGljbGVzLzUyODA3OC8=">始于 Linux 2.6.23 完成于 Linux 3.8<i class="fa fa-external-link-alt"></i></span></td>
</tr>
</tbody></table>
<p>　　而容器环境，就是对这些隔离种类的复合使用的结果，具体的调用测试可以参照“左耳朵耗子”大佬在多年前的一篇文章<span class="exturl" data-url="aHR0cHM6Ly9jb29sc2hlbGwuY24vYXJ0aWNsZXMvMTcwMTAuaHRtbA==">《DOCKER基础技术：LINUX NAMESPACE（上）》<i class="fa fa-external-link-alt"></i></span>，调用文档可以参考<span class="exturl" data-url="aHR0cHM6Ly9sd24ubmV0L0FydGljbGVzLzUzMTExNC8=">官方文档<i class="fa fa-external-link-alt"></i></span>。</p>
<h3 id="Linux-NameSpace-的优势（对比虚拟机）"><a href="#Linux-NameSpace-的优势（对比虚拟机）" class="headerlink" title="Linux NameSpace 的优势（对比虚拟机）"></a>Linux NameSpace 的优势（对比虚拟机）</h3><p><img data-src="https://qiniucdn.wayneshao.com/46316/20210926111113033.png"><br>　　上图是网上常见的虚拟机和容器的对比通，把容器管理系统放到了跟虚拟系统一个级别，实际是有问题的，我们对它做一下纠正。<br><img data-src="https://qiniucdn.wayneshao.com/46316/20210926113859290.png"><br>　　如上图所示，因为容器的本质其实就是 Linux 系统上的原生进程做了特殊的隔离措施，对容器的操作其实都是原生物理机操作系统的进程操作，没有中间的性能损耗。而虚拟机自身都是完整的操作系统，本身就要占用不小的内存，用户程序运行在虚拟机内部，对宿主机的计算资源、网络和磁盘 I/O 的调用必须要经过虚拟化软件的拦截和处理，性能损耗很大。</p>
<p>　　故而容器启动要比虚拟机快很多，性能也是要比虚拟机更高，概括一下，即<strong>“敏捷”</strong>和<strong>“高性能”</strong>，这是容器技术在 PaaS 时代大行其道的重要原因。<br>　　。</p>
<h3 id="Linux-NameSpace-带来的问题（对比虚拟机）"><a href="#Linux-NameSpace-带来的问题（对比虚拟机）" class="headerlink" title="Linux NameSpace 带来的问题（对比虚拟机）"></a>Linux NameSpace 带来的问题（对比虚拟机）</h3><p>　　Linux NameSpace 的隔离并非只有好处，有利就有弊，主要的问题有以下两点。<br>　　1. 隔离的不彻底。<br>　　2. 有一些资源和对象无法被隔离。</p>
<h4 id="隔离的不彻底"><a href="#隔离的不彻底" class="headerlink" title="隔离的不彻底"></a>隔离的不彻底</h4><p>　　尽管我们可以在容器里通过 Mount Namespace 单独挂载其他不同版本的操作系统的 rootfs 文件，比如 CentOS 或者 Ubuntu 等各种 Linux 发行版，但这并不能改变共享宿主机内核的事实。这意味着，如果你要在 Windows 宿主机上运行 Linux 容器，或者在低版本的 Linux 宿主机上运行高版本或者低版本的 Linux 容器，都是行不通的。<br>　　而相比之下，拥有硬件虚拟化技术和独立 Guest OS 的虚拟机就要方便得多了。最极端的例子是，Microsoft 的云计算平台 Azure，实际上就是运行在 Windows 服务器集群上的，但这并不妨碍你在它上面创建各种 Linux 虚拟机出来。</p>
<h4 id="有一些资源和对象无法被隔离"><a href="#有一些资源和对象无法被隔离" class="headerlink" title="有一些资源和对象无法被隔离"></a>有一些资源和对象无法被隔离</h4><p>　　一个很经典的例子就是时间，如果在容器中调用 settimeofday 更改了时间，那么就会对宿主机以及所有宿主机上的容器造成影响，所以在生产环境中，没有人敢把运行在物理机上的容器直接暴露到公网上。<br>　　而虚拟机虚拟化的是完整的操作系统，完全不存在这样的顾虑。</p>
<p>　　当然，现在其实出现了一些基于虚拟化或者独立内核技术的容器实现，可以比较好地在隔离与性能之间做出平衡，后续我们也会对这种方案做一些介绍和实践。</p>
<h2 id="限制大法：Linux-Cgroups"><a href="#限制大法：Linux-Cgroups" class="headerlink" title="限制大法：Linux Cgroups"></a>限制大法：Linux Cgroups</h2><p>　　在使用了 NameSpace 做隔离之后，“容器”已经被创建出来了，但是当前被隔离的进程是完全没有做任何限制的，能够使用到100% 的物理资源，如内存、CPU等，这显然不符合我们的需求。<br>　　Linux Cgroups 就是我们用来对进程（组）做限制的系统能力。<br>　　Linux Cgroups 的全称是 Linux Control Group。它最主要的作用，就是限制一个进程组能够使用的资源上限，包括 CPU、内存、磁盘、网络带宽等等。<br>　　此外，Cgroups 还能够对进程进行优先级设置、审计，以及将进程挂起和恢复等操作。<br>　　<br>　　下面我们做一个试验，亲自操作一下 Cgroups 的限制能力。<br>　　在 Linux 中，Cgroups 暴露给用户的操作接口是文件系统的形式存在的，它以文件和目录的方式组织在操作系统的 /sys/fs/cgroup 路径下，使用 mount 命令可以将它展示出来。</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># mount -t cgroup </span></span><br><span class="line">cgroup on /sys/fs/cgroup/systemd <span class="built_in">type</span> cgroup (rw,nosuid,nodev,noexec,relatime,seclabel,xattr,release_agent=/usr/lib/systemd/systemd<span class="literal">-cgroups-agent</span>,name=systemd)</span><br><span class="line">cgroup on /sys/fs/cgroup/net_cls,net_prio <span class="built_in">type</span> cgroup (rw,nosuid,nodev,noexec,relatime,seclabel,net_cls,net_prio)</span><br><span class="line">cgroup on /sys/fs/cgroup/cpu,cpuacct <span class="built_in">type</span> cgroup (rw,nosuid,nodev,noexec,relatime,seclabel,cpu,cpuacct)</span><br><span class="line">cgroup on /sys/fs/cgroup/freezer <span class="built_in">type</span> cgroup (rw,nosuid,nodev,noexec,relatime,seclabel,freezer)</span><br><span class="line">cgroup on /sys/fs/cgroup/devices <span class="built_in">type</span> cgroup (rw,nosuid,nodev,noexec,relatime,seclabel,devices)</span><br><span class="line">cgroup on /sys/fs/cgroup/memory <span class="built_in">type</span> cgroup (rw,nosuid,nodev,noexec,relatime,seclabel,memory)</span><br><span class="line">cgroup on /sys/fs/cgroup/blkio <span class="built_in">type</span> cgroup (rw,nosuid,nodev,noexec,relatime,seclabel,blkio)</span><br><span class="line">cgroup on /sys/fs/cgroup/perf_event <span class="built_in">type</span> cgroup (rw,nosuid,nodev,noexec,relatime,seclabel,perf_event)</span><br><span class="line">cgroup on /sys/fs/cgroup/hugetlb <span class="built_in">type</span> cgroup (rw,nosuid,nodev,noexec,relatime,seclabel,hugetlb)</span><br><span class="line">cgroup on /sys/fs/cgroup/cpuset <span class="built_in">type</span> cgroup (rw,nosuid,nodev,noexec,relatime,seclabel,cpuset)</span><br><span class="line">cgroup on /sys/fs/cgroup/pids <span class="built_in">type</span> cgroup (rw,nosuid,nodev,noexec,relatime,seclabel,pids)</span><br><span class="line">cgroup on /sys/fs/cgroup/rdma <span class="built_in">type</span> cgroup (rw,nosuid,nodev,noexec,relatime,seclabel,rdma)</span><br></pre></td></tr></table></figure>
<p>　　这些诸如 cpuset、cpu、 memory 这样的子目录就是这台机器当前可以被 Cgroups 进行限制的资源种类。在对应的资源种类下，可以看到该类资源具体可以被限制的方法。</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># ls /sys/fs/cgroup/cpu</span></span><br><span class="line">cgroup.clone_children  cpuacct.stat       cpuacct.usage_percpu       cpuacct.usage_sys   cpu.cfs_quota_us   cpu.shares  kubepods           system.slice</span><br><span class="line">cgroup.procs           cpuacct.usage      cpuacct.usage_percpu_sys   cpuacct.usage_user  cpu.rt_period_us   cpu.stat    notify_on_release  tasks</span><br><span class="line">cgroup.sane_behavior   cpuacct.usage_all  cpuacct.usage_percpu_user  cpu.cfs_period_us   cpu.rt_runtime_us  docker      release_agent</span><br></pre></td></tr></table></figure>

<p>下面我们尝试使用 Cgroups 对自己运行的进程做限制。</p>
<p>写一个死循环程序，命名为 test.c，然后用 gcc 编译<br>程序源码：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">long</span> i=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;i++;&#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>操作：</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">master</span> <span class="type">cpu</span>]<span class="comment"># cd ~/</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># vi test.c</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># gcc test.c tes</span></span><br></pre></td></tr></table></figure>
<p>随后运行程序并使用 top 命令查看程序占用：</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># nohup ./test &amp;</span></span><br><span class="line">[<span class="number">1</span>] <span class="number">136487</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># top</span></span><br><span class="line">top - <span class="number">00</span>:<span class="number">30</span>:<span class="number">58</span> up  <span class="number">3</span>:<span class="number">26</span>,  <span class="number">3</span> users,  load average: <span class="number">1.16</span>, <span class="number">0.68</span>, <span class="number">0.66</span></span><br><span class="line">Tasks: <span class="number">287</span> total,   <span class="number">2</span> running, <span class="number">285</span> sleeping,   <span class="number">0</span> stopped,   <span class="number">0</span> zombie</span><br><span class="line">%Cpu(s): <span class="number">25.7</span> us,  <span class="number">0.5</span> sy,  <span class="number">0.0</span> <span class="built_in">ni</span>, <span class="number">71.4</span> id,  <span class="number">0.0</span> wa,  <span class="number">2.1</span> hi,  <span class="number">0.3</span> <span class="built_in">si</span>,  <span class="number">0.0</span> st</span><br><span class="line">MiB Mem :   <span class="number">7742.0</span> total,   <span class="number">3245.5</span> free,   <span class="number">2250.1</span> used,   <span class="number">2246.3</span> buff/cache</span><br><span class="line">MiB Swap:      <span class="number">0.0</span> total,      <span class="number">0.0</span> free,      <span class="number">0.0</span> used.   <span class="number">5115.1</span> avail Mem </span><br><span class="line"></span><br><span class="line">    PID USER      PR  <span class="built_in">NI</span>    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND                                                                                                </span><br><span class="line"> <span class="number">136487</span> root      <span class="number">20</span>   <span class="number">0</span>    <span class="number">4224</span>    <span class="number">824</span>    <span class="number">756</span> <span class="built_in">R</span>  <span class="number">97.0</span>   <span class="number">0.0</span>   <span class="number">1</span>:<span class="number">06.70</span> test                                                                                                   </span><br><span class="line">   <span class="number">3175</span> root      <span class="number">20</span>   <span class="number">0</span> <span class="number">1243688</span> <span class="number">528740</span>  <span class="number">75124</span> S   <span class="number">6.3</span>   <span class="number">6.7</span>  <span class="number">13</span>:<span class="number">34.29</span> kube<span class="literal">-apiserver</span>                                                                                         </span><br><span class="line">   <span class="number">1105</span> root      <span class="number">20</span>   <span class="number">0</span> <span class="number">2183524</span> <span class="number">121736</span>  <span class="number">74692</span> S   <span class="number">1.3</span>   <span class="number">1.5</span>   <span class="number">4</span>:<span class="number">58.10</span> kubelet                                                                                                </span><br><span class="line">  <span class="number">17097</span> root      <span class="number">20</span>   <span class="number">0</span>  <span class="number">889800</span> <span class="number">140096</span>  <span class="number">65000</span> S   <span class="number">1.3</span>   <span class="number">1.8</span>   <span class="number">3</span>:<span class="number">47.23</span> kube<span class="literal">-controller</span>                                                                                        </span><br><span class="line">   <span class="number">3288</span> root      <span class="number">20</span>   <span class="number">0</span>   <span class="number">10.2</span>g <span class="number">138408</span>  <span class="number">36164</span> S   <span class="number">1.0</span>   <span class="number">1.7</span>   <span class="number">3</span>:<span class="number">50.64</span> etcd                                                                                                   </span><br><span class="line">    <span class="number">742</span> root      <span class="number">20</span>   <span class="number">0</span>  <span class="number">154412</span>  <span class="number">49324</span>  <span class="number">41928</span> S   <span class="number">0.3</span>   <span class="number">0.6</span>   <span class="number">0</span>:<span class="number">45.41</span> systemd<span class="literal">-journal</span>                                                                                        </span><br><span class="line">   <span class="number">1754</span> root      <span class="number">20</span>   <span class="number">0</span> <span class="number">2328956</span> <span class="number">105312</span>  <span class="number">53004</span> S   <span class="number">0.3</span>   <span class="number">1.3</span>   <span class="number">1</span>:<span class="number">06.30</span> dockerd                                                                                                </span><br><span class="line">      <span class="number">1</span> root      <span class="number">20</span>   <span class="number">0</span>  <span class="number">252572</span>  <span class="number">14848</span>   <span class="number">9552</span> S   <span class="number">0.0</span>   <span class="number">0.2</span>   <span class="number">0</span>:<span class="number">05.89</span> systemd  </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>　　可以看到，我们的测试程序启动后 PID 为 136487 ，它在启动后几乎无节制的占用了 CPU 的 97% 左右。<br>　　<br>　　下面我们使用 Cgroups 对它做一些CPU限制：</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">master</span> ~]<span class="comment"># cd /sys/fs/cgroup/cpu/new_test/</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> <span class="type">new_test</span>]<span class="comment"># ls</span></span><br><span class="line">cgroup.clone_children  cpuacct.stat   cpuacct.usage_all     cpuacct.usage_percpu_sys   cpuacct.usage_sys   cpu.cfs_period_us  cpu.rt_period_us   cpu.shares  notify_on_release</span><br><span class="line">cgroup.procs           cpuacct.usage  cpuacct.usage_percpu  cpuacct.usage_percpu_user  cpuacct.usage_user  cpu.cfs_quota_us   cpu.rt_runtime_us  cpu.stat    tasks</span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> <span class="type">new_test</span>]<span class="comment"># cat cpu.cfs_quota_us</span></span><br><span class="line"><span class="literal">-1</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> <span class="type">new_test</span>]<span class="comment"># echo 100000 &gt; cpu.cfs_period_us</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> <span class="type">new_test</span>]<span class="comment"># echo 20000 &gt; cpu.cfs_quota_us</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> <span class="type">new_test</span>]<span class="comment"># cat cpu.cfs_quota_us</span></span><br><span class="line"><span class="number">20000</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> <span class="type">new_test</span>]<span class="comment"># echo 136487 &gt; tasks</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> <span class="type">new_test</span>]<span class="comment"># top</span></span><br><span class="line">top - <span class="number">00</span>:<span class="number">37</span>:<span class="number">05</span> up  <span class="number">3</span>:<span class="number">33</span>,  <span class="number">4</span> users,  load average: <span class="number">1.11</span>, <span class="number">1.32</span>, <span class="number">1.00</span></span><br><span class="line">Tasks: <span class="number">297</span> total,   <span class="number">2</span> running, <span class="number">295</span> sleeping,   <span class="number">0</span> stopped,   <span class="number">0</span> zombie</span><br><span class="line">%Cpu(s):  <span class="number">5.8</span> us,  <span class="number">0.5</span> sy,  <span class="number">0.0</span> <span class="built_in">ni</span>, <span class="number">91.7</span> id,  <span class="number">0.0</span> wa,  <span class="number">1.7</span> hi,  <span class="number">0.3</span> <span class="built_in">si</span>,  <span class="number">0.0</span> st</span><br><span class="line">MiB Mem :   <span class="number">7742.0</span> total,   <span class="number">3223.5</span> free,   <span class="number">2256.5</span> used,   <span class="number">2262.0</span> buff/cache</span><br><span class="line">MiB Swap:      <span class="number">0.0</span> total,      <span class="number">0.0</span> free,      <span class="number">0.0</span> used.   <span class="number">5100.6</span> avail Mem </span><br><span class="line"></span><br><span class="line">    PID USER      PR  <span class="built_in">NI</span>    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND                                                                                                </span><br><span class="line"> <span class="number">136487</span> root      <span class="number">20</span>   <span class="number">0</span>    <span class="number">4224</span>    <span class="number">824</span>    <span class="number">756</span> <span class="built_in">R</span>  <span class="number">19.9</span>   <span class="number">0.0</span>   <span class="number">6</span>:<span class="number">37.88</span> test                                                                                                   </span><br><span class="line">   <span class="number">3175</span> root      <span class="number">20</span>   <span class="number">0</span> <span class="number">1243688</span> <span class="number">528740</span>  <span class="number">75124</span> S   <span class="number">6.0</span>   <span class="number">6.7</span>  <span class="number">13</span>:<span class="number">59.71</span> kube<span class="literal">-apiserver</span>                                                                                         </span><br><span class="line">  <span class="number">17097</span> root      <span class="number">20</span>   <span class="number">0</span>  <span class="number">889800</span> <span class="number">134080</span>  <span class="number">65000</span> S   <span class="number">4.3</span>   <span class="number">1.7</span>   <span class="number">3</span>:<span class="number">54.87</span> kube<span class="literal">-controller</span>                                                                                        </span><br><span class="line">   <span class="number">3288</span> root      <span class="number">20</span>   <span class="number">0</span>   <span class="number">10.2</span>g <span class="number">138408</span>  <span class="number">36164</span> S   <span class="number">1.7</span>   <span class="number">1.7</span>   <span class="number">3</span>:<span class="number">56.05</span> etcd                                                                                                   </span><br><span class="line">   <span class="number">1105</span> root      <span class="number">20</span>   <span class="number">0</span> <span class="number">2183780</span> <span class="number">123964</span>  <span class="number">74692</span> S   <span class="number">1.0</span>   <span class="number">1.6</span>   <span class="number">5</span>:<span class="number">05.89</span> kubelet                                                                                                </span><br><span class="line">    <span class="number">742</span> root      <span class="number">20</span>   <span class="number">0</span>  <span class="number">170696</span>  <span class="number">56944</span>  <span class="number">49416</span> S   <span class="number">0.3</span>   <span class="number">0.7</span>   <span class="number">0</span>:<span class="number">46.87</span> systemd<span class="literal">-journal</span>                                                                                        </span><br><span class="line">    <span class="number">953</span> root      <span class="number">20</span>   <span class="number">0</span>  <span class="number">575876</span>  <span class="number">12372</span>  <span class="number">10484</span> S   <span class="number">0.3</span>   <span class="number">0.2</span>   <span class="number">0</span>:<span class="number">20.45</span> vmtoolsd                                                                                               </span><br><span class="line">   <span class="number">1057</span> root      <span class="number">20</span>   <span class="number">0</span> <span class="number">1647028</span>  <span class="number">60856</span>  <span class="number">24616</span> S   <span class="number">0.3</span>   <span class="number">0.8</span>   <span class="number">0</span>:<span class="number">05.48</span> containerd             </span><br></pre></td></tr></table></figure>

<p>实验完成。</p>
<p>而 docker 的 Cgroups 组其实就在 /sys/fs/cgroup/…/docker/…/ 下。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>　　综上所述，<strong>一个正在运行的 Docker 容器，其实就是启用了多个 Linux Namespace 的，受 Cgroups 配置的限制的应用进程</strong>。</p>
<p>　　然后我们就能自然而然的得出另一个结论，<strong>容器是一个“单进程”模型</strong>。</p>
]]></content>
      <categories>
        <category>云原生</category>
      </categories>
      <tags>
        <tag>云原生</tag>
        <tag>Docker</tag>
      </tags>
  </entry>
  <entry>
    <title>Docker？Docker！</title>
    <url>/posts/46315.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p><strong>是时代选择了 Docker？还是 Docker 选择了时代？</strong></p>
<p>本文是云原生系列的第二篇文章，主题是回顾容器的发展史。<br>在 PaaS 林立的时代，为什么开发者最终选择了 Docker？Docker 又是以怎样姿态给与了 PaaS 世界“降维打击”，直接宣告了 PaaS 时代的结束呢？</p>
<span id="more"></span>
<h2 id="云计算简介（可以跳过）"><a href="#云计算简介（可以跳过）" class="headerlink" title="云计算简介（可以跳过）"></a>云计算简介（可以跳过）</h2><p>　　<strong>后续回顾中会涉及到云计算的发展，故而先对云计算的相关模型知识略作解释，如果本身对这些知识已经了解的，建议直接进入</strong> <em><strong><a href="#%E5%8E%86%E5%8F%B2%E9%80%89%E6%8B%A9%E4%BA%86Docker">下一部分</a>。</strong></em></p>
<p>美国国家标准和技术研究院 2011 提出的的<span class="exturl" data-url="aHR0cHM6Ly9jc3JjLm5pc3QuZ292L3B1YmxpY2F0aW9ucy9kZXRhaWwvc3AvODAwLTE0NS9maW5hbA==">云计算定义<i class="fa fa-external-link-alt"></i></span>中明确了云计算的模型。该云模型由<a href="#%E4%BA%94%E4%B8%AA%E5%9F%BA%E6%9C%AC%E7%89%B9%E5%BE%81">五个基本特征</a>、<a href="#%E4%B8%89%E7%A7%8D%E6%9C%8D%E5%8A%A1%E6%A8%A1%E5%BC%8F">三种服务模式</a>和<a href="#%E5%9B%9B%E7%A7%8D%E9%83%A8%E7%BD%B2%E6%A8%A1%E5%9E%8B">四种部署模型</a>组成。</p>
<h3 id="五个基本特征"><a href="#五个基本特征" class="headerlink" title="五个基本特征"></a>五个基本特征</h3><p><strong>随需应变自助服务</strong>：</p>
<blockquote>
<p>可以向消费者单方面提供计算能力，例如服务器算力和网络存储，根据需要自动组合，无需消费者人工与每个服务提供商互动。</p>
</blockquote>
<p><strong>随时随地用任何网络设备访问</strong>：</p>
<blockquote>
<p>可经由异构瘦客户端或胖客户例如，手机、平板电脑、笔记本电脑和工作站）端通过网络使用标准方式访问的机制。</p>
</blockquote>
<p><strong>多人共享资源池</strong>：</p>
<blockquote>
<p>提供者的计算资源池以多租户模型为多个消费者服务，根据消费者需求分配和重新分配动态地使用不同的物理和虚拟资源。资源需要有位置感独立性，客户虽然无法控制或了解确切的所提供资源的位置，但能够在更高级别指定位置抽象（例如国家、省或数据中心）。资源的包括存储、处理、内存和网络带宽等。</p>
</blockquote>
<p><strong>快速弹性灵活部署</strong>：</p>
<blockquote>
<p>在某些情况下，可以自动地弹性配置和释放，根据需求快速向外和向内扩展。通常要给消费者提供近乎是无限的可以随时以任何数量配置的资源。</p>
</blockquote>
<p><strong>可被监控与量测的服务</strong>：</p>
<blockquote>
<p>云系统通过利用自动控制和优化资源为消费者提供某种抽象级别的计量能力。 其中的资源使用可以监控、控制和报告。</p>
</blockquote>
<p>除NIST的规范外，一般认为还有如下特征：</p>
<ul>
<li>基于虚拟化技术快速部署资源或获得服务。</li>
<li>减少用户终端的处理负担。</li>
<li>降低用户对于IT专业知识的依赖。</li>
</ul>
<h3 id="三种服务模式"><a href="#三种服务模式" class="headerlink" title="三种服务模式"></a>三种服务模式</h3><p><strong>软件即服务（SaaS）</strong>：</p>
<blockquote>
<p>消费者使用应用程序，但并不掌控操作系统、硬件或运作的网络基础架构。是一种服务观念的基础，软件服务供应商，以租赁的概念提供客户服务，而非购买，比较常见的模式是提供一组账号密码。例如：Adobe Creative Cloud，Microsoft CRM与Salesforce.com。</p>
</blockquote>
<p><strong>平台即服务（PaaS）</strong>：</p>
<blockquote>
<p>消费者使用主机操作应用程序。消费者掌控运作应用程序的环境（也拥有主机部分掌控权），但并不掌控操作系统、硬件或运作的网络基础架构。平台通常是应用程序基础架构。例如：Google App Engine。</p>
</blockquote>
<p><strong>基础设施即服务（IaaS）</strong>：</p>
<blockquote>
<p>消费者使用“基础计算资源”，如处理能力、存储空间、网络组件或中间件。消费者能掌控操作系统、存储空间、已部署的应用程序及网络组件（如防火墙、负载平衡器等），但并不掌控云基础架构。例如：Amazon AWS、Rackspace。</p>
</blockquote>
<h3 id="四种部署模型"><a href="#四种部署模型" class="headerlink" title="四种部署模型"></a>四种部署模型</h3><p><strong>公有云（Public Cloud）</strong>：</p>
<blockquote>
<p>简而言之，公用云服务可透过网络及第三方服务供应者，开放给客户使用，“公用”一词并不一定代表“免费”，但也可能代表免费或相当廉价，公用云并不表示用户资料可供任何人查看，公用云供应者通常会对用户实施使用访问控制机制，公用云作为解决方案，既有弹性，又具备成本效益。</p>
</blockquote>
<p><strong>私有云（Private Cloud）</strong>：</p>
<blockquote>
<p>私有云具备许多公用云环境的优点，例如弹性、适合提供服务，两者差别在于私有云服务中，资料与程序皆在组织内管理，且与公用云服务不同，不会受到网络带宽、安全疑虑、法规限制影响；此外，私有云服务让供应者及用户更能掌控云基础架构、改善安全与弹性，因为用户与网络都受到特殊限制。</p>
</blockquote>
<p><strong>社群云（Community Cloud）</strong>：</p>
<blockquote>
<p>社群云由众多利益相仿的组织掌控及使用，例如特定安全要求、共同宗旨等。社群成员共同使用云资料及应用程序。</p>
</blockquote>
<p><strong>混合云（Hybrid Cloud）</strong>：</p>
<blockquote>
<p>混合云结合公用云及私有云，这个模式中，用户通常将非企业关键信息外包，并在公用云上处理，但同时掌控企业关键服务及资料。</p>
</blockquote>
<h2 id="历史选择了Docker"><a href="#历史选择了Docker" class="headerlink" title="历史选择了Docker"></a>历史选择了Docker</h2><h3 id="2000-2010：云计算伊始，群雄并起"><a href="#2000-2010：云计算伊始，群雄并起" class="headerlink" title="2000-2010：云计算伊始，群雄并起"></a>2000-2010：云计算伊始，群雄并起</h3><p>　　2000 年到 2010 年这十年里，除了语言们本身的迭代与竞争外，后端领域最主要的新玩意，就是在这一时期逐渐兴起的云计算了。<br>　　各大互联网公司或是自身架构过渡到大规模分布式系统之后，意识到研发成果可以为公众所用，或者是弹性计算设计中，有大量的冗余服务器白白浪费资源，或者是对先行者的模仿，总之这一时期，各个厂商开始推出以 IaaS 服务模式为主的云计算服务，涌现的主要玩家包括 ：</p>
<ul>
<li><strong>【AWS】</strong>Amazon Web Services（2002）</li>
<li><strong>【GCP】</strong>Google Cloud Platform（2008）</li>
<li><strong>【Azure】</strong>Microsoft Azure（2008）</li>
<li><strong>【Aliyun】</strong>Alibaba Cloud（2009）</li>
<li><strong>【OpenStack】</strong>OpenStack（2010）</li>
</ul>
<h3 id="2011-2013：逐鹿中原"><a href="#2011-2013：逐鹿中原" class="headerlink" title="2011-2013：逐鹿中原"></a>2011-2013：逐鹿中原</h3><p>　　云计算给开发者的兴奋渐渐消退，或许是期待太高，云计算的形象从原来的高大上逐渐幻灭，最终抓住的只是实实在在的虚拟机和长长的账单。而这时各家云计算平台的竞争也已经逐渐明朗，如日中天的 AWS 、盛极一时的 OpenStack、紧追不放的 Azure、GCP，还有大吃中国这一时期互联网合规性政策红利的 Aliyun。<br>　　与此同时，以 Cloud Foundry 为代表的项目，开始尝试探索 PaaS 服务模式方向。</p>
<h3 id="2013-2014：Docker！"><a href="#2013-2014：Docker！" class="headerlink" title="2013-2014：Docker！"></a>2013-2014：Docker！</h3><p>　　2013 年是云计算发展较为关键的一个年头， Cloud Foundry 已经完成了最艰难的普及阶段，吸引了包裹IBM，华为、百度、京东等一大批顶尖技术厂商，以开源 PaaS 为核心构建平台层服务能力的思维已经得到了普遍接受，这一时期的云计算从业者仿佛渡过长夜看到曙光的疲惫旅人，PaaS 时代即将降临已经成为了大家的共识。<br>　　然而，互联网世界从来不缺少的就是变革者，几乎被钦定的 Cloud Foundry 没能携着大家的期待将 PaaS 的辉煌普照开来，当然某种意义上，大家的共识也没有错，PaaS 时代的确要来了，就在这一年，我们的真正主角，<strong>名为 Docker 的开源项目诞生了</strong>。<br>　　在 Red Hat、Pivotal 这些 PaaS 弄潮儿们推崇着以 Cloud Foundry 社区为主的主流方案的同时，PaaS 热潮中一个名不见经传的小公司 dotCloud 艰难维护着自己主打产品。因为该产品跟主流的 Cloud Foundry 社区脱节，长期以来无人问津，眼看就要被 PaaS 风潮抛弃的时候，2013年3月13日 dotCloud 公司做出了这样一个决定：开源自己的容器项目 Docker，当然，这件事在当时根本没人在乎，但命运就是这样有趣，PaaS 发展的拐点就这样近乎悄无声息的发生了。<br>　　其实粗粗看来，Docker 跟这一时期的其他 PaaS 产品如 Cloud Foundry 相比，并没有什么明显的不同，使用 Cgroups 和 Namespace 实现的原理几乎一样的沙盒，在它发布后不久，Cloud Foundry 的首席产品经理 James Bayer 就在社区里做了一次详细对比，结论是没有什么特别的黑科技，也不需要特别关注。<br>　　James Bayer 的分析确实没有错，<strong>Docker 大部分功能和底层原理都和 Cloud Foundry 一致</strong>，但是他也没能预料到，就是这一小部分不一样的，甚至没能被他正视的功能，让 Docker 在接下来的<strong>短短几个月</strong>迅速崛起，以近乎三体中“降维打击”的姿态，将包含 Cloud Foundry 在内的一众 PaaS 社区横扫出局。<br>　　<strong>这个功能，就是看似不起眼的 Docker 镜像。</strong><br>　　Docker 镜像解决了一个当时所有其他 PaaS 方案都没有解决的问题：<strong>保证环境的高度一致</strong>。<br>　　以 Cloud Foundry 为例，当时的其他 PaaS 方案踩坑成本极大，虽然一样有打包和部署的逻辑，但是必须为每种语言、每种框架，甚至每个版本的应用维护一个打好的包，经常遇到的情况是，明明在本地运行得好好的应用，推送到 PaaS 却不能正常运行，而是需要做大量缺少章法的修改和配置，在不断试错之后才能搞定。<br>　　而 Docker 镜像其实就是将整个系统的关键文件都作为基础环境打包，因此使用 Docker 镜像让用户完全不需要环境的试错成本，原本作为 PaaS 系统中最核心的打包系统被彻底抛弃。<br>　　而这正是 Docker 镜像的精妙之处，或许连作者 Solomon Hykes 都没有意识到，这个小小的创新不止给 Docker 带来了碾压级的实力，还推动整个云计算领域迅速的走上了快车道。<br>　　对于开发者们来说，在终于体验到了　Docker 镜像丝滑般的流畅感之后，自然而然的用脚投票，直接宣告了 PaaS 争霸时代的结束。<br>　　不过，Docker 项目固然解决了应用打包的难题，但是它并不具有 PaaS 大规模部署应用的能力，Docker 集群管理的需求迫在眉睫，而这时的过气王者如果能够使用 Docker 替换掉自己原有的打包模块，完全有机会再次卷土重来，但是因为 Docker 的一些商业上的潜在问题以及错误的判断的 Docker 的发展势头，错过了这个窗口期，反而是一些嗅觉敏锐的创业公司瞅准了机会，推出了如 Deis 和 Flynn 等的 Docker 容器集群管理的开源项目，这一类工具有了一个新的名称， CaaS，即 Container-as-a-Service。<br>　　2013年底，dotCloud 宣布将公司直接改名为 Docker。<br>　　2014年底，Docker 公司发布了自家的 CaaS —— “原生容器集群管理项目：Swarm”，雄心勃勃的准备实现自己重新定义 PaaS 的宏愿，这无疑是 Docker 的高光时刻，梦想似乎触手可及，想来当时的 Docker 员工和我写稿的现在一样，一定是激情澎湃，指点江山。<br>　　可惜作为未来人我们清楚地知道，属于 Docker 的奇迹并没有延续，未来属于 Kubernetes，至于这段故事，欢迎关注公众号“云原生之光”或者<a href="https://blog.wayneshao.com/">我的博客</a>，未来我会慢慢讲给大家听。</p>
<h2 id="为什么是-Docker？"><a href="#为什么是-Docker？" class="headerlink" title="为什么是 Docker？"></a>为什么是 Docker？</h2><p>　　讲到最后，我们来总结点题，“为什么是 Docker？”。<br>　　答案显而易见，正是因为 Docker 出现的这个时间点，PaaS 在普及和落地的同时，也让“打包”问题成了大家共同的困扰，而 Docker 创造性的设计了 <strong>Docker 镜像机制</strong>，降维打击般的破解了困局，近乎完美的解决了“打包”问题。<strong>Docker 镜像在技术上其实不难，但要想出这个方法，却是一个从0到1的突破</strong>，或许是误打误撞，也或许是真正洞察了 PaaS 的命门，这个创举正是 Docker 横扫云计算完成大一统的原因。</p>
]]></content>
      <categories>
        <category>云原生</category>
      </categories>
      <tags>
        <tag>云原生</tag>
        <tag>Docker</tag>
        <tag>云计算</tag>
      </tags>
  </entry>
  <entry>
    <title>CentOS8 使用 Docker 部署 GitLab-CE</title>
    <url>/posts/51370.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="最近需要在公司的CentOS7服务器上部署一套GitLab服务，打算采用Docker来完成，记录一下部署过程。"><a href="#最近需要在公司的CentOS7服务器上部署一套GitLab服务，打算采用Docker来完成，记录一下部署过程。" class="headerlink" title="最近需要在公司的CentOS7服务器上部署一套GitLab服务，打算采用Docker来完成，记录一下部署过程。"></a>最近需要在公司的CentOS7服务器上部署一套GitLab服务，打算采用Docker来完成，记录一下部署过程。</h2><p>2021-07-05<br>更新：</p>
<ol>
<li>系统升级为CentOS8</li>
<li>因为GitLab新版本直接支持了中文且GitLab-CE-CN一直没有更新，故而镜像换成了GitLab-CE</li>
<li>redis 升级为最新版</li>
<li>实践中发现默认源安装的pip版本安装docker-compose时必然出错，故而加入更新pip步骤</li>
<li>实际使用过程中发现docker网段在阿里云非常容易和企业内网网段冲突，故而新建网络时增加指定生僻网段<span id="more"></span>
<h2 id="安装-Docker-与-Docker-Compose"><a href="#安装-Docker-与-Docker-Compose" class="headerlink" title="安装 Docker 与 Docker Compose"></a>安装 Docker 与 Docker Compose</h2><h3 id="安装-Docker"><a href="#安装-Docker" class="headerlink" title="安装 Docker"></a>安装 Docker</h3><h4 id="卸载旧版本-新机可忽略"><a href="#卸载旧版本-新机可忽略" class="headerlink" title="卸载旧版本(新机可忽略)"></a>卸载旧版本(新机可忽略)</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo yum remove -y docker \</span><br><span class="line">                 docker-client \</span><br><span class="line">                 docker-client-latest \</span><br><span class="line">                 docker-common \</span><br><span class="line">                 docker-latest \</span><br><span class="line">                 docker-latest-logrotate \</span><br><span class="line">                 docker-logrotate \</span><br><span class="line">                 docker-engine</span><br></pre></td></tr></table></figure>
<h4 id="安装所需包"><a href="#安装所需包" class="headerlink" title="安装所需包"></a>安装所需包</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo yum install -y yum-utils \</span><br><span class="line">                    device-mapper-persistent-data \</span><br><span class="line">                    lvm2</span><br></pre></td></tr></table></figure>
<h4 id="配置仓库"><a href="#配置仓库" class="headerlink" title="配置仓库"></a>配置仓库</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo yum-config-manager \</span><br><span class="line">    --add-repo \</span><br><span class="line">    https://download.docker.com/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure>
<h4 id="安装-Docker-Engine-Community"><a href="#安装-Docker-Engine-Community" class="headerlink" title="安装 Docker Engine Community"></a>安装 Docker Engine Community</h4>安装最新版本的 Docker Engine-Community 和 containerd<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo yum install -y docker-ce \</span><br><span class="line">                 docker-ce-cli \</span><br><span class="line">                 containerd.io</span><br></pre></td></tr></table></figure>
如果提示接受 GPG 密钥，选yes。<h4 id="启动-Docker"><a href="#启动-Docker" class="headerlink" title="启动 Docker"></a>启动 Docker</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo systemctl start docker</span><br></pre></td></tr></table></figure>
<h4 id="验证安装"><a href="#验证安装" class="headerlink" title="验证安装"></a>验证安装</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo docker -v</span><br><span class="line">sudo docker run hello-world</span><br></pre></td></tr></table></figure>
正确输出如下<br><img data-src="https://qiniucdn.wayneshao.com/centos-docker-gitlab20191213110159557.png"></li>
</ol>
<h3 id="安装-Docker-Compose"><a href="#安装-Docker-Compose" class="headerlink" title="安装 Docker Compose"></a>安装 Docker Compose</h3><h4 id="安装企业Linux的额外软件包"><a href="#安装企业Linux的额外软件包" class="headerlink" title="安装企业Linux的额外软件包"></a>安装企业Linux的额外软件包</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo yum install -y epel-release</span><br></pre></td></tr></table></figure>
<h4 id="安装并更新-python3-pip"><a href="#安装并更新-python3-pip" class="headerlink" title="安装并更新 python3-pip"></a>安装并更新 python3-pip</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo yum install -y python3-pip</span><br><span class="line">python3 -m pip install -U pip</span><br></pre></td></tr></table></figure>
<h4 id="安装-Docker-Compose-1"><a href="#安装-Docker-Compose-1" class="headerlink" title="安装 Docker Compose"></a>安装 Docker Compose</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo pip3 install docker-compose</span><br></pre></td></tr></table></figure>
<h4 id="验证安装-1"><a href="#验证安装-1" class="headerlink" title="验证安装"></a>验证安装</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker-compose version</span><br></pre></td></tr></table></figure>
<p>正确输出如下<br><img data-src="https://qiniucdn.wayneshao.com/centos-docker-gitlab20191213110723662.png"></p>
<h2 id="安装-Redis-和-GitLab"><a href="#安装-Redis-和-GitLab" class="headerlink" title="安装 Redis 和 GitLab"></a>安装 Redis 和 GitLab</h2><h3 id="Network"><a href="#Network" class="headerlink" title="Network"></a>Network</h3><p>我这边预计会复用Redis，所以要创建单独的Redis镜像，那么在创建之前，需要先见一个 network 用于将多个镜像放置在同一网络环境下。（如果局域网中已经存在对应网段，请自行替换）</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo docker network create \</span><br><span class="line">  --driver=bridge \</span><br><span class="line">  --subnet=192.112.0.0/16 \</span><br><span class="line">  --ip-range=192.112.5.0/24 \</span><br><span class="line">  --gateway=192.112.5.254 \</span><br><span class="line">  net_default</span><br></pre></td></tr></table></figure>
<h3 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h3><p>下面创建 Redis，我这里使用 Docker Compose 来完成。<br>新建一个文件夹并将其重命名为 Redis，在 Redis 文件夹中创建 config 文件夹，而后在 config 文件夹中创建 Redis 的配置文件 redis.conf</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="comment">#redis的databases数量</span></span><br><span class="line"><span class="attribute">databases</span> <span class="number">32</span></span><br><span class="line"><span class="comment">#redis密码</span></span><br><span class="line">requirepass qm4Cqd3srYK0MHTPEZmf</span><br></pre></td></tr></table></figure>
<p>在 Redis 目录中新建 docker-compose.yml 脚本:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">redis:</span> </span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">db-redis</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">6379</span><span class="string">:6379</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">net_default</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./config:/docker/config</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data:/data</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">redis-server</span> <span class="string">/docker/config/redis.conf</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">net_default:</span></span><br><span class="line">    <span class="attr">external:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>然后在 docker-compose.yml 所在目录下<br>接下来，在 docker-compose.yml 所在目录运行 docker-compose:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>
<p><img data-src="https://qiniucdn.wayneshao.com/centos-docker-gitlab20191213055427131.png"></p>
<h3 id="GitLab"><a href="#GitLab" class="headerlink" title="GitLab"></a>GitLab</h3><p>新建一个文件夹并将其重命名为 GitLab，在 GitLab 文件夹中创建 config 文件夹，在 config 文件夹中创建 ssl 文件夹，而后将我们的 SSL 证书拷贝到 ssl 目录中。<br><img data-src="https://qiniucdn.wayneshao.com/centos-docker-gitlab20191213055037651.png"><br>而后回到 GitLab 文件夹开始编写我们的 docker-compose.yml</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">gitlab-ce:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">&#x27;gitlab/gitlab-ce:13.0.14-ce.0&#x27;</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">gitlab-ce</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">&#x27;Asia/Shanghai&#x27;</span></span><br><span class="line">      <span class="attr">GITLAB_OMNIBUS_CONFIG:</span> <span class="string">|</span></span><br><span class="line"><span class="string">        external_url &#x27;https://gitlab.apukj.com&#x27;</span></span><br><span class="line"><span class="string">        nginx[&#x27;redirect_http_to_https&#x27;] = true</span></span><br><span class="line"><span class="string">        nginx[&#x27;ssl_certificate&#x27;] = &quot;/etc/gitlab/ssl/5216854__apukj.com.pem&quot;</span></span><br><span class="line"><span class="string">        nginx[&#x27;ssl_certificate_key&#x27;] = &quot;/etc/gitlab/ssl/5216854__apukj.com.key&quot;</span></span><br><span class="line"><span class="string">        gitlab_rails[&#x27;time_zone&#x27;] = &#x27;Asia/Shanghai&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">        <span class="string">gitlab_rails[&#x27;smtp_enable&#x27;]</span> <span class="string">=</span> <span class="literal">true</span></span><br><span class="line">        <span class="string">gitlab_rails[&#x27;smtp_address&#x27;]</span> <span class="string">=</span> <span class="string">&#x27;smtp.exmail.qq.com&#x27;</span></span><br><span class="line">        <span class="string">gitlab_rails[&#x27;smtp_port&#x27;]</span> <span class="string">=</span> <span class="number">465</span></span><br><span class="line">        <span class="string">gitlab_rails[&#x27;smtp_user_name&#x27;]</span> <span class="string">=</span> <span class="string">&#x27;admin@apukj.com&#x27;</span></span><br><span class="line">        <span class="string">gitlab_rails[&#x27;smtp_password&#x27;]</span> <span class="string">=</span> <span class="string">&#x27;FmSM8juiYywqJnXv&#x27;</span></span><br><span class="line">        <span class="string">gitlab_rails[&#x27;smtp_domain&#x27;]</span> <span class="string">=</span> <span class="string">&#x27;smtp.exmail.qq.com&#x27;</span></span><br><span class="line">        <span class="string">gitlab_rails[&#x27;smtp_authentication&#x27;]</span> <span class="string">=</span> <span class="string">&#x27;login&#x27;</span></span><br><span class="line">        <span class="string">gitlab_rails[&#x27;smtp_enable_starttls_auto&#x27;]</span> <span class="string">=</span> <span class="literal">true</span></span><br><span class="line">        <span class="string">gitlab_rails[&#x27;smtp_tls&#x27;]</span> <span class="string">=</span> <span class="literal">true</span></span><br><span class="line">        <span class="string">gitlab_rails[&#x27;gitlab_email_enabled&#x27;]</span> <span class="string">=</span> <span class="literal">true</span></span><br><span class="line">        <span class="string">gitlab_rails[&#x27;gitlab_email_from&#x27;]</span> <span class="string">=</span> <span class="string">&#x27;admin@apukj.com&#x27;</span></span><br><span class="line">        <span class="string">gitlab_rails[&#x27;gitlab_email_display_name&#x27;]</span> <span class="string">=</span> <span class="string">&#x27;阿铺科技源码服务&#x27;</span></span><br><span class="line">        <span class="string">gitlab_rails[&#x27;gitlab_email_reply_to&#x27;]</span> <span class="string">=</span> <span class="string">&#x27;admin@apukj.com&#x27;</span></span><br><span class="line">        <span class="string">user[&quot;git_user_email&quot;]</span> <span class="string">=</span> <span class="string">&#x27;admin@apukj.com&#x27;</span></span><br><span class="line">        <span class="comment">#修改sidekiq的数量，减少内存占用，默认为15，也可以不填</span></span><br><span class="line">        <span class="string">sidekiq[&#x27;concurrency&#x27;]</span> <span class="string">=</span> <span class="number">10</span></span><br><span class="line">        <span class="comment">#使用外部redis所需设置，根据刚刚生成的redis设置修改</span></span><br><span class="line">        <span class="string">gitlab_rails[&#x27;redis_port&#x27;]</span> <span class="string">=</span> <span class="number">6379</span></span><br><span class="line">        <span class="string">gitlab_rails[&#x27;redis_host&#x27;]</span> <span class="string">=</span> <span class="string">&#x27;db-redis&#x27;</span></span><br><span class="line">        <span class="string">gitlab_rails[&#x27;redis_password&#x27;]</span> <span class="string">=</span> <span class="string">&#x27;edHtDM44XbOzsQcEXlaR&#x27;</span></span><br><span class="line">        <span class="string">gitlab_rails[&#x27;redis_database&#x27;]</span> <span class="string">=</span> <span class="string">&#x27;1&#x27;</span></span><br><span class="line">        <span class="comment">#因为22端口被占用，修改映射的端口号时，同时修改在Gitlab项目中的ssh地址加上端口号</span></span><br><span class="line">        <span class="string">gitlab_rails[&#x27;gitlab_shell_ssh_port&#x27;]</span> <span class="string">=</span> <span class="number">24</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;80:80&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;443:443&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;24:22&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;5432:5432&#x27;</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">net_default</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./config:/etc/gitlab</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data:/var/opt/gitlab</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./logs:/var/log/gitlab</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">net_default:</span></span><br><span class="line">    <span class="attr">external:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>接下来，在 docker-compose.yml 所在目录运行 docker-compose:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>
<p><img data-src="https://qiniucdn.wayneshao.com/centos-docker-gitlab20191213055352508.png"><br>至此，我们完成了使用 Docker 搭建 GitLab 的全过程，直接访问HTTP对应服务器的80/443端口接口即可：<br><img data-src="https://qiniucdn.wayneshao.com/centos-docker-gitlab20191213055609985.png"></p>
<h2 id="踩坑记录"><a href="#踩坑记录" class="headerlink" title="踩坑记录"></a>踩坑记录</h2><h3 id="docker端口映射或启动容器时报错Error-response-from-daemon-driver-failed-programming-external-connectivity-on-endpoint"><a href="#docker端口映射或启动容器时报错Error-response-from-daemon-driver-failed-programming-external-connectivity-on-endpoint" class="headerlink" title="docker端口映射或启动容器时报错Error response from daemon: driver failed programming external connectivity on endpoint"></a>docker端口映射或启动容器时报错Error response from daemon: driver failed programming external connectivity on endpoint</h3><p>docker服务启动时定义的自定义链DOCKER由于某种原因被清掉<br>重启docker服务及可重新生成自定义链DOCKER</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure>

<h3 id="SMTP-验证失败"><a href="#SMTP-验证失败" class="headerlink" title="SMTP 验证失败"></a>SMTP 验证失败</h3><p>163、QQ等邮箱在开启了授权码之后，需要使用授权码做协议登陆。</p>
<h3 id="阿里云，启动以后无法通过外部访问"><a href="#阿里云，启动以后无法通过外部访问" class="headerlink" title="阿里云，启动以后无法通过外部访问"></a>阿里云，启动以后无法通过外部访问</h3><p>首先需要排除防火墙问题，firewall 和 iptables 均需要处理，处理后如果仍然不行，那可能是阿里云自身的安全策略问题，需要在管理后台设置。</p>
<h3 id="阿里云，邮件无法发送"><a href="#阿里云，邮件无法发送" class="headerlink" title="阿里云，邮件无法发送"></a>阿里云，邮件无法发送</h3><p>可能是阿里云对 25 端口做了屏蔽，可以按照我给出的配置，使用 SSL 的 SMTP 端口 465 。</p>
]]></content>
      <categories>
        <category>踩坑笔记</category>
      </categories>
      <tags>
        <tag>Docker</tag>
        <tag>Linux</tag>
        <tag>CentOS</tag>
        <tag>GitLab</tag>
      </tags>
  </entry>
  <entry>
    <title>Docker原理解析——镜像</title>
    <url>/posts/46317.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>　　上一篇，我们主要分析了 Docker 沙盒机制的实现原理。但是光有沙盒还不够，Docker 为了实现“一致性”，引入了 Docker 镜像这一项伟大的创举，使得容器的传递和迁移更加简单，这一篇我们来用一个扒一扒 Docker 镜像的具体原理。</p>
<span id="more"></span>
<p>回忆一下，前文提到的一个容器启动的过程如下：</p>
<ol>
<li>配置 Linux Namespace</li>
<li>设置 Cgroups 参数</li>
<li>切换进程更目录</li>
</ol>
<h2 id="镜像的内容构成"><a href="#镜像的内容构成" class="headerlink" title="镜像的内容构成"></a>镜像的内容构成</h2><p>　　步骤 3 切换到的进程根目录的内容就是为容器进程提供隔离的执行环境的文件系统，着整个文件系统就是镜像中的全部文件了，在 Linux 操作系统的语境下，这样的一个完整系统，被称为根文件系统，简称 rootfs。<br>　　不过需要注意的是，rootfs 包含的是一个完整操作系统（如Ubuntu、CentOS）的全部文件，但是也仅仅是文件而已，在 Linux 系统中，操作系统内核和 rootfs 是分开存放的，操作系统只有在开机时才会加载某个固定版本的内核镜像。<br>　　换而言之，就是说，虽然我们在打包镜像时可以选择各种不同的操作系统，但是在具体运行镜像时，不管是什么操作系统，同一台宿主机上运行的所有容器都共享宿主机操作系统的内核，这就意味着，和内核相关的操作，相当于会被应用于宿主机以及宿主机上所有的容器，带来额外的安全隐患，而在虚拟机时代，这样的隐患是不存在的。<br>　　Docker 镜像的设计中还有一个创举，不是单纯的将所有文件打包到一个镜像再一股脑儿挂载到某个目录，而是引入了<strong>分层挂载</strong>的概念，用户在制作镜像时，每一步操作都会生成一个层，基础镜像再加上所有的层，以一种增量的方式构成了打包的新镜像。</p>
<h2 id="镜像如何被挂载"><a href="#镜像如何被挂载" class="headerlink" title="镜像如何被挂载"></a>镜像如何被挂载</h2><p>联系上文内存，步骤 3 实际上可以划分为挂载文件和切换根目录两个操作，具体步骤如下：</p>
<ol>
<li>创建只读层（即容器镜像中的内容）</li>
<li>创建读写层（writeLayer）</li>
<li>创建 Init 层</li>
<li>创建挂载点（mnt），并把只读层、读写层和 Init 层挂载到挂载点</li>
<li>将挂载点作为容器的根目录</li>
</ol>
<p><strong>只读层</strong>中包含的就是 Docker 镜像中的文件，挂载方式是 ro+wh，无法被修改，但是可以被其它层遮挡覆盖。</p>
<p><strong>读写层</strong>在挂载初期是空的，挂载方式为rw，可以进行读写操作，在容器中做了任何写操作，修改产生的内容就会以增量的方式出现在读写层中，如果对只读层中的 rootfs 中的文件做了删除或修改，读写层会产生对应的新文件，由于挂载时是依次挂载的，后挂载的读写层里的改动会遮挡覆盖掉只读层的文件，以实现真实的读写效果。</p>
<p><strong>Init 层</strong>是 Docker 生成的一个内部层，用来存放 /etc/*.conf 等本来属于镜像一部分的配置文件，这些修改往往只是对当前容易有效，为了防止 commit 时把这些修改也提交，故而没有放在读写层，而是单独了一层。</p>
<p>这三类层挂载在一起，就是一个容器的完整文件系统了。</p>
]]></content>
      <categories>
        <category>云原生</category>
      </categories>
      <tags>
        <tag>云原生</tag>
        <tag>Docker</tag>
      </tags>
  </entry>
  <entry>
    <title>【微服务学习】Consul 服务治理发现</title>
    <url>/posts/15089.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="Consul-服务治理发现"><a href="#Consul-服务治理发现" class="headerlink" title="Consul 服务治理发现"></a>Consul 服务治理发现</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>　　Consul 是 HashiCorp 公司推出的开源工具，用于实现分布式系统的服务发现与配置。与其他分布式服务注册与发现的方案，Consul的方案更“<strong>一站式</strong>”，内置了服务注册与发现框架、分布一致性协议实现、健康检查、Key/Value存储、多数据中心方案，不再需要依赖其他工具（比如ZooKeeper等）。使用起来也较为简单。Consul使用Go语言编写，因此具有天然可移植性(支持Linux、windows和Mac OS X)；安装包仅包含一个可执行文件，方便部署，与Docker等轻量级容器可无缝配合 。</p>
<ul>
<li><strong>service discovery</strong>：consul通过DNS或者HTTP接口使服务注册和服务发现变的很容易，一些外部服务，例如saas提供的也可以一样注册。</li>
<li><strong>health checking</strong>：健康检测使consul可以快速的告警在集群中的操作。和服务发现的集成，可以防止服务转发到故障的服务上面。</li>
<li><strong>key/value storage</strong>：一个用来存储动态配置的系统。提供简单的HTTP接口，可以在任何地方操作。</li>
<li>*<em>multi-datacenter</em>：无需复杂的配置，即可支持任意数量的区域。</li>
</ul>
<p>　　Consul 是注册中心，服务提供者、服务消费者等都要注册到 Consul 中，这样就可以实现服务提供者、服务消费者的隔离。<br>　　除了 Consul 之外，还有 Eureka、Zookeeper、Etcd 等类似服务发现框架。</p>
<h3 id="Consul-相关概念"><a href="#Consul-相关概念" class="headerlink" title="Consul 相关概念"></a>Consul 相关概念</h3><p><img data-src="https://qiniucdn.wayneshao.com/Consul-%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86%E5%8F%91%E7%8E%B0/20190220082541153.png"></p>
<ul>
<li><p><strong>CLIENT</strong><br>CLIENT表示consul的client模式，就是客户端模式。是consul节点的一种模式，这种模式下，所有注册到当前节点的服务会被转发到SERVER，本身是不持久化这些信息。</p>
</li>
<li><p><strong>SERVER</strong><br>SERVER表示consul的server模式，表明这个consul是个server，这种模式下，功能和CLIENT都一样，唯一不同的是，它会把所有的信息持久化的本地，这样遇到故障，信息是可以被保留的。</p>
</li>
<li><p><strong>SERVER-LEADER</strong><br>中间那个SERVER下面有LEADER的字眼，表明这个SERVER是它们的老大，它和其它SERVER不一样的一点是，它需要负责同步注册的信息给其它的SERVER，同时也要负责各个节点的健康监测。</p>
</li>
<li><p><strong>其它信息</strong><br>其它信息包括它们之间的通信方式，还有一些协议信息，算法。它们是用于保证节点之间的数据同步，实时性要求等等一系列集群问题的解决。这些有兴趣的自己看看官方文档。</p>
</li>
</ul>
<h3 id="我的理解"><a href="#我的理解" class="headerlink" title="我的理解"></a>我的理解</h3><p>　　Consul 的整体功能其实就类似于互联网中的 DNS 服务器，Consul 服务端根据客户端传入的服务名，返回所有提供该服务的地址，整个流程跟 DNS 服务器将域名转化为 IP 地址有异曲同工之妙。</p>
<h2 id="Consul-在-NET-Core-下的实践"><a href="#Consul-在-NET-Core-下的实践" class="headerlink" title="Consul 在 .NET Core 下的实践"></a>Consul 在 .NET Core 下的实践</h2><p>　　我是用的开发平台是 Windows 64bit，鉴于 Windows 使用 Docker 的繁琐和诸多问题，以下流程直接下载运行 Consul 而不使用 Docker。</p>
<h3 id="下载安装运行"><a href="#下载安装运行" class="headerlink" title="下载安装运行"></a>下载安装运行</h3><ol>
<li>从<span class="exturl" data-url="aHR0cHM6Ly93d3cuY29uc3VsLmlvL2Rvd25sb2Fkcy5odG1s">Consul 下载页面<i class="fa fa-external-link-alt"></i></span>下载对应平台的最新版本的 Consul 程序并解压。<br><img data-src="https://qiniucdn.wayneshao.com/Consul-%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86%E5%8F%91%E7%8E%B0/20190220085150466.png"><br><img data-src="https://qiniucdn.wayneshao.com/Consul-%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86%E5%8F%91%E7%8E%B0/20190220085227813.png"></li>
<li>运行 <strong>consul.exe agent -dev</strong> （使用开发模式进行测试，如需生产环境集群使用，只要需要一台 Server，多台 Agent）<br><img data-src="https://qiniucdn.wayneshao.com/Consul-%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86%E5%8F%91%E7%8E%B0/20190220085306129.png"></li>
<li>访问自带的 Web 后台查看即时信息<br><img data-src="https://qiniucdn.wayneshao.com/Consul-%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86%E5%8F%91%E7%8E%B0/20190220085443153.png"></li>
</ol>
<h3 id="NET-Core-下的-Consul-实践"><a href="#NET-Core-下的-Consul-实践" class="headerlink" title=".NET Core 下的 Consul 实践"></a>.NET Core 下的 Consul 实践</h3><blockquote>
<p>Install-Package Consul</p>
</blockquote>
<p>　　<strong>程序与 Consul 的交互主要有三种：</strong></p>
<ul>
<li>服务注册</li>
<li>服务查询</li>
<li>服务健康检查</li>
</ul>
<h4 id="服务注册与反注册"><a href="#服务注册与反注册" class="headerlink" title="服务注册与反注册"></a>服务注册与反注册</h4><h5 id="随机获取一个可用端口"><a href="#随机获取一个可用端口" class="headerlink" title="随机获取一个可用端口"></a>随机获取一个可用端口</h5><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Net.NetworkInformation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ConsulDemo.Extensions</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">PortHelper</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 产生一个随机可用端口</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span> <span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;minPort&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;maxPort&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">int</span> <span class="title">GetRandAvailablePort</span>(<span class="params"><span class="built_in">int</span> minPort = <span class="number">1024</span>, <span class="built_in">int</span> maxPort = <span class="number">65535</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> rand = <span class="keyword">new</span> Random();</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> port = rand.Next(minPort, maxPort);</span><br><span class="line">                <span class="keyword">if</span> (!IsPortInUsed(port))</span><br><span class="line">                    <span class="keyword">return</span> port;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 判断端口是否在使用中</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;port&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">IsPortInUsed</span>(<span class="params"><span class="built_in">int</span> port</span>)</span> =&gt;</span><br><span class="line">            IPGlobalProperties.GetIPGlobalProperties().GetActiveTcpListeners().Any(p =&gt; p.Port == port) ||</span><br><span class="line">            IPGlobalProperties.GetIPGlobalProperties().GetActiveUdpListeners().Any(p =&gt; p.Port == port) ||</span><br><span class="line">            IPGlobalProperties.GetIPGlobalProperties().GetActiveTcpConnections().Any(conn =&gt; conn.LocalEndPoint.Port == port);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Program-增加属性-CurrentPort"><a href="#Program-增加属性-CurrentPort" class="headerlink" title="Program 增加属性 CurrentPort"></a>Program 增加属性 <strong>CurrentPort</strong></h5><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> IWebHostBuilder <span class="keyword">using</span> ConsulDemo.Extensions;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Hosting;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ConsulDemo</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            CreateWebHostBuilder(args).Build().Run();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">int</span> CurrentPort &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IWebHostBuilder <span class="title">CreateWebHostBuilder</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span> =&gt; </span><br><span class="line">            WebHost.CreateDefaultBuilder(args)</span><br><span class="line">            .UseStartup&lt;Startup&gt;()</span><br><span class="line">            .UseUrls(<span class="string">$&quot;http://*:<span class="subst">&#123;CurrentPort = PortHelper.GetRandAvailablePort()&#125;</span>&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="将注册与反注册的方法绑定到生命周期的开始和结束"><a href="#将注册与反注册的方法绑定到生命周期的开始和结束" class="headerlink" title="将注册与反注册的方法绑定到生命周期的开始和结束"></a>将注册与反注册的方法绑定到生命周期的开始和结束</h5><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params">IApplicationBuilder app, IHostingEnvironment env, IApplicationLifetime lifetime</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (env.IsDevelopment())</span><br><span class="line">        app.UseDeveloperExceptionPage();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    app.UseMvc();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="built_in">string</span> ip = <span class="string">&quot;127.0.0.1&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> port = Program.CurrentPort;</span><br><span class="line">    <span class="keyword">var</span> serviceID = <span class="string">$&quot;ConsulDemo_<span class="subst">&#123;Environment.TickCount&#125;</span>&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Consul 客户端</span></span><br><span class="line">    <span class="keyword">var</span> client = <span class="keyword">new</span> ConsulClient((obj) =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        obj.Address = <span class="keyword">new</span> Uri(<span class="string">&quot;http://127.0.0.1:8500&quot;</span>);</span><br><span class="line">        obj.Datacenter = <span class="string">&quot;dc1&quot;</span>;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在生命周期开始时注册服务</span></span><br><span class="line">    lifetime.ApplicationStarted.Register(() =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> result = client.Agent.ServiceRegister(<span class="keyword">new</span> AgentServiceRegistration</span><br><span class="line">        &#123;</span><br><span class="line">            ID = serviceID,</span><br><span class="line">            Name = <span class="string">&quot;ConsulDemo&quot;</span>,</span><br><span class="line">            Address = ip,</span><br><span class="line">            Port = port,</span><br><span class="line">            Check = <span class="keyword">new</span> AgentServiceCheck</span><br><span class="line">            &#123;</span><br><span class="line">                DeregisterCriticalServiceAfter = TimeSpan.FromSeconds(<span class="number">5</span>),</span><br><span class="line">                Interval = TimeSpan.FromSeconds(<span class="number">5</span>),</span><br><span class="line">                HTTP = <span class="string">$&quot;http://<span class="subst">&#123;ip&#125;</span>:<span class="subst">&#123;port&#125;</span>/api/values/0&quot;</span>,</span><br><span class="line">                Timeout = TimeSpan.FromSeconds(<span class="number">5</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;Consul-ServiceRegister:<span class="subst">&#123;result.Result.StatusCode&#125;</span> - <span class="subst">&#123;result.Result.RequestTime&#125;</span>&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在生命周期结束时反注册服务</span></span><br><span class="line">    lifetime.ApplicationStopping.Register(() =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> result = client.Agent.ServiceDeregister(serviceID);</span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;Consul-ServiceDeregister:<span class="subst">&#123;result.Result.StatusCode&#125;</span> - <span class="subst">&#123;result.Result.RequestTime&#125;</span>&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="结果视图"><a href="#结果视图" class="headerlink" title="结果视图"></a>结果视图</h5><p>启动五个服务提供程序，图中可以看得到连接成功后的打印以及 Consul 健康检查得请求日志。<br><img data-src="https://qiniucdn.wayneshao.com/Consul-%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86%E5%8F%91%E7%8E%B0/20190221072754356.png"><br>从 Consul 的后台可以清楚的看到已经成功注册了五个 ConsulDemo 服务提供程序。<br><img data-src="https://qiniucdn.wayneshao.com/Consul-%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86%E5%8F%91%E7%8E%B0/20190221073245220.png"><br><img data-src="https://qiniucdn.wayneshao.com/Consul-%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86%E5%8F%91%E7%8E%B0/20190221073230199.png"></p>
<h4 id="服务消费程序"><a href="#服务消费程序" class="headerlink" title="服务消费程序"></a>服务消费程序</h4><h5 id="首先我们新建一个-RestTemplate"><a href="#首先我们新建一个-RestTemplate" class="headerlink" title="首先我们新建一个 RestTemplate"></a>首先我们新建一个 RestTemplate</h5><p>RestTemplate（模仿 Spring Cloud 中的）</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> Consul;</span><br><span class="line"><span class="keyword">using</span> Newtonsoft.Json;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Net;</span><br><span class="line"><span class="keyword">using</span> System.Net.Http;</span><br><span class="line"><span class="keyword">using</span> System.Net.Http.Headers;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ConsulTemplate</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">RestTemplate</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> <span class="built_in">string</span> _consulServerUrl;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">RestTemplate</span>(<span class="params"><span class="built_in">string</span> consulServerUrl = <span class="string">&quot;http://127.0.0.1:8500&quot;</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _consulServerUrl = consulServerUrl;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 获取服务的第一个实现地址</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;serviceName&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">async</span> Task&lt;<span class="built_in">string</span>&gt; <span class="title">ResolveRootUrlAsync</span>(<span class="params"><span class="built_in">string</span> serviceName</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">using</span> (<span class="keyword">var</span> consulClient = <span class="keyword">new</span> ConsulClient(c =&gt; c.Address = <span class="keyword">new</span> Uri(_consulServerUrl)))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> services = (<span class="keyword">await</span> consulClient.Agent.Services()).Response;</span><br><span class="line"></span><br><span class="line">                Console.WriteLine(<span class="string">&quot;当前所有服务&quot;</span>);</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">var</span> service <span class="keyword">in</span> services)</span><br><span class="line">                    Console.WriteLine(<span class="string">$&quot;Service:<span class="subst">&#123;service.Value.Service&#125;</span>Address:<span class="subst">&#123;service.Value.Address&#125;</span>Port:<span class="subst">&#123;service.Value.Port&#125;</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">var</span> agentServices = services.Where(s =&gt; s.Value.Service.Equals(serviceName, StringComparison.CurrentCultureIgnoreCase)).Select(s =&gt; s.Value).ToArray();</span><br><span class="line"></span><br><span class="line">                </span><br><span class="line"></span><br><span class="line">                <span class="comment">//根据当前TickCount对服务器个数取模，“随机”取一个机器出来，避免“轮询”的负载均衡策略需要计数加锁问题</span></span><br><span class="line">                <span class="keyword">var</span> agentService = agentServices.ElementAt(Environment.TickCount % agentServices.Length);</span><br><span class="line"></span><br><span class="line">                 Console.WriteLine(<span class="string">$&quot;随机选取 Service:<span class="subst">&#123;agentService.Service&#125;</span>Address:<span class="subst">&#123;agentService.Address&#125;</span>Port:<span class="subst">&#123;agentService.Port&#125;</span>&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> agentService.Address + <span class="string">&quot;:&quot;</span> + agentService.Port;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 转化到实际接口地址</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;url&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">async</span> Task&lt;<span class="built_in">string</span>&gt; <span class="title">ResolveUrlAsync</span>(<span class="params"><span class="built_in">string</span> url</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> uri = <span class="keyword">new</span> Uri(url);</span><br><span class="line">            <span class="keyword">var</span> serviceName = uri.Host;</span><br><span class="line">            <span class="keyword">var</span> realRootUrl = <span class="keyword">await</span> ResolveRootUrlAsync(serviceName);</span><br><span class="line">            <span class="keyword">return</span> uri.Scheme + <span class="string">&quot;://&quot;</span> + realRootUrl + uri.PathAndQuery;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> <span class="title">Task</span>&lt;<span class="title">ResponseEntity</span>&lt;<span class="title">T</span>&gt;&gt; <span class="title">GetForEntityAsync</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="built_in">string</span> url, HttpRequestHeaders requestHeaders = <span class="literal">null</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">using</span> (<span class="keyword">var</span> httpClient = <span class="keyword">new</span> HttpClient())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> requestMsg = <span class="keyword">new</span> HttpRequestMessage();</span><br><span class="line">                <span class="keyword">if</span> (requestHeaders != <span class="literal">null</span>)</span><br><span class="line">                    <span class="keyword">foreach</span> (<span class="keyword">var</span> header <span class="keyword">in</span> requestHeaders)</span><br><span class="line">                        requestHeaders.Add(header.Key, header.Value);</span><br><span class="line"></span><br><span class="line">                requestMsg.Method = HttpMethod.Get;</span><br><span class="line">                requestMsg.RequestUri = <span class="keyword">new</span> Uri(<span class="keyword">await</span> ResolveUrlAsync(url));</span><br><span class="line">                <span class="keyword">var</span> result = <span class="keyword">await</span> httpClient.SendAsync(requestMsg);</span><br><span class="line">                <span class="keyword">var</span> respEntity = <span class="keyword">new</span> ResponseEntity&lt;T&gt;</span><br><span class="line">                &#123;</span><br><span class="line">                    StatusCode = result.StatusCode</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">var</span> bodyStr = <span class="keyword">await</span> result.Content.ReadAsStringAsync();</span><br><span class="line">                respEntity.Body = JsonConvert.DeserializeObject&lt;T&gt;(bodyStr);</span><br><span class="line">                respEntity.Headers = respEntity.Headers;</span><br><span class="line">                <span class="keyword">return</span> respEntity;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ResponseEntity</span>&lt;<span class="title">T</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> HttpStatusCode StatusCode &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> T Body &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;<span class="comment">//返回的json反序列化出来的对象</span></span><br><span class="line">    <span class="keyword">public</span> HttpResponseHeaders Headers &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;<span class="comment">//响应的报文头</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="调用代码"><a href="#调用代码" class="headerlink" title="调用代码"></a>调用代码</h5><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;请求开始&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> rest = <span class="keyword">new</span> RestTemplate();</span><br><span class="line">        <span class="keyword">var</span> data = rest.GetForEntityAsync&lt;DateTime&gt;(<span class="string">&quot;http://ConsulDemo/api/Values&quot;</span>).Result;</span><br><span class="line">        Console.WriteLine(data.StatusCode);</span><br><span class="line">        Console.WriteLine(<span class="built_in">string</span>.Join(<span class="string">&quot;,&quot;</span>, data.Body));</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;请求结束\r\n\r\n&quot;</span>);</span><br><span class="line">        Console.ReadKey();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img data-src="https://qiniucdn.wayneshao.com/Consul-%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86%E5%8F%91%E7%8E%B0/20190221075743368.png"></p>
<p>手动关掉一个服务端</p>
<p><img data-src="https://qiniucdn.wayneshao.com/Consul-%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86%E5%8F%91%E7%8E%B0/20190221080109388.png"><br>关掉的程序成功消失(反注册)<br><img data-src="https://qiniucdn.wayneshao.com/Consul-%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86%E5%8F%91%E7%8E%B0/20190221080152025.png"><br>资源管理器杀掉一个程序<br><img data-src="https://qiniucdn.wayneshao.com/Consul-%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86%E5%8F%91%E7%8E%B0/20190221080431270.png"><br><img data-src="https://qiniucdn.wayneshao.com/Consul-%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86%E5%8F%91%E7%8E%B0/20190221080513331.png"></p>
<p>源码 <span class="exturl" data-url="aHR0cHM6Ly9xaW5pdWNkbi53YXluZXNoYW8uY29tL0NvbnN1bERlbW8uN3o=">ConsulDemo.7z<i class="fa fa-external-link-alt"></i></span></p>
]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
      <tags>
        <tag>服务治理发现</tag>
        <tag>.NET</tag>
      </tags>
  </entry>
  <entry>
    <title>GitLab 非 Docker .NET Core CI/CD搭建</title>
    <url>/posts/33677.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>公司的 GitLab 服务部署完了，但是领导出于性能方面的考虑，希望测试和生产环境不用 Docker 来部署，遂搭建了一套不基于Docker 的 GitLab CI/CD 负载均衡测试环境。</p>
<span id="more"></span>
<h2 id="注册-GitLab-Runner"><a href="#注册-GitLab-Runner" class="headerlink" title="注册 GitLab-Runner"></a>注册 GitLab-Runner</h2><h3 id="安装-GitLab-Runner"><a href="#安装-GitLab-Runner" class="headerlink" title="安装 GitLab-Runner"></a>安装 GitLab-Runner</h3><p>这里我没有按照官方教程来直接下载对应系统的包安装，而是使用了<span class="exturl" data-url="aHR0cHM6Ly9taXJyb3IudHVuYS50c2luZ2h1YS5lZHUuY24vaGVscC9naXRsYWItcnVubmVyLw==">清华大学开源镜像站的方法<i class="fa fa-external-link-alt"></i></span>:<br><img data-src="https://qiniucdn.wayneshao.com/20191217060322268.png"></p>
<h3 id="注册启用-GitLab-Runner"><a href="#注册启用-GitLab-Runner" class="headerlink" title="注册启用 GitLab-Runner"></a>注册启用 GitLab-Runner</h3><p>转到搭建好的GitLab的具体项目CICD项目设置页<br><span class="exturl" data-url="aHR0cHM6Ly9naXRsYWIueHh4L3VzZXIvcHJvamVjdC9zZXR0aW5ncy9jaV9jZA==">https://gitlab.xxx/user/project/settings/ci_cd<i class="fa fa-external-link-alt"></i></span><br><img data-src="https://qiniucdn.wayneshao.com/20191217060555653.png"><br>然后用GitLab提供的令牌和地址对GitLab进行注册：<br><img data-src="https://qiniucdn.wayneshao.com/20191217060735087.png"></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">gitlab-runner register</span><br><span class="line">gitlab.xxx</span><br><span class="line">xxxxx</span><br><span class="line">shell</span><br></pre></td></tr></table></figure>
<h2 id="测试机负载均衡和Daemon"><a href="#测试机负载均衡和Daemon" class="headerlink" title="测试机负载均衡和Daemon"></a>测试机负载均衡和Daemon</h2><h3 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h3><p>负载均衡方面，国际惯例，还用 nginx 来做</p>
<p>直接用 yum 安装</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yum install -y nginx</span><br></pre></td></tr></table></figure>
<p>配置</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="comment"># For more information on configuration, see:</span></span><br><span class="line"><span class="comment">#   * Official English Documentation: http://nginx.org/en/docs/</span></span><br><span class="line"><span class="comment">#   * Official Russian Documentation: http://nginx.org/ru/docs/</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">user</span> nginx;</span><br><span class="line"><span class="attribute">worker_processes</span> auto;</span><br><span class="line"><span class="attribute">error_log</span> /var/log/nginx/<span class="literal">error</span>.log;</span><br><span class="line"><span class="attribute">pid</span> /run/nginx.pid;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Load dynamic modules. See /usr/share/doc/nginx/README.dynamic.</span></span><br><span class="line"><span class="attribute">include</span> /usr/share/nginx/modules/<span class="regexp">*.conf</span>;</span><br><span class="line"></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">worker_connections</span> <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">log_format</span>  main  <span class="string">&#x27;<span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] &quot;<span class="variable">$request</span>&quot; &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;<span class="variable">$status</span> <span class="variable">$body_bytes_sent</span> &quot;<span class="variable">$http_referer</span>&quot; &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;&quot;<span class="variable">$http_user_agent</span>&quot; &quot;<span class="variable">$http_x_forwarded_for</span>&quot;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">access_log</span>  /var/log/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">sendfile</span>            <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">tcp_nopush</span>          <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">tcp_nodelay</span>         <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">keepalive_timeout</span>   <span class="number">65</span>;</span><br><span class="line">    <span class="attribute">types_hash_max_size</span> <span class="number">2048</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">include</span>             /etc/nginx/mime.types;</span><br><span class="line">    <span class="attribute">default_type</span>        application/octet-stream;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">include</span> /etc/nginx/conf.d/<span class="regexp">*.conf</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 待选服务器列表</span></span><br><span class="line">    <span class="section">upstream</span> myproject&#123;</span><br><span class="line">        <span class="comment"># ip_hash;</span></span><br><span class="line">        <span class="attribute">server</span> Y.Y.Y.Y:<span class="number">4411</span> weight=<span class="number">7</span>;</span><br><span class="line">        <span class="attribute">server</span> X.X.X.X:<span class="number">4411</span> weight=<span class="number">3</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># HTTP 配置</span></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">        <span class="attribute">listen</span>       [::]:<span class="number">80</span>;</span><br><span class="line"></span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line">            <span class="attribute">proxy_pass</span> http://myproject;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Settings for a TLS enabled server.</span></span><br><span class="line">   <span class="section">server</span> &#123;</span><br><span class="line">       <span class="attribute">listen</span>       <span class="number">443</span> ssl http2;</span><br><span class="line">       <span class="attribute">listen</span>       [::]:<span class="number">443</span> ssl http2;</span><br><span class="line"></span><br><span class="line">       <span class="attribute">ssl_certificate</span> <span class="string">&quot;/etc/nginx/ssl/ssl_certificate.pem&quot;</span>;</span><br><span class="line">       <span class="attribute">ssl_certificate_key</span> <span class="string">&quot;/etc/nginx/ssl/ssl_certificate_key.key&quot;</span>;</span><br><span class="line">       <span class="attribute">ssl_session_cache</span> shared:SSL:<span class="number">1m</span>;</span><br><span class="line">       <span class="attribute">ssl_session_timeout</span>  <span class="number">10m</span>;</span><br><span class="line">       <span class="attribute">ssl_ciphers</span> HIGH:!aNULL:!MD5;</span><br><span class="line">       <span class="attribute">ssl_prefer_server_ciphers</span> <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line">       <span class="section">location</span> / &#123;</span><br><span class="line">            <span class="attribute">proxy_pass</span> http://myproject;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Daemon"><a href="#Daemon" class="headerlink" title="Daemon"></a>Daemon</h3><p>Daemon 方面，用过的几个里，个人觉得使用舒适度从低到高是 Systemd &lt; Supervisor &lt; PM2，直接选PM2了，原理一样，可以很方便的更换其他。<br>在做了负载均衡的两台服务器上做以下相同配置：</p>
<ol>
<li>安装 NodeJS<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo yum install -y nodejs gcc-c++ make yarn</span><br></pre></td></tr></table></figure>
<img data-src="https://qiniucdn.wayneshao.com/GitLab%E9%9D%9EDockerNETCoreCICD%E6%90%AD%E5%BB%BA/20191217054930495.png"></li>
<li>切换 Registry<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm install -g nrm</span><br><span class="line">nrm use taobao</span><br></pre></td></tr></table></figure>
<img data-src="https://qiniucdn.wayneshao.com/GitLab%E9%9D%9EDockerNETCoreCICD%E6%90%AD%E5%BB%BA/20191217055207670.png"></li>
<li>安装 PM2<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm install -g pm2</span><br></pre></td></tr></table></figure>
<img data-src="https://qiniucdn.wayneshao.com/GitLab%E9%9D%9EDockerNETCoreCICD%E6%90%AD%E5%BB%BA/20191217055334058.png"></li>
<li>配置 PM2 自启<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pm2 startup</span><br></pre></td></tr></table></figure>
<img data-src="https://qiniucdn.wayneshao.com/GitLab%E9%9D%9EDockerNETCoreCICD%E6%90%AD%E5%BB%BA/20191217055400554.png"></li>
<li>新建 dotnet 守护服务，保存 pm2 守护列表<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pm2 start <span class="string">&quot;dotnet test-ci.dll&quot;</span> --name testCI</span><br><span class="line">pm2 save</span><br></pre></td></tr></table></figure>
<img data-src="https://qiniucdn.wayneshao.com/GitLab%E9%9D%9EDockerNETCoreCICD%E6%90%AD%E5%BB%BA/20191217055600544.png"><br><img data-src="https://qiniucdn.wayneshao.com/GitLab%E9%9D%9EDockerNETCoreCICD%E6%90%AD%E5%BB%BA/20191217055718569.png"><h2 id="GitLab-CI-CD"><a href="#GitLab-CI-CD" class="headerlink" title="GitLab CI/CD"></a>GitLab CI/CD</h2><h3 id="配置变量"><a href="#配置变量" class="headerlink" title="配置变量"></a>配置变量</h3><img data-src="https://qiniucdn.wayneshao.com/20191217055906645.png"><h3 id="在项目源码更目录增加-gitlab-ci-yml"><a href="#在项目源码更目录增加-gitlab-ci-yml" class="headerlink" title="在项目源码更目录增加 .gitlab-ci.yml"></a>在项目源码更目录增加 .gitlab-ci.yml</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">stages:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">deploy_dev</span></span><br><span class="line"><span class="attr">build_job:</span></span><br><span class="line">    <span class="attr">stage:</span> <span class="string">build</span></span><br><span class="line">    <span class="attr">only:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">master</span></span><br><span class="line">    <span class="attr">script:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">cd</span> <span class="string">test-ci</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">dotnet</span> <span class="string">restore</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">dotnet</span> <span class="string">build</span></span><br><span class="line"><span class="attr">before_script:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">export</span> <span class="string">COMMIT_TIME=$(git</span> <span class="string">show</span> <span class="string">-s</span> <span class="string">--format=%ct</span> <span class="string">$CI_COMMIT_SHA)</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">export</span> <span class="string">COMMIT_TIME_STR=$(date</span> <span class="string">-d</span> <span class="string">@$COMMIT_TIME</span> <span class="string">+%Y%m%d%k%M%S)</span></span><br><span class="line"><span class="attr">deploy_master_job:</span></span><br><span class="line">    <span class="attr">stage:</span> <span class="string">deploy_dev</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">development</span></span><br><span class="line">    <span class="attr">only:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">master</span></span><br><span class="line">    <span class="attr">script:</span></span><br><span class="line">        <span class="comment"># 发布程序并部署运行</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">cd</span> <span class="string">test-ci</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;version:$COMMIT_TIME_STR&quot;</span></span><br><span class="line">        <span class="comment"># 发布</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">dotnet</span> <span class="string">publish</span> <span class="string">-c</span> <span class="string">Release</span> <span class="string">--output</span> <span class="string">bin/publish</span></span><br><span class="line">        <span class="comment"># 压缩</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">cd</span> <span class="string">bin/publish</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">zip</span> <span class="string">-r</span> <span class="string">$COMMIT_TIME_STR.zip</span> <span class="string">./</span></span><br><span class="line">        <span class="comment"># 备份</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">cp</span> <span class="string">$COMMIT_TIME_STR.zip</span> <span class="string">/opt/backup-cd/test-ci/</span></span><br><span class="line">        <span class="comment"># 部署服务一</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">lftp</span> <span class="string">sftp://$DEV_URL_1</span> <span class="string">-e</span> <span class="string">&quot;user $DEV_USER $DEV_PASS; cd /root/test-ci; put $COMMIT_TIME_STR.zip; bye&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">sshpass</span> <span class="string">-p</span> <span class="string">&quot;$DEV_PASS&quot;</span> <span class="string">ssh</span> <span class="string">-o</span> <span class="string">StrictHostKeyChecking=no</span> <span class="string">$DEV_USER@$DEV_URL_1</span> <span class="string">&quot;cd /root/test-ci;unzip -o ./$COMMIT_TIME_STR.zip;rm -Rf ./$COMMIT_TIME_STR.zip;&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">sshpass</span> <span class="string">-p</span> <span class="string">&quot;$DEV_PASS&quot;</span> <span class="string">ssh</span> <span class="string">-o</span> <span class="string">StrictHostKeyChecking=no</span> <span class="string">$DEV_USER@$DEV_URL_1</span> <span class="string">&quot;pm2 restart testCI;pm2 status;&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 部署服务二</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">lftp</span> <span class="string">sftp://$DEV_URL_2</span> <span class="string">-e</span> <span class="string">&quot;user $DEV_USER $DEV_PASS; cd /root/test-ci; put $COMMIT_TIME_STR.zip; bye&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">sshpass</span> <span class="string">-p</span> <span class="string">&quot;$DEV_PASS&quot;</span> <span class="string">ssh</span> <span class="string">-o</span> <span class="string">StrictHostKeyChecking=no</span> <span class="string">$DEV_USER@$DEV_URL_2</span> <span class="string">&quot;cd /root/test-ci;ls;unzip -o ./$COMMIT_TIME_STR.zip;rm -Rf ./$COMMIT_TIME_STR.zip&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">sshpass</span> <span class="string">-p</span> <span class="string">&quot;$DEV_PASS&quot;</span> <span class="string">ssh</span> <span class="string">-o</span> <span class="string">StrictHostKeyChecking=no</span> <span class="string">$DEV_USER@$DEV_URL_2</span> <span class="string">&quot;pm2 restart testCI;pm2 status;&quot;</span></span><br><span class="line">        <span class="comment"># 删除压缩包</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">rm</span> <span class="string">-Rf</span> <span class="string">./$COMMIT_TIME_STR.zipx</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="一些坑"><a href="#一些坑" class="headerlink" title="一些坑"></a>一些坑</h2><h3 id="NodeJS"><a href="#NodeJS" class="headerlink" title="NodeJS"></a>NodeJS</h3><p>使用 yum 安装的官方提供的 NodeJS 最新版本为6.X，使用nrm会报错，属于低版本NodeJS本身对coffeescript的兼容问题，想要安装新版的NodeJS可以参考<span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vZnBzMnRhby9wLzk5NTYxMzkuaHRtbA==">这篇文章<i class="fa fa-external-link-alt"></i></span>，我用的方法是<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL25vZGVzb3VyY2UvZGlzdHJpYnV0aW9ucw==">nodesource/distributions<i class="fa fa-external-link-alt"></i></span>：<br><img data-src="https://qiniucdn.wayneshao.com/20191217055906645.png"></p>
]]></content>
      <categories>
        <category>踩坑笔记</category>
      </categories>
      <tags>
        <tag>Docker</tag>
        <tag>Linux</tag>
        <tag>CentOS</tag>
        <tag>GitLab</tag>
        <tag>CI/CD</tag>
        <tag>负载均衡</tag>
      </tags>
  </entry>
  <entry>
    <title>MVC学习笔记索引帖</title>
    <url>/posts/375.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="MVC学习笔记索引帖"><a href="#MVC学习笔记索引帖" class="headerlink" title="MVC学习笔记索引帖"></a>MVC学习笔记索引帖</h1><span id="more"></span>
<p><a href="cjdsu1gvb000mjgkbaiuicjql.html">【MVC学习笔记】1.项目结构搭建及单个类在各个层次中的实现</a></p>
<p><a href="cjdsuiiy8000qjgkbr90ccd59.html">【MVC学习笔记】2.使用T4模板生成其他类的具体实现</a></p>
<p><a href="cjdsursww000tjgkbwkx2jcyr.html">【MVC学习笔记】3.使用Spring.Net应用IOC（依赖倒置）</a></p>
<p><a href="cjdsvb5540010jgkbpzf0p0be.html">【MVC学习笔记】4.使用Log4Net来进行错误日志的记录</a></p>
<p><a href="cjdsvhlwr0015jgkb4dxozvxi.html">【MVC学习笔记】5.使用Controller来代替Filter完成登录验证（Session校验）</a></p>
<p><a href="cjdsvqsvv001ajgkbjw972ezv.html">【MVC学习笔记】6. 使用Memcache+Cookie解决分布式系统共享登录状态</a></p>
<p><a href="cjdswd091001mjgkbhuo2l56k.html">【MVC学习笔记】7.使用极验验证来制作更高逼格的验证码</a></p>
]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
      <tags>
        <tag>MVC</tag>
        <tag>索引</tag>
      </tags>
  </entry>
  <entry>
    <title>Let&#39;s Encrypt 通配符证书自动续期大法</title>
    <url>/posts/46309.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>鉴于大部分免费SSL证书都是针对特定二级域名的，而 Let’s Encrypt 提供通配符证书，却需要每三个月续期一次，经过摸索，鼓捣出了一个方案，遂记录。</p>
<span id="more"></span>

<h2 id="安装-certbot"><a href="#安装-certbot" class="headerlink" title="安装 certbot"></a>安装 certbot</h2><p>鉴于 certbot 本身对各种系统自带的包管理工具支持一般，所以我们采用通用的方法，先安装 snap ，再使用 snap 安装 certbot。</p>
<p>以下示例环境为 CentOS8 ，其他系统可以参照 <span class="exturl" data-url="aHR0cHM6Ly9zbmFwY3JhZnQuaW8vZG9jcy9pbnN0YWxsaW5nLXNuYXBk">snap 官方安装文档<i class="fa fa-external-link-alt"></i></span>。</p>
<h3 id="安装-snap"><a href="#安装-snap" class="headerlink" title="安装 snap"></a>安装 snap</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 安装企业支持包</span></span><br><span class="line">sudo dnf install epel-release</span><br><span class="line">sudo dnf upgrade</span><br><span class="line"><span class="comment"># 安装 snap</span></span><br><span class="line">sudo dnf install snapd</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> --now snapd.socket</span><br><span class="line">sudo <span class="built_in">ln</span> -s /var/lib/snapd/snap /snap</span><br><span class="line">sudo snap install core</span><br><span class="line">sudo snap refresh core</span><br></pre></td></tr></table></figure>

<p><img data-src="https://qiniucdn.wayneshao.com/snap_version.jpg" alt="成功效果"></p>
<h3 id="安装-cerbot"><a href="#安装-cerbot" class="headerlink" title="安装 cerbot"></a>安装 cerbot</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 安装 cerbot</span></span><br><span class="line">sudo snap install --classic certbot</span><br><span class="line">sudo <span class="built_in">ln</span> -s /snap/bin/certbot /usr/bin/certbot</span><br></pre></td></tr></table></figure>

<p><img data-src="https://qiniucdn.wayneshao.com/certbot_version.jpg" alt="成功效果"></p>
<h2 id="实现自动续期"><a href="#实现自动续期" class="headerlink" title="实现自动续期"></a>实现自动续期</h2><p>我的自动续期是使用了 Gayhub 一位老铁 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3l3ZGJsb2c=">ywdblog<i class="fa fa-external-link-alt"></i></span> 开源的<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3l3ZGJsb2cvY2VydGJvdC1sZXRlbmNyeXB0LXdpbGRjYXJkY2VydGlmaWNhdGVzLWFseWRucy1hdQ==">脚本<i class="fa fa-external-link-alt"></i></span>，我选择的运行环境是 Python3。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">dnf install -y python3</span><br><span class="line">sudo <span class="built_in">ln</span> -s /usr/bin/python3 /usr/bin/python</span><br></pre></td></tr></table></figure>

<p>以下示例中我的域名为 wayneshao.com ，注册于腾讯云。</p>
<p>脚本所在目录为 <code>/root/certbot-dns-au</code>。</p>
<h3 id="配置证书"><a href="#配置证书" class="headerlink" title="配置证书"></a>配置证书</h3><p><span class="exturl" data-url="aHR0cHM6Ly9jb25zb2xlLmNsb3VkLnRlbmNlbnQuY29tL2NhbS9jYXBp">腾讯云后台<i class="fa fa-external-link-alt"></i></span>新增一个密匙用于脚本自动配置域名解析来续期</p>
<p><img data-src="https://qiniucdn.wayneshao.com/46309/qcloud_apikey.jpg" alt="申请密钥和key"></p>
<p>将申请到的 SecretId 和 SecretKey 填入脚本中</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vi /root/certbot-dns-au/au.sh</span><br></pre></td></tr></table></figure>

<p><img data-src="https://qiniucdn.wayneshao.com/46309/script_id_key.jpg" alt="把key填入脚本"></p>
<h3 id="申请通配符证书"><a href="#申请通配符证书" class="headerlink" title="申请通配符证书"></a>申请通配符证书</h3><p>直接使用 ywdblog 老哥的脚本</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">certbot certonly  -d *.wayneshao.com --manual --preferred-challenges dns  --manual-auth-hook <span class="string">&quot;/root/certbot-dns-au/au.sh python txy add&quot;</span> --manual-cleanup-hook <span class="string">&quot;/root/certbot-dns-au/au.sh python txy clean&quot;</span></span><br></pre></td></tr></table></figure>

<p><img data-src="https://qiniucdn.wayneshao.com/46309/new_certificate.jpg" alt="申请通配符证书"></p>
<p>申请证书成功后，可以直接在硬盘找到对应的文件（建议 NGINX 等软件使用证书时，直接使用原本的目录，方便续期）。</p>
<h3 id="续期通配符证书"><a href="#续期通配符证书" class="headerlink" title="续期通配符证书"></a>续期通配符证书</h3><p>因为我的证书最终被部署到了 NGINX ，故而我做了续期成功后的 hook ，对 NGINX 的配置做了刷新。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">certbot renew --cert-name wayneshao.com --deploy-hook  <span class="string">&quot;nginx -s reload&quot;</span> --manual-auth-hook <span class="string">&quot;/root/certbot-dns-au/au.sh python txy add&quot;</span> --manual-cleanup-hook <span class="string">&quot;/root/certbot-dns-au/au.sh python txy clean&quot;</span></span><br></pre></td></tr></table></figure>

<p><img data-src="https://qiniucdn.wayneshao.com/46309/refresh_cert.jpg" alt="由于有效期还长续期失败"></p>
<p>证书有效期小于30天时才能续期成功，由于有效期还长，续期失败。</p>
<h2 id="使用定时任务自动续期"><a href="#使用定时任务自动续期" class="headerlink" title="使用定时任务自动续期"></a>使用定时任务自动续期</h2><p>流程已经畅通，接下来就是要把自动续期的脚本加入 crontab ，每天去尝试一下，防止证书过期。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">crontab -e</span><br></pre></td></tr></table></figure>

<p>新加一行 输入</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1 1 */1 * * root certbot renew --cert-name wayneshao.com --deploy-hook  &quot;nginx -s reload&quot; --manual-auth-hook &quot;/root/certbot-dns-au/au.sh python txy add&quot; --manual-cleanup-hook &quot;/root/certbot-dns-au/au.sh python txy clean&quot;</span><br></pre></td></tr></table></figure>

<p>查看确认一下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">crontab -l</span><br></pre></td></tr></table></figure>

<p><img data-src="https://qiniucdn.wayneshao.com/46309/crontab_l.jpg" alt="定时任务列表"></p>
]]></content>
      <categories>
        <category>偶有所得</category>
      </categories>
      <tags>
        <tag>SSL</tag>
        <tag>Let&#39;s Encrypt</tag>
        <tag>通配符</tag>
        <tag>自动化</tag>
      </tags>
  </entry>
  <entry>
    <title>ListBox 扩展方法-获取所有Item构成的集合</title>
    <url>/posts/5516.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>今天在实现一个小功能 “插入更新 ListBox 中的 Item ”时，发现 <code>ListBox.Items</code> 的类型 <code>ListBox.ObjectCollection</code> 实现了 <code>IList</code>, <code>ICollection</code>, <code>IEnumerable</code>三个接口，整体的方法已经非常接近一个数组，但是方便程度跟数据确实差距较大，Linq 也完全不能使用，故封装一个扩展方法实现直接获取 <code>ListBox.Items</code>中所储存的数据的集合。</p>
<span id="more"></span>
<figure class="highlight cs"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">System.Windows.Forms</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">ListBoxExtension</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 获取 ListBox.Items 中的数据构成的集合</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span>ListBox.Items中储存的数据的类型<span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;listbox&quot;&gt;</span>ListBox对象<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="title">List</span>&lt;<span class="title">T</span>&gt; <span class="title">GetItems</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="keyword">this</span> ListBox listbox</span>) <span class="keyword">where</span> T : <span class="keyword">class</span></span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> items = <span class="keyword">new</span> <span class="built_in">object</span>[listbox.Items.Count];</span><br><span class="line">            listbox.Items.CopyTo(items, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> current = items.Select(i =&gt; i <span class="keyword">as</span> T).Where(i =&gt; i != <span class="literal">null</span>).ToList();</span><br><span class="line">            <span class="keyword">if</span> (listbox.Items.Count != current.Count)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">$&quot;并非所有元素都为<span class="subst">&#123;<span class="keyword">typeof</span>(T).Name&#125;</span>类型&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> current.ToList();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>踩坑笔记</category>
      </categories>
      <tags>
        <tag>C#</tag>
        <tag>WinForm</tag>
      </tags>
  </entry>
  <entry>
    <title>【算法复习】贪心算法之最小生成树Prim算法</title>
    <url>/posts/44726.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>最小生成树的Prim算法也是贪心算法的一大经典应用。Prim算法的特点是时刻维护一棵树，算法不断加边，加的过程始终是一棵树。</p>
<span id="more"></span>
<h2 id="简述"><a href="#简述" class="headerlink" title="简述"></a>简述</h2><p>Prim算法过程：</p>
<p>一条边一条边地加， 维护一棵树。</p>
<p>初始 E ＝ ｛｝空集合， V = ｛任意节点｝</p>
<p>循环（n – 1）次，每次选择一条边（v1,v2）， 满足：v1属于V , v2不属于V。且（v1,v2）权值最小。</p>
<p>E = E + （v1,v2）<br>V = V + v2</p>
<p>最终E中的边是一棵最小生成树， V包含了全部节点。</p>
<h2 id="执行过程"><a href="#执行过程" class="headerlink" title="执行过程"></a>执行过程</h2><p>以下图为例介绍Prim算法的执行过程。<br><img data-src="https://qiniucdn.wayneshao.com/20180228211614459/20180228092129488.png"><br>Prim算法的过程从A开始 V = {A}, E = {}<br><img data-src="https://qiniucdn.wayneshao.com/20180228211614459/20180228092216396.png"><br>选中边AF , V = {A, F}, E = {(A,F)}<br><img data-src="https://qiniucdn.wayneshao.com/20180228211614459/20180228092234421.png"><br>选中边FB, V = {A, F, B}, E = {(A,F), (F,B)}<br><img data-src="https://qiniucdn.wayneshao.com/20180228211614459/20180228092252771.png"><br>选中边BD, V = {A, B, F, D},   E = {(A,F), (F,B), (B,D)}<br><img data-src="https://qiniucdn.wayneshao.com/20180228211614459/20180228092305430.png"><br>选中边DE, V = {A, B, F, D, E},   E = {(A,F), (F,B), (B,D), (D,E)}<br><img data-src="https://qiniucdn.wayneshao.com/20180228211614459/20180228092428701.png"><br>选中边BC, V = {A, B, F, D, E, c},   E = {(A,F), (F,B), (B,D), (D,E), (B,C)}, 算法结束。</p>
<h2 id="算法证明"><a href="#算法证明" class="headerlink" title="算法证明"></a>算法证明</h2><p>Prim算法的证明：假设Prim算法得到一棵树P，有一棵最小生成树T。假设P和T不同，我们假设Prim算法进行到第(K – 1)步时选择的边都在T中，这时Prim算法的树是P’, 第K步时,Prim算法选择了一条边e = (u, v)不在T中。假设u在P’中，而v不在。</p>
<p>因为T是树，所以T中必然有一条u到v的路径，我们考虑这条路径上第一个点u在P’中，最后一个点v不在P’中，则路径上一定有一条边f = (x,y)，x在P’中，而且y不在P’中。<br>我们考虑f和e的边权w(f)与w(e)的关系：</p>
<p>若w(f) &gt; w(e)，在T中用e换掉f （T中加上e去掉f)，得到一个权值和更小的生成树，与T是最小生成树矛盾。<br>若w(f) &lt; w(e), Prim算法在第K步时应该考虑加边f，而不是e,矛盾。</p>
<p>因此只有w(f) = w(e),我们在T中用e换掉f，这样Prim算法在前K步选择的边在T中了，有限步之后把T变成P,而树权值和不变， 从而Prim算法是正确的。<br>请仔细理解Prim算法——时刻维护一棵生成树。我们的证明构造性地证明了所有地最小生成树地边权（多重）集合都相同！</p>
<h2 id="题目测试"><a href="#题目测试" class="headerlink" title="题目测试"></a>题目测试</h2><p>最后，我们来提供输入输出数据，由你来写一段程序，实现这个算法，只有写出了正确的程序，才能继续后面的课程。</p>
<p><strong>输入</strong></p>
<p>第1行：2个数N,M中间用空格分隔，N为点的数量，M为边的数量。（2 &lt;= N &lt;= 1000, 1 &lt;= M &lt;= 50000)<br>第2 - M + 1行：每行3个数S E W，分别表示M条边的2个顶点及权值。(1 &lt;= S, E &lt;= N，1 &lt;= W &lt;= 10000)</p>
<p><strong>输出</strong></p>
<p>输出最小生成树的所有边的权值之和。</p>
<p><strong>输入示例</strong></p>
<blockquote>
<p>9 14<br>1 2 4<br>2 3 8<br>3 4 7<br>4 5 9<br>5 6 10<br>6 7 2<br>7 8 1<br>8 9 7<br>2 8 11<br>3 9 2<br>7 9 6<br>3 6 4<br>4 6 14<br>1 8 8</p>
</blockquote>
<p>输出示例</p>
<blockquote>
<p>37</p>
</blockquote>
<p>请选取你熟悉的语言，并在下面的代码框中完成你的程序，注意数据范围，最终结果会造成Int32溢出，这样会输出错误的答案。<br>不同语言如何处理输入输出，请查看下面的语言说明。</p>
<h2 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h2><p>声明一个结构类型储存“边”的信息。</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> Side</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span>[] Endpoints;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Weight;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Side</span>(<span class="params"><span class="built_in">int</span> endpoint1, <span class="built_in">int</span> endpoint2, <span class="built_in">int</span> weight</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Endpoints = <span class="keyword">new</span> <span class="built_in">int</span>[<span class="number">2</span>] &#123; endpoint1, endpoint2 &#125;;</span><br><span class="line">        Weight = weight;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先读入总边数和总点数</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> line1 = Console.ReadLine().Split(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> n = Convert.ToInt32(line1[<span class="number">0</span>]);</span><br><span class="line"><span class="keyword">var</span> m = Convert.ToInt32(line1[<span class="number">1</span>]);</span><br></pre></td></tr></table></figure>
<p>读入所有“边”，储存在数组中</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> sides = <span class="keyword">new</span> Side[m];</span><br><span class="line"><span class="keyword">var</span> points = <span class="keyword">new</span> List&lt;<span class="built_in">int</span>&gt;();</span><br><span class="line"><span class="keyword">var</span> totalWeight = <span class="number">0L</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; m; i++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> line = Console.ReadLine().Split(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">    sides[i] = <span class="keyword">new</span> Side(Convert.ToInt32(line[<span class="number">0</span>]), Convert.ToInt32(line[<span class="number">1</span>]), Convert.ToInt32(line[<span class="number">2</span>]));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将所有边按照权值排序</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> orderSides = sides.OrderBy(s =&gt; s.Weight</span><br></pre></td></tr></table></figure>
<p>加入起点</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">points.AddRange(orderSides[<span class="number">0</span>].Endpoints);</span><br><span class="line">totalWeight += orderSides[<span class="number">0</span>].Weight;</span><br><span class="line">orderSides.Rem</span><br></pre></td></tr></table></figure>
<p>Prim：<br>按权值从小到大循环遍历数组里的边，如果发现某一个边的一个端点在端点数组里有，另一个端点在端点数组里没有，就把另一端点也加入，然后累加权值。直到端点数组内端点个数等于总端点数。</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">while</span> (points.Count != n)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; orderSides.Count; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ((!points.Contains(orderSides[i].Endpoints[<span class="number">0</span>]) &amp;&amp; !points.Contains(orderSides[i].Endpoints[<span class="number">1</span>]))||(points.Contains(orderSides[i].Endpoints[<span class="number">0</span>]) &amp;&amp; points.Contains(orderSides[i].Endpoints[<span class="number">1</span>]))) <span class="keyword">continue</span>;</span><br><span class="line">        points.Add(points.Contains(orderSides[i].Endpoints[<span class="number">0</span>]) ? orderSides[i].Endpoints[<span class="number">1</span>] : orderSides[i].Endpoints[<span class="number">0</span>]);</span><br><span class="line">        totalWeight += orderSides[i].Weight;</span><br><span class="line">        orderSides.RemoveAt(i);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Accepted"><a href="#Accepted" class="headerlink" title="Accepted"></a>Accepted</h2><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Sum</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">struct</span> Side</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span>[] Endpoints;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> Weight;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Side</span>(<span class="params"><span class="built_in">int</span> endpoint1, <span class="built_in">int</span> endpoint2, <span class="built_in">int</span> weight</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Endpoints = <span class="keyword">new</span> <span class="built_in">int</span>[<span class="number">2</span>] &#123; endpoint1, endpoint2 &#125;;</span><br><span class="line">            Weight = weight;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> line1 = Console.ReadLine().Split(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> n = Convert.ToInt32(line1[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">var</span> m = Convert.ToInt32(line1[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">var</span> sides = <span class="keyword">new</span> Side[m];</span><br><span class="line">        <span class="keyword">var</span> points = <span class="keyword">new</span> List&lt;<span class="built_in">int</span>&gt;();</span><br><span class="line">        <span class="keyword">var</span> totalWeight = <span class="number">0L</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; m; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> line = Console.ReadLine().Split(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">            sides[i] = <span class="keyword">new</span> Side(Convert.ToInt32(line[<span class="number">0</span>]), Convert.ToInt32(line[<span class="number">1</span>]), Convert.ToInt32(line[<span class="number">2</span>]));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> orderSides = sides.OrderBy(s =&gt; s.Weight).ToList();</span><br><span class="line"></span><br><span class="line">        points.AddRange(orderSides[<span class="number">0</span>].Endpoints);</span><br><span class="line">        totalWeight += orderSides[<span class="number">0</span>].Weight;</span><br><span class="line">        orderSides.RemoveAt(<span class="number">0</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span> (points.Count != n)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; orderSides.Count; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> ((!points.Contains(orderSides[i].Endpoints[<span class="number">0</span>]) &amp;&amp; !points.Contains(orderSides[i].Endpoints[<span class="number">1</span>]))||(points.Contains(orderSides[i].Endpoints[<span class="number">0</span>]) &amp;&amp; points.Contains(orderSides[i].Endpoints[<span class="number">1</span>]))) <span class="keyword">continue</span>;</span><br><span class="line">                points.Add(points.Contains(orderSides[i].Endpoints[<span class="number">0</span>]) ? orderSides[i].Endpoints[<span class="number">1</span>] : orderSides[i].Endpoints[<span class="number">0</span>]);</span><br><span class="line">                totalWeight += orderSides[i].Weight;</span><br><span class="line">                orderSides.RemoveAt(i);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Console.WriteLine(totalWeight);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>算法笔记</category>
      </categories>
      <tags>
        <tag>51NOD</tag>
        <tag>刷题</tag>
        <tag>C#</tag>
        <tag>Prim</tag>
        <tag>贪心</tag>
      </tags>
  </entry>
  <entry>
    <title>EFCore MySQL System.TypeLoadException occurred 问题解决</title>
    <url>/posts/11533.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>　　今天在使用 EFCore + MySQL 搭一个小Demo的时候,在 Migration 环节遇到了这样一个问题。</p>
<blockquote>
<p>System.TypeLoadException occurred<br>HResult=0x80131522<br>Message=Method ‘Clone’ in type ‘MySQL.Data.EntityFrameworkCore.Infraestructure.Internal.MySQLOptionsExtension’ from assembly ‘MySql.Data.EntityFrameworkCore, Version=8.0.8.0, Culture=neutral, PublicKeyToken=c5687fc88969c44d’ does not have an implementation.</p>
</blockquote>
<span id="more"></span>

<p>  几经排查无果之后求助了Google，发现了一条状况相同的 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2phc29uc3R1cmdlcy9teXNxbC1kb3RuZXQtY29yZS9pc3N1ZXMvMQ==">Issue<i class="fa fa-external-link-alt"></i></span><br>  项目作者的回复如下</p>
<blockquote>
<p>　　@lixiandai Hi, yes, this is frustrating - Oracle’s MySQL does not yet fully support .NET Core 2.</p>
</blockquote>
<blockquote>
<p>　　In the interim, I suggest using Pomelo, which can be installed by executing the following command:</p>
</blockquote>
<blockquote>
<p>　　$ dotnet add package Pomelo.EntityFrameworkCore.MySql –version 2.0.0-rtm-10062<br>Or, add the following line to your .csproj ItemGroup</p>
</blockquote>
<blockquote>
<p>　　<PackageReference Include="Pomelo.EntityFrameworkCore.MySql" Version="2.0.0-rtm-10062" /></p>
</blockquote>
<p>　　所以其实是MySQL的官方驱动包的锅喽?</p>
<p>　　按照作者的推荐选择了一位国内大佬的项目<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL1BvbWVsb0ZvdW5kYXRpb24vUG9tZWxvLkVudGl0eUZyYW1ld29ya0NvcmUuTXlTcWw=">Pomelo.EntityFrameworkCore.MySql<i class="fa fa-external-link-alt"></i></span>，成功解决问题。</p>
]]></content>
      <categories>
        <category>踩坑笔记</category>
      </categories>
      <tags>
        <tag>EFCore</tag>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>Rtmp/Hls直播、点播服务器部署与配置</title>
    <url>/posts/13147.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>测试使用的系统为CentOS7.3、所有文章中涉及到的包打包在以下地址:</p>
<p>链接：<span class="exturl" data-url="aHR0cDovL3Bhbi5iYWlkdS5jb20vcy8xbnVGM2dMVg==">http://pan.baidu.com/s/1nuF3gLV<i class="fa fa-external-link-alt"></i></span> 密码：fo8q</p>
 <span id="more"></span>
<h2 id="Nginx-Rtmp-Module-安装"><a href="#Nginx-Rtmp-Module-安装" class="headerlink" title="Nginx-Rtmp-Module 安装"></a>Nginx-Rtmp-Module 安装</h2><p> 1). 安装依赖包<br> <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum -y install gcc glibc glibc-devel make nasm pkgconfig openssl-devel expat-devel gettext-devel libtool perl-Digest-SHA1.x86_64</span><br></pre></td></tr></table></figure><br>2). yum 安装相关工具包及 ffmpeg 依赖包<br>   <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum -y install git zlib pcre openssl</span><br></pre></td></tr></table></figure><br>3). 手动编译安装工具包和依赖包<br>    a). <strong>yadmi</strong><br>     <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tar xzvf yamdi-1.9.tar.gz</span><br><span class="line">cd yamdi-1.9</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line">cd ..</span><br></pre></td></tr></table></figure><br>b). <strong>yasm</strong><br>    <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tar xzvf yasm-1.3.0.tar.gz</span><br><span class="line">cd yasm-1.3.0</span><br><span class="line">./configure</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line">cd ..</span><br></pre></td></tr></table></figure><br>c). <strong>x264</strong><br>    <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tar -xjvf x264.tar.bz2</span><br><span class="line">cd x264-snapshot-20170111-2245</span><br><span class="line">./configure --enable-shared </span><br><span class="line">make &amp;&amp; make install</span><br><span class="line">cd ..</span><br></pre></td></tr></table></figure><br>d). <strong>lame</strong><br>    <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"> tar xzvf lame-3.99.5.tar.gz</span><br><span class="line"> cd lame-3.99.5</span><br><span class="line">./configure --enable-nasm</span><br><span class="line"> make &amp;&amp; make install</span><br><span class="line"> cd ..</span><br></pre></td></tr></table></figure><br>e). <strong>faad2</strong><br>    <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tar zxvf faad2-2.7.tar.gz</span><br><span class="line">cd faad2-2.7</span><br><span class="line">./configure</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line">cd ..</span><br></pre></td></tr></table></figure><br>f). <strong>faac</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tar zxvf faac-1.28.tar.gz</span><br><span class="line">cd faac-1.28</span><br><span class="line">./configure</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line">cd ..</span><br></pre></td></tr></table></figure>
<p>g). <strong>xvid</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tar zxvf xvidcore-1.3.3.tar.gz</span><br><span class="line">cd xvidcore/build/generic</span><br><span class="line">./configure</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line">cd ..</span><br></pre></td></tr></table></figure>
<p>h). <strong>ffmpeg</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tar -xjvf ffmpeg-3.2.4.tar.bz2</span><br><span class="line">cd ffmpeg-3.2.4</span><br><span class="line">./configure  --prefix=/opt/ffmpeg/ --enable-version3 --enable-libvpx --enable-libmp3lame  --enable-libvorbis --enable-libx264 --enable-libxvid --enable-shared --enable-gpl --enable-postproc--enable-nonfree  --enable-avfilter --enable-pthreads</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line">cd ..</span><br></pre></td></tr></table></figure>
<p>i). 修改/etc/ld.so.conf如下:<br>        <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">include ld.so.conf.d/*.conf</span><br><span class="line">/lib</span><br><span class="line">/lib64</span><br><span class="line">/usr/lib</span><br><span class="line">/usr/lib64</span><br><span class="line">/usr/local/lib</span><br><span class="line">/usr/local/lib64</span><br><span class="line">/opt/ffmpeg/lib</span><br><span class="line">ldconfig</span><br></pre></td></tr></table></figure><br>4). 安装 Nginx<br>        <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tar zxvf nginx-1.9.9.tar.gz</span><br><span class="line">unzip nginx-rtmp-module-master.zip</span><br><span class="line">tar zxvf openssl-1.0.2k.tar.gz</span><br><span class="line">cd nginx-1.9.9</span><br><span class="line">./configure --add-module=../nginx-rtmp-module-master --without-http_rewrite_module --with-openssl=../openssl-1.0.2k</span><br><span class="line">make &amp; make install</span><br><span class="line">cd ..</span><br></pre></td></tr></table></figure></p>
<h2 id="nginx-conf配置"><a href="#nginx-conf配置" class="headerlink" title="nginx.conf配置"></a>nginx.conf配置</h2> <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"> # nginx.conf Start</span><br><span class="line">worker_processes  1;                    #  nginx对外提供 web 服务时的 worker 进程数</span><br><span class="line"></span><br><span class="line">error_log  logs/error.log debug;        # 错误日志路径</span><br><span class="line"></span><br><span class="line">pid        logs/nginx.pid;                #  pid 文件路径</span><br><span class="line">worker_rlimit_nofile 51200;                #  worker 进程的最大打开文件数限制</span><br><span class="line"></span><br><span class="line">events &#123;                                #  events 模块中包含 nginx 中所有处理连接的设置。</span><br><span class="line">    use epoll;                                # 设置用于复用客户端线程的轮询方法。</span><br><span class="line">    worker_connections  51200;                #由一个 worker 进程同时打开的最大连接数。</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">rtmp_auto_push on;                        # 切换自动推送(多 worker 直播流)模式</span><br><span class="line"></span><br><span class="line">rtmp_auto_push_reconnect 1s;            # 当 worker 被干掉时设置自动推送连接超时时间。默认为 100 毫秒。</span><br><span class="line"></span><br><span class="line">rtmp &#123;                                    # 保存所有 RTMP 配置的块。    </span><br><span class="line">    server &#123;                                # 声明一个 RTMP 实例。</span><br><span class="line">        listen 1935;                            # 监听的端口号</span><br><span class="line">        chunk_size 4096;                        # 流整合的最大的块大小。默认值为 4096。</span><br><span class="line"></span><br><span class="line">        application vod &#123;                        # 创建一个 RTMP 应用。</span><br><span class="line">            play /opt/media/nginxrtmp/flv;            # 点播文件路径</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        application live &#123;                        # 创建一个 RTMP 应用。</span><br><span class="line">            live on;                                # 是否直播</span><br><span class="line">            hls on;                                    # 是否开启hls</span><br><span class="line">            hls_path /usr/local/nginx/html/live;    # 设置 HLS 播放列表和分段目录。</span><br><span class="line">            hls_fragment 1s;                        # 设置 HLS 分段长度。</span><br><span class="line">            max_connections 1024;                    # 最大连接数    </span><br><span class="line">            hls_playlist_length 30s;                #  HLS 播放列表长度</span><br><span class="line">            hls_sync 100ms;                            #  HLS 时间戳同步阈值</span><br><span class="line">            meta copy;                                # 是否发送元数据到客户端    </span><br><span class="line">            recorder manual &#123;                        # 创建一个录制应用</span><br><span class="line">                record all manual;                        # 设置录制模式</span><br><span class="line">                record_suffix %Y-%m-%d-%H_%M_%S.flv;    # 设置录制文件名</span><br><span class="line">                record_max_size 6200000K;                # 设置录制文件的最大值    </span><br><span class="line">                record_path /usr/local/nginx/html/Rec;    # 指定录制的 flv 文件存放目录</span><br><span class="line">            &#125;</span><br><span class="line">            #record keyframes;</span><br><span class="line">            #record_path /tmp;</span><br><span class="line">            #record_max_size 128K;</span><br><span class="line">            #record_interval 30s;</span><br><span class="line">            #record_suffix .this.is.flv;</span><br><span class="line"></span><br><span class="line">            #on_publish http://localhost:8080/publish;</span><br><span class="line">            #on_play http://localhost:8080/play;</span><br><span class="line">            #on_record_done http://localhost:8080/record_done;</span><br><span class="line">        &#125;</span><br><span class="line">        # application hls &#123;  </span><br><span class="line">        #     live on;  </span><br><span class="line">        #     hls on;  </span><br><span class="line">        #     hls_path /tmp/app;  </span><br><span class="line">        #     hls_fragment 5s;  </span><br><span class="line">        # &#125;</span><br><span class="line"></span><br><span class="line">        # application hls&#123;</span><br><span class="line">        #     live on;</span><br><span class="line">        #     hls on;</span><br><span class="line">        #     hls_path /usr/local/nginx/html/hls;</span><br><span class="line">        #     hls_fragment 5s;</span><br><span class="line">        # &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen      5000;</span><br><span class="line">        keepalive_timeout  65;</span><br><span class="line">        location /stat &#123;</span><br><span class="line">            rtmp_stat all;</span><br><span class="line">            rtmp_stat_stylesheet stat.xsl;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location /stat.xsl &#123;</span><br><span class="line">            root /opt/nginx-rtmp-server/nginx-rtmp-module/;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location /control &#123;</span><br><span class="line">            rtmp_control all;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location /rtmp-publisher &#123;</span><br><span class="line">            root /opt/nginx-rtmp-server/nginx-rtmp-module/test;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">            root /opt/nginx-rtmp-server/nginx-rtmp-module/test/www;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location /crplayer &#123;</span><br><span class="line">            root /opt/nginx-rtmp-server/nginx-rtmp-module/test;</span><br><span class="line">        &#125;</span><br><span class="line">         </span><br><span class="line">        location /live &#123;  </span><br><span class="line">           #server hls fragments  </span><br><span class="line">            types&#123;  </span><br><span class="line">                application/vnd.apple.mpegurl m3u8;  </span><br><span class="line">                video/mp2t ts;  </span><br><span class="line">            &#125;  </span><br><span class="line">            root html;</span><br><span class="line">            expires -1;  </span><br><span class="line">        &#125; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"># nginx.conf End</span><br></pre></td></tr></table></figure>
<h2 id="运行Nginx服务"><a href="#运行Nginx服务" class="headerlink" title="运行Nginx服务"></a>运行Nginx服务</h2> <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/usr/local/nginx/sbin/nginx -c /root/nginx/nginx.conf</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>踩坑笔记</category>
      </categories>
      <tags>
        <tag>nginx-rtmp</tag>
        <tag>流媒体</tag>
        <tag>hls</tag>
        <tag>点播</tag>
      </tags>
  </entry>
  <entry>
    <title>Selenium PhantomJS 巧妙过渡到 Firefox/Chrome</title>
    <url>/posts/40690.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="PhantomJS-Obsolete"><a href="#PhantomJS-Obsolete" class="headerlink" title="PhantomJS Obsolete"></a>PhantomJS Obsolete</h1><h2 id="Origin"><a href="#Origin" class="headerlink" title="Origin"></a>Origin</h2><p>前段时间因为一些个人爱好，想要对某网站的数据进行整站采集，其中需要对某些页面的一些区块进行截图采集，整个采集任务中还涉及一些验证码识别之类的工作。学艺不精，我当前掌握的 Scrapy 知识很难完成这样一个爬虫，就使用了 Selenium + PhantomJS 制作了一个模拟浏览器访问来爬取数据的小爬虫，完成了整套抓取任务。<br><img data-src="https://qiniucdn.wayneshao.com/20180711045204672.gif"></p>
<span id="more"></span>
<p>然而上个月手误格掉了整块数据硬盘，之前的代码也没留下备份，我还仍然有同样的数据采集需要，只能准备按照原有思路重新做一个爬虫，这本来应该只是个体力活，只要重新抓样本，做好验证码识别，之后就应该一马平川，一泻千里了。<br><img data-src="https://qiniucdn.wayneshao.com/Selenium-+-Firefox-Chrome-%E5%85%A8%E9%A1%B5%E9%9D%A2%E6%88%AA%E5%9B%BE/20180711050254778.png"><br>然而就在我开始动手的时候，PhantomJSDriver 类型下的蓝色下划线成功吸引了有强迫症的程序员本尊的注意<br><img data-src="https://qiniucdn.wayneshao.com/20180711213420950/20180711101818131.png"><br><img data-src="https://qiniucdn.wayneshao.com/20180711213420950/20180711101850349.png"><br><img data-src="https://qiniucdn.wayneshao.com/Selenium%E5%85%A8%E9%A1%B5%E9%9D%A2%E6%88%AA%E5%9B%BE/20180711080149417.png"></p>
<p>运用我考了三遍都没过的四级英语定睛一看，这个意思是说， PhantomJSDriver 类型已经被<strong>弃用</strong>，PhantomJS 的开发工作已经停止，PhantomJS 的驱动<strong>将会在未来的某个 release 版本上被移除</strong>。<br><strong>天哪~！</strong><br><img data-src="https://qiniucdn.wayneshao.com/Selenium%E5%85%A8%E9%A1%B5%E9%9D%A2%E6%88%AA%E5%9B%BE/20180711080102494.png"><br>告诉我不是真的！Selenium 居然放弃了他的好基友 PhantomJS！<br><em><strong>（这个声明颇有 “不是我他跟不上我的进步被我抛弃，而是他渣，他抛弃了我” 的戏剧性，让我不由得想要查证一下）</strong></em></p>
<h2 id="Investigate"><a href="#Investigate" class="headerlink" title="Investigate"></a>Investigate</h2><p>不敢相信的我祭出了谷歌神器</p>
<blockquote>
<p>Chrome 59 将支持 Headless 模式。而在 Chrome 未提供原生 Headless 模式前，Web 开发者可以使用 PhantomJS 等第三方 Headless 浏览器。现在官方准备提供 Headless 了，PhantomJS 主要的贡献者 Vitaly Slobodin 随即在邮件列表上宣布辞职。<br><img data-src="https://qiniucdn.wayneshao.com/Selenium%E5%85%A8%E9%A1%B5%E9%9D%A2%E6%88%AA%E5%9B%BE/20180711080802730.png"><br>因为这半年都没有过写新爬虫的需求，而最近一直在跑着的爬虫用的是老版本 Selenium 开发，所以还 PhantomJS 玩得很嗨，殊不知已经 Out 了。查了一下，<strong>去年四月份的 Chrome 59 版本和六月份的 Firefox 56 版本都引入了 Headless 模式</strong>，PhantomJS 的独领风骚地位瞬间丧失，开发者流失，仅剩的一位开发者 Vitaly Slobodin 看不到 PhantomJS 的未来，选择了<strong>停止开发</strong>，然后 “不思进取” 的 PhantomJS 逐渐消失在历史的尘埃中…… 小厂出的创新产品，大厂做出类似产品之后，小厂 GG，大概也就是这么一回事吧……<br><em><strong>（虽然果真是 PhantomJS 做了负心汉，但还是莫名悲壮，有种丈夫不思进取，觉得配不上努力上进妻子然后自我了断给妻子自由的既视感）</strong></em></p>
</blockquote>
<h1 id="Headless-Chrome-Firefox"><a href="#Headless-Chrome-Firefox" class="headerlink" title="Headless Chrome/Firefox"></a>Headless Chrome/Firefox</h1><p>想要使用 Selenium 控制 Firefox 进行页面浏览，需要先做以下的准备工作：</p>
<h2 id="Headless-Firefox"><a href="#Headless-Firefox" class="headerlink" title="Headless Firefox"></a>Headless Firefox</h2><h3 id="Prepare"><a href="#Prepare" class="headerlink" title="Prepare"></a>Prepare</h3><ol>
<li>安装最新版本的 Firefox 浏览器。</li>
<li>下载最新版本的适应当前系统的 GeckoDriver。</li>
<li>将步骤 2 下载的 GeckoDriver 的程序文件移动到 Firefox 的程序目录中，使两个程序的执行文件处于同一目录中，并将程序所在的目录加入到环境变量中。</li>
</ol>
<p>然后引入官方的四个 Nuget 包：<br><img data-src="https://qiniucdn.wayneshao.com/Selenium%E5%85%A8%E9%A1%B5%E9%9D%A2%E6%88%AA%E5%9B%BE/20180711082732423.png"></p>
<blockquote>
<p>Install-Package Selenium.WebDriver<br>Install-Package Selenium.WebDriverBackedSelenium<br>Install-Package Selenium.Support<br>Install-Package Selenium.RC</p>
</blockquote>
<h3 id="Coding"><a href="#Coding" class="headerlink" title="Coding"></a>Coding</h3><p>随意拉一个窗体用于测试，然后敲入以下代码：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> firefoxOption = <span class="keyword">new</span> FirefoxOptions();</span><br><span class="line">firefoxOption.AddArguments(<span class="string">&quot;-headless&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> firefoxDriver = <span class="keyword">new</span> FirefoxDriver(firefoxOption);</span><br><span class="line"></span><br><span class="line">firefoxDriver.Navigate().GoToUrl(<span class="string">&quot;http://www.baidu.com/&quot;</span>);</span><br><span class="line"></span><br><span class="line">textBox1.Text = firefoxDriver.PageSource;</span><br></pre></td></tr></table></figure>
<p>运行结果：<br><img data-src="https://qiniucdn.wayneshao.com/20180711213420950/20180711105729884.png"></p>
<h2 id="Headless-Chrome"><a href="#Headless-Chrome" class="headerlink" title="Headless Chrome"></a>Headless Chrome</h2><h3 id="Prepare-1"><a href="#Prepare-1" class="headerlink" title="Prepare"></a>Prepare</h3><p>想要使用 Selenium 控制 Chrome 进行页面浏览，需要做的准备工作和上面的 Firefox 大同小异：</p>
<ol>
<li>安装最新版本的 Chrome 浏览器（也可以考虑像我一样使用国内大牛写的 Chrome 绿色化工具 MyChrome 安装绿色版 Chrome ，在版本控制、用户文件本地化方面更具优势）。</li>
<li>下载最新版本的适应当前系统的 ChromeDriver。</li>
<li>将步骤 2 下载的 ChromeDriver 的程序文件移动到 Chrome 的程序目录中，使两个程序的执行文件处于同一目录中，并将程序所在的目录加入到环境变量中。</li>
</ol>
<p>依然是官方的四个 Nuget 包（如果已经安装过，则直接跳过）：<br><img data-src="https://qiniucdn.wayneshao.com/Selenium%E5%85%A8%E9%A1%B5%E9%9D%A2%E6%88%AA%E5%9B%BE/20180711082732423.png"></p>
<blockquote>
<p>Install-Package Selenium.WebDriver<br>Install-Package Selenium.WebDriverBackedSelenium<br>Install-Package Selenium.Support<br>Install-Package Selenium.RC</p>
</blockquote>
<h3 id="Coding-1"><a href="#Coding-1" class="headerlink" title="Coding"></a>Coding</h3><p>随意拉一个窗体用于测试，然后敲入以下代码：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> chromeOption = <span class="keyword">new</span> ChromeOptions();</span><br><span class="line">chromeOption.AddArguments(<span class="string">&quot;--headless&quot;</span>, <span class="string">&quot;--disable-gpu&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> chromeDriver = <span class="keyword">new</span> ChromeDriver(chromeOption);</span><br><span class="line"></span><br><span class="line">chromeDriver.Navigate().GoToUrl(<span class="string">&quot;http://www.baidu.com/&quot;</span>);</span><br><span class="line"></span><br><span class="line">textBox1.Text = chromeDriver.PageSource;</span><br></pre></td></tr></table></figure>
<p>运行结果：<br><img data-src="https://qiniucdn.wayneshao.com/20180711213420950/20180711111201947.png"></p>
<h2 id="Full-Page-ScreenShot"><a href="#Full-Page-ScreenShot" class="headerlink" title="Full Page ScreenShot"></a>Full Page ScreenShot</h2><p>无头模式是已经实现了，在打开时间上效率略差于 PhantomJS，但是执行页面抓取是却要更优于 PhantomJS ，无愧于老牌浏览器的称号。可是接下来就遇到了新的问题，上面提到的，我的爬虫求有截取页面某一区域图片的需求，而 Selenium 的驱动 API 标准获取图片的只有 GetScreenShot ，在之前使用 PhantomJS 时，由于 PhantomJS 从从诞生时起就是一个为爬虫服务的没有界面的浏览器，所以截图 API 截到的就是整个页面的图片，在获取某一区域的渲染图片时，只需要从截到的全页面图中将区域所在的矩形取出来，就可以完成要求。但是对于 Chrome 和 Firefox 这样的浏览器，虽然有 Headless 模式，但是窗口的概念是一只存在的， GetScreenShot 截到的只会是浏览器窗口显示的部分页面的截图，所以我们需要找到一种可以截全图的方法。</p>
<h3 id="Thinking"><a href="#Thinking" class="headerlink" title="Thinking"></a>Thinking</h3><p>想要在每次只能截到浏览器显示区域截图的情况下得到整个页面的截图，有如下两个思路：</p>
<ol>
<li>控制浏览器滚动条移动，将所有区域的截图全都获取到，再根据每次截图时滚动条所处的位置信息，将所有截图合并到一起，最终得到全页面的截图。</li>
<li>把浏览器的窗口大小设置到页面一样大，甚至比页面稍大些，再进行截图，就可以得到全页面的截图。<br>比较而言无疑是思路 2 更为简单高效，而且在 Headless 模式下，浏览器窗口的变化也完全不会有什么影响，故我们选用第二种思路来实现全页面截图。</li>
</ol>
<h3 id="Coding-2"><a href="#Coding-2" class="headerlink" title="Coding"></a>Coding</h3><p>这里我们使用. NET 知名开源图片处理组件 ImageProcessor 来进行图片裁剪。</p>
<blockquote>
<p>Install-Package ImageProcessor</p>
</blockquote>
<p>并非专业前端的我开始觉得 html 标签的尺寸应该就是整个页面的尺寸了，所以有了如下的代码：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Image <span class="title">GetElementImage</span>(<span class="params"><span class="keyword">this</span> RemoteWebDriver driver, IWebElement element</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    driver.Manage().Window.Size = driver.FindElementByTagName(<span class="string">&quot;html&quot;</span>).Size;</span><br><span class="line">    <span class="keyword">var</span> photoBytes = driver.GetScreenshot().AsByteArray;</span><br><span class="line">    <span class="keyword">using</span> (<span class="keyword">var</span> inStream = <span class="keyword">new</span> MemoryStream(photoBytes))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">using</span> (<span class="keyword">var</span> outStream = <span class="keyword">new</span> MemoryStream())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">using</span> (<span class="keyword">var</span> imageFactory = <span class="keyword">new</span> ImageFactory(<span class="literal">true</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                imageFactory.Load(inStream)</span><br><span class="line">                    .Crop(<span class="keyword">new</span> Rectangle(element.Location, element.Size))</span><br><span class="line">                    .Save(outStream);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> Image.FromStream(outStream);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是在测试过程中发现并非如此，具体测试页面为 “Selenium 的维基百科关键词主页”<span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvU2VsZW5pdW1fKHNvZnR3YXJlKQ==">https://en.wikipedia.org/wiki/Selenium_(software)<i class="fa fa-external-link-alt"></i></span><br>调用代码：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">pictureBox1.Image =</span><br><span class="line">                chromeDriver.GetElementImage(</span><br><span class="line">                    chromeDriver.FindElementByXPath(<span class="string">@&quot;//*[@id=&quot;&quot;footer-copyrightico&quot;&quot;]/a/img&quot;</span>));</span><br></pre></td></tr></table></figure>

<p><img data-src="https://qiniucdn.wayneshao.com/20180711213420950/20180711115157926.png"></p>
<p>调用代码中的 XPath 命中的标签为页面底部的维基百科 logo 图片，调试信息可知，该标签的 Y 坐标远大于 Html 标签的 Height ，故 Html 的尺寸应该和页面实际尺寸并不完全吻合。</p>
<p>居然不对？！<br><img data-src="https://qiniucdn.wayneshao.com/20180711213420950/20180712120904055.png"></p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29tL3F1ZXN0aW9uLzIwODE2ODc5">查询资料大法：<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">//页面尺寸</span></span><br><span class="line"><span class="keyword">var</span> pageWidth = Math.max(</span><br><span class="line">     document.body.scrollWidth,</span><br><span class="line">     document.documentElement.scrollWidth,</span><br><span class="line">     document.body.offsetWidth, </span><br><span class="line">     document.documentElement.offsetWidth,</span><br><span class="line">     document.documentElement.clientWidth</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> pageHeight = Math.max(</span><br><span class="line">     document.body.scrollHeight,</span><br><span class="line">     document.documentElement.scrollHeight,</span><br><span class="line">     document.body.offsetHeight, </span><br><span class="line">     document.documentElement.offsetHeight,</span><br><span class="line">     document.documentElement.clientHeight</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>于是我决定改用执行 JS 代码来获取页面实际尺寸：<br>封装 JS 执行方法：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> T <span class="title">Execute</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="keyword">this</span> IWebDriver driver, <span class="built_in">string</span> script</span>)</span> </span><br><span class="line">            =&gt; (T)((IJavaScriptExecutor)driver).ExecuteScript(script);</span><br></pre></td></tr></table></figure>
<p>获取实际尺寸</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> height = driver.Execute&lt;<span class="built_in">long</span>&gt;(<span class="string">&quot;return Math.max(document.body.scrollHeight, document.body.offsetHeight, document.documentElement.clientHeight, document.documentElement.scrollHeight, document.documentElement.offsetHeight);&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> width = driver.Execute&lt;<span class="built_in">long</span>&gt;(<span class="string">&quot;return Math.max(document.body.scrollWidth, document.body.offsetWidth, document.documentElement.clientWidth, document.documentElement.scrollWidth, document.documentElement.offsetWidth);&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>使用新思路重新封装方法</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Image <span class="title">GetElementImage</span>(<span class="params"><span class="keyword">this</span> RemoteWebDriver driver, IWebElement element</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//driver.Manage().Window.Size = driver.FindElementByTagName(&quot;html&quot;).Size;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> height = driver.Execute&lt;<span class="built_in">long</span>&gt;(<span class="string">&quot;return Math.max(document.body.scrollHeight, document.body.offsetHeight, document.documentElement.clientHeight, document.documentElement.scrollHeight, document.documentElement.offsetHeight);&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> width = driver.Execute&lt;<span class="built_in">long</span>&gt;(<span class="string">&quot;return Math.max(document.body.scrollWidth, document.body.offsetWidth, document.documentElement.clientWidth, document.documentElement.scrollWidth, document.documentElement.offsetWidth);&quot;</span>);</span><br><span class="line"></span><br><span class="line">    driver.Manage().Window.Size = <span class="keyword">new</span> Size((<span class="built_in">int</span>)width + <span class="number">100</span>, (<span class="built_in">int</span>)height + <span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> photoBytes = driver.GetScreenshot().AsByteArray;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">using</span> (<span class="keyword">var</span> inStream = <span class="keyword">new</span> MemoryStream(photoBytes))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">using</span> (<span class="keyword">var</span> outStream = <span class="keyword">new</span> MemoryStream())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">using</span> (<span class="keyword">var</span> imageFactory = <span class="keyword">new</span> ImageFactory(<span class="literal">true</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                imageFactory.Load(inStream)</span><br><span class="line">                    .Crop(<span class="keyword">new</span> Rectangle(element.Location, element.Size))</span><br><span class="line">                    .Save(outStream);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> Image.FromStream(outStream);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码执行结果如下：<br><img data-src="https://qiniucdn.wayneshao.com/20180711213420950/20180712120513778.png"></p>
<p>成功！</p>
<p><img data-src="https://qiniucdn.wayneshao.com/20180711213420950/20180712120712325.png"></p>
]]></content>
      <categories>
        <category>踩坑笔记</category>
      </categories>
      <tags>
        <tag>C#</tag>
        <tag>selenium</tag>
        <tag>full page screenshot</tag>
        <tag>全页面截图</tag>
      </tags>
  </entry>
  <entry>
    <title>WSL2安装CentOS8等其他官方没有直接提供的Linux版本</title>
    <url>/posts/46310.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>鉴于 Microsoft 官方并没有提供官方的 CentOS8 的 WSL2 包，甚至 CentOS 的官方也并没有提供对应的包（Ubuntu 是微软和官方都有提供的），联想到 WSL2 和 Docker 在某种意义上是十分类似的，rootfs 都是核心，猜测可能会有方法使用官方提供标准包更广泛的 Docker 包的 rootfs 直接建立 WSL2 应用，经过摸索，发现可以使用 LxRunOffline 搞定，遂记录。</p>
<span id="more"></span>
<h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><h3 id="安装和启用-WSL2"><a href="#安装和启用-WSL2" class="headerlink" title="安装和启用 WSL2"></a>安装和启用 WSL2</h3><p>启用功能可能会需要重启。</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 启用 WSL</span></span><br><span class="line">dism.exe /online /<span class="built_in">enable-feature</span> /featurename:Microsoft<span class="literal">-Windows-Subsystem-Linux</span> /all /norestart</span><br><span class="line"><span class="comment"># 启用 VMP</span></span><br><span class="line">dism.exe /online /<span class="built_in">enable-feature</span> /featurename:VirtualMachinePlatform /all /norestart</span><br><span class="line"><span class="comment"># 设置 WSL2 为默认版本</span></span><br><span class="line">wsl <span class="literal">--set-default-version</span> <span class="number">2</span></span><br></pre></td></tr></table></figure>

<p>下载 <span class="exturl" data-url="aHR0cHM6Ly93c2xzdG9yZXN0b3JhZ2UuYmxvYi5jb3JlLndpbmRvd3MubmV0L3dzbGJsb2Ivd3NsX3VwZGF0ZV94NjQubXNp">WSL2 内核更新包<i class="fa fa-external-link-alt"></i></span>并安装。</p>
<h3 id="安装-LxRunOffline"><a href="#安装-LxRunOffline" class="headerlink" title="安装 LxRunOffline"></a>安装 LxRunOffline</h3><h4 id="安装-Chocolatey"><a href="#安装-Chocolatey" class="headerlink" title="安装 Chocolatey"></a>安装 Chocolatey</h4><p>管理员运行 Powershell</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Set-ExecutionPolicy</span> Bypass <span class="literal">-Scope</span> <span class="keyword">Process</span> <span class="literal">-Force</span>; <span class="built_in">iex</span> ((<span class="built_in">New-Object</span> System.Net.WebClient).DownloadString(<span class="string">&#x27;https://chocolatey.org/install.ps1&#x27;</span>))</span><br></pre></td></tr></table></figure>

<h4 id="使用-Chocolatey-安装-LxRunOffline"><a href="#使用-Chocolatey-安装-LxRunOffline" class="headerlink" title="使用 Chocolatey 安装 LxRunOffline"></a>使用 Chocolatey 安装 LxRunOffline</h4><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0REb1NvbGl0YXJ5L0x4UnVuT2ZmbGluZQ==">LxRunOffline<i class="fa fa-external-link-alt"></i></span> 是用于管理适用于 Linux 的 Windows 子系统 (WSL) 的全功能实用程序，可以安装任意发行版到任意目录、转移已安装的 WSL 目录、备份 WSL、设置默认用户和修改环境变量等操作。</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">choco install lxrunoffline</span><br></pre></td></tr></table></figure>

<h2 id="安装-Linux-发行版的-Docker-rootfs-包为-WSL2"><a href="#安装-Linux-发行版的-Docker-rootfs-包为-WSL2" class="headerlink" title="安装 Linux 发行版的 Docker rootfs 包为 WSL2"></a>安装 Linux 发行版的 Docker rootfs 包为 WSL2</h2><p>以下以 CentOS 为示例，其他发行版可以参照。</p>
<h3 id="下载-rootfs-包"><a href="#下载-rootfs-包" class="headerlink" title="下载 rootfs 包"></a>下载 rootfs 包</h3><p>访问<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0NlbnRPUy9zaWctY2xvdWQtaW5zdGFuY2UtaW1hZ2VzLw==">CentOS 的官方 Docker rootfs 包仓库<i class="fa fa-external-link-alt"></i></span>，找到 CentOS8 最新版本的<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0NlbnRPUy9zaWctY2xvdWQtaW5zdGFuY2UtaW1hZ2VzL3Jhdy9DZW50T1MtOC14ODZfNjQvZG9ja2VyL2NlbnRvcy04LXg4Nl82NC50YXIueHo=">包<i class="fa fa-external-link-alt"></i></span>在 CentOS-8-x86_64 分支，下载备用。</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">LxRunOffline install <span class="literal">-n</span> CentOS8 <span class="literal">-d</span> D:\WSL\CentOS8 <span class="operator">-f</span> .\centos<span class="literal">-8-x86_64</span>.tar.xz</span><br></pre></td></tr></table></figure>

<p>查看效果并设置为默认wsl</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">wsl <span class="literal">-l</span></span><br><span class="line">wsl <span class="literal">-s</span> CentOS8</span><br></pre></td></tr></table></figure>

<p><img data-src="https://qiniucdn.wayneshao.com/46310/wsl_install.jpg" alt="WSL安装"></p>
<p>进入 WSL 测试</p>
<p><img data-src="https://qiniucdn.wayneshao.com/46310/wsl_open.jpg" alt="WSL测试"></p>
]]></content>
      <categories>
        <category>偶有所得</category>
      </categories>
      <tags>
        <tag>Docker</tag>
        <tag>WSL2</tag>
        <tag>CentOS8</tag>
        <tag>LxRunOffline</tag>
        <tag>rootfs</tag>
      </tags>
  </entry>
  <entry>
    <title>Windows下DockerCE启用K8s报错kubernetes.docker.internal no such host</title>
    <url>/posts/10324.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="踩坑"><a href="#踩坑" class="headerlink" title="踩坑"></a>踩坑</h2><p>在安装 Windows CE 之后，我尝试从设置菜单中启用Kubernetes，却一直处于 starting 状态不见好，查找位于 <em><strong>C:\ProgramData\DockerDesktop\service.txt</strong></em> 目录下的日志文件后，发现大片大片类似的错误日志：<br><img data-src="https://qiniucdn.wayneshao.com/20191007041435438.png"></p>
<span id="more"></span>
<p>根据错误信息</p>
<blockquote>
<p>dial tcp: lookup kubernetes.docker.internal: no such host</p>
</blockquote>
<p>可知，错误的原因是无法解析到域名 <strong>kubernetes.docker.internal</strong>，随即开始寻找解决思路。</p>
<h2 id="寻求解决"><a href="#寻求解决" class="headerlink" title="寻求解决"></a>寻求解决</h2><h3 id="一（失败）"><a href="#一（失败）" class="headerlink" title="一（失败）"></a>一（失败）</h3><p>首先我在 DockerCE for Windows 的 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2RvY2tlci9mb3Itd2luL2lzc3Vlcy8xOTYy">issue<i class="fa fa-external-link-alt"></i></span> 看到JoseThen提出了如下<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2RvY2tlci9mb3Itd2luL2lzc3Vlcy8xOTYyI2lzc3VlY29tbWVudC00NDc2MDkwMTg=">解决方案<i class="fa fa-external-link-alt"></i></span>：</p>
<blockquote>
<p>I was able to get this working even after restarting docker::</p>
</blockquote>
<ol>
<li>Change DNS to fixed and use 8.8.8.8, this is within docker for window’s settings</li>
<li>Remove the .kube</li>
<li>Add the KUBECONFIG environment variable to System Variables and have the path be C:\Users[MYUSER].kube\config. Note that before I had it set as a User Variable.</li>
<li>Restart Docker from the Docker for Window’s reset tab in settings.</li>
<li>Restart Kubernetes Cluster from the Docker for Window’s reset tab in settings (you can do this a number of times).</li>
<li>Afterwards just wait for some time and Kubernetes is running should display.<br>I hope this can help someone, this issue is a pain.</li>
</ol>
<p>查看之后发现 kube 的配置文件确实有配置这个路径<br>clusters[0]&gt;server:<span class="exturl" data-url="aHR0cHM6Ly9rdWJlcm5ldGVzLmRvY2tlci5pbnRlcm5hbDo2NDQzLw==">https://kubernetes.docker.internal:6443<i class="fa fa-external-link-alt"></i></span> ，按照 JoseThen 的方法删除配置文件后重启，却并未成功解决，重新生成的文件中对应节点的值依然还是之前的地址，继续寻找解决思路。</p>
<h3 id="二"><a href="#二" class="headerlink" title="二"></a>二</h3><p>之后我在 DockerCE for Mac 的 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2RvY2tlci9mb3ItbWFjL2lzc3Vlcy8zODI5">issue<i class="fa fa-external-link-alt"></i></span> 看到了<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2RvY2tlci9mb3ItbWFjL2lzc3Vlcy8zODI5I2lzc3VlY29tbWVudC01MjA1MDM5NzQ=">解决方案<i class="fa fa-external-link-alt"></i></span>，原来 kubernetes.docker.internal 应该指向的就是本机，将</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># Kubernetes</span><br><span class="line">127.0.0.1 kubernetes.docker.internal</span><br></pre></td></tr></table></figure>
<p>加入hosts之后即成功解决。</p>
<h2 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h2><p><img data-src="https://qiniucdn.wayneshao.com/Windows%E4%B8%8BDockerCE%E5%90%AF%E7%94%A8K8s%E8%B8%A9%E5%9D%91%E7%AC%94%E8%AE%B0/20191007045422970.png"></p>
]]></content>
      <categories>
        <category>踩坑笔记</category>
      </categories>
      <tags>
        <tag>DockerCE</tag>
        <tag>K8s</tag>
        <tag>踩坑</tag>
      </tags>
  </entry>
  <entry>
    <title>Windows11系统下劫持notepad.exe的方法</title>
    <url>/posts/46308.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>　　在微软终于对 nodepad.exe 和 mspaint.exe 的界面下手，把这两个系统程序重构为UWP程序后，原有的镜像劫持替换 notepad.exe 的方法就直接失效了，经过研究，找到了亲测可行的替换方法，特此分享。</p>
<span id="more"></span>
<p>具体步骤如下：</p>
<ol>
<li>卸载新版本的 notepad.exe。</li>
<li>劫持镜像。</li>
<li>关闭 UseFilter 开关。</li>
</ol>
<p>以下涉及到的软件有：</p>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3p1ZnVsaXUvbm90ZXBhZDI=">Notepad2（待替换的软件）<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cDovL3d3dy5kYXlhbnphaS5tZS9yZWdpc3RyeS1maW5kZXIuaHRtbA==">Registry Finder<i class="fa fa-external-link-alt"></i></span>（非必要，可以直接用系统自带的 regedit）</li>
<li>Windows PowerShell（系统自带）<h1 id="操作步骤"><a href="#操作步骤" class="headerlink" title="操作步骤"></a>操作步骤</h1><h2 id="卸载-notepad-exe-的升级UWP程序"><a href="#卸载-notepad-exe-的升级UWP程序" class="headerlink" title="卸载 notepad.exe 的升级UWP程序"></a>卸载 notepad.exe 的升级UWP程序</h2>随便用记事本打开一个文件，然后用 taskmanager 追踪文件的位置，得到一个明显是Windows程序的目录。<br><code>C:\Program Files\WindowsApps\Microsoft.WindowsNotepad_10.2102.13.0_x64__8wekyb3d8bbwe\Notepad</code><br><img data-src="https://qiniucdn.wayneshao.com/Windows11%E7%B3%BB%E7%BB%9F%E4%B8%8B%E5%8A%AB%E6%8C%81notepad.exe%E7%9A%84%E6%96%B9%E6%B3%95/20210706034436963.png"><br>直接使用 PowerShell 运行以下命令<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Get-AppxPackage</span> *notepad* | <span class="built_in">Remove-AppxPackage</span></span><br></pre></td></tr></table></figure>
执行完成之后再次用记事本打开文件，得到的目录就在<code>C:\Windows\System32</code>下了，任务管理器里记事本图标会变，记事本状态栏位置也会提示升级。<br><img data-src="https://qiniucdn.wayneshao.com/Windows11%E7%B3%BB%E7%BB%9F%E4%B8%8B%E5%8A%AB%E6%8C%81notepad.exe%E7%9A%84%E6%96%B9%E6%B3%95/20210706034715419.png"><h2 id="劫持镜像"><a href="#劫持镜像" class="headerlink" title="劫持镜像"></a>劫持镜像</h2>先下载待替换的软件，比如我上面列出来的 notepad2 到合适的目录，然后按照老方法做镜像劫持，如果使用我推荐的 notepad2 版本可以直接在设置里进行操作。脚本中的路径可以根据实际情况自行调整。<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">reg add &quot;HKLM\Software\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\notepad.exe&quot; /v &quot;Debugger&quot; /t REG_SZ /d &quot;D:\ProgramData\Notepad2\Notepad2.exe /u /l /z&quot; /f</span><br></pre></td></tr></table></figure>
<h2 id="关闭-UseFilter-开关"><a href="#关闭-UseFilter-开关" class="headerlink" title="关闭 UseFilter 开关"></a>关闭 UseFilter 开关</h2><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">reg add &quot;HKLM\Software\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\notepad.exe&quot; /v &quot;UseFilter&quot; /t REG_DWORD /d <span class="number">0</span> /f</span><br></pre></td></tr></table></figure>
<h2 id="原因分析（推测）"><a href="#原因分析（推测）" class="headerlink" title="原因分析（推测）"></a>原因分析（推测）</h2>根据具体细节推测如下：</li>
</ul>
<ol>
<li>Windows 在运行 UWP 程序的时候，跟传统 win32 程序略有不同，会有检查更新的逻辑，如果新版本存在，根本不会触发镜像劫持。</li>
<li>UseFilter 为 1 时，会触发子目录中的 FilterFullPath 相关的逻辑，导致替换不成功，所以需要关掉。<br><img data-src="https://qiniucdn.wayneshao.com/Windows11%E7%B3%BB%E7%BB%9F%E4%B8%8B%E5%8A%AB%E6%8C%81notepad.exe%E7%9A%84%E6%96%B9%E6%B3%95/20210706040826216.png"></li>
</ol>
]]></content>
      <categories>
        <category>踩坑笔记</category>
      </categories>
      <tags>
        <tag>软件心得</tag>
        <tag>notepad</tag>
        <tag>替换记事本</tag>
      </tags>
  </entry>
  <entry>
    <title>bash脚本错误 Syntax error: else unexpected (expecting then)解决</title>
    <url>/posts/15091.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>今天在使用 bash 脚本发布程序时，发生了这样的错误</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">xxx.sh: Syntax error: <span class="string">&quot;else&quot;</span> unexpected (expecting <span class="string">&quot;then&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>到处搜索资料尝试无果之后想到会不会是编码问题导致，<br>dos2unix 处理后测试果然可以</p>
<span id="more"></span>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt-get -y install dos2unix</span><br></pre></td></tr></table></figure>
<p>处理</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">dos2unix xxx.sh</span><br><span class="line">dos2unix: converting file xxx.sh to Unix format ...</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>踩坑笔记</category>
      </categories>
      <tags>
        <tag>踩坑</tag>
        <tag>编码</tag>
        <tag>dos2unix</tag>
      </tags>
  </entry>
  <entry>
    <title>var str = new string(string)问题</title>
    <url>/posts/22967.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>前几日，广州群有小伙伴遇到了这样一道面试题<br><img data-src="https://qiniucdn.wayneshao.com/20191023021342980.png"></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> s = <span class="keyword">new</span> <span class="built_in">string</span>(<span class="string">&quot;abc&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>关于以上语句到底创建了几个对象呢？由于印象里这种使用 string 来初始化 string 的操作并不常见，推测以下，应该是类似于 copy 的操作产生一个新的对象，所以我先盲猜，不考虑有上下文，只针对这一句语句，应该是2个。</p>
<p>下面来试验：</p>
<span id="more"></span>
<h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><ol>
<li>string 属于引用类型，所以我们把单个 string 定义为堆中的对象，两个或多个引用类型变量引用同一个对象时，依然认为只有一个对象。</li>
</ol>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><h3 id="文档分析"><a href="#文档分析" class="headerlink" title="文档分析"></a>文档分析</h3><p>　　首先，事实证明了不是我对 string 了解太少，而是被公司从策划 diss 了几次的升级计划导致我常用的 .NET Core 版本一直是 1.1 ，而用 string 初始化 string 的用法只有在 .NET Core 2.1 及以上版本才有，确切的说，只有 .NET Core 2.1、.NET Core 2.2、.NET Core 3.0 三个版本才有，以上结论来自官方文档并经过实际测试，文档如下：<br><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vZW4tdXMvZG90bmV0L2FwaS9zeXN0ZW0uc3RyaW5nLi1jdG9yP3ZpZXc9bmV0Y29yZS0yLjAjU3lzdGVtX1N0cmluZ19fY3Rvcl9TeXN0ZW1fUmVhZE9ubHlTcGFuX1N5c3RlbV9DaGFyX18=">** .NET Core 2.0 String Constructors**<i class="fa fa-external-link-alt"></i></span><br><img data-src="https://qiniucdn.wayneshao.com/new_string%E9%97%AE%E9%A2%98/20191023023611480.png"></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vZW4tdXMvZG90bmV0L2FwaS9zeXN0ZW0uc3RyaW5nLi1jdG9yP3ZpZXc9bmV0Y29yZS0yLjEjU3lzdGVtX1N0cmluZ19fY3Rvcl9TeXN0ZW1fUmVhZE9ubHlTcGFuX1N5c3RlbV9DaGFyX18=">** .NET Core 2.1 String Constructors**<i class="fa fa-external-link-alt"></i></span><br><img data-src="https://qiniucdn.wayneshao.com/new_string%E9%97%AE%E9%A2%98/20191023023640662.png"></p>
<p>由官方文档可知，.NET Core 从 2.0 升级为 2.1 时，增加了一个构造函数<a href="https://docs.microsoft.com/en-us/dotnet/api/system.string.-ctor?view=netcore-2.1#System_String__ctor_System_ReadOnlySpan_System_Char__"><code>String(ReadOnlySpan&lt;Char&gt;)</code></a><br><img data-src="https://qiniucdn.wayneshao.com/new_string%E9%97%AE%E9%A2%98/20191023024029871.png"><br>题目中的 new(“qqq”)使用的正式这一构造函数，入参为 <a href="https://docs.microsoft.com/en-us/dotnet/api/system.readonlyspan-1?view=netcore-2.1"><code>ReadOnlySpan&lt;Char&gt;</code>结构体泛型</a>，而这一类型也正是从 .NET Core 2.1 版本才新引入的。</p>
<p>故，<strong>这一题目在 <code>.NET Core 2.1</code> - <code>.NET Core 3.0</code> 版本成立，其余.NET 版本中均无法编译通过</strong>。</p>
<h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><p>下面开始直接代码寻找答案，<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2RvdG5ldC9jb3JlY2xyL2Jsb2IvbWFzdGVyL3NyYy9TeXN0ZW0uUHJpdmF0ZS5Db3JlTGliL3NoYXJlZC9TeXN0ZW0vU3RyaW5nLmNz">查看 String.cs 源码<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line">[<span class="meta">MethodImpl(MethodImplOptions.InternalCall)</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">extern</span> <span class="title">String</span>(<span class="params">ReadOnlySpan&lt;<span class="built_in">char</span>&gt; <span class="keyword">value</span></span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !CORECLR</span></span><br><span class="line"><span class="keyword">static</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">unsafe</span> <span class="built_in">string</span> <span class="title">Ctor</span>(<span class="params">ReadOnlySpan&lt;<span class="built_in">char</span>&gt; <span class="keyword">value</span></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">value</span>.Length == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> Empty;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">string</span> result = FastAllocateString(<span class="keyword">value</span>.Length);</span><br><span class="line">    Buffer.Memmove(<span class="keyword">ref</span> result._firstChar, <span class="keyword">ref</span> MemoryMarshal.GetReference(<span class="keyword">value</span>), (<span class="built_in">uint</span>)<span class="keyword">value</span>.Length);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">[<span class="meta">MethodImpl(MethodImplOptions.AggressiveInlining)</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">implicit</span> <span class="keyword">operator</span> <span class="title">ReadOnlySpan</span>&lt;<span class="title">char</span>&gt;(<span class="params"><span class="built_in">string</span>? <span class="keyword">value</span></span>)</span> =&gt;</span><br><span class="line">    <span class="keyword">value</span> != <span class="literal">null</span> ? <span class="keyword">new</span> ReadOnlySpan&lt;<span class="built_in">char</span>&gt;(<span class="keyword">ref</span> <span class="keyword">value</span>.GetRawStringData(), <span class="keyword">value</span>.Length) : <span class="literal">default</span>;</span><br></pre></td></tr></table></figure>
<p>由官方源码可知，当入参为 string 时，首先会调用隐式转换方法将入参转换为<code>ReadOnlySpan&lt;char&gt;</code>类型，而后再使用转换后的值调用构造函数<code>String(ReadOnlySpan&lt;char&gt; value)</code>，构造函数中，重新分配了新的内存空间给新字符串，将入参的值 Copy 到新字符串后返回，<strong>所以该构造函数会产生一个全新的字符串值</strong>。</p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><h3 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a>测试代码</h3><p>以下是试验代码：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.InteropServices;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ConsoleApp1</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">string</span> str0 = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">var</span> str1 = <span class="keyword">new</span> <span class="built_in">string</span>(<span class="string">&quot;123&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> str2 = <span class="string">&quot;123&quot;</span>;</span><br><span class="line">            <span class="keyword">var</span> str3 = str2;</span><br><span class="line">            <span class="keyword">var</span> str4 = <span class="string">&quot;123&quot;</span>;</span><br><span class="line">            Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;GetMemoryAddress(str0)&#125;</span> - <span class="subst">&#123;GetMemoryAddress(str1)&#125;</span> - <span class="subst">&#123;GetMemoryAddress(str2)&#125;</span> - <span class="subst">&#123;GetMemoryAddress(str3)&#125;</span> - <span class="subst">&#123;GetMemoryAddress(str4)&#125;</span>&quot;</span>);</span><br><span class="line">            Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;<span class="built_in">object</span>.ReferenceEquals(str0,str1)&#125;</span> - <span class="subst">&#123;<span class="built_in">object</span>.ReferenceEquals(str1,str2)&#125;</span> - <span class="subst">&#123;<span class="built_in">object</span>.ReferenceEquals(str2,str3)&#125;</span> - <span class="subst">&#123;<span class="built_in">object</span>.ReferenceEquals(str3,str4)&#125;</span>&quot;</span>);</span><br><span class="line">            Console.ReadKey();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">GetMemoryAddress</span>(<span class="params"><span class="built_in">object</span> o</span>)</span></span><br><span class="line">            =&gt;</span><br><span class="line">                <span class="string">$&quot;0x<span class="subst">&#123;GCHandle.Alloc(o, GCHandleType.Pinned).AddrOfPinnedObject().ToString(<span class="string">&quot;X&quot;</span>)&#125;</span>&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>输出结果为：<br><img data-src="https://qiniucdn.wayneshao.com/new_string%E9%97%AE%E9%A2%98/20191023032318413.png"></p>
<h3 id="IL代码"><a href="#IL代码" class="headerlink" title="IL代码"></a>IL代码</h3><p><img data-src="https://qiniucdn.wayneshao.com/new_string%E9%97%AE%E9%A2%98/20191023031520047.png"><br>由 IL 代码可知，的确是先调用了隐式转换函数，而后再使用转换后的值调用构造函数<code>String(ReadOnlySpan&lt;char&gt; value)</code>。</p>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><ol>
<li>这一题目在 <code>.NET Core 2.1</code> - <code>.NET Core 3.0</code> 版本成立，其余.NET 版本中均无法编译通过。</li>
<li>如果传入的字符串已在字符串常量池中，那么该语句只会产生一个新的 string 对象。</li>
<li>如果传入的字符串未在字符串常量池中，那么该语句会产生两个新的string对象。</li>
</ol>
]]></content>
      <categories>
        <category>面试笔记</category>
      </categories>
      <tags>
        <tag>string</tag>
        <tag>面试</tag>
      </tags>
  </entry>
  <entry>
    <title>redhat7.3配置163 yum源</title>
    <url>/posts/12206.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>redhat 的更新包只对注册的用户生效，所以我们需要自己手动更改成CentOS 的更新包，CentOS几乎和redhat是一样的，所以无需担心软件包是否可安装，安装之后是否有问题。</p>
<span id="more"></span>
<h2 id="删除redhat原有的yum"><a href="#删除redhat原有的yum" class="headerlink" title="删除redhat原有的yum"></a>删除redhat原有的yum</h2><p>首先删除redhat原有的yum ，因为redhat 原本的yum 没有注册为redhat用户是用不了的。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">rpm -aq|grep yum|xargs rpm -e --nodeps </span><br><span class="line">rpm -aq|grep python-iniparse|xargs rpm -e --nodeps</span><br></pre></td></tr></table></figure>
<h2 id="下载163的yum-安装包"><a href="#下载163的yum-安装包" class="headerlink" title="下载163的yum 安装包"></a>下载163的yum 安装包</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">wget http://mirrors.163.com/centos/7.3.1611/os/x86_64/Packages/yum-3.4.3-150.el7.centos.noarch.rpm</span><br><span class="line">wget http://mirrors.163.com/centos/7.3.1611/os/x86_64/Packages/python-iniparse-0.4-9.el7.noarch.rpm</span><br><span class="line">wget http://mirrors.163.com/centos/7.3.1611/os/x86_64/Packages/yum-metadata-parser-1.1.4-10.el7.x86_64.rpm</span><br><span class="line">wget http://mirrors.163.com/centos/7.3.1611/os/x86_64/Packages/yum-plugin-fastestmirror-1.1.31-40.el7.noarch.rpm</span><br></pre></td></tr></table></figure>
<h3 id="安装下载的rpm包"><a href="#安装下载的rpm包" class="headerlink" title="安装下载的rpm包"></a>安装下载的rpm包</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">rpm -ivh *.rpm</span><br></pre></td></tr></table></figure>
<h3 id="创建文件-etc-yum-repos-d-rhel-debuginfo-repo并写入"><a href="#创建文件-etc-yum-repos-d-rhel-debuginfo-repo并写入" class="headerlink" title="创建文件/etc/yum.repos.d/rhel-debuginfo.repo并写入"></a>创建文件/etc/yum.repos.d/rhel-debuginfo.repo并写入</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[base]</span><br><span class="line">name=CentOS-$releasever - Base</span><br><span class="line">baseurl=http://mirrors.163.com/centos/7.3.1611/os/$basearch/</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=http://mirrors.163.com/centos/7.3.1611/os/x86_64/RPM-GPG-KEY-CentOS-7</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">#released updates</span><br><span class="line">[updates]</span><br><span class="line">name=CentOS-$releasever - Updates</span><br><span class="line">baseurl=http://mirrors.163.com/centos/7.3.1611/updates/$basearch/</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=http://mirrors.163.com/centos/7.3.1611/os/x86_64/RPM-GPG-KEY-CentOS-7</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">[extras]</span><br><span class="line">name=CentOS-$releasever - Extras</span><br><span class="line">baseurl=http://mirrors.163.com/centos/7.3.1611/extras//$basearch/</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=http://mirrors.163.com/centos/7.3.1611/os/x86_64/RPM-GPG-KEY-CentOS-7</span><br><span class="line"> </span><br><span class="line">[centosplus]</span><br><span class="line">name=CentOS-$releasever - Plus</span><br><span class="line">baseurl=http://mirrors.163.com/centos/7.3.1611/centosplus//$basearch/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=0</span><br></pre></td></tr></table></figure>
<h3 id="yum-clean-all"><a href="#yum-clean-all" class="headerlink" title="yum clean all"></a>yum clean all</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum clean all</span><br></pre></td></tr></table></figure>
<h3 id="yum-update-测试。"><a href="#yum-update-测试。" class="headerlink" title="yum update 测试。"></a>yum update 测试。</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum update</span><br></pre></td></tr></table></figure>
<h3 id="安装-epel-源"><a href="#安装-epel-源" class="headerlink" title="安装 epel 源"></a>安装 epel 源</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum install epel-release</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>踩坑笔记</category>
      </categories>
      <tags>
        <tag>redhat</tag>
        <tag>yum源</tag>
      </tags>
  </entry>
  <entry>
    <title>【51NOD刷题】1284 2 3 5 7的倍数</title>
    <url>/posts/41184.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p><span class="exturl" data-url="aHR0cDovL3d3dy41MW5vZC5jb20vb25saW5lSnVkZ2UvcXVlc3Rpb25Db2RlLmh0bWwjIXByb2JsZW1JZD0xMjg0">**1284 2 3 5 7的倍数  **<i class="fa fa-external-link-alt"></i></span><br>基准时间限制：1 秒 空间限制：131072 KB 分值: 5 难度：1级算法题</p>
<p>给出一个数N，求1至N中，有多少个数不是2 3 5 7的倍数。 例如N = 10，只有1不是2 3 5 7的倍数。</p>
<span id="more"></span>
<h2 id="输入输出"><a href="#输入输出" class="headerlink" title="输入输出"></a>输入输出</h2><p><strong>Input</strong><br>输入1个数N(1 &lt;= N &lt;= 10^18)。<br><strong>Output</strong><br>输出不是2 3 5 7的倍数的数共有多少。<br><strong>Input示例</strong></p>
<blockquote>
<p>10</p>
</blockquote>
<p><strong>Output示例</strong></p>
<blockquote>
<p>1</p>
</blockquote>
<h2 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h2><p>求取1到数字N之间共有多少个数不是2 3 5 7的倍数，只需要求取1到2 3 5 7的最小公倍数210之间不是的个数48，然后再求出1到N / 210之间不是的个数mCount，即可得出最终结果N / 210 * 48 + mCount。</p>
<h2 id="Accepted"><a href="#Accepted" class="headerlink" title="Accepted"></a>Accepted</h2><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Sum</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> input = Convert.ToInt64(Console.ReadLine());</span><br><span class="line">        <span class="keyword">var</span> m = input % <span class="number">210</span>;</span><br><span class="line">        <span class="keyword">var</span> mCount = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (m &gt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">1</span>; i &lt;= m; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (i % <span class="number">2</span> == <span class="number">0</span> || i % <span class="number">3</span> == <span class="number">0</span> || i % <span class="number">5</span> == <span class="number">0</span> || i % <span class="number">7</span> == <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                mCount++;</span><br><span class="line">            &#125;</span><br><span class="line">        Console.WriteLine(input / <span class="number">210</span> * <span class="number">48</span> + mCount);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>算法刷题</category>
      </categories>
      <tags>
        <tag>51NOD</tag>
        <tag>刷题</tag>
        <tag>C#</tag>
      </tags>
  </entry>
  <entry>
    <title>【51NOD刷题】1182 完美字符串</title>
    <url>/posts/52125.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p><span class="exturl" data-url="aHR0cDovL3d3dy41MW5vZC5jb20vb25saW5lSnVkZ2UvcXVlc3Rpb25Db2RlLmh0bWwjIXByb2JsZW1JZD0xMTgy">**1182 完美字符串  **<i class="fa fa-external-link-alt"></i></span><br>题目来源： Facebook Hacker Cup选拔<br>基准时间限制：1 秒 空间限制：131072 KB 分值: 5 难度：1级算法题</p>
<p>约翰认为字符串的完美度等于它里面所有字母的完美度之和。每个字母的完美度可以由你来分配，不同字母的完美度不同，分别对应一个1-26之间的整数。<br>约翰不在乎字母大小写。（也就是说字母F和f）的完美度相同。给定一个字符串，输出它的最大可能的完美度。例如：dad，你可以将26分配给d，25分配给a，这样整个字符串完美度为77。</p>
<span id="more"></span>
<h2 id="输入输出"><a href="#输入输出" class="headerlink" title="输入输出"></a>输入输出</h2><p><strong>Input</strong><br>输入一个字符串S(S的长度 &lt;= 10000)，S中没有除字母外的其他字符。</p>
<p><strong>Output</strong><br>由你将1-26分配给不同的字母，使得字符串S的完美度最大，输出这个完美度。</p>
<p><strong>Input示例</strong></p>
<blockquote>
<p>dad</p>
</blockquote>
<p><strong>Output示例</strong></p>
<blockquote>
<p>77</p>
</blockquote>
<h2 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h2><p>这道题很简单，可以自主赋予权值，则吧字符串中每个字母出现的次数统计出来，再按照次数降序排序，从第一个元素开始到次数不为0的最后一个元素n分别讲数量乘以26-n+1，之后将所有运算结果相加即为最终结果。</p>
<h2 id="Accepted"><a href="#Accepted" class="headerlink" title="Accepted"></a>Accepted</h2><p>```csharp<br>using System;<br>using System.Collections.Generic;<br>using System.Linq;</p>
<p>public class Sum<br>{<br>    public static void Main()<br>    {<br>        var str = Console.ReadLine();<br>        var countDic = new Dictionary&lt;char, int&gt;();</p>
<pre><code>    foreach (var c in str.ToCharArray())
        if (countDic.ContainsKey(c))
            countDic[c]++;
        else
            countDic.Add(c, 1);

    var countE = countDic.Where(i =&gt; i.Key &gt; 0).Select(i =&gt; i.Value).OrderByDescending(i =&gt; i).ToArray();

    var s = 0;
    for (var i = 0; i &lt; countE.Count(); i++)
        s += countE[i] * (26 - i);

    Console.WriteLine(s);
&#125;
</code></pre>
<p>}<br>```<img data-src="undefined"></p>
]]></content>
      <categories>
        <category>算法刷题</category>
      </categories>
      <tags>
        <tag>51NOD</tag>
        <tag>刷题</tag>
        <tag>C#</tag>
      </tags>
  </entry>
  <entry>
    <title>【51NOD刷题】1289 大鱼吃小鱼</title>
    <url>/posts/28398.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p><span class="exturl" data-url="aHR0cDovL3d3dy41MW5vZC5jb20vb25saW5lSnVkZ2UvcXVlc3Rpb25Db2RlLmh0bWwjIXByb2JsZW1JZD0xMjg5">**1289 大鱼吃小鱼  **<i class="fa fa-external-link-alt"></i></span><br>题目来源： <span class="exturl" data-url="aHR0cHM6Ly9jb2RpbGl0eS5jb20v">Codility<i class="fa fa-external-link-alt"></i></span><br>基准时间限制：1 秒 空间限制：131072 KB 分值: 5 难度：1级算法题<br>有N条鱼每条鱼的位置及大小均不同，他们沿着X轴游动，有的向左，有的向右。游动的速度是一样的，两条鱼相遇大鱼会吃掉小鱼。从左到右给出每条鱼的大小和游动的方向（0表示向左，1表示向右）。问足够长的时间之后，能剩下多少条鱼？</p>
<span id="more"></span>
<h2 id="输入输出"><a href="#输入输出" class="headerlink" title="输入输出"></a>输入输出</h2><p><strong>Input</strong><br>第1行：1个数N，表示鱼的数量(1 &lt;= N &lt;= 100000)。<br>第2 - N + 1行：每行两个数A[i], B[i]，中间用空格分隔，分别表示鱼的大小及游动的方向(1 &lt;= A[i] &lt;= 10^9，B[i] = 0 或 1，0表示向左，1表示向右）。<br><strong>Output</strong><br>输出1个数，表示最终剩下的鱼的数量。<br><strong>Input示例</strong></p>
<blockquote>
<p>5<br>4 0<br>3 1<br>2 0<br>1 0<br>5 0</p>
</blockquote>
<p><strong>Output示例</strong></p>
<blockquote>
<p>2</p>
</blockquote>
<h2 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h2><p>本题目确切来讲有点不太严谨，比如每条鱼的起始位置、相同大小的鱼相遇后的情况就并未提供，这两个条件也会影响最终的结果。</p>
<p>我们按照从左到右依次摆放所有鱼、两条相同的鱼相遇后只会有一条胜出来计算，则可以使用Stack完美的解决这个问题。如果鱼向右走则入栈，如果鱼向左走则循环判断它和栈顶元素的大小关系，若比栈顶元素大，则移除元素继续循环，如果栈内无元素则记录左鱼幸存条数++并跳出循环，如果比栈顶元素小则直接跳出循环。最终统计栈内元素个数和左鱼幸存条数的和即为最终幸存的鱼的数量。</p>
<h2 id="Accepted"><a href="#Accepted" class="headerlink" title="Accepted"></a>Accepted</h2><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Sum</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> sr = <span class="keyword">new</span> StreamReader(Console.OpenStandardInput());</span><br><span class="line">        <span class="keyword">var</span> sw = <span class="keyword">new</span> StreamWriter(Console.OpenStandardOutput());</span><br><span class="line">        <span class="keyword">var</span> count = Convert.ToInt32(sr.ReadLine());</span><br><span class="line">        <span class="keyword">var</span> leftFishs = <span class="keyword">new</span> Stack&lt;<span class="built_in">long</span>&gt;();</span><br><span class="line">        <span class="keyword">var</span> left = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; count; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> input = sr.ReadLine().Split(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">            <span class="keyword">var</span> dx = Convert.ToInt64(input[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">var</span> fx = Convert.ToInt32(input[<span class="number">1</span>]);</span><br><span class="line">            <span class="keyword">if</span> (fx == <span class="number">1</span>)</span><br><span class="line">                leftFishs.Push(dx);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">                    <span class="keyword">if</span> (leftFishs.Count &gt; <span class="number">0</span> &amp;&amp; leftFishs.Peek() &lt;= dx)</span><br><span class="line">                        leftFishs.Pop();</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">if</span> (leftFishs.Count == <span class="number">0</span>)</span><br><span class="line">                            left++;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        sw.WriteLine(leftFishs.Count + left);</span><br><span class="line">        sw.Flush();</span><br><span class="line">        sr.Close();</span><br><span class="line">        sw.Close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>算法刷题</category>
      </categories>
      <tags>
        <tag>51NOD</tag>
        <tag>刷题</tag>
        <tag>C#</tag>
      </tags>
  </entry>
  <entry>
    <title>【51NOD刷题】1305 Pairwise Sum and Divide</title>
    <url>/posts/34469.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p><span class="exturl" data-url="aHR0cDovL3d3dy41MW5vZC5jb20vb25saW5lSnVkZ2UvcXVlc3Rpb25Db2RlLmh0bWwjIXByb2JsZW1JZD0xMzA1">**1305 Pairwise Sum and Divide  **<i class="fa fa-external-link-alt"></i></span></p>
<p>题目来源： HackerRank<br>基准时间限制：1 秒&#8195;空间限制：131072 KB&#8195;分值: 5&#8195;难度：1级算法题</p>
<p>有这样一段程序，fun会对整数数组A进行求值，其中Floor表示向下取整：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">fun(A)</span><br><span class="line">    <span class="built_in">sum</span> = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i = <span class="number">1</span> to A.length</span><br><span class="line">        <span class="keyword">for</span> j = i+<span class="number">1</span> to A.length</span><br><span class="line">            <span class="built_in">sum</span> = <span class="built_in">sum</span> + Floor((A[i]+A[j])/(A[i]*A[j])) </span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">sum</span></span><br></pre></td></tr></table></figure>
<p>给出数组A，由你来计算fun(A)的结果。例如：A = {1, 4, 1}，fun(A) = [5/4] + [2/1] + [5/4] = 1 + 2 + 1 = 4。</p>
<span id="more"></span>
<h2 id="输入输出"><a href="#输入输出" class="headerlink" title="输入输出"></a>输入输出</h2><p><strong>Input</strong><br>第1行：1个数N，表示数组A的长度(1 &lt;= N &lt;= 100000)。<br>第2 - N + 1行：每行1个数A[i]（1 &lt;= A[i] &lt;= 10^9)。<br><strong>Output</strong><br>输出fun(A)的计算结果。<br><strong>Input示例</strong></p>
<blockquote>
<p>3<br>1<br>4<br>1</p>
</blockquote>
<p><strong>Output示例</strong></p>
<blockquote>
<p>4</p>
</blockquote>
<h2 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h2><p>因为题目给出的已经是近乎伪代码了，所以初始很容易直接按照程序中给出的逻辑来提交，然而可能是C#的效率问题，差不多一般的测试都超时了，下面是第一版的代码：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Sum</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> sr = <span class="keyword">new</span> StreamReader(Console.OpenStandardInput());</span><br><span class="line">        <span class="keyword">var</span> sw = <span class="keyword">new</span> StreamWriter(Console.OpenStandardOutput());</span><br><span class="line">        <span class="keyword">var</span> count = Convert.ToInt32(sr.ReadLine());</span><br><span class="line">        <span class="keyword">var</span> sum = <span class="number">0L</span>;</span><br><span class="line">        <span class="keyword">var</span> list = <span class="keyword">new</span> <span class="built_in">long</span>[count];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; count; i++)</span><br><span class="line">            list[i] = Convert.ToInt64(sr.ReadLine());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; count; i++)</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> j = i + <span class="number">1</span>; j &lt; count; j++)</span><br><span class="line">                sum += (list[i] + list[j]) / (list[i] * list[j]);</span><br><span class="line">        sw.WriteLine(sum);</span><br><span class="line">        sw.Flush();</span><br><span class="line">        sr.Close();</span><br><span class="line">        sw.Close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个时候返回来分析题目，100,000次输入操作，之后双层循环差不多10,000,000,000次循环内操作，C#在1.5s内确实不大可能完的成，只能从题目入手重新分析了。</p>
<p>题目总的来分析就是每个数和集合中的所有其他数做一次和除以积取整的操作后的和。</p>
<p>仔细考虑后不难发现，其实所有的数里只有1和2是可以做有效贡献的，其他数做上述运算一定是0，所以其实只需要统计1和2的数量即可。<br>其中，1和1的运算结果为2，1和其他数的计算结果是1，2和2的计算结果是1。设一个长度为n的集合里，1的个数为a，2的个数为b，则这个集合的运算结果公式为：</p>
<p>$C_a^2+a(n-a)+C_b^2$</p>
<p>化简可得：</p>
<p>$a(a-1)+a(n-a)+\frac{1}{2}(b*(b-1))$</p>
<p>PS.因为每个数的范围最大可达$10^9$，所以我们使用64位的long类型来接收和运算。</p>
<h2 id="Accepted"><a href="#Accepted" class="headerlink" title="Accepted"></a>Accepted</h2><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Sum</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> sr = <span class="keyword">new</span> StreamReader(Console.OpenStandardInput());</span><br><span class="line">        <span class="keyword">var</span> sw = <span class="keyword">new</span> StreamWriter(Console.OpenStandardOutput());</span><br><span class="line">        <span class="keyword">var</span> count = Convert.ToInt32(sr.ReadLine());</span><br><span class="line">        <span class="keyword">var</span> sum = <span class="number">0L</span>;</span><br><span class="line">        <span class="keyword">var</span> a = <span class="number">0L</span>;</span><br><span class="line">        <span class="keyword">var</span> b = <span class="number">0L</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; count; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> s = Convert.ToInt64(sr.ReadLine());</span><br><span class="line">            <span class="keyword">switch</span> (s)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                    a++;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                    b++;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        sum = a * (a - <span class="number">1</span>) + a * (count - a) + (b * (b - <span class="number">1</span>) / <span class="number">2</span>);</span><br><span class="line">        sw.WriteLine(sum);</span><br><span class="line">        Console.ReadLine();</span><br><span class="line">        sw.Flush();</span><br><span class="line">        sr.Close();</span><br><span class="line">        sw.Close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>算法刷题</category>
      </categories>
      <tags>
        <tag>51NOD</tag>
        <tag>刷题</tag>
        <tag>C#</tag>
      </tags>
  </entry>
  <entry>
    <title>【51NOD刷题】1344 走格子</title>
    <url>/posts/16190.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p><a href="http://www.51nod.com/onlineJudge/questionCode.html#!problemId=1344"><strong>1344 走格子</strong></a></p>
<p>基准时间限制：1 秒&#8195;空间限制：131072 KB&#8195;分值: 5&#8195;难度：1级算法题</p>
<p>有编号1-n的n个格子，机器人从1号格子顺序向后走，一直走到n号格子，并需要从n号格子走出去。机器人有一个初始能量，每个格子对应一个整数A[i]，表示这个格子的能量值。如果A[i] &gt; 0，机器人走到这个格子能够获取A[i]个能量，如果A[i] &lt; 0，走到这个格子需要消耗相应的能量，如果机器人的能量 &lt; 0，就无法继续前进了。问机器人最少需要有多少初始能量，才能完成整个旅程。</p>
<p>例如：n = 5。{1，-2，-1，3，4} 最少需要2个初始能量，才能从1号走到5号格子。途中的能量变化如下3 1 0 3 7。</p>
<span id="more"></span>
<h2 id="输入输出"><a href="#输入输出" class="headerlink" title="输入输出"></a>输入输出</h2><p><strong>Input</strong><br>第1行：1个数n，表示格子的数量。(1 &lt;= n &lt;= 50000)<br>第2 - n + 1行：每行1个数A[i]，表示格子里的能量值(-1000000000 &lt;= A[i] &lt;= 1000000000)<br><strong>Output</strong><br>输出1个数，对应从1走到n最少需要多少初始能量。<br><strong>Input示例</strong></p>
<blockquote>
<p>5<br>1<br>-2<br>-1<br>3<br>4</p>
</blockquote>
<p><strong>Output示例</strong></p>
<blockquote>
<p>2</p>
</blockquote>
<h2 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h2><p>这道题的主要问题主要是需要考虑到精度问题，格子数最多为50,000，每个格子能量范围为 -1,000,000,000 &lt;= NL &lt;= 1,000,000,000，总能量范围则为 -50,000,000,000,000 &lt;= MaxNL &lt;= 50,000,000,000,000，超出了Int32类型的范围-2147483648 &lt;= Int32 &lt;= 2147483647。需要使用Int64类型。</p>
<h2 id="Accepted"><a href="#Accepted" class="headerlink" title="Accepted"></a>Accepted</h2><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Sum</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> count = Convert.ToInt64(Console.ReadLine());</span><br><span class="line">        <span class="keyword">var</span> nl = <span class="number">0L</span>;</span><br><span class="line">        <span class="keyword">var</span> zxnl = <span class="number">0L</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; count; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            nl += Convert.ToInt64(Console.ReadLine());</span><br><span class="line">            zxnl = nl &lt; zxnl ? nl : zxnl;</span><br><span class="line">        &#125;</span><br><span class="line">        Console.WriteLine(zxnl &gt; <span class="number">0</span> ? <span class="number">0</span> : <span class="number">0</span> - zxnl);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>算法刷题</category>
      </categories>
      <tags>
        <tag>51NOD</tag>
        <tag>刷题</tag>
        <tag>C#</tag>
        <tag>贪心算法</tag>
      </tags>
  </entry>
  <entry>
    <title>【51NOD刷题】1347 旋转字符串</title>
    <url>/posts/40433.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p><a href="http://www.51nod.com/onlineJudge/questionCode.html#!problemId=1347"><strong>1347 旋转字符串</strong></a></p>
<p>基准时间限制：1 秒&#8195;空间限制：131072 KB&#8195;分值: 5&#8195;难度：1级算法题</p>
<p>S[0…n-1]是一个长度为n的字符串，定义旋转函数Left(S)=S[1…n-1]+S[0].比如S=”abcd”,Left(S)=”bcda”.一个串是对串当且仅当这个串长度为偶数，前半段和后半段一样。比如”abcabc”是对串,”aabbcc”则不是。<br>现在问题是给定一个字符串，判断他是否可以由一个对串旋转任意次得到。</p>
<span id="more"></span>
<h2 id="输入输出"><a href="#输入输出" class="headerlink" title="输入输出"></a>输入输出</h2><p><strong>Input</strong><br>第1行：给出一个字符串（字符串非空串，只包含小写字母，长度不超过1000000）<br><strong>Output</strong><br>对于每个测试用例，输出结果占一行，如果能，输出YES，否则输出NO。<br><strong>Input示例</strong></p>
<blockquote>
<p>aa<br>ab</p>
</blockquote>
<p><strong>Output示例</strong></p>
<blockquote>
<p>YES<br>NO</p>
</blockquote>
<p>C#的运行时限为：1500 ms ，空间限制为：196608 KB</p>
<h2 id="题目解析"><a href="#题目解析" class="headerlink" title="题目解析"></a>题目解析</h2><p>从旋转函数定义来看，将字符串第一个字符移动到字符串的末尾，很容易想当然的以为需要进行Length-1次循环判断完所有旋转后的结果。<br>题目中输入字符串长度最多为1,000,000，最多需要500,000次判断才能得出该字符串是否为对串，如果进行Length-1次循环，那计算次数最多会达到500,000,000,000，结果必然是超时。</p>
<p>而实际上，当一个字符串是对串（即前半段和后半段完全相同的字符串）时，它无论经过多少次旋转都依然还是对串，所以只需要对输入字符串进行一次判断即可。</p>
<h2 id="Accepted"><a href="#Accepted" class="headerlink" title="Accepted"></a>Accepted</h2><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Sum</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> str = Console.ReadLine();</span><br><span class="line">        <span class="keyword">if</span> (str.Length % <span class="number">2</span> != <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;NO&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> strQueue = str.ToCharArray();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; strQueue.Length / <span class="number">2</span>; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (strQueue[j] == strQueue[strQueue.Length / <span class="number">2</span> + j]) <span class="keyword">continue</span>;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;NO&quot;</span>); ;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;YES&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>算法刷题</category>
      </categories>
      <tags>
        <tag>51NOD</tag>
        <tag>刷题</tag>
        <tag>C#</tag>
      </tags>
  </entry>
  <entry>
    <title>【MVC学习笔记】1.项目结构搭建及单个类在各个层次中的实现</title>
    <url>/posts/21959.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p> 新人刚开始学习ASP.NET MVC，若有不足之处希望能得到您的指点，不胜感激！</p>
<span id="more"></span>
<h2 id="层级结构"><a href="#层级结构" class="headerlink" title="层级结构"></a>层级结构</h2><p>先来一张项目的层级结构图:<br><img data-src="https://qiniucdn.wayneshao.com/20180218213243/20180218093427987.png"><br> Model：模型层，主要是各种类型、枚举以及ORM框架，框架完成数据库和实体类的映射。项目中选用了微软的开源ORM框架 EntityFramework 6.0 （以下简称EF），数据库则选择了微软的轻量级数据库SQL Server Compact 4.0本地数据库（简称Compact），Compact对EF支持比较完美，又属于文档型数据库，部署起来比较简洁。</p>
<ul>
<li><p><em><strong>DAL</strong></em>：<strong>数据访问层</strong>，主要是对数据库的操作层，为业务逻辑层或表示层提供数据服务。</p>
</li>
<li><p><em><strong>IDAL</strong></em>：<strong>数据访问接口层</strong>，是数据访问层的接口，降低耦合。</p>
</li>
<li><p><em><strong>DALFactory</strong></em>：<strong>数据会话层</strong>，封装了所有数据操作类实例的创建，将数据访问层与业务逻辑层解耦。</p>
</li>
<li><p><em><strong>BLL</strong></em>：<strong>业务逻辑层</strong>，主要负责对数据层的操作，把一些数据层的操作进行组合以完成业务的需要。</p>
</li>
<li><p><em><strong>IBLL</strong></em>：<strong>业务逻辑接口层</strong>，业务逻辑层的接口，降低耦合。</p>
</li>
<li><p><em><strong>WebApp</strong></em>：<strong>表现层</strong>，是一个ASP.NET MVC项目，完成具体网站的实现。</p>
</li>
<li><p><em><strong>Common</strong></em>：<strong>通用层</strong>，用来存放一些工具类。</p>
</li>
</ul>
<p>下面是各个层级之间具体的实现，首先创建以 项目名.层级名 命名的各个层次，除WebApp层为ASP.NET MVC项目外，其余均创建为类库项目。<br><img data-src="https://qiniucdn.wayneshao.com/20180218213243/20180218093803742.png"></p>
<h2 id="各层级搭建"><a href="#各层级搭建" class="headerlink" title="各层级搭建"></a>各层级搭建</h2><h3 id="模型层的构建"><a href="#模型层的构建" class="headerlink" title="模型层的构建"></a>模型层的构建</h3><p>先建立模型层，新建ASP.NET 实体数据模型，关联到已经设计好的数据库，EF自动完成模型类的创建。<br><img data-src="https://qiniucdn.wayneshao.com/20180218213243/20180218093918538.png"></p>
<h3 id="数据访问层的构建"><a href="#数据访问层的构建" class="headerlink" title="数据访问层的构建"></a>数据访问层的构建</h3><p>DAL层中，我们首先需要一个方法来获取单例的EF数据操纵上下文对象，以保证每个用户访问时只有使用一个上下文对象对数据库进行操作。DbContextFactory.cs</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Data.Entity;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.Remoting.Messaging;</span><br><span class="line"><span class="keyword">using</span> PMS.Model;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PMS.DAL</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DbContextFactory</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 负责创建EF数据操作上下文实例,必须保证线程内唯一</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> DbContext <span class="title">CreateContext</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            DbContext dbContext = (DbContext)CallContext.GetData(<span class="string">&quot;dbContext&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (dbContext != <span class="literal">null</span>) <span class="keyword">return</span> dbContext;</span><br><span class="line">            dbContext = <span class="keyword">new</span> PMSEntities();</span><br><span class="line">            CallContext.SetData(<span class="string">&quot;dbContext&quot;</span>, dbContext);</span><br><span class="line">            <span class="keyword">return</span> dbContext;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为User类创建DAL层，实现查询、分页查询、增加、删除和修改这五个基本的方法：UserDAL.cs</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Data.Entity;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> PMS.IDAL;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PMS.DAL</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">UserDal</span> </span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span> DbContext DbEntities = DbContextFactory.CreateContext();</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 查询过滤</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;whereLamada&quot;&gt;</span>过滤条件Lambda表达式<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>实体集合<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">IQueryable</span>&lt;<span class="title">UserDal</span>&gt; <span class="title">LoadEntities</span>(<span class="params">System.Linq.Expressions.Expression&lt;Func&lt;UserDal, <span class="built_in">bool</span>&gt;&gt; whereLamada</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> DbEntities.Set&lt;UserDal&gt;().Where(whereLamada);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 分页查询</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;TS&quot;&gt;</span>排序类型<span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;pageIndex&quot;&gt;</span>查询的页码<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;pageSize&quot;&gt;</span>每页显示的数目<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;totalCount&quot;&gt;</span>符合条件的总行数<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;whereLambda&quot;&gt;</span>过滤条件Lambda表达式<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;orderbyLambda&quot;&gt;</span>排序Lambda表达式<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;isAsc&quot;&gt;</span>排序方向<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>实体集合<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">IQueryable</span>&lt;<span class="title">UserDal</span>&gt; <span class="title">LoadPageEntities</span>&lt;<span class="title">TS</span>&gt;(<span class="params"><span class="built_in">int</span> pageIndex, <span class="built_in">int</span> pageSize, <span class="keyword">out</span> <span class="built_in">int</span> totalCount, System.Linq.Expressions.Expression&lt;Func&lt;UserDal, <span class="built_in">bool</span>&gt;&gt; whereLambda, System.Linq.Expressions.Expression&lt;Func&lt;UserDal, TS&gt;&gt; orderbyLambda, <span class="built_in">bool</span> isAsc</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> temp = DbEntities.Set&lt;UserDal&gt;().Where(whereLambda);</span><br><span class="line">            totalCount = temp.Count();</span><br><span class="line">            temp = isAsc ? temp.OrderBy(orderbyLambda).Skip((pageIndex - <span class="number">1</span>) * pageSize).Take(pageSize) : temp.OrderByDescending(orderbyLambda).Skip((pageIndex - <span class="number">1</span>) * pageSize).Take(pageSize);</span><br><span class="line">            <span class="keyword">return</span> temp;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 删除数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;entity&quot;&gt;</span>待删数据<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>删除结果<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">DeleteEntity</span>(<span class="params">UserDal entity</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            DbEntities.Entry(entity).State = EntityState.Deleted;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 编辑数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;entity&quot;&gt;</span>待编辑数据<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>编辑结果<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">EditEntity</span>(<span class="params">UserDal entity</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            DbEntities.Entry(entity).State = EntityState.Modified;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 添加数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;entity&quot;&gt;</span>待添加数据<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>已添加数据<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> UserDal <span class="title">AddEntity</span>(<span class="params">UserDal entity</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            entity = DbEntities.Set&lt;UserDal&gt;().Add(entity);</span><br><span class="line">            <span class="keyword">return</span> entity;</span><br><span class="line">        &#125;       </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>注</strong>：这里的增删改操作并不即时进行，而是在封装在数据会话层中，以实现工作单元模式，提高数据库的操作效率。</p>
<p>考虑到每个类都需要实现相同的数据操作，我们可以将以上方法封装到一个泛型基类中，各类型只需要继承泛型基类就可以实现以上方法：BaseDal.cs</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Data.Entity;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PMS.DAL</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BaseDal</span>&lt;<span class="title">T</span>&gt; <span class="keyword">where</span> <span class="title">T</span>:<span class="keyword">class</span> ,<span class="title">new</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> DbContext DbEntities = DbContextFactory.CreateContext();</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 查询过滤</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;whereLamada&quot;&gt;</span>过滤条件Lambda表达式<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>实体集合<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">IQueryable</span>&lt;<span class="title">T</span>&gt; <span class="title">LoadEntities</span>(<span class="params">System.Linq.Expressions.Expression&lt;Func&lt;T, <span class="built_in">bool</span>&gt;&gt; whereLamada</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> DbEntities.Set&lt;T&gt;().Where(whereLamada);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 分页查询</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;TS&quot;&gt;</span>排序类型<span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;pageIndex&quot;&gt;</span>查询的页码<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;pageSize&quot;&gt;</span>每页显示的数目<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;totalCount&quot;&gt;</span>符合条件的总行数<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;whereLambda&quot;&gt;</span>过滤条件Lambda表达式<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;orderbyLambda&quot;&gt;</span>排序Lambda表达式<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;isAsc&quot;&gt;</span>排序方向<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>实体集合<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">IQueryable</span>&lt;<span class="title">T</span>&gt; <span class="title">LoadPageEntities</span>&lt;<span class="title">TS</span>&gt;(<span class="params"><span class="built_in">int</span> pageIndex, <span class="built_in">int</span> pageSize, <span class="keyword">out</span> <span class="built_in">int</span> totalCount, System.Linq.Expressions.Expression&lt;Func&lt;T, <span class="built_in">bool</span>&gt;&gt; whereLambda, System.Linq.Expressions.Expression&lt;Func&lt;T, TS&gt;&gt; orderbyLambda, <span class="built_in">bool</span> isAsc</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> temp = DbEntities.Set&lt;T&gt;().Where(whereLambda);</span><br><span class="line">            totalCount = temp.Count();</span><br><span class="line">            temp = isAsc ? temp.OrderBy(orderbyLambda).Skip((pageIndex - <span class="number">1</span>) * pageSize).Take(pageSize) : temp.OrderByDescending(orderbyLambda).Skip((pageIndex - <span class="number">1</span>) * pageSize).Take(pageSize);</span><br><span class="line">            <span class="keyword">return</span> temp;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 删除数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;entity&quot;&gt;</span>待删数据<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>删除结果<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">DeleteEntity</span>(<span class="params">T entity</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            DbEntities.Entry(entity).State = EntityState.Deleted;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 编辑数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;entity&quot;&gt;</span>待编辑数据<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>编辑结果<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">EditEntity</span>(<span class="params">T entity</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            DbEntities.Entry(entity).State = EntityState.Modified;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 添加数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;entity&quot;&gt;</span>待添加数据<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>已添加数据<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> T <span class="title">AddEntity</span>(<span class="params">T entity</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            entity = DbEntities.Set&lt;T&gt;().Add(entity);</span><br><span class="line">            <span class="comment">//DbEntities.SaveChanges();</span></span><br><span class="line">            <span class="keyword">return</span> entity;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>UserDal继承BaseDal</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> PMS.IDAL;</span><br><span class="line"><span class="keyword">using</span> PMS.Model;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PMS.DAL</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">UserDal</span> : <span class="title">BaseDal</span>&lt;<span class="title">User</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="数据访问接口层的构建"><a href="#数据访问接口层的构建" class="headerlink" title="数据访问接口层的构建"></a>数据访问接口层的构建</h3><p>然后我们建立相应的IbaseDal接口和IUserDal接口，并且使UserDal类实现IUserDal接口<br>IBaseDal：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PMS.IDAL</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IBaseDal</span>&lt;<span class="title">T</span>&gt; <span class="keyword">where</span> T:<span class="keyword">class</span>,<span class="keyword">new</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="title">IQueryable</span>&lt;<span class="title">T</span>&gt; <span class="title">LoadEntities</span>(<span class="params">System.Linq.Expressions.Expression&lt;Func&lt;T, <span class="built_in">bool</span>&gt;&gt; whereLamada</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="title">IQueryable</span>&lt;<span class="title">T</span>&gt; <span class="title">LoadPageEntities</span>&lt;<span class="title">s</span>&gt;(<span class="params"><span class="built_in">int</span> pageIndex, <span class="built_in">int</span> pageSize, <span class="keyword">out</span> <span class="built_in">int</span> totalCount,</span></span></span><br><span class="line"><span class="params"><span class="function">            System.Linq.Expressions.Expression&lt;Func&lt;T, <span class="built_in">bool</span>&gt;&gt; whereLambda,</span></span></span><br><span class="line"><span class="params"><span class="function">            System.Linq.Expressions.Expression&lt;Func&lt;T, s&gt;&gt; orderbyLambda, <span class="built_in">bool</span> isAsc</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="built_in">bool</span> <span class="title">DeleteEntity</span>(<span class="params">T entity</span>)</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="built_in">bool</span> <span class="title">EditEntity</span>(<span class="params">T entity</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function">T <span class="title">AddEntity</span>(<span class="params">T entity</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>IUserDal：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> PMS.Model;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PMS.IDAL</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">interface</span> <span class="title">IUserDal</span>:<span class="title">IBaseDal</span>&lt;<span class="title">User</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>UserDal实现IUserDal接口：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">UserDal</span> : <span class="title">BaseDal</span>&lt;<span class="title">User</span>&gt;,<span class="title">IUserDal</span></span><br></pre></td></tr></table></figure>
<h3 id="数据会话层的构建"><a href="#数据会话层的构建" class="headerlink" title="数据会话层的构建"></a>数据会话层的构建</h3><p>抽象工厂类AbstractFactory：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Configuration;</span><br><span class="line"><span class="keyword">using</span> System.Reflection;</span><br><span class="line"><span class="keyword">using</span> PMS.IDAL;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PMS.DALFactory</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">AbstractFactory</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//读取保存在配置文件中的程序集名称与命名空间名</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="built_in">string</span> AssemblyPath = ConfigurationManager.AppSettings[<span class="string">&quot;AssemblyPath&quot;</span>];</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="built_in">string</span> NameSpace = ConfigurationManager.AppSettings[<span class="string">&quot;NameSpace&quot;</span>];</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 获取UserDal的实例</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IUserDal <span class="title">CreateUserInfoDal</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> fullClassName = NameSpace + <span class="string">&quot;.UserInfoDal&quot;</span>;</span><br><span class="line">            <span class="keyword">return</span> CreateInstance(fullClassName) <span class="keyword">as</span> IUserDal;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 通过反射获得程序集中某类型的实例</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;className&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">object</span> <span class="title">CreateInstance</span>(<span class="params"><span class="built_in">string</span> className</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> assembly = Assembly.Load(AssemblyPath);</span><br><span class="line">            <span class="keyword">return</span> assembly.CreateInstance(className);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>数据会话类DbSession：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Data.Entity;</span><br><span class="line"><span class="keyword">using</span> PMS.IDAL;</span><br><span class="line"><span class="keyword">using</span> PMS.DAL;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PMS.DALFactory</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">DbSession</span>:<span class="title">IDbSession</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> DbContext Db</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span> &#123; <span class="keyword">return</span> DbContextFactory.CreateContext(); &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> IUserDal _userDal;</span><br><span class="line">        <span class="keyword">public</span> IUserDal UserDal</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span> &#123; <span class="keyword">return</span> _userDal ?? (_userDal = AbstractFactory.CreateUserInfoDal()); &#125;</span><br><span class="line">            <span class="keyword">set</span> &#123; _userDal = <span class="keyword">value</span>; &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 工作单元模式，统一保存数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">SaveChanges</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> Db.SaveChanges() &gt; <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="业务逻辑层的构建"><a href="#业务逻辑层的构建" class="headerlink" title="业务逻辑层的构建"></a>业务逻辑层的构建</h3><p>业务类基类BaseService</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Linq.Expressions;</span><br><span class="line"><span class="keyword">using</span> PMS.DALFactory;</span><br><span class="line"><span class="keyword">using</span> PMS.IDAL;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PMS.BLL</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">BaseService</span>&lt;<span class="title">T</span>&gt; <span class="keyword">where</span> <span class="title">T</span>:<span class="keyword">class</span>,<span class="title">new</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> IDbSession CurrentDbSession</span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">get</span></span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">return</span> <span class="keyword">new</span> DbSession();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">public</span> IBaseDal&lt;T&gt; CurrentDal &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">SetCurrentDal</span>()</span>;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="title">BaseService</span>()</span></span><br><span class="line">       &#123;</span><br><span class="line">           SetCurrentDal();<span class="comment">//子类一定要实现抽象方法，以指明当前类的子类类型。</span></span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 查询过滤</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;whereLambda&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> IQueryable&lt;T&gt; <span class="title">LoadEntities</span>(<span class="params">Expression&lt;Func&lt;T, <span class="built_in">bool</span>&gt;&gt; whereLambda</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">return</span> CurrentDal.LoadEntities(whereLambda);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 分页</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;s&quot;&gt;</span><span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;pageIndex&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;pageSize&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;totalCount&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;whereLambda&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;orderbyLambda&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;isAsc&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="title">IQueryable</span>&lt;<span class="title">T</span>&gt; <span class="title">LoadPageEntities</span>&lt;<span class="title">s</span>&gt;(<span class="params"><span class="built_in">int</span> pageIndex, <span class="built_in">int</span> pageSize, <span class="keyword">out</span> <span class="built_in">int</span> totalCount, Expression&lt;Func&lt;T, <span class="built_in">bool</span>&gt;&gt; whereLambda,</span></span></span><br><span class="line"><span class="params"><span class="function">           Expression&lt;Func&lt;T, s&gt;&gt; orderbyLambda, <span class="built_in">bool</span> isAsc</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">return</span> CurrentDal.LoadPageEntities&lt;s&gt;(pageIndex, pageSize, <span class="keyword">out</span> totalCount, whereLambda, orderbyLambda, isAsc);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 删除</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;entity&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">DeleteEntity</span>(<span class="params">T entity</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           CurrentDal.DeleteEntity(entity);</span><br><span class="line">           <span class="keyword">return</span> CurrentDbSession.SaveChanges();</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 编辑</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;entity&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">EditEntity</span>(<span class="params">T entity</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           CurrentDal.EditEntity(entity);</span><br><span class="line">           <span class="keyword">return</span> CurrentDbSession.SaveChanges();</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 添加数据</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;entity&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> T <span class="title">AddEntity</span>(<span class="params">T entity</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           CurrentDal.AddEntity(entity);</span><br><span class="line">           CurrentDbSession.SaveChanges();</span><br><span class="line">           <span class="keyword">return</span> entity;</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>UserService类：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> PMS.IBLL;</span><br><span class="line"><span class="keyword">using</span> PMS.Model;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PMS.BLL</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">UserService</span> : <span class="title">BaseService</span>&lt;<span class="title">User</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">SetCurrentDal</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            CurrentDal = CurrentDbSession.UserDal;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="业务逻辑接口层的构建"><a href="#业务逻辑接口层的构建" class="headerlink" title="业务逻辑接口层的构建"></a>业务逻辑接口层的构建</h3><p>直接建立对应的接口并使用UserService类实现IUserService接口</p>
<p>IBaseService接口：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Linq.Expressions;</span><br><span class="line"><span class="keyword">using</span> PMS.IDAL;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PMS.IBLL</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IBaseService</span>&lt;<span class="title">T</span>&gt; <span class="keyword">where</span> T : <span class="keyword">class</span>,<span class="keyword">new</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        IDbSession CurrentDbSession &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line">        IBaseDal&lt;T&gt; CurrentDal &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">SetCurrentDal</span>()</span>;</span><br><span class="line">        <span class="function"><span class="title">IQueryable</span>&lt;<span class="title">T</span>&gt; <span class="title">LoadEntities</span>(<span class="params">Expression&lt;Func&lt;T, <span class="built_in">bool</span>&gt;&gt; whereLambda</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="title">IQueryable</span>&lt;<span class="title">T</span>&gt; <span class="title">LoadPageEntities</span>&lt;<span class="title">s</span>&gt;(<span class="params"><span class="built_in">int</span> pageIndex, <span class="built_in">int</span> pageSize, <span class="keyword">out</span> <span class="built_in">int</span> totalCount,</span></span></span><br><span class="line"><span class="params"><span class="function">            Expression&lt;Func&lt;T, <span class="built_in">bool</span>&gt;&gt; whereLambda,</span></span></span><br><span class="line"><span class="params"><span class="function">            Expression&lt;Func&lt;T, s&gt;&gt; orderbyLambda, <span class="built_in">bool</span> isAsc</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="built_in">bool</span> <span class="title">DeleteEntity</span>(<span class="params">T entity</span>)</span>;</span><br><span class="line">        <span class="function"><span class="built_in">bool</span> <span class="title">EditEntity</span>(<span class="params">T entity</span>)</span>;</span><br><span class="line">        <span class="function">T <span class="title">AddEntity</span>(<span class="params">T entity</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>IUserService接口:</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> PMS.Model;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PMS.IBLL</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">interface</span> <span class="title">IUserService</span>:<span class="title">IBaseService</span>&lt;<span class="title">User</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用UserService类实现IUserService接口:</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">UserService</span> : <span class="title">BaseService</span>&lt;<span class="title">User</span>&gt;, <span class="title">IUserService</span></span><br></pre></td></tr></table></figure>
<p>以上我们就完成了整个框架中关于User类的各层次的实现。</p>
]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
      <tags>
        <tag>MVC</tag>
      </tags>
  </entry>
  <entry>
    <title>【51NOD刷题】2020 排序相减</title>
    <url>/posts/52661.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p><a href="http://www.51nod.com/onlineJudge/questionCode.html#!problemId=2020"><strong>2020 排序相减</strong></a></p>
<p>题目来源： syu练习题<br>基准时间限制：1 秒&#8195;空间限制：131072 KB&#8195;分值: 5&#8195;难度：1级算法题<br>“排序相减”操作是指对于任意一个四位数n，将四个数字分别进行顺序排序和逆序排序，得到两个数取相减后结果的绝对值n1，然后继续将n1中的四个数字进行顺序排序和逆序排序，得到两个数取相减后结果的绝对值n2,以此类推，最后总会得到一个数字黑洞，无法跳出。</p>
<p>例如:样例2中4176 = 6532 - 2356</p>
<span id="more"></span>
<h2 id="输入输出"><a href="#输入输出" class="headerlink" title="输入输出"></a>输入输出</h2><p><strong>Input</strong><br>第一行输入一个整数T，表示数据组数（1&lt;T&lt;10000）；<br>第二行输入一个正整数n(1000&lt;=n&lt;=9999)和一个正整数k（1&lt;=k&lt;=100）,表示操作次数；<br><strong>Output</strong><br>对于每组数据，输出对于开始的数据n在第k次“排序相减”后结果绝对值。<br><strong>Input示例</strong></p>
<blockquote>
<p>2<br>1234 2<br>3562 1</p>
</blockquote>
<p><strong>Output示例</strong></p>
<blockquote>
<p>8352<br>4176</p>
</blockquote>
<h2 id="Accepted"><a href="#Accepted" class="headerlink" title="Accepted"></a>Accepted</h2><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Sum</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">       <span class="keyword">var</span> sr = <span class="keyword">new</span> StreamReader(Console.OpenStandardInput());</span><br><span class="line">        <span class="keyword">var</span> sw = <span class="keyword">new</span> StreamWriter(Console.OpenStandardOutput());</span><br><span class="line">        <span class="keyword">var</span> count = Convert.ToInt32(sr.ReadLine());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; count; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> tokens = sr.ReadLine().Split(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">            <span class="keyword">var</span> n = Convert.ToInt32(tokens[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">var</span> t = Convert.ToInt32(tokens[<span class="number">1</span>]);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; t; j++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> intArray = n.ToString().ToCharArray();</span><br><span class="line">                Array.Sort(intArray);</span><br><span class="line">                <span class="keyword">var</span> z = Convert.ToInt32(<span class="keyword">new</span> <span class="built_in">string</span>(intArray));</span><br><span class="line">                Array.Reverse(intArray);</span><br><span class="line">                <span class="keyword">var</span> f = Convert.ToInt32(<span class="keyword">new</span> <span class="built_in">string</span>(intArray));</span><br><span class="line">                n = Math.Abs(z - f);</span><br><span class="line">            &#125;</span><br><span class="line">            sw.WriteLine(n);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        sw.Flush();</span><br><span class="line">        sr.Close();</span><br><span class="line">        sw.Close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>算法刷题</category>
      </categories>
      <tags>
        <tag>51NOD</tag>
        <tag>刷题</tag>
        <tag>C#</tag>
      </tags>
  </entry>
  <entry>
    <title>【51NOD刷题】1381 硬币游戏</title>
    <url>/posts/59607.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p><a href="http://www.51nod.com/onlineJudge/questionCode.html#!problemId=1381"><strong>1381 硬币游戏</strong></a><br>基准时间限制：1 秒&#8195;空间限制：131072 KB&#8195;分值: 5&#8195;难度：1级算法题</p>
<p>有一个简单但是很有趣的游戏。在这个游戏中有一个硬币还有一张桌子，这张桌子上有很多平行线（如下图所示）。两条相邻平行线之间的距离是1，硬币的半径是R，然后我们来抛硬币到桌子上，抛下之后硬币有时候会和一些直线相交（相切的情况也算是相交），有时候不会。<br>请你来计算一下抛一次硬币之后，该硬币和直线相交数目的期望。<br><img data-src="https://qiniucdn.wayneshao.com/20180305013606666/20180224023425513.png"></p>
<span id="more"></span>
<h2 id="输入输出"><a href="#输入输出" class="headerlink" title="输入输出"></a>输入输出</h2><p><strong>Input</strong><br>第一行给出一个整数T，表示有T组数据(1&lt;=T&lt;=10000)。<br>第2行到T+1，每行给出一个整数R。(0&lt; R &lt;= 10,000,000,000)<br><strong>Output</strong><br>对于每一个数据，在一行中输出答案的整数部分即可。<br><strong>Input示例</strong></p>
<blockquote>
<p>1<br>1</p>
</blockquote>
<p><strong>Output示例</strong></p>
<blockquote>
<p>2</p>
</blockquote>
<h2 id="题目解析"><a href="#题目解析" class="headerlink" title="题目解析"></a>题目解析</h2><p>由题目可知，输入的R是整数，所以分析硬币落桌之后只有两种情况：</p>
<ol>
<li>硬币边缘和某两条线相切，这个时候会有一条线经过圆心，总共有2R+1条线与圆相交，这种情况的概率非常低。</li>
<li>硬币和所有线都没有相切，总共有2R条线与圆相交。</li>
</ol>
<p>所以总体的期望为2R</p>
<h2 id="Accepted"><a href="#Accepted" class="headerlink" title="Accepted"></a>Accepted</h2><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Sum</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> count = Convert.ToInt32(Console.ReadLine());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; count; i++)</span><br><span class="line">            Console.WriteLine(Convert.ToInt32(Console.ReadLine()) * <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>算法刷题</category>
      </categories>
      <tags>
        <tag>51NOD</tag>
        <tag>刷题</tag>
        <tag>C#</tag>
        <tag>概率</tag>
      </tags>
  </entry>
  <entry>
    <title>【MVC学习笔记】5.使用Controller来代替Filter完成登录验证（Session校验）</title>
    <url>/posts/21523.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>之前的学习中，在对Session校验完成登录验证时，通常使用Filter来处理，方法类似与前文的错误日志过滤，即新建Filter类继承ActionFilterAttribute类，重写OnActionExecuting方法，之后直接在需要验证的Action前加上Filter标记即可。</p>
<span id="more"></span>
<h2 id="Filter式实现"><a href="#Filter式实现" class="headerlink" title="Filter式实现"></a>Filter式实现</h2><h3 id="新建登陆校验类"><a href="#新建登陆校验类" class="headerlink" title="新建登陆校验类"></a>新建登陆校验类</h3><p>新建登陆校验类CheckLoginAttribute</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Web.Mvc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PMS.WebApp.Models</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CheckLoginAttribute</span>:<span class="title">ActionFilterAttribute</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnActionExecuting</span>(<span class="params">ActionExecutingContext filterContext</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">base</span>.OnActionExecuting(filterContext);</span><br><span class="line">            <span class="keyword">if</span> (filterContext.HttpContext.Session == <span class="literal">null</span> || filterContext.HttpContext.Session[<span class="string">&quot;user&quot;</span>] == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                filterContext.HttpContext.Response.Redirect(<span class="string">&quot;/User/Login&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="增加特性"><a href="#增加特性" class="headerlink" title="增加特性"></a>增加特性</h3><p>在需要校验的Action增加标记以完成校验</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Web.Mvc;</span><br><span class="line"><span class="keyword">using</span> PMS.IBLL;</span><br><span class="line"><span class="keyword">using</span> PMS.WebApp.Models;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PMS.WebApp.Controllers</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserController</span> : <span class="title">Controller</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// GET: /User/</span></span><br><span class="line">        <span class="comment">//private IUserService _userService;</span></span><br><span class="line">        <span class="comment">//private IUserService UserService</span></span><br><span class="line">        <span class="comment">//&#123;</span></span><br><span class="line">        <span class="comment">//    get &#123; return _userService ?? (_userService = new UserService()); &#125;</span></span><br><span class="line">        <span class="comment">//    set &#123; _userService = value; &#125;</span></span><br><span class="line">        <span class="comment">//&#125;</span></span><br><span class="line">        <span class="keyword">private</span> IUserService UserService &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        [<span class="meta">CheckLogin</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> ActionResult <span class="title">Index</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> Content(<span class="string">&quot;OK&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意：不要在RegisterGlobalFilters方法中注册校验类，否则则会相当于给所有Action都添加了校验</p>
<p>这种方法使用起来需要在每个Action方法前添加过滤标签，且效率并不十分高，我们的项目中使用的是一种更为简单高效的方法：使用Controller进行登录验证</p>
<h2 id="Controller式实现"><a href="#Controller式实现" class="headerlink" title="Controller式实现"></a>Controller式实现</h2><h3 id="新建验证父类"><a href="#新建验证父类" class="headerlink" title="新建验证父类"></a>新建验证父类</h3><p>新建一个用于验证的Controller父类，并在其内重写OnActionExecuting方法完成登陆校验：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Web.Mvc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PMS.WebApp.Controllers</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FilterController</span> : <span class="title">Controller</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnActionExecuting</span>(<span class="params">ActionExecutingContext filterContext</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">base</span>.OnActionExecuting(filterContext);</span><br><span class="line">            <span class="keyword">if</span> (Session[<span class="string">&quot;user&quot;</span>] == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//filterContext.HttpContext.Response.Redirect(&quot;/User/Login&quot;);</span></span><br><span class="line">                filterContext.Result = Redirect(<span class="string">&quot;/User/Login&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在Controller校验类的OnActionExecuting方法中，有如下代码</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">//filterContext.HttpContext.Response.Redirect(&quot;/User/Login&quot;);</span></span><br><span class="line">filterContext.Result = Redirect(<span class="string">&quot;/User/Login&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>我们使用后者而放弃前者的原因是，ASP.NET MVC中规定，Action必须返回ActionResult，如果使用前者，在完成跳转前会先进入到请求的页面，这样不符合我们使用过滤器的初衷。</p>
<h3 id="继承校验父类"><a href="#继承校验父类" class="headerlink" title="继承校验父类"></a>继承校验父类</h3><p>然后使需要校验的Controller继承于我们定义的校验Controller即可完成全局登录校验操作：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Web.Mvc;</span><br><span class="line"><span class="keyword">using</span> PMS.IBLL;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PMS.WebApp.Controllers</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserController</span> : <span class="title">FilterController</span><span class="comment">//Controller</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// GET: /User/</span></span><br><span class="line">        <span class="comment">//private IUserService _userService;</span></span><br><span class="line">        <span class="comment">//private IUserService UserService</span></span><br><span class="line">        <span class="comment">//&#123;</span></span><br><span class="line">        <span class="comment">//    get &#123; return _userService ?? (_userService = new UserService()); &#125;</span></span><br><span class="line">        <span class="comment">//    set &#123; _userService = value; &#125;</span></span><br><span class="line">        <span class="comment">//&#125;</span></span><br><span class="line">        <span class="keyword">private</span> IUserService UserService &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="comment">//[CheckLogin]</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> ActionResult <span class="title">Index</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> Content(<span class="string">&quot;OK&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面我们对比两种方法的优缺点:</p>
<p>  Filter定义过程比较复杂，效率也稍低些，但是却可以对每一个Action进行单独的过滤，同一Action也可以有多条过滤信息，使用比较灵活。</p>
<p>  Controller定义更为简便，效率高，但是却只能对整个Controller中所有方法进行过滤，同一Controller也不太容易有多个Controller过滤父类。</p>
<p> <strong>综上所述，实际项目中大多需求都是同一Controller下所有方法都需要完成登陆验证，所以其实使用Controller过滤更为高效，应对复杂需求时，灵活混用两种方法也不失为一种好的策略。</strong></p>
]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
      <tags>
        <tag>MVC</tag>
        <tag>登录验证</tag>
      </tags>
  </entry>
  <entry>
    <title>【MVC学习笔记】2.使用T4模板生成其他类的具体实现</title>
    <url>/posts/18563.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>在前篇中我们已经将User类中的代码做了具体的实现，但仍然有多个实体类未实现，以后可能还会增加新的数据表，数据表结构也有可能发生变化，所以我们使用T4模板来完成类的生成，这样就算数据库表发生了改变，也会自动根据改变后的实体对类进行重新生成。</p>
<span id="more"></span>
<h3 id="DAL层"><a href="#DAL层" class="headerlink" title="DAL层"></a>DAL层</h3><p>下面是数据访问层的T4模板文件 Dal.tt</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">&lt;<span class="meta">#@ template language=&quot;C#&quot; debug=&quot;false&quot; hostspecific=&quot;true&quot;#&gt;</span></span><br><span class="line">&lt;<span class="meta">#@ include file=&quot;EF.Utility.CS.ttinclude&quot;#&gt;&lt;#@</span></span><br><span class="line"> output extension=<span class="string">&quot;.cs&quot;</span><span class="meta">#&gt;</span></span><br><span class="line"> </span><br><span class="line">&lt;<span class="meta">#</span></span><br><span class="line"></span><br><span class="line">CodeGenerationTools code = <span class="keyword">new</span> CodeGenerationTools(<span class="keyword">this</span>);</span><br><span class="line">MetadataLoader loader = <span class="keyword">new</span> MetadataLoader(<span class="keyword">this</span>);</span><br><span class="line">CodeRegion region = <span class="keyword">new</span> CodeRegion(<span class="keyword">this</span>, <span class="number">1</span>);</span><br><span class="line">MetadataTools ef = <span class="keyword">new</span> MetadataTools(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//EF实体文件在项目中的路径</span></span><br><span class="line"><span class="built_in">string</span> inputFile = <span class="string">@&quot;..\\PMS.Model\\PMS.edmx&quot;</span>;</span><br><span class="line"></span><br><span class="line">EdmItemCollection ItemCollection = loader.CreateEdmItemCollection(inputFile);</span><br><span class="line"><span class="built_in">string</span> namespaceName = code.VsNamespaceSuggestion();</span><br><span class="line"></span><br><span class="line">EntityFrameworkTemplateFileManager fileManager = EntityFrameworkTemplateFileManager.Create(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#&gt;</span></span><br><span class="line">&lt;<span class="meta">#//这里为命名空间部分，手动更改为相应的命名空间 #&gt;</span></span><br><span class="line"><span class="keyword">using</span> PMS.IDAL;</span><br><span class="line"><span class="keyword">using</span> PMS.Model;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PMS.DAL</span></span><br><span class="line">&#123;</span><br><span class="line">&lt;<span class="meta">#</span></span><br><span class="line"><span class="comment">// Emit Entity Types</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (EntityType entity <span class="keyword">in</span> ItemCollection.GetItems&lt;EntityType&gt;().OrderBy(e =&gt; e.Name))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//fileManager.StartNewFile(entity.Name + &quot;RepositoryExt.cs&quot;);</span></span><br><span class="line">    <span class="comment">//BeginNamespace(namespaceName, code);    </span></span><br><span class="line"><span class="meta">#&gt;        </span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> &lt;#=<span class="title">entity.Name</span>#&gt;<span class="title">Dal</span> :<span class="title">BaseDal</span>&lt;&lt;#=<span class="title">entity.Name</span>#&gt;&gt;,<span class="title">I</span>&lt;#=<span class="title">entity.Name</span>#&gt;<span class="title">Dal</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&lt;<span class="meta">#&#125;#&gt;</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们将EF实体文件路径、命名空间更改为对应的值时，<strong>Ctrl+S</strong> 保存，即可生成对应的其他类型的数据访问类</p>
<p>其他层中也大同小异，只需要做对应的更改即可，下面我将提供相应的代码。</p>
<h3 id="IDAL层"><a href="#IDAL层" class="headerlink" title="IDAL层"></a>IDAL层</h3><p>IDal.tt</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">&lt;<span class="meta">#@ template language=&quot;C#&quot; debug=&quot;false&quot; hostspecific=&quot;true&quot;#&gt;</span></span><br><span class="line">&lt;<span class="meta">#@ include file=&quot;EF.Utility.CS.ttinclude&quot;#&gt;&lt;#@</span></span><br><span class="line"> output extension=<span class="string">&quot;.cs&quot;</span><span class="meta">#&gt; </span></span><br><span class="line">&lt;<span class="meta">#</span></span><br><span class="line">CodeGenerationTools code = <span class="keyword">new</span> CodeGenerationTools(<span class="keyword">this</span>);</span><br><span class="line">MetadataLoader loader = <span class="keyword">new</span> MetadataLoader(<span class="keyword">this</span>);</span><br><span class="line">CodeRegion region = <span class="keyword">new</span> CodeRegion(<span class="keyword">this</span>, <span class="number">1</span>);</span><br><span class="line">MetadataTools ef = <span class="keyword">new</span> MetadataTools(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">string</span> inputFile = <span class="string">@&quot;..\\PMS.Model\\PMS.edmx&quot;</span>;</span><br><span class="line"></span><br><span class="line">EdmItemCollection ItemCollection = loader.CreateEdmItemCollection(inputFile);</span><br><span class="line"><span class="built_in">string</span> namespaceName = code.VsNamespaceSuggestion();</span><br><span class="line"></span><br><span class="line">EntityFrameworkTemplateFileManager fileManager = EntityFrameworkTemplateFileManager.Create(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#&gt;</span></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"><span class="keyword">using</span> PMS.Model;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PMS.IDAL</span></span><br><span class="line">&#123;</span><br><span class="line">   </span><br><span class="line">&lt;<span class="meta">#</span></span><br><span class="line"><span class="comment">// Emit Entity Types</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (EntityType entity <span class="keyword">in</span> ItemCollection.GetItems&lt;EntityType&gt;().OrderBy(e =&gt; e.Name))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//fileManager.StartNewFile(entity.Name + &quot;RepositoryExt.cs&quot;);</span></span><br><span class="line">    <span class="comment">//BeginNamespace(namespaceName, code);    </span></span><br><span class="line"><span class="meta">#&gt;    </span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">interface</span> <span class="title">I</span>&lt;#=<span class="title">entity.Name</span>#&gt;<span class="title">Dal</span> :<span class="title">IBaseDal</span>&lt;&lt;#=<span class="title">entity.Name</span>#&gt;&gt;</span><br><span class="line">    &#123;</span><br><span class="line">      </span><br><span class="line">    &#125;</span><br><span class="line">&lt;<span class="meta">#&#125;#&gt;</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>IDbSession.tt</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">&lt;<span class="meta">#@ template language=&quot;C#&quot; debug=&quot;false&quot; hostspecific=&quot;true&quot;#&gt;</span></span><br><span class="line">&lt;<span class="meta">#@ include file=&quot;EF.Utility.CS.ttinclude&quot;#&gt;&lt;#@</span></span><br><span class="line"> output extension=<span class="string">&quot;.cs&quot;</span><span class="meta">#&gt;</span></span><br><span class="line"> </span><br><span class="line">&lt;<span class="meta">#</span></span><br><span class="line"></span><br><span class="line">CodeGenerationTools code = <span class="keyword">new</span> CodeGenerationTools(<span class="keyword">this</span>);</span><br><span class="line">MetadataLoader loader = <span class="keyword">new</span> MetadataLoader(<span class="keyword">this</span>);</span><br><span class="line">CodeRegion region = <span class="keyword">new</span> CodeRegion(<span class="keyword">this</span>, <span class="number">1</span>);</span><br><span class="line">MetadataTools ef = <span class="keyword">new</span> MetadataTools(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">string</span> inputFile = <span class="string">@&quot;..\\PMS.Model\\PMS.edmx&quot;</span>;</span><br><span class="line"></span><br><span class="line">EdmItemCollection ItemCollection = loader.CreateEdmItemCollection(inputFile);</span><br><span class="line"><span class="built_in">string</span> namespaceName = code.VsNamespaceSuggestion();</span><br><span class="line"></span><br><span class="line">EntityFrameworkTemplateFileManager fileManager = EntityFrameworkTemplateFileManager.Create(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Data.Entity;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PMS.IDAL</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">interface</span> <span class="title">IDbSession</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">&lt;<span class="meta">#</span></span><br><span class="line"><span class="comment">// Emit Entity Types</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (EntityType entity <span class="keyword">in</span> ItemCollection.GetItems&lt;EntityType&gt;().OrderBy(e =&gt; e.Name))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//fileManager.StartNewFile(entity.Name + &quot;RepositoryExt.cs&quot;);</span></span><br><span class="line">    <span class="comment">//BeginNamespace(namespaceName, code);    </span></span><br><span class="line"><span class="meta">#&gt;    </span></span><br><span class="line">        I&lt;<span class="meta">#=entity.Name#&gt;Dal &lt;#=entity.Name#&gt;Dal&#123;get;set;&#125;</span></span><br><span class="line">&lt;<span class="meta">#&#125;#&gt;</span></span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="DALFactory层"><a href="#DALFactory层" class="headerlink" title="DALFactory层"></a>DALFactory层</h3><p>SimpleDalFactory.tt</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">&lt;<span class="meta">#@ template language=&quot;C#&quot; debug=&quot;false&quot; hostspecific=&quot;true&quot;#&gt;</span></span><br><span class="line">&lt;<span class="meta">#@ include file=&quot;EF.Utility.CS.ttinclude&quot;#&gt;&lt;#@</span></span><br><span class="line"> output extension=<span class="string">&quot;.cs&quot;</span><span class="meta">#&gt;</span></span><br><span class="line"> </span><br><span class="line">&lt;<span class="meta">#</span></span><br><span class="line"></span><br><span class="line">CodeGenerationTools code = <span class="keyword">new</span> CodeGenerationTools(<span class="keyword">this</span>);</span><br><span class="line">MetadataLoader loader = <span class="keyword">new</span> MetadataLoader(<span class="keyword">this</span>);</span><br><span class="line">CodeRegion region = <span class="keyword">new</span> CodeRegion(<span class="keyword">this</span>, <span class="number">1</span>);</span><br><span class="line">MetadataTools ef = <span class="keyword">new</span> MetadataTools(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">string</span> inputFile =<span class="string">@&quot;..\\PMS.Model\\PMS.edmx&quot;</span>;</span><br><span class="line"></span><br><span class="line">EdmItemCollection ItemCollection = loader.CreateEdmItemCollection(inputFile);</span><br><span class="line"><span class="built_in">string</span> namespaceName = code.VsNamespaceSuggestion();</span><br><span class="line"></span><br><span class="line">EntityFrameworkTemplateFileManager fileManager = EntityFrameworkTemplateFileManager.Create(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> SW.OA.IDAL;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Configuration;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Reflection;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">SW.OA.DALFactory</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">AbstractFactory</span></span><br><span class="line">    &#123;</span><br><span class="line">      </span><br><span class="line">   </span><br><span class="line">&lt;<span class="meta">#</span></span><br><span class="line"><span class="keyword">foreach</span> (EntityType entity <span class="keyword">in</span> ItemCollection.GetItems&lt;EntityType&gt;().OrderBy(e =&gt; e.Name))</span><br><span class="line">&#123;    </span><br><span class="line"><span class="meta">#&gt;        </span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> I&lt;<span class="meta">#=entity.Name#&gt;Dal Create&lt;#=entity.Name#&gt;Dal()</span></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">         <span class="built_in">string</span> fullClassName = NameSpace + <span class="string">&quot;.&lt;#=entity.Name#&gt;Dal&quot;</span>;</span><br><span class="line">          <span class="keyword">return</span> CreateInstance(fullClassName) <span class="keyword">as</span> I&lt;<span class="meta">#=entity.Name#&gt;Dal;</span></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">&lt;<span class="meta">#&#125;#&gt;</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>DbSession.tt</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">&lt;<span class="meta">#@ template language=&quot;C#&quot; debug=&quot;false&quot; hostspecific=&quot;true&quot;#&gt;</span></span><br><span class="line">&lt;<span class="meta">#@ include file=&quot;EF.Utility.CS.ttinclude&quot;#&gt;&lt;#@</span></span><br><span class="line"> output extension=<span class="string">&quot;.cs&quot;</span><span class="meta">#&gt;</span></span><br><span class="line"> </span><br><span class="line">&lt;<span class="meta">#</span></span><br><span class="line"></span><br><span class="line">CodeGenerationTools code = <span class="keyword">new</span> CodeGenerationTools(<span class="keyword">this</span>);</span><br><span class="line">MetadataLoader loader = <span class="keyword">new</span> MetadataLoader(<span class="keyword">this</span>);</span><br><span class="line">CodeRegion region = <span class="keyword">new</span> CodeRegion(<span class="keyword">this</span>, <span class="number">1</span>);</span><br><span class="line">MetadataTools ef = <span class="keyword">new</span> MetadataTools(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">string</span> inputFile = <span class="string">@&quot;..\\PMS.Model\\PMS.edmx&quot;</span>;</span><br><span class="line"></span><br><span class="line">EdmItemCollection ItemCollection = loader.CreateEdmItemCollection(inputFile);</span><br><span class="line"><span class="built_in">string</span> namespaceName = code.VsNamespaceSuggestion();</span><br><span class="line"></span><br><span class="line">EntityFrameworkTemplateFileManager fileManager = EntityFrameworkTemplateFileManager.Create(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#&gt;</span></span><br><span class="line"><span class="keyword">using</span> PMS.DAL;</span><br><span class="line"><span class="keyword">using</span> PMS.IDAL;</span><br><span class="line"><span class="keyword">using</span> PMS.Model;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Data.Entity;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PMS.DALFactory</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">DBSession</span> : <span class="title">IDBSession</span></span><br><span class="line">    &#123;</span><br><span class="line">&lt;<span class="meta">#</span></span><br><span class="line"><span class="comment">// Emit Entity Types</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (EntityType entity <span class="keyword">in</span> ItemCollection.GetItems&lt;EntityType&gt;().OrderBy(e =&gt; e.Name))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//fileManager.StartNewFile(entity.Name + &quot;RepositoryExt.cs&quot;);</span></span><br><span class="line">    <span class="comment">//BeginNamespace(namespaceName, code);    </span></span><br><span class="line"><span class="meta">#&gt;    </span></span><br><span class="line">        <span class="keyword">private</span> I&lt;<span class="meta">#=entity.Name#&gt;Dal _&lt;#=entity.Name#&gt;Dal;</span></span><br><span class="line">        <span class="keyword">public</span> I&lt;<span class="meta">#=entity.Name#&gt;Dal &lt;#=entity.Name#&gt;Dal</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(_&lt;<span class="meta">#=entity.Name#&gt;Dal == null)</span></span><br><span class="line">                &#123;</span><br><span class="line">                    _&lt;<span class="meta">#=entity.Name#&gt;Dal = AbstractFactory.Create&lt;#=entity.Name#&gt;Dal();</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> _&lt;<span class="meta">#=entity.Name#&gt;Dal;</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">set</span> &#123; _&lt;<span class="meta">#=entity.Name#&gt;Dal = value; &#125;</span></span><br><span class="line">        &#125;</span><br><span class="line">&lt;<span class="meta">#&#125;#&gt;</span></span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="BLL层"><a href="#BLL层" class="headerlink" title="BLL层"></a>BLL层</h3><p>Service.tt</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">&lt;<span class="meta">#@ template language=&quot;C#&quot; debug=&quot;false&quot; hostspecific=&quot;true&quot;#&gt;</span></span><br><span class="line">&lt;<span class="meta">#@ include file=&quot;EF.Utility.CS.ttinclude&quot;#&gt;&lt;#@</span></span><br><span class="line"> output extension=<span class="string">&quot;.cs&quot;</span><span class="meta">#&gt;</span></span><br><span class="line"> </span><br><span class="line">&lt;<span class="meta">#</span></span><br><span class="line"></span><br><span class="line">CodeGenerationTools code = <span class="keyword">new</span> CodeGenerationTools(<span class="keyword">this</span>);</span><br><span class="line">MetadataLoader loader = <span class="keyword">new</span> MetadataLoader(<span class="keyword">this</span>);</span><br><span class="line">CodeRegion region = <span class="keyword">new</span> CodeRegion(<span class="keyword">this</span>, <span class="number">1</span>);</span><br><span class="line">MetadataTools ef = <span class="keyword">new</span> MetadataTools(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">string</span> inputFile = <span class="string">@&quot;..\\PMS.Model\\PMS.edmx&quot;</span>;</span><br><span class="line"></span><br><span class="line">EdmItemCollection ItemCollection = loader.CreateEdmItemCollection(inputFile);</span><br><span class="line"><span class="built_in">string</span> namespaceName = code.VsNamespaceSuggestion();</span><br><span class="line"></span><br><span class="line">EntityFrameworkTemplateFileManager fileManager = EntityFrameworkTemplateFileManager.Create(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#&gt;</span></span><br><span class="line"><span class="keyword">using</span> PMS.IBLL;</span><br><span class="line"><span class="keyword">using</span> PMS.Model;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PMS.BLL</span></span><br><span class="line">&#123;</span><br><span class="line">&lt;<span class="meta">#</span></span><br><span class="line"><span class="comment">// Emit Entity Types</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (EntityType entity <span class="keyword">in</span> ItemCollection.GetItems&lt;EntityType&gt;().OrderBy(e =&gt; e.Name))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//fileManager.StartNewFile(entity.Name + &quot;RepositoryExt.cs&quot;);</span></span><br><span class="line">    <span class="comment">//BeginNamespace(namespaceName, code);    </span></span><br><span class="line"><span class="meta">#&gt;    </span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> &lt;#=<span class="title">entity.Name</span>#&gt;<span class="title">Service</span> :<span class="title">BaseService</span>&lt;&lt;#=<span class="title">entity.Name</span>#&gt;&gt;,<span class="title">I</span>&lt;#=<span class="title">entity.Name</span>#&gt;<span class="title">Service</span></span><br><span class="line">    &#123;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">SetCurrentDal</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            CurrentDal = <span class="keyword">this</span>.CurrentDbSession.&lt;<span class="meta">#=entity.Name#&gt;Dal;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;   </span><br><span class="line">&lt;<span class="meta">#&#125;#&gt;</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="IBLL层"><a href="#IBLL层" class="headerlink" title="IBLL层"></a>IBLL层</h3><p>IService.tt</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">&lt;<span class="meta">#@ template language=&quot;C#&quot; debug=&quot;false&quot; hostspecific=&quot;true&quot;#&gt;</span></span><br><span class="line">&lt;<span class="meta">#@ include file=&quot;EF.Utility.CS.ttinclude&quot;#&gt;&lt;#@</span></span><br><span class="line"> output extension=<span class="string">&quot;.cs&quot;</span><span class="meta">#&gt;</span></span><br><span class="line"> </span><br><span class="line">&lt;<span class="meta">#</span></span><br><span class="line"></span><br><span class="line">CodeGenerationTools code = <span class="keyword">new</span> CodeGenerationTools(<span class="keyword">this</span>);</span><br><span class="line">MetadataLoader loader = <span class="keyword">new</span> MetadataLoader(<span class="keyword">this</span>);</span><br><span class="line">CodeRegion region = <span class="keyword">new</span> CodeRegion(<span class="keyword">this</span>, <span class="number">1</span>);</span><br><span class="line">MetadataTools ef = <span class="keyword">new</span> MetadataTools(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">string</span> inputFile = <span class="string">@&quot;..\\PMS.Model\\PMS.edmx&quot;</span>;</span><br><span class="line"></span><br><span class="line">EdmItemCollection ItemCollection = loader.CreateEdmItemCollection(inputFile);</span><br><span class="line"><span class="built_in">string</span> namespaceName = code.VsNamespaceSuggestion();</span><br><span class="line"></span><br><span class="line">EntityFrameworkTemplateFileManager fileManager = EntityFrameworkTemplateFileManager.Create(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> PMS.Model;</span><br><span class="line"><span class="keyword">using</span> PMS.Model.Search;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PMS.IBLL</span></span><br><span class="line">&#123;</span><br><span class="line">&lt;<span class="meta">#</span></span><br><span class="line"><span class="comment">// Emit Entity Types</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (EntityType entity <span class="keyword">in</span> ItemCollection.GetItems&lt;EntityType&gt;().OrderBy(e =&gt; e.Name))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//fileManager.StartNewFile(entity.Name + &quot;RepositoryExt.cs&quot;);</span></span><br><span class="line">    <span class="comment">//BeginNamespace(namespaceName, code);    </span></span><br><span class="line"><span class="meta">#&gt;    </span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">interface</span> <span class="title">I</span>&lt;#=<span class="title">entity.Name</span>#&gt;<span class="title">Service</span> : <span class="title">IBaseService</span>&lt;&lt;#=<span class="title">entity.Name</span>#&gt;&gt;</span><br><span class="line">    &#123;</span><br><span class="line">       </span><br><span class="line">    &#125;   </span><br><span class="line">&lt;<span class="meta">#&#125;#&gt;</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>至此，我们完成了基本框架内容的填充。</p>
]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
      <tags>
        <tag>MVC</tag>
      </tags>
  </entry>
  <entry>
    <title>【MVC学习笔记】4.使用Log4Net来进行错误日志的记录</title>
    <url>/posts/43794.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>在Web应用运行过程中，我们难免会遇到程序运行异常，这个时候我们就应该将异常信息记录下来，以便开发人员和维护人员对异常原因进行还原，对异常原因进行修复。在ASP.NET平台中进行日志记录的组件也有很多，如Log4Net、CommonLogging等，我们这里选用Log4Net进行异常日志的记录。</p>
<span id="more"></span>
<h2 id="捕获异常"><a href="#捕获异常" class="headerlink" title="捕获异常"></a>捕获异常</h2><p>在ASP.NET MVC中提供了一个全局的异常处理过滤器：HandleErrorAttribute，可以通过该过滤器捕获异常信息。</p>
<p>我们在Models文件夹下新建类型Log4ExceptionAttribute，继承HandleErrorAttribute类，同时重写OnException方法来捕获异常数据：      </p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Web.Mvc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PMS.WebApp.Models</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Log4ExceptionAttribute</span>:<span class="title">HandleErrorAttribute</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 重写OnException方法来捕获异常数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;filterContext&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnException</span>(<span class="params">ExceptionContext filterContext</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">base</span>.OnException(filterContext);</span><br><span class="line">            <span class="comment">//捕获当前异常数据</span></span><br><span class="line">            <span class="keyword">var</span> ex = filterContext.Exception;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>新建过滤器后我们还需要在Global文件中调用的RegisterGlobalFilters方法中完成自己定义异常处理过滤的注册。</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Web.Mvc;</span><br><span class="line"><span class="keyword">using</span> PMS.WebApp.Models;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PMS.WebApp</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FilterConfig</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">RegisterGlobalFilters</span>(<span class="params">GlobalFilterCollection filters</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//filters.Add(new HandleErrorAttribute());</span></span><br><span class="line">            filters.Add(<span class="keyword">new</span> Log4ExceptionAttribute());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="队列处理"><a href="#队列处理" class="headerlink" title="队列处理"></a>队列处理</h2><p>考虑到多用户并发操作时可能产生的问题，我们需要新建一个队列来进行异常信息的暂存，同时开辟一个线程专门对队列中的异常信息进行处理。</p>
<p>在Log4ExceptionAttribute类中新建一个静态的异常类型的队列，在发生异常后，程序自动触发OnException方法，方法中将当前的异常信息入队后，跳转到错误页面。</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Web.Mvc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PMS.WebApp.Models</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Log4ExceptionAttribute</span>:<span class="title">HandleErrorAttribute</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> Queue&lt;Exception&gt; Exceptions=<span class="keyword">new</span> Queue&lt;Exception&gt;();</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 重写OnException方法来捕获异常数据</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;filterContext&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnException</span>(<span class="params">ExceptionContext filterContext</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">base</span>.OnException(filterContext);</span><br><span class="line">            <span class="comment">//捕获当前异常数据</span></span><br><span class="line">            <span class="keyword">var</span> ex = filterContext.Exception;</span><br><span class="line">            <span class="comment">//将异常数据入队</span></span><br><span class="line">            Exceptions.Enqueue(ex);</span><br><span class="line">            <span class="comment">//跳转到错误页面</span></span><br><span class="line">            filterContext.HttpContext.Response.Redirect(<span class="string">&quot;/Error.html&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Log4Net的配置是在应用程序配置文件中进行的，我们先在配置文件中进行Log4Net的配置。Log4Net需要配置的节点位置和SpringNet完全相同，首先需要在configSessions中新增子节点,然后在configuration节点中增加log4net节点完成具体配置。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">configSections</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">section</span> <span class="attr">name</span>=<span class="string">&quot;entityFramework&quot;</span> <span class="attr">type</span>=<span class="string">&quot;System.Data.Entity.Internal.ConfigFile.EntityFrameworkSection, EntityFramework, Version=6.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089&quot;</span> <span class="attr">requirePermission</span>=<span class="string">&quot;false&quot;</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- For more information on Entity Framework configuration, visit http://go.microsoft.com/fwlink/?LinkID=237468 --&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!--↓Log4Net配置↓--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">section</span> <span class="attr">name</span>=<span class="string">&quot;log4net&quot;</span> <span class="attr">type</span>=<span class="string">&quot;log4net.Config.Log4NetConfigurationSectionHandler, log4net&quot;</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--↑Log4Net配置↑--&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!--↓Spring.Net配置↓--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sectionGroup</span> <span class="attr">name</span>=<span class="string">&quot;spring&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">section</span> <span class="attr">name</span>=<span class="string">&quot;context&quot;</span> <span class="attr">type</span>=<span class="string">&quot;Spring.Context.Support.MvcContextHandler, Spring.Web.Mvc4&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">sectionGroup</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--↑Spring.Net配置↑--&gt;</span></span><br><span class="line">    </span><br><span class="line">  <span class="tag">&lt;/<span class="name">configSections</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">&lt;!--↓Spring.Net配置↓--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">spring</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">resource</span> <span class="attr">uri</span>=<span class="string">&quot;file://~/Config/controllers.xml&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">resource</span> <span class="attr">uri</span>=<span class="string">&quot;file://~/Config/services.xml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">context</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">spring</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--↑Spring.Net配置↑--&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">&lt;!--↓Log4Net配置↓--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">log4net</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- OFF, FATAL, ERROR, WARN, INFO, DEBUG, ALL --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Set root logger level to ERROR and its appenders --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">root</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">level</span> <span class="attr">value</span>=<span class="string">&quot;ALL&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;SysAppender&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Print only messages of level DEBUG or above in the packages --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">&quot;WebLogger&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">level</span> <span class="attr">value</span>=<span class="string">&quot;DEBUG&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">logger</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;SysAppender&quot;</span> <span class="attr">type</span>=<span class="string">&quot;log4net.Appender.RollingFileAppender,log4net&quot;</span> &gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;File&quot;</span> <span class="attr">value</span>=<span class="string">&quot;App_Data/&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;AppendToFile&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;RollingStyle&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Date&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;DatePattern&quot;</span> <span class="attr">value</span>=<span class="string">&quot;<span class="symbol">&amp;quot;</span>Logs_<span class="symbol">&amp;quot;</span>yyyyMMdd<span class="symbol">&amp;quot;</span>.txt<span class="symbol">&amp;quot;</span>&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;StaticLogFileName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;false&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">layout</span> <span class="attr">type</span>=<span class="string">&quot;log4net.Layout.PatternLayout,log4net&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;ConversionPattern&quot;</span> <span class="attr">value</span>=<span class="string">&quot;%d [%t] %-5p %c - %m%n&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;Header&quot;</span> <span class="attr">value</span>=<span class="string">&quot;<span class="symbol">&amp;#13;</span><span class="symbol">&amp;#10;</span>----------------------header--------------------------<span class="symbol">&amp;#13;</span><span class="symbol">&amp;#10;</span>&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;Footer&quot;</span> <span class="attr">value</span>=<span class="string">&quot;<span class="symbol">&amp;#13;</span><span class="symbol">&amp;#10;</span>----------------------footer--------------------------<span class="symbol">&amp;#13;</span><span class="symbol">&amp;#10;</span>&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;consoleApp&quot;</span> <span class="attr">type</span>=<span class="string">&quot;log4net.Appender.ConsoleAppender,log4net&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">layout</span> <span class="attr">type</span>=<span class="string">&quot;log4net.Layout.PatternLayout,log4net&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">&quot;ConversionPattern&quot;</span> <span class="attr">value</span>=<span class="string">&quot;%d [%t] %-5p %c - %m%n&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">log4net</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--↑Log4Net配置↑--&gt;</span></span><br><span class="line">  ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="进阶配置"><a href="#进阶配置" class="headerlink" title="进阶配置"></a>进阶配置</h2><p>在配置文件中可以对日志记录的信息、格式、文件名等作出具体的配置，下面是配置信息的详解</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">configSections</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">section</span> <span class="attr">name</span>=<span class="string">&quot;log4net&quot;</span> </span></span><br><span class="line"><span class="tag">             <span class="attr">type</span>=<span class="string">&quot;log4net.Config.Log4NetConfigurationSectionHandler,log4net&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">configSections</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--站点日志配置部分--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">log4net</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">root</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!--控制级别，由低到高: ALL|DEBUG|INFO|WARN|ERROR|FATAL|OFF--&gt;</span></span><br><span class="line">      <span class="comment">&lt;!--比如定义级别为INFO，则INFO级别向下的级别，比如DEBUG日志将不会被记录--&gt;</span></span><br><span class="line">      <span class="comment">&lt;!--如果没有定义LEVEL的值，则缺省为DEBUG--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">level</span> <span class="attr">value</span>=<span class="string">&quot;ERROR&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;RollingFileAppender&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;RollingFileAppender&quot;</span> <span class="attr">type</span>=<span class="string">&quot;log4net.Appender.RollingFileAppender&quot;</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!--日志文件名开头--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">file</span> <span class="attr">value</span>=<span class="string">&quot;c:\Log\TestLog4net.TXT&quot;</span>/&gt;</span></span><br><span class="line">      <span class="comment">&lt;!--多线程时采用最小锁定--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">lockingModel</span> <span class="attr">type</span>=<span class="string">&quot;log4net.Appender.FileAppender+MinimalLock&quot;</span>/&gt;</span></span><br><span class="line">      <span class="comment">&lt;!--日期的格式，每天换一个文件记录，如不设置则永远只记录一天的日志，需设置--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">datePattern</span> <span class="attr">value</span>=<span class="string">&quot;(yyyyMMdd)&quot;</span>/&gt;</span></span><br><span class="line">      <span class="comment">&lt;!--是否追加到文件,默认为true，通常无需设置--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">appendToFile</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">      <span class="comment">&lt;!--变换的形式为日期，这种情况下每天只有一个日志--&gt;</span></span><br><span class="line">      <span class="comment">&lt;!--此时MaxSizeRollBackups和maximumFileSize的节点设置没有意义--&gt;</span></span><br><span class="line">      <span class="comment">&lt;!--&lt;rollingStyle value=&quot;Date&quot;/&gt;--&gt;</span></span><br><span class="line">      <span class="comment">&lt;!--变换的形式为日志大小--&gt;</span></span><br><span class="line">      <span class="comment">&lt;!--这种情况下MaxSizeRollBackups和maximumFileSize的节点设置才有意义--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">RollingStyle</span> <span class="attr">value</span>=<span class="string">&quot;Size&quot;</span>/&gt;</span></span><br><span class="line">      <span class="comment">&lt;!--每天记录的日志文件个数，与maximumFileSize配合使用--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">MaxSizeRollBackups</span> <span class="attr">value</span>=<span class="string">&quot;10&quot;</span>/&gt;</span></span><br><span class="line">      <span class="comment">&lt;!--每个日志文件的最大大小--&gt;</span></span><br><span class="line">      <span class="comment">&lt;!--可用的单位:KB|MB|GB--&gt;</span></span><br><span class="line">      <span class="comment">&lt;!--不要使用小数,否则会一直写入当前日志--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">maximumFileSize</span> <span class="attr">value</span>=<span class="string">&quot;2MB&quot;</span>/&gt;</span></span><br><span class="line">      <span class="comment">&lt;!--日志格式--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">layout</span> <span class="attr">type</span>=<span class="string">&quot;log4net.Layout.PatternLayout&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">conversionPattern</span> <span class="attr">value</span>=<span class="string">&quot;%date [%t]%-5p %c - %m%n&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">log4net</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>在Global文件中的Application_Start方法中开启一个线程，用于将队列中的错误信息写入日志文件。</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Threading;</span><br><span class="line"><span class="keyword">using</span> System.Web.Http;</span><br><span class="line"><span class="keyword">using</span> System.Web.Mvc;</span><br><span class="line"><span class="keyword">using</span> System.Web.Optimization;</span><br><span class="line"><span class="keyword">using</span> System.Web.Routing;</span><br><span class="line"><span class="keyword">using</span> log4net;</span><br><span class="line"><span class="keyword">using</span> PMS.WebApp.Models;</span><br><span class="line"><span class="keyword">using</span> Spring.Web.Mvc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PMS.WebApp</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 注意: 有关启用 IIS6 或 IIS7 经典模式的说明，</span></span><br><span class="line">    <span class="comment">// 请访问 http://go.microsoft.com/?LinkId=9394801</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MvcApplication</span> : <span class="title">SpringMvcApplication</span><span class="comment">//HttpApplication</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">Application_Start</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            log4net.Config.XmlConfigurator.Configure();<span class="comment">//读取Log4Net配置信息</span></span><br><span class="line">            AreaRegistration.RegisterAllAreas();</span><br><span class="line"></span><br><span class="line">            WebApiConfig.Register(GlobalConfiguration.Configuration);</span><br><span class="line">            FilterConfig.RegisterGlobalFilters(GlobalFilters.Filters);</span><br><span class="line">            RouteConfig.RegisterRoutes(RouteTable.Routes);</span><br><span class="line">            BundleConfig.RegisterBundles(BundleTable.Bundles);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//开启一个线程,扫描异常信息队列.</span></span><br><span class="line">            <span class="keyword">var</span> filePath = Server.MapPath(<span class="string">&quot;/Log/&quot;</span>);</span><br><span class="line">            ThreadPool.QueueUserWorkItem((a) =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//判断队列中是否有数据</span></span><br><span class="line">                    <span class="keyword">if</span> (Log4ExceptionAttribute.Exceptions.Any())</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="comment">//出队一条异常信息</span></span><br><span class="line">                        <span class="keyword">var</span> ex = Log4ExceptionAttribute.Exceptions.Dequeue();</span><br><span class="line">                        <span class="comment">//若异常信息不为空</span></span><br><span class="line">                        <span class="keyword">if</span> (ex == <span class="literal">null</span>) <span class="keyword">continue</span>;</span><br><span class="line">                        <span class="comment">//将异常信息写入到日志文件中</span></span><br><span class="line">                        <span class="keyword">var</span> logger = LogManager.GetLogger(<span class="string">&quot;errorMsg&quot;</span>);</span><br><span class="line">                        logger.Error(ex.ToString());</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="comment">//若异常信息队列为空，则线程休息三秒</span></span><br><span class="line">                        Thread.Sleep(<span class="number">3000</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, filePath);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>成功完成错误日志的配置。 </p>
]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
      <tags>
        <tag>MVC</tag>
        <tag>Log4Net</tag>
      </tags>
  </entry>
  <entry>
    <title>【MVC学习笔记】3.使用Spring.Net应用IOC（依赖倒置）</title>
    <url>/posts/63049.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>本篇我们将使用Spring.Net进行依赖导致。</p>
<span id="more"></span>
<p>到现在，我们已经基本搭建起了项目的框架，但是项目中还存在一个问题，就是尽管层与层之间使用了接口进行隔离，但实例化接口的时候，还是引入了接口实现类的依赖，如下面的代码：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> IUserService _userService;</span><br><span class="line"><span class="keyword">private</span> IUserService UserService</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">get</span> &#123; <span class="keyword">return</span> _userService ?? (_userService = <span class="keyword">new</span> UserService()); &#125;</span><br><span class="line">    <span class="keyword">set</span> &#123; _userService = <span class="keyword">value</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><span class="exturl" data-url="aHR0cDovL2JhaWtlLmJhaWR1LmNuL3ZpZXcvMjQ5MzIwNC5odG0=">面向接口编程<i class="fa fa-external-link-alt"></i></span>，Controller应该只依赖于站点业务层的接口，而不能依赖于具体的实现，否则，就违背了在层之间设置接口的初衷了。</p>
<p>另外，如果上层只依赖于下层的接口，在做单元测试的时候，就可以用Moq，Fakes等Mock工具来按实际需求来模拟接口的实现，就可以灵活的控制接口的返回值来对各种情况进行测试，如果依赖于具体的实现，项目的可测试性将大大减小，不利于进行自动化的单元测试。</p>
<p>要不依赖于具体的实现，就不能使用通常的 T t = new T() 的方式来获得一个类的实例了，需要通过IOC容器来对对象生命周期，依赖关系等进行统一的管理，这里，我们将使用Spring.Net应用IOC。</p>
<h3 id="Spring-Net在控制台程序中的使用"><a href="#Spring-Net在控制台程序中的使用" class="headerlink" title="Spring.Net在控制台程序中的使用"></a>Spring.Net在控制台程序中的使用</h3><p>我们将通过一个简单的控制台示例来展示Spring.Net的使用方法</p>
<p>创建测试用的类：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">SpringNetDemo</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IClass</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        Student Monitor &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="function"><span class="built_in">string</span> <span class="title">GetMsg</span>()</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Class</span> : <span class="title">IClass</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> Student Monitor &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">GetMsg</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;班级名称：&quot;</span> + Name + <span class="string">&quot;，班长：&quot;</span> + Monitor.Name;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Student</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>两个类，一个接口，Student类中有一个string类型的属性，为Name，Class类中除了string类型的Name属性外还有一个Student类型的Monitor属性，方法GetMsg可以返回当前Class对象的简介，包括班级名和班长名两个内容。Class类实现IClass接口。</p>
<p>先做简单的测试：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">IClass c6=<span class="keyword">new</span> Class()</span><br><span class="line">&#123;</span><br><span class="line">    Monitor = <span class="keyword">new</span> Student()</span><br><span class="line">    &#123;</span><br><span class="line">        Name = <span class="string">&quot;李芙蓉&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    Name = <span class="string">&quot;六班&quot;</span></span><br><span class="line">&#125;;</span><br><span class="line">Console.WriteLine(c6.GetMsg());</span><br><span class="line">Console.ReadKey();</span><br></pre></td></tr></table></figure>
<p>输出为：<br><img data-src="https://qiniucdn.wayneshao.com/20180218215235/20180218095803520.png"><br>接下来，我们<strong>换用Spring.Net容器来声明对象</strong></p>
<ol>
<li><p>首先引用dll文件<br><img data-src="https://qiniucdn.wayneshao.com/20180218215235/20180218095839887.png"><br>需要核心库Spring.Core.dll和Spring.Net使用的日志记录组件Common.Logging.dll</p>
</li>
<li><p>然后我们需要了解当前的程序集名称和命名空间<br><img data-src="https://qiniucdn.wayneshao.com/20180218215235/20180218095922038.png"></p>
</li>
<li><p>在项目中新建一个xml文件，命名为services.xml：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">objects</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.net&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span>An  example that demonstrates simple IoC features.<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">object</span> <span class="attr">name</span>=<span class="string">&quot;Class&quot;</span> <span class="attr">type</span>=<span class="string">&quot;SpringNetDemo.Class,SpringNetDemo&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;Name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;尖子班&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;Monitor&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;Student&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">object</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">object</span> <span class="attr">name</span>=<span class="string">&quot;Student&quot;</span> <span class="attr">type</span>=<span class="string">&quot;SpringNetDemo.Student, SpringNetDemo&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;Name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;陈二蛋&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">object</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">objects</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p> 在xml中新建objects根节点，其中加入需要容器生成的object子节点，object子节点的type属性中需要指明类的完整名称（带有程序集）和当前命名空间，如果需要为当前类的属性赋默认值，则可以在object节点中增加property节点，配置其value属性来为类的属性赋初值，若类的属性仍然为其他类对象时，可以新建该类型的object节点，并给予其name属性，再在当前属性的property节点中将ref属性，指向新增object节点的name属性。</p>
<p>   注意：要把xml文件设置为“如果较新则复制”或者“始终复制”，否则生成时将不会自动复制到程序目录</p>
</li>
<li><p>然后在应用程序配置文件中配置Spring.Net的信息：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">configSections</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sectionGroup</span> <span class="attr">name</span>=<span class="string">&quot;spring&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">section</span> <span class="attr">name</span>=<span class="string">&quot;context&quot;</span> <span class="attr">type</span>=<span class="string">&quot;Spring.Context.Support.ContextHandler, Spring.Core&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">section</span> <span class="attr">name</span>=<span class="string">&quot;objects&quot;</span> <span class="attr">type</span>=<span class="string">&quot;Spring.Context.Support.DefaultSectionHandler, Spring.Core&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">sectionGroup</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">configSections</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">spring</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">resource</span> <span class="attr">uri</span>=<span class="string">&quot;file://services.xml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">context</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">spring</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>运行程序，得到输出结果：<br><img data-src="https://qiniucdn.wayneshao.com/20180218215235/20180218100404037.png"></p>
</li>
</ol>
<p><strong>成功实现IOC</strong></p>
<h3 id="Spring-Net在ASP-NET-MVC中的使用"><a href="#Spring-Net在ASP-NET-MVC中的使用" class="headerlink" title="Spring.Net在ASP.NET MVC中的使用"></a>Spring.Net在ASP.NET MVC中的使用</h3><p>方法和在控制台程序中大同小异</p>
<ol>
<li>同样，首先要导入dll文件<br><img data-src="https://qiniucdn.wayneshao.com/20180218215235/20180218100505181.png"><br> MVC项目中需要引用的dll文件稍多些，需要五个，除了值钱的两个外，还需要三个Web相关的dll。</li>
<li>为了便于管理，我们在MVC项目更目录新建Config文件夹来保存配置文件，并在其中新建两个xml文件<br>controllers.xml：<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">objects</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.net&quot;</span>&gt;</span>、</span><br><span class="line">  <span class="tag">&lt;<span class="name">object</span> <span class="attr">type</span>=<span class="string">&quot;PMS.WebApp.Controllers.UserController , PMS.WebApp&quot;</span> <span class="attr">singleton</span>=<span class="string">&quot;false&quot;</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;UserService&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;UserService&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">object</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">objects</span>&gt;</span></span><br></pre></td></tr></table></figure>
 services.xml：<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">objects</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.net&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">object</span> <span class="attr">name</span>=<span class="string">&quot;UserService&quot;</span> <span class="attr">type</span>=<span class="string">&quot;PMS.BLL.UserService, PMS.BLL&quot;</span> <span class="attr">singleton</span>=<span class="string">&quot;false&quot;</span> &gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">object</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">objects</span>&gt;</span></span><br></pre></td></tr></table></figure>
   同样是出于方便管理考虑，我们将控制器和业务类分两个文件来保存，文件中节点的规则与控制台示例中完全相同。</li>
<li>修改Web.config配置文件<br><img data-src="https://qiniucdn.wayneshao.com/20180218215235/20180218100703550.png"><br> 在配置文件的configSections节点中增加如图的sectionGrup节点，configuration节点中增加Spring节点，并在spring节点中的context节点中使用resource节点设置配置文件的路径。</li>
<li>修改Global文件<br>修改根目录的Global.asax文件，将MvcApplication类的父类由HttpApplication更改为SpringMvcApplication。<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MvcApplication</span> : <span class="title">SpringMvcApplication</span><span class="comment">//HttpApplication</span></span><br></pre></td></tr></table></figure></li>
<li>最后，将原来的控制器中代码修改，就成功地在MVC项目中使用Spring.Net实现了IOC<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">//private IUserService _userService;</span></span><br><span class="line"><span class="comment">//private IUserService UserService</span></span><br><span class="line"><span class="comment">//&#123;</span></span><br><span class="line"><span class="comment">//    get &#123; return _userService ?? (_userService = new UserService()); &#125;</span></span><br><span class="line"><span class="comment">//    set &#123; _userService = value; &#125;</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"><span class="keyword">private</span> IUserService UserService &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br></pre></td></tr></table></figure></li>
</ol>
]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
      <tags>
        <tag>MVC</tag>
        <tag>Spring.Net</tag>
        <tag>IOC</tag>
      </tags>
  </entry>
  <entry>
    <title>【MVC学习笔记】6. 使用Memcache+Cookie解决分布式系统共享登录状态</title>
    <url>/posts/7556.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>为了解决单机处理的瓶颈，增强软件的可用性，我们需要将软件部署在多台服务器上启用多个二级子域名以频道化的方式，根据业务功能将网站分布部署在独立的服务器上，或通过负载均衡技术（如：DNS轮询、Radware、F5、LVS等）让多个频道共享一组服务器。当我们将网站程序分部到多台服务器上后，由于Session受实现原理的局限，无法跨服务器同步更新Session，使得登录状态难以通过Session共享。</p>
<span id="more"></span>
<p>我们使用MemCache+Cookie方案来解决分布式系统共享登录状态的问题。</p>
<p>Memcache服务器本身就是一个Socket服务端，内部数据采用键值对的形式存储在服务器的内存中，本质就是一个大型的哈希表。数据的删除采用惰性删除机制。虽然Memcache并没有提供集群功能，但是通过客户端的驱动程序很容易就可以实现Memcache的集群配置。</p>
<h2 id="Memcache使用"><a href="#Memcache使用" class="headerlink" title="Memcache使用"></a>Memcache使用</h2><ol>
<li>下载安装<span class="exturl" data-url="aHR0cDovL2NvZGUuamVsbHljYW4uY29tL01lbWNhY2hlLw==">Memcache<i class="fa fa-external-link-alt"></i></span>（Windows平台）<br> （1）将程序解压到磁盘任意位置<br> （2）进入cmd窗口，运行Memcached.exe -d install安装服务，安装后打开服务窗口查看服务是否安装成功。<br><img data-src="https://qiniucdn.wayneshao.com/20180218222028/20180218102319007.png"><br> （3）直接在服务管理中启动服务，或者使用cmd命令 net start “Memcache Server”<br> （4）使用Telnet连接到Memcache控制台，验证服务是否正常 telnet 127.0.0.1 11211<br> （5）使用stats指令查看当前Memcache服务器状态。<br>  <img data-src="https://qiniucdn.wayneshao.com/20180218222028/20180218102458126.png"></li>
<li>程序中的用法<br> （1）在程序中添加 Memcached.ClientLibrary.dll 的引用<br> （2）C#中操作Memcache的代码示例<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">String[] serverlist = &#123; <span class="string">&quot;192.168.1.100:11211&quot;</span>,</span><br><span class="line"><span class="string">&quot;192.168.1.101:11211&quot;</span>  &#125;;</span><br><span class="line"><span class="comment">// initialize the pool for memcache servers</span></span><br><span class="line">SockIOPool pool = SockIOPool.GetInstance(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">pool.SetServers(serverlist);</span><br><span class="line">pool.Initialize();</span><br><span class="line">mc = <span class="keyword">new</span> MemcacheClient();</span><br><span class="line">mc.PoolName = <span class="string">&quot;test&quot;</span>;</span><br><span class="line">mc.EnableCompression = <span class="literal">false</span>;</span><br><span class="line">pool.Shutdown();<span class="comment">//关闭连接池</span></span><br></pre></td></tr></table></figure>
<h2 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a>具体实现</h2>首先在Common层中引入<span class="exturl" data-url="aHR0cDovL3NvdXJjZWZvcmdlLm5ldC9wcm9qZWN0cy9tZW1jYWNoZWRkb3RuZXQv">Memcached.ClientLibrary.dll<i class="fa fa-external-link-alt"></i></span>，并封装Memcache的帮助类，MemcacheHelper<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> Memcached.ClientLibrary;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PMS.Common</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MemcacheHelper</span></span><br><span class="line">    &#123;</span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> MemcachedClient Mc = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">static</span> <span class="title">MemcacheHelper</span>()</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="comment">//最好放在配置文件中</span></span><br><span class="line">           <span class="built_in">string</span>[] serverlist = &#123; <span class="string">&quot;127.0.0.1:11211&quot;</span>, <span class="string">&quot;10.0.0.132:11211&quot;</span> &#125;;</span><br><span class="line"></span><br><span class="line">           <span class="comment">//初始化池</span></span><br><span class="line">           <span class="keyword">var</span> pool = SockIOPool.GetInstance();</span><br><span class="line">           pool.SetServers(serverlist);</span><br><span class="line"></span><br><span class="line">           pool.InitConnections = <span class="number">3</span>;</span><br><span class="line">           pool.MinConnections = <span class="number">3</span>;</span><br><span class="line">           pool.MaxConnections = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">           pool.SocketConnectTimeout = <span class="number">1000</span>;</span><br><span class="line">           pool.SocketTimeout = <span class="number">3000</span>;</span><br><span class="line"></span><br><span class="line">           pool.MaintenanceSleep = <span class="number">30</span>;</span><br><span class="line">           pool.Failover = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">           pool.Nagle = <span class="literal">false</span>;</span><br><span class="line">           pool.Initialize();</span><br><span class="line"></span><br><span class="line">           <span class="comment">// 获得客户端实例</span></span><br><span class="line">           Mc = <span class="keyword">new</span> MemcachedClient &#123;EnableCompression = <span class="literal">false</span>&#125;;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 存储数据</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;key&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;value&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">Set</span>(<span class="params"><span class="built_in">string</span> key,<span class="built_in">object</span> <span class="keyword">value</span></span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">          <span class="keyword">return</span> Mc.Set(key, <span class="keyword">value</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">Set</span>(<span class="params"><span class="built_in">string</span> key, <span class="built_in">object</span> <span class="keyword">value</span>,DateTime time</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">return</span> Mc.Set(key, <span class="keyword">value</span>,time);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 获取数据</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;key&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">object</span> <span class="title">Get</span>(<span class="params"><span class="built_in">string</span> key</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">return</span> Mc.Get(key);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> 删除</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;key&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">Delete</span>(<span class="params"><span class="built_in">string</span> key</span>)</span></span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">return</span> Mc.KeyExists(key) &amp;&amp; Mc.Delete(key);</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
改变用户登录方法UserLogin，用户登录成功后生成GUID，将此GUID存入Cookie并以GUID为键将登录用户信息序列化存入Memcache服务器。<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ActionResult <span class="title">UserLogin</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">#<span class="keyword">region</span> 验证码校验</span></span><br><span class="line">    <span class="keyword">var</span> validateCode = Session[<span class="string">&quot;validateCode&quot;</span>] != <span class="literal">null</span> ? Session[<span class="string">&quot;validateCode&quot;</span>].ToString() : <span class="built_in">string</span>.Empty;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrEmpty(validateCode))</span><br><span class="line">        <span class="keyword">return</span> Content(<span class="string">&quot;no:验证码错误!!&quot;</span>);</span><br><span class="line">    Session[<span class="string">&quot;validateCode&quot;</span>] = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> txtCode = Request[<span class="string">&quot;ValidateCode&quot;</span>];</span><br><span class="line">    <span class="keyword">if</span> (!validateCode.Equals(txtCode, StringComparison.InvariantCultureIgnoreCase))</span><br><span class="line">        <span class="keyword">return</span> Content(<span class="string">&quot;no:验证码错误!!&quot;</span>);</span><br><span class="line">    <span class="meta">#<span class="keyword">endregion</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> userName = Request[<span class="string">&quot;UserName&quot;</span>];</span><br><span class="line">    <span class="keyword">var</span> userPwd = Request[<span class="string">&quot;PassWord&quot;</span>];</span><br><span class="line">    <span class="comment">//查询用户是否存在</span></span><br><span class="line">    <span class="keyword">var</span> user = UserService.LoadEntities(u =&gt; u.UserName == userName &amp;&amp; u.PassWord == userPwd).FirstOrDefault();</span><br><span class="line">    <span class="keyword">if</span> (user == <span class="literal">null</span>) <span class="keyword">return</span> Content(<span class="string">&quot;no:登录失败&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//产生一个GUID值作为Memache的键.</span></span><br><span class="line">    <span class="keyword">var</span> sessionId = Guid.NewGuid().ToString();</span><br><span class="line">    <span class="comment">//将登录用户信息存储到Memcache中。</span></span><br><span class="line">    MemcacheHelper.Set(sessionId, SerializeHelper.SerializeToString(user), DateTime.Now.AddMinutes(<span class="number">20</span>));</span><br><span class="line">    <span class="comment">//将Memcache的key以Cookie的形式返回给浏览器。</span></span><br><span class="line">    Response.Cookies[<span class="string">&quot;sessionId&quot;</span>].Value = sessionId;</span><br><span class="line">    <span class="keyword">return</span> Content(<span class="string">&quot;ok:登录成功&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
改变登录校验控制器FilterController的OnActionExecuting方法，使其校验方式改为从Memcache服务器中读取Cookie中值为键的对象：<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnActionExecuting</span>(<span class="params">ActionExecutingContext filterContext</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">base</span>.OnActionExecuting(filterContext);</span><br><span class="line">    <span class="comment">//if (Session[&quot;user&quot;] == null)</span></span><br><span class="line">    <span class="keyword">if</span> (Request.Cookies[<span class="string">&quot;sessionId&quot;</span>] != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> sessionId = Request.Cookies[<span class="string">&quot;sessionId&quot;</span>].Value;</span><br><span class="line">        <span class="comment">//根据该值查Memcache.</span></span><br><span class="line">        <span class="keyword">var</span> obj = MemcacheHelper.Get(sessionId);</span><br><span class="line">        <span class="keyword">if</span> (obj == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            filterContext.Result = Redirect(<span class="string">&quot;/Login/Index&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> user = SerializeHelper.DeserializeToObject&lt;User&gt;(obj.ToString());</span><br><span class="line">        LoginUser = user;</span><br><span class="line">        <span class="comment">//模拟出滑动过期时间.</span></span><br><span class="line">        MemcacheHelper.Set(sessionId, obj, DateTime.Now.AddMinutes(<span class="number">20</span>)); </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        filterContext.Result = Redirect(<span class="string">&quot;/Login/Index&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
      <tags>
        <tag>MVC</tag>
        <tag>Memcache</tag>
        <tag>分布式</tag>
      </tags>
  </entry>
  <entry>
    <title>【单例】使用同步基元变量来检测程序是否已运行</title>
    <url>/posts/16660.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 应用程序的主入口点。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">STAThread</span>]</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> instance = <span class="keyword">new</span> Mutex(<span class="literal">true</span>, <span class="string">&quot;SingleStart&quot;</span>, <span class="keyword">out</span> <span class="built_in">bool</span> createdNew); <span class="comment">//同步基元变量   </span></span><br><span class="line">        <span class="keyword">if</span> (createdNew)</span><br><span class="line">        &#123;</span><br><span class="line">            Application.Run(<span class="keyword">new</span> Form());</span><br><span class="line">            instance.ReleaseMutex();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Application.Exit();</span><br><span class="line">        &#125;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<span id="more"></span>]]></content>
      <categories>
        <category>踩坑笔记</category>
      </categories>
      <tags>
        <tag>C#</tag>
        <tag>Winform</tag>
        <tag>单例</tag>
      </tags>
  </entry>
  <entry>
    <title>【MVC学习笔记】7.使用极验验证来制作更高逼格的验证码</title>
    <url>/posts/47398.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>在之前的项目中，如果有需要使用验证码，基本都是自己用GDI+画图出来，简单好用，但是却也存在了一些小问题，首先若较少干扰线，则安全性不是很高，验证码容易被机器识别，若多画太多干扰线条，机器人识别率下降的同时，人眼的识别率也同步下降（震惊哭）。更为重要的是，GDI+绘制的验证码一般来说也不会很美观，如果做一个炫酷的登陆界面却配了这样一个验证码，画风诡异，丑到极致。</p>
<p>再后来浏览网页的过程中，发现很多很多网站项目中都使用了一种叫极验验证的验证码，采用移动滑块的方式进行验证，方便美观。而一番搜索之后了解到，官方提供的免费版也足以应付我手头的大多数项目了，不禁想把在MVC学习过程中试着使用极验验证来作为登录的验证码。</p>
<span id="more"></span>
<p>极验官方提供了<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0dlZVRlYW0vZ3QtY3NoYXJwLXNkaw==">C#的SDK和Demo<i class="fa fa-external-link-alt"></i></span>供开发者参考，不过是Webform版本的，可读性不是很高，而现在使用Webform进行网站开发的也基本消失了，我将在官方Webform代码的基础上，将其用在ASP.NET MVC程序中。</p>
<h2 id="注册极验"><a href="#注册极验" class="headerlink" title="注册极验"></a>注册极验</h2><p>到极验官网注册账号之后进入后台管理界面，点击添加验证<br><img data-src="https://qiniucdn.wayneshao.com/20180218223716/20180218103931147.png"><br>添加后我们可以得到ID和KEY<br><img data-src="https://qiniucdn.wayneshao.com/20180218223716/20180218103949448.png"></p>
<h2 id="完成验证逻辑"><a href="#完成验证逻辑" class="headerlink" title="完成验证逻辑"></a>完成验证逻辑</h2><h3 id="首先我们需要引入官方的Geetestlib类"><a href="#首先我们需要引入官方的Geetestlib类" class="headerlink" title="首先我们需要引入官方的Geetestlib类"></a>首先我们需要引入官方的<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0dlZVRlYW0vZ3QtY3NoYXJwLXNkay9ibG9iL21hc3Rlci9zcmMvR2VldGVzdFNESy9HZWV0ZXN0U0RLL0dlZXRlc3RMaWIuY3M=">Geetestlib类<i class="fa fa-external-link-alt"></i></span></h3><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Security.Cryptography;</span><br><span class="line"><span class="keyword">using</span> System.Net;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PMS.WebApp.Models</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> GeetestLib 极验验证C# SDK基本库</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GeetestLib</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> SDK版本号</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">const</span> String version = <span class="string">&quot;3.2.0&quot;</span>;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> SDK开发语言</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">const</span> String sdkLang = <span class="string">&quot;csharp&quot;</span>;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 极验验证API URL</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">const</span> String apiUrl = <span class="string">&quot;http://api.geetest.com&quot;</span>;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> register url</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">const</span> String registerUrl = <span class="string">&quot;/register.php&quot;</span>;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> validate url</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">const</span> String validateUrl = <span class="string">&quot;/validate.php&quot;</span>;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 极验验证API服务状态Session Key</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">const</span> String gtServerStatusSessionKey = <span class="string">&quot;gt_server_status&quot;</span>;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 极验验证二次验证表单数据 Chllenge</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">const</span> String fnGeetestChallenge = <span class="string">&quot;geetest_challenge&quot;</span>;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 极验验证二次验证表单数据 Validate</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">const</span> String fnGeetestValidate = <span class="string">&quot;geetest_validate&quot;</span>;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 极验验证二次验证表单数据 Seccode</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">const</span> String fnGeetestSeccode = <span class="string">&quot;geetest_seccode&quot;</span>;</span><br><span class="line">        <span class="keyword">private</span> String userID = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">private</span> String responseStr = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">private</span> String captchaID = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">private</span> String privateKey = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 验证成功结果字符串</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">int</span> successResult = <span class="number">1</span>;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 证结失败验果字符串</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">int</span> failResult = <span class="number">0</span>;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 判定为机器人结果字符串</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">const</span> String forbiddenResult = <span class="string">&quot;forbidden&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> GeetestLib构造函数</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;publicKey&quot;&gt;</span>极验验证公钥<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;privateKey&quot;&gt;</span>极验验证私钥<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">GeetestLib</span>(<span class="params">String publicKey, String privateKey</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.privateKey = privateKey;</span><br><span class="line">            <span class="keyword">this</span>.captchaID = publicKey;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="built_in">int</span> <span class="title">getRandomNum</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            Random rand =<span class="keyword">new</span> Random();</span><br><span class="line">            <span class="built_in">int</span> randRes = rand.Next(<span class="number">100</span>);</span><br><span class="line">            <span class="keyword">return</span> randRes;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 验证初始化预处理</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>初始化结果<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Byte <span class="title">preProcess</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.captchaID == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;publicKey is null!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                String challenge = <span class="keyword">this</span>.registerChallenge();</span><br><span class="line">                <span class="keyword">if</span> (challenge.Length == <span class="number">32</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">this</span>.getSuccessPreProcessRes(challenge);</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">this</span>.getFailPreProcessRes();</span><br><span class="line">                    Console.WriteLine(<span class="string">&quot;Server regist challenge failed!&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> Byte <span class="title">preProcess</span>(<span class="params">String userID</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.captchaID == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;publicKey is null!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">this</span>.userID = userID;</span><br><span class="line">                String challenge = <span class="keyword">this</span>.registerChallenge();</span><br><span class="line">                <span class="keyword">if</span> (challenge.Length == <span class="number">32</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">this</span>.getSuccessPreProcessRes(challenge);</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">this</span>.getFailPreProcessRes();</span><br><span class="line">                    Console.WriteLine(<span class="string">&quot;Server regist challenge failed!&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getResponseStr</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.responseStr;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 预处理失败后的返回格式串</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">getFailPreProcessRes</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">int</span> rand1 = <span class="keyword">this</span>.getRandomNum();</span><br><span class="line">            <span class="built_in">int</span> rand2 = <span class="keyword">this</span>.getRandomNum();</span><br><span class="line">            String md5Str1 = <span class="keyword">this</span>.md5Encode(rand1 + <span class="string">&quot;&quot;</span>);</span><br><span class="line">            String md5Str2 = <span class="keyword">this</span>.md5Encode(rand2 + <span class="string">&quot;&quot;</span>);</span><br><span class="line">            String challenge = md5Str1 + md5Str2.Substring(<span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line">            <span class="keyword">this</span>.responseStr = <span class="string">&quot;&#123;&quot;</span> + <span class="built_in">string</span>.Format(</span><br><span class="line">                 <span class="string">&quot;\&quot;success\&quot;:&#123;0&#125;,\&quot;gt\&quot;:\&quot;&#123;1&#125;\&quot;,\&quot;challenge\&quot;:\&quot;&#123;2&#125;\&quot;&quot;</span>, <span class="number">0</span>,</span><br><span class="line">                <span class="keyword">this</span>.captchaID, challenge) + <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 预处理成功后的标准串</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">getSuccessPreProcessRes</span>(<span class="params">String challenge</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            challenge = <span class="keyword">this</span>.md5Encode(challenge + <span class="keyword">this</span>.privateKey);</span><br><span class="line">            <span class="keyword">this</span>.responseStr =<span class="string">&quot;&#123;&quot;</span> + <span class="built_in">string</span>.Format(</span><br><span class="line">                <span class="string">&quot;\&quot;success\&quot;:&#123;0&#125;,\&quot;gt\&quot;:\&quot;&#123;1&#125;\&quot;,\&quot;challenge\&quot;:\&quot;&#123;2&#125;\&quot;&quot;</span>, <span class="number">1</span>, </span><br><span class="line">                <span class="keyword">this</span>.captchaID, challenge) + <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> failback模式的验证方式</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;challenge&quot;&gt;</span>failback模式下用于与validate一起解码答案， 判断验证是否正确<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;validate&quot;&gt;</span>failback模式下用于与challenge一起解码答案， 判断验证是否正确<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;seccode&quot;&gt;</span>failback模式下，其实是个没用的参数<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>验证结果<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">failbackValidateRequest</span>(<span class="params">String challenge, String validate, String seccode</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">this</span>.requestIsLegal(challenge, validate, seccode)) <span class="keyword">return</span> GeetestLib.failResult;</span><br><span class="line">            String[] validateStr = validate.Split(<span class="string">&#x27;_&#x27;</span>);</span><br><span class="line">            String encodeAns = validateStr[<span class="number">0</span>];</span><br><span class="line">            String encodeFullBgImgIndex = validateStr[<span class="number">1</span>];</span><br><span class="line">            String encodeImgGrpIndex = validateStr[<span class="number">2</span>];</span><br><span class="line">            <span class="built_in">int</span> decodeAns = <span class="keyword">this</span>.decodeResponse(challenge, encodeAns);</span><br><span class="line">            <span class="built_in">int</span> decodeFullBgImgIndex = <span class="keyword">this</span>.decodeResponse(challenge, encodeFullBgImgIndex);</span><br><span class="line">            <span class="built_in">int</span> decodeImgGrpIndex = <span class="keyword">this</span>.decodeResponse(challenge, encodeImgGrpIndex);</span><br><span class="line">            <span class="built_in">int</span> validateResult = <span class="keyword">this</span>.validateFailImage(decodeAns, decodeFullBgImgIndex, decodeImgGrpIndex);</span><br><span class="line">            <span class="keyword">return</span> validateResult;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="built_in">int</span> <span class="title">validateFailImage</span>(<span class="params"><span class="built_in">int</span> ans, <span class="built_in">int</span> full_bg_index, <span class="built_in">int</span> img_grp_index</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">const</span> <span class="built_in">int</span> thread = <span class="number">3</span>;</span><br><span class="line">            String full_bg_name = <span class="keyword">this</span>.md5Encode(full_bg_index + <span class="string">&quot;&quot;</span>).Substring(<span class="number">0</span>, <span class="number">10</span>);</span><br><span class="line">            String bg_name = md5Encode(img_grp_index + <span class="string">&quot;&quot;</span>).Substring(<span class="number">10</span>, <span class="number">10</span>);</span><br><span class="line">            String answer_decode = <span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>;i &lt; <span class="number">9</span>; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (i % <span class="number">2</span> == <span class="number">0</span>) answer_decode += full_bg_name.ElementAt(i);</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (i % <span class="number">2</span> == <span class="number">1</span>) answer_decode += bg_name.ElementAt(i);</span><br><span class="line">            &#125;</span><br><span class="line">            String x_decode = answer_decode.Substring(<span class="number">4</span>);</span><br><span class="line">            <span class="built_in">int</span> x_int = Convert.ToInt32(x_decode, <span class="number">16</span>);</span><br><span class="line">            <span class="built_in">int</span> result = x_int % <span class="number">200</span>;</span><br><span class="line">            <span class="keyword">if</span> (result &lt; <span class="number">40</span>) result = <span class="number">40</span>;</span><br><span class="line">            <span class="keyword">if</span> (Math.Abs(ans - result) &lt; thread) <span class="keyword">return</span> GeetestLib.successResult;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">return</span> GeetestLib.failResult;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">private</span> Boolean <span class="title">requestIsLegal</span>(<span class="params">String challenge, String validate, String seccode</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (challenge.Equals(<span class="built_in">string</span>.Empty) || validate.Equals(<span class="built_in">string</span>.Empty) || seccode.Equals(<span class="built_in">string</span>.Empty)) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 向gt-server进行二次验证</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;challenge&quot;&gt;</span>本次验证会话的唯一标识<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;validate&quot;&gt;</span>拖动完成后server端返回的验证结果标识字符串<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;seccode&quot;&gt;</span>验证结果的校验码，如果gt-server返回的不与这个值相等则表明验证失败<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>二次验证结果<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">enhencedValidateRequest</span>(<span class="params">String challenge, String validate, String seccode</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">this</span>.requestIsLegal(challenge, validate, seccode)) <span class="keyword">return</span> GeetestLib.failResult;</span><br><span class="line">            <span class="keyword">if</span> (validate.Length &gt; <span class="number">0</span> &amp;&amp; checkResultByPrivate(challenge, validate))</span><br><span class="line">            &#123;</span><br><span class="line">                String query = <span class="string">&quot;seccode=&quot;</span> + seccode + <span class="string">&quot;&amp;sdk=csharp_&quot;</span> + GeetestLib.version;</span><br><span class="line">                String response = <span class="string">&quot;&quot;</span>;</span><br><span class="line">                <span class="keyword">try</span></span><br><span class="line">                &#123;</span><br><span class="line">                    response = postValidate(query);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span> (Exception e)</span><br><span class="line">                &#123;</span><br><span class="line">                    Console.WriteLine(e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (response.Equals(md5Encode(seccode)))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> GeetestLib.successResult;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> GeetestLib.failResult;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">enhencedValidateRequest</span>(<span class="params">String challenge, String validate, String seccode, String userID</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">this</span>.requestIsLegal(challenge, validate, seccode)) <span class="keyword">return</span> GeetestLib.failResult;</span><br><span class="line">            <span class="keyword">if</span> (validate.Length &gt; <span class="number">0</span> &amp;&amp; checkResultByPrivate(challenge, validate))</span><br><span class="line">            &#123;</span><br><span class="line">                String query = <span class="string">&quot;seccode=&quot;</span> + seccode + <span class="string">&quot;&amp;user_id=&quot;</span> + userID + <span class="string">&quot;&amp;sdk=csharp_&quot;</span> + GeetestLib.version;</span><br><span class="line">                String response = <span class="string">&quot;&quot;</span>;</span><br><span class="line">                <span class="keyword">try</span></span><br><span class="line">                &#123;</span><br><span class="line">                    response = postValidate(query);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span> (Exception e)</span><br><span class="line">                &#123;</span><br><span class="line">                    Console.WriteLine(e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (response.Equals(md5Encode(seccode)))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> GeetestLib.successResult;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> GeetestLib.failResult;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">private</span> String <span class="title">readContentFromGet</span>(<span class="params">String url</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                HttpWebRequest request = (HttpWebRequest)WebRequest.Create(url);</span><br><span class="line">                request.Timeout = <span class="number">20000</span>;</span><br><span class="line">                HttpWebResponse response = (HttpWebResponse)request.GetResponse();</span><br><span class="line">                Stream myResponseStream = response.GetResponseStream();</span><br><span class="line">                StreamReader myStreamReader = <span class="keyword">new</span> StreamReader(myResponseStream, Encoding.GetEncoding(<span class="string">&quot;utf-8&quot;</span>));</span><br><span class="line">                String retString = myStreamReader.ReadToEnd();</span><br><span class="line">                myStreamReader.Close();</span><br><span class="line">                myResponseStream.Close();</span><br><span class="line">                <span class="keyword">return</span> retString;</span><br><span class="line">            &#125;</span><br><span class="line">           <span class="keyword">catch</span></span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;     </span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">private</span> String <span class="title">registerChallenge</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            String url = <span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">string</span>.Empty.Equals(<span class="keyword">this</span>.userID))</span><br><span class="line">            &#123;</span><br><span class="line">                url = <span class="built_in">string</span>.Format(<span class="string">&quot;&#123;0&#125;&#123;1&#125;?gt=&#123;2&#125;&quot;</span>, GeetestLib.apiUrl, GeetestLib.registerUrl, <span class="keyword">this</span>.captchaID);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                url = <span class="built_in">string</span>.Format(<span class="string">&quot;&#123;0&#125;&#123;1&#125;?gt=&#123;2&#125;&amp;user_id=&#123;3&#125;&quot;</span>, GeetestLib.apiUrl, GeetestLib.registerUrl, <span class="keyword">this</span>.captchaID, <span class="keyword">this</span>.userID);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">string</span> retString = <span class="keyword">this</span>.readContentFromGet(url);</span><br><span class="line">            <span class="keyword">return</span> retString;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">private</span> Boolean <span class="title">checkResultByPrivate</span>(<span class="params">String origin, String validate</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            String encodeStr = md5Encode(privateKey + <span class="string">&quot;geetest&quot;</span> + origin);</span><br><span class="line">            <span class="keyword">return</span> validate.Equals(encodeStr);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">private</span> String <span class="title">postValidate</span>(<span class="params">String data</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            String url = <span class="built_in">string</span>.Format(<span class="string">&quot;&#123;0&#125;&#123;1&#125;&quot;</span>, GeetestLib.apiUrl, GeetestLib.validateUrl);</span><br><span class="line">            HttpWebRequest request = (HttpWebRequest)WebRequest.Create(url);</span><br><span class="line">            request.Method = <span class="string">&quot;POST&quot;</span>;</span><br><span class="line">            request.ContentType = <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>;</span><br><span class="line">            request.ContentLength = Encoding.UTF8.GetByteCount(data);</span><br><span class="line">            <span class="comment">// 发送数据</span></span><br><span class="line">            Stream myRequestStream = request.GetRequestStream();</span><br><span class="line">            <span class="built_in">byte</span>[] requestBytes = System.Text.Encoding.ASCII.GetBytes(data);</span><br><span class="line">            myRequestStream.Write(requestBytes, <span class="number">0</span>, requestBytes.Length);</span><br><span class="line">            myRequestStream.Close();</span><br><span class="line"></span><br><span class="line">            HttpWebResponse response = (HttpWebResponse)request.GetResponse();</span><br><span class="line">            <span class="comment">// 读取返回信息</span></span><br><span class="line">            Stream myResponseStream = response.GetResponseStream();</span><br><span class="line">            StreamReader myStreamReader = <span class="keyword">new</span> StreamReader(myResponseStream, Encoding.GetEncoding(<span class="string">&quot;utf-8&quot;</span>));</span><br><span class="line">            <span class="built_in">string</span> retString = myStreamReader.ReadToEnd();</span><br><span class="line">            myStreamReader.Close();</span><br><span class="line">            myResponseStream.Close();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> retString;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="built_in">int</span> <span class="title">decodeRandBase</span>(<span class="params">String challenge</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            String baseStr = challenge.Substring(<span class="number">32</span>, <span class="number">2</span>);</span><br><span class="line">            List&lt;<span class="built_in">int</span>&gt; tempList = <span class="keyword">new</span> List&lt;<span class="built_in">int</span>&gt;();</span><br><span class="line">            <span class="keyword">for</span>(<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; baseStr.Length; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">int</span> tempAscii = (<span class="built_in">int</span>)baseStr[i];</span><br><span class="line">                tempList.Add((tempAscii &gt; <span class="number">57</span>) ? (tempAscii - <span class="number">87</span>)</span><br><span class="line">                    : (tempAscii - <span class="number">48</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">int</span> result = tempList.ElementAt(<span class="number">0</span>) * <span class="number">36</span> + tempList.ElementAt(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="built_in">int</span> <span class="title">decodeResponse</span>(<span class="params">String challenge, String str</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (str.Length&gt;<span class="number">100</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            <span class="built_in">int</span>[] shuzi = <span class="keyword">new</span> <span class="built_in">int</span>[] &#123; <span class="number">1</span>, <span class="number">2</span>, <span class="number">5</span>, <span class="number">10</span>, <span class="number">50</span>&#125;;</span><br><span class="line">            String chongfu = <span class="string">&quot;&quot;</span>;</span><br><span class="line">            Hashtable key = <span class="keyword">new</span> Hashtable();</span><br><span class="line">            <span class="built_in">int</span> count = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i=<span class="number">0</span>;i&lt;challenge.Length;i++)</span><br><span class="line">            &#123;</span><br><span class="line">                String item = challenge.ElementAt(i) + <span class="string">&quot;&quot;</span>;</span><br><span class="line">                <span class="keyword">if</span> (chongfu.Contains(item)) <span class="keyword">continue</span>;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">int</span> <span class="keyword">value</span> = shuzi[count % <span class="number">5</span>];</span><br><span class="line">                    chongfu += item;</span><br><span class="line">                    count++;</span><br><span class="line">                    key.Add(item, <span class="keyword">value</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">int</span> res = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; str.Length; i++) res += (<span class="built_in">int</span>)key[str[i]+<span class="string">&quot;&quot;</span>];</span><br><span class="line">            res = res - <span class="keyword">this</span>.decodeRandBase(challenge);</span><br><span class="line">            <span class="keyword">return</span> res;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">private</span> String <span class="title">md5Encode</span>(<span class="params">String plainText</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            MD5CryptoServiceProvider md5 = <span class="keyword">new</span> MD5CryptoServiceProvider();</span><br><span class="line">            <span class="built_in">string</span> t2 = BitConverter.ToString(md5.ComputeHash(UTF8Encoding.Default.GetBytes(plainText)));</span><br><span class="line">            t2 = t2.Replace(<span class="string">&quot;-&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">            t2 = t2.ToLower();</span><br><span class="line">            <span class="keyword">return</span> t2;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="获取验证码"><a href="#获取验证码" class="headerlink" title="获取验证码"></a>获取验证码</h3><p>引入Jquery库</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;~/Content/plugins/jquery/jquery-1.8.2.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>添加用于放置验证码的div（需要放到form表单中）</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;geetest-container&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>添加JS代码用于获取验证码</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;load&#x27;</span>, processGeeTest);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">function</span> <span class="title function_">processGeeTest</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        $.<span class="title function_">ajax</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 获取id，challenge，success（是否启用failback）</span></span></span><br><span class="line"><span class="language-javascript">            <span class="attr">url</span>: <span class="string">&quot;/Login/GeekTest&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">type</span>: <span class="string">&quot;get&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">dataType</span>: <span class="string">&quot;json&quot;</span>, <span class="comment">// 使用jsonp格式</span></span></span><br><span class="line"><span class="language-javascript">            <span class="attr">success</span>: <span class="keyword">function</span> (<span class="params">data</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">// 使用initGeetest接口</span></span></span><br><span class="line"><span class="language-javascript">                <span class="comment">// 参数1：配置参数，与创建Geetest实例时接受的参数一致</span></span></span><br><span class="line"><span class="language-javascript">                <span class="comment">// 参数2：回调，回调的第一个参数验证码对象，之后可以使用它做appendTo之类的事件</span></span></span><br><span class="line"><span class="language-javascript">                <span class="title function_">initGeetest</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">gt</span>: data.<span class="property">gt</span>,</span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">challenge</span>: data.<span class="property">challenge</span>,</span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">product</span>: <span class="string">&quot;float&quot;</span>, <span class="comment">// 产品形式</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">offline</span>: !data.<span class="property">success</span></span></span><br><span class="line"><span class="language-javascript">                &#125;,</span></span><br><span class="line"><span class="language-javascript">                    handler);</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> handler = <span class="keyword">function</span> (<span class="params">captchaObj</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 将验证码加到id为captcha的元素里</span></span></span><br><span class="line"><span class="language-javascript">        captchaObj.<span class="title function_">appendTo</span>(<span class="string">&quot;#geetest-container&quot;</span>);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        captchaObj.<span class="property">onSuccess</span> = <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(e);</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    &#125;;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>processGeeTest方法中我们异步请求的地址“/Login/GeekTest”就是获取验证码是后台需要执行的方法</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ActionResult <span class="title">GeekTest</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> Content(GetCaptcha(),<span class="string">&quot;application/json&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="built_in">string</span> <span class="title">GetCaptcha</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> geetest = <span class="keyword">new</span> GeetestLib(<span class="string">&quot;3594e0d834df77cedc7351a02b5b06a4&quot;</span>, <span class="string">&quot;b961c8081ce88af7e32a3f45d00dff84&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> gtServerStatus = geetest.preProcess();</span><br><span class="line">    Session[GeetestLib.gtServerStatusSessionKey] = gtServerStatus;</span><br><span class="line">    <span class="keyword">return</span> geetest.getResponseStr();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="校验验证码"><a href="#校验验证码" class="headerlink" title="校验验证码"></a>校验验证码</h3><p>注意，当提交form表单时，会将三个和极验有关的参数传到后台方法（geetest_challenge、geetest_validate、geetest_seccode），若验证码未验证成功，则参数为空值。</p>
<p>后台验证方法为：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">CheckGeeTestResult</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> geetest = <span class="keyword">new</span> GeetestLib(<span class="string">&quot;3594e0d834df77cedc7351a02b5b06a4&quot;</span>, <span class="string">&quot;b961c8081ce88af7e32a3f45d00dff84 &quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> gtServerStatusCode = (<span class="built_in">byte</span>)Session[GeetestLib.gtServerStatusSessionKey];</span><br><span class="line">    <span class="keyword">var</span> userId = (<span class="built_in">string</span>)Session[<span class="string">&quot;userID&quot;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> challenge = Request.Form.Get(GeetestLib.fnGeetestChallenge);</span><br><span class="line">    <span class="keyword">var</span> validate = Request.Form.Get(GeetestLib.fnGeetestValidate);</span><br><span class="line">    <span class="keyword">var</span> seccode = Request.Form.Get(GeetestLib.fnGeetestSeccode);</span><br><span class="line">    <span class="keyword">var</span> result = gtServerStatusCode == <span class="number">1</span> ? geetest.enhencedValidateRequest(challenge, validate, seccode, userId) : geetest.failbackValidateRequest(challenge, validate, seccode);</span><br><span class="line">    <span class="keyword">return</span> result == <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以在表单中判断验证码是否成功校验：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ActionResult <span class="title">Login</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!CheckGeeTestResult())</span><br><span class="line">        <span class="keyword">return</span> Content(<span class="string">&quot;no:请先完成验证操作。&quot;</span>);</span><br><span class="line">    ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
      <tags>
        <tag>MVC</tag>
        <tag>验证码</tag>
      </tags>
  </entry>
  <entry>
    <title>【代码仓库】命名风格转化</title>
    <url>/posts/9410.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>一个关于将名称在不同命名风格之间转换的帮助类</p>
<span id="more"></span>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 系统扩展 - 命名风格</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">Extensions</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">int</span> LetterUpperLowerDistance = <span class="string">&#x27;a&#x27;</span> - <span class="string">&#x27;A&#x27;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ExpiredCache&lt;<span class="built_in">string</span>, NamingStyle&gt; _cache = <span class="keyword">new</span> ExpiredCache&lt;<span class="built_in">string</span>, NamingStyle&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 获取字符串的命名规范</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 支持类型：UpperCamel、lowerCamel、AllUpper、AllLower、FirstUpper</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;name&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;prefix&quot;&gt;</span>前缀<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;suffix&quot;&gt;</span>后缀<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> NamingStyle <span class="title">GetNamingStyle</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">string</span> name, <span class="built_in">string</span> prefix = <span class="string">&quot;&quot;</span>, <span class="built_in">string</span> suffix = <span class="string">&quot;&quot;</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (_cache.ContainsKey(name))</span><br><span class="line">            <span class="keyword">return</span> _cache[name];</span><br><span class="line">        <span class="comment">//移除前后缀</span></span><br><span class="line">        name = name.RemovePrefix(prefix);</span><br><span class="line">        name = name.RemoveSuffix(suffix);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> type = GetNamingStyle(name);</span><br><span class="line">        _cache[name] = type;</span><br><span class="line">        <span class="keyword">return</span> type;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> NamingStyle <span class="title">GetNamingStyle</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">string</span> name</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果含有下划线字符</span></span><br><span class="line">        <span class="keyword">if</span> (name.Contains(<span class="string">&quot;_&quot;</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (name.IsRegexMatch(<span class="string">&quot;^[A-Z_]+$&quot;</span>, RegexOptions.Compiled | RegexOptions.Singleline))</span><br><span class="line">                <span class="keyword">return</span> NamingStyle.AllUpper;</span><br><span class="line">            <span class="keyword">if</span> (name.IsRegexMatch(<span class="string">&quot;^[a-z_]+$&quot;</span>, RegexOptions.Compiled | RegexOptions.Singleline))</span><br><span class="line">                <span class="keyword">return</span> NamingStyle.AllLower;</span><br><span class="line">            <span class="keyword">if</span> (name[<span class="number">0</span>].IsUpperLetter() &amp;&amp; name.Substring(<span class="number">1</span>).IsRegexMatch(<span class="string">&quot;^[a-z_]+$&quot;</span>, RegexOptions.Compiled | RegexOptions.Singleline))</span><br><span class="line">                <span class="keyword">return</span> NamingStyle.FirstUpper;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> NamingStyle.NonStandard;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (name.IsRegexMatch(<span class="string">&quot;^[A-Z]+$&quot;</span>, RegexOptions.Compiled | RegexOptions.Singleline))</span><br><span class="line">            <span class="keyword">return</span> NamingStyle.AllUpper;</span><br><span class="line">        <span class="keyword">if</span> (name.IsRegexMatch(<span class="string">&quot;^[a-z]+$&quot;</span>, RegexOptions.Compiled | RegexOptions.Singleline))</span><br><span class="line">            <span class="keyword">return</span> NamingStyle.AllLower;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!name.IsRegexMatch(<span class="string">&quot;^[A-Za-z]+$&quot;</span>, RegexOptions.Compiled | RegexOptions.Singleline)) <span class="keyword">return</span> NamingStyle.NonStandard;</span><br><span class="line">        <span class="keyword">return</span> name[<span class="number">0</span>].IsUpperLetter() ? NamingStyle.UpperCamel : NamingStyle.LowerCamel;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 转换字符串命名规范</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 支持类型：UpperCamel、lowerCamel、AllUpper、AllLower、FirstUpper</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;name&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;toStyle&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;prefix&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;suffix&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">ConvertNamingStyle</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">string</span> name, NamingStyle toStyle, <span class="built_in">string</span> prefix = <span class="string">&quot;&quot;</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="built_in">string</span> suffix = <span class="string">&quot;&quot;</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//移除前后缀</span></span><br><span class="line">        name = name.RemovePrefix(prefix);</span><br><span class="line">        name = name.RemoveSuffix(suffix);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (name.GetNamingStyle() == NamingStyle.NonStandard)</span><br><span class="line">            <span class="keyword">return</span> name;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> toName = toStyle <span class="keyword">switch</span></span><br><span class="line">        &#123;</span><br><span class="line">            NamingStyle.LowerCamel =&gt; name.ToLowerCamel(),</span><br><span class="line">            NamingStyle.AllUpper =&gt; name.ToAllUpper(),</span><br><span class="line">            NamingStyle.AllLower =&gt; name.ToAllLower(),</span><br><span class="line">            NamingStyle.FirstUpper =&gt; name.ToFirstUpper(),</span><br><span class="line">            NamingStyle.UpperCamel =&gt; name.ToUpperCamel(),</span><br><span class="line">            _ =&gt; name</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">$&quot;<span class="subst">&#123;prefix&#125;</span><span class="subst">&#123;toName&#125;</span><span class="subst">&#123;suffix&#125;</span>&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//UpperCamel To Other</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">UpperCamelToLowerCamel</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">string</span> name</span>)</span> =&gt; !name.IsUpperCamel() ? name : (<span class="built_in">char</span>)(name[<span class="number">0</span>] + LetterUpperLowerDistance) + name.Substring(<span class="number">1</span>);</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">UpperCamelToAllUpper</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">string</span> name</span>)</span> =&gt; !name.IsUpperCamel() ? name : <span class="built_in">string</span>.Join(<span class="string">&#x27;_&#x27;</span>, name.UpperCamelSplit().Select(letter =&gt; letter.ToUpper()));</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">UpperCamelToAllLower</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">string</span> name</span>)</span> =&gt; !name.IsUpperCamel() ? name : <span class="built_in">string</span>.Join(<span class="string">&#x27;_&#x27;</span>, name.UpperCamelSplit().Select(letter =&gt; letter.ToLower()));</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">UpperCamelToFirstUpper</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">string</span> name</span>)</span> =&gt; !name.IsUpperCamel() ? name : name[<span class="number">0</span>] + name.UpperCamelToAllLower().Substring(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//LowerCamel To Other</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">LowerCamelToUpperCamel</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">string</span> name</span>)</span> =&gt; !name.IsLowerCamel() ? name : (<span class="built_in">char</span>)(name[<span class="number">0</span>] - LetterUpperLowerDistance) + name.Substring(<span class="number">1</span>);</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">LowerCamelToAllUpper</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">string</span> name</span>)</span> =&gt; !name.IsLowerCamel() ? name : name.LowerCamelToUpperCamel().UpperCamelToAllUpper();</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">LowerCamelToAllLower</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">string</span> name</span>)</span> =&gt; !name.IsLowerCamel() ? name : name.LowerCamelToUpperCamel().UpperCamelToAllLower();</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">LowerCamelToFirstUpper</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">string</span> name</span>)</span> =&gt; !name.IsLowerCamel() ? name : (<span class="built_in">char</span>)(name[<span class="number">0</span>] - LetterUpperLowerDistance) + name.LowerCamelToUpperCamel().UpperCamelToFirstUpper().Substring(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//AllUpper To Other</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">AllUpperToUpperCamel</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">string</span> name</span>)</span> =&gt; !name.IsAllUpper() ? name : <span class="built_in">string</span>.Join(<span class="string">&quot;&quot;</span>, name.Split(<span class="string">&#x27;_&#x27;</span>).Select(ToFirstUpperStyle));</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">AllUpperToLowerCamel</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">string</span> name</span>)</span> =&gt; !name.IsAllUpper() ? name : (<span class="built_in">char</span>)(name[<span class="number">0</span>] + LetterUpperLowerDistance) + name.AllUpperToUpperCamel().Substring(<span class="number">1</span>);</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">AllUpperToAllLower</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">string</span> name</span>)</span> =&gt; !name.IsAllUpper() ? name : name.ToLower();</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">AllUpperToFirstUpper</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">string</span> name</span>)</span> =&gt; !name.IsAllUpper() ? name : name[<span class="number">0</span>] + name.AllUpperToAllLower().Substring(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//AllLower To Other</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">AllLowerToUpperCamel</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">string</span> name</span>)</span> =&gt; !name.IsAllLower() ? name : <span class="built_in">string</span>.Join(<span class="string">&quot;&quot;</span>, name.Split(<span class="string">&#x27;_&#x27;</span>).Select(ToFirstUpperStyle));</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">AllLowerToLowerCamel</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">string</span> name</span>)</span> =&gt; !name.IsAllLower() ? name : name[<span class="number">0</span>] + name.AllLowerToUpperCamel().Substring(<span class="number">1</span>);</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">AllLowerToAllUpper</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">string</span> name</span>)</span> =&gt; !name.IsAllLower() ? name : name.ToUpper();</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">AllLowerToFirstUpper</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">string</span> name</span>)</span> =&gt; !name.IsAllLower() ? name : (<span class="built_in">char</span>)(name[<span class="number">0</span>] - LetterUpperLowerDistance) + name.Substring(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//FirstUpper To Other</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">FirstUpperToUpperCamel</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">string</span> name</span>)</span> =&gt; !name.IsFirstUpper() ? name : <span class="built_in">string</span>.Join(<span class="string">&quot;&quot;</span>, name.Split(<span class="string">&#x27;_&#x27;</span>).Select(ToFirstUpperStyle));</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">FirstUpperToLowerCamel</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">string</span> name</span>)</span> =&gt; !name.IsFirstUpper() ? name : (<span class="built_in">char</span>)(name[<span class="number">0</span>] + LetterUpperLowerDistance) + name.FirstUpperToUpperCamel().Substring(<span class="number">1</span>);</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">FirstUpperToAllUpper</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">string</span> name</span>)</span> =&gt; !name.IsFirstUpper() ? name : name.ToUpper();</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">FirstUpperToAllLower</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">string</span> name</span>)</span> =&gt; !name.IsFirstUpper() ? name : name.ToLower();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Orthers To X</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">ToUpperCamel</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">string</span> name</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> name.GetNamingStyle() <span class="keyword">switch</span></span><br><span class="line">        &#123;</span><br><span class="line">            NamingStyle.LowerCamel =&gt; name.LowerCamelToUpperCamel(),</span><br><span class="line">            NamingStyle.AllUpper =&gt; name.AllUpperToUpperCamel(),</span><br><span class="line">            NamingStyle.AllLower =&gt; name.AllLowerToUpperCamel(),</span><br><span class="line">            NamingStyle.FirstUpper =&gt; name.FirstUpperToUpperCamel(),</span><br><span class="line">            _ =&gt; name</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">ToLowerCamel</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">string</span> name</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> name.GetNamingStyle() <span class="keyword">switch</span></span><br><span class="line">        &#123;</span><br><span class="line">            NamingStyle.UpperCamel =&gt; name.UpperCamelToLowerCamel(),</span><br><span class="line">            NamingStyle.AllUpper =&gt; name.AllUpperToLowerCamel(),</span><br><span class="line">            NamingStyle.AllLower =&gt; name.AllLowerToLowerCamel(),</span><br><span class="line">            NamingStyle.FirstUpper =&gt; name.FirstUpperToLowerCamel(),</span><br><span class="line">            _ =&gt; name</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">ToAllUpper</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">string</span> name</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> name.GetNamingStyle() <span class="keyword">switch</span></span><br><span class="line">        &#123;</span><br><span class="line">            NamingStyle.UpperCamel =&gt; name.UpperCamelToAllUpper(),</span><br><span class="line">            NamingStyle.LowerCamel =&gt; name.LowerCamelToAllUpper(),</span><br><span class="line">            NamingStyle.AllLower =&gt; name.AllLowerToAllUpper(),</span><br><span class="line">            NamingStyle.FirstUpper =&gt; name.FirstUpperToAllUpper(),</span><br><span class="line">            _ =&gt; name</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">ToAllLower</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">string</span> name</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> name.GetNamingStyle() <span class="keyword">switch</span></span><br><span class="line">        &#123;</span><br><span class="line">            NamingStyle.UpperCamel =&gt; name.UpperCamelToAllLower(),</span><br><span class="line">            NamingStyle.LowerCamel =&gt; name.LowerCamelToAllLower(),</span><br><span class="line">            NamingStyle.AllUpper =&gt; name.AllUpperToAllLower(),</span><br><span class="line">            NamingStyle.FirstUpper =&gt; name.FirstUpperToAllLower(),</span><br><span class="line">            _ =&gt; name</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">ToFirstUpper</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">string</span> name</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> name.GetNamingStyle() <span class="keyword">switch</span></span><br><span class="line">        &#123;</span><br><span class="line">            NamingStyle.UpperCamel =&gt; name.UpperCamelToFirstUpper(),</span><br><span class="line">            NamingStyle.LowerCamel =&gt; name.LowerCamelToFirstUpper(),</span><br><span class="line">            NamingStyle.AllUpper =&gt; name.AllUpperToFirstUpper(),</span><br><span class="line">            NamingStyle.AllLower =&gt; name.AllLowerToFirstUpper(),</span><br><span class="line">            _ =&gt; name</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">IsUpperLetter</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">char</span> letter</span>)</span> =&gt; letter &gt;= <span class="string">&#x27;A&#x27;</span> &amp;&amp; letter &lt;= <span class="string">&#x27;Z&#x27;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">IsLowerLetter</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">char</span> letter</span>)</span> =&gt; letter &gt;= <span class="string">&#x27;a&#x27;</span> &amp;&amp; letter &lt;= <span class="string">&#x27;z&#x27;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">IsLetter</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">char</span> letter</span>)</span> =&gt; letter.IsLowerLetter() || letter.IsUpperLetter();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">RemovePrefix</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">string</span> str, <span class="built_in">string</span> prefix</span>)</span> =&gt; str.StartsWith(prefix) ? str.Substring(prefix.Length) : str;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">RemoveSuffix</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">string</span> str, <span class="built_in">string</span> suffix</span>)</span> =&gt; str.EndsWith(suffix) ? str.Substring(<span class="number">0</span>, str.Length - suffix.Length) : str;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">IsUpperCamel</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">string</span> name</span>)</span> =&gt; name.GetNamingStyle() == NamingStyle.UpperCamel;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">IsLowerCamel</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">string</span> name</span>)</span> =&gt; name.GetNamingStyle() == NamingStyle.LowerCamel;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">IsAllUpper</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">string</span> name</span>)</span> =&gt; name.GetNamingStyle() == NamingStyle.AllUpper;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">IsAllLower</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">string</span> name</span>)</span> =&gt; name.GetNamingStyle() == NamingStyle.AllLower;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">IsFirstUpper</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">string</span> name</span>)</span> =&gt; name.GetNamingStyle() == NamingStyle.FirstUpper;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> IEnumerable&lt;<span class="built_in">string</span>&gt; <span class="title">UpperCamelSplit</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">string</span> name</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (Match match <span class="keyword">in</span> Regex.Matches(name, <span class="string">&quot;[A-Z][a-z]+&quot;</span>, RegexOptions.Compiled | RegexOptions.Singleline))</span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">return</span> match.Value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">ToFirstUpperStyle</span>(<span class="params"><span class="built_in">string</span> word</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!word.IsRegexMatch(<span class="string">&quot;^[a-z]+$&quot;</span>, RegexOptions.Compiled | RegexOptions.Singleline | RegexOptions.IgnoreCase))</span><br><span class="line">            <span class="keyword">return</span> word;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> newLetter = <span class="keyword">new</span> <span class="built_in">char</span>[word.Length];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; word.Length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (i == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (word[i].IsLowerLetter())</span><br><span class="line">                &#123;</span><br><span class="line">                    newLetter[i] = (<span class="built_in">char</span>)(word[i] - LetterUpperLowerDistance);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    newLetter[i] = word[i];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (word[i].IsUpperLetter())</span><br><span class="line">                &#123;</span><br><span class="line">                    newLetter[i] = (<span class="built_in">char</span>)(word[i] + LetterUpperLowerDistance);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    newLetter[i] = word[i];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">string</span>(newLetter);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">char</span> <span class="title">ToUpper</span>(<span class="params"><span class="built_in">char</span> c</span>)</span> =&gt; c.IsLowerLetter() ? (<span class="built_in">char</span>)(c - LetterUpperLowerDistance) : c;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">char</span> <span class="title">ToLower</span>(<span class="params"><span class="built_in">char</span> c</span>)</span> =&gt; c.IsUpperLetter() ? (<span class="built_in">char</span>)(c + LetterUpperLowerDistance) : c;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">enum</span> NamingStyle</span><br><span class="line">&#123;</span><br><span class="line">    NonStandard,</span><br><span class="line">    UpperCamel,</span><br><span class="line">    LowerCamel,</span><br><span class="line">    AllUpper,</span><br><span class="line">    AllLower,</span><br><span class="line">    FirstUpper</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>代码仓库</category>
      </categories>
      <tags>
        <tag>风格转化</tag>
        <tag>封装</tag>
      </tags>
  </entry>
  <entry>
    <title>【微服务学习】Polly：熔断降级组件</title>
    <url>/posts/15090.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="何为熔断降级"><a href="#何为熔断降级" class="headerlink" title="何为熔断降级"></a>何为熔断降级</h2><p>　　“熔断器如同电力过载保护器。它可以实现快速失败，如果它在一段时间内侦测到许多类似的错误，会强迫其以后的多个调用快速失败，不再访问远程服务器，从而防止应用程序不断地尝试执行可能会失败的操作，使得应用程序继续执行而不用等待修正错误，或者浪费时间去等到长时间的超时产生。”<br>　　降级的目的是当某个服务提供者发生故障的时候，向调用方返回一个替代响应。<br>　　简单一句话概括，降级就是在调用的下游服务A出现问题（常见超时），提供PLAN-B，返回的效果可能没有服务A好，但是聊胜于无。而熔断器的存在就是要保障何时走到降级方法，何时恢复，以什么样的策略恢复。</p>
<span id="more"></span>
<h2 id="NET-Core-熔断降级实践"><a href="#NET-Core-熔断降级实践" class="headerlink" title=".NET Core 熔断降级实践"></a>.NET Core 熔断降级实践</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>　　Polly是一种.NET弹性和瞬态故障处理库，允许我们以非常顺畅和线程安全的方式来执诸如行重试，断路，超时，故障恢复等策略。<br>　　Polly当前版本可以工作在 .NET Standard 1.1 (包括: .NET Framework 4.5-4.6.1, .NET Core 1.0, Mono, Xamarin, UWP, WP8.1+) 和 .NET Standard 2.0+ (包括: .NET Framework 4.6.1, .NET Core 2.0+, 新版本的 Mono, Xamarin and UWP targets).上，同时也为旧版本的.NET Framework提供了一些可用的旧版本，具体版本对应如下：</p>
<table>
<thead>
<tr>
<th>目标框架</th>
<th>最低适配版本</th>
<th>最高适配版本</th>
</tr>
</thead>
<tbody><tr>
<td>.NET&nbsp;Standard&nbsp;2.1<br/>for use with IHttpClientFactory</td>
<td><span class="exturl" data-url="aHR0cHM6Ly93d3cubnVnZXQub3JnL3BhY2thZ2VzL1BvbGx5LzYuMC4x">6.0.1<i class="fa fa-external-link-alt"></i></span></td>
<td><span class="exturl" data-url="aHR0cHM6Ly93d3cubnVnZXQub3JnL3BhY2thZ2VzL3BvbGx5">Current<i class="fa fa-external-link-alt"></i></span></td>
</tr>
<tr>
<td>.NET&nbsp;Standard&nbsp;2.0 (dedicated&nbsp;target)</td>
<td><span class="exturl" data-url="aHR0cHM6Ly93d3cubnVnZXQub3JnL3BhY2thZ2VzL1BvbGx5LzYuMC4x">6.0.1<i class="fa fa-external-link-alt"></i></span></td>
<td><span class="exturl" data-url="aHR0cHM6Ly93d3cubnVnZXQub3JnL3BhY2thZ2VzL3BvbGx5">Current<i class="fa fa-external-link-alt"></i></span></td>
</tr>
<tr>
<td>.NET&nbsp;Standard&nbsp;2.0</td>
<td><span class="exturl" data-url="aHR0cHM6Ly93d3cubnVnZXQub3JnL3BhY2thZ2VzL1BvbGx5LzUuMC4z">5.0.3<i class="fa fa-external-link-alt"></i></span> via .Net&nbsp;Standard&nbsp;1.0 (upward compatible)</td>
<td><span class="exturl" data-url="aHR0cHM6Ly93d3cubnVnZXQub3JnL3BhY2thZ2VzL3BvbGx5">Current<i class="fa fa-external-link-alt"></i></span></td>
</tr>
<tr>
<td>.NET&nbsp;Standard&nbsp;1.1</td>
<td><span class="exturl" data-url="aHR0cHM6Ly93d3cubnVnZXQub3JnL3BhY2thZ2VzL1BvbGx5LzUuMC4z">5.0.3<i class="fa fa-external-link-alt"></i></span> via  .Net&nbsp;Standard&nbsp;1.0 (upward compatible)</td>
<td><span class="exturl" data-url="aHR0cHM6Ly93d3cubnVnZXQub3JnL3BhY2thZ2VzL3BvbGx5">Current<i class="fa fa-external-link-alt"></i></span></td>
</tr>
<tr>
<td>.NET&nbsp;Standard&nbsp;1.0</td>
<td><span class="exturl" data-url="aHR0cHM6Ly93d3cubnVnZXQub3JnL3BhY2thZ2VzL1BvbGx5LzUuMC4z">5.0.3<i class="fa fa-external-link-alt"></i></span></td>
<td><span class="exturl" data-url="aHR0cHM6Ly93d3cubnVnZXQub3JnL3BhY2thZ2VzL1BvbGx5LzUuMS4w">5.1.0<i class="fa fa-external-link-alt"></i></span></td>
</tr>
<tr>
<td>.NET&nbsp;Framework&nbsp;4.5</td>
<td><span class="exturl" data-url="aHR0cHM6Ly93d3cubnVnZXQub3JnL3BhY2thZ2VzL1BvbGx5LzEuMC4w">1.0.0<i class="fa fa-external-link-alt"></i></span></td>
<td><span class="exturl" data-url="aHR0cHM6Ly93d3cubnVnZXQub3JnL3BhY2thZ2VzL3BvbGx5">Current<i class="fa fa-external-link-alt"></i></span>&nbsp;(via&nbsp;.Net&nbsp;Standard);<br/><span class="exturl" data-url="aHR0cHM6Ly93d3cubnVnZXQub3JnL3BhY2thZ2VzL1BvbGx5LzUuOS4w">5.9.0<i class="fa fa-external-link-alt"></i></span>&nbsp;(as&nbsp;dedicated&nbsp;target)</td>
</tr>
<tr>
<td>.NET&nbsp;Framework&nbsp;4.0<br/>with Async support</td>
<td><span class="exturl" data-url="aHR0cHM6Ly93d3cubnVnZXQub3JnL3BhY2thZ2VzL1BvbGx5Lk5ldDQwQXN5bmMvNC4yLjI=">4.2.2<i class="fa fa-external-link-alt"></i></span></td>
<td><span class="exturl" data-url="aHR0cHM6Ly93d3cubnVnZXQub3JnL3BhY2thZ2VzL1BvbGx5Lk5ldDQwQXN5bmMvNS45LjA=">5.9.0<i class="fa fa-external-link-alt"></i></span></td>
</tr>
<tr>
<td>.NET&nbsp;Framework&nbsp;4.0</td>
<td><span class="exturl" data-url="aHR0cHM6Ly93d3cubnVnZXQub3JnL3BhY2thZ2VzL1BvbGx5LzEuMC4w">1.0.0<i class="fa fa-external-link-alt"></i></span></td>
<td><span class="exturl" data-url="aHR0cHM6Ly93d3cubnVnZXQub3JnL3BhY2thZ2VzL1BvbGx5Lk5ldDQwQXN5bmMvNS45LjA=">5.9.0<i class="fa fa-external-link-alt"></i></span></td>
</tr>
<tr>
<td>.NET&nbsp;Framework&nbsp;3.5</td>
<td><span class="exturl" data-url="aHR0cHM6Ly93d3cubnVnZXQub3JnL3BhY2thZ2VzL1BvbGx5LzEuMC4w">1.0.0<i class="fa fa-external-link-alt"></i></span></td>
<td><span class="exturl" data-url="aHR0cHM6Ly93d3cubnVnZXQub3JnL3BhY2thZ2VzL1BvbGx5LzQuMy4w">4.3.0<i class="fa fa-external-link-alt"></i></span></td>
</tr>
<tr>
<td>Various PCL targets</td>
<td><span class="exturl" data-url="aHR0cHM6Ly93d3cubnVnZXQub3JnL3BhY2thZ2VzL1BvbGx5LzIuMC4w">2.0.0<i class="fa fa-external-link-alt"></i></span></td>
<td><span class="exturl" data-url="aHR0cHM6Ly93d3cubnVnZXQub3JnL3BhY2thZ2VzL3BvbGx5">Current<i class="fa fa-external-link-alt"></i></span>&nbsp;(via&nbsp;.Net&nbsp;Standard);<br/><span class="exturl" data-url="aHR0cHM6Ly93d3cubnVnZXQub3JnL3BhY2thZ2VzL1BvbGx5LzQuMy4w">4.3.0<i class="fa fa-external-link-alt"></i></span>&nbsp;(as&nbsp;dedicated&nbsp;PCL&nbsp;target)</td>
</tr>
</tbody></table>
<p>　　该项目作者现已成为.NET基金会一员，项目一直在不停迭代和更新，项目地址<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0FwcC12TmV4dC9Qb2xseQ==">【https://github.com/App-vNext/Polly】<i class="fa fa-external-link-alt"></i></span>。</p>
<h3 id="七种恢复策略"><a href="#七种恢复策略" class="headerlink" title="七种恢复策略"></a>七种恢复策略</h3><table>
<thead>
<tr>
<th>策略</th>
<th>前置条件</th>
<th align="center">例</th>
<th>此策略解决什么问题?</th>
</tr>
</thead>
<tbody><tr>
<td><strong>重试策略（Retry）</strong> <br/>(policy family)<br/><sub>(<a href="#retry">快速开始</a>&nbsp;;&nbsp;<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0FwcC12TmV4dC9Qb2xseS93aWtpL1JldHJ5">深入学习<i class="fa fa-external-link-alt"></i></span>)</sub></td>
<td>重试策略针对的前置条件是短暂的故障延迟且在短暂的延迟之后能够自我纠正。</td>
<td align="center">“也许这只是昙花一现”</td>
<td>允许我们做的是能够自动配置重试机制。</td>
</tr>
<tr>
<td><strong>断路器（Circuit-breaker）</strong><br/>(policy family)<br/><sub>(<a href="#circuit-breaker">快速开始</a>&nbsp;;&nbsp;<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0FwcC12TmV4dC9Qb2xseS93aWtpL0NpcmN1aXQtQnJlYWtlcg==">深入学习<i class="fa fa-external-link-alt"></i></span>)</sub></td>
<td>断路器策略针对的前置条件是当系统繁忙时，快速响应失败总比让用户一直等待更好。 <br/><br/>保护系统故障免受过载，Polly可以帮其恢复。</td>
<td align="center">“痛了，自然就会放下” <br/><br/>“让它歇一下”</td>
<td>当故障超过某个预先配置的阈值时, 中断电路 (块执行) 一段时间。</td>
</tr>
<tr>
<td><strong>超时（Timeout）</strong><br/><sub>(<a href="#timeout">快速开始</a>&nbsp;;&nbsp;<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0FwcC12TmV4dC9Qb2xseS93aWtpL1RpbWVvdXQ=">深入学习<i class="fa fa-external-link-alt"></i></span>)</sub></td>
<td>超时策略针对的前置条件是超过一定的等待时间，想要得到成功的结果是不可能的。</td>
<td align="center">“你不必等待，她不会再来”</td>
<td>保证调用者不必等待太长时间。</td>
</tr>
<tr>
<td><strong>隔板隔离（Bulkhead Isolation）</strong><br/><sub>(<a href="#bulkhead">快速开始</a>&nbsp;;&nbsp;<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0FwcC12TmV4dC9Qb2xseS93aWtpL0J1bGtoZWFk">深入学习<i class="fa fa-external-link-alt"></i></span>)</sub></td>
<td>隔板隔离针对的前置条件是当进程出现故障时，多个失败一直在主机中对资源（例如线程/ CPU）一直占用。下游系统故障也可能导致上游失败。<br/><br/>这两个风险都将造成严重的后果。</td>
<td align="center">“一颗老鼠屎坏了一锅汤”</td>
<td>将受管制的操作限制在固定的资源池中，避免其他资源受其影响。</td>
</tr>
<tr>
<td><strong>缓存（Cache）</strong><br/><sub>(<a href="#cache">快速开始</a>&nbsp;;&nbsp;<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0FwcC12TmV4dC9Qb2xseS93aWtpL0NhY2hl">深入学习<i class="fa fa-external-link-alt"></i></span>)</sub></td>
<td>数据不会很频繁的进行更新，相同请求的响应是相似的。</td>
<td align="center">“听说 <br/>你还会再来<br/>我翘首以盼”</td>
<td>首次加载数据时将响应数据进行缓存，请求时若缓存中存在则直接从缓存中读取。</td>
</tr>
<tr>
<td><strong>回退（Fallback）</strong><br/><sub>(<a href="#fallback">快速开始</a>&nbsp;;&nbsp;<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0FwcC12TmV4dC9Qb2xseS93aWtpL0ZhbGxiYWNr">深入学习<i class="fa fa-external-link-alt"></i></span>)</sub></td>
<td>操作将仍然失败 - 但是你可以实现准备好失败后要做的补救措施。</td>
<td align="center">“你若安好，我备胎到老。”</td>
<td>定义失败时要返回 (或要执行的操作) 的替代值。.</td>
</tr>
<tr>
<td><strong>策略包装（PolicyWrap）</strong><br/><sub>(<a href="#policywrap">快速开始</a>&nbsp;;&nbsp;<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0FwcC12TmV4dC9Qb2xseS93aWtpL1BvbGljeVdyYXA=">深入学习<i class="fa fa-external-link-alt"></i></span>)</sub></td>
<td>不同的故障需要不同的策略，也就意味着弹性灵活使用组合。</td>
<td align="center">“谋定而后动”</td>
<td>允许灵活地组合上述任何策略。</td>
</tr>
</tbody></table>
<h2 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h2><h3 id="故障处理（被动策略）"><a href="#故障处理（被动策略）" class="headerlink" title="故障处理（被动策略）"></a>故障处理（被动策略）</h3><p>故障处理策略处理通过策略执行的代码所引发的特定的异常或返回结果。</p>
<h4 id="第一步：指定希望处理的异常（可选-指定要处理的返回结果）"><a href="#第一步：指定希望处理的异常（可选-指定要处理的返回结果）" class="headerlink" title="第一步：指定希望处理的异常（可选-指定要处理的返回结果）"></a>第一步：指定希望处理的异常（可选-指定要处理的返回结果）</h4><h5 id="指定希望处理的异常："><a href="#指定希望处理的异常：" class="headerlink" title="指定希望处理的异常："></a>指定希望处理的异常：</h5><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 单一异常种类</span></span><br><span class="line">Policy</span><br><span class="line">  .Handle&lt;HttpRequestException&gt;()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 带条件判断的单一异常</span></span><br><span class="line">Policy</span><br><span class="line">  .Handle&lt;SqlException&gt;(ex =&gt; ex.Number == <span class="number">1205</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 多种异常</span></span><br><span class="line">Policy</span><br><span class="line">  .Handle&lt;HttpRequestException&gt;()</span><br><span class="line">  .Or&lt;OperationCanceledException&gt;()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 带条件判断的多种异常</span></span><br><span class="line">Policy</span><br><span class="line">  .Handle&lt;SqlException&gt;(ex =&gt; ex.Number == <span class="number">1205</span>)</span><br><span class="line">  .Or&lt;ArgumentException&gt;(ex =&gt; ex.ParamName == <span class="string">&quot;example&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 普通异常或聚合异常的内部异常, 可以带有条件</span></span><br><span class="line">Policy</span><br><span class="line">  .HandleInner&lt;HttpRequestException&gt;()</span><br><span class="line">  .OrInner&lt;OperationCanceledException&gt;(ex =&gt; ex.CancellationToken != myToken)</span><br></pre></td></tr></table></figure>
<h5 id="指定要处理的返回结果"><a href="#指定要处理的返回结果" class="headerlink" title="指定要处理的返回结果"></a><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0FwcC12TmV4dC9Qb2xseSNoYW5kaW5nLXJldHVybi12YWx1ZXMtYW5kLXBvbGljeXRyZXN1bHQ=">指定要处理的返回结果<i class="fa fa-external-link-alt"></i></span></h5><p>从Polly v4.3.0起，包含返回TResult的调用的策略也可以处理TResult返回值</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 带条件判断的单种返回值处理</span></span><br><span class="line">Policy</span><br><span class="line">  .HandleResult&lt;HttpResponseMessage&gt;(r =&gt; r.StatusCode == HttpStatusCode.NotFound)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 带条件判断的多种返回值处理</span></span><br><span class="line">Policy</span><br><span class="line">  .HandleResult&lt;HttpResponseMessage&gt;(r =&gt; r.StatusCode == HttpStatusCode.InternalServerError)</span><br><span class="line">  .OrResult(r =&gt; r.StatusCode == HttpStatusCode.BadGateway)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 原始返回值处理 (隐式调用 .Equals())</span></span><br><span class="line">Policy</span><br><span class="line">  .HandleResult&lt;HttpStatusCode&gt;(HttpStatusCode.InternalServerError)</span><br><span class="line">  .OrResult(HttpStatusCode.BadGateway)</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 在一个策略中同时处理异常和返回值</span></span><br><span class="line">HttpStatusCode[] httpStatusCodesWorthRetrying = &#123;</span><br><span class="line">   HttpStatusCode.RequestTimeout, <span class="comment">// 408</span></span><br><span class="line">   HttpStatusCode.InternalServerError, <span class="comment">// 500</span></span><br><span class="line">   HttpStatusCode.BadGateway, <span class="comment">// 502</span></span><br><span class="line">   HttpStatusCode.ServiceUnavailable, <span class="comment">// 503</span></span><br><span class="line">   HttpStatusCode.GatewayTimeout <span class="comment">// 504</span></span><br><span class="line">&#125;; </span><br><span class="line">HttpResponseMessage result = <span class="keyword">await</span> Policy</span><br><span class="line">  .Handle&lt;HttpRequestException&gt;()</span><br><span class="line">  .OrResult&lt;HttpResponseMessage&gt;(r =&gt; httpStatusCodesWorthRetrying.Contains(r.StatusCode))</span><br><span class="line">  .RetryAsync(...)</span><br><span class="line">  .ExecuteAsync( <span class="comment">/* Func&lt;Task&lt;HttpResponseMessage&gt;&gt; */</span> )</span><br></pre></td></tr></table></figure>

<h4 id="第二步：指定策略应如何处理这些错误"><a href="#第二步：指定策略应如何处理这些错误" class="headerlink" title="第二步：指定策略应如何处理这些错误"></a>第二步：指定策略应如何处理这些错误</h4><h5 id="重试（Retry）"><a href="#重试（Retry）" class="headerlink" title="重试（Retry）"></a>重试（Retry）</h5><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 重试一次</span></span><br><span class="line">Policy</span><br><span class="line">  .Handle&lt;SomeExceptionType&gt;()</span><br><span class="line">  .Retry()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 重试多次</span></span><br><span class="line">Policy</span><br><span class="line">  .Handle&lt;SomeExceptionType&gt;()</span><br><span class="line">  .Retry(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 重试多次，每次重试触发事件（参数为此次异常和当前重试次数）</span></span><br><span class="line">Policy</span><br><span class="line">    .Handle&lt;SomeExceptionType&gt;()</span><br><span class="line">    .Retry(<span class="number">3</span>, onRetry: (exception, retryCount) =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// do something </span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 重试多次，每次重试触发事件（参数为此次异常、当前重试次数和当前执行的上下文）</span></span><br><span class="line">Policy</span><br><span class="line">    .Handle&lt;SomeExceptionType&gt;()</span><br><span class="line">    .Retry(<span class="number">3</span>, onRetry: (exception, retryCount, context) =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// do something </span></span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<h5 id="不断重试直到成功（Retry-forever-until-succeeds）"><a href="#不断重试直到成功（Retry-forever-until-succeeds）" class="headerlink" title="不断重试直到成功（Retry forever until succeeds）"></a>不断重试直到成功（Retry forever until succeeds）</h5><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 不断重试</span></span><br><span class="line">Policy</span><br><span class="line">  .Handle&lt;SomeExceptionType&gt;()</span><br><span class="line">  .RetryForever()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 不断重试，每次重试触发事件（参数为此次异常） </span></span><br><span class="line">Policy</span><br><span class="line">  .Handle&lt;SomeExceptionType&gt;()</span><br><span class="line">  .RetryForever(onRetry: exception =&gt;</span><br><span class="line">  &#123;</span><br><span class="line">        <span class="comment">// do something       </span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 不断重试，每次重试触发事件（参数为此次异常和当前执行的上下文）</span></span><br><span class="line">Policy</span><br><span class="line">  .Handle&lt;SomeExceptionType&gt;()</span><br><span class="line">  .RetryForever(onRetry: (exception, context) =&gt;</span><br><span class="line">  &#123;</span><br><span class="line">        <span class="comment">// do something       </span></span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<h5 id="等待并重试（Wait-and-retry）"><a href="#等待并重试（Wait-and-retry）" class="headerlink" title="等待并重试（Wait and retry）"></a>等待并重试（Wait and retry）</h5><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0FwcC12TmV4dC9Qb2xseS93aWtpL1JldHJ5I3JldHJ5YWZ0ZXItd2hlbi10aGUtcmVzcG9uc2Utc3BlY2lmaWVzLWhvdy1sb25nLXRvLXdhaXQ=">WaitAndRetry策略处理HTTP状态代码429的重试后状态<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 重试多次, 每次重试之间等待指定的持续时间。(失败之后触发等待, 然后再进行下一次尝试。)</span></span><br><span class="line">Policy</span><br><span class="line">  .Handle&lt;SomeExceptionType&gt;()</span><br><span class="line">  .WaitAndRetry(<span class="keyword">new</span>[]</span><br><span class="line">  &#123;</span><br><span class="line">    TimeSpan.FromSeconds(<span class="number">1</span>),</span><br><span class="line">    TimeSpan.FromSeconds(<span class="number">2</span>),</span><br><span class="line">    TimeSpan.FromSeconds(<span class="number">3</span>)</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 重试并触发事件多次, 每次重试之间等待指定的持续时间。（事件参数为当前异常和时间间隔）</span></span><br><span class="line">Policy</span><br><span class="line">  .Handle&lt;SomeExceptionType&gt;()</span><br><span class="line">  .WaitAndRetry(<span class="keyword">new</span>[]</span><br><span class="line">  &#123;</span><br><span class="line">    TimeSpan.FromSeconds(<span class="number">1</span>),</span><br><span class="line">    TimeSpan.FromSeconds(<span class="number">2</span>),</span><br><span class="line">    TimeSpan.FromSeconds(<span class="number">3</span>)</span><br><span class="line">  &#125;, (exception, timeSpan) =&gt; &#123;</span><br><span class="line">    <span class="comment">// do something    </span></span><br><span class="line">  &#125;); </span><br><span class="line"></span><br><span class="line"><span class="comment">// 重试并触发事件多次, 每次重试之间等待指定的持续时间。（事件参数为当前异常、时间间隔和当前执行的上下文）</span></span><br><span class="line">Policy</span><br><span class="line">  .Handle&lt;SomeExceptionType&gt;()</span><br><span class="line">  .WaitAndRetry(<span class="keyword">new</span>[]</span><br><span class="line">  &#123;</span><br><span class="line">    TimeSpan.FromSeconds(<span class="number">1</span>),</span><br><span class="line">    TimeSpan.FromSeconds(<span class="number">2</span>),</span><br><span class="line">    TimeSpan.FromSeconds(<span class="number">3</span>)</span><br><span class="line">  &#125;, (exception, timeSpan, context) =&gt; &#123;</span><br><span class="line">    <span class="comment">// do something    </span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 重试并触发事件多次, 每次重试之间等待指定的持续时间。（事件参数为当前异常、时间间隔、当前重试次数和当前执行的上下文）</span></span><br><span class="line">Policy</span><br><span class="line">  .Handle&lt;SomeExceptionType&gt;()</span><br><span class="line">  .WaitAndRetry(<span class="keyword">new</span>[]</span><br><span class="line">  &#123;</span><br><span class="line">    TimeSpan.FromSeconds(<span class="number">1</span>),</span><br><span class="line">    TimeSpan.FromSeconds(<span class="number">2</span>),</span><br><span class="line">    TimeSpan.FromSeconds(<span class="number">3</span>)</span><br><span class="line">  &#125;, (exception, timeSpan, retryCount, context) =&gt; &#123;</span><br><span class="line">    <span class="comment">// do something    </span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 重试指定的次数, 根据当前重试次数计算等待时间 (允许指数回退)</span></span><br><span class="line"><span class="comment">// 当前这种情况下, 等待时间为:</span></span><br><span class="line"><span class="comment">//  2 ^ 1 = 2 s</span></span><br><span class="line"><span class="comment">//  2 ^ 2 = 4 s</span></span><br><span class="line"><span class="comment">//  2 ^ 3 = 8 s</span></span><br><span class="line"><span class="comment">//  2 ^ 4 = 16 s</span></span><br><span class="line"><span class="comment">//  2 ^ 5 = 32 s</span></span><br><span class="line">Policy</span><br><span class="line">  .Handle&lt;SomeExceptionType&gt;()</span><br><span class="line">  .WaitAndRetry(<span class="number">5</span>, retryAttempt =&gt; </span><br><span class="line">	TimeSpan.FromSeconds(Math.Pow(<span class="number">2</span>, retryAttempt)) </span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line"><span class="comment">// 重试指定的次数，每次重试时触发事件，根据当前重试次数计算等待时间。（事件参数为当前异常、时间间隔和当前执行的上下文）</span></span><br><span class="line">Policy</span><br><span class="line">  .Handle&lt;SomeExceptionType&gt;()</span><br><span class="line">  .WaitAndRetry(</span><br><span class="line">    <span class="number">5</span>, </span><br><span class="line">    retryAttempt =&gt; TimeSpan.FromSeconds(Math.Pow(<span class="number">2</span>, retryAttempt)), </span><br><span class="line">    (exception, timeSpan, context) =&gt; &#123;</span><br><span class="line">      <span class="comment">// do something</span></span><br><span class="line">    &#125;</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line"><span class="comment">// 重试指定的次数，每次重试时触发事件，根据当前重试次数计算等待时间。（事件参数为当前异常、时间间隔、当前重试次数和当前执行的上下文）</span></span><br><span class="line">Policy</span><br><span class="line">  .Handle&lt;SomeExceptionType&gt;()</span><br><span class="line">  .WaitAndRetry(</span><br><span class="line">    <span class="number">5</span>, </span><br><span class="line">    retryAttempt =&gt; TimeSpan.FromSeconds(Math.Pow(<span class="number">2</span>, retryAttempt)), </span><br><span class="line">    (exception, timeSpan, retryCount, context) =&gt; &#123;</span><br><span class="line">      <span class="comment">// do something</span></span><br><span class="line">    &#125;</span><br><span class="line">  );</span><br></pre></td></tr></table></figure>
<h5 id="不断等待并重试直到成功（Wait-and-retry-forever-until-succeeds）"><a href="#不断等待并重试直到成功（Wait-and-retry-forever-until-succeeds）" class="headerlink" title="不断等待并重试直到成功（Wait and retry forever until succeeds）"></a>不断等待并重试直到成功（Wait and retry forever until succeeds）</h5><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0FwcC12TmV4dC9Qb2xseS93aWtpL1JldHJ5">如果所有重试都失败, 重试策略将重新引发最后一个异常返回到调用代码。<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 不断等待并重试</span></span><br><span class="line">Policy</span><br><span class="line">  .Handle&lt;SomeExceptionType&gt;()</span><br><span class="line">  .WaitAndRetryForever(retryAttempt =&gt; </span><br><span class="line">	TimeSpan.FromSeconds(Math.Pow(<span class="number">2</span>, retryAttempt))</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line"><span class="comment">// 不断等待并重试，每次重试时触发事件。（事件参数为当前异常、时间间隔）</span></span><br><span class="line">Policy</span><br><span class="line">  .Handle&lt;SomeExceptionType&gt;()</span><br><span class="line">  .WaitAndRetryForever(</span><br><span class="line">    retryAttempt =&gt; TimeSpan.FromSeconds(Math.Pow(<span class="number">2</span>, retryAttempt)),    </span><br><span class="line">    (exception, timespan) =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// do something       </span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 不断等待并重试，每次重试时触发事件。（事件参数为当前异常、时间间隔和当前执行的上下文）</span></span><br><span class="line">Policy</span><br><span class="line">  .Handle&lt;SomeExceptionType&gt;()</span><br><span class="line">  .WaitAndRetryForever(</span><br><span class="line">    retryAttempt =&gt; TimeSpan.FromSeconds(Math.Pow(<span class="number">2</span>, retryAttempt)),    </span><br><span class="line">    (exception, timespan, context) =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// do something       </span></span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<h5 id="断路器（Circuit-breaker）"><a href="#断路器（Circuit-breaker）" class="headerlink" title="断路器（Circuit-breaker）"></a>断路器（Circuit-breaker）</h5><p>断路器策略通过在程序出错时抛出<strong>BrokenCircuitException</strong>来屏蔽其他异常。<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0FwcC12TmV4dC9Qb2xseS93aWtpL0NpcmN1aXQtQnJlYWtlcg==">文档<i class="fa fa-external-link-alt"></i></span><br>请注意, 断路器策略将<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0FwcC12TmV4dC9Qb2xseS93aWtpL0NpcmN1aXQtQnJlYWtlciNleGNlcHRpb24taGFuZGxpbmc=">重新引发所有异常<i class="fa fa-external-link-alt"></i></span>, 甚至是已处理的异常。所以使用时通常会将<strong>重试策略</strong>和断路器策略<strong>组合使用</strong>。</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 在指定数量的连续异常后断开程序执行并在之后的一段时间内保持程序执行断开。</span></span><br><span class="line">Policy</span><br><span class="line">    .Handle&lt;SomeExceptionType&gt;()</span><br><span class="line">    .CircuitBreaker(<span class="number">2</span>, TimeSpan.FromMinutes(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在指定数量的连续异常后断开程序执行并在之后的一段时间内保持程序执行断开。当程序执行断开或者重新启用时触发事件。（程序执行断开事件参数为当前异常和间隔时间，重新启用事件无参数）</span></span><br><span class="line">Action&lt;Exception, TimeSpan&gt; onBreak = (exception, timespan) =&gt; &#123; ... &#125;;</span><br><span class="line">Action onReset = () =&gt; &#123; ... &#125;;</span><br><span class="line">CircuitBreakerPolicy breaker = Policy</span><br><span class="line">    .Handle&lt;SomeExceptionType&gt;()</span><br><span class="line">    .CircuitBreaker(<span class="number">2</span>, TimeSpan.FromMinutes(<span class="number">1</span>), onBreak, onReset);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在指定数量的连续异常后断开程序执行并在之后的一段时间内保持程序执行断开。当程序执行断开或者重新启用时触发事件。（程序执行断开事件参数为当前异常、间隔时间和当前执行上下文，重新启用事件参数为当前执行上下文）</span></span><br><span class="line">Action&lt;Exception, TimeSpan, Context&gt; onBreak = (exception, timespan, context) =&gt; &#123; ... &#125;;</span><br><span class="line">Action&lt;Context&gt; onReset = context =&gt; &#123; ... &#125;;</span><br><span class="line">CircuitBreakerPolicy breaker = Policy</span><br><span class="line">    .Handle&lt;SomeExceptionType&gt;()</span><br><span class="line">    .CircuitBreaker(<span class="number">2</span>, TimeSpan.FromMinutes(<span class="number">1</span>), onBreak, onReset);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 程序运行状态, 运行状况。</span></span><br><span class="line">CircuitState state = breaker.CircuitState;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">CircuitState.Closed - 断路器未触发，允许操作执行。</span></span><br><span class="line"><span class="comment">CircuitState.Open - 断路器开启，阻止操作执行。</span></span><br><span class="line"><span class="comment">CircuitState.HalfOpen - 断路器开启指定时间后重新关闭，此状态允许操作执行，之后的开启或关闭取决于继续执行的结果。</span></span><br><span class="line"><span class="comment">CircuitState.Isolated - 断路器被主动开启，阻止操作执行。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 手动打开 (并保持打开) 断路器（例如需要主动隔离下游服务时）</span></span><br><span class="line">breaker.Isolate(); </span><br><span class="line"><span class="comment">// 重置断路器为关闭状态, 再次开始允许操作执行。</span></span><br><span class="line">breaker.Reset(); </span><br><span class="line">````</span><br><span class="line"><span class="meta">##### 高级断路器（Advanced Circuit Breaker）</span></span><br><span class="line">```csharp</span><br><span class="line"><span class="comment">// 在采样持续时间内, 如果已处理异常的操作的比例超过故障阈值且该时间段内通过请求操作数达到最小吞吐量，主动启动断路器。</span></span><br><span class="line"></span><br><span class="line">Policy</span><br><span class="line">    .Handle&lt;SomeExceptionType&gt;()</span><br><span class="line">    .AdvancedCircuitBreaker(</span><br><span class="line">        failureThreshold: <span class="number">0.5</span>, <span class="comment">// 当&gt;=50%的操作会导致已处理的异常时中断程序。</span></span><br><span class="line">        samplingDuration: TimeSpan.FromSeconds(<span class="number">10</span>), <span class="comment">// 采样时间区间为10秒</span></span><br><span class="line">        minimumThroughput: <span class="number">8</span>, <span class="comment">// ... 在采样时间区间内进行了至少8次操作。</span></span><br><span class="line">        durationOfBreak: TimeSpan.FromSeconds(<span class="number">30</span>) <span class="comment">// 断路30秒.</span></span><br><span class="line">                );</span><br><span class="line"></span><br><span class="line"><span class="comment">// 采用状态更改委托的配置重载同样可用于高级断路器。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 电路状态监控和手动控制同样也可用于高级断路器。</span></span><br></pre></td></tr></table></figure>

<p>更多相关资料请参考: <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0FwcC12TmV4dC9Qb2xseS93aWtpL0FkdmFuY2VkLUNpcmN1aXQtQnJlYWtlcg==">文档<i class="fa fa-external-link-alt"></i></span></p>
<p>有关断路器模式的更多信息, 请参见：</p>
<ul>
<li><a href="http://techblog.netflix.com/2011/12/making-netflix-api-more-resilient.html"><strong>改造 Netflix API 增加接口弹性</strong></a></li>
<li><a href="http://martinfowler.com/bliki/CircuitBreaker.html"><strong>断路器浅谈 (马丁·福勒)</strong></a></li>
<li><a href="https://msdn.microsoft.com/en-us/library/dn589784.aspx"><strong>断路器模式 (Microsoft)</strong></a></li>
<li><a href="https://web.archive.org/web/20160106203951/http://thatextramile.be/blog/2008/05/the-circuit-breaker"><strong>原始断路器链</strong></a></li>
</ul>
<h5 id="回退策略（Fallback）"><a href="#回退策略（Fallback）" class="headerlink" title="回退策略（Fallback）"></a><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0FwcC12TmV4dC9Qb2xseS93aWtpL0ZhbGxiYWNr">回退策略（Fallback）<i class="fa fa-external-link-alt"></i></span></h5><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 执行错误时提供替代值。</span></span><br><span class="line">Policy</span><br><span class="line">   .Handle&lt;Whatever&gt;()</span><br><span class="line">   .Fallback&lt;UserAvatar&gt;(UserAvatar.Blank)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行错误时使用回调函数提供替代值。</span></span><br><span class="line">Policy</span><br><span class="line">   .Handle&lt;Whatever&gt;()</span><br><span class="line">   .Fallback&lt;UserAvatar&gt;(() =&gt; UserAvatar.GetRandomAvatar()) <span class="comment">// where: public UserAvatar GetRandomAvatar() &#123; ... &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行错误时提供替代值的同时触发事件。（事件参数为当前异常信息和当前运行上下文）</span></span><br><span class="line">Policy</span><br><span class="line">   .Handle&lt;Whatever&gt;()</span><br><span class="line">   .Fallback&lt;UserAvatar&gt;(UserAvatar.Blank, onFallback: (exception, context) =&gt; </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// do something</span></span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
<h4 id="第三步：执行策略"><a href="#第三步：执行策略" class="headerlink" title="第三步：执行策略"></a>第三步：执行策略</h4><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 执行操作</span></span><br><span class="line"><span class="keyword">var</span> policy = Policy</span><br><span class="line">              .Handle&lt;SomeExceptionType&gt;()</span><br><span class="line">              .Retry();</span><br><span class="line"></span><br><span class="line">policy.Execute(() =&gt; DoSomething());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行传递任意上下文数据的操作</span></span><br><span class="line"><span class="keyword">var</span> policy = Policy</span><br><span class="line">    .Handle&lt;SomeExceptionType&gt;()</span><br><span class="line">    .Retry(<span class="number">3</span>, (exception, retryCount, context) =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> methodThatRaisedException = context[<span class="string">&quot;methodName&quot;</span>];</span><br><span class="line">		Log(exception, methodThatRaisedException);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">policy.Execute(</span><br><span class="line">	() =&gt; DoSomething(),</span><br><span class="line">	<span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">object</span>&gt;() &#123;&#123; <span class="string">&quot;methodName&quot;</span>, <span class="string">&quot;some method&quot;</span> &#125;&#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行返回结果的函数</span></span><br><span class="line"><span class="keyword">var</span> policy = Policy</span><br><span class="line">              .Handle&lt;SomeExceptionType&gt;()</span><br><span class="line">              .Retry();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> result = policy.Execute(() =&gt; DoSomething());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行传递任意上下文数据且返回结果的操作</span></span><br><span class="line"><span class="keyword">var</span> policy = Policy</span><br><span class="line">    .Handle&lt;SomeExceptionType&gt;()</span><br><span class="line">    .Retry(<span class="number">3</span>, (exception, retryCount, context) =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">object</span> methodThatRaisedException = context[<span class="string">&quot;methodName&quot;</span>];</span><br><span class="line">        Log(exception, methodThatRaisedException)</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> result = policy.Execute(</span><br><span class="line">    () =&gt; DoSomething(),</span><br><span class="line">    <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">object</span>&gt;() &#123;&#123; <span class="string">&quot;methodName&quot;</span>, <span class="string">&quot;some method&quot;</span> &#125;&#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 综合使用</span></span><br><span class="line">Policy</span><br><span class="line">  .Handle&lt;SqlException&gt;(ex =&gt; ex.Number == <span class="number">1205</span>)</span><br><span class="line">  .Or&lt;ArgumentException&gt;(ex =&gt; ex.ParamName == <span class="string">&quot;example&quot;</span>)</span><br><span class="line">  .Retry()</span><br><span class="line">  .Execute(() =&gt; DoSomething());</span><br></pre></td></tr></table></figure>
<p>为了简单起见, 上面的示例显示了策略定义, 然后是策略执行。<br>但是在代码库和应用程序生命周期中, 策略定义和执行可能同样经常被<strong>分离</strong>。<br>例如, 可以选择在启动时定义策略, 然后通过<strong>依赖注入</strong>将其提供给使用点。</p>
<h3 id="故障处理（主动策略）"><a href="#故障处理（主动策略）" class="headerlink" title="故障处理（主动策略）"></a>故障处理（主动策略）</h3><p>主动策略添加了不基于当策略被引发或返回时才处理错误的弹性策略。</p>
<h4 id="第一步：配置"><a href="#第一步：配置" class="headerlink" title="第一步：配置"></a>第一步：配置</h4><h5 id="超时（Timeout）"><a href="#超时（Timeout）" class="headerlink" title="超时（Timeout）"></a>超时（Timeout）</h5><h6 id="乐观超时（Optimistic-timeout）"><a href="#乐观超时（Optimistic-timeout）" class="headerlink" title="乐观超时（Optimistic timeout）"></a>乐观超时（Optimistic timeout）</h6><p>乐观超时<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0FwcC12TmV4dC9Qb2xseS93aWtpL1RpbWVvdXQjb3B0aW1pc3RpYy10aW1lb3V0">通过 CancellationToken 运行<i class="fa fa-external-link-alt"></i></span>, 并假定您执行支持合作取消的委托。您必须使用 <code>Execute/Async(...)</code> 重载以获取 <code>CancellationToken</code>, 并且执行的委托必须遵守该 <code>CancellationToken</code>。</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 如果执行的委托尚未完成，在调用30秒后超时并返回 。 乐观超时: 委托应采取并遵守 CancellationToken。</span></span><br><span class="line">Policy</span><br><span class="line">  .Timeout(<span class="number">30</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 TimeSpan 配置超时。</span></span><br><span class="line">Policy</span><br><span class="line">  .Timeout(TimeSpan.FromMilliseconds(<span class="number">2500</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过方法提供可变的超时。</span></span><br><span class="line">Policy</span><br><span class="line">  .Timeout(() =&gt; myTimeoutProvider)) <span class="comment">// Func&lt;TimeSpan&gt; myTimeoutProvider</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 超时后触发事件。（事件参数为当前执行上下文、执行间隔、当前执行的TASK）</span></span><br><span class="line">Policy</span><br><span class="line">  .Timeout(<span class="number">30</span>, onTimeout: (context, timespan, task) =&gt; </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// do something </span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 示例：在超时后记录日志</span></span><br><span class="line">Policy</span><br><span class="line">  .Timeout(<span class="number">30</span>, onTimeout: (context, timespan, task) =&gt; </span><br><span class="line">    &#123;</span><br><span class="line">        logger.Warn(<span class="string">$&quot;<span class="subst">&#123;context.PolicyKey&#125;</span> at <span class="subst">&#123;context.ExecutionKey&#125;</span>: execution timed out after <span class="subst">&#123;timespan.TotalSeconds&#125;</span> seconds.&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 示例：在超时任务完成时捕获该任务中的任何异常</span></span><br><span class="line">Policy</span><br><span class="line">  .Timeout(<span class="number">30</span>, onTimeout: (context, timespan, task) =&gt; </span><br><span class="line">    &#123;</span><br><span class="line">        task.ContinueWith(t =&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (t.IsFaulted) logger.Error(<span class="string">$&quot;<span class="subst">&#123;context.PolicyKey&#125;</span> at <span class="subst">&#123;context.ExecutionKey&#125;</span>: execution timed out after <span class="subst">&#123;timespan.TotalSeconds&#125;</span> seconds, with: <span class="subst">&#123;t.Exception&#125;</span>.&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<p>示例执行:</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">Policy timeoutPolicy = Policy.TimeoutAsync(<span class="number">30</span>);</span><br><span class="line">HttpResponseMessage httpResponse = <span class="keyword">await</span> timeoutPolicy</span><br><span class="line">    .ExecuteAsync(</span><br><span class="line">      <span class="keyword">async</span> ct =&gt; <span class="keyword">await</span> httpClient.GetAsync(endpoint, ct), <span class="comment">// 执行一个有参数且响应 CancellationToken 的委托。</span></span><br><span class="line">      CancellationToken.None <span class="comment">// 在这种情况下, CancellationToken.None 将被传递到执行中, 这表明您没有将期望的令牌控制通过超时策略添加。 自定义 CancellationToken 也可以通过，详情请参阅 wiki 中的例子。</span></span><br><span class="line">      );</span><br></pre></td></tr></table></figure>
<h6 id="悲观超时（Pessimistic-timeout）"><a href="#悲观超时（Pessimistic-timeout）" class="headerlink" title="悲观超时（Pessimistic timeout）"></a>悲观超时（Pessimistic timeout）</h6><p>悲观超时允许调用代码 “离开” 等待执行完成的委托, 即使它不支持取消。<br>在同步执行中, 这是以牺牲一个额外的线程为代价的。有关更多细节, 请参见<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0FwcC12TmV4dC9Qb2xseS93aWtpL1RpbWVvdXQjcGVzc2ltaXN0aWMtdGltZW91dA==">文档<i class="fa fa-external-link-alt"></i></span>。<br>示例执行:</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">Policy timeoutPolicy = Policy.TimeoutAsync(<span class="number">30</span>, TimeoutStrategy.Pessimistic);</span><br><span class="line"><span class="keyword">var</span> response = <span class="keyword">await</span> timeoutPolicy</span><br><span class="line">    .ExecuteAsync(</span><br><span class="line">      <span class="keyword">async</span> () =&gt; <span class="keyword">await</span> FooNotHonoringCancellationAsync(), <span class="comment">// 执行不接受取消令牌且不响应取消的委托。</span></span><br><span class="line">      );</span><br></pre></td></tr></table></figure>
<p>超时策略在发生超时时引发 <code>TimeoutRejectedException</code>。<br>更多详情参见<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0FwcC12TmV4dC9Qb2xseS93aWtpL1RpbWVvdXQ=">文档<i class="fa fa-external-link-alt"></i></span>。</p>
<h5 id="隔板（Bulkhead）"><a href="#隔板（Bulkhead）" class="headerlink" title="隔板（Bulkhead）"></a>隔板（Bulkhead）</h5><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 通过该策略将执行限制为最多12个并发操作。</span></span><br><span class="line">Policy</span><br><span class="line">  .Bulkhead(<span class="number">12</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将通过策略执行的操作限制为最多12个并发操作, 如果插槽都被占满, 最多可以有两个操作被等待执行。</span></span><br><span class="line">Policy</span><br><span class="line">  .Bulkhead(<span class="number">12</span>, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 限制并发执行, 如果执行被拒绝, 则调用触发事件。（事件参数为当前执行上下文）</span></span><br><span class="line">Policy</span><br><span class="line">  .Bulkhead(<span class="number">12</span>, context =&gt; </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// do something </span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查看隔板可用容量, 例如健康负荷。</span></span><br><span class="line"><span class="keyword">var</span> bulkhead = Policy.Bulkhead(<span class="number">12</span>, <span class="number">2</span>);</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="built_in">int</span> freeExecutionSlots = bulkhead.BulkheadAvailableCount;</span><br><span class="line"><span class="built_in">int</span> freeQueueSlots     = bulkhead.QueueAvailableCount;</span><br></pre></td></tr></table></figure>

<p>当隔板策略的插槽全部被正在执行的操作占满是，会引发 <code>BulkheadRejectedException</code>。<br>更多详情参见<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0FwcC12TmV4dC9Qb2xseS93aWtpL0J1bGtoZWFk">文档<i class="fa fa-external-link-alt"></i></span>。</p>
<h5 id="缓存-Cache"><a href="#缓存-Cache" class="headerlink" title="缓存(Cache)"></a>缓存(Cache)</h5><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> memoryCache = <span class="keyword">new</span> MemoryCache(<span class="keyword">new</span> MemoryCacheOptions());</span><br><span class="line"><span class="keyword">var</span> memoryCacheProvider = <span class="keyword">new</span> MemoryCacheProvider(memoryCache);</span><br><span class="line"><span class="keyword">var</span> cachePolicy = Policy.Cache(memoryCacheProvider, TimeSpan.FromMinutes(<span class="number">5</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// .NET Core CacheProviders DI 示例 请参照以下文章  https://github.com/App-vNext/Polly/wiki/Cache#working-with-cacheproviders :</span></span><br><span class="line"><span class="comment">// - https://github.com/App-vNext/Polly.Caching.MemoryCache</span></span><br><span class="line"><span class="comment">// - https://github.com/App-vNext/Polly.Caching.IDistributedCache </span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义每天午夜绝对过期的缓存策略。</span></span><br><span class="line"><span class="keyword">var</span> cachePolicy = Policy.Cache(memoryCacheProvider, <span class="keyword">new</span> AbsoluteTtl(DateTimeOffset.Now.Date.AddDays(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义超时过期的缓存策略: 每次使用缓存项时, 项目的有效期为5分钟。</span></span><br><span class="line"><span class="keyword">var</span> cachePolicy = Policy.Cache(memoryCacheProvider, <span class="keyword">new</span> SlidingTtl(TimeSpan.FromMinutes(<span class="number">5</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义缓存策略, 并捕获任何缓存提供程序错误以进行日志记录。</span></span><br><span class="line"><span class="keyword">var</span> cachePolicy = Policy.Cache(myCacheProvider, TimeSpan.FromMinutes(<span class="number">5</span>), </span><br><span class="line">   (context, key, ex) =&gt; &#123; </span><br><span class="line">       logger.Error(<span class="string">$&quot;Cache provider, for key <span class="subst">&#123;key&#125;</span>, threw exception: <span class="subst">&#123;ex&#125;</span>.&quot;</span>); <span class="comment">// (for example) </span></span><br><span class="line">   &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 以直通缓存的身份执行缓存: 首先检查缓存;如果未找到, 请执行基础委托并将结果存储在缓存中。 </span></span><br><span class="line"><span class="comment">// 用于特定执行的缓存的键是通过在传递给执行的上下文实例上设置操作键 (v6 之前: 执行键) 来指定的。使用下面显示的窗体的重载 (或包含相同元素的更丰富的重载)。</span></span><br><span class="line"><span class="comment">// 示例: &quot;fookey&quot; 是将在下面的执行中使用的缓存密钥。</span></span><br><span class="line">TResult result = cachePolicy.Execute(context =&gt; getFoo(), <span class="keyword">new</span> Context(<span class="string">&quot;FooKey&quot;</span>));</span><br></pre></td></tr></table></figure>
<p>有关使用其他缓存提供程序的更丰富的选项和详细信息, 请参阅:<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0FwcC12TmV4dC9Qb2xseS93aWtpL0NhY2hl">文档<i class="fa fa-external-link-alt"></i></span></p>
<h5 id="策略包装（PolicyWrap）"><a href="#策略包装（PolicyWrap）" class="headerlink" title="策略包装（PolicyWrap）"></a>策略包装（PolicyWrap）</h5><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 定义由以前定义的策略构建的组合策略。</span></span><br><span class="line"><span class="keyword">var</span> policyWrap = Policy</span><br><span class="line">  .Wrap(fallback, cache, retry, breaker, timeout, bulkhead);</span><br><span class="line"><span class="comment">// (包装策略执行任何被包装的策略: fallback outermost ... bulkhead innermost)</span></span><br><span class="line">policyWrap.Execute(...)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义标准的弹性策略</span></span><br><span class="line">PolicyWrap commonResilience = Policy.Wrap(retry, breaker, timeout);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ... 然后包装在额外的策略特定于一个请求类型:</span></span><br><span class="line">Avatar avatar = Policy</span><br><span class="line">   .Handle&lt;Whatever&gt;()</span><br><span class="line">   .Fallback&lt;Avatar&gt;(Avatar.Blank)</span><br><span class="line">   .Wrap(commonResilience)</span><br><span class="line">   .Execute(() =&gt; &#123; <span class="comment">/* get avatar */</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 共享通用弹性, 但将不同的策略包装在另一个请求类型中:</span></span><br><span class="line">Reputation reps = Policy</span><br><span class="line">   .Handle&lt;Whatever&gt;()</span><br><span class="line">   .Fallback&lt;Reputation&gt;(Reputation.NotAvailable)</span><br><span class="line">   .Wrap(commonResilience)</span><br><span class="line">   .Execute(() =&gt; &#123; <span class="comment">/* get reputation */</span> &#125;);  </span><br></pre></td></tr></table></figure>
<p>更多详情参见<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0FwcC12TmV4dC9Qb2xseS93aWtpL1BvbGljeVdyYXA=">文档<i class="fa fa-external-link-alt"></i></span></p>
<h5 id="无策略-NoOp"><a href="#无策略-NoOp" class="headerlink" title="无策略(NoOp)"></a>无策略(NoOp)</h5><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 定义一个策略, 该策略将简单地导致传递给执行的委托 &quot;按原样&quot; 执行。</span></span><br><span class="line"><span class="comment">// 适用于在单元测试中或在应用程序中可能需要策略, 但您只是希望在没有策略干预的情况下通过执行的应用程序。</span></span><br><span class="line">NoOpPolicy noOp = Policy.NoOp();</span><br></pre></td></tr></table></figure>
<p>更多详情参见<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0FwcC12TmV4dC9Qb2xseS93aWtpL05vT3A=">文档<i class="fa fa-external-link-alt"></i></span></p>
<h4 id="第二步：执行策略"><a href="#第二步：执行策略" class="headerlink" title="第二步：执行策略"></a>第二步：执行策略</h4><p><a href="#">同上</a></p>
<h3 id="执行后：捕获结果或任何最终异常"><a href="#执行后：捕获结果或任何最终异常" class="headerlink" title="执行后：捕获结果或任何最终异常"></a>执行后：捕获结果或任何最终异常</h3><p>使用 ExecuteAndCapture(…)  方法可以捕获执行的结果: 这些方法返回一个执行结果实例, 该实例描述的是成功执行还是错误。</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> policyResult = <span class="keyword">await</span> Policy</span><br><span class="line">              .Handle&lt;HttpRequestException&gt;()</span><br><span class="line">              .RetryAsync()</span><br><span class="line">              .ExecuteAndCaptureAsync(() =&gt; DoSomethingAsync());</span><br><span class="line"><span class="comment">/*              </span></span><br><span class="line"><span class="comment">policyResult.Outcome - 调用是成功还是失败         </span></span><br><span class="line"><span class="comment">policyResult.FinalException - 最后一个异常。如果调用成功, 则捕获的最后一个异常将为 null</span></span><br><span class="line"><span class="comment">policyResult.ExceptionType - 定义为要处理的策略的最后一个异常 (如上面的 HttpRequestException) 或未处理的异常  (如 Exception). 如果调用成功, 则为 null。</span></span><br><span class="line"><span class="comment">policyResult.Result - 如果执行 func, 调用成功则返回执行结果, 否则为类型的默认值</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<h3 id="处理返回值和-Policy-lt-TResult-gt"><a href="#处理返回值和-Policy-lt-TResult-gt" class="headerlink" title="处理返回值和 Policy&lt;TResult&gt;"></a>处理返回值和 <code>Policy&lt;TResult&gt;</code></h3><p>如步骤1b 所述, 从 polly v4.3.0 开始, 策略可以组合处理返回值和异常:</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 在一个策略中处理异常和返回值</span></span><br><span class="line">HttpStatusCode[] httpStatusCodesWorthRetrying = &#123;</span><br><span class="line">   HttpStatusCode.RequestTimeout, <span class="comment">// 408</span></span><br><span class="line">   HttpStatusCode.InternalServerError, <span class="comment">// 500</span></span><br><span class="line">   HttpStatusCode.BadGateway, <span class="comment">// 502</span></span><br><span class="line">   HttpStatusCode.ServiceUnavailable, <span class="comment">// 503</span></span><br><span class="line">   HttpStatusCode.GatewayTimeout <span class="comment">// 504</span></span><br><span class="line">&#125;; </span><br><span class="line">HttpResponseMessage result = <span class="keyword">await</span> Policy</span><br><span class="line">  .Handle&lt;HttpRequestException&gt;()</span><br><span class="line">  .OrResult&lt;HttpResponseMessage&gt;(r =&gt; httpStatusCodesWorthRetrying.Contains(r.StatusCode))</span><br><span class="line">  .RetryAsync(...)</span><br><span class="line">  .ExecuteAsync( <span class="comment">/* some Func&lt;Task&lt;HttpResponseMessage&gt;&gt; */</span> )</span><br></pre></td></tr></table></figure>
<p>要处理的异常和返回结果可以以任意顺序流畅的表达。</p>
<h4 id="强类型-Policy-lt-TResult-gt"><a href="#强类型-Policy-lt-TResult-gt" class="headerlink" title="强类型 Policy&lt;TResult&gt;"></a>强类型 <code>Policy&lt;TResult&gt;</code></h4><p><code>配置策略 .HandleResult&lt;TResult&gt;(...) 或.OrResult&lt;TResult&gt;(...) 生成特定强类型策略 Policy&lt;TResult&gt;，例如 Retry&lt;TResult&gt;, AdvancedCircuitBreaker&lt;TResult&gt;</code>。<br>这些策略必须用于执行返回 TResult 的委托, 即:</p>
<ul>
<li><code>Execute(Func&lt;TResult&gt;) (and related overloads)</code></li>
<li><code>ExecuteAsync(Func&lt;CancellationToken, Task&lt;TResult&gt;&gt;) (and related overloads)</code></li>
</ul>
<h4 id="ExecuteAndCapture-lt-TResult-gt"><a href="#ExecuteAndCapture-lt-TResult-gt" class="headerlink" title="ExecuteAndCapture&lt;TResult&gt;()"></a><code>ExecuteAndCapture&lt;TResult&gt;()</code></h4><p>.ExecuteAndCapture(…) 在非泛型策略上返回具有属性的 PolicyResult：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">policyResult.Outcome - 调用是成功还是失败         </span><br><span class="line">policyResult.FinalException - 最后一个异常。如果调用成功, 则捕获的最后一个异常将为 <span class="literal">null</span></span><br><span class="line">policyResult.ExceptionType - 定义为要处理的策略的最后一个异常 (如上面的 HttpRequestException) 或未处理的异常  (如 Exception). 如果调用成功, 则为 <span class="literal">null</span>。</span><br><span class="line">policyResult.Result - 如果执行 func, 调用成功则返回执行结果, 否则为类型的默认值</span><br></pre></td></tr></table></figure>

<p><code>.ExecuteAndCapture&lt;TResult&gt;(Func&lt;TResult&gt;) </code>在强类型策略上添加了两个属性:</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">policyResult.FaultType - 最终的故障是处理异常还是由策略处理的结果？如果委托执行成功, 则为 <span class="literal">null</span>。</span><br><span class="line">policyResult.FinalHandledResult - 处理的最终故障结果;如果调用成功将为空或类型的默认值。</span><br></pre></td></tr></table></figure>
<h4 id="Policy-lt-TResult-gt-策略的状态更改事件"><a href="#Policy-lt-TResult-gt-策略的状态更改事件" class="headerlink" title="Policy&lt;TResult&gt;策略的状态更改事件"></a><code>Policy&lt;TResult&gt;</code>策略的状态更改事件</h4><p>在仅处理异常的非泛型策略中, 状态更改事件 (如 onRetry 和 onBreak ) 提供 Exception 参数。<br>在处理 TResult 返回值的通用性策略中, 状态更改委托是相同的, 除非它们采用 DelegateResult<TResult> 参数代替异常。DelegateResult<TResult>具有两个属性:</p>
<ul>
<li><strong>Exception</strong> // 如果策略正在处理异常则为则刚刚引发异常(否则为空),</li>
<li><strong>Result</strong> // 如果策略正在处理结果则为刚刚引发的 TResult (否则为 default(TResult))</li>
</ul>
<h4 id="BrokenCircuitException-lt-TResult-gt"><a href="#BrokenCircuitException-lt-TResult-gt" class="headerlink" title="BrokenCircuitException&lt;TResult&gt;"></a><code>BrokenCircuitException&lt;TResult&gt;</code></h4><p>非通用的循环断路器策略在断路时抛出一个BrokenCircuitException。此 BrokenCircuitException 包含最后一个异常 (导致中断的异常) 作为 InnerException。<br>关于 <code>CircuitBreakerPolicy&lt;TResult&gt;</code> 策略:</p>
<ul>
<li>由于异常而中断将引发一个 BrokenCircuitException, 并将 InnerException 设置为触发中断的异常 (如以前一样)。</li>
<li>由于处理结果而中断会引发 ‘<code>BrokenCircuitException&lt;TResult&gt;</code>‘, 其 Result  属性设置为导致电路中断的结果.</li>
</ul>
<h3 id="Policy-Keys-与-Context-data"><a href="#Policy-Keys-与-Context-data" class="headerlink" title="Policy Keys 与 Context data"></a>Policy Keys 与 Context data</h3><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 用扩展方法 WithPolicyKey() 使用 PolicyKey 识别策略, </span></span><br><span class="line"><span class="comment">// (例如, 对于日志或指标中的相关性)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> policy = Policy</span><br><span class="line">    .Handle&lt;DataAccessException&gt;()</span><br><span class="line">    .Retry(<span class="number">3</span>, onRetry: (exception, retryCount, context) =&gt;</span><br><span class="line">       &#123;</span><br><span class="line">           logger.Error(<span class="string">$&quot;Retry <span class="subst">&#123;retryCount&#125;</span> of <span class="subst">&#123;context.PolicyKey&#125;</span> at <span class="subst">&#123;context.ExecutionKey&#125;</span>, due to: <span class="subst">&#123;exception&#125;</span>.&quot;</span>);</span><br><span class="line">       &#125;)</span><br><span class="line">    .WithPolicyKey(<span class="string">&quot;MyDataAccessPolicy&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在上下文中传递 ExecutionKey , 并使用 ExecutionKey 标识呼叫站点</span></span><br><span class="line"><span class="keyword">var</span> customerDetails = policy.Execute(myDelegate, <span class="keyword">new</span> Context(<span class="string">&quot;GetCustomerDetails&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// &quot;MyDataAccessPolicy&quot; -&gt; context.PolicyKey </span></span><br><span class="line"><span class="comment">// &quot;GetCustomerDetails  -&gt; context.ExecutionKey</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 将其他自定义信息从调用站点传递到执行上下文中 </span></span><br><span class="line"><span class="keyword">var</span> policy = Policy</span><br><span class="line">    .Handle&lt;DataAccessException&gt;()</span><br><span class="line">    .Retry(<span class="number">3</span>, onRetry: (exception, retryCount, context) =&gt;</span><br><span class="line">       &#123;</span><br><span class="line">           logger.Error(<span class="string">$&quot;Retry <span class="subst">&#123;retryCount&#125;</span> of <span class="subst">&#123;context.PolicyKey&#125;</span> at <span class="subst">&#123;context.ExecutionKey&#125;</span>, getting <span class="subst">&#123;context[<span class="string">&quot;Type&quot;</span>]&#125;</span> of id <span class="subst">&#123;context[<span class="string">&quot;Id&quot;</span>]&#125;</span>, due to: <span class="subst">&#123;exception&#125;</span>.&quot;</span>);</span><br><span class="line">       &#125;)</span><br><span class="line">    .WithPolicyKey(<span class="string">&quot;MyDataAccessPolicy&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">int</span> id = ... <span class="comment">// 客户id</span></span><br><span class="line"><span class="keyword">var</span> customerDetails = policy.Execute(context =&gt; GetCustomer(id), </span><br><span class="line">    <span class="keyword">new</span> Context(<span class="string">&quot;GetCustomerDetails&quot;</span>, <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">object</span>&gt;() &#123;&#123;<span class="string">&quot;Type&quot;</span>,<span class="string">&quot;Customer&quot;</span>&#125;,&#123;<span class="string">&quot;Id&quot;</span>,id&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>更多资料参考<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0FwcC12TmV4dC9Qb2xseS93aWtpL0tleXMtQW5kLUNvbnRleHQtRGF0YQ==">文档<i class="fa fa-external-link-alt"></i></span></p>
<h3 id="PolicyRegistry"><a href="#PolicyRegistry" class="headerlink" title="PolicyRegistry"></a>PolicyRegistry</h3><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 创建策略注册表 (例如在应用程序启动时) </span></span><br><span class="line">PolicyRegistry registry = <span class="keyword">new</span> PolicyRegistry();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用策略填充注册表</span></span><br><span class="line">registry.Add(<span class="string">&quot;StandardHttpResilience&quot;</span>, myStandardHttpResiliencePolicy);</span><br><span class="line"><span class="comment">// 或者:</span></span><br><span class="line">registry[<span class="string">&quot;StandardHttpResilience&quot;</span>] = myStandardHttpResiliencePolicy;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过 DI 将注册表实例传递给使用站点</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyServiceGateway</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">MyServiceGateway</span>(<span class="params">..., IReadOnlyPolicyRegistry&lt;<span class="built_in">string</span>&gt; registry, ...</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">       ...</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// (或者, 如果您更喜欢环境上下文模式, 请使用线程安全的单例)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用注册表中的策略</span></span><br><span class="line">registry.Get&lt;IAsyncPolicy&lt;HttpResponseMessage&gt;&gt;(<span class="string">&quot;StandardHttpResilience&quot;</span>)</span><br><span class="line">    .ExecuteAsync&lt;HttpResponseMessage&gt;(...)</span><br></pre></td></tr></table></figure>
<p>策略注册表具有一系列进一步的类似字典的语义, 例如 .ContainsKey(…), .TryGet<TPolicy>(…), .Count, .Clear(), 和 Remove(…)，适用于 v5.2.0 以上版本</p>
<p>有关详细信息, 请参阅: <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0FwcC12TmV4dC9Qb2xseS93aWtpL1BvbGljeVJlZ2lzdHJ5">文档<i class="fa fa-external-link-alt"></i></span></p>
<h3 id="NET-Core-使用Polly重试机制"><a href="#NET-Core-使用Polly重试机制" class="headerlink" title=".NET Core 使用Polly重试机制"></a>.NET Core 使用Polly重试机制</h3><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PollyController</span> : <span class="title">ApiController</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">readonly</span> RetryPolicy&lt;HttpResponseMessage&gt; _httpRequestPolicy;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PollyController</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        _httpRequestPolicy = Policy.HandleResult&lt;HttpResponseMessage&gt;(</span><br><span class="line">        r =&gt; r.StatusCode == HttpStatusCode.InternalServerError)</span><br><span class="line">        .WaitAndRetryAsync(<span class="number">3</span>,</span><br><span class="line">        retryAttempt =&gt; TimeSpan.FromSeconds(retryAttempt));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IHttpActionResult&gt; <span class="title">Get</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> httpClient = <span class="keyword">new</span> HttpClient();</span><br><span class="line">        <span class="keyword">var</span> requestEndpoint = <span class="string">&quot;http://www.baidu.com&quot;</span>;</span><br><span class="line"></span><br><span class="line">        HttpResponseMessage httpResponse = <span class="keyword">await</span> _httpRequestPolicy.ExecuteAsync(() =&gt; httpClient.GetAsync(requestEndpoint));</span><br><span class="line"></span><br><span class="line">        IEnumerable&lt;<span class="built_in">string</span>&gt; numbers = <span class="keyword">await</span> httpResponse.Content.ReadAsAsync&lt;IEnumerable&lt;<span class="built_in">string</span>&gt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Ok(numbers);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
      <tags>
        <tag>.NET</tag>
        <tag>Polly</tag>
        <tag>熔断降级</tag>
        <tag>微服务</tag>
      </tags>
  </entry>
  <entry>
    <title>【新手学Java】使用内省(Introspector)操作JavaBean属性</title>
    <url>/posts/50715.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>使用内省(Introspector)操作</p>
<span id="more"></span>
<p>获取类bean中的所有属性:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="comment">//获取类bean中的所有属性</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">    <span class="type">BeanInfo</span> <span class="variable">info</span> <span class="operator">=</span> Introspector.getBeanInfo(Person.class);</span><br><span class="line">    PropertyDescriptor[] decriptors = info.getPropertyDescriptors();</span><br><span class="line">    <span class="keyword">for</span>(PropertyDescriptor decriptor : decriptors)&#123;</span><br><span class="line">        <span class="comment">//输出属性的名称</span></span><br><span class="line">        System.out.println(decriptor.getName());</span><br><span class="line">        <span class="comment">//输出属性的类型</span></span><br><span class="line">        System.out.println(decriptor.getPropertyType());</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>读/写bean中某个属性:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="comment">//操纵bean中某个属性</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test2</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">    Person p=<span class="keyword">new</span> <span class="title class_">Person</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="type">PropertyDescriptor</span> <span class="variable">decriptor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PropertyDescriptor</span>(<span class="string">&quot;username&quot;</span>,Person.class);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//得到属性的写方法</span></span><br><span class="line">    Method method=decriptor.getWriteMethod();</span><br><span class="line">    method.invoke(p, <span class="string">&quot;张三&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//得到属性的读方法</span></span><br><span class="line">    method=decriptor.getReadMethod();</span><br><span class="line">    String username= (String) method.invoke(p);</span><br><span class="line">    System.out.println(username);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>Introspector</tag>
        <tag>javabean</tag>
      </tags>
  </entry>
  <entry>
    <title>【新手学Java】反射学习笔记</title>
    <url>/posts/16721.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>示例类代码</p>
<span id="more"></span>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings(&quot;unused&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String Name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> Age;</span><br><span class="line">    <span class="keyword">public</span> Gender Gender;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">Species</span> <span class="operator">=</span> <span class="string">&quot;人类&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">()</span>&#123;</span><br><span class="line">        Name=<span class="string">&quot;佚名&quot;</span>;</span><br><span class="line">        Age=-<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">(String name)</span>&#123;</span><br><span class="line">        Name=name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Person</span><span class="params">(String name,<span class="type">int</span> age)</span>&#123;</span><br><span class="line">        Name=name;</span><br><span class="line">        Age=age;</span><br><span class="line">    &#125;    </span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Person</span><span class="params">(Gender g)</span>&#123;</span><br><span class="line">        Gender=g;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">Run</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(Name+<span class="string">&quot; 跑!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">Attack</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(Name+<span class="string">&quot; 打!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">Attack</span><span class="params">(String name)</span>&#123;</span><br><span class="line">        System.out.println(Name+<span class="string">&quot; 打 &quot;</span>+name+<span class="string">&quot;!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">Eat</span><span class="params">(String food)</span>&#123;</span><br><span class="line">        System.out.println(Name+<span class="string">&quot; 吃 &quot;</span>+food);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">Introduce</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;我叫&quot;</span>+Name+<span class="string">&quot;,我今年&quot;</span>+Age+<span class="string">&quot;岁了。&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">PlayGame</span><span class="params">(String gameName)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;玩 &quot;</span>+gameName+<span class="string">&quot; 游戏&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;main&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(String s:args)</span><br><span class="line">            System.out.println(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">Gender</span>&#123;</span><br><span class="line">    Male,Female</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>反射类的无参构造函数:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="comment">//反射类的无参构造函数</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">constructor1</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">    <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;pro.shaowei.reflect.Person&quot;</span>);</span><br><span class="line">    Constructor c=clazz.getConstructor();</span><br><span class="line">    <span class="type">Person</span> <span class="variable">p</span> <span class="operator">=</span> (Person) c.newInstance();</span><br><span class="line">    <span class="type">Person</span> <span class="variable">p1</span> <span class="operator">=</span> (Person) clazz.newInstance();</span><br><span class="line">    p.Introduce();</span><br><span class="line">    p.Run();</span><br><span class="line">    p1.Introduce();</span><br><span class="line">    p1.Run();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>反射类的有参构造函数:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="comment">//反射类的有参构造函数</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">constructor2</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">    Class clazz=Class.forName(<span class="string">&quot;pro.shaowei.reflect.Person&quot;</span>);</span><br><span class="line">    Constructor c=clazz.getConstructor(String.class);</span><br><span class="line">    Person p=((Person) c.newInstance(<span class="string">&quot;张三&quot;</span>));</span><br><span class="line">    p.Introduce();</span><br><span class="line">    p.Run();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>反射类的私有构造函数:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="comment">//反射类的私有构造函数</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">constructor3</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">    Class clazz=Class.forName(<span class="string">&quot;pro.shaowei.reflect.Person&quot;</span>);</span><br><span class="line">    <span class="comment">//反射私有构造函数时必须从使用 getDeclaredConstructor 方法</span></span><br><span class="line">    Constructor c=clazz.getDeclaredConstructor(String.class,<span class="type">int</span>.class);</span><br><span class="line">    c.setAccessible(<span class="literal">true</span>);<span class="comment">//暴力反射</span></span><br><span class="line">    Person p=((Person) c.newInstance(<span class="string">&quot;张三&quot;</span>,<span class="number">25</span>));</span><br><span class="line">    p.Introduce();</span><br><span class="line">    p.Run();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>反射类的公有无参方法:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="comment">//反射类的公有无参方法</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method1</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">    Class clazz=Class.forName(<span class="string">&quot;pro.shaowei.reflect.Person&quot;</span>);</span><br><span class="line">    Person p=(Person) clazz.newInstance();</span><br><span class="line">    Method method=clazz.getMethod(<span class="string">&quot;Run&quot;</span>);</span><br><span class="line">    method.invoke(p);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>反射类的公有有参方法:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="comment">//反射类的公有有参方法</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method2</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">    Class clazz=Class.forName(<span class="string">&quot;pro.shaowei.reflect.Person&quot;</span>);</span><br><span class="line">    Person p=(Person) clazz.newInstance();</span><br><span class="line">    Method method=clazz.getMethod(<span class="string">&quot;Attack&quot;</span>,String.class);</span><br><span class="line">    method.invoke(p,<span class="string">&quot;李四&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>反射类的私有有参方法:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="comment">//反射类的私有有参方法</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method3</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">    Class clazz=Class.forName(<span class="string">&quot;pro.shaowei.reflect.Person&quot;</span>);</span><br><span class="line">    Person p=(Person) clazz.newInstance();</span><br><span class="line">    Method method=clazz.getDeclaredMethod(<span class="string">&quot;Eat&quot;</span>,String.class);</span><br><span class="line">    method.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    method.invoke(p,<span class="string">&quot;香蕉&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>反射类的静态有参方法:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="comment">//反射类的静态有参方法</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method4</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">    Class clazz=Class.forName(<span class="string">&quot;pro.shaowei.reflect.Person&quot;</span>);</span><br><span class="line">    Person p=(Person) clazz.newInstance();</span><br><span class="line">    Method method=clazz.getDeclaredMethod(<span class="string">&quot;PlayGame&quot;</span>,String.class);</span><br><span class="line">    method.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    method.invoke(p,<span class="string">&quot;扫雷&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>反射类的main方法:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="comment">//反射类的main方法</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method5</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">    Class clazz=Class.forName(<span class="string">&quot;pro.shaowei.reflect.Person&quot;</span>);</span><br><span class="line">    Person p=(Person) clazz.newInstance();</span><br><span class="line">    Method method=clazz.getDeclaredMethod(<span class="string">&quot;main&quot;</span>,String[].class);</span><br><span class="line">    method.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    method.invoke(p,(Object)<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;1&quot;</span>,<span class="string">&quot;2&quot;</span>&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>反射类公有的字段:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="comment">//反射类公有的字段</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">field1</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">    Class clazz=Class.forName(<span class="string">&quot;pro.shaowei.reflect.Person&quot;</span>);</span><br><span class="line">    Person p=(Person) clazz.newInstance();</span><br><span class="line">    Field field=clazz.getField(<span class="string">&quot;Name&quot;</span>);</span><br><span class="line">    System.out.println(field.get(p));</span><br><span class="line">    field.set(p, <span class="string">&quot;王五&quot;</span>);</span><br><span class="line">    p.Introduce();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>反射类私有的字段:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="comment">//反射类私有的字段</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">field2</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">    Class clazz=Class.forName(<span class="string">&quot;pro.shaowei.reflect.Person&quot;</span>);</span><br><span class="line">    Person p=(Person) clazz.newInstance();</span><br><span class="line">    Field field=clazz.getDeclaredField(<span class="string">&quot;Age&quot;</span>);</span><br><span class="line">    field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    System.out.println(field.get(p));</span><br><span class="line">    field.set(p, <span class="number">7</span>);</span><br><span class="line">    p.Introduce();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>反射类私有静态的字段:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="comment">//反射类私有静态的字段</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">field3</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">    Class clazz=Class.forName(<span class="string">&quot;pro.shaowei.reflect.Person&quot;</span>);</span><br><span class="line">    Person p=(Person) clazz.newInstance();</span><br><span class="line">    Field field=clazz.getDeclaredField(<span class="string">&quot;Species&quot;</span>);</span><br><span class="line">    field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    System.out.println(field.get(p));</span><br><span class="line">    field.set(p, <span class="string">&quot;不死族&quot;</span>);</span><br><span class="line">    System.out.println(field.get(p));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>反射</tag>
      </tags>
  </entry>
  <entry>
    <title>【爬虫学习笔记】.Net 使用 ScrapySharp 并行下载天涯图片</title>
    <url>/posts/31517.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>最近因为一个作业需要完成CNKI爬虫，研究爬虫架构的时候发现了这个疑似移植于Python的著名开源爬虫框架Scrapy的ScrapySharp，然而在网上寻找之后只发现了这个<span class="exturl" data-url="aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaGFkc3RqL2FydGljbGUvZGV0YWlscy8xODg5MTIyNw==">F#的Demo<i class="fa fa-external-link-alt"></i></span>，就使用原文中示例的网站写了这个C#版本的代码。</p>
<span id="more"></span>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>下面是代码:</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"><span class="keyword">using</span> HtmlAgilityPack;</span><br><span class="line"><span class="keyword">using</span> ScrapySharp.Extensions;</span><br><span class="line"><span class="keyword">using</span> ScrapySharp.Network;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ScrapySharpDemo</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//示例网站地址</span></span><br><span class="line">            <span class="keyword">var</span> url = <span class="string">&quot;http://bbs.tianya.cn/post-12-563201-1.shtml&quot;</span>;</span><br><span class="line">            <span class="keyword">var</span> web = <span class="keyword">new</span> ScrapingBrowser();</span><br><span class="line">            <span class="keyword">var</span> html = web.DownloadString(<span class="keyword">new</span> Uri(url));</span><br><span class="line">            <span class="keyword">var</span> doc = <span class="keyword">new</span> HtmlDocument();</span><br><span class="line">            doc.LoadHtml(html);</span><br><span class="line">            <span class="comment">//获取网站中的图片地址</span></span><br><span class="line">            <span class="keyword">var</span> urls= doc.DocumentNode.CssSelect(<span class="string">&quot;div.bbs-content &gt; img&quot;</span>).Select(node =&gt; node.GetAttributeValue(<span class="string">&quot;original&quot;</span>)).ToList();</span><br><span class="line">            <span class="comment">//并行下载图片</span></span><br><span class="line">            Parallel.ForEach(urls, SavePic);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">SavePic</span>(<span class="params"><span class="built_in">string</span> url</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> web = <span class="keyword">new</span> ScrapingBrowser();</span><br><span class="line">            <span class="comment">//因天涯网站限制,所有站外来源都无法访问图片,故先设置请求头Refer属性为当前页地址</span></span><br><span class="line">            web.Headers.Add(<span class="string">&quot;Referer&quot;</span>, <span class="string">&quot;http://bbs.tianya.cn/post-12-563201-1.shtml&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> pic = web.NavigateToPage(<span class="keyword">new</span> Uri(url)).RawResponse.Body;</span><br><span class="line">            <span class="keyword">var</span> file = url.Substring(url.LastIndexOf(<span class="string">&quot;/&quot;</span>, StringComparison.Ordinal));</span><br><span class="line">            <span class="keyword">if</span> (!Directory.Exists(<span class="string">&quot;imgs&quot;</span>))</span><br><span class="line">                Directory.CreateDirectory(<span class="string">&quot;imgs&quot;</span>);</span><br><span class="line">            File.WriteAllBytes(<span class="string">&quot;imgs&quot;</span> + file, pic);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论:"></a>结论:</h2><p>研究之后发现，ScrapySharp和Scrapy差距还是挺大的，没有Scrapy那样完善的八大组件，只含有Http请求的Downloader和基于HtmlAgilityPack扩展的网页解析功能，莫名有些小失望。</p>
]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
      <tags>
        <tag>C#</tag>
        <tag>爬虫</tag>
        <tag>ScrapySharp</tag>
      </tags>
  </entry>
  <entry>
    <title>【新手学Java】使用beanUtils控制javabean</title>
    <url>/posts/33316.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>使用beanUtils控制javabean</p>
<span id="more"></span>

<p>使用BeanUtils设置/读取属性的值以及默认支持的自动转化:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="comment">//使用BeanUtils设置/读取属性的值以及自动转化</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span> <span class="keyword">throws</span> IllegalAccessException, InvocationTargetException, NoSuchMethodException&#123;</span><br><span class="line">    Person p=<span class="keyword">new</span> <span class="title class_">Person</span>();</span><br><span class="line">    <span class="comment">//使用BeanUtils设置属性的值</span></span><br><span class="line">    BeanUtils.setProperty(p, <span class="string">&quot;username&quot;</span>, <span class="string">&quot;李四&quot;</span>);</span><br><span class="line">    <span class="comment">//使用BeanUtils读取属性的值        </span></span><br><span class="line">    System.out.println(BeanUtils.getProperty(p, <span class="string">&quot;username&quot;</span>););</span><br><span class="line">    <span class="comment">//类型不同依然可以自动转化,BeanUtils默认支持八种基本类型的转换</span></span><br><span class="line">    BeanUtils.setProperty(p,<span class="string">&quot;age&quot;</span>, <span class="string">&quot;123&quot;</span>);</span><br><span class="line">    System.out.println(p.getAge());</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注册已有的转化器来完成复杂类型的自动转化:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="comment">//注册已有的转化器来完成复杂类型的自动转化</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test3</span><span class="params">()</span> <span class="keyword">throws</span> IllegalAccessException, InvocationTargetException&#123;</span><br><span class="line">    Person p=<span class="keyword">new</span> <span class="title class_">Person</span>();</span><br><span class="line">    String birthday=<span class="string">&quot;1995-05-05&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//注册Apache提供的时间转换器</span></span><br><span class="line">    ConvertUtils.register(<span class="keyword">new</span> <span class="title class_">DateLocaleConverter</span>(), Date.class);</span><br><span class="line">    </span><br><span class="line">    BeanUtils.setProperty(p, <span class="string">&quot;birthday&quot;</span>, birthday);</span><br><span class="line">    </span><br><span class="line">    System.out.println(p.getBirthday());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> Apache已有的时间转化器中不能很好地过滤空字符串，若待转换字符串为空则会抛出异常；而现实业务非常复杂，Apache无法提供给我们所有的类型转化方法，需要时我们可以注册自己需要的转换器完成业务需求。</p>
<p> 注册自己的转换器完成时间转化：<br> <figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="comment">//注册自己的转换器完成时间转化</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test2</span><span class="params">()</span> <span class="keyword">throws</span> IllegalAccessException, InvocationTargetException&#123;</span><br><span class="line">    Person p=<span class="keyword">new</span> <span class="title class_">Person</span>();</span><br><span class="line">    String birthday=<span class="string">&quot;1995-05-05&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//为了日期可以赋值到bean的属性,我们给benUtils注册日期转换器</span></span><br><span class="line">    ConvertUtils.register(<span class="keyword">new</span> <span class="title class_">Converter</span>()&#123;</span><br><span class="line">        <span class="meta">@SuppressWarnings(&#123; &quot;unchecked&quot;, &quot;rawtypes&quot; &#125;)</span></span><br><span class="line">        <span class="keyword">public</span> Object <span class="title function_">convert</span><span class="params">(Class type,Object value)</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(value==<span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(!(value <span class="keyword">instanceof</span> String))&#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ConversionException</span>(<span class="string">&quot;只支持String类型的转换&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            String str=(String) value;</span><br><span class="line">            <span class="keyword">if</span>(str.trim().equals(<span class="string">&quot;&quot;</span>))&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            SimpleDateFormat dateformate=<span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd&quot;</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> dateformate.parse(str);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ParseException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;                </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, Date.class);</span><br><span class="line">    </span><br><span class="line">    BeanUtils.setProperty(p, <span class="string">&quot;birthday&quot;</span>, birthday);</span><br><span class="line">    </span><br><span class="line">    System.out.println(p.getBirthday());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>直接使用map对象填充类:</p>
<p>```java<br>@Test<br>//直接使用map对象填充类<br>public void test4() throws Exception{<br>    HashMap&lt;String, String&gt; map=new HashMap&lt;String,String&gt;();<br>    map.put(“username”,”李四”);<br>    map.put(“password”,”lisi”);<br>    map.put(“age”,”26”);<br>    map.put(“birthday”,”1990-05-05”);</p>
<pre><code>ConvertUtils.register(new DateLocaleConverter() , Date.class);

Person p=new Person();
BeanUtils.populate(p, map);

System.out.println(p.getUsername());
System.out.println(p.getPassword());
System.out.println(p.getAge());
System.out.println(p.getBirthday());
</code></pre>
<p>}</p>
]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>javabean</tag>
        <tag>beanUtils</tag>
      </tags>
  </entry>
  <entry>
    <title>【爬虫学习笔记】DNS解析服务增加缓存机制</title>
    <url>/posts/2858.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p> 之前我们已经基于ARSoft.Tools.Net简单实现了DNS解析模块的功能，但是当性能要求升高时，每一次爬取都要进行DNS请求，甚至很有可能一段时间内每次请求的都是相同的地址，频繁的DNS请求就会成为性能瓶颈，所以我们要通过缓存机制将DNS解析结果缓存下来，降低DNS解析操作，提升系统性能。<br> <span id="more"></span><br> 如此，我们基于之前封装的MemoryCacheHelper类对DnsResolver类进行改造：<br> <figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"> <span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Diagnostics;</span><br><span class="line"><span class="keyword">using</span> System.Net;</span><br><span class="line"><span class="keyword">using</span> ARSoft.Tools.Net;</span><br><span class="line"><span class="keyword">using</span> ARSoft.Tools.Net.Dns;</span><br><span class="line"><span class="keyword">using</span> Mem = Crawler.Common.MemoryCacheHelper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Crawler.Protocol</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DnsResolver</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> TimeSpan TimeSpan &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Url &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> ARecord Record &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> DnsServer &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> TimeOut &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> ReturnCode ReturnCode &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">bool</span> IsSuccess &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> TimeSpan TimeToLive &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DnsResolver</span>(<span class="params"><span class="built_in">string</span> url, <span class="built_in">string</span> dnsServer = <span class="string">&quot;223.5.5.5&quot;</span>, <span class="built_in">int</span> timeOut = <span class="number">10000</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Url = url;</span><br><span class="line">            DnsServer = dnsServer;</span><br><span class="line">            TimeOut = timeOut;</span><br><span class="line">            IsSuccess = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (Mem.Contains(url))</span><br><span class="line">                Fill(Mem.Get&lt;DnsResolver&gt;(url));</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                Dig();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Fill</span>(<span class="params">DnsResolver resolver</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            TimeSpan = resolver.TimeSpan;</span><br><span class="line">            Url = resolver.Url;</span><br><span class="line">            Record = resolver.Record;</span><br><span class="line">            DnsServer = resolver.DnsServer;</span><br><span class="line">            TimeOut = resolver.TimeOut;</span><br><span class="line">            ReturnCode = resolver.ReturnCode;</span><br><span class="line">            IsSuccess = resolver.IsSuccess;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Dig</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//初始化DnsClient，第一个参数为DNS服务器的IP，第二个参数为超时时间</span></span><br><span class="line">            <span class="keyword">var</span> dnsClient = <span class="keyword">new</span> DnsClient(IPAddress.Parse(DnsServer), TimeOut);</span><br><span class="line">            <span class="keyword">var</span> s = <span class="keyword">new</span> Stopwatch();</span><br><span class="line">            s.Start();</span><br><span class="line">            <span class="comment">//解析域名。将域名请求发送至DNS服务器解析，参数为需要解析的域名</span></span><br><span class="line">            <span class="keyword">var</span> dnsMessage = dnsClient.Resolve(DomainName.Parse(Url));</span><br><span class="line">            s.Stop();</span><br><span class="line">            TimeSpan = s.Elapsed;</span><br><span class="line">            <span class="comment">//若返回结果为空，或者存在错误，则该请求失败。</span></span><br><span class="line">            <span class="keyword">if</span> (dnsMessage == <span class="literal">null</span> || (dnsMessage.ReturnCode != ReturnCode.NoError &amp;&amp; dnsMessage.ReturnCode != ReturnCode.NxDomain))</span><br><span class="line">                IsSuccess = <span class="literal">false</span>;</span><br><span class="line">            <span class="comment">//循环遍历返回结果，将返回的IPV4记录添加到结果集List中。</span></span><br><span class="line">            <span class="keyword">if</span> (dnsMessage != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (dnsMessage.AnswerRecords.Count &gt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    Record = dnsMessage.AnswerRecords[<span class="number">0</span>] <span class="keyword">as</span> ARecord;</span><br><span class="line">                    <span class="keyword">if</span> (Record != <span class="literal">null</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        IsSuccess = <span class="literal">true</span>;</span><br><span class="line">                        TimeToLive=<span class="keyword">new</span> TimeSpan(<span class="number">0</span>,<span class="number">0</span>,Record.TimeToLive);</span><br><span class="line">                        Mem.Add(Url, <span class="keyword">this</span>, TimeToLive);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (dnsMessage != <span class="literal">null</span>) ReturnCode = dnsMessage.ReturnCode;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br> 这样,每次做完DNS解析后，会根据域名的TTL将解析结果缓存下来，下次查询时可以直接调用缓存，提高系统性能。</p>
]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
      <tags>
        <tag>爬虫</tag>
        <tag>缓存</tag>
      </tags>
  </entry>
  <entry>
    <title>【爬虫学习笔记】.Net 基于ARSoft.Tools.Net的DNS解析模块（半成品）</title>
    <url>/posts/61444.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>最近在做爬虫的作业，今天学习的内容是关于DNS解析模块的制作的。使用的库为ARSoft.Tools.Net，它是一个非常强大的开源DNS控件库，包含.Net SPF validation, SenderID validation以及DNS Client、DNS Server接口。使用该接口可轻松实现DNS客户请求端及服务器解析端。</p>
<span id="more"></span>
<p>项目地址：<span class="exturl" data-url="aHR0cDovL2Fyc29mdHRvb2xzbmV0LmNvZGVwbGV4LmNvbS8lRUYlQkMlOEM=">http://arsofttoolsnet.codeplex.com/，<i class="fa fa-external-link-alt"></i></span></p>
<p>Nuget包地址：<span class="exturl" data-url="aHR0cHM6Ly93d3cubnVnZXQub3JnL3BhY2thZ2VzL0FSU29mdC5Ub29scy5OZXQvJUUzJTgwJTgy">https://www.nuget.org/packages/ARSoft.Tools.Net/。<i class="fa fa-external-link-alt"></i></span></p>
<h2 id="引入"><a href="#引入" class="headerlink" title="引入"></a>引入</h2><p>首先引入nuget包:</p>
<blockquote>
<p><strong>Install-Package ARSoft.Tools.NetInstall-Package ARSoft.Tools.Net</strong></p>
</blockquote>
<h2 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a>具体实现</h2><h3 id="实现代码"><a href="#实现代码" class="headerlink" title="实现代码:"></a>实现代码:</h3><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> DNS解析</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;dnsServer&quot;&gt;</span>DNS服务器IP<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;timeOut&quot;&gt;</span>解析超时时间<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;url&quot;&gt;</span>解析网址<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;isSuccess&quot;&gt;</span>是否解析成功<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>解析到的IP信息<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IPAddress <span class="title">DnsResolver</span>(<span class="params"><span class="built_in">string</span> dnsServer, <span class="built_in">int</span> timeOut, <span class="built_in">string</span> url, <span class="keyword">out</span> <span class="built_in">bool</span> isSuccess</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//初始化DnsClient，第一个参数为DNS服务器的IP，第二个参数为超时时间</span></span><br><span class="line">    <span class="keyword">var</span> dnsClient = <span class="keyword">new</span> DnsClient(IPAddress.Parse(dnsServer), timeOut);</span><br><span class="line">    <span class="comment">//解析域名。将域名请求发送至DNS服务器解析，第一个参数为需要解析的域名，第二个参数为</span></span><br><span class="line">    <span class="comment">//解析类型， RecordType.A为IPV4类型</span></span><br><span class="line">    <span class="comment">//DnsMessage dnsMessage = dnsClient.Resolve(&quot;www.sina.com&quot;, RecordType.A);</span></span><br><span class="line">    <span class="keyword">var</span> s = <span class="keyword">new</span> Stopwatch();</span><br><span class="line">    s.Start();</span><br><span class="line">    <span class="keyword">var</span> dnsMessage = dnsClient.Resolve(DomainName.Parse(url));</span><br><span class="line">    s.Stop();</span><br><span class="line">    Console.WriteLine(s.Elapsed.Milliseconds);</span><br><span class="line">    <span class="comment">//若返回结果为空，或者存在错误，则该请求失败。</span></span><br><span class="line">    <span class="keyword">if</span> (dnsMessage == <span class="literal">null</span> || (dnsMessage.ReturnCode != ReturnCode.NoError &amp;&amp; dnsMessage.ReturnCode != ReturnCode.NxDomain))</span><br><span class="line">    &#123;</span><br><span class="line">        isSuccess= <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//循环遍历返回结果，将返回的IPV4记录添加到结果集List中。</span></span><br><span class="line">    <span class="keyword">if</span> (dnsMessage != <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> dnsRecord <span class="keyword">in</span> dnsMessage.AnswerRecords)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> aRecord = dnsRecord <span class="keyword">as</span> ARecord;</span><br><span class="line">            <span class="keyword">if</span> (aRecord == <span class="literal">null</span>) <span class="keyword">continue</span>;</span><br><span class="line">            isSuccess = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">return</span> aRecord.Address;</span><br><span class="line">        &#125;</span><br><span class="line">    isSuccess= <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="调用代码"><a href="#调用代码" class="headerlink" title="调用代码"></a>调用代码</h3><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">bool</span> isSuccess;</span><br><span class="line">IPAddress ip = DnsResolver(<span class="string">&quot;223.5.5.5&quot;</span>, <span class="number">200</span>, <span class="string">&quot;shaoweicloud.cn&quot;</span>, <span class="keyword">out</span> isSuccess);</span><br><span class="line"><span class="keyword">if</span> (isSuccess)</span><br><span class="line">    Console.WriteLine(ip);</span><br></pre></td></tr></table></figure>
<h2 id="进一步封装"><a href="#进一步封装" class="headerlink" title="进一步封装"></a>进一步封装</h2><p>懂的使用方法后我们可以对它做进一步封装,得到<strong>DnsResolver</strong>类:</p>
<h3 id="实现代码-1"><a href="#实现代码-1" class="headerlink" title="实现代码"></a>实现代码</h3><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Diagnostics;</span><br><span class="line"><span class="keyword">using</span> System.Net;</span><br><span class="line"><span class="keyword">using</span> ARSoft.Tools.Net;</span><br><span class="line"><span class="keyword">using</span> ARSoft.Tools.Net.Dns;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Crawler.Protocol</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DnsResolver</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> TimeSpan TimeSpan &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Url &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> List Record &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> DnsServer &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> TimeOut &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> ReturnCode ReturnCode &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">bool</span> IsSuccess &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DnsResolver</span>(<span class="params"><span class="built_in">string</span> url, <span class="built_in">string</span> dnsServer = <span class="string">&quot;223.5.5.5&quot;</span>, <span class="built_in">int</span> timeOut = <span class="number">200</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Url = url;</span><br><span class="line">            DnsServer = dnsServer;</span><br><span class="line">            TimeOut = timeOut;</span><br><span class="line">            Record=<span class="keyword">new</span> List();</span><br><span class="line">            Dig();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Dig</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//初始化DnsClient，第一个参数为DNS服务器的IP，第二个参数为超时时间</span></span><br><span class="line">            <span class="keyword">var</span> dnsClient = <span class="keyword">new</span> DnsClient(IPAddress.Parse(DnsServer), TimeOut);</span><br><span class="line">            <span class="keyword">var</span> s = <span class="keyword">new</span> Stopwatch();</span><br><span class="line">            s.Start();</span><br><span class="line">            <span class="comment">//解析域名。将域名请求发送至DNS服务器解析，参数为需要解析的域名</span></span><br><span class="line">            <span class="keyword">var</span> dnsMessage = dnsClient.Resolve(DomainName.Parse(Url));</span><br><span class="line">            s.Stop();</span><br><span class="line">            TimeSpan = s.Elapsed;</span><br><span class="line">            <span class="comment">//若返回结果为空，或者存在错误，则该请求失败。</span></span><br><span class="line">            <span class="keyword">if</span> (dnsMessage == <span class="literal">null</span> || (dnsMessage.ReturnCode != ReturnCode.NoError &amp;&amp; dnsMessage.ReturnCode != ReturnCode.NxDomain))</span><br><span class="line">                IsSuccess = <span class="literal">false</span>;</span><br><span class="line">            <span class="comment">//循环遍历返回结果，将返回的IPV4记录添加到结果集List中。</span></span><br><span class="line">            <span class="keyword">if</span> (dnsMessage != <span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">var</span> dnsRecord <span class="keyword">in</span> dnsMessage.AnswerRecords)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">var</span> aRecord = dnsRecord <span class="keyword">as</span> ARecord;</span><br><span class="line">                    <span class="keyword">if</span> (aRecord == <span class="literal">null</span>) <span class="keyword">continue</span>;</span><br><span class="line">                    IsSuccess = <span class="literal">true</span>;</span><br><span class="line">                    Record.Add(aRecord);</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="keyword">if</span> (dnsMessage != <span class="literal">null</span>) ReturnCode = dnsMessage.ReturnCode;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="调用方法"><a href="#调用方法" class="headerlink" title="调用方法"></a>调用方法</h3><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">DnsResolver dns = <span class="keyword">new</span> DnsResolver(<span class="string">&quot;shaoweicloud.cn&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (dns.IsSuccess)</span><br><span class="line">    Console.WriteLine(dns.Record[<span class="number">0</span>]);</span><br></pre></td></tr></table></figure>

<h2 id="结束"><a href="#结束" class="headerlink" title="结束"></a>结束</h2><p> 至此，DNS解析模块就基本结束了，至于为什么标题中标注了半成品，是因为我想在基本的DNS解析功能的基础上根据解析到DNS信息中的TTL做一套信息缓存机制，减少不必要的重复查询，目前还在考虑使用何种方法，后续实现会更新。</p>
]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
      <tags>
        <tag>C#</tag>
        <tag>爬虫</tag>
        <tag>DNS</tag>
      </tags>
  </entry>
  <entry>
    <title>【爬虫学习笔记】MemoryCache缓存的用法学习</title>
    <url>/posts/30836.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>在完成了DNS解析模块之后，我意识到了DNS缓存机制也很有必要。在Redis，Memcache，和.Net自带的Cache之间,考虑到部署问题，最终选择了后者，之前在学习Web及开发的过程中用过System.Web.Caching.Cache这个类库，但是这次的爬虫程序我打算部署为桌面软件，所以选用了System.Runtime.Caching.MemoryCache（后期如有必要也会加入System.Web.Caching.Cache来适配Web端程序）。</p>
<p>MemoryCache的使用网上介绍的不多，不过这个是.NET4.0新引入的缓存对象，估计主要是替换原来企业库的缓存模块，使得.NET的缓存可以无处不在，而不用基于特定的Windows版本上使用。</p>
<p>出于方便考虑，我们将不再实例化新的MemoryCache对象，只对MemoryCache的默认示例Memory.Default进行增删查操作。</p>
<h2 id="基础操作"><a href="#基础操作" class="headerlink" title="基础操作"></a>基础操作</h2><h3 id="增加"><a href="#增加" class="headerlink" title="增加"></a>增加</h3><p><img data-src="https://qiniucdn.wayneshao.com/20180218211417/20180218091804918.png"><br>增加缓存需要提供两个参数，CacheItem类表示缓存中的单个缓存项,</p>
<p>构造函数:<br>CacheItem(String, Object, String)            用缓存项的指定键、值和区域初始化新的 CacheItem 实例。</p>
<p>三个参数分别为：键、值和区域。</p>
<p>CacheItemPolicy类则表示缓存项的过期信息，只含有默认的构造函数。</p>
<p>增加一条缓存：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> item = <span class="keyword">new</span> CacheItem(<span class="string">&quot;习大大&quot;</span>, <span class="string">&quot;两学一做&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> policy = <span class="keyword">new</span> CacheItemPolicy();</span><br><span class="line">policy.SlidingExpiration = <span class="keyword">new</span> TimeSpan(<span class="number">500</span>);</span><br><span class="line"><span class="comment">//插入一条key为&quot;习大大&quot;,value为&quot;两学一做&quot;,500毫秒后自动销毁的缓存</span></span><br><span class="line">MemoryCache.Default.Add(item, policy);</span><br><span class="line"><span class="comment">//重新设置policy的过期时间为当前时间+十分钟</span></span><br><span class="line">policy.AbsoluteExpiration = DateTimeOffset.Now + TimeSpan.FromMinutes(<span class="number">10</span>);</span><br><span class="line"><span class="comment">//注意,如果要使用Sliding时间,则Absolute必须为DateTimeOffset.MaxValue,反之,则Sliding必须为TimeSpan.Zero</span></span><br><span class="line">policy.SlidingExpiration = TimeSpan.Zero;</span><br><span class="line"><span class="comment">//重新插入,覆盖前一条数据</span></span><br><span class="line">MemoryCache.Default.Add(item, policy);</span><br></pre></td></tr></table></figure>
<p><font style="background-color: #ffff00">注意,如果要使用Sliding时间,则Absolute<strong>必须为DateTimeOffset.MaxValue</strong>,反之,则Sliding<strong>必须为TimeSpan.Zero</strong></font><strong> </strong></p>
<h3 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h3><p>缓存对象类似于字典集,查询可以直接采用memoryCache[key]来进行,例如我们查询一下前面插入的那条数据:</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> idea = MemoryCache.Default[<span class="string">&quot;习大大&quot;</span>];</span><br></pre></td></tr></table></figure>
<h3 id="移除"><a href="#移除" class="headerlink" title="移除"></a>移除</h3><p><img data-src="https://qiniucdn.wayneshao.com/20180218211417/20180218092011241.png"><br><strong>参数</strong><br><em><strong>key</strong></em>:要移除的缓存项的唯一标识符。<br><em><strong>regionName</strong></em>:缓存中的一个添加了缓存项的命名区域。不要为该参数传递值。默认情况下，此参数为null，因为 MemoryCache 类未实现区域。<br><strong>返回值</strong><br><em><strong>Type</strong></em>: <em>System.Object</em>  如果在缓存中找到该项，则为已移除的缓存项；否则为 null。</p>
<p>删除前面加入的那一项:</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">MemoryCache.Default.Remove(<span class="string">&quot;习大大&quot;</span>);</span><br></pre></td></tr></table></figure>
<h2 id="进一步封装"><a href="#进一步封装" class="headerlink" title="进一步封装"></a>进一步封装</h2><p>明白了基本的用法之后，我们就可以对它做进一步的封装，使之使用起来更为便捷：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.Caching;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Crawler.Common</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 基于MemoryCache的缓存辅助类</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">MemoryCacheHelper</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="built_in">object</span> _locker = <span class="keyword">new</span> <span class="built_in">object</span>();</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">Contains</span>(<span class="params"><span class="built_in">string</span> key</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> MemoryCache.Default.Contains(key);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 获取Catch元素</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span>所获取的元素的类型<span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;key&quot;&gt;</span>元素的键<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>特定的元素值<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> T <span class="title">Get</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="built_in">string</span> key</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrWhiteSpace(key)) <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">&quot;不合法的key!&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (!MemoryCache.Default.Contains(key))</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">&quot;获取失败,不存在该key!&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (!(MemoryCache.Default[key] <span class="keyword">is</span> T))</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">&quot;未找到所需类型数据!&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> (T)MemoryCache.Default[key];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 添加Catch元素</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;key&quot;&gt;</span>元素的键<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;value&quot;&gt;</span>元素的值<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;slidingExpiration&quot;&gt;</span>元素过期时间(时间间隔)<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;absoluteExpiration&quot;&gt;</span>元素过期时间(绝对时间)<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">Add</span>(<span class="params"><span class="built_in">string</span> key, <span class="built_in">object</span> <span class="keyword">value</span>, TimeSpan? slidingExpiration = <span class="literal">null</span>, DateTime? absoluteExpiration = <span class="literal">null</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> item = <span class="keyword">new</span> CacheItem(key, <span class="keyword">value</span>);</span><br><span class="line">            <span class="keyword">var</span> policy = CreatePolicy(slidingExpiration, absoluteExpiration);</span><br><span class="line">            <span class="keyword">lock</span> (_locker)</span><br><span class="line">                <span class="keyword">return</span> MemoryCache.Default.Add(item, policy);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 移出Cache元素</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span>待移出元素的类型<span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;key&quot;&gt;</span>待移除元素的键<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>已经移出的元素<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> T <span class="title">Remove</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="built_in">string</span> key</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrWhiteSpace(key)) <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">&quot;不合法的key!&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (!MemoryCache.Default.Contains(key))</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">&quot;获取失败,不存在该key!&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> <span class="keyword">value</span> = MemoryCache.Default.Get(key);</span><br><span class="line">            <span class="keyword">if</span> (!(<span class="keyword">value</span> <span class="keyword">is</span> T))</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">&quot;未找到所需类型数据!&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> (T)MemoryCache.Default.Remove(key);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 移出多条缓存数据,默认为所有缓存</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span>待移出的缓存类型<span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;keyList&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="title">List</span>&lt;<span class="title">T</span>&gt; <span class="title">RemoveAll</span>&lt;<span class="title">T</span>&gt;(<span class="params">IEnumerable&lt;<span class="built_in">string</span>&gt; keyList = <span class="literal">null</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (keyList != <span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">return</span> (<span class="keyword">from</span> key <span class="keyword">in</span> keyList</span><br><span class="line">                        <span class="keyword">where</span> MemoryCache.Default.Contains(key)</span><br><span class="line">                        <span class="keyword">where</span> MemoryCache.Default.Get(key) <span class="function"><span class="keyword">is</span> T</span></span><br><span class="line"><span class="function">                        <span class="title">select</span> (<span class="params">T</span>)MemoryCache.Default.<span class="title">Remove</span>(<span class="params">key</span>)).<span class="title">ToList</span>()</span>;</span><br><span class="line">            <span class="keyword">while</span> (MemoryCache.Default.GetCount() &gt; <span class="number">0</span>)</span><br><span class="line">                MemoryCache.Default.Remove(MemoryCache.Default.ElementAt(<span class="number">0</span>).Key);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> List&lt;T&gt;();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 设置过期信息</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;slidingExpiration&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;absoluteExpiration&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> CacheItemPolicy <span class="title">CreatePolicy</span>(<span class="params">TimeSpan? slidingExpiration, DateTime? absoluteExpiration</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> policy = <span class="keyword">new</span> CacheItemPolicy();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (absoluteExpiration.HasValue)</span><br><span class="line">            &#123;</span><br><span class="line">                policy.AbsoluteExpiration = absoluteExpiration.Value;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (slidingExpiration.HasValue)</span><br><span class="line">            &#123;</span><br><span class="line">                policy.SlidingExpiration = slidingExpiration.Value;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            policy.Priority = CacheItemPriority.Default;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> policy;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
      <tags>
        <tag>爬虫</tag>
        <tag>缓存</tag>
      </tags>
  </entry>
  <entry>
    <title>【爬虫学习笔记】ScrapySharp简单封装为Requester</title>
    <url>/posts/41785.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>为了便于使用及日后的扩展，将Scrapy简单封装为了Requester。</p>
<span id="more"></span>
<p>具体代码如下：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> Crawler.Common;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Crawler.Protocol</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Requester</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> Uri Url &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">private</span> Browser Browser &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Requester</span>(<span class="params"><span class="built_in">string</span> url, Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt; headers = <span class="literal">null</span>, Browser browser = <span class="literal">null</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> u = <span class="keyword">new</span> Uri(url);</span><br><span class="line">            <span class="comment">//检测地址是域名还是IP地址,如果是域名,则使用DnsResolver解析为IP地址</span></span><br><span class="line">            <span class="keyword">var</span> leftPart = u.GetLeftPart(UriPartial.Authority).Replace(u.GetLeftPart(UriPartial.Scheme), <span class="string">&quot;&quot;</span>);</span><br><span class="line">            <span class="comment">//正则匹配是否为IP地址</span></span><br><span class="line">            <span class="keyword">if</span> (!RegexHelper.IsMatch(leftPart, <span class="string">@&quot;\d+\.\d+\.\d+\.\d+\w&quot;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> dns = <span class="keyword">new</span> DnsResolver(leftPart);</span><br><span class="line">                <span class="keyword">if</span> (dns.IsSuccess)</span><br><span class="line">                    u = <span class="keyword">new</span> Uri(url.Replace(leftPart, dns.Record.Address.ToString()));</span><br><span class="line">            &#125;</span><br><span class="line">            Url = u;</span><br><span class="line">            Browser = browser ?? <span class="keyword">new</span> Browser();</span><br><span class="line">            <span class="keyword">if</span> (headers == <span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> header <span class="keyword">in</span> headers)</span><br><span class="line">                Browser.Headers[header.Key] = header.Value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">GetHtml</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> Browser.DownloadString(Url);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">byte</span>[] <span class="title">GetFile</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> Browser.NavigateToPage(Url).RawResponse.Body;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>考虑到可能对ScrapyBrowser做一些扩展（例如增加对FTP等其他协议的支持），故新建了Browser类继承自ScrapyBrowser类：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> ScrapySharp.Network;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Crawler.Protocol</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Browser</span> : <span class="title">ScrapingBrowser</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
      <tags>
        <tag>爬虫</tag>
        <tag>ScrapySharp</tag>
      </tags>
  </entry>
  <entry>
    <title>【爬虫学习笔记】基于Bloom Filter的url去重模块UrlSeen</title>
    <url>/posts/41470.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>Url Seen用来做url去重。对于一个大的爬虫系统，它可能已经有百亿或者千亿的url，新来一个url如何能快速的判断url是否已经出现过非常关键。因为大的爬虫系统可能一秒钟就会下载几千个网页，一个网页一般能够抽取出几十个url，而每个url都需要执行去重操作，可想每秒需要执行大量的去重操作。因此Url Seen是整个爬虫系统中非常有技术含量的一个部分。</p>
<span id="more"></span>

<p>为了提高过滤的效率,我们使用有极低误判率但是效率非常高的算法——Bloom Filter，已经有高手写好了Bloom Filter的算法实现，我们这里就直接站在巨人的肩膀上直接使用他写好的类库啦。</p>
<p>Nuget:</p>
<blockquote>
<p>Install-Package BloomFilter</p>
</blockquote>
<p>代码实现:</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> BloomFilterDotNet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Crawler.Processing</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Url Seen用来做url去重。对于一个大的爬虫系统，它可能已经有百亿或者千亿的url，新来一个url如何能快速的判断url是否已经出现过非常关键。因为大的爬虫系统可能一秒钟就会下载几千个网页，一个网页一般能够抽取出几十个url，而每个url都需要执行去重操作，可想每秒需要执行大量的去重操作。因此Url Seen是整个爬虫系统中非常有技术含量的一个部分。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UrlSeen</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> BloomFilter&lt;<span class="built_in">string</span>&gt; Seen &#123; <span class="keyword">set</span>; <span class="keyword">get</span>; &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">UrlSeen</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            Seen = <span class="keyword">new</span> BloomFilter&lt;<span class="built_in">string</span>&gt;(<span class="number">1000000</span>, <span class="number">0.0001</span>, <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">UrlSeen</span>(<span class="params"><span class="built_in">int</span> targetCapacity, <span class="built_in">double</span> falsePositiveRate</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Seen = <span class="keyword">new</span> BloomFilter&lt;<span class="built_in">string</span>&gt;(targetCapacity, falsePositiveRate, <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">MatchUrl</span>(<span class="params">Uri url</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> Seen.Contains(url.ToString());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> Count</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span> &#123; <span class="keyword">return</span> Seen.Count; &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Add</span>(<span class="params">Uri url</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Seen.Add(url.ToString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
      <tags>
        <tag>爬虫</tag>
        <tag>Bloom Filter</tag>
      </tags>
  </entry>
  <entry>
    <title>【爬虫学习笔记】Url过滤模块UrlFilter</title>
    <url>/posts/27677.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>Url Filter则是对提取出来的URL再进行一次筛选。不同的应用筛选的标准是不一样的，比如对于baidu/google的搜索，一般不进行筛选，但是对于垂直搜索或者定向抓取的应用，那么它可能只需要满足某个条件的url，比如不需要图片的url，比如只需要某个特定网站的url等等。Url Filter是一个和应用密切相关的模块。</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> Crawler.Common;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Crawler.Processing</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UrlFilter</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;Uri&gt; <span class="title">RemoveByRegex</span>(<span class="params">List&lt;Uri&gt; uris, <span class="keyword">params</span> <span class="built_in">string</span>[] regexs</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> uriList=<span class="keyword">new</span> List&lt;Uri&gt;(uris);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; uriList.Count; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">var</span> r <span class="keyword">in</span> regexs)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!RegexHelper.IsMatch(uriList[i].ToString(), r)) <span class="keyword">continue</span>;</span><br><span class="line">                    uris.RemoveAt(i);</span><br><span class="line">                    i--;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> uriList;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;Uri&gt; <span class="title">SelectByRegex</span>(<span class="params">List&lt;Uri&gt; uris, <span class="keyword">params</span> <span class="built_in">string</span>[] regexs</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> uriList = <span class="keyword">new</span> List&lt;Uri&gt;();</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> t <span class="keyword">in</span> uris)</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">var</span> r <span class="keyword">in</span> regexs)</span><br><span class="line">                    <span class="keyword">if</span> (RegexHelper.IsMatch(t.ToString(), r))</span><br><span class="line">                        <span class="keyword">if</span>(!uriList.Contains(t))</span><br><span class="line">                            uriList.Add(t);</span><br><span class="line">            <span class="keyword">return</span> uriList;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
      <tags>
        <tag>爬虫</tag>
        <tag>UrlFilter</tag>
      </tags>
  </entry>
  <entry>
    <title>【爬虫学习笔记】用于提取网页中所有链接的 Extractor 模块</title>
    <url>/posts/33241.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>   Extractor的工作是从下载的网页中将它包含的所有URL提取出来。这是个细致的工作，你需要考虑到所有可能的url的样式，比如网页中常常会包含相对路径的url，提取的时候需要将它转换成绝对路径。这里我们选择使用正则表达式来完成链接的提取。</p>
<p>   html标签中的链接地址通常会出现在href属性或者src属性中，所以我们采用两个正则表达式来匹配网页中的所有链接地址。</p>
<span id="more"></span>
<p>网页链接提取器Extractor类：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> Crawler.Common;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Crawler.Processing</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Extractor的工作是从下载的网页中将它包含的所有URL提取出来。这是个细致的工作，你需要考虑到所有可能的url的样式，比如网页中常常会包含相对路径的url，提取的时候需要将它转换成绝对路径。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Extractor</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> List&lt;Uri&gt; <span class="title">GetAllUrl</span>(<span class="params"><span class="built_in">string</span> html, <span class="built_in">string</span> host</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> list = <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt;();</span><br><span class="line">            <span class="comment">//匹配href属性</span></span><br><span class="line">            <span class="keyword">var</span> href = RegexHelper.ExtractStringArray(html, <span class="string">&quot;href *= *[&#x27;\&quot;]*(\\S+)[\&quot;&#x27;]&quot;</span>);</span><br><span class="line">            <span class="comment">//去掉匹配到字符串的空格、双引号和前面的href=，得到链接</span></span><br><span class="line">            <span class="keyword">var</span> temp = <span class="keyword">from</span> h <span class="keyword">in</span> href</span><br><span class="line">                       <span class="keyword">select</span> h.Replace(<span class="string">&quot; &quot;</span>, <span class="string">&quot;&quot;</span>).Replace(<span class="string">&quot;\&quot;&quot;</span>, <span class="string">&quot;&quot;</span>).Substring(<span class="number">5</span>);</span><br><span class="line">            <span class="comment">//加入数组</span></span><br><span class="line">            list.AddRange(temp);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//匹配src属性</span></span><br><span class="line">            <span class="keyword">var</span> src = RegexHelper.ExtractStringArray(html, <span class="string">&quot;src *= *[&#x27;\&quot;]*(\\S+)[\&quot;&#x27;]&quot;</span>);</span><br><span class="line">            temp = <span class="keyword">from</span> s <span class="keyword">in</span> src</span><br><span class="line">                   <span class="keyword">select</span> s.Replace(<span class="string">&quot; &quot;</span>, <span class="string">&quot;&quot;</span>).Replace(<span class="string">&quot;\&quot;&quot;</span>, <span class="string">&quot;&quot;</span>).Substring(<span class="number">4</span>);</span><br><span class="line">            list.AddRange(temp);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//去重</span></span><br><span class="line">            list = list.Distinct().ToList();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//将链接地址中的相对路径转换为绝对路径</span></span><br><span class="line">            <span class="keyword">var</span> uriList = list.Select(s =&gt; s.IndexOf(<span class="string">&quot;http://&quot;</span>, StringComparison.Ordinal) != <span class="number">0</span> ? <span class="keyword">new</span> Uri(<span class="keyword">new</span> Uri(host), s) : <span class="keyword">new</span> Uri(s)).ToList();</span><br><span class="line">            <span class="keyword">return</span> uriList.ToList();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
      <tags>
        <tag>爬虫</tag>
        <tag>Extractor</tag>
      </tags>
  </entry>
  <entry>
    <title>【爬虫学习笔记】基于 SimHash 的去重复处理模块ContentSeen的构建</title>
    <url>/posts/38230.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>Internet上的一些站点常常存在着镜像网站（mirror），即两个网站的内容一样但网页对应的域名不同。这样会导致对同一份网页爬虫重复抓取多次。为了避免这种情况，对于每一份抓取到的网页，它首先需要进入ContentSeen模块。该模块会判断网页的内容是否和已下载过的某个网页的内容一致，如果一致，则该网页不会再被送去进行下一步的处理。这样的做法能够显著的降低爬虫需要下载的网页数。至于如果判断两个网页的内容是否一致，一般的思路是这样的：并不会去直接比较两个网页的内容，而是将网页的内容经过计算生成FingerPrint（指纹），通常FingerPrint是一个固定长度的字符串，要比网页的正文短很多。如果两个网页的FingerPrint一样，则认为它们内容完全相同。</p>
<p>为了完成这一模块，首先我们需要一个强大的指纹算法，将我们的网页内容计算成指纹存入数据库，下次直接判断指纹在保存前通过指纹的对比即可成功完成去重复操作。</p>
<span id="more"></span>
<h2 id="SmiHash算法"><a href="#SmiHash算法" class="headerlink" title="SmiHash算法"></a>SmiHash算法</h2><p>首先来看一下大名鼎鼎的Google公司使用的网页去重复算法SimHash吧：</p>
<p>GoogleMoses Charikar发表的一篇论文“detecting near-duplicates for web crawling”中提出了simhash算法，专门用来解决亿万级别的网页的去重任务。</p>
<p>SimHash作为locality sensitive hash（局部敏感哈希）的一种：</p>
<p>其主要思想是降维，将高维的特征向量映射成低维的特征向量，通过两个向量的Hamming Distance来确定文章是否重复或者高度近似。</p>
<p>其中，Hamming Distance，又称汉明距离，在信息论中，两个等长字符串之间的汉明距离是两个字符串对应位置的不同字符的个数。也就是说，它就是将一个字符串变换成 另外一个字符串所需要替换的字符个数。例如：1011101 与 1001001 之间的汉明距离是 2。至于我们常说的字符串编辑距离则是一般形式的汉明距离。</p>
<p>如此，通过比较多个文档的SimHash值的海明距离，可以获取它们的相似度。</p>
<p>详情可以看这里<span class="exturl" data-url="aHR0cDovL3d3dy5jbmJsb2dzLmNvbS9jaGVueWluZzk5L3AvMzgzMDcyOC5odG1s">SimHash算法<i class="fa fa-external-link-alt"></i></span></p>
<h2 id="算法实现"><a href="#算法实现" class="headerlink" title="算法实现"></a>算法实现</h2><p>下面我们进行代码实现:</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Crawler.Common</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SimHashAnalyser</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">int</span> HashSize = <span class="number">32</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">float</span> <span class="title">GetLikenessValue</span>(<span class="params"><span class="built_in">string</span> needle, <span class="built_in">string</span> haystack, TokeniserType type = TokeniserType.Overlapping</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> needleSimHash = GetSimHash(needle, type);</span><br><span class="line">            <span class="keyword">var</span> hayStackSimHash = GetSimHash(haystack, type);</span><br><span class="line">            <span class="keyword">return</span> GetLikenessValue(needleSimHash, hayStackSimHash);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">float</span> <span class="title">GetLikenessValue</span>(<span class="params"><span class="built_in">int</span> needleSimHash, <span class="built_in">int</span> hayStackSimHash</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> (HashSize - GetHammingDistance(needleSimHash, hayStackSimHash)) / (<span class="built_in">float</span>)HashSize;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> IEnumerable&lt;<span class="built_in">int</span>&gt; <span class="title">DoHashTokens</span>(<span class="params">IEnumerable&lt;<span class="built_in">string</span>&gt; tokens</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> tokens.Select(token =&gt; token.GetHashCode()).ToList();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">int</span> <span class="title">GetHammingDistance</span>(<span class="params"><span class="built_in">int</span> firstValue, <span class="built_in">int</span> secondValue</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> hammingBits = firstValue ^ secondValue;</span><br><span class="line">            <span class="keyword">var</span> hammingValue = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">32</span>; i++)</span><br><span class="line">                <span class="keyword">if</span> (IsBitSet(hammingBits, i))</span><br><span class="line">                    hammingValue += <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">return</span> hammingValue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">IsBitSet</span>(<span class="params"><span class="built_in">int</span> b, <span class="built_in">int</span> pos</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> (b &amp; (<span class="number">1</span> &lt;&lt; pos)) != <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">int</span> <span class="title">GetSimHash</span>(<span class="params"><span class="built_in">string</span> input</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> GetSimHash(input, TokeniserType.Overlapping);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">int</span> <span class="title">GetSimHash</span>(<span class="params"><span class="built_in">string</span> input, TokeniserType tokeniserType</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            ITokeniser tokeniser;</span><br><span class="line">            <span class="keyword">if</span> (tokeniserType == TokeniserType.Overlapping)</span><br><span class="line">                tokeniser = <span class="keyword">new</span> OverlappingStringTokeniser();</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                tokeniser = <span class="keyword">new</span> FixedSizeStringTokeniser();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> hashedtokens = DoHashTokens(tokeniser.Tokenise(input));</span><br><span class="line">            <span class="keyword">var</span> vector = <span class="keyword">new</span> <span class="built_in">int</span>[HashSize];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; HashSize; i++)</span><br><span class="line">                vector[i] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> <span class="keyword">value</span> <span class="keyword">in</span> hashedtokens)</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; HashSize; j++)</span><br><span class="line">                    <span class="keyword">if</span> (IsBitSet(<span class="keyword">value</span>, j))</span><br><span class="line">                        vector[j] += <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        vector[j] -= <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">var</span> fingerprint = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; HashSize; i++)</span><br><span class="line">                <span class="keyword">if</span> (vector[i] &gt; <span class="number">0</span>)</span><br><span class="line">                    fingerprint += <span class="number">1</span> &lt;&lt; i;</span><br><span class="line">            <span class="keyword">return</span> fingerprint;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">ITokeniser</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">IEnumerable&lt;<span class="built_in">string</span>&gt; <span class="title">Tokenise</span>(<span class="params"><span class="built_in">string</span> input</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FixedSizeStringTokeniser</span> : <span class="title">ITokeniser</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> <span class="built_in">ushort</span> _tokensize;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">FixedSizeStringTokeniser</span>(<span class="params"><span class="built_in">ushort</span> tokenSize = <span class="number">5</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (tokenSize &lt; <span class="number">2</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">&quot;Token 不能超出范围&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (tokenSize &gt; <span class="number">127</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">&quot;Token 不能超出范围&quot;</span>);</span><br><span class="line">            _tokensize = tokenSize;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> IEnumerable&lt;<span class="built_in">string</span>&gt; <span class="title">Tokenise</span>(<span class="params"><span class="built_in">string</span> input</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> chunks = <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt;();</span><br><span class="line">            <span class="keyword">var</span> offset = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> (offset &lt; input.Length)</span><br><span class="line">            &#123;</span><br><span class="line">                chunks.Add(<span class="keyword">new</span> <span class="built_in">string</span>(input.Skip(offset).Take(_tokensize).ToArray()));</span><br><span class="line">                offset += _tokensize;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> chunks;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">OverlappingStringTokeniser</span> : <span class="title">ITokeniser</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> <span class="built_in">ushort</span> _chunkSize;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> <span class="built_in">ushort</span> _overlapSize;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">OverlappingStringTokeniser</span>(<span class="params"><span class="built_in">ushort</span> chunkSize = <span class="number">4</span>, <span class="built_in">ushort</span> overlapSize = <span class="number">3</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (chunkSize &lt;= overlapSize)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="string">&quot;Chunck 必须大于 overlap&quot;</span>);</span><br><span class="line">            _overlapSize = overlapSize;</span><br><span class="line">            _chunkSize = chunkSize;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> IEnumerable&lt;<span class="built_in">string</span>&gt; <span class="title">Tokenise</span>(<span class="params"><span class="built_in">string</span> input</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> result = <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt;();</span><br><span class="line">            <span class="keyword">var</span> position = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> (position &lt; input.Length - _chunkSize)</span><br><span class="line">            &#123;</span><br><span class="line">                result.Add(input.Substring(position, _chunkSize));</span><br><span class="line">                position += _chunkSize - _overlapSize;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">enum</span> TokeniserType</span><br><span class="line">    &#123;</span><br><span class="line">        Overlapping,</span><br><span class="line">        FixedSize</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="调用"><a href="#调用" class="headerlink" title="调用"></a>调用</h2><p>调用方法如下:</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> s1 = <span class="string">&quot;the cat sat on the mat.&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> s2 = <span class="string">&quot;the cat sat on a mat.&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> similarity = SimHashAnalyser.GetLikenessValue(s1, s2);</span><br><span class="line"></span><br><span class="line">Console.Clear();</span><br><span class="line">Console.WriteLine(<span class="string">&quot;相似度: &#123;0&#125;%&quot;</span>, similarity * <span class="number">100</span>);</span><br><span class="line">Console.ReadKey();</span><br></pre></td></tr></table></figure>
<p>输出为:<br><strong>相似度: 78.125%</strong></p>
<h2 id="封装"><a href="#封装" class="headerlink" title="封装"></a>封装</h2><p>接下来就是对ContentSeen模块的简单封装:</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> Crawler.Common;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Crawler.Processing</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 对于每一份抓取到的网页，它首先需要进入Content Seen模块。该模块会判断网页的内容是否和已下载过的某个网页的内容一致，如果一致，则该网页不会再被送去进行下一步的处理。</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ContentSeen</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">int</span> <span class="title">GetFingerPrint</span>(<span class="params"><span class="built_in">string</span> html</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> SimHashAnalyser.GetSimHash(html);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">float</span> <span class="title">Similarity</span>(<span class="params"><span class="built_in">int</span> print1, <span class="built_in">int</span> print2</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> SimHashAnalyser.GetLikenessValue(print1, print2);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
      <tags>
        <tag>爬虫</tag>
      </tags>
  </entry>
  <entry>
    <title>【迷宫中的算法实践】迷宫生成算法——Prim算法</title>
    <url>/posts/47068.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>  普里姆算法（Prim算法），图论中的一种算法，可在加权连通图里搜索最小生成树。意即由此算法搜索到的边子集所构成的树中，不但包括了连通图里的所有顶点（英语：Vertex (graph theory)），且其所有边的权值之和亦为最小。该算法于1930年由捷克数学家沃伊捷赫·亚尔尼克（英语：Vojtěch Jarník）发现；并在1957年由美国计算机科学家罗伯特·普里姆（英语：Robert C. Prim）独立发现；1959年，艾兹格·迪科斯彻再次发现了该算法。因此，在某些场合，普里姆算法又被称为DJP算法、亚尔尼克算法或普里姆－亚尔尼克算法。</p>
<p>——来自百度百科</p>
<span id="more"></span>
<p>当我们将Prim算法用于迷宫生成时，情况有些不同，维基百科中给出了<span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvUHJpbSUyN3NfYWxnb3JpdGht">随机Prim迷宫生成算法(Randomized Prim’s algorithm)<i class="fa fa-external-link-alt"></i></span>的解释及实现过程：<br><img data-src="https://qiniucdn.wayneshao.com/20180218224344/20180218104613142.png"><br>我们将算法实现部分翻译成中文 </p>
<ol>
<li>让迷宫全都是墙.。</li>
<li>选一个格，作为迷宫的通路，然后把它的邻墙放入列表.。</li>
<li>当列表里还有墙时:<br> 1). 从列表里随机选一个墙，如果它对面的格子不是迷宫的通路:<br> 2). 把墙打通，让对面的格子成为迷宫的通路.。<br>把那个格子的邻墙加入列表。</li>
<li>如果对面的格子已经是通路了，那就从列表里移除这面墙。</li>
</ol>
<p>简单研究算法实现过程我们可以发现，Prim算法就是不断地从所有可以是通路的位置中随意选一个挖洞，直到没有可能为通路的位置。</p>
<p> 整个实现过程还是相当于随意为路线附权值的Prim算法。</p>
<p>下面我们来做C#下的代码实现：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 普利姆迷宫生成法</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;startX&quot;&gt;</span>起始点X坐标<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;startY&quot;&gt;</span>起始点Y坐标<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;widthLimit&quot;&gt;</span>迷宫宽度<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;heightLimit&quot;&gt;</span>迷宫高度<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;haveBorder&quot;&gt;</span>迷宫是否含有墙<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="keyword">private</span> <span class="built_in">int</span>[,] Prim(<span class="built_in">int</span> startX, <span class="built_in">int</span> startY, <span class="built_in">int</span> widthLimit, <span class="built_in">int</span> heightLimit,<span class="built_in">bool</span> haveBorder)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//block:不可通行    unBlock:可通行</span></span><br><span class="line">    <span class="keyword">const</span> <span class="built_in">int</span> block = <span class="number">0</span>,unBlock = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">var</span> r=<span class="keyword">new</span> Random();</span><br><span class="line">    <span class="comment">//迷宫尺寸合法化</span></span><br><span class="line">    <span class="keyword">if</span> (widthLimit &lt; <span class="number">1</span>)</span><br><span class="line">        widthLimit = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (heightLimit &lt; <span class="number">1</span>)</span><br><span class="line">        heightLimit = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">//迷宫起点合法化</span></span><br><span class="line">    <span class="keyword">if</span> (startX &lt; <span class="number">0</span> || startX &gt;= widthLimit)</span><br><span class="line">        startX = r.Next(<span class="number">0</span>, widthLimit);</span><br><span class="line">    <span class="keyword">if</span> (startY &lt; <span class="number">0</span> || startY &gt;= heightLimit)</span><br><span class="line">        startY = r.Next(<span class="number">0</span>, heightLimit);</span><br><span class="line">    <span class="comment">//减去边框所占的格子</span></span><br><span class="line">    <span class="keyword">if</span> (!haveBorder)</span><br><span class="line">    &#123;</span><br><span class="line">        widthLimit--;</span><br><span class="line">        heightLimit--;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//迷宫尺寸换算成带墙尺寸</span></span><br><span class="line">    widthLimit *= <span class="number">2</span>;</span><br><span class="line">    heightLimit *= <span class="number">2</span>;</span><br><span class="line">    <span class="comment">//迷宫起点换算成带墙起点</span></span><br><span class="line">    startX *= <span class="number">2</span>;</span><br><span class="line">    startY *= <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">if</span> (haveBorder)</span><br><span class="line">    &#123;</span><br><span class="line">        startX++;</span><br><span class="line">        startY++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//产生空白迷宫</span></span><br><span class="line">    <span class="keyword">var</span> mazeMap = <span class="keyword">new</span> <span class="built_in">int</span>[widthLimit + <span class="number">1</span>, heightLimit + <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> x = <span class="number">0</span>; x &lt;= widthLimit; x++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//mazeMap.Add(new BitArray(heightLimit + 1));</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> y = <span class="number">0</span>; y &lt;= heightLimit; y++)</span><br><span class="line">        &#123;</span><br><span class="line">            mazeMap[x, y] = block;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//邻墙列表</span></span><br><span class="line">    <span class="keyword">var</span> blockPos = <span class="keyword">new</span> List&lt;<span class="built_in">int</span>&gt;();</span><br><span class="line">    <span class="comment">//将起点作为目标格</span></span><br><span class="line">    <span class="built_in">int</span> targetX = startX, targetY = startY;</span><br><span class="line">    <span class="comment">//将起点标记为通路</span></span><br><span class="line">    mazeMap[targetX, targetY] = unBlock;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//记录邻墙</span></span><br><span class="line">    <span class="keyword">if</span> (targetY &gt; <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        blockPos.AddRange(<span class="keyword">new</span> <span class="built_in">int</span>[] &#123; targetX, targetY - <span class="number">1</span>, <span class="number">0</span> &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (targetX &lt; widthLimit)</span><br><span class="line">    &#123;</span><br><span class="line">        blockPos.AddRange(<span class="keyword">new</span> <span class="built_in">int</span>[] &#123; targetX + <span class="number">1</span>, targetY, <span class="number">1</span> &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (targetY &lt; heightLimit)</span><br><span class="line">    &#123;</span><br><span class="line">        blockPos.AddRange(<span class="keyword">new</span> <span class="built_in">int</span>[] &#123; targetX, targetY + <span class="number">1</span>, <span class="number">2</span> &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (targetX &gt; <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        blockPos.AddRange(<span class="keyword">new</span> <span class="built_in">int</span>[] &#123; targetX - <span class="number">1</span>, targetY, <span class="number">3</span> &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (blockPos.Count &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//随机选一堵墙</span></span><br><span class="line">        <span class="keyword">var</span> blockIndex = r.Next(<span class="number">0</span>, blockPos.Count / <span class="number">3</span>) * <span class="number">3</span>;</span><br><span class="line">        <span class="comment">//找到墙对面的墙</span></span><br><span class="line">        <span class="keyword">if</span> (blockPos[blockIndex + <span class="number">2</span>] == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            targetX = blockPos[blockIndex];</span><br><span class="line">            targetY = blockPos[blockIndex + <span class="number">1</span>] - <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (blockPos[blockIndex + <span class="number">2</span>] == <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            targetX = blockPos[blockIndex] + <span class="number">1</span>;</span><br><span class="line">            targetY = blockPos[blockIndex + <span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (blockPos[blockIndex + <span class="number">2</span>] == <span class="number">2</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            targetX = blockPos[blockIndex];</span><br><span class="line">            targetY = blockPos[blockIndex + <span class="number">1</span>] + <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (blockPos[blockIndex + <span class="number">2</span>] == <span class="number">3</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            targetX = blockPos[blockIndex] - <span class="number">1</span>;</span><br><span class="line">            targetY = blockPos[blockIndex + <span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//如果目标格未连通</span></span><br><span class="line">        <span class="keyword">if</span> (mazeMap[targetX, targetY] == block)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//联通目标格</span></span><br><span class="line">            mazeMap[blockPos[blockIndex], blockPos[blockIndex + <span class="number">1</span>]] = unBlock;</span><br><span class="line">            mazeMap[targetX, targetY] = unBlock;</span><br><span class="line">            <span class="comment">//添加目标格相邻格</span></span><br><span class="line">            <span class="keyword">if</span> (targetY &gt; <span class="number">1</span> &amp;&amp; mazeMap[targetX, targetY - <span class="number">1</span>] == block &amp;&amp; mazeMap[targetX, targetY - <span class="number">2</span>] == block)</span><br><span class="line">            &#123;</span><br><span class="line">                blockPos.AddRange(<span class="keyword">new</span> <span class="built_in">int</span>[] &#123; targetX, targetY - <span class="number">1</span>, <span class="number">0</span> &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (targetX &lt; widthLimit &amp;&amp; mazeMap[targetX + <span class="number">1</span>, targetY] == block &amp;&amp; mazeMap[targetX + <span class="number">2</span>, targetY] == block)</span><br><span class="line">            &#123;</span><br><span class="line">                blockPos.AddRange(<span class="keyword">new</span> <span class="built_in">int</span>[] &#123; targetX + <span class="number">1</span>, targetY, <span class="number">1</span> &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (targetY &lt; heightLimit &amp;&amp; mazeMap[targetX, targetY + <span class="number">1</span>] == block &amp;&amp; mazeMap[targetX, targetY + <span class="number">2</span>] == block)</span><br><span class="line">            &#123;</span><br><span class="line">                blockPos.AddRange(<span class="keyword">new</span> <span class="built_in">int</span>[] &#123; targetX, targetY + <span class="number">1</span>, <span class="number">2</span> &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (targetX &gt; <span class="number">1</span> &amp;&amp; mazeMap[targetX - <span class="number">1</span>, targetY] == block &amp;&amp; mazeMap[targetX - <span class="number">1</span>, targetY] == block)</span><br><span class="line">            &#123;</span><br><span class="line">                blockPos.AddRange(<span class="keyword">new</span> <span class="built_in">int</span>[] &#123; targetX - <span class="number">1</span>, targetY, <span class="number">3</span> &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        blockPos.RemoveRange(blockIndex, <span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mazeMap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>算法笔记</category>
      </categories>
      <tags>
        <tag>算法</tag>
        <tag>Prim</tag>
        <tag>迷宫</tag>
      </tags>
  </entry>
  <entry>
    <title>【迷宫中的算法实践】迷宫生成算法——递归分割算法</title>
    <url>/posts/62848.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p><strong>Recursive division method</strong></p>
<p>Mazes can be created with recursive division, an algorithm which works as follows: Begin with the maze’s space with no walls. Call this a chamber. Divide the chamber with a randomly positioned wall (or multiple walls) where each wall contains a randomly positioned passage opening within it. Then recursively repeat the process on the subchambers until all chambers are minimum sized. This method results in mazes with long straight walls crossing their space, making it easier to see which areas to avoid.</p>
<p>For example, in a rectangular maze, build at random points two walls that are perpendicular to each other. These two walls divide the large chamber into four smaller chambers separated by four walls. Choose three of the four walls at random, and open a one cell-wide hole at a random point in each of the three. Continue in this manner recursively, until every chamber has a width of one cell in either of the two directions.</p>
<span id="more"></span>
<p><img data-src="https://qiniucdn.wayneshao.com/20180218231937/20180218112102947.gif"></p>
<h2 id="递归分割算法"><a href="#递归分割算法" class="headerlink" title="递归分割算法"></a>递归分割算法</h2><p> 可以用递归分割法创建迷宫，算法的工作原理如下：</p>
<ol>
<li><p>开始创建迷宫，使整个空间没有壁，我们称之为“室”。</p>
</li>
<li><p>在随机位置生成壁将室分割为两个子室，并在壁上随机开孔，使子室联通。</p>
</li>
<li><p>重复步骤2，直到所有子室全部不可分割（即子室某一个维度等于1）。</p>
</li>
</ol>
<p>例如，在矩形迷宫中，在任意点建立彼此垂直的两个壁。 这两个壁将大腔室分成由四个壁分开的四个较小腔室。 随机选择四个墙壁中的三个，并在三个墙壁的随机点处打开一个单元格的孔。 继续以这种方式递归，直到每个室在两个方向中的任一个方向上具有一个单元的宽度。</p>
<h2 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h2><p>下面我们来做C#的代码实现：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 递归回溯法迷宫生成法</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;startX&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;startY&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;widthLimit&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;heightLimit&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">RecursiveBacktrack</span>(<span class="params"><span class="built_in">int</span> startX, <span class="built_in">int</span> startY, <span class="built_in">int</span> widthLimit, <span class="built_in">int</span> heightLimit</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    PathStack = <span class="keyword">new</span> Stack&lt;Point&gt;();</span><br><span class="line">    <span class="comment">//周围未连通格坐标</span></span><br><span class="line">    <span class="built_in">int</span>[] blockPos = <span class="keyword">new</span> <span class="built_in">int</span>[<span class="number">4</span>];</span><br><span class="line">    <span class="comment">//周围未标记格的数量</span></span><br><span class="line">    <span class="built_in">int</span> blockNum = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//将起点作为当前格</span></span><br><span class="line">    <span class="built_in">int</span> currentX = startX;</span><br><span class="line">    <span class="built_in">int</span> currentY = startY;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//标记起点</span></span><br><span class="line">    MazeMap[currentX, currentY] = UnBlock;</span><br><span class="line">    CreateScript.Add(<span class="keyword">new</span> ScriptPoint(<span class="keyword">new</span> Point(currentX, currentY), <span class="literal">false</span>));</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//检测周围有没有未连通的格子</span></span><br><span class="line">        blockNum = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//检查上方</span></span><br><span class="line">        <span class="keyword">if</span> (currentY &gt; <span class="number">1</span> &amp;&amp; MazeMap[currentX, currentY - <span class="number">2</span>] == Block)</span><br><span class="line">        &#123;</span><br><span class="line">            blockPos[blockNum] = <span class="number">0</span>;</span><br><span class="line">            blockNum++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//检查右侧</span></span><br><span class="line">        <span class="keyword">if</span> (currentX &lt; widthLimit &amp;&amp; MazeMap[currentX + <span class="number">2</span>, currentY] == Block)</span><br><span class="line">        &#123;</span><br><span class="line">            blockPos[blockNum] = <span class="number">1</span>;</span><br><span class="line">            blockNum++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//检查下方</span></span><br><span class="line">        <span class="keyword">if</span> (currentY &lt; heightLimit &amp;&amp; MazeMap[currentX, currentY + <span class="number">2</span>] == Block)</span><br><span class="line">        &#123;</span><br><span class="line">            blockPos[blockNum] = <span class="number">2</span>;</span><br><span class="line">            blockNum++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//检查左侧</span></span><br><span class="line">        <span class="keyword">if</span> (currentX &gt; <span class="number">1</span> &amp;&amp; MazeMap[currentX - <span class="number">2</span>, currentY] == Block)</span><br><span class="line">        &#123;</span><br><span class="line">            blockPos[blockNum] = <span class="number">3</span>;</span><br><span class="line">            blockNum++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//选出下一个当前格</span></span><br><span class="line">        <span class="keyword">if</span> (blockNum &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//随机选择一个邻格</span></span><br><span class="line">            blockNum = _r.Next(<span class="number">0</span>, blockNum);</span><br><span class="line">            <span class="comment">//把当前格入栈</span></span><br><span class="line">            PathStack.Push(<span class="keyword">new</span> Point(currentX, currentY));</span><br><span class="line">            <span class="comment">//连通邻格，并将邻格指定为当前格</span></span><br><span class="line">            <span class="keyword">switch</span> (blockPos[blockNum])</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                    MazeMap[currentX, currentY - <span class="number">1</span>] = UnBlock;</span><br><span class="line">                    CreateScript.Add(<span class="keyword">new</span> ScriptPoint(<span class="keyword">new</span> Point(currentX, currentY - <span class="number">1</span>), <span class="literal">false</span>));</span><br><span class="line">                    currentY -= <span class="number">2</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                    MazeMap[currentX + <span class="number">1</span>, currentY] = UnBlock;</span><br><span class="line">                    CreateScript.Add(<span class="keyword">new</span> ScriptPoint(<span class="keyword">new</span> Point(currentX + <span class="number">1</span>, currentY), <span class="literal">false</span>));</span><br><span class="line">                    currentX += <span class="number">2</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                    MazeMap[currentX, currentY + <span class="number">1</span>] = UnBlock;</span><br><span class="line">                    CreateScript.Add(<span class="keyword">new</span> ScriptPoint(<span class="keyword">new</span> Point(currentX, currentY + <span class="number">1</span>), <span class="literal">false</span>));</span><br><span class="line">                    currentY += <span class="number">2</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                    MazeMap[currentX - <span class="number">1</span>, currentY] = UnBlock;</span><br><span class="line">                    CreateScript.Add(<span class="keyword">new</span> ScriptPoint(<span class="keyword">new</span> Point(currentX - <span class="number">1</span>, currentY), <span class="literal">false</span>));</span><br><span class="line">                    currentX -= <span class="number">2</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//标记当前格</span></span><br><span class="line">            MazeMap[currentX, currentY] = UnBlock;</span><br><span class="line">            CreateScript.Add(<span class="keyword">new</span> ScriptPoint(<span class="keyword">new</span> Point(currentX, currentY), <span class="literal">false</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (PathStack.Count &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//将栈顶作为当前格</span></span><br><span class="line">            Point top = PathStack.Pop();</span><br><span class="line">            currentY = top.Y;</span><br><span class="line">            currentX = top.X;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (PathStack.Count &gt; <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>算法笔记</category>
      </categories>
      <tags>
        <tag>算法</tag>
        <tag>迷宫</tag>
        <tag>递归分割</tag>
      </tags>
  </entry>
  <entry>
    <title>一木禾网盘文件下载地址批量获取实现</title>
    <url>/posts/19316.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>流程清晰之后，我们就可以制作软件来对网盘地址链接批量处理得到下载链接。</p>
<span id="more"></span>
<h2 id="选型"><a href="#选型" class="headerlink" title="选型"></a>选型</h2><p>我们的整个操作流程类似模拟浏览器操作，最好的解决方法其实是使用Selenium直接操作浏览器抓取。不过这方面我还没什么研究，就直接用最近发现的<span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmZpc2hsZWUubmV0Lw==">木鱼<i class="fa fa-external-link-alt"></i></span>大牛的 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2ljY2Zpc2gvZnNsaWIubmV0d29yaw==">FSLib.Network<i class="fa fa-external-link-alt"></i></span> 库来实现。这个类库是实现了HTTP访问过程中对Cookie的自动处理，在大多数情况下都可以模拟浏览器。<br>使用nuget在项目中安装 <strong>FSLib.Network</strong> 包:</p>
<blockquote>
<p><strong>Install-Package network.fishlee.net</strong></p>
</blockquote>
<h2 id="获取流程实现"><a href="#获取流程实现" class="headerlink" title="获取流程实现"></a>获取流程实现</h2><p>下面来依据流程完成通过页面地址来获得文件下载连接的方法：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">async</span> <span class="keyword">void</span> <span class="title">GetDownLoadUrl</span>(<span class="params"><span class="built_in">string</span> fileUrl</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//建立HTTP客户端</span></span><br><span class="line">    <span class="keyword">var</span> client = <span class="keyword">new</span> HttpClient();</span><br><span class="line">    <span class="comment">//用于接收验证码</span></span><br><span class="line">    StringBuilder Result;</span><br><span class="line">    <span class="comment">//验证码的字符数组</span></span><br><span class="line">    <span class="built_in">byte</span>[] bytes;</span><br><span class="line">    <span class="comment">//用于接收下载链接</span></span><br><span class="line">    <span class="built_in">string</span> downPath = <span class="built_in">string</span>.Empty;</span><br><span class="line">    <span class="comment">//通过正则匹配到链接中的 fileid</span></span><br><span class="line">   <span class="built_in">int</span> id = Convert.ToInt32(Extract(fileUrl, <span class="string">&quot;\\d&#123;7,&#125;&quot;</span>));</span><br><span class="line">    <span class="comment">//有时会出现一级域名为ymhwp的情况，这里先做一下替换，以防不测</span></span><br><span class="line">    fileUrl = fileUrl.Replace(<span class="string">&quot;ymhwp&quot;</span>, <span class="string">&quot;yimuhe&quot;</span>);</span><br><span class="line">    <span class="comment">//创建展示页面请求</span></span><br><span class="line">    <span class="keyword">var</span> filecontext = client.Create&lt;<span class="built_in">string</span>&gt;(HttpMethod.Get, fileUrl);</span><br><span class="line">    <span class="comment">//发送请求</span></span><br><span class="line">    <span class="keyword">await</span> filecontext.SendTask();</span><br><span class="line">    <span class="keyword">if</span> (filecontext.IsValid())<span class="comment">//如果请求成功</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//替换链接中的fil为down，使其成为下载页面地址</span></span><br><span class="line">        fileUrl = fileUrl.Replace(<span class="string">&quot;file&quot;</span>, <span class="string">&quot;down&quot;</span>);</span><br><span class="line">        <span class="comment">//创建下载页面请求</span></span><br><span class="line">         <span class="keyword">var</span> downcontext = client.Create&lt;<span class="built_in">string</span>&gt;(HttpMethod.Get, fileUrl);</span><br><span class="line">        <span class="keyword">await</span> downcontext.SendTask();</span><br><span class="line">        <span class="keyword">if</span> (downcontext.IsValid())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//设置初始返回值为0，表示验证码输入错误，即识别失败</span></span><br><span class="line">            <span class="built_in">int</span> response = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> (response == <span class="number">0</span>)<span class="comment">//循环识别，直到识别成功</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//创建验证码图片请求</span></span><br><span class="line">                   <span class="keyword">var</span> vcode = client.Create&lt;Byte[]&gt;(HttpMethod.Get, <span class="string">&quot;http://www.yimuhe.com/n_downcode.php&quot;</span>);</span><br><span class="line">                <span class="keyword">await</span> vcode.SendTask();</span><br><span class="line">                <span class="keyword">if</span> (vcode.IsValid())</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//将获取到的验证码图片存入字节数组中</span></span><br><span class="line">                    bytes = vcode.Result;</span><br><span class="line">                    Result = <span class="keyword">new</span> StringBuilder(<span class="string">&#x27;\0&#x27;</span>, <span class="number">256</span>);</span><br><span class="line">                    <span class="comment">//识别验证码</span></span><br><span class="line">                    GetVcodeFromBuffer(<span class="number">1</span>, bytes, bytes.Length, Result);</span><br><span class="line">                    <span class="comment">//创建检验验证码请求</span></span><br><span class="line">                    <span class="keyword">var</span> resp = client.Create&lt;<span class="built_in">string</span>&gt;(HttpMethod.Post,</span><br><span class="line">                        <span class="string">&quot;http://www.yimuhe.com/n_downcode.php&quot;</span>, data: <span class="string">&quot;action=yz&amp;id=&quot;</span> + id + <span class="string">&quot;&amp;code=&quot;</span> + Result);</span><br><span class="line">                    <span class="keyword">await</span> resp.SendTask();</span><br><span class="line">                    <span class="keyword">if</span> (resp.IsValid())</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="comment">//返回验证码校验值、成功为1失败为0</span></span><br><span class="line">                        response = Convert.ToInt32(resp.Result);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//创建获取下载地址请求</span></span><br><span class="line">            <span class="keyword">var</span> h1 = client.Create&lt;<span class="built_in">string</span>&gt;(HttpMethod.Post,</span><br><span class="line">                    <span class="string">&quot;http://www.yimuhe.com/n_dd.php?file_id=&quot;</span> + id + <span class="string">&quot;&amp;ser=99&quot;</span>, refer: <span class="string">&quot;http://www.yimuhe.com/down-2546737.html&quot;</span>, data: id.ToString());</span><br><span class="line">            <span class="keyword">await</span> h1.SendTask();</span><br><span class="line">            <span class="keyword">if</span> (h1.IsValid())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//通过HtmlAgilityPack库完成html解析，获得下载地址</span></span><br><span class="line">                   HtmlDocument html = <span class="keyword">new</span> HtmlDocument();</span><br><span class="line">                html.LoadHtml(h1.Result);</span><br><span class="line">                downPath = html.GetElementbyId(<span class="string">&quot;downs&quot;</span>).Attributes[<span class="string">&quot;href&quot;</span>].Value;</span><br><span class="line">                tBAfter.AppendText(downPath + NewLine);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="批量获取实现"><a href="#批量获取实现" class="headerlink" title="批量获取实现"></a>批量获取实现</h3><p>我的批量实现思路为将要获取的链接加入一个队列当中，线程从队头移出数据一条进行地址获取，获取成功不进行操作，失败则将地址添回到队尾。循环获取直到队列为空。另一个队列储存正在处理的数据，仅当两个线程均为空时才会陆续结束所有线程。线程执行的方法在上边的方法基础上又做了一些修改。</p>
<p>具体实现代码如下：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">async</span> <span class="keyword">void</span> <span class="title">GetDownLoadUrl</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//当链接队列和正在处理队列存在不为空时，循环执行以下代码</span></span><br><span class="line">    <span class="keyword">while</span> (_pathList.Count &gt; <span class="number">0</span> || _pathReady.Count &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//当链接队列不为空时</span></span><br><span class="line">        <span class="keyword">if</span> (_pathList.Count &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//从队头取出一条数据</span></span><br><span class="line">            <span class="built_in">string</span> fileUrl = _pathList[<span class="number">0</span>];</span><br><span class="line">            _pathList.RemoveAt(<span class="number">0</span>);</span><br><span class="line">            _pathReady.Add(fileUrl);</span><br><span class="line">            <span class="comment">//建立HTTP客户端</span></span><br><span class="line">            <span class="keyword">var</span> client = <span class="keyword">new</span> HttpClient();</span><br><span class="line">            <span class="comment">//用于接收验证码</span></span><br><span class="line">            StringBuilder Result;</span><br><span class="line">            <span class="comment">//验证码的字符数组</span></span><br><span class="line">            <span class="built_in">byte</span>[] bytes;</span><br><span class="line">            <span class="comment">//用于接收下载链接</span></span><br><span class="line">            <span class="built_in">string</span> downPath = <span class="built_in">string</span>.Empty;</span><br><span class="line">            <span class="comment">//通过正则匹配到链接中的 fileid</span></span><br><span class="line">            <span class="built_in">int</span> id = Convert.ToInt32(Extract(fileUrl, <span class="string">&quot;\\d&#123;7,&#125;&quot;</span>));</span><br><span class="line">            <span class="comment">//有时会出现一级域名为ymhwp的情况，这里先做一下替换，以防不测</span></span><br><span class="line">            fileUrl = fileUrl.Replace(<span class="string">&quot;ymhwp&quot;</span>, <span class="string">&quot;yimuhe&quot;</span>);</span><br><span class="line">            <span class="comment">//创建展示页面请求</span></span><br><span class="line">            <span class="keyword">var</span> filecontext = client.Create&lt;<span class="built_in">string</span>&gt;(HttpMethod.Get, fileUrl);</span><br><span class="line">            <span class="comment">//发送请求</span></span><br><span class="line">            <span class="keyword">await</span> filecontext.SendTask();</span><br><span class="line">            <span class="keyword">if</span> (filecontext.IsValid())<span class="comment">//如果请求成功</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//替换链接中的fil为down，使其成为下载页面地址</span></span><br><span class="line">                fileUrl = fileUrl.Replace(<span class="string">&quot;file&quot;</span>, <span class="string">&quot;down&quot;</span>);</span><br><span class="line">                <span class="comment">//创建下载页面请求</span></span><br><span class="line">                <span class="keyword">var</span> downcontext = client.Create&lt;<span class="built_in">string</span>&gt;(HttpMethod.Get, fileUrl);</span><br><span class="line">                <span class="keyword">await</span> downcontext.SendTask();</span><br><span class="line">                <span class="keyword">if</span> (downcontext.IsValid())</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//设置初始返回值为0，表示验证码输入错误，即识别失败</span></span><br><span class="line">                    <span class="built_in">int</span> response = <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">while</span> (response == <span class="number">0</span>)<span class="comment">//循环识别，直到识别成功</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="comment">//创建验证码图片请求</span></span><br><span class="line">                        <span class="keyword">var</span> vcode = client.Create&lt;Byte[]&gt;(HttpMethod.Get, <span class="string">&quot;http://www.yimuhe.com/n_downcode.php&quot;</span>);</span><br><span class="line">                        <span class="keyword">await</span> vcode.SendTask();</span><br><span class="line">                        <span class="keyword">if</span> (vcode.IsValid())</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="comment">//将获取到的验证码图片存入字节数组中</span></span><br><span class="line">                            bytes = vcode.Result;</span><br><span class="line">                            Result = <span class="keyword">new</span> StringBuilder(<span class="string">&#x27;\0&#x27;</span>, <span class="number">256</span>);</span><br><span class="line">                            <span class="comment">//识别验证码</span></span><br><span class="line">                            GetVcodeFromBuffer(<span class="number">1</span>, bytes, bytes.Length, Result);</span><br><span class="line">                            <span class="comment">//创建检验验证码请求</span></span><br><span class="line">                            <span class="keyword">var</span> resp = client.Create&lt;<span class="built_in">string</span>&gt;(HttpMethod.Post,</span><br><span class="line">                                <span class="string">&quot;http://www.yimuhe.com/n_downcode.php&quot;</span>, data: <span class="string">&quot;action=yz&amp;id=&quot;</span> + id + <span class="string">&quot;&amp;code=&quot;</span> + Result);</span><br><span class="line">                            <span class="keyword">await</span> resp.SendTask();</span><br><span class="line">                            <span class="keyword">if</span> (resp.IsValid())</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="comment">//返回验证码校验值、成功为1失败为0</span></span><br><span class="line">                                response = Convert.ToInt32(resp.Result);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//创建获取下载地址请求</span></span><br><span class="line">                    <span class="keyword">var</span> h1 = client.Create&lt;<span class="built_in">string</span>&gt;(HttpMethod.Post,</span><br><span class="line">                            <span class="string">&quot;http://www.yimuhe.com/n_dd.php?file_id=&quot;</span> + id + <span class="string">&quot;&amp;ser=99&quot;</span>, refer: <span class="string">&quot;http://www.yimuhe.com/down-2546737.html&quot;</span>, data: id.ToString());</span><br><span class="line">                    <span class="keyword">await</span> h1.SendTask();</span><br><span class="line">                    <span class="keyword">if</span> (h1.IsValid())</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="comment">//通过HtmlAgilityPack库完成html解析，获得下载地址</span></span><br><span class="line">                        HtmlDocument html = <span class="keyword">new</span> HtmlDocument();</span><br><span class="line">                        html.LoadHtml(h1.Result);</span><br><span class="line">                        downPath = html.GetElementbyId(<span class="string">&quot;downs&quot;</span>).Attributes[<span class="string">&quot;href&quot;</span>].Value;</span><br><span class="line">                        <span class="comment">//将获取到的地址显示到界面</span></span><br><span class="line">                        tBAfter.AppendText(downPath + NewLine);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//如果downPath为空，则请求失败</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrWhiteSpace(downPath))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//将请求链接添回队尾</span></span><br><span class="line">                _pathList.Add(path);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//处理完毕，移出当前处理队列</span></span><br><span class="line">            _pathReady.Remove(path);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="结束"><a href="#结束" class="headerlink" title="结束"></a>结束</h2><p>本文旨在抛砖引玉，因为一些都懂得的原因，就不给出成品的下载地址了，有需要的童鞋可以自行完成。</p>
]]></content>
      <categories>
        <category>踩坑笔记</category>
      </categories>
      <tags>
        <tag>爬虫</tag>
      </tags>
  </entry>
  <entry>
    <title>【迷宫中的算法实践】迷宫问题算法综述</title>
    <url>/posts/26097.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p> 最近听闻数据结构与算法实践课的老师又出了和上年一样的选题，不禁想起了去年自己完成作业时的点点滴滴，遗憾当时没有写博客的习惯，之前的一些心得这一年实践的过去也逐渐淡忘了，突然就有了总结一下的想法，希望能有新的收获吧。<br> <span id="more"></span><br> 由于当时也没注意保存，软件完成过程中的一些文档早已丢失了，幸运的是Winform版源码还在，Unity3D版程序也还幸存，虽然由于时间紧张只完成了大概框架，但美观程度也远非Winform可以相比的，先上几张软件图吧：<br> <img data-src="https://qiniucdn.wayneshao.com/20180218222743/20180218102928613.png"><br> <img data-src="https://qiniucdn.wayneshao.com/20180218222743/20180218102935756.png"><br> <img data-src="https://qiniucdn.wayneshao.com/20180218222743/20180218102935756.png"></p>
<h2 id="生成算法"><a href="#生成算法" class="headerlink" title="生成算法"></a>生成算法</h2><p>软件实现了普利姆算法、递归回溯算法、递归分割算法和深度遍历图算法四种算法来完成迷宫的生成，前两种算法生成的迷宫本质上是一个二维矩阵网络形式的生成树，也就是说其中没有回路，同时从左下角的起点到迷宫中的每一点都有且仅有一条路径，递归分割法虽然不是生成树算法但是同样属于没有回路的迷宫生成算法，深度遍历图算法则来源于知网上的一篇论文，属于图的深度遍历算法，生成的迷宫随机性更强，路径也不止一条，但不得不说的确扮相比较差。</p>
<h3 id="普利姆算法迷宫（Prim）"><a href="#普利姆算法迷宫（Prim）" class="headerlink" title="普利姆算法迷宫（Prim）"></a>普利姆算法迷宫（Prim）</h3><p><img data-src="https://qiniucdn.wayneshao.com/20180218222743/20180218103025583.gif"></p>
<h3 id="递归分割算法（Recursive-division）"><a href="#递归分割算法（Recursive-division）" class="headerlink" title="递归分割算法（Recursive division）"></a>递归分割算法（Recursive division）</h3><p><img data-src="https://qiniucdn.wayneshao.com/20180218222743/20180218103145980.gif"></p>
<h3 id="递归回溯（Recursive-backtracker）"><a href="#递归回溯（Recursive-backtracker）" class="headerlink" title="递归回溯（Recursive backtracker）"></a>递归回溯（Recursive backtracker）</h3><p><img data-src="https://qiniucdn.wayneshao.com/20180218222743/20180218103226097.gif"></p>
<h3 id="深度遍历图（Deep-traversal-graph）"><a href="#深度遍历图（Deep-traversal-graph）" class="headerlink" title="深度遍历图（Deep traversal graph）"></a>深度遍历图（Deep traversal graph）</h3><p><img data-src="https://qiniucdn.wayneshao.com/20180218222743/20180218103309658.gif"></p>
<h2 id="寻路算法"><a href="#寻路算法" class="headerlink" title="寻路算法"></a>寻路算法</h2><p>至于寻路算法，软件实现了深度优先遍历、广度优先遍历、和A-Star三种算法，前两种自不必说，A-Star算法是一种启发式搜索算法，移动时会评估向周围八个方向行走的预期代价，实时选出更小代价的移动方向，不过因为生成的迷宫均为正方形迷宫且起点和终点固定为左上和右下，所以在本项目中，A-Star算法并未发挥出它应有的机智，效率与广度优先基本相同。后两种算法可以寻找到最短路径，而深度优先则并不能展示。图中绿色为正确路线，蓝色为寻路过程中经过的路线。。（PS：设定为深度广度四方向移动，A-Star八方向移动）</p>
<h3 id="深度优先遍历（DFS）"><a href="#深度优先遍历（DFS）" class="headerlink" title="深度优先遍历（DFS）"></a>深度优先遍历（DFS）</h3><p><img data-src="https://qiniucdn.wayneshao.com/20180218222743/20180218103413877.gif"></p>
<h3 id="广度优先遍历（BFS）"><a href="#广度优先遍历（BFS）" class="headerlink" title="广度优先遍历（BFS）"></a>广度优先遍历（BFS）</h3><p><img data-src="https://qiniucdn.wayneshao.com/20180218222743/20180218103500950.gif"></p>
<h3 id="A-Star"><a href="#A-Star" class="headerlink" title="A-Star"></a>A-Star</h3><p><img data-src="https://qiniucdn.wayneshao.com/20180218222743/20180218103540517.gif"><br>因为实例中的迷宫入口出口位置的特殊性，广度优先在寻路过程中基本要走完全称，显得有些不太机智，而A-Star的表现也和广度优先近似。<br><strong>本文章属于综述，后面的算法会分篇分别阐述。</strong></p>
]]></content>
      <categories>
        <category>算法笔记</category>
      </categories>
      <tags>
        <tag>算法</tag>
        <tag>迷宫</tag>
      </tags>
  </entry>
  <entry>
    <title>一木禾网盘文件下载地址抓取分析</title>
    <url>/posts/5284.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>本文是对抓取一木禾网盘文件下载地址的整个流程就行分析，并依次解决其中各个环节涉及的技术问题。</p>
<span id="more"></span>
<h2 id="缘由"><a href="#缘由" class="headerlink" title="缘由"></a>缘由</h2><p>最近因为一些个人原因用到了一木禾网盘，这个收费网盘虽然较一些国外的倒数30秒网盘容易了一些，也没有十分钟只能下载一个的限制，但如果下载资源较多还是显得十分麻烦。<br>网上搜索了很长时间，功夫不负有心认，终于在<span class="exturl" data-url="aHR0cHM6Ly93d3cuNTJwb2ppZS5jbi9mb3J1bS5waHA=">吾爱破解<i class="fa fa-external-link-alt"></i></span>找到了 <span class="exturl" data-url="aHR0cDovL3d3dy41MnBvamllLmNuL3NwYWNlLXVpZC0xMjYxMDkuaHRtbA==">cylisme<i class="fa fa-external-link-alt"></i></span> 作品 <span class="exturl" data-url="aHR0cDovL3d3dy41MnBvamllLmNuL3RocmVhZC0yMTU3MTktMS0xLmh0bWw=">一木禾网盘批量下载<i class="fa fa-external-link-alt"></i></span> 。<br>软件界面如下：<br><img data-src="https://qiniucdn.wayneshao.com//20180218182211/20180218063130751.png"><br>虽然可以进行使用，但是每一个验证码都必须手动输入，就起了自己制作一个网盘批量下载器的想法 。<br><strong>我本人只是一个C#初学者，言辞中有不正确的请指出，若文中内容侵犯了您的权益，请联系删除。</strong></p>
<h2 id="流程分析"><a href="#流程分析" class="headerlink" title="流程分析"></a>流程分析</h2><p>网页端获取下载地址流程分析：<br>使用Chrome的开发人员工具得到了以下流程<br><img data-src="https://qiniucdn.wayneshao.com//20180218182211/20180218063408396.png"><br>由上图可知，关键性技术问题为验证码识别</p>
<h2 id="验证码识别"><a href="#验证码识别" class="headerlink" title="验证码识别"></a>验证码识别</h2><p>一木禾的验证码是杂色点比较多的四位数字，如下图：<br><img data-src="https://qiniucdn.wayneshao.com//20180218182211/20180218083729794.png"><br>尝试过几次自行去杂色点识别数字，但是因为个人对图形处理方面的知识十分有限，均以失败告终，最终使用了<strong>次世代验证码识别系统2.3</strong>来完成验证码识别，系统支持C#调用，经过几次调教之后已经能对一木禾验证码有不错的识别率。<br>以下是软件界面:<br><img data-src="https://qiniucdn.wayneshao.com//20180218182211/20180218083901347.png"><br><img data-src="https://qiniucdn.wayneshao.com//20180218182211/20180218083907810.png"><br><em><strong>本篇主要进行一些理论分析，下篇做具体代码实现。</strong></em></p>
]]></content>
      <categories>
        <category>踩坑笔记</category>
      </categories>
      <tags>
        <tag>爬虫</tag>
      </tags>
  </entry>
  <entry>
    <title>.NET Core 不同程序集中存在相同命名空间时的解决思路</title>
    <url>/posts/2017.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>　　前几天同事遇到了这个问题，没查到资料找到了我这位老司机，隐约记得. NET Framework 应该用别名解决的我给出了两个字的解决方案 “别名”，被告知别名在. NET Core 中是不能像. NET Framework 中那样设置的，连忙打开 VS 亲自尝试了一下，以下是他遇到问题的两个包：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PM&gt; Install-Package StackExchange.Redis</span><br><span class="line">PM&gt; Install-Package StackExchange.Redis.StrongName</span><br></pre></td></tr></table></figure>
<p>　　随便按照文档的调用简单写了一句代码</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">ConnectionMultiplexer redis = ConnectionMultiplexer.Connect(<span class="string">&quot;localhost&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>！！<br>居然出了问题！</p>
<p>　　错误提示的大意为，StackExchange.Redis.dll 和 StackExchange.Redis.StrongName.dll 中都存在 StackExchange.Redis 命名空间，且命名空间下都有一个 ConnectionMultiplexer 类型，先不追究同事为何需要同时使用这样两个程序集，假设这是必要的，我们来尝试解决这个问题。</p>
<span id="more"></span>
<p>先试试使用. NET Framework 的老方法<br><img data-src="https://qiniucdn.wayneshao.com/.NET-Core-%E4%B8%8D%E5%90%8C/20180710081024412.png"></p>
<p>Framework 的方法在 Core 居然行不通，菜单里根本没有别名可以设置。<br>祭谷歌：<br><img data-src="https://qiniucdn.wayneshao.com/.NET-Core-%E4%B8%8D%E5%90%8C/20180710080824886.png"></p>
<p>　　然而翻了几页之后，大量的解决方法都是. Net Framework 的。<br>根据对微软的了解，我判断. NET Core 里属性菜单里虽然没有别名可以设置，但是解决方法一定还是落在 “别名” 上，很有可能是需要手动在项目文件中进行指定，中文描述不太准确，这方面的文章也比较滞后，再次尝试使用英文关键词搜索：</p>
<p><img data-src="https://qiniucdn.wayneshao.com/.NET-Core-%E4%B8%8D%E5%90%8C/20180710081620557.png"></p>
<p>只翻了两条，就在 Nuget 的一个 Issue 中找到了解决方法，果然是使用别名：</p>
<p><img data-src="https://qiniucdn.wayneshao.com/.NET-Core-%E4%B8%8D%E5%90%8C/20180710082052253.png"></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">&lt;Target Name=<span class="string">&quot;ChangeAliasesOfStrongNameAssemblies&quot;</span> BeforeTargets=<span class="string">&quot;FindReferenceAssembliesForReferences;ResolveReferences&quot;</span>&gt;</span><br><span class="line">    &lt;ItemGroup&gt;</span><br><span class="line">      &lt;ReferencePath Condition=<span class="string">&quot;&#x27;%(FileName)&#x27; == &#x27;StackExchange.Redis.StrongName&#x27;&quot;</span>&gt;</span><br><span class="line">        &lt;Aliases&gt;signed&lt;/Aliases&gt;</span><br><span class="line">      &lt;/ReferencePath&gt;</span><br><span class="line">    &lt;/ItemGroup&gt;</span><br><span class="line">  &lt;/Target&gt;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>踩坑笔记</category>
      </categories>
      <tags>
        <tag>EFCore</tag>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>使用 GitLab CI 进行 hexo 的持续集成</title>
    <url>/posts/34874.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>其实很早之前我就意识到，把博客的源码不加掩饰的直接托管在 Github 是一件颇为危险的事，配置文件中配置的各种平台的 key 随时有可能被窃取，只是一直懒得动手，今天得闲把整个流程捋顺了，遂记录一下。</p>
<span id="more"></span>
<h1 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h1><ol>
<li>本文使用 <span class="exturl" data-url="aHR0cHM6Ly9naXRsYWIuY29tLw==">GitLab<i class="fa fa-external-link-alt"></i></span> 提供的共享 gitlab-runner 来进行持续集成，本来手头有一台腾讯云的 1GB RAM、 CentOS 7.6 主机，在上面直接部署私有 gitlab_runner 其实能让整个过程变得更加简单一些，可惜经过测试通过 SSH 访问 gitlab.com 速度实在感人，就放弃了。</li>
<li>本文所用的持续集成方式是：<br>共享 github-runner Docker 编译打包 -&gt; WebHook -&gt; 下载最新包 -&gt; 部署</li>
<li>迁移源码到GitLab的步骤略过不提。</li>
</ol>
<h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><h2 id="新增访问令牌"><a href="#新增访问令牌" class="headerlink" title="新增访问令牌"></a>新增访问令牌</h2><p>在下载文件时，需要使用访问令牌，转到个人设置菜单，新增一个访问令牌：<br><img data-src="https://qiniucdn.wayneshao.com/%E4%BD%BF%E7%94%A8GitLabCI%E8%BF%9B%E8%A1%8Chexo%E7%9A%84%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90/20191228080940646.png"><br><img data-src="https://qiniucdn.wayneshao.com/%E4%BD%BF%E7%94%A8GitLabCI%E8%BF%9B%E8%A1%8Chexo%E7%9A%84%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90/20191228080958633.png"><br><img data-src="https://qiniucdn.wayneshao.com/%E4%BD%BF%E7%94%A8GitLabCI%E8%BF%9B%E8%A1%8Chexo%E7%9A%84%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90/20191228081053893.png"><br>访问令牌仅能在生成后查看一次，注意妥善保存。</p>
<h2 id="配置-SSH-私钥与-known-hosts"><a href="#配置-SSH-私钥与-known-hosts" class="headerlink" title="配置 SSH 私钥与 known_hosts"></a>配置 SSH 私钥与 known_hosts</h2><p>参照官方文档，命名为 SSH_PRIVATE_KEY 和 SSH_KNOWN_HOSTS。<br><img data-src="https://qiniucdn.wayneshao.com/%E4%BD%BF%E7%94%A8GitLabCI%E8%BF%9B%E8%A1%8Chexo%E7%9A%84%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90/20191228093822749.png"></p>
<h1 id="配置-gitlab-ci-yml"><a href="#配置-gitlab-ci-yml" class="headerlink" title="配置  .gitlab-ci.yml"></a>配置  .gitlab-ci.yml</h1><p><img data-src="https://qiniucdn.wayneshao.com/%E4%BD%BF%E7%94%A8GitLabCI%E8%BF%9B%E8%A1%8Chexo%E7%9A%84%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90/20191228080142533.png"><br><img data-src="https://qiniucdn.wayneshao.com/%E4%BD%BF%E7%94%A8GitLabCI%E8%BF%9B%E8%A1%8Chexo%E7%9A%84%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90/20191228084859229.png"></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># This file is a template, and might need editing before it works on your project.</span></span><br><span class="line"><span class="comment"># Full project: https://gitlab.com/pages/hexo</span></span><br><span class="line"><span class="attr">image:</span> <span class="string">node:10.15.3</span></span><br><span class="line"></span><br><span class="line"><span class="attr">before_script:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;which ssh-agent || ( apt-get update -y &amp;&amp; apt-get install openssh-client -y )&#x27;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">eval</span> <span class="string">$(ssh-agent</span> <span class="string">-s)</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">mkdir</span> <span class="string">-p</span> <span class="string">~/.ssh</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">rm</span> <span class="string">-Rf</span> <span class="string">~/.ssh/id_rsa</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">touch</span> <span class="string">~/.ssh/id_rsa</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;$SSH_PRIVATE_KEY&quot;</span> <span class="string">&gt;</span> <span class="string">~/.ssh/id_rsa</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">rm</span> <span class="string">-Rf</span> <span class="string">~/.ssh/known_hosts</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">touch</span> <span class="string">~/.ssh/known_hosts</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">echo</span> <span class="string">&quot;$SSH_KNOWN_HOSTS&quot;</span> <span class="string">&gt;</span> <span class="string">~/.ssh/known_hosts</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">chmod</span> <span class="number">700</span> <span class="string">~/.ssh</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">chmod</span> <span class="number">700</span> <span class="string">~/.ssh/*</span>  </span><br><span class="line">  <span class="bullet">-</span> <span class="string">git</span> <span class="string">config</span> <span class="string">--global</span> <span class="string">user.email</span> <span class="string">&quot;owner@wayneshao.com&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">git</span> <span class="string">config</span> <span class="string">--global</span> <span class="string">user.name</span> <span class="string">&quot;玮仔Wayne&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">pages:</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">npm</span> <span class="string">install</span> <span class="string">hexo-cli</span> <span class="string">-g</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">test</span> <span class="string">-e</span> <span class="string">package.json</span> <span class="string">&amp;&amp;</span> <span class="string">npm</span> <span class="string">install</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">hexo</span> <span class="string">generate</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">hexo</span> <span class="string">deploy</span></span><br><span class="line">  <span class="attr">artifacts:</span></span><br><span class="line">    <span class="attr">expire_in:</span> <span class="number">3</span> <span class="string">days</span>  <span class="comment"># &lt;== !!!</span></span><br><span class="line">    <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">public</span></span><br><span class="line">  <span class="attr">cache:</span></span><br><span class="line">    <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">node_modules</span></span><br><span class="line">    <span class="attr">key:</span> <span class="string">project</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">source</span></span><br></pre></td></tr></table></figure>
<p>如果没有禁用共享 git-runner，那提交 .gitlab-ci.yml 之后就能看到如下的部署过程了，可能会比较慢，等待邮件通知即可。<br><img data-src="https://qiniucdn.wayneshao.com/%E4%BD%BF%E7%94%A8GitLabCI%E8%BF%9B%E8%A1%8Chexo%E7%9A%84%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90/20191228080418766.png"><br>之后就能看到生成的作业产物——打包好的 public 目录<br><img data-src="https://qiniucdn.wayneshao.com/%E4%BD%BF%E7%94%A8GitLabCI%E8%BF%9B%E8%A1%8Chexo%E7%9A%84%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90/20191228080524554.png"><br><img data-src="https://qiniucdn.wayneshao.com/%E4%BD%BF%E7%94%A8GitLabCI%E8%BF%9B%E8%A1%8Chexo%E7%9A%84%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90/20191228080542637.png"></p>
<h1 id="WebHook"><a href="#WebHook" class="headerlink" title="WebHook"></a>WebHook</h1><h2 id="配置-WebHook-仓库集成"><a href="#配置-WebHook-仓库集成" class="headerlink" title="配置 WebHook 仓库集成"></a>配置 WebHook 仓库集成</h2><p><img data-src="https://qiniucdn.wayneshao.com/%E4%BD%BF%E7%94%A8GitLabCI%E8%BF%9B%E8%A1%8Chexo%E7%9A%84%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90/20191228104145125.png"></p>
<h2 id="WebHook-监听"><a href="#WebHook-监听" class="headerlink" title="WebHook 监听"></a>WebHook 监听</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>打算这里我打算使用 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FkbmFuaC93ZWJob29r">WebHook<i class="fa fa-external-link-alt"></i></span> 做 Web 监听，集成工作使用 shell 脚本来完成，先安装配置 WebHook ：</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~</span><br><span class="line">go get github.com/adnanh/webhook</span><br><span class="line"><span class="built_in">cd</span> go/bin</span><br><span class="line">vi hooks.json</span><br></pre></td></tr></table></figure>
<h3 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h3><p>hooks.json中按需求输入以下内容</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blog&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;execute-command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/var/scripts/update-blog.sh&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;command-working-directory&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/opt/backup-blog&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;pass-arguments-to-command&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="comment">//传入打包文件大小用于校验</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="string">&quot;payload&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;builds.0.artifacts_file.size&quot;</span> </span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;response-message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;job done!&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="comment">//Hook条件</span></span><br><span class="line">        <span class="attr">&quot;trigger-rule&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;and&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="comment">//校验 Secret Token</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;value&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;(仓库中配置的 Secret Token)&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;parameter&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="string">&quot;header&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;X-Gitlab-Token&quot;</span></span><br><span class="line">                        <span class="punctuation">&#125;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="comment">//校验 payload 类型</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;value&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pipeline&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;parameter&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="string">&quot;payload&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object_kind&quot;</span></span><br><span class="line">                        <span class="punctuation">&#125;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="comment">//校验 payload 状态，只有成功才Hook</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;value&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;success&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;parameter&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="string">&quot;payload&quot;</span><span class="punctuation">,</span></span><br><span class="line">                            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object_attributes.status&quot;</span></span><br><span class="line">                        <span class="punctuation">&#125;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>
<p><strong>PS:一定要有 response-message ，没有返回时 GitLab 会判定为访问失败</strong></p>
<h3 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h3><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">nohup ~/go/bin/webhook <span class="literal">-hooks</span> ~/go/bin/hooks.json <span class="literal">-verbose</span> &amp;</span><br></pre></td></tr></table></figure>
<p>访问 :9000/hooks/blog 测试<br><img data-src="https://qiniucdn.wayneshao.com/%E4%BD%BF%E7%94%A8GitLabCI%E8%BF%9B%E8%A1%8Chexo%E7%9A%84%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90/20191228081926884.png"></p>
<h3 id="配置-Nginx"><a href="#配置-Nginx" class="headerlink" title="配置 Nginx"></a>配置 Nginx</h3><p><img data-src="https://qiniucdn.wayneshao.com/%E4%BD%BF%E7%94%A8GitLabCI%E8%BF%9B%E8%A1%8Chexo%E7%9A%84%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90/20191228082134051.png"><br><img data-src="https://qiniucdn.wayneshao.com/%E4%BD%BF%E7%94%A8GitLabCI%E8%BF%9B%E8%A1%8Chexo%E7%9A%84%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90/20191228082148103.png"></p>
<h2 id="Shell-脚本实现"><a href="#Shell-脚本实现" class="headerlink" title="Shell 脚本实现"></a>Shell 脚本实现</h2><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取当前时间以作为文件名/版本号</span></span><br><span class="line">datename=<span class="variable">$</span>(date +%Y%m%d%<span class="built_in">H</span>%M%S)</span><br><span class="line"><span class="comment"># 获取最后一个文件名 </span></span><br><span class="line">filename=`ls <span class="literal">-l</span> | tail <span class="literal">-n</span> <span class="number">1</span> | awk <span class="string">&#x27;&#123;print $9&#125;&#x27;</span>`</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用令牌下载最新的编译产出</span></span><br><span class="line"><span class="built_in">wget</span> <span class="literal">--header</span> <span class="string">&quot;PRIVATE-TOKEN: （访问令牌)&quot;</span> <span class="string">&quot;https://gitlab.com/api/v4/projects/(项目ID)/jobs/artifacts/(源码所在的分支)/download?job=pages&quot;</span> <span class="literal">-O</span> /opt/<span class="built_in">backup-blog</span>/<span class="variable">$datename</span>.zip</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> </span><br><span class="line"><span class="comment"># 校验文件大小</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$</span>(<span class="type">stat</span> --<span class="type">format</span>=%<span class="type">s</span> /<span class="type">opt</span>/<span class="built_in">backup-blog</span>/<span class="variable">$datename</span><span class="type">.zip</span>) == <span class="variable">$1</span> ]; then	</span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;[OK]size check passed.&quot;</span></span><br><span class="line">	<span class="comment"># 对比 Md5 校验是否为旧文件</span></span><br><span class="line">	<span class="keyword">if</span> [ <span class="variable">$</span>(<span class="type">md5sum</span> <span class="variable">$datename</span><span class="type">.zip</span> | <span class="type">cut</span> -<span class="type">c1</span>-<span class="number">32</span>) == <span class="variable">$</span>(<span class="type">md5sum</span> <span class="variable">$filename</span> | <span class="type">cut</span> -<span class="type">c1</span>-<span class="number">32</span>) ]; then</span><br><span class="line">		<span class="built_in">echo</span> <span class="string">&quot;[ERROR]same with last.&quot;</span></span><br><span class="line">		<span class="built_in">rm</span> <span class="literal">-Rf</span> /opt/<span class="built_in">backup-blog</span>/<span class="variable">$datename</span>.zip</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="built_in">echo</span> <span class="string">&quot;[OK]last md5 equal passed.&quot;</span></span><br><span class="line">		<span class="comment"># 解压</span></span><br><span class="line">		unzip <span class="literal">-o</span> /opt/<span class="built_in">backup-blog</span>/<span class="variable">$datename</span>.zip</span><br><span class="line"></span><br><span class="line">		<span class="comment"># 更新</span></span><br><span class="line">		sudo <span class="built_in">rm</span> <span class="literal">-Rf</span> /opt/blog</span><br><span class="line">		mkdir <span class="literal">-p</span> /opt/blog</span><br><span class="line">		<span class="built_in">cp</span> <span class="literal">-rf</span> ./public/* /opt/blog</span><br><span class="line">		<span class="built_in">rm</span> <span class="literal">-Rf</span> ./public</span><br><span class="line">		<span class="comment"># 重载 nginx</span></span><br><span class="line">		nginx <span class="literal">-s</span> reload</span><br><span class="line">	fi</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;[ERROR]size not equal.&quot;</span></span><br><span class="line">	<span class="built_in">rm</span> <span class="literal">-Rf</span> /opt/<span class="built_in">backup-blog</span>/<span class="variable">$datename</span>.zip</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
<p>注意：</p>
<ol>
<li>下载文件时需要在 http 请求头中设置键 PRIVATE-TOKEN 的值为访问令牌，才能请求到对应的文件。</li>
<li>最新产出文件的地址如图，注意修改项目 ID 和源码所在的分支名（项目 ID 可以再项目的设置中获得）。</li>
</ol>
]]></content>
      <categories>
        <category>踩坑笔记</category>
      </categories>
      <tags>
        <tag>GitLab</tag>
        <tag>CI/CD</tag>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>.Net 使用GeoIP2获取IP的地理位置信息</title>
    <url>/posts/20420.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p><span class="exturl" data-url="aHR0cHM6Ly93d3cubWF4bWluZC5jb20vemgvZ2VvaXAyLXNlcnZpY2VzLWFuZC1kYXRhYmFzZXM=">GeoIP® 数据库&amp;服务：业界领先的IP智能<i class="fa fa-external-link-alt"></i></span>，MaxMind GeoIP2 服务能识别互联网用户的地点位置与其他特征，应用广泛，包括个性化定制内容、诈欺检测、广告定向、网站流量分析、执行规定、地理目标定位、地理围栏定位 (geo-fencing)以及数字版权管理。</p>
<span id="more"></span>
<p><img data-src="https://qiniucdn.wayneshao.com/20180221212532042/20180221093334576.png"></p>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLm1heG1pbmQuY29tLzIwMTQvMDEvMzEvd2hvLWhhcy10aGUtbW9zdC1hY2N1cmF0ZS1pcC1nZW9sb2NhdGlvbi1kYXRhLw==">MaxMind是IP地理定位准确性的行业领导者.<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cubWF4bWluZC5jb20vemgvZ2VvaXAyLWNpdHktZGF0YWJhc2UtYWNjdXJhY3k=">按照不同国家，比较MaxMind GeoIP2数据服务与数据库的准确性<i class="fa fa-external-link-alt"></i></span>。</li>
</ul>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cubWF4bWluZC5jb20vemgvZ2VvaXAyLXByZWNpc2lvbi1zZXJ2aWNlcw==">GeoIP2精准版服务<i class="fa fa-external-link-alt"></i></span>向您提供本公司最准确的数据，为您省去在您服务器上托管数据或部署更新项目的麻烦。 我们的精准版服务产品可通过API或文件手动上传方式使用，为您提供最新的数据。</p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cubWF4bWluZC5jb20vemgvZ2VvaXAyLWRhdGFiYXNlcw==">MaxMind的GeoIP2数据库<i class="fa fa-external-link-alt"></i></span>为大容量环境提供IP智能数据。 通过在本地托管我们的数据库，您既可避免网络延迟问题，又可避免按每次查询计价的费用。</p>
<p>GeoIP 分为商业版和免费版，免费版比商业版精度差了许多，经测试对于城市定位确实有差距，能否接受看你的精度要求！</p>
<h2 id="免费版介绍"><a href="#免费版介绍" class="headerlink" title="免费版介绍"></a>免费版介绍</h2><p>免费版仅有数据库服务，目前有两个版本<br>1、GeoLite 版本，网上流传较广，数据库类型为 dat 格式文件，库文件较小、未进行精准度测试且不再更新。<br>2、GeoLite2版本，目前最新版本，数据库文件为 mmdb 格式或csv格式。<br><a href="https://dev.maxmind.com/geoip/geoip2/geoip2-city-country-csv-databases/"><strong>GeoLite2 特性</strong></a></p>
<h2 id="下载数据库"><a href="#下载数据库" class="headerlink" title="下载数据库"></a>下载数据库</h2><h3 id="GeoIP数据库"><a href="#GeoIP数据库" class="headerlink" title="GeoIP数据库"></a>GeoIP数据库</h3><p><a href="https://www.maxmind.com/zh/geoip2-databases"><strong>GeoIP2数据库</strong></a><br>本地维护的数据库适用于容量大、延迟性低的环境，购买机构可以获取站点许可证，即可在公司内进行无限次使用。</p>
<ul>
<li>对于选定地点，含有简体中文、法文、德文、日文、西班牙文、巴西葡萄牙文及俄文版的本地化名称</li>
<li>为多数常用语言提供开放源代码的API</li>
<li>可提供自动更新</li>
</ul>
<h3 id="GeoLite2-开源数据库"><a href="#GeoLite2-开源数据库" class="headerlink" title="GeoLite2 开源数据库"></a>GeoLite2 开源数据库</h3><h4 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h4><p><span class="exturl" data-url="aHR0cHM6Ly9kZXYubWF4bWluZC5jb20vZ2VvaXAvZ2VvaXAyL2dlb2xpdGUyLw==">GeoLite2数据库<i class="fa fa-external-link-alt"></i></span>是 GeoLite 数据库的开源版，GeoIP2的免费版，准确率稍低于付费版，其前身 GeoLite 现行数据库已<span class="exturl" data-url="aHR0cHM6Ly9zdXBwb3J0Lm1heG1pbmQuY29tL2dlb2xpdGUtbGVnYWN5LWRpc2NvbnRpbnVhdGlvbi1ub3RpY2Uv">于 2019年1月2日 不再提供服务<i class="fa fa-external-link-alt"></i></span>)</p>
<h4 id="技术支持"><a href="#技术支持" class="headerlink" title="技术支持"></a>技术支持</h4><p>MaxMind 不为免费数据库提供技术支持。如果您有问题请前往<span class="exturl" data-url="aHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy90YWdnZWQvZ2VvaXA=">stackoverflow’s GeoIP问题以及解答。<i class="fa fa-external-link-alt"></i></span></p>
<h4 id="许可证"><a href="#许可证" class="headerlink" title="许可证"></a>许可证</h4><p>GeoLite2使用的是开源许可证：<span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LXNhLzMuMC9kZWVkLnpoX1RX">Creative Commons Attribution-ShareAlike 3.0 Unported License<i class="fa fa-external-link-alt"></i></span>. 您只需要在页面中添加如下代码即可：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">该产品使用MaxMind公司的GeoLite2数据，可以在此获取：</span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;http://www.maxmind.com&quot;</span>&gt;</span>http://www.maxmind.com<span class="tag">&lt;/<span class="name">a</span>&gt;</span>.</span><br></pre></td></tr></table></figure>
<p>官方提供 <span class="exturl" data-url="aHR0cDovL3d3dy5tYXhtaW5kLmNvbS96aC9nZW9saXRlMi1kZXZlbG9wZXItcGFja2FnZQ==">二次销售许可证<i class="fa fa-external-link-alt"></i></span>.</p>
<h4 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h4><table>
<thead>
<tr>
<th align="center">数据库</th>
<th align="center"><span class="exturl" data-url="aHR0cHM6Ly9tYXhtaW5kLmdpdGh1Yi5pby9NYXhNaW5kLURCLw==">MaxMind DB<i class="fa fa-external-link-alt"></i></span> 二进制格式, 压缩</th>
<th align="center"><span class="exturl" data-url="aHR0cHM6Ly9kZXYubWF4bWluZC5jb20vZ2VvaXAvZ2VvaXAyL2dlb2lwMi1jaXR5LWNvdW50cnktY3N2LWRhdGFiYXNlcy8=">CSV 格式<i class="fa fa-external-link-alt"></i></span>, 压缩</th>
</tr>
</thead>
<tbody><tr>
<td align="center">GeoLite2 城市</td>
<td align="center"><span class="exturl" data-url="aHR0cHM6Ly9nZW9saXRlLm1heG1pbmQuY29tL2Rvd25sb2FkL2dlb2lwL2RhdGFiYXNlL0dlb0xpdGUyLUNpdHkudGFyLmd6">Download<i class="fa fa-external-link-alt"></i></span> (<span class="exturl" data-url="aHR0cHM6Ly9nZW9saXRlLm1heG1pbmQuY29tL2Rvd25sb2FkL2dlb2lwL2RhdGFiYXNlL0dlb0xpdGUyLUNpdHkudGFyLmd6Lm1kNQ==">md5 校验<i class="fa fa-external-link-alt"></i></span>)</td>
<td align="center"><span class="exturl" data-url="aHR0cHM6Ly9nZW9saXRlLm1heG1pbmQuY29tL2Rvd25sb2FkL2dlb2lwL2RhdGFiYXNlL0dlb0xpdGUyLUNpdHktQ1NWLnppcA==">Download<i class="fa fa-external-link-alt"></i></span> (<span class="exturl" data-url="aHR0cHM6Ly9nZW9saXRlLm1heG1pbmQuY29tL2Rvd25sb2FkL2dlb2lwL2RhdGFiYXNlL0dlb0xpdGUyLUNpdHktQ1NWLnppcC5tZDU=">md5 校验<i class="fa fa-external-link-alt"></i></span>)</td>
</tr>
<tr>
<td align="center">GeoLite2 国家</td>
<td align="center"><span class="exturl" data-url="aHR0cHM6Ly9nZW9saXRlLm1heG1pbmQuY29tL2Rvd25sb2FkL2dlb2lwL2RhdGFiYXNlL0dlb0xpdGUyLUNvdW50cnkudGFyLmd6">Download<i class="fa fa-external-link-alt"></i></span> (<span class="exturl" data-url="aHR0cHM6Ly9nZW9saXRlLm1heG1pbmQuY29tL2Rvd25sb2FkL2dlb2lwL2RhdGFiYXNlL0dlb0xpdGUyLUNvdW50cnkudGFyLmd6Lm1kNQ==">md5 校验<i class="fa fa-external-link-alt"></i></span>)</td>
<td align="center"><span class="exturl" data-url="aHR0cHM6Ly9nZW9saXRlLm1heG1pbmQuY29tL2Rvd25sb2FkL2dlb2lwL2RhdGFiYXNlL0dlb0xpdGUyLUNvdW50cnktQ1NWLnppcA==">Download<i class="fa fa-external-link-alt"></i></span> (<span class="exturl" data-url="aHR0cHM6Ly9nZW9saXRlLm1heG1pbmQuY29tL2Rvd25sb2FkL2dlb2lwL2RhdGFiYXNlL0dlb0xpdGUyLUNvdW50cnktQ1NWLnppcC5tZDU=">md5 校验<i class="fa fa-external-link-alt"></i></span>)</td>
</tr>
<tr>
<td align="center">GeoLite2  ASN（<span class="exturl" data-url="aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3poLWNuLyVFOCU4NyVBQSVFNiVCMiVCQiVFNyVCMyVCQiVFNyVCQiU5Rg==">自治系统<i class="fa fa-external-link-alt"></i></span>）</td>
<td align="center"><span class="exturl" data-url="aHR0cHM6Ly9nZW9saXRlLm1heG1pbmQuY29tL2Rvd25sb2FkL2dlb2lwL2RhdGFiYXNlL0dlb0xpdGUyLUFTTi50YXIuZ3o=">Download<i class="fa fa-external-link-alt"></i></span> (<span class="exturl" data-url="aHR0cHM6Ly9nZW9saXRlLm1heG1pbmQuY29tL2Rvd25sb2FkL2dlb2lwL2RhdGFiYXNlL0dlb0xpdGUyLUFTTi50YXIuZ3oubWQ1">md5 校验<i class="fa fa-external-link-alt"></i></span>)</td>
<td align="center"><span class="exturl" data-url="aHR0cHM6Ly9nZW9saXRlLm1heG1pbmQuY29tL2Rvd25sb2FkL2dlb2lwL2RhdGFiYXNlL0dlb0xpdGUyLUFTTi1DU1Yuemlw">Download<i class="fa fa-external-link-alt"></i></span> (<span class="exturl" data-url="aHR0cHM6Ly9nZW9saXRlLm1heG1pbmQuY29tL2Rvd25sb2FkL2dlb2lwL2RhdGFiYXNlL0dlb0xpdGUyLUFTTi1DU1YuemlwLm1kNQ==">md5 校验<i class="fa fa-external-link-alt"></i></span>)</td>
</tr>
</tbody></table>
<h4 id="更新数据库"><a href="#更新数据库" class="headerlink" title="更新数据库"></a>更新数据库</h4><p>你可以使用 <span class="exturl" data-url="aHR0cHM6Ly9kZXYubWF4bWluZC5jb20vemgtaGFucy9nZW9pcC9nZW9pcHVwZGF0ZS8=">GeoIP 更新<i class="fa fa-external-link-alt"></i></span>来自动更新您的数据库。</p>
<h4 id="MaxMind-API-接口"><a href="#MaxMind-API-接口" class="headerlink" title="MaxMind API 接口"></a>MaxMind API 接口</h4><p>参阅 <span class="exturl" data-url="aHR0cHM6Ly9kZXYubWF4bWluZC5jb20vemgtaGFucy9nZW9pcC9nZW9pcDIvZG93bmxvYWRhYmxlLyNNYXhNaW5kX0FQSXM=">GeoIP2 可下载数据库<i class="fa fa-external-link-alt"></i></span> 以下载API。付费版和免费版API互通。</p>
<h2 id="Net调用MaxMind-API"><a href="#Net调用MaxMind-API" class="headerlink" title=".Net调用MaxMind API"></a>.Net调用MaxMind API</h2><p>.Net调用MaxMind API可以使用官方发布的<span class="exturl" data-url="aHR0cHM6Ly93d3cubnVnZXQub3JnL3BhY2thZ2VzL01heE1pbmQuR2VvSVAyLw==">nuget包<i class="fa fa-external-link-alt"></i></span>，官方提供了<span class="exturl" data-url="aHR0cDovL21heG1pbmQuZ2l0aHViLmlvL0dlb0lQMi1kb3RuZXQv">文档<i class="fa fa-external-link-alt"></i></span>和<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL21heG1pbmQvR2VvSVAyLWRvdG5ldA==">源码地址<i class="fa fa-external-link-alt"></i></span>。</p>
<h3 id="安装Nuget包"><a href="#安装Nuget包" class="headerlink" title="安装Nuget包"></a>安装Nuget包</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Install-Package MaxMind.GeoIP2</span><br></pre></td></tr></table></figure>
<h3 id="代码调用"><a href="#代码调用" class="headerlink" title="代码调用"></a>代码调用</h3><p>因GeoLite2只提供了City和Country两个数据库版本。<br>故只能进行这两种调用方式，调用方式非常简单</p>
<h4 id="City"><a href="#City" class="headerlink" title="City"></a>City</h4><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> (<span class="keyword">var</span> reader = <span class="keyword">new</span> DatabaseReader(<span class="string">&quot;GeoLite2-City.mmdb&quot;</span>))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> city = reader.City(<span class="string">&quot;65.49.134.29&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>city即为查询结果，结构如下：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;city&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;geoname_id&quot;</span>: <span class="number">5125591</span>,</span><br><span class="line">        <span class="string">&quot;names&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;en&quot;</span>: <span class="string">&quot;Macedon&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;continent&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;code&quot;</span>: <span class="string">&quot;NA&quot;</span>,</span><br><span class="line">        <span class="string">&quot;geoname_id&quot;</span>: <span class="number">6255149</span>,</span><br><span class="line">        <span class="string">&quot;names&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;de&quot;</span>: <span class="string">&quot;Nordamerika&quot;</span>,</span><br><span class="line">            <span class="string">&quot;en&quot;</span>: <span class="string">&quot;North America&quot;</span>,</span><br><span class="line">            <span class="string">&quot;es&quot;</span>: <span class="string">&quot;Norteamérica&quot;</span>,</span><br><span class="line">            <span class="string">&quot;fr&quot;</span>: <span class="string">&quot;Amérique du Nord&quot;</span>,</span><br><span class="line">            <span class="string">&quot;ja&quot;</span>: <span class="string">&quot;北アメリカ&quot;</span>,</span><br><span class="line">            <span class="string">&quot;pt-BR&quot;</span>: <span class="string">&quot;América do Norte&quot;</span>,</span><br><span class="line">            <span class="string">&quot;ru&quot;</span>: <span class="string">&quot;Северная Америка&quot;</span>,</span><br><span class="line">            <span class="string">&quot;zh-CN&quot;</span>: <span class="string">&quot;北美洲&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;country&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;geoname_id&quot;</span>: <span class="number">6252001</span>,</span><br><span class="line">        <span class="string">&quot;is_in_european_union&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;iso_code&quot;</span>: <span class="string">&quot;US&quot;</span>,</span><br><span class="line">        <span class="string">&quot;names&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;de&quot;</span>: <span class="string">&quot;USA&quot;</span>,</span><br><span class="line">            <span class="string">&quot;en&quot;</span>: <span class="string">&quot;United States&quot;</span>,</span><br><span class="line">            <span class="string">&quot;es&quot;</span>: <span class="string">&quot;Estados Unidos&quot;</span>,</span><br><span class="line">            <span class="string">&quot;fr&quot;</span>: <span class="string">&quot;États-Unis&quot;</span>,</span><br><span class="line">            <span class="string">&quot;ja&quot;</span>: <span class="string">&quot;アメリカ合衆国&quot;</span>,</span><br><span class="line">            <span class="string">&quot;pt-BR&quot;</span>: <span class="string">&quot;Estados Unidos&quot;</span>,</span><br><span class="line">            <span class="string">&quot;ru&quot;</span>: <span class="string">&quot;США&quot;</span>,</span><br><span class="line">            <span class="string">&quot;zh-CN&quot;</span>: <span class="string">&quot;美国&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;location&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;accuracy_radius&quot;</span>: <span class="number">20</span>,</span><br><span class="line">        <span class="string">&quot;latitude&quot;</span>: <span class="number">43.1089</span>,</span><br><span class="line">        <span class="string">&quot;longitude&quot;</span>: -<span class="number">77.3226</span>,</span><br><span class="line">        <span class="string">&quot;metro_code&quot;</span>: <span class="number">538</span>,</span><br><span class="line">        <span class="string">&quot;time_zone&quot;</span>: <span class="string">&quot;America/New_York&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;maxmind&quot;</span>: &#123;&#125;,</span><br><span class="line">    <span class="string">&quot;postal&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;code&quot;</span>: <span class="string">&quot;14502&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;registered_country&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;geoname_id&quot;</span>: <span class="number">6252001</span>,</span><br><span class="line">        <span class="string">&quot;is_in_european_union&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;iso_code&quot;</span>: <span class="string">&quot;US&quot;</span>,</span><br><span class="line">        <span class="string">&quot;names&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;de&quot;</span>: <span class="string">&quot;USA&quot;</span>,</span><br><span class="line">            <span class="string">&quot;en&quot;</span>: <span class="string">&quot;United States&quot;</span>,</span><br><span class="line">            <span class="string">&quot;es&quot;</span>: <span class="string">&quot;Estados Unidos&quot;</span>,</span><br><span class="line">            <span class="string">&quot;fr&quot;</span>: <span class="string">&quot;États-Unis&quot;</span>,</span><br><span class="line">            <span class="string">&quot;ja&quot;</span>: <span class="string">&quot;アメリカ合衆国&quot;</span>,</span><br><span class="line">            <span class="string">&quot;pt-BR&quot;</span>: <span class="string">&quot;Estados Unidos&quot;</span>,</span><br><span class="line">            <span class="string">&quot;ru&quot;</span>: <span class="string">&quot;США&quot;</span>,</span><br><span class="line">            <span class="string">&quot;zh-CN&quot;</span>: <span class="string">&quot;美国&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;represented_country&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;is_in_european_union&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;names&quot;</span>: &#123;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;subdivisions&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;geoname_id&quot;</span>: <span class="number">5128638</span>,</span><br><span class="line">            <span class="string">&quot;iso_code&quot;</span>: <span class="string">&quot;NY&quot;</span>,</span><br><span class="line">            <span class="string">&quot;names&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;de&quot;</span>: <span class="string">&quot;New York&quot;</span>,</span><br><span class="line">                <span class="string">&quot;en&quot;</span>: <span class="string">&quot;New York&quot;</span>,</span><br><span class="line">                <span class="string">&quot;es&quot;</span>: <span class="string">&quot;Nueva York&quot;</span>,</span><br><span class="line">                <span class="string">&quot;fr&quot;</span>: <span class="string">&quot;New York&quot;</span>,</span><br><span class="line">                <span class="string">&quot;ja&quot;</span>: <span class="string">&quot;ニューヨーク州&quot;</span>,</span><br><span class="line">                <span class="string">&quot;pt-BR&quot;</span>: <span class="string">&quot;Nova Iorque&quot;</span>,</span><br><span class="line">                <span class="string">&quot;ru&quot;</span>: <span class="string">&quot;Нью-Йорк&quot;</span>,</span><br><span class="line">                <span class="string">&quot;zh-CN&quot;</span>: <span class="string">&quot;纽约州&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;traits&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;ip_address&quot;</span>: <span class="string">&quot;66.66.66.66&quot;</span>,</span><br><span class="line">        <span class="string">&quot;is_anonymous&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;is_anonymous_proxy&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;is_anonymous_vpn&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;is_hosting_provider&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;is_legitimate_proxy&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;is_public_proxy&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;is_satellite_provider&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;is_tor_exit_node&quot;</span>: <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中包含了比较详细的信息，有具体的经纬度。</p>
<h4 id="Country"><a href="#Country" class="headerlink" title="Country"></a>Country</h4><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> (<span class="keyword">var</span> reader = <span class="keyword">new</span> DatabaseReader(<span class="string">&quot;GeoLite2-Country.mmdb&quot;</span>))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> country = reader.Country(<span class="string">&quot;66.66.66.66&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>country即为查询结果，结构如下：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;continent&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;code&quot;</span>: <span class="string">&quot;NA&quot;</span>,</span><br><span class="line">        <span class="string">&quot;geoname_id&quot;</span>: <span class="number">6255149</span>,</span><br><span class="line">        <span class="string">&quot;names&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;de&quot;</span>: <span class="string">&quot;Nordamerika&quot;</span>,</span><br><span class="line">            <span class="string">&quot;en&quot;</span>: <span class="string">&quot;North America&quot;</span>,</span><br><span class="line">            <span class="string">&quot;es&quot;</span>: <span class="string">&quot;Norteamérica&quot;</span>,</span><br><span class="line">            <span class="string">&quot;fr&quot;</span>: <span class="string">&quot;Amérique du Nord&quot;</span>,</span><br><span class="line">            <span class="string">&quot;ja&quot;</span>: <span class="string">&quot;北アメリカ&quot;</span>,</span><br><span class="line">            <span class="string">&quot;pt-BR&quot;</span>: <span class="string">&quot;América do Norte&quot;</span>,</span><br><span class="line">            <span class="string">&quot;ru&quot;</span>: <span class="string">&quot;Северная Америка&quot;</span>,</span><br><span class="line">            <span class="string">&quot;zh-CN&quot;</span>: <span class="string">&quot;北美洲&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;country&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;geoname_id&quot;</span>: <span class="number">6252001</span>,</span><br><span class="line">        <span class="string">&quot;is_in_european_union&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;iso_code&quot;</span>: <span class="string">&quot;US&quot;</span>,</span><br><span class="line">        <span class="string">&quot;names&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;de&quot;</span>: <span class="string">&quot;USA&quot;</span>,</span><br><span class="line">            <span class="string">&quot;en&quot;</span>: <span class="string">&quot;United States&quot;</span>,</span><br><span class="line">            <span class="string">&quot;es&quot;</span>: <span class="string">&quot;Estados Unidos&quot;</span>,</span><br><span class="line">            <span class="string">&quot;fr&quot;</span>: <span class="string">&quot;États-Unis&quot;</span>,</span><br><span class="line">            <span class="string">&quot;ja&quot;</span>: <span class="string">&quot;アメリカ合衆国&quot;</span>,</span><br><span class="line">            <span class="string">&quot;pt-BR&quot;</span>: <span class="string">&quot;Estados Unidos&quot;</span>,</span><br><span class="line">            <span class="string">&quot;ru&quot;</span>: <span class="string">&quot;США&quot;</span>,</span><br><span class="line">            <span class="string">&quot;zh-CN&quot;</span>: <span class="string">&quot;美国&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;maxmind&quot;</span>: &#123;&#125;,</span><br><span class="line">    <span class="string">&quot;registered_country&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;geoname_id&quot;</span>: <span class="number">6252001</span>,</span><br><span class="line">        <span class="string">&quot;is_in_european_union&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;iso_code&quot;</span>: <span class="string">&quot;US&quot;</span>,</span><br><span class="line">        <span class="string">&quot;names&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;de&quot;</span>: <span class="string">&quot;USA&quot;</span>,</span><br><span class="line">            <span class="string">&quot;en&quot;</span>: <span class="string">&quot;United States&quot;</span>,</span><br><span class="line">            <span class="string">&quot;es&quot;</span>: <span class="string">&quot;Estados Unidos&quot;</span>,</span><br><span class="line">            <span class="string">&quot;fr&quot;</span>: <span class="string">&quot;États-Unis&quot;</span>,</span><br><span class="line">            <span class="string">&quot;ja&quot;</span>: <span class="string">&quot;アメリカ合衆国&quot;</span>,</span><br><span class="line">            <span class="string">&quot;pt-BR&quot;</span>: <span class="string">&quot;Estados Unidos&quot;</span>,</span><br><span class="line">            <span class="string">&quot;ru&quot;</span>: <span class="string">&quot;США&quot;</span>,</span><br><span class="line">            <span class="string">&quot;zh-CN&quot;</span>: <span class="string">&quot;美国&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;represented_country&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;is_in_european_union&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;names&quot;</span>: &#123;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;traits&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;ip_address&quot;</span>: <span class="string">&quot;66.66.66.66&quot;</span>,</span><br><span class="line">        <span class="string">&quot;is_anonymous&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;is_anonymous_proxy&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;is_anonymous_vpn&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;is_hosting_provider&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;is_legitimate_proxy&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;is_public_proxy&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;is_satellite_provider&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;is_tor_exit_node&quot;</span>: <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>country数据库中的信息的详细程度较之city就差了很多，但数据库大小仅为city的 1/20，视使用场景来决定使用对应的数据库。</p>
]]></content>
      <categories>
        <category>踩坑笔记</category>
      </categories>
      <tags>
        <tag>.NET</tag>
        <tag>GeoIP2</tag>
        <tag>IP</tag>
      </tags>
  </entry>
  <entry>
    <title>两种软件开发模式：瀑布与敏捷</title>
    <url>/posts/15045.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="瀑布开发模式"><a href="#瀑布开发模式" class="headerlink" title="瀑布开发模式"></a>瀑布开发模式</h2><p>　　瀑布模式是一种前几年在国内各大项目中比较流行的开发模式，特点是分阶段进行，每个阶段都很清晰，只有阶段对应的人员才会参与当前阶段的开发，每个阶段必须有产出物才可以开始下个阶段，整个周期较长，早期需求分析和设计的时间消耗较多，整个流程会尽量避免需求的改动，更适用于B端产品的开发。<br><img data-src="https://qiniucdn.wayneshao.com/%E4%B8%A4%E7%A7%8D%E8%BD%AF%E4%BB%B6%E5%BC%80%E5%8F%91%E6%A8%A1%E5%BC%8F%EF%BC%9A%E7%80%91%E5%B8%83%E4%B8%8E%E6%95%8F%E6%8D%B7/20181101031030742.png"></p>
<span id="more"></span>
<h2 id="瀑布-VS-敏捷"><a href="#瀑布-VS-敏捷" class="headerlink" title="瀑布 VS 敏捷"></a>瀑布 VS 敏捷</h2><table>
<thead>
<tr>
<th></th>
<th><strong>瀑布</strong></th>
<th><strong>敏捷</strong></th>
</tr>
</thead>
<tbody><tr>
<td><em><strong>开发流程</strong></em></td>
<td>里程碑</td>
<td>迭代</td>
</tr>
<tr>
<td><em><strong>开发文档</strong></em></td>
<td>强调文档</td>
<td>可以工作的胜过面面俱到的文档</td>
</tr>
<tr>
<td><em><strong>开发人员</strong></em></td>
<td>强调分工</td>
<td>协助、沟通</td>
</tr>
<tr>
<td><em><strong>开发需求</strong></em></td>
<td>避免变化</td>
<td>拥抱变化</td>
</tr>
<tr>
<td><em><strong>需求变更</strong></em></td>
<td>谈判与计划</td>
<td>与客户合作</td>
</tr>
</tbody></table>
<h2 id="敏捷模式典型框架-Scrum"><a href="#敏捷模式典型框架-Scrum" class="headerlink" title="敏捷模式典型框架 Scrum"></a>敏捷模式典型框架 Scrum</h2><h3 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h3><p><img data-src="https://qiniucdn.wayneshao.com/%E4%B8%A4%E7%A7%8D%E8%BD%AF%E4%BB%B6%E5%BC%80%E5%8F%91%E6%A8%A1%E5%BC%8F%EF%BC%9A%E7%80%91%E5%B8%83%E4%B8%8E%E6%95%8F%E6%8D%B7/20181101041035296.png"></p>
<h4 id="Scrum-角色"><a href="#Scrum-角色" class="headerlink" title="Scrum 角色"></a>Scrum 角色</h4><p><strong>Product Owner：</strong>产品负责人，主要提需求的人，一般为老板。<br><strong>Scrum Master：</strong>Scrum 主管，保证Scrum模式的顺利执行（禁止在开发阶段该需求，督促开展会议等），一般为项目经理，或者项目之外的人担任。<br><strong>Team：</strong>开发团队，包含所有的开发人员。</p>
<h4 id="工件"><a href="#工件" class="headerlink" title="工件"></a>工件</h4><p><strong>UserStory：</strong>用户故事，不必有清晰文档的产品需求。<br><strong>Product Backlog：</strong>产品订单，所有待开发的UserStory的集合。<br><strong>Sprint Backlog：</strong>冲刺订单，本周期内待开发的UserStory。<br><strong>Burndown Chat：</strong>冲刺燃尽图，周期内UserStory的变化曲线。</p>
<h4 id="活动"><a href="#活动" class="headerlink" title="活动"></a>活动</h4><p><strong>Sprint Planning Meeting：</strong>计划会，周期末开展，总结冲刺燃尽图，评估冲刺订单。<br><strong>Daily Standuy Meeting：</strong>每日例会，每天早上开展，十五分钟内的短会，所有开发人员对昨天的工作成果，今天的工作内容，现在遇到的问题这三个问题进行描述，方便会议之后解决问题和让开发团队每一个成员了解到当前进度。<br><strong>Review Meeting：</strong>评审会，评审UserStory的可行性和工期。<br><strong>Retrospective Meeting：</strong>回顾会，每个迭代上线之后，以匿名的方式投票总结成员各自看到的问题，并在下一个迭代尝试解决。</p>
<h4 id="Scrum-流程"><a href="#Scrum-流程" class="headerlink" title="Scrum 流程"></a>Scrum 流程</h4><p><img data-src="https://qiniucdn.wayneshao.com/%E4%B8%A4%E7%A7%8D%E8%BD%AF%E4%BB%B6%E5%BC%80%E5%8F%91%E6%A8%A1%E5%BC%8F%EF%BC%9A%E7%80%91%E5%B8%83%E4%B8%8E%E6%95%8F%E6%8D%B7/20181101040633936.png"></p>
]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
      <tags>
        <tag>开发模式</tag>
        <tag>瀑布模式</tag>
        <tag>敏捷开发</tag>
      </tags>
  </entry>
  <entry>
    <title>云原生是什么？</title>
    <url>/posts/46314.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>　　最近几年，相信大家都越来越多的在各种场合各种平台听到过了“云原生”这个词。<br>　　比如，关于云原生应用的“<span class="exturl" data-url="aHR0cHM6Ly8xMmZhY3Rvci5uZXQv">Twelve-Factor App<i class="fa fa-external-link-alt"></i></span>”理论，现在已经是基础设施的现象级容器技术，几乎已经等同于容器本身的 Docker，还有容器编排技术 Kubernetes，以及 Kubernetes 背后的 CNCF（云原生计算基金会）。<br>　　那么，什么才是“云原生”呢？什么样的系统架构才能被称为云原生架构呢？</p>
<span id="more"></span>
<h2 id="什么是云原生？"><a href="#什么是云原生？" class="headerlink" title="什么是云原生？"></a>什么是云原生？</h2><p>在<span class="exturl" data-url="aHR0cHM6Ly93d3cuY25jZi5pby9hYm91dC93aG8td2UtYXJlLw=="> CNCF 官网的 About 板块<i class="fa fa-external-link-alt"></i></span>，有 CNCF 给出的云原生的定义：</p>
<blockquote>
<p>Cloud native technologies empower organizations to build and run scalable applications in modern, dynamic environments such as public, private, and hybrid clouds. Containers, service meshes, microservices, immutable infrastructure, and declarative APIs exemplify this approach.</p>
</blockquote>
<blockquote>
<p>These techniques enable loosely coupled systems that are resilient, manageable, and observable. Combined with robust automation, they allow engineers to make high-impact changes frequently and predictably with minimal toil.</p>
</blockquote>
<blockquote>
<p>The Cloud Native Computing Foundation seeks to drive adoption of this paradigm by fostering and sustaining an ecosystem of open source, vendor-neutral projects. We democratize state-of-the-art patterns to make these innovations accessible for everyone.</p>
</blockquote>
<p>下面是不精准的翻译：</p>
<blockquote>
<p>云原生技术使组织能够在现代动态环境（例如公共云、私有云和混合云）中构建和运行可扩展的应用程序。容器、服务网格、微服务、不可变基础设施和声明式 API 是这种方法的例证。</p>
<p>这些技术使松散耦合的系统具有弹性、可管理性和可观察性。与强大的自动化相结合，它们使工程师能够以最少的工作量频繁且可预测地进行高影响力的更改。</p>
<p>CNCF 旨在通过培育和维持一个由供应商中立的开源项目生态系统来推动这种范式的应用。我们将最先进的模式民主化，使每个人都可以使用这些创新。</p>
</blockquote>
<p>这个说明更多的是描述了云原生能带给我们什么，我在 CNCF 2019年5月21 日的一篇公告 <span class="exturl" data-url="aHR0cHM6Ly93d3cuY25jZi5pby8vMjAxOS8wNS8yMS9jbmNmLWdyb3dzLXRvLW1vcmUtdGhhbi00MDAtbWVtYmVycy8=">Cloud Native Computing Foundation grows to more than 400 members
<i class="fa fa-external-link-alt"></i></span> 中找到了更精确的描述：</p>
<blockquote>
<p>Cloud native computing uses an open source software stack to deploy applications as microservices, packaging each part into its own container, and dynamically orchestrating those containers to optimize resource utilization. </p>
</blockquote>
<p>皇家翻译：</p>
<blockquote>
<p>云原生计算使用开源技术栈来部署微服务应用，将每个组件打包到它自己的容器中，并且通过动态编排以优化资源利用率。 </p>
</blockquote>
<p>提取一下里面的关键词：开源技术栈、微服务应用、容器化、动态编排，重新组织一下，即为：云原生应用就是把微服务架构的应用，以容器化的方式部署在具有动态编排能力的云平台（Kubernetes）上。</p>
<h2 id="如何设计一个云原生的程序？"><a href="#如何设计一个云原生的程序？" class="headerlink" title="如何设计一个云原生的程序？"></a>如何设计一个云原生的程序？</h2><p><img data-src="http://qiniucdn.wayneshao.com/%E4%BA%91%E5%8E%9F%E7%94%9F%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F/20210920084658937.png"><br>以下内容均节选翻译自资深云原生领域专家 Siddharth Patnaik 发表的文章 <span class="exturl" data-url="aHR0cHM6Ly9tZWRpdW0uY29tL3dhbG1hcnRnbG9iYWx0ZWNoL2Nsb3VkLW5hdGl2ZS1hcHBsaWNhdGlvbi1hcmNoaXRlY3R1cmUtYTg0ZGRmMzc4Zjgy">Cloud Native Application Architecture<i class="fa fa-external-link-alt"></i></span>，有兴趣的同学可以拜读原文。</p>
<p>PS：是在 Google Translate 的基础上进行的二次翻译，受译者水平所限，可能会有错漏，会尽可能保证内容通顺且语义流畅。</p>
<blockquote>
<p>Cloud-native is about how applications are created and deployed, not where. </p>
</blockquote>
<p><em><strong>云原生关注的是应用如何构建和部署，而非在哪里运行。</strong></em></p>
<h3 id="设计为松散耦合的微服务"><a href="#设计为松散耦合的微服务" class="headerlink" title="设计为松散耦合的微服务"></a>设计为松散耦合的微服务</h3><p>微服务是一种将单个应用程序开发为一组小型服务的方法，每个服务都在自己的进程中运行，并使用 HTTP 等轻量级协议进行通信。 这些服务是围绕业务能力构建的，并且可以通过完全自动化的部署机制独立部署。</p>
<h3 id="使用最佳的语言和框架"><a href="#使用最佳的语言和框架" class="headerlink" title="使用最佳的语言和框架"></a>使用最佳的语言和框架</h3><p>云原生应用程序的每项服务都应当使用最适合该功能的语言和框架开发。<br>云原生应用程序是多语言的。<br>服务使用多种语言、运行时和框架。<br>例如，开发人员可能会基于 WebSockets 构建一个实时流服务，使用 Node.js 开发，同时选择 Python 来构建基于机器学习的服务，并选择 spring-boot 来暴露 REST API。 开发微服务的细粒度方法使他们能够为特定工作选择最佳语言和框架。</p>
<h3 id="以交互和协作为核心的-APIs"><a href="#以交互和协作为核心的-APIs" class="headerlink" title="以交互和协作为核心的 APIs"></a>以交互和协作为核心的 APIs</h3><p>云原生服务使用基于协议的轻量级 API，如表征状态传输 (REST) 来公开其功能。 内部服务使用二进制协议（如 Thrift、Protobuff、GRPC 等）相互通信以获得更好的性能。</p>
<h3 id="无状态且可大规模扩展"><a href="#无状态且可大规模扩展" class="headerlink" title="无状态且可大规模扩展"></a>无状态且可大规模扩展</h3><p>云原生应用程序将其状态存储在数据库或其他一些外部实体中，以便实例可以随意增减，任何实例都可以处理请求。<br>它们不依赖于底层基础设施，这允许应用程序以高度分布式的方式运行，并且仍然独立于底层基础设施的弹性性质保持其状态。<br>从可扩展性的角度来看，架构很简单，只需将商品服务器节点添加到集群中就可以扩展应用程序。</p>
<h3 id="韧性作为架构核心"><a href="#韧性作为架构核心" class="headerlink" title="韧性作为架构核心"></a>韧性作为架构核心</h3><p>根据墨菲定律——“任何可能失败的事情都会失败”。<br>当我们将此应用于软件系统时，在分布式系统中，故障必定会发生。<br>硬件可能会失败、网络可能会出现暂时性故障、极少情况下，整个服务或区域都可能会遇到中断，但即使是这样的小概率实践也必须进行预案。<br>韧性是系统从故障中恢复并继续运行的能力。这不是试图避免故障，而是以一种避免停机或数据丢失的方式响应故障。 韧性的目标是在发生故障后将应用程序恢复到完全正常运行的状态。 韧性提供以下功能：</p>
<ul>
<li>高可用性 — 应用程序能够继续在健康状态下运行，而不会出现明显的停机时间。</li>
<li>灾难恢复 — 应用程序从罕见但重大事件中恢复的能力：非暂时性、大规模故障，例如影响整个区域的服务中断。</li>
</ul>
<p>使应用程序具有弹性的主要方法之一是通过<strong>冗余</strong>。 HA 和 DR 方案使用多节点集群、多区域部署、数据复制、无单点故障、持续监控等实现。</p>
<p>以下是一些实施弹性的策略：</p>
<ul>
<li><p><strong>重试暂时性故障</strong> — 暂时性故障可能是由于网络连接暂时中断、数据库连接断开或服务繁忙时超时造成的。通常，可以通过重试请求来解决暂时性故障。</p>
</li>
<li><p><strong>跨实例负载均衡</strong> — 一切皆集群。无状态应用程序应该能够通过向集群添加更多节点来扩展。</p>
</li>
<li><p><strong>优雅降级</strong> — 如果服务失败并且没有故障转移路径，应用程序可能能够优雅降级，同时仍然提供可接受的用户体验</p>
</li>
<li><p><strong>限制大量租户/用户</strong> — 有时少数用户会产生过多的负载。这可能会对其他用户产生影响，从而降低应用程序的整体可用性。</p>
</li>
<li><p><strong>使用断路器</strong> — 断路器模式可以防止应用程序重复尝试可能失败的操作。断路器包装对服务的调用并跟踪最近失败的次数。如果故障计数超过阈值，断路器开始返回错误代码而不调用服务。</p>
</li>
<li><p><strong>应用补偿交易</strong> — 补偿事务是撤销另一个已完成事务的影响的事务。在分布式系统中，实现强事务一致性可能非常困难。补偿事务是一种通过使用一系列可在每一步撤消的较小的单独事务来实现一致性的方法。</p>
</li>
<li><p><strong>测试弹性</strong> — 通常弹性测试不能像测试应用程序功能一样完成（通过运行单元测试、集成测试等）。相反，您必须测试端到端工作负载在仅间歇性发生的故障条件下的执行情况。例如：通过进程崩溃、证书过期、使依赖服务不可用等来注入失败。像<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL05ldGZsaXgvY2hhb3Ntb25rZXk=">【chaos monkey】<i class="fa fa-external-link-alt"></i></span>这样的框架可以用于这种混乱测试。</p>
<h3 id="打包成轻量级容器并编排"><a href="#打包成轻量级容器并编排" class="headerlink" title="打包成轻量级容器并编排"></a>打包成轻量级容器并编排</h3><p>容器可以将应用程序隔离到共享操作系统内核的小型轻量级执行环境中。 通常以兆字节为单位，容器使用的资源比虚拟机少得多，而且几乎可以立即启动。 Docker 已经成为容器技术的标准。 它们提供的最大优势是便携性。<br>云原生应用程序使用 Kubernetes 进行部署，Kubernetes 是一个开源平台，旨在自动化部署、扩展和管理容器化应用程序。 Kubernetes 最初由 Google 开发，现已成为部署云原生应用程序的操作系统。 它也是最早在 CNCF 毕业的几个项目之一。</p>
<h3 id="通过-CI-CD-实施敏捷-DevOps-和自动化"><a href="#通过-CI-CD-实施敏捷-DevOps-和自动化" class="headerlink" title="通过 CI/CD 实施敏捷 DevOps 和自动化"></a>通过 CI/CD 实施敏捷 DevOps 和自动化</h3><p>DevOps，“开发”和“运维”的合并描述了实现快速敏捷开发和可扩展、可靠运营所需的组织结构、实践和文化。 DevOps 是关于使开发和运维团队保持一致的文化、协作实践以及自动化，以便他们在改善客户体验、更快地响应业务需求以及确保创新与安全和运营需求之间取得平衡方面拥有统一的心态。 现代组织相信开发人员和运维人员以及职责的合并，以便一个 DevOps 团队承担这两项职责。 通过这种方式，您只有一个团队负责开发、部署和在生产中运行软件。</p>
<p>  持续集成和持续交付:<br><img data-src="http://qiniucdn.wayneshao.com/46314/20210920092932163.png"><br>  持续集成 (CI) 和持续交付 (CD) 是一组操作原则，使应用程序开发团队能够更频繁、更可靠地交付代码更改。 CI 的技术目标是建立一种一致且自动化的方式来构建、打包和测试应用程序。随着集成过程的一致性，团队更有可能更频繁地提交代码更改，从而带来更好的协作和软件质量。</p>
<p>  持续交付从持续集成结束的地方开始。 CD 自动将应用程序交付到选定的基础架构环境。它获取由 CI 构建的包，部署到多个环境中，如 Dev、QA、Performance、Staging 运行各种测试，如集成测试、性能测试等，最后部署到生产中。持续交付通常在管道中很少有手动步骤，而持续部署是一个完全自动化的管道，它可以自动化从代码签入到生产部署的整个过程。</p>
</li>
</ul>
<h3 id="弹性-动态扩容-缩容"><a href="#弹性-动态扩容-缩容" class="headerlink" title="弹性 - 动态扩容/缩容"></a>弹性 - 动态扩容/缩容</h3><p>云原生应用通过在使用高峰期间打动态增加资源来利用云的弹性。 如果您的基于云的电子商务应用程序遇到使用高峰，您可以将其设置为使用额外的计算资源，直到高峰消退，然后关闭这些资源。云原生应用程序可以根据需要调整以适应增加的资源和规模。</p>
]]></content>
      <categories>
        <category>云原生</category>
      </categories>
      <tags>
        <tag>云原生</tag>
        <tag>CNCF</tag>
        <tag>Kubernetes</tag>
      </tags>
  </entry>
  <entry>
    <title>使用Git提交记录中的文件更改时间来修改文件的更改时间</title>
    <url>/posts/9412.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>在今天更新文章的时候，实验性的使用了按照更新时间排序，却发现所有文章的更新时间都是当天，推测是因为读取了文件的更新时间，而文件更新时间由于仓库刚刚新拉取而通通保持了当期时间，所以有了标题所示的需求。</p>
<span id="more"></span>
<h2 id="以下操作环境均为Linux系统"><a href="#以下操作环境均为Linux系统" class="headerlink" title="以下操作环境均为Linux系统"></a>以下操作环境均为Linux系统</h2><p>首先需要对git做设置</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 中文目录处理</span></span><br><span class="line">git config core.quotepath <span class="literal">false</span>;</span><br></pre></td></tr></table></figure>

<p>然后直接上脚本</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 获取 git 仓库中所有文件的最新修改时间并应用在文件上</span></span><br><span class="line">git ls-tree -r --name-only HEAD | <span class="keyword">while</span> <span class="built_in">read</span> filename; <span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$filename</span>;</span><br><span class="line"><span class="built_in">touch</span>  -t <span class="string">&quot;<span class="subst">$(date -d <span class="string">&quot;<span class="subst">$(git log -1 --pretty=format:<span class="string">&quot;%aI&quot;</span> <span class="string">&quot;<span class="variable">$filename</span>&quot;</span>)</span>&quot;</span> <span class="string">&quot;+%Y%m%d%H%M.%S&quot;</span>)</span>&quot;</span> <span class="string">&quot;<span class="variable">$filename</span>&quot;</span>;</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>踩坑笔记</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>Git</tag>
      </tags>
  </entry>
  <entry>
    <title>使用委托解决方法的跨线程调用问题</title>
    <url>/posts/51547.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">//声明和需进行跨线程调用的方法相同形参表的委托</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">delegate</span> <span class="keyword">void</span> <span class="title">AddStatusInfoToFormCallback</span>(<span class="params"><span class="built_in">string</span> str</span>)</span>;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">AddStatusInfoToForm</span>(<span class="params"><span class="built_in">string</span> str</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//检测调用控件的线程和创建控件的线程是否相同</span></span><br><span class="line">    <span class="comment">//如果调用控件的线程和创建创建控件的线程不是同一个则为True</span></span><br><span class="line">    <span class="keyword">if</span> (InvokeRequired)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//使用委托调用本方法</span></span><br><span class="line">        <span class="keyword">var</span> d = <span class="keyword">new</span> AddStatusInfoToFormCallback(AddStatusInfoToForm);</span><br><span class="line">        Invoke(d, str);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//当前线程调用</span></span><br><span class="line">        Controls.Clear();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<span id="more"></span>]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
      <tags>
        <tag>Winform</tag>
        <tag>跨线程</tag>
        <tag>委托</tag>
      </tags>
  </entry>
  <entry>
    <title>使用不安全代码 + 反射修改 String.Empty 的值</title>
    <url>/posts/25922.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>前几天的时候看到了 <span class="exturl" data-url="aHR0cHM6Ly9tdnAubWljcm9zb2Z0LmNvbS9lbi11cy9QdWJsaWNQcm9maWxlLzUwMDMyMjU=">吕毅<i class="fa fa-external-link-alt"></i></span> 大佬写的博客<br><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLndhbHRlcmx2LmNvbS9wb3N0L3doeS1zdHJpbmctZW1wdHktaXMtYS1yZWFkb25seS1maWVsZC1idXQtbm90LWEtY29uc3RhbnQuaHRtbA==">为什么 C# 的 string.Empty 是一个静态只读字段，而不是一个常量呢？<i class="fa fa-external-link-alt"></i></span>，<br>非常感谢吕毅大佬的分享，在文章的末尾大佬提到了通过反射修改 String.Empty 的可能，于是我打算自己实践一下。<br><img data-src="https://qiniucdn.wayneshao.com/%E4%BD%BF%E7%94%A8%E4%B8%8D%E5%AE%89%E5%85%A8%E4%BB%A3%E7%A0%81%E4%BF%AE%E6%94%B9-String.Empty-%E7%9A%84%E5%80%BC/20190311084845629.png"></p>
<span id="more"></span>

<h2 id="反射修改"><a href="#反射修改" class="headerlink" title="反射修改"></a>反射修改</h2><p>首先上一个我自己封装的 ReflectionExtension 类，方便直接进行反射操作（这里只展示部分代码，完整代码会附上下载链接）</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">System.Reflection</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">ReflectionExtension</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">const</span> BindingFlags Flags = BindingFlags.Public | BindingFlags.NonPublic |</span><br><span class="line">                         BindingFlags.Static | BindingFlags.Instance |</span><br><span class="line">                         BindingFlags.DeclaredOnly;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 通过反射设置字段的值</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;instance&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;fieldName&quot;&gt;</span>字段名称<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;value&quot;&gt;</span>要修改为的值<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">SetField</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">object</span> instance, <span class="built_in">string</span> fieldName, <span class="built_in">object</span> <span class="keyword">value</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> type = instance.GetType();</span><br><span class="line">            <span class="keyword">var</span> field = type.GetField(fieldName) ?? type.GetField(fieldName, Flags);</span><br><span class="line">            field?.SetValue(instance, <span class="keyword">value</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>新建项目的框架为 .NET Framework 3.5，使用以下代码完成反射修改 String.Empty ：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    Console.WriteLine(<span class="string">$&quot;Empty : <span class="subst">&#123;<span class="built_in">string</span>.Empty&#125;</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">string</span>.Empty.SetField(<span class="string">&quot;m_stringLength&quot;</span>, <span class="number">3</span>);</span><br><span class="line">    <span class="string">&quot;&quot;</span>.SetField(<span class="string">&quot;Empty&quot;</span>,<span class="string">&quot;CBA&quot;</span>);</span><br><span class="line"></span><br><span class="line">    Console.WriteLine(<span class="string">$&quot;Empty Reflection : <span class="subst">&#123;<span class="built_in">string</span>.Empty&#125;</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line">    Console.ReadLine();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果如图：<br><img data-src="https://qiniucdn.wayneshao.com/%E4%BD%BF%E7%94%A8%E4%B8%8D%E5%AE%89%E5%85%A8%E4%BB%A3%E7%A0%81%E4%BF%AE%E6%94%B9-String.Empty-%E7%9A%84%E5%80%BC/20190311090724793.png"><br>有效!<br>查看一下 String.cs 的源码<br><img data-src="https://qiniucdn.wayneshao.com/%E4%BD%BF%E7%94%A8%E4%B8%8D%E5%AE%89%E5%85%A8%E4%BB%A3%E7%A0%81%E4%BF%AE%E6%94%B9-String.Empty-%E7%9A%84%E5%80%BC/20190311112213462.png"><br>.NET Framework 3.5 以下版本中的 String.Empty 就是一个普通的共有只读字段。</p>
<p>下面将框架版本升级到 4.0 以上再次尝试：<br><img data-src="https://qiniucdn.wayneshao.com/%E4%BD%BF%E7%94%A8%E4%B8%8D%E5%AE%89%E5%85%A8%E4%BB%A3%E7%A0%81%E4%BF%AE%E6%94%B9-String.Empty-%E7%9A%84%E5%80%BC/20190311112442989.png"><br>同样的方法在 4.0 以上的版本就行不通了，转到源码看一下：<br><img data-src="https://qiniucdn.wayneshao.com/%E4%BD%BF%E7%94%A8%E4%B8%8D%E5%AE%89%E5%85%A8%E4%BB%A3%E7%A0%81%E4%BF%AE%E6%94%B9-String.Empty-%E7%9A%84%E5%80%BC/20190311112600692.png"><br>String.Empty 上增加了 <strong><code>__DynamicallyInvokable </code></strong> Attribute，查找资料:</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Each blessed API will be annotated with a &quot;__DynamicallyInvokableAttribute&quot;.</span></span><br><span class="line"><span class="comment">// This &quot;__DynamicallyInvokableAttribute&quot; is a type defined in its own assembly.</span></span><br><span class="line"><span class="comment">// So the ctor is always a MethodDef and the type a TypeDef.</span></span><br><span class="line"><span class="comment">// We cache this ctor MethodDef token for faster custom attribute lookup.</span></span><br><span class="line"><span class="comment">// If this attribute type doesn&#x27;t exist in the assembly, it means the assembly</span></span><br><span class="line"><span class="comment">// doesn&#x27;t contain any blessed APIs.</span></span><br><span class="line">Type invocableAttribute = GetType(<span class="string">&quot;__DynamicallyInvokableAttribute&quot;</span>, <span class="literal">false</span>);</span><br><span class="line"><span class="keyword">if</span> (invocableAttribute != <span class="literal">null</span>)</span><br><span class="line">&#123;</span><br><span class="line"> Contract.Assert(((MetadataToken)invocableAttribute.MetadataToken).IsTypeDef);</span><br><span class="line"></span><br><span class="line"> ConstructorInfo ctor = invocableAttribute.GetConstructor(Type.EmptyTypes);</span><br><span class="line"> Contract.Assert(ctor != <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line"> <span class="built_in">int</span> token = ctor.MetadataToken;</span><br><span class="line"> Contract.Assert(((MetadataToken)token).IsMethodDef);</span><br><span class="line"></span><br><span class="line"> flags |= (ASSEMBLY_FLAGS)token &amp; ASSEMBLY_FLAGS.ASSEMBLY_FLAGS_TOKEN_MASK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据注释中的介绍，这个特性只是某种用于提升速度的标记，看来大约是跟 CLR 有关，与这个 Attribute 并没有什么关系。</p>
<h2 id="不安全代码"><a href="#不安全代码" class="headerlink" title="不安全代码"></a>不安全代码</h2><p>下面加入不安全代码，使用指针来实现我们的设置 String.Empty 。<br>首先打开项目属性，设置生成中的允许<strong>不安全代码</strong>选项<br><img data-src="https://qiniucdn.wayneshao.com/%E4%BD%BF%E7%94%A8%E4%B8%8D%E5%AE%89%E5%85%A8%E4%BB%A3%E7%A0%81%E4%BF%AE%E6%94%B9-String.Empty-%E7%9A%84%E5%80%BC/20190311114311684.png"><br>代码：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Reflection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">System</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">StringHelper</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 使用反射 + 不安全代码直接修改 string 的值</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;str&quot;&gt;</span>原始字符串<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;newStr&quot;&gt;</span>新字符串<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">unsafe</span> <span class="keyword">void</span> <span class="title">SetValue</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">string</span> str, <span class="built_in">string</span> newStr</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//使用反射设置字符串的长度属性</span></span><br><span class="line">            str.SetField(<span class="string">&quot;m_stringLength&quot;</span>, newStr.Length);</span><br><span class="line">            <span class="comment">//指针大法好</span></span><br><span class="line">            <span class="keyword">fixed</span> (<span class="built_in">char</span>* pe = str)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; newStr.Length; i++)</span><br><span class="line">                    pe[i] = newStr[i];</span><br><span class="line">                pe[newStr.Length] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 .NET Framework 4.7.2 下重新运行下面的测试代码</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    Console.WriteLine(<span class="string">$&quot;Empty : <span class="subst">&#123;<span class="built_in">string</span>.Empty&#125;</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">string</span>.Empty.SetField(<span class="string">&quot;m_stringLength&quot;</span>, <span class="number">3</span>);</span><br><span class="line">    <span class="string">&quot;&quot;</span>.SetField(<span class="string">&quot;Empty&quot;</span>,<span class="string">&quot;CBA&quot;</span>);</span><br><span class="line"></span><br><span class="line">    Console.WriteLine(<span class="string">$&quot;Empty Reflection : <span class="subst">&#123;<span class="built_in">string</span>.Empty&#125;</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">string</span>.Empty.SetValue(<span class="string">&quot;ABC&quot;</span>);</span><br><span class="line"></span><br><span class="line">    Console.WriteLine(<span class="string">$&quot;Empty Unsafe : <span class="subst">&#123;<span class="built_in">string</span>.Empty&#125;</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line">    Console.ReadLine();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img data-src="https://qiniucdn.wayneshao.com/%E4%BD%BF%E7%94%A8%E4%B8%8D%E5%AE%89%E5%85%A8%E4%BB%A3%E7%A0%81%E4%BF%AE%E6%94%B9-String.Empty-%E7%9A%84%E5%80%BC/20190311114612307.png"><br>不安全代码可以在最新版 Framework 上实现修改 String.Empty。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>在各个平台下运行测试代码，结论如下：</p>
<table>
<thead>
<tr>
<th>平台</th>
<th>反射</th>
<th>不安全代码</th>
</tr>
</thead>
<tbody><tr>
<td>.NET Framework 1.0 - 3.5</td>
<td><strong>√</strong></td>
<td><strong>√</strong></td>
</tr>
<tr>
<td>.NET Framework 4.0 - 4.7.2</td>
<td><strong>×</strong></td>
<td><strong>√</strong></td>
</tr>
<tr>
<td>.NET Core 1.0 - 2.0</td>
<td><strong>×</strong></td>
<td><strong>√</strong></td>
</tr>
<tr>
<td>.NET Core 2.1 - 2.2</td>
<td><strong>×</strong></td>
<td><strong>×</strong></td>
</tr>
<tr>
<td>.NET Core 3.0 preview</td>
<td><strong>FieldAccessException</strong><br/>Cannot set initonly static field ‘Empty’ after type ‘System.String’ is initialized.</td>
<td><strong>×</strong></td>
</tr>
</tbody></table>
]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
      <tags>
        <tag>反射</tag>
        <tag>unsafe</tag>
        <tag>String.Empty</tag>
        <tag>不安全代码</tag>
      </tags>
  </entry>
  <entry>
    <title>面试·网站后台开发工程师·总结</title>
    <url>/posts/61268.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>关于2018年3月9日面试某公司网站后台开发工程师的一些总结。</p>
<span id="more"></span>
<!--多益-->
<h2 id="面试问题总结"><a href="#面试问题总结" class="headerlink" title="面试问题总结"></a>面试问题总结</h2><p>　　面试官非常nice，可能是因为之前通过同学跟他有过一些间接交流，所以开场时问了我：“我让XXX告诉你去学习一下.NET Core，你学的怎么样了。”<br>　　瞬间整个人就不那么紧张了。之后面试官首先问了我一些我目前主要使用的C#桌面软件开发的一些知识，之后在逐渐的把问题转到.NET Core，从中可以感觉得出面试官对于基础知识即为擅长，问的问题大量的都是非常细节性的，由于我在.NET Core上并没有付出很多的学习时间，而且主要是“自定向下”的学习，主要学习怎么使用，这些细节就了解的不那么清楚了，所以整个面试确实有不少问题没能回答得上来。<br>　　下面是具体没能答上来问题的具体分析。</p>
<h3 id="桌面开发"><a href="#桌面开发" class="headerlink" title="桌面开发"></a>桌面开发</h3><h4 id="Winform-多线程状态下应该怎样保持界面响应"><a href="#Winform-多线程状态下应该怎样保持界面响应" class="headerlink" title="Winform 多线程状态下应该怎样保持界面响应"></a>Winform 多线程状态下应该怎样保持界面响应</h4><p>　　当时回答了可以使用.Net Framework 4.5版本以上支持的语法糖await\asnyc来进行多线程请求，或者是新开线程完成操作，或者使用Application.DoEvent()这样的函数强行保持界面响应。<br>　　当时应该是有些紧张，没有准确get到面试官真正想要问的问题，事后思考感觉面试官真正想问的应该是<a href="cjepod20f002mh8kbydftcdjw.html">使用委托解决方法的跨线程调用问题</a>这种类型的委托问题，所以这道题也算是没有回答好。</p>
<h3 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h3><h4 id="数据库横表、纵表转换"><a href="#数据库横表、纵表转换" class="headerlink" title="数据库横表、纵表转换"></a>数据库横表、纵表转换</h4><p>　　这道题确实是忘记了大学学习的知识，也没反应过来横纵表转换到底是什么概念，下面直接写一个例子吧。</p>
<p>**横表结构: ** <em><strong>Achievement</strong></em></p>
<blockquote>
<table>
<thead>
<tr>
<th align="center">ID</th>
<th align="center">姓名</th>
<th align="center">语文</th>
<th align="center">数学</th>
<th align="center">英语</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td align="center">张三</td>
<td align="center">80</td>
<td align="center">90</td>
<td align="center">70</td>
</tr>
<tr>
<td align="center">2</td>
<td align="center">李四</td>
<td align="center">90</td>
<td align="center">85</td>
<td align="center">95</td>
</tr>
<tr>
<td align="center">3</td>
<td align="center">王五</td>
<td align="center">88</td>
<td align="center">75</td>
<td align="center">90</td>
</tr>
</tbody></table>
</blockquote>
<p><strong>转换后的表结构</strong></p>
<blockquote>
<table>
<thead>
<tr>
<th align="center">ID</th>
<th align="center">姓名</th>
<th align="center">科目</th>
<th align="center">成绩</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td align="center">张三</td>
<td align="center">语文</td>
<td align="center">80</td>
</tr>
<tr>
<td align="center">2</td>
<td align="center">张三</td>
<td align="center">数学</td>
<td align="center">90</td>
</tr>
<tr>
<td align="center">3</td>
<td align="center">张三</td>
<td align="center">英语</td>
<td align="center">70</td>
</tr>
<tr>
<td align="center">4</td>
<td align="center">李四</td>
<td align="center">语文</td>
<td align="center">90</td>
</tr>
<tr>
<td align="center">5</td>
<td align="center">李四</td>
<td align="center">数学</td>
<td align="center">80</td>
</tr>
<tr>
<td align="center">6</td>
<td align="center">李四</td>
<td align="center">英语</td>
<td align="center">99</td>
</tr>
<tr>
<td align="center">7</td>
<td align="center">王五</td>
<td align="center">语文</td>
<td align="center">85</td>
</tr>
<tr>
<td align="center">8</td>
<td align="center">王五</td>
<td align="center">数学</td>
<td align="center">96</td>
</tr>
<tr>
<td align="center">9</td>
<td align="center">王五</td>
<td align="center">英语</td>
<td align="center">88</td>
</tr>
</tbody></table>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span>　姓名,<span class="string">&#x27;语文&#x27;</span>　<span class="keyword">AS</span>　科目,语文　<span class="keyword">AS</span>　成绩　<span class="keyword">FROM</span>　Achievement　<span class="keyword">UNION</span>　<span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span>　姓名,<span class="string">&#x27;数学&#x27;</span>　<span class="keyword">AS</span>　科目,数学　<span class="keyword">AS</span>　成绩　<span class="keyword">FROM</span>　Achievement　<span class="keyword">UNION</span>　<span class="keyword">ALL</span>　</span><br><span class="line"><span class="keyword">SELECT</span>　姓名,<span class="string">&#x27;英语&#x27;</span>　<span class="keyword">AS</span>　科目,英语　<span class="keyword">AS</span>　成绩　<span class="keyword">FROM</span>　Achievement</span><br><span class="line"><span class="keyword">ORDER</span>　<span class="keyword">BY</span>　姓名,科目　<span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>
<h3 id="NET-Core"><a href="#NET-Core" class="headerlink" title=".NET Core"></a>.NET Core</h3><p>　　下面题目中的一些.NET Core的细节，我会引用来自本人购买的 张剑桥 先生的《ASP.NET Core 跨平台开发从入门到实战》一书中的内容，如果希望获得更多的知识请直接在各大平台购买本书，若侵犯了您的权利，请联系删除。</p>
<h4 id="NET-Core-程序增加中间件在什么位置"><a href="#NET-Core-程序增加中间件在什么位置" class="headerlink" title=".NET Core 程序增加中间件在什么位置"></a>.NET Core 程序增加中间件在什么位置</h4><blockquote>
<p>　　在 ASP.NET Core 中，你可以使用中间件构建你的请求处理管道。ASP.NET Core 中间件为一个HttpContext 执行异步逻辑，然后按顺序调用下一个中间件或者直接终止请求。一般来说，要使用一个中间件，只需在Configure方法里调用 IApplicationBuilder 上一个对应的扩展方法即可。</p>
</blockquote>
<h4 id="静态文件访问开启"><a href="#静态文件访问开启" class="headerlink" title="静态文件访问开启"></a>静态文件访问开启</h4><blockquote>
<p>　　为了能够使用静态文件服务，必须配置中间件，把静态文件中间件加入到管道内。静态文件中间件可通过下述方法来配置：在项目中增加 Microsoft.AspNetCore.StaticFiles包依赖，然后从 Startup.Configure 中调用.UseStaticFiles扩展方法：</p>
</blockquote>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// This method gets called by the runtime. Use this method to configure the HTTP request pipeline.</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params">IApplicationBuilder app, IHostingEnvironment env</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    app.UseStaticFiles();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="配置使用Session"><a href="#配置使用Session" class="headerlink" title="配置使用Session"></a>配置使用Session</h4><p>　　与上面的静态文件相同，需要首先依赖 Microsoft.AspNetCore.Session 包，然后从Startup.Configure 中调用.UseSession方法。</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// This method gets called by the runtime. Use this method to configure the HTTP request pipeline.</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params">IApplicationBuilder app, IHostingEnvironment env</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    app.UseSession();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="EF-Core如何启用懒加载"><a href="#EF-Core如何启用懒加载" class="headerlink" title="EF Core如何启用懒加载"></a>EF Core如何启用懒加载</h4><p>EF6中是默认开启懒加载的，可以通过修改配置文件来进行修改，而到了EF Core中，则可以在 DbContext 的 OnConfiguring 方法中添加对 UseLazyLoadingProxies() 扩展方法调用即可。</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">WayneContext</span> : <span class="title">DbContext</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnConfiguring</span>(<span class="params">DbContextOptionsBuilder optionsBuilder</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> sqlConnectionStringBuilder = <span class="keyword">new</span> SqlConnectionStringBuilder &#123;</span><br><span class="line">            DataSource = <span class="string">&quot;****&quot;</span>,</span><br><span class="line">            InitialCatalog = <span class="string">&quot;Wayne&quot;</span>,</span><br><span class="line">            UserID = <span class="string">&quot;sa&quot;</span>,</span><br><span class="line">            Password = <span class="string">&quot;sa&quot;</span></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        optionsBuilder.UseSqlServer(sqlConnectionStringBuilder.ConnectionString);</span><br><span class="line"></span><br><span class="line">        optionsBuilder.UseLazyLoadingProxies();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">base</span>.OnConfiguring(optionsBuilder);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Asp-NET-Core的热部署是怎么实现的"><a href="#Asp-NET-Core的热部署是怎么实现的" class="headerlink" title="Asp.NET Core的热部署是怎么实现的"></a>Asp.NET Core的热部署是怎么实现的</h4><p>　　以MVC模板为例，其实是在 Program 类中的 CreateWebHostBuilder 方法中实现的。</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Hosting;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">TestCore</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            CreateWebHostBuilder(args).Build().Run();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IWebHostBuilder <span class="title">CreateWebHostBuilder</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span> =&gt;</span><br><span class="line">            WebHost.CreateDefaultBuilder(args)</span><br><span class="line">                .UseStartup&lt;Startup&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>　　第十四行，WebHost.CreateDefaultBuilder(args)方法中巨硬封装了读取配置文件的操作。F12反编译转到源码。</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span>   Initializes a new instance of the <span class="doctag">&lt;see cref=&quot;T:Microsoft.AspNetCore.Hosting.WebHostBuilder&quot; /&gt;</span> class with pre-configured defaults.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;remarks&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span>   The following defaults are applied to the returned <span class="doctag">&lt;see cref=&quot;T:Microsoft.AspNetCore.Hosting.WebHostBuilder&quot; /&gt;</span>:</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span>     use Kestrel as the web server and configure it using the application&#x27;s configuration providers,</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span>     set the <span class="doctag">&lt;see cref=&quot;P:Microsoft.AspNetCore.Hosting.IHostingEnvironment.ContentRootPath&quot; /&gt;</span> to the result of <span class="doctag">&lt;see cref=&quot;M:System.IO.Directory.GetCurrentDirectory&quot; /&gt;</span>,</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span>     load <span class="doctag">&lt;see cref=&quot;T:Microsoft.Extensions.Configuration.IConfiguration&quot; /&gt;</span> from &#x27;appsettings.json&#x27; and &#x27;appsettings.[<span class="doctag">&lt;see cref=&quot;P:Microsoft.AspNetCore.Hosting.IHostingEnvironment.EnvironmentName&quot; /&gt;</span>].json&#x27;,</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span>     load <span class="doctag">&lt;see cref=&quot;T:Microsoft.Extensions.Configuration.IConfiguration&quot; /&gt;</span> from User Secrets when <span class="doctag">&lt;see cref=&quot;P:Microsoft.AspNetCore.Hosting.IHostingEnvironment.EnvironmentName&quot; /&gt;</span> is &#x27;Development&#x27; using the entry assembly,</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span>     load <span class="doctag">&lt;see cref=&quot;T:Microsoft.Extensions.Configuration.IConfiguration&quot; /&gt;</span> from environment variables,</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span>     load <span class="doctag">&lt;see cref=&quot;T:Microsoft.Extensions.Configuration.IConfiguration&quot; /&gt;</span> from supplied command line args,</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span>     configures the <span class="doctag">&lt;see cref=&quot;T:Microsoft.Extensions.Logging.ILoggerFactory&quot; /&gt;</span> to log to the console and debug output,</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span>     enables IIS integration,</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span>     and enables the ability for frameworks to bind their options to their default configuration sections.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;args&quot;&gt;</span>The command line args.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>The initialized <span class="doctag">&lt;see cref=&quot;T:Microsoft.AspNetCore.Hosting.IWebHostBuilder&quot; /&gt;</span>.<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IWebHostBuilder <span class="title">CreateDefaultBuilder</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    IWebHostBuilder hostBuilder = <span class="keyword">new</span> WebHostBuilder().UseKestrel((Action&lt;WebHostBuilderContext, KestrelServerOptions&gt;)((builderContext, options) =&gt; options.Configure((IConfiguration)builderContext.Configuration.GetSection(<span class="string">&quot;Kestrel&quot;</span>)))).UseContentRoot(Directory.GetCurrentDirectory()).ConfigureAppConfiguration((Action&lt;WebHostBuilderContext, IConfigurationBuilder&gt;)((hostingContext, config) =&gt;</span><br><span class="line">	&#123;</span><br><span class="line">		IHostingEnvironment hostingEnvironment = hostingContext.HostingEnvironment;</span><br><span class="line">		config.AddJsonFile(<span class="string">&quot;appsettings.json&quot;</span>, <span class="literal">true</span>, <span class="literal">true</span>).AddJsonFile(<span class="built_in">string</span>.Format(<span class="string">&quot;appsettings.&#123;0&#125;.json&quot;</span>, (<span class="built_in">object</span>)hostingEnvironment.EnvironmentName), <span class="literal">true</span>, <span class="literal">true</span>);</span><br><span class="line">		<span class="keyword">if</span> (hostingEnvironment.IsDevelopment())</span><br><span class="line">		&#123;</span><br><span class="line">			Assembly assembly = Assembly.Load(<span class="keyword">new</span> AssemblyName(hostingEnvironment.ApplicationName));</span><br><span class="line">			<span class="keyword">if</span> (assembly != (Assembly)<span class="literal">null</span>)</span><br><span class="line">				config.AddUserSecrets(assembly, <span class="literal">true</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		config.AddEnvironmentVariables();</span><br><span class="line">		<span class="keyword">if</span> (args == <span class="literal">null</span>)</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">		config.AddCommandLine(args);</span><br><span class="line">	&#125;))</span><br><span class="line">	.ConfigureLogging((Action&lt;WebHostBuilderContext, ILoggingBuilder&gt;)((hostingContext, logging) =&gt;</span><br><span class="line">	&#123;</span><br><span class="line">		logging.AddConfiguration((IConfiguration)hostingContext.Configuration.GetSection(<span class="string">&quot;Logging&quot;</span>));</span><br><span class="line">		logging.AddConsole();</span><br><span class="line">		logging.AddDebug();</span><br><span class="line">	&#125;))</span><br><span class="line">	.UseIISIntegration().UseDefaultServiceProvider((Action&lt;WebHostBuilderContext, ServiceProviderOptions&gt;)((context, options) =&gt; options.ValidateScopes = context.HostingEnvironment.IsDevelopment()));</span><br><span class="line">    <span class="keyword">if</span> (args != <span class="literal">null</span>)</span><br><span class="line">        hostBuilder.UseConfiguration((IConfiguration)<span class="keyword">new</span> ConfigurationBuilder().AddCommandLine(args).Build());</span><br><span class="line">    <span class="keyword">return</span> hostBuilder;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第23行 中 </p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">config.AddJsonFile(<span class="string">&quot;appsettings.json&quot;</span>, <span class="literal">true</span>, <span class="literal">true</span>).AddJsonFile(<span class="built_in">string</span>.Format(<span class="string">&quot;appsettings.&#123;0&#125;.json&quot;</span>, (<span class="built_in">object</span>)hostingEnvironment.EnvironmentName), <span class="literal">true</span>, <span class="literal">true</span>);</span><br></pre></td></tr></table></figure>
<p>继续查看config扩展方法AddJsonFile的源码</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Adds the JSON configuration provider at <span class="doctag">&lt;paramref name=&quot;path&quot; /&gt;</span> to <span class="doctag">&lt;paramref name=&quot;builder&quot; /&gt;</span>.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;builder&quot;&gt;</span>The <span class="doctag">&lt;see cref=&quot;T:Microsoft.Extensions.Configuration.IConfigurationBuilder&quot; /&gt;</span> to add to.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;path&quot;&gt;</span>Path relative to the base path stored in</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;see cref=&quot;P:Microsoft.Extensions.Configuration.IConfigurationBuilder.Properties&quot; /&gt;</span> of <span class="doctag">&lt;paramref name=&quot;builder&quot; /&gt;</span>.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;optional&quot;&gt;</span>Whether the file is optional.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;reloadOnChange&quot;&gt;</span>Whether the configuration should be reloaded if the file changes.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>The <span class="doctag">&lt;see cref=&quot;T:Microsoft.Extensions.Configuration.IConfigurationBuilder&quot; /&gt;</span>.<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IConfigurationBuilder <span class="title">AddJsonFile</span>(<span class="params"><span class="keyword">this</span> IConfigurationBuilder builder, <span class="built_in">string</span> path, <span class="built_in">bool</span> optional, <span class="built_in">bool</span> reloadOnChange</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> builder.AddJsonFile((IFileProvider) <span class="literal">null</span>, path, optional, reloadOnChange);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>形参中的第四个参数为</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;reloadOnChange&quot;&gt;</span>Whether the configuration should be reloaded if the file changes.<span class="doctag">&lt;/param&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>当这个参数被设置为 <strong>true</strong> 时即可实现热更新。</p>
<h4 id="怎样修改绑定的地址"><a href="#怎样修改绑定的地址" class="headerlink" title="怎样修改绑定的地址"></a>怎样修改绑定的地址</h4><p>在 Program 类的 CreateWebHostBuilder 中增加 UseUrls 方法的调用</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IWebHostBuilder <span class="title">CreateWebHostBuilder</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span> =&gt;</span><br><span class="line">            WebHost.CreateDefaultBuilder(args)</span><br><span class="line">                .UseUrls(<span class="string">&quot;http://localhost:5001&quot;</span>)</span><br><span class="line">                .UseStartup&lt;Startup&gt;();</span><br></pre></td></tr></table></figure>

<h4 id="更改实体类后怎样同步更改到数据库"><a href="#更改实体类后怎样同步更改到数据库" class="headerlink" title="更改实体类后怎样同步更改到数据库"></a>更改实体类后怎样同步更改到数据库</h4><p><strong>主要要使用EF的cli命令</strong><br>提交更改</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">dotnet ef migrations Add InitialCreate</span><br></pre></td></tr></table></figure>
<p>同步到数据库</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">dotnet ef database update</span><br></pre></td></tr></table></figure>
<p>回滚到之前的某一次提交</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">dotnet ef migrations update InitialCreate</span><br></pre></td></tr></table></figure>
<p>回滚后同步代码回滚</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">dotnet ef migrations remove</span><br></pre></td></tr></table></figure>
<p>将更改生成SQL脚本（一般是为了方便部署到正式环境）</p>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line">dotnet ef migrations script</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>踩坑笔记</category>
      </categories>
      <tags>
        <tag>总结</tag>
        <tag>面试</tag>
      </tags>
  </entry>
  <entry>
    <title>关于.Net 调用广州医保HG_Interface.dll调用的一些总结（外部组件异常）</title>
    <url>/posts/57100.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p> 开始做的时候也遇到了奇葩的情况、创智提供的dll只能在有UI的Winform、WPF上使用，WebForm、WPF、WebService完全没办法使用，Console在加上了[STAThread]的线程Attribute之后也可以成功调用，推测和dll使用MFC编写有关、但是各种引入MFC的dll均无果，一筹莫展之际把问题提到了交流群里，吾乐吧的牛总给出了可行的解决方案—-使用WCF来调用。</p>
<p>有了具体解决方案一切就顺风顺水了，但是完成程序之后又出现了奇葩的问题，部署到服务器也会出现外部组件异常的问题，本机调试可以部署却不行，很明显就是环境的问题了，由于dll为非托管dll，我们无法从错误中得到有效的错误信息，从环境下手尝试解决，虽然最终成功了，但是目前还并不清楚到底是因为什么，这里的经验是MSSOAP、MSXML、WebMatrix一定要装，如果还是不能成功运行可以考虑安装VS环境试试看。期待能有高手给出具体的解决之道。</p>
<span id="more"></span>
]]></content>
      <categories>
        <category>踩坑笔记</category>
      </categories>
      <tags>
        <tag>C#</tag>
        <tag>广州医保</tag>
        <tag>HG_Interface.dll</tag>
        <tag>外部组件异常</tag>
      </tags>
  </entry>
  <entry>
    <title>关于几种字符串查找算法的对比分析</title>
    <url>/posts/46311.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p><img data-src="https://qiniucdn.wayneshao.com/%E5%85%B3%E4%BA%8E%E5%87%A0%E7%A7%8D%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%9F%A5%E6%89%BE%E7%AE%97%E6%B3%95%E7%9A%84%E5%AF%B9%E6%AF%94%E5%88%86%E6%9E%90/20210902074534094.png"><br>昨日在新生命团队钉钉群中，看到大石头老师分享了他们实现的 IndexOf 算法，据说可以做到 O(1)，第一反应是几乎不可能，了解之后得知是使用了 Boyer Moore 字符串搜索算法，据说这种算法常用于 IDE 工具的查找，比 KMP 更快，所以有了对各种常用字符串查找算法做一下 Benchmark 的想法。</p>
<span id="more"></span>
<h2 id="横向对比的各个字符串查找算法"><a href="#横向对比的各个字符串查找算法" class="headerlink" title="横向对比的各个字符串查找算法"></a>横向对比的各个字符串查找算法</h2><h3 id="string-IndexOf"><a href="#string-IndexOf" class="headerlink" title="string.IndexOf"></a>string.IndexOf</h3><p>此方法为 FLC 中实现的 string 类型的方法，以下源码均已开源在 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL21pY3Jvc29mdC9yZWZlcmVuY2Vzb3VyY2UvYmxvYi9tYXN0ZXIvbXNjb3JsaWIvc3lzdGVtL3N0cmluZy5jcw==">GitHub<i class="fa fa-external-link-alt"></i></span> 。</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Determines the position within this string of the first occurence of the specified</span></span><br><span class="line"><span class="comment">// string, according to the specified search criteria.  The search begins at</span></span><br><span class="line"><span class="comment">// the first character of this string, it is case-sensitive and ordinal (code-point)</span></span><br><span class="line"><span class="comment">// comparison is used.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line">[<span class="meta">Pure</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">IndexOf</span>(<span class="params">String <span class="keyword">value</span></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> IndexOf(<span class="keyword">value</span>, StringComparison.CurrentCulture);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，默认使用了 StringComprison.CurrentCulture，关于其具体的定义，可以参照<span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vZG90bmV0L2FwaS9zeXN0ZW0uc3RyaW5nY29tcGFyaXNvbj92aWV3PW5ldC02LjA=">官方文档<i class="fa fa-external-link-alt"></i></span>：<br><img data-src="https://qiniucdn.wayneshao.com/46311/20210902080637671.png"><br>通常情况我们使用 CurrentCulture 或是 Ordinal 都能很好的满足需求。</p>
<hr>
<p>继续向下看（源码为节选，省略了无关内容）</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">Pure</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">IndexOf</span>(<span class="params">String <span class="keyword">value</span>, StringComparison comparisonType</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> IndexOf(<span class="keyword">value</span>, <span class="number">0</span>, <span class="keyword">this</span>.Length, comparisonType);</span><br><span class="line">&#125;</span><br><span class="line">[<span class="meta">Pure</span>]</span><br><span class="line">[<span class="meta">System.Security.SecuritySafeCritical</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">IndexOf</span>(<span class="params">String <span class="keyword">value</span>, <span class="built_in">int</span> startIndex, <span class="built_in">int</span> count, StringComparison comparisonType</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// Validate inputs</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">value</span> == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="string">&quot;value&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (startIndex &lt; <span class="number">0</span> || startIndex &gt; <span class="keyword">this</span>.Length)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentOutOfRangeException(<span class="string">&quot;startIndex&quot;</span>, Environment.GetResourceString(<span class="string">&quot;ArgumentOutOfRange_Index&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (count &lt; <span class="number">0</span> || startIndex &gt; <span class="keyword">this</span>.Length - count)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentOutOfRangeException(<span class="string">&quot;count&quot;</span>, Environment.GetResourceString(<span class="string">&quot;ArgumentOutOfRange_Count&quot;</span>));</span><br><span class="line">    Contract.EndContractBlock();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (comparisonType) &#123;</span><br><span class="line">        <span class="keyword">case</span> StringComparison.CurrentCulture:</span><br><span class="line">            <span class="keyword">return</span> CultureInfo.CurrentCulture.CompareInfo.IndexOf(<span class="keyword">this</span>, <span class="keyword">value</span>, startIndex, count, CompareOptions.None);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> StringComparison.CurrentCultureIgnoreCase:</span><br><span class="line">            <span class="keyword">return</span> CultureInfo.CurrentCulture.CompareInfo.IndexOf(<span class="keyword">this</span>, <span class="keyword">value</span>, startIndex, count, CompareOptions.IgnoreCase);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> StringComparison.InvariantCulture:</span><br><span class="line">            <span class="keyword">return</span> CultureInfo.InvariantCulture.CompareInfo.IndexOf(<span class="keyword">this</span>, <span class="keyword">value</span>, startIndex, count, CompareOptions.None);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> StringComparison.InvariantCultureIgnoreCase:</span><br><span class="line">            <span class="keyword">return</span> CultureInfo.InvariantCulture.CompareInfo.IndexOf(<span class="keyword">this</span>, <span class="keyword">value</span>, startIndex, count, CompareOptions.IgnoreCase);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> StringComparison.Ordinal:</span><br><span class="line">            <span class="keyword">return</span> CultureInfo.InvariantCulture.CompareInfo.IndexOf(<span class="keyword">this</span>, <span class="keyword">value</span>, startIndex, count, CompareOptions.Ordinal);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> StringComparison.OrdinalIgnoreCase:</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">value</span>.IsAscii() &amp;&amp; <span class="keyword">this</span>.IsAscii())</span><br><span class="line">                <span class="keyword">return</span> CultureInfo.InvariantCulture.CompareInfo.IndexOf(<span class="keyword">this</span>, <span class="keyword">value</span>, startIndex, count, CompareOptions.IgnoreCase);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">return</span> TextInfo.IndexOfStringOrdinalIgnoreCase(<span class="keyword">this</span>, <span class="keyword">value</span>, startIndex, count);</span><br><span class="line"></span><br><span class="line">        <span class="literal">default</span>:</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(Environment.GetResourceString(<span class="string">&quot;NotSupported_StringComparison&quot;</span>), <span class="string">&quot;comparisonType&quot;</span>);</span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面继续跟着源码来到 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL21pY3Jvc29mdC9yZWZlcmVuY2Vzb3VyY2UvYmxvYi9tYXN0ZXIvbXNjb3JsaWIvc3lzdGVtL2dsb2JhbGl6YXRpb24vY29tcGFyZWluZm8uY3MjTDY5OA==">CompareInfo<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">unsafe</span> <span class="keyword">virtual</span> <span class="built_in">int</span> <span class="title">IndexOf</span>(<span class="params">String source, <span class="built_in">char</span> <span class="keyword">value</span>, CompareOptions options</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (source==<span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="string">&quot;source&quot;</span>);</span><br><span class="line">    Contract.EndContractBlock();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> IndexOf(source, <span class="keyword">value</span>, <span class="number">0</span>, source.Length, options);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[<span class="meta">System.Security.SecuritySafeCritical</span>]  <span class="comment">// auto-generated</span></span><br><span class="line">[<span class="meta">ResourceExposure(ResourceScope.None)</span>]</span><br><span class="line">[<span class="meta">ResourceConsumption(ResourceScope.Process, ResourceScope.Process)</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">unsafe</span> <span class="keyword">virtual</span> <span class="built_in">int</span> <span class="title">IndexOf</span>(<span class="params">String source, <span class="built_in">char</span> <span class="keyword">value</span>, <span class="built_in">int</span> startIndex, <span class="built_in">int</span> count, CompareOptions options</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Validate inputs</span></span><br><span class="line">    <span class="keyword">if</span> (source == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="string">&quot;source&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (startIndex &lt; <span class="number">0</span> || startIndex &gt; source.Length)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentOutOfRangeException(<span class="string">&quot;startIndex&quot;</span>, Environment.GetResourceString(<span class="string">&quot;ArgumentOutOfRange_Index&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (count &lt; <span class="number">0</span> || startIndex &gt; source.Length - count)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentOutOfRangeException(<span class="string">&quot;count&quot;</span>, Environment.GetResourceString(<span class="string">&quot;ArgumentOutOfRange_Count&quot;</span>));</span><br><span class="line">    Contract.EndContractBlock();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (options == CompareOptions.OrdinalIgnoreCase)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// </span></span><br><span class="line">        <span class="keyword">return</span> source.IndexOf(<span class="keyword">value</span>.ToString(), startIndex, count, StringComparison.OrdinalIgnoreCase);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Validate CompareOptions</span></span><br><span class="line">    <span class="comment">// Ordinal can&#x27;t be selected with other flags</span></span><br><span class="line">    <span class="keyword">if</span> ((options &amp; ValidIndexMaskOffFlags) != <span class="number">0</span> &amp;&amp; (options != CompareOptions.Ordinal))</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(Environment.GetResourceString(<span class="string">&quot;Argument_InvalidFlag&quot;</span>), <span class="string">&quot;options&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// to let the sorting DLL do the call optimization in case of Ascii strings, we check if the strings are in Ascii and then send the flag RESERVED_FIND_ASCII_STRING  to </span></span><br><span class="line">    <span class="comment">// the sorting DLL API SortFindString so sorting DLL don&#x27;t have to check if the string is Ascii with every call to SortFindString.</span></span><br><span class="line">    <span class="keyword">return</span> InternalFindNLSStringEx(</span><br><span class="line">                m_dataHandle, m_handleOrigin, m_sortName, </span><br><span class="line">                GetNativeCompareFlags(options) | Win32Native.FIND_FROMSTART | ((source.IsAscii() &amp;&amp; (<span class="keyword">value</span> &lt;= <span class="string">&#x27;\x007f&#x27;</span>)) ? RESERVED_FIND_ASCII_STRING : <span class="number">0</span>),</span><br><span class="line">                source, count, startIndex, <span class="keyword">new</span> String(<span class="keyword">value</span>, <span class="number">1</span>), <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// InternalFindNLSStringEx parameters is not exactly matching kernel32::FindNLSStringEx parameters.</span></span><br><span class="line"><span class="comment">// Call through to NewApis::FindNLSStringEx so we can get the right behavior</span></span><br><span class="line">[<span class="meta">System.Security.SecurityCritical</span>]  <span class="comment">// auto-generated</span></span><br><span class="line">[<span class="meta">ResourceExposure(ResourceScope.None)</span>]</span><br><span class="line">[<span class="meta">DllImport(JitHelpers.QCall, CharSet = CharSet.Unicode)</span>]</span><br><span class="line">[<span class="meta">SuppressUnmanagedCodeSecurity</span>]</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="built_in">int</span> <span class="title">InternalFindNLSStringEx</span>(<span class="params">IntPtr handle, IntPtr handleOrigin, String localeName, <span class="built_in">int</span> flags, String source, <span class="built_in">int</span> sourceCount, <span class="built_in">int</span> startIndex, <span class="built_in">string</span> target, <span class="built_in">int</span> targetCount</span>)</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以看到，最终是调用了  <a href="https://docs.microsoft.com/en-us/windows/win32/api/winnls/nf-winnls-findnlsstringex"><code>InternalFindNLSStringEx</code></a>。</p>
<p>不同的选项被转换成了不同的 flag</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">Pure</span>]</span><br><span class="line"><span class="function"><span class="keyword">internal</span> <span class="keyword">static</span> <span class="built_in">int</span> <span class="title">GetNativeCompareFlags</span>(<span class="params">CompareOptions options</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// some NLS VM functions can handle COMPARE_OPTIONS_ORDINAL</span></span><br><span class="line">    <span class="comment">// in which case options should be simply cast to int instead of using this function</span></span><br><span class="line">    <span class="comment">// Does not look like the best approach to me but for now I am going to leave it as it is</span></span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    Contract.Assert(options != CompareOptions.OrdinalIgnoreCase, <span class="string">&quot;[CompareInfo.GetNativeCompareFlags]CompareOptions.OrdinalIgnoreCase should be handled separately&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Use &quot;linguistic casing&quot; by default (load the culture&#x27;s casing exception tables)</span></span><br><span class="line">    <span class="built_in">int</span> nativeCompareFlags = NORM_LINGUISTIC_CASING;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((options &amp; CompareOptions.IgnoreCase)       != <span class="number">0</span>) &#123; nativeCompareFlags |= NORM_IGNORECASE;        &#125;</span><br><span class="line">    <span class="keyword">if</span> ((options &amp; CompareOptions.IgnoreKanaType)   != <span class="number">0</span>) &#123; nativeCompareFlags |= NORM_IGNOREKANATYPE;    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((options &amp; CompareOptions.IgnoreNonSpace)   != <span class="number">0</span>) &#123; nativeCompareFlags |= NORM_IGNORENONSPACE;    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((options &amp; CompareOptions.IgnoreSymbols)    != <span class="number">0</span>) &#123; nativeCompareFlags |= NORM_IGNORESYMBOLS;     &#125;</span><br><span class="line">    <span class="keyword">if</span> ((options &amp; CompareOptions.IgnoreWidth)      != <span class="number">0</span>) &#123; nativeCompareFlags |= NORM_IGNOREWIDTH;       &#125;</span><br><span class="line">    <span class="keyword">if</span> ((options &amp; CompareOptions.StringSort)       != <span class="number">0</span>) &#123; nativeCompareFlags |= SORT_STRINGSORT;        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Suffix &amp; Prefix shouldn&#x27;t use this, make sure to turn off the NORM_LINGUISTIC_CASING flag</span></span><br><span class="line">    <span class="keyword">if</span> (options == CompareOptions.Ordinal)                &#123; nativeCompareFlags = COMPARE_OPTIONS_ORDINAL; &#125;</span><br><span class="line"></span><br><span class="line">    Contract.Assert(((options &amp; ~(CompareOptions.IgnoreCase |</span><br><span class="line">                                  CompareOptions.IgnoreKanaType |</span><br><span class="line">                                  CompareOptions.IgnoreNonSpace |</span><br><span class="line">                                  CompareOptions.IgnoreSymbols |</span><br><span class="line">                                  CompareOptions.IgnoreWidth |</span><br><span class="line">                                  CompareOptions.StringSort)) == <span class="number">0</span>) ||</span><br><span class="line">                     (options == CompareOptions.Ordinal), <span class="string">&quot;[CompareInfo.GetNativeCompareFlags]Expected all flags to be handled&quot;</span>);</span><br><span class="line"></span><br><span class="line">    Contract.Assert((nativeCompareFlags &amp; RESERVED_FIND_ASCII_STRING) == <span class="number">0</span>, <span class="string">&quot;[CompareInfo.GetNativeCompareFlags] RESERVED_FIND_ASCII_STRING shouldn&#x27;t be set here&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> nativeCompareFlags;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以看到继续前进涉及到了 CLR 层的 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2cxNWVjYi9zaGFyZWQtc291cmNlLWNsaS0yLjAvYmxvYi9tYXN0ZXIvY2xyL3NyYy9jbGFzc2xpYm5hdGl2ZS9ubHMvY29tbmxzaW5mby5jcHAjMTg5Mw==">comnlsinfo<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  Search for the character in the string.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line">Buffer1 = pString1-&gt;<span class="built_in">GetBuffer</span>();</span><br><span class="line">Buffer2 = pString2-&gt;<span class="built_in">GetBuffer</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (dwFlags == COMPARE_OPTIONS_ORDINAL)</span><br><span class="line">&#123;</span><br><span class="line">    iRetVal = <span class="built_in">FastIndexOfString</span>(Buffer1, StartIndex, EndIndex, Buffer2, StringLength2);</span><br><span class="line">    <span class="keyword">goto</span> lExit;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>其中  COMPARE_OPTIONS_ORDINAL 涉及到的是 FastIndexOfString</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">INT32 COMNlsInfo::FastIndexOfString(__in WCHAR *source, INT32 startIndex, INT32 endIndex, __in_ecount(patternLength) WCHAR *pattern, INT32 patternLength)</span><br><span class="line">&#123;</span><br><span class="line">    CONTRACTL &#123;</span><br><span class="line">        NOTHROW;</span><br><span class="line">        GC_NOTRIGGER;</span><br><span class="line">        MODE_COOPERATIVE;</span><br><span class="line">        SO_TOLERANT;</span><br><span class="line">        PRECONDITION(CheckPointer(source));</span><br><span class="line">        PRECONDITION(CheckPointer(pattern));</span><br><span class="line">        PRECONDITION(startIndex &gt;= <span class="number">0</span>);</span><br><span class="line">        PRECONDITION(endIndex &gt;= <span class="number">0</span>);</span><br><span class="line">        PRECONDITION(patternLength&gt;= <span class="number">0</span>);</span><br><span class="line">    &#125; CONTRACTL_END</span><br><span class="line"></span><br><span class="line">    <span class="built_in">int</span> endPattern = endIndex - patternLength + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (endPattern&lt;<span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (patternLength &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> startIndex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    WCHAR patternChar0 = pattern[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> ctrSrc = startIndex; ctrSrc&lt;=endPattern; ctrSrc++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (source[ctrSrc] != patternChar0)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        <span class="built_in">int</span> ctrPat;</span><br><span class="line">        <span class="keyword">for</span> (ctrPat = <span class="number">1</span>; (ctrPat &lt; patternLength) &amp;&amp; (source[ctrSrc + ctrPat] == pattern[ctrPat]); ctrPat++) &#123;</span><br><span class="line">            ;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (ctrPat == patternLength) &#123;</span><br><span class="line">            <span class="keyword">return</span> (ctrSrc);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其余的则是 IndexOfString</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">FCIMPL7(INT32, COMNlsInfo::IndexOfString,</span><br><span class="line">                    INT_PTR pNativeCompareInfo,</span><br><span class="line">                    INT32 LCID,</span><br><span class="line">                    StringObject* pString1UNSAFE,   <span class="comment">// String to search in</span></span><br><span class="line">                    StringObject* pString2UNSAFE,   <span class="comment">// String we&#x27;re looking for</span></span><br><span class="line">                    INT32 StartIndex,               <span class="comment">// Index to start at in search string</span></span><br><span class="line">                    INT32 Count,                    <span class="comment">// # of chars to search</span></span><br><span class="line">                    INT32 dwFlags)</span><br><span class="line">&#123;</span><br><span class="line">    CONTRACTL</span><br><span class="line">    &#123;</span><br><span class="line">        THROWS;</span><br><span class="line">        DISABLED(GC_TRIGGERS);</span><br><span class="line">        MODE_ANY;</span><br><span class="line">        SO_TOLERANT;</span><br><span class="line">        PRECONDITION(CheckPointer((LPVOID)pNativeCompareInfo));</span><br><span class="line">        PRECONDITION(CheckPointer(pString1UNSAFE));</span><br><span class="line">        PRECONDITION(CheckPointer(pString2UNSAFE));</span><br><span class="line">    &#125; CONTRACTL_END;</span><br><span class="line"></span><br><span class="line">    INT32       iRetVal = <span class="number">-1</span>;</span><br><span class="line">    STRINGREF   pString1 = (STRINGREF) pString1UNSAFE;</span><br><span class="line">    STRINGREF   pString2 = (STRINGREF) pString2UNSAFE;</span><br><span class="line"></span><br><span class="line">    HELPER_METHOD_FRAME_BEGIN_RET_2(pString1, pString2);</span><br><span class="line"></span><br><span class="line">    WCHAR *Buffer1 = NULL;</span><br><span class="line">    WCHAR *Buffer2 = NULL;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  Get the arguments.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="built_in">int</span> StringLength1;</span><br><span class="line">    <span class="built_in">int</span> StringLength2;</span><br><span class="line">    StringLength1 = pString1-&gt;GetStringLength();</span><br><span class="line">    StringLength2 = pString2-&gt;GetStringLength();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  Get the arguments.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    _ASSERTE(StartIndex &gt;= <span class="number">0</span> &amp;&amp; StartIndex &lt;= StringLength1);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">int</span> EndIndex = StartIndex - <span class="number">1</span> + Count;</span><br><span class="line"></span><br><span class="line">    _ASSERTE(Count &gt;= <span class="number">0</span> &amp;&amp; EndIndex &lt; StringLength1);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  Check the ranges.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">if</span> (StringLength1 == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (StringLength2 == <span class="number">0</span>)</span><br><span class="line">            iRetVal = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// else iRetVal = -1 (not found)</span></span><br><span class="line">        <span class="keyword">goto</span> lExit;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  See if we have an empty string 2.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">if</span> (StringLength2 == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        iRetVal = StartIndex;</span><br><span class="line">        <span class="keyword">goto</span> lExit;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//  Search for the character in the string.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    Buffer1 = pString1-&gt;GetBuffer();</span><br><span class="line">    Buffer2 = pString2-&gt;GetBuffer();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (dwFlags == COMPARE_OPTIONS_ORDINAL)</span><br><span class="line">    &#123;</span><br><span class="line">        iRetVal = FastIndexOfString(Buffer1, StartIndex, EndIndex, Buffer2, StringLength2);</span><br><span class="line">        <span class="keyword">goto</span> lExit;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//For dwFlags, 0 is the default, 1 is ignore case, we can handle both.</span></span><br><span class="line">    <span class="keyword">if</span> (dwFlags&lt;=<span class="number">1</span> &amp;&amp; IS_FAST_COMPARE_LOCALE(LCID))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//If we&#x27;ve never before looked at whether this string has high chars, do so now.</span></span><br><span class="line">        <span class="keyword">if</span> (IS_STRING_STATE_UNDETERMINED(pString1-&gt;GetHighCharState()))</span><br><span class="line">        &#123;</span><br><span class="line">            COMString::InternalCheckHighChars(pString1);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//If we&#x27;ve never before looked at whether this string has high chars, do so now.</span></span><br><span class="line">        <span class="keyword">if</span> (IS_STRING_STATE_UNDETERMINED(pString2-&gt;GetHighCharState()))</span><br><span class="line">        &#123;</span><br><span class="line">            COMString::InternalCheckHighChars(pString2);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//If neither string has high chars, we can use a much faster comparison algorithm.</span></span><br><span class="line">        <span class="keyword">if</span> (IS_FAST_INDEX(pString1-&gt;GetHighCharState()) &amp;&amp; IS_FAST_INDEX(pString2-&gt;GetHighCharState()))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (dwFlags==<span class="number">0</span>)</span><br><span class="line">                iRetVal = FastIndexOfString(Buffer1, StartIndex, EndIndex, Buffer2, StringLength2);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                iRetVal = FastIndexOfStringInsensitive(Buffer1, StartIndex, EndIndex, Buffer2, StringLength2);</span><br><span class="line">            <span class="keyword">goto</span> lExit;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    iRetVal = ((NativeCompareInfo*)(pNativeCompareInfo))-&gt;IndexOfString(</span><br><span class="line">        Buffer1, Buffer2, StartIndex, EndIndex, StringLength2, dwFlags, FALSE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We checked flags in managed code, so this shouldn&#x27;t happen.</span></span><br><span class="line">    _ASSERTE(iRetVal != INDEXOF_INVALID_FLAGS);</span><br><span class="line"><span class="comment">//    if (iRetVal == INDEXOF_INVALID_FLAGS) &#123;</span></span><br><span class="line"><span class="comment">//        COMPlusThrowArgumentException(L&quot;flags&quot;, L&quot;Argument_InvalidFlag&quot;);</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"></span><br><span class="line">lExit: ;</span><br><span class="line">    HELPER_METHOD_FRAME_END();</span><br><span class="line">    <span class="keyword">return</span> iRetVal;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="function">FCIMPLEND</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">FCIMPL5</span>(<span class="params">INT32, COMNlsInfo::IndexOfStringOrdinalIgnoreCase,</span></span></span><br><span class="line"><span class="params"><span class="function">                    INT_PTR     ptr,</span></span></span><br><span class="line"><span class="params"><span class="function">                    StringObject* pString1UNSAFE,   // String to search <span class="keyword">in</span></span></span></span><br><span class="line"><span class="params"><span class="function">                    StringObject* pString2UNSAFE,   // String we<span class="string">&#x27;re looking for</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">                    INT32 StartIndex,               // Index to start at in search string</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">                    INT32 Count)                    // # of chars to search</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">&#123;</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">    CONTRACTL</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">    &#123;</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">        THROWS;</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">        DISABLED(GC_TRIGGERS);</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">        MODE_ANY;</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">        SO_TOLERANT;</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">        PRECONDITION(ptr != NULL);</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">        PRECONDITION(CheckPointer(pString1UNSAFE));</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">        PRECONDITION(CheckPointer(pString2UNSAFE));</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">    &#125; CONTRACTL_END;</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function"></span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">    INT32       iRetVal = -1;</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">    STRINGREF   pString1 = (STRINGREF) pString1UNSAFE;</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">    STRINGREF   pString2 = (STRINGREF) pString2UNSAFE;</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function"></span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">    HELPER_METHOD_FRAME_BEGIN_RET_2(pString1, pString2);</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function"></span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">    WCHAR *Buffer1 = NULL;</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">    WCHAR *Buffer2 = NULL;</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function"></span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">    //</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">    //  Get the arguments.</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">    //</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">    int StringLength1;</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">    int StringLength2;</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">    StringLength1 = pString1-&gt;GetStringLength();</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">    StringLength2 = pString2-&gt;GetStringLength();</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function"></span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">    //</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">    //  Get the arguments.</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">    //</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">    _ASSERTE(StartIndex &gt;= 0 &amp;&amp; StartIndex &lt;= StringLength1);</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function"></span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">    int EndIndex = StartIndex - 1 + Count;</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function"></span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">    _ASSERTE(Count &gt;= 0 &amp;&amp; EndIndex &lt; StringLength1);</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function"></span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">    //</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">    //  Check the ranges.</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">    //</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">    if (StringLength1 == 0)</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">    &#123;</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">        if (StringLength2 == 0)</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">            iRetVal = 0;</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">        // else iRetVal = -1 (not found)</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">        goto lExit;</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">    &#125;</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function"></span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">    //</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">    //  See if we have an empty string 2.</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">    //</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">    if (StringLength2 == 0)</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">    &#123;</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">        iRetVal = StartIndex;</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">        goto lExit;</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">    &#125;</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function"></span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">    //</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">    //  Search for the character in the string.</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">    //</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">    Buffer1 = pString1-&gt;GetBuffer();</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">    Buffer2 = pString2-&gt;GetBuffer();</span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function"></span></span></span></span><br><span class="line"><span class="string"><span class="params"><span class="function">    //If we&#x27;</span>ve never before looked at whether <span class="keyword">this</span> <span class="built_in">string</span> has high chars, <span class="keyword">do</span> so now.</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">if</span> (IS_STRING_STATE_UNDETERMINED(pString1-&gt;GetHighCharState(</span>)))</span></span><br><span class="line">    &#123;</span><br><span class="line">        COMString::InternalCheckHighChars(pString1);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//If we&#x27;ve never before looked at whether this string has high chars, do so now.</span></span><br><span class="line">    <span class="keyword">if</span> (IS_STRING_STATE_UNDETERMINED(pString2-&gt;GetHighCharState()))</span><br><span class="line">    &#123;</span><br><span class="line">        COMString::InternalCheckHighChars(pString2);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//If neither string has high chars, we can use a much faster comparison algorithm.</span></span><br><span class="line">    <span class="keyword">if</span> (IS_FAST_INDEX(pString1-&gt;GetHighCharState()) &amp;&amp; IS_FAST_INDEX(pString2-&gt;GetHighCharState())) &#123;</span><br><span class="line">        iRetVal = FastIndexOfStringInsensitive(Buffer1, StartIndex, EndIndex, Buffer2, StringLength2);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        NativeTextInfo* pNativeTextInfo = (NativeTextInfo*)ptr;</span><br><span class="line">        iRetVal = pNativeTextInfo-&gt;IndexOfStringOrdinalIgnoreCase(Buffer1, StartIndex, EndIndex, Buffer2, StringLength2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">lExit: ;</span><br><span class="line">    HELPER_METHOD_FRAME_END();</span><br><span class="line">    <span class="keyword">return</span> iRetVal;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Span-lt-Char-gt-IndexOf"><a href="#Span-lt-Char-gt-IndexOf" class="headerlink" title="Span&lt;Char&gt;.IndexOf"></a><code>Span&lt;Char&gt;.IndexOf</code></h3><p><a href="https://docs.microsoft.com/en-us/dotnet/api/system.span-1?view=net-6.0"><code>System.Span&lt;T&gt;</code></a> 是在 .NET 中发挥关键作用的新值类型。使用它，可以表示任意内存的相邻区域，无论相应内存是与托管对象相关联，还是通过互操作由本机代码提供，亦或是位于堆栈上。除了具有上述用途外，它仍能确保安全访问和高性能特性，就像数组一样。<br>官方在 System.Memory.dll 中提供了 <span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vZW4tdXMvZG90bmV0L2FwaS9zeXN0ZW0ubWVtb3J5ZXh0ZW5zaW9ucy5pbmRleG9mP3ZpZXc9bmV0LTYuMA==">MemoryExtensions.IndexOf<i class="fa fa-external-link-alt"></i></span> 方法，同样可以用于字符串的查找。</p>
<p>简单看一下源码<br><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2RvdG5ldC9jb3JlcnQvYmxvYi9tYXN0ZXIvc3JjL1N5c3RlbS5Qcml2YXRlLkNvcmVMaWIvc2hhcmVkL1N5c3RlbS9NZW1vcnlFeHRlbnNpb25zLkdsb2JhbGl6YXRpb24uY3MjTDEyMQ==">MemoryExtensions.Globalization.cs<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Reports the zero-based index of the first occurrence of the specified <span class="doctag">&lt;paramref name=&quot;value&quot;/&gt;</span> in the current <span class="doctag">&lt;paramref name=&quot;span&quot;/&gt;</span>.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;span&quot;&gt;</span>The source span.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;value&quot;&gt;</span>The value to seek within the source span.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;comparisonType&quot;&gt;</span>One of the enumeration values that determines how the <span class="doctag">&lt;paramref name=&quot;span&quot;/&gt;</span> and <span class="doctag">&lt;paramref name=&quot;value&quot;/&gt;</span> are compared.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">int</span> <span class="title">IndexOf</span>(<span class="params"><span class="keyword">this</span> ReadOnlySpan&lt;<span class="built_in">char</span>&gt; span, ReadOnlySpan&lt;<span class="built_in">char</span>&gt; <span class="keyword">value</span>, StringComparison comparisonType</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">string</span>.CheckStringComparison(comparisonType);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (comparisonType == StringComparison.Ordinal)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> SpanHelpers.IndexOf(</span><br><span class="line">            <span class="keyword">ref</span> MemoryMarshal.GetReference(span),</span><br><span class="line">            span.Length,</span><br><span class="line">            <span class="keyword">ref</span> MemoryMarshal.GetReference(<span class="keyword">value</span>),</span><br><span class="line">            <span class="keyword">value</span>.Length);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (comparisonType)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> StringComparison.CurrentCulture:</span><br><span class="line">        <span class="keyword">case</span> StringComparison.CurrentCultureIgnoreCase:</span><br><span class="line">            <span class="keyword">return</span> CultureInfo.CurrentCulture.CompareInfo.IndexOf(span, <span class="keyword">value</span>, <span class="built_in">string</span>.GetCaseCompareOfComparisonCulture(comparisonType));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> StringComparison.InvariantCulture:</span><br><span class="line">        <span class="keyword">case</span> StringComparison.InvariantCultureIgnoreCase:</span><br><span class="line">            <span class="keyword">return</span> CompareInfo.Invariant.IndexOf(span, <span class="keyword">value</span>, <span class="built_in">string</span>.GetCaseCompareOfComparisonCulture(comparisonType));</span><br><span class="line"></span><br><span class="line">        <span class="literal">default</span>:</span><br><span class="line">            Debug.Assert(comparisonType == StringComparison.OrdinalIgnoreCase);</span><br><span class="line">            <span class="keyword">return</span> CompareInfo.IndexOfOrdinalIgnoreCase(span, <span class="keyword">value</span>, fromBeginning: <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，只有 StringComparison.Ordinal 下，调用了 SpanHelpers.IndexOf 方法，其余参数下依旧采用了和 string.IndexOf 一致的 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL21pY3Jvc29mdC9yZWZlcmVuY2Vzb3VyY2UvYmxvYi9tYXN0ZXIvbXNjb3JsaWIvc3lzdGVtL2dsb2JhbGl6YXRpb24vY29tcGFyZWluZm8uY3MjTDY5OA==">CompareInfo<i class="fa fa-external-link-alt"></i></span> 处理。<br><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2RvdG5ldC9jb3JlcnQvYmxvYi9tYXN0ZXIvc3JjL1N5c3RlbS5Qcml2YXRlLkNvcmVMaWIvc2hhcmVkL1N5c3RlbS9TcGFuSGVscGVycy5CeXRlLmNzI0wyNQ==">SpanHelpers.IndexOf<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">int</span> <span class="title">IndexOf</span>(<span class="params"><span class="keyword">ref</span> <span class="built_in">byte</span> searchSpace, <span class="built_in">int</span> searchSpaceLength, <span class="keyword">ref</span> <span class="built_in">byte</span> <span class="keyword">value</span>, <span class="built_in">int</span> valueLength</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    Debug.Assert(searchSpaceLength &gt;= <span class="number">0</span>);</span><br><span class="line">    Debug.Assert(valueLength &gt;= <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (valueLength == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;  <span class="comment">// A zero-length sequence is always treated as &quot;found&quot; at the start of the search space.</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">byte</span> valueHead = <span class="keyword">value</span>;</span><br><span class="line">    <span class="keyword">ref</span> <span class="built_in">byte</span> valueTail = <span class="keyword">ref</span> Unsafe.Add(<span class="keyword">ref</span> <span class="keyword">value</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">int</span> valueTailLength = valueLength - <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">int</span> remainingSearchSpaceLength = searchSpaceLength - valueTailLength;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">int</span> offset = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (remainingSearchSpaceLength &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Do a quick search for the first element of &quot;value&quot;.</span></span><br><span class="line">        <span class="built_in">int</span> relativeIndex = IndexOf(<span class="keyword">ref</span> Unsafe.Add(<span class="keyword">ref</span> searchSpace, offset), valueHead, remainingSearchSpaceLength);</span><br><span class="line">        <span class="keyword">if</span> (relativeIndex == <span class="number">-1</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        remainingSearchSpaceLength -= relativeIndex;</span><br><span class="line">        offset += relativeIndex;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (remainingSearchSpaceLength &lt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;  <span class="comment">// The unsearched portion is now shorter than the sequence we&#x27;re looking for. So it can&#x27;t be there.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Found the first element of &quot;value&quot;. See if the tail matches.</span></span><br><span class="line">        <span class="keyword">if</span> (SequenceEqual(<span class="keyword">ref</span> Unsafe.Add(<span class="keyword">ref</span> searchSpace, offset + <span class="number">1</span>), <span class="keyword">ref</span> valueTail, (<span class="built_in">nuint</span>)valueTailLength))  <span class="comment">// The (nunit)-cast is necessary to pick the correct overload</span></span><br><span class="line">            <span class="keyword">return</span> offset;  <span class="comment">// The tail matched. Return a successful find.</span></span><br><span class="line"></span><br><span class="line">        remainingSearchSpaceLength--;</span><br><span class="line">        offset++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Boyer-Moore"><a href="#Boyer-Moore" class="headerlink" title="Boyer Moore"></a>Boyer Moore</h3><p>截图来自<span class="exturl" data-url="aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvJUU1JThEJTlBJUU4JTgwJUI2LSVFNyVBOSU4NiVFNSVCMCU5NCVFNSVBRCU5NyVFNyVBQyVBNiVFNCVCOCVCMiVFNiU5MCU5QyVFNyVCNCVBMiVFNyVBRSU5NyVFNiVCMyU5NQ==">维基百科词条：博耶-穆尔字符串搜索算法<i class="fa fa-external-link-alt"></i></span><br><img data-src="https://qiniucdn.wayneshao.com/%E5%85%B3%E4%BA%8E%E5%87%A0%E7%A7%8D%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%9F%A5%E6%89%BE%E7%AE%97%E6%B3%95%E7%9A%84%E5%AF%B9%E6%AF%94%E5%88%86%E6%9E%90/20210902091553102.png"><br><img data-src="https://qiniucdn.wayneshao.com/%E5%85%B3%E4%BA%8E%E5%87%A0%E7%A7%8D%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%9F%A5%E6%89%BE%E7%AE%97%E6%B3%95%E7%9A%84%E5%AF%B9%E6%AF%94%E5%88%86%E6%9E%90/20210902091503549.png"></p>
<p>这里直接上 C# 版本源码实现</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">int</span> <span class="title">BoyerMooreIndexOf</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">string</span> source, <span class="built_in">string</span> pattern, <span class="built_in">int</span> offset = <span class="number">0</span>, <span class="built_in">int</span> count = <span class="number">-1</span></span>)</span> =&gt; BoyerMooreIndexOf(Encoding.UTF8.GetBytes(source), Encoding.UTF8.GetBytes(pattern), offset, count);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">int</span> <span class="title">BoyerMooreIndexOf</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">byte</span>[] source, <span class="built_in">byte</span>[] pattern, <span class="built_in">int</span> offset = <span class="number">0</span>, <span class="built_in">int</span> count = <span class="number">-1</span></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (source == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(source));</span><br><span class="line">    <span class="keyword">if</span> (pattern == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(pattern));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> total = source.Length;</span><br><span class="line">    <span class="keyword">var</span> length = pattern.Length;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (count &gt; <span class="number">0</span> &amp;&amp; total &gt; offset + count) total = offset + count;</span><br><span class="line">    <span class="keyword">if</span> (total == <span class="number">0</span> || length == <span class="number">0</span> || length &gt; total) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化坏字符，即不匹配字符</span></span><br><span class="line">    <span class="keyword">var</span> bads = <span class="keyword">new</span> <span class="built_in">int</span>[<span class="number">256</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">256</span>; i++)</span><br><span class="line">        bads[i] = length;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> last = length - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; last; i++)</span><br><span class="line">        bads[pattern[i]] = last - i;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> index = offset;</span><br><span class="line">    <span class="keyword">while</span> (index &lt;= total - length)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 尾部开始比较</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = last; source[index + i] == pattern[i]; i--)</span><br><span class="line">            <span class="keyword">if</span> (i == <span class="number">0</span>) <span class="keyword">return</span> index;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 坏字符规则：后移位数 = 坏字符的位置 - 搜索词中的上一次出现位置</span></span><br><span class="line">        index += bads[source[index + last]];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="KMP"><a href="#KMP" class="headerlink" title="KMP"></a>KMP</h3><p>截图来自<span class="exturl" data-url="aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvS01QJUU3JUFFJTk3JUU2JUIzJTk1">维基百科词条：KMP算法<i class="fa fa-external-link-alt"></i></span><br><img data-src="https://qiniucdn.wayneshao.com/%E5%85%B3%E4%BA%8E%E5%87%A0%E7%A7%8D%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%9F%A5%E6%89%BE%E7%AE%97%E6%B3%95%E7%9A%84%E5%AF%B9%E6%AF%94%E5%88%86%E6%9E%90/20210902091903197.png"><br>同样直接上源码:</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">int</span> <span class="title">KMPSearch</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">string</span> text, <span class="built_in">string</span> pattern</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> n = text.Length;</span><br><span class="line">    <span class="keyword">var</span> m = pattern.Length;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (n &lt; m) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span> (n == m &amp;&amp; text == pattern) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (m == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> lpsArray = <span class="keyword">new</span> <span class="built_in">int</span>[m];</span><br><span class="line"></span><br><span class="line">    LongestPrefixSuffix(pattern, <span class="keyword">ref</span> lpsArray);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (i &lt; n)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (text[i] == pattern[j])</span><br><span class="line">        &#123;</span><br><span class="line">            i++;</span><br><span class="line">            j++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (j == m)</span><br><span class="line">            <span class="keyword">return</span> i - j;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (i &gt;= n || text[i] == pattern[j]) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">if</span> (j != <span class="number">0</span>)</span><br><span class="line">            j = lpsArray[j - <span class="number">1</span>];</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            i++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">LongestPrefixSuffix</span>(<span class="params"><span class="built_in">string</span> pattern, <span class="keyword">ref</span> <span class="built_in">int</span>[] lpsArray</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> m = pattern.Length;</span><br><span class="line">    <span class="keyword">var</span> len = <span class="number">0</span>;</span><br><span class="line">    lpsArray[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">var</span> i = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (i &lt; m)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (pattern[i] == pattern[len])</span><br><span class="line">            lpsArray[i++] = ++len;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (len == <span class="number">0</span>)</span><br><span class="line">            lpsArray[i++] = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            len = lpsArray[len - <span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="算法性能横向测试"><a href="#算法性能横向测试" class="headerlink" title="算法性能横向测试"></a>算法性能横向测试</h2><p>本次横向对比了 IndexOf IndexOfOrdinal SpanIndexOf SpanIndexOfOrdinal BoyerMooreIndexOf KMPIndexOf，在查找样本长度 100, 10000, 1000000, 100000000 四种数据规模下，被查找字符串分别处于样本 开头、中间、结尾、随机位置 四种情况下的性能。</p>
<h3 id="测试完整源码"><a href="#测试完整源码" class="headerlink" title="测试完整源码"></a>测试完整源码</h3><p>Program.cs</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> BenchmarkDotNet.Attributes;</span><br><span class="line"><span class="keyword">using</span> BenchmarkDotNet.Running;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">BenchmarkSample</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">RPlotExporter</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">IndexOfTest</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">private</span> <span class="built_in">string</span> _haystack;</span><br><span class="line">            <span class="keyword">private</span> <span class="built_in">string</span> _needle = <span class="string">&quot;needle&quot;</span>;</span><br><span class="line"></span><br><span class="line">            [<span class="meta">Params(100, 10000, 1000000, 100000000)</span>]</span><br><span class="line">            <span class="keyword">public</span> <span class="built_in">int</span> HaystackSize &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">            [<span class="meta">Params(SubstringLocationEnum.Start, SubstringLocationEnum.Middle, SubstringLocationEnum.End,</span></span><br><span class="line"><span class="meta">                SubstringLocationEnum.Random)</span>]</span><br><span class="line">            <span class="keyword">public</span> SubstringLocationEnum Location &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="title">IndexOfTest</span>()</span></span><br><span class="line">            &#123;</span><br><span class="line">                _haystack = GetRandomString(HaystackSize, _needle, Location); ;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            [<span class="meta">Benchmark</span>]</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">IndexOf</span>()</span> =&gt; _haystack.IndexOf(_needle);</span><br><span class="line">            [<span class="meta">Benchmark</span>]</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">IndexOfOrdinal</span>()</span> =&gt; _haystack.IndexOf(_needle, StringComparison.Ordinal);</span><br><span class="line">            [<span class="meta">Benchmark</span>]</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">SpanIndexOf</span>()</span> =&gt; _haystack.AsSpan().IndexOf(_needle);</span><br><span class="line">            [<span class="meta">Benchmark</span>]</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">SpanIndexOfOrdinal</span>()</span> =&gt; _haystack.AsSpan().IndexOf(_needle, StringComparison.Ordinal);</span><br><span class="line">            [<span class="meta">Benchmark</span>]</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">BoyerMooreIndexOf</span>()</span> =&gt; _haystack.BoyerMooreIndexOf(_needle);</span><br><span class="line">            [<span class="meta">Benchmark</span>]</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">KMPIndexOf</span>()</span> =&gt; _haystack.KMPSearch(_needle);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">enum</span> SubstringLocationEnum</span><br><span class="line">        &#123;</span><br><span class="line">            Start = <span class="number">0</span>, Middle, End, Random</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 生成随机字符串并加入自定义串</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;length&quot;&gt;</span>目标字符串的长度<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;custom&quot;&gt;</span>要插入的自定义串<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;location&quot;&gt;</span>插入的位置 0：开头 1：中间 2：尾部 3：随机<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">GetRandomString</span>(<span class="params"><span class="built_in">int</span> length, <span class="built_in">string</span> custom, SubstringLocationEnum location = SubstringLocationEnum.Middle</span>)</span></span><br><span class="line">        =&gt; GetRandomString(length, <span class="literal">true</span>, <span class="literal">true</span>, <span class="literal">true</span>, <span class="literal">true</span>, <span class="literal">null</span>, custom, (<span class="built_in">int</span>)location);</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 生成随机字符串 </span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;length&quot;&gt;</span>目标字符串的长度<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;useNum&quot;&gt;</span>是否包含数字，1=包含，默认为包含<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;useLow&quot;&gt;</span>是否包含小写字母，1=包含，默认为包含<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;useUpp&quot;&gt;</span>是否包含大写字母，1=包含，默认为包含<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;useSpe&quot;&gt;</span>是否包含特殊字符，1=包含，默认为不包含<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;customChars&quot;&gt;</span>要包含的自定义字符，直接输入要包含的字符列表<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;custom&quot;&gt;</span>要插入的自定义串<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;location&quot;&gt;</span>插入的位置 0：开头 1：中间 2：尾部 3：随机<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>指定长度的随机字符串<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">GetRandomString</span>(<span class="params"><span class="built_in">int</span> length, <span class="built_in">bool</span> useNum = <span class="literal">true</span>, <span class="built_in">bool</span> useLow = <span class="literal">true</span>, <span class="built_in">bool</span> useUpp = <span class="literal">true</span>, <span class="built_in">bool</span> useSpe = <span class="literal">true</span>, <span class="built_in">string</span> customChars = <span class="literal">null</span>, <span class="built_in">string</span> custom = <span class="literal">null</span>, <span class="built_in">int</span> location = <span class="number">0</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> b = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">4</span>];</span><br><span class="line">            <span class="keyword">new</span> System.Security.Cryptography.RNGCryptoServiceProvider().GetBytes(b);</span><br><span class="line">            Random r = <span class="keyword">new</span>(BitConverter.ToInt32(b, <span class="number">0</span>));</span><br><span class="line">            <span class="keyword">var</span> charList = <span class="keyword">new</span> List&lt;<span class="built_in">char</span>&gt;();</span><br><span class="line">            <span class="keyword">var</span> sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            custom ??= <span class="built_in">string</span>.Empty;</span><br><span class="line">            charList.AddRange(custom);</span><br><span class="line">            <span class="keyword">if</span> (useNum) charList.AddRange(<span class="string">&quot;0123456789&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (useLow) charList.AddRange(<span class="string">&quot;abcdefghijklmnopqrstuvwxyz&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (useUpp) charList.AddRange(<span class="string">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (useSpe) charList.AddRange(<span class="string">&quot;!\&quot;#$%&amp;&#x27;()*+,-./:;&lt;=&gt;?@[\\]^_`&#123;|&#125;~&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> charArray = charList.ToArray();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; length; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                sb.Append(charArray[r.Next(<span class="number">0</span>, charArray.Length - <span class="number">1</span>)]);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> insertIndex = location <span class="keyword">switch</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="number">0</span> =&gt; <span class="number">0</span>,</span><br><span class="line">                <span class="number">1</span> =&gt; length / <span class="number">2</span>,</span><br><span class="line">                <span class="number">2</span> =&gt; length - <span class="number">1</span>,</span><br><span class="line">                <span class="number">3</span> =&gt; r.Next(<span class="number">0</span>, length),</span><br><span class="line">                _ =&gt; <span class="number">-1</span></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> sb.Insert(insertIndex, custom).ToString();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">int</span> <span class="title">BoyerMooreIndexOf</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">string</span> source, <span class="built_in">string</span> pattern, <span class="built_in">int</span> offset = <span class="number">0</span>, <span class="built_in">int</span> count = <span class="number">-1</span></span>)</span> =&gt; BoyerMooreIndexOf(Encoding.UTF8.GetBytes(source), Encoding.UTF8.GetBytes(pattern), offset, count);</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span>Boyer Moore 字符串搜索算法，比KMP更快，常用于IDE工具的查找<span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;source&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;pattern&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;offset&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;count&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">int</span> <span class="title">BoyerMooreIndexOf</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">byte</span>[] source, <span class="built_in">byte</span>[] pattern, <span class="built_in">int</span> offset = <span class="number">0</span>, <span class="built_in">int</span> count = <span class="number">-1</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (source == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(source));</span><br><span class="line">            <span class="keyword">if</span> (pattern == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(pattern));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> total = source.Length;</span><br><span class="line">            <span class="keyword">var</span> length = pattern.Length;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (count &gt; <span class="number">0</span> &amp;&amp; total &gt; offset + count) total = offset + count;</span><br><span class="line">            <span class="keyword">if</span> (total == <span class="number">0</span> || length == <span class="number">0</span> || length &gt; total) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 初始化坏字符，即不匹配字符</span></span><br><span class="line">            <span class="keyword">var</span> bads = <span class="keyword">new</span> <span class="built_in">int</span>[<span class="number">256</span>];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">256</span>; i++)</span><br><span class="line">                bads[i] = length;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> last = length - <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; last; i++)</span><br><span class="line">                bads[pattern[i]] = last - i;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> index = offset;</span><br><span class="line">            <span class="keyword">while</span> (index &lt;= total - length)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 尾部开始比较</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">var</span> i = last; source[index + i] == pattern[i]; i--)</span><br><span class="line">                    <span class="keyword">if</span> (i == <span class="number">0</span>) <span class="keyword">return</span> index;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="comment">// 坏字符规则：后移位数 = 坏字符的位置 - 搜索词中的上一次出现位置</span></span><br><span class="line">                index += bads[source[index + last]];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">int</span> <span class="title">KMPSearch</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">string</span> text, <span class="built_in">string</span> pattern</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> n = text.Length;</span><br><span class="line">            <span class="keyword">var</span> m = pattern.Length;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (n &lt; m) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            <span class="keyword">if</span> (n == m &amp;&amp; text == pattern) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (m == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> lpsArray = <span class="keyword">new</span> <span class="built_in">int</span>[m];</span><br><span class="line"></span><br><span class="line">            LongestPrefixSuffix(pattern, <span class="keyword">ref</span> lpsArray);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> (i &lt; n)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (text[i] == pattern[j])</span><br><span class="line">                &#123;</span><br><span class="line">                    i++;</span><br><span class="line">                    j++;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (j == m)</span><br><span class="line">                    <span class="keyword">return</span> i - j;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (i &gt;= n || text[i] == pattern[j]) <span class="keyword">continue</span>;</span><br><span class="line">                <span class="keyword">if</span> (j != <span class="number">0</span>)</span><br><span class="line">                    j = lpsArray[j - <span class="number">1</span>];</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    i++;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">LongestPrefixSuffix</span>(<span class="params"><span class="built_in">string</span> pattern, <span class="keyword">ref</span> <span class="built_in">int</span>[] lpsArray</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> m = pattern.Length;</span><br><span class="line">            <span class="keyword">var</span> len = <span class="number">0</span>;</span><br><span class="line">            lpsArray[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">var</span> i = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (i &lt; m)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (pattern[i] == pattern[len])</span><br><span class="line">                    lpsArray[i++] = ++len;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (len == <span class="number">0</span>)</span><br><span class="line">                    lpsArray[i++] = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    len = lpsArray[len - <span class="number">1</span>];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> summary = BenchmarkRunner.Run&lt;IndexOfTest&gt;();</span><br><span class="line">            Console.ReadLine();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="测试结果"><a href="#测试结果" class="headerlink" title="测试结果"></a>测试结果</h3><p>因为测试结果比较多，生成的图表一大堆，就不放了，直接放时间表。</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="attr">BenchmarkDotNet</span>=v0.<span class="number">13.1</span>, OS=Windows <span class="number">10.0</span>.<span class="number">22000</span></span><br><span class="line">AMD Ryzen 7 3700X, 1 CPU, 16 logical and 8 physical cores</span><br><span class="line">.NET <span class="attr">SDK</span>=<span class="number">6.0</span>.<span class="number">100</span>-preview.<span class="number">4.21255</span>.<span class="number">9</span></span><br><span class="line">  <span class="section">[Host]</span>     : .NET 6.0.0 (6.0.21.25307), X64 RyuJIT</span><br><span class="line">  DefaultJob : .NET 6.0.0 (6.0.21.25307), X64 RyuJIT</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>Method</th>
<th>HaystackSize</th>
<th>Location</th>
<th align="right">Mean</th>
<th align="right">Error</th>
<th align="right">StdDev</th>
<th align="right">Median</th>
</tr>
</thead>
<tbody><tr>
<td><strong>IndexOf</strong></td>
<td><strong>100</strong></td>
<td><strong>Start</strong></td>
<td align="right"><strong>1,907.369 ns</strong></td>
<td align="right"><strong>10.5384 ns</strong></td>
<td align="right"><strong>9.8576 ns</strong></td>
<td align="right"><strong>1,909.585 ns</strong></td>
</tr>
<tr>
<td>IndexOfOrdinal</td>
<td>100</td>
<td>Start</td>
<td align="right">10.262 ns</td>
<td align="right">0.0898 ns</td>
<td align="right">0.0750 ns</td>
<td align="right">10.266 ns</td>
</tr>
<tr>
<td>SpanIndexOf</td>
<td>100</td>
<td>Start</td>
<td align="right">6.445 ns</td>
<td align="right">0.1105 ns</td>
<td align="right">0.1033 ns</td>
<td align="right">6.402 ns</td>
</tr>
<tr>
<td>SpanIndexOfOrdinal</td>
<td>100</td>
<td>Start</td>
<td align="right">11.435 ns</td>
<td align="right">0.1470 ns</td>
<td align="right">0.1148 ns</td>
<td align="right">11.426 ns</td>
</tr>
<tr>
<td>BoyerMooreIndexOf</td>
<td>100</td>
<td>Start</td>
<td align="right">152.684 ns</td>
<td align="right">0.8215 ns</td>
<td align="right">0.6860 ns</td>
<td align="right">152.648 ns</td>
</tr>
<tr>
<td>KMPIndexOf</td>
<td>100</td>
<td>Start</td>
<td align="right">4.804 ns</td>
<td align="right">0.0463 ns</td>
<td align="right">0.0387 ns</td>
<td align="right">4.797 ns</td>
</tr>
<tr>
<td><strong>IndexOf</strong></td>
<td><strong>100</strong></td>
<td><strong>Middle</strong></td>
<td align="right"><strong>1,928.897 ns</strong></td>
<td align="right"><strong>23.5317 ns</strong></td>
<td align="right"><strong>20.8602 ns</strong></td>
<td align="right"><strong>1,928.090 ns</strong></td>
</tr>
<tr>
<td>IndexOfOrdinal</td>
<td>100</td>
<td>Middle</td>
<td align="right">10.455 ns</td>
<td align="right">0.0554 ns</td>
<td align="right">0.0518 ns</td>
<td align="right">10.458 ns</td>
</tr>
<tr>
<td>SpanIndexOf</td>
<td>100</td>
<td>Middle</td>
<td align="right">6.515 ns</td>
<td align="right">0.0611 ns</td>
<td align="right">0.0571 ns</td>
<td align="right">6.522 ns</td>
</tr>
<tr>
<td>SpanIndexOfOrdinal</td>
<td>100</td>
<td>Middle</td>
<td align="right">11.298 ns</td>
<td align="right">0.0352 ns</td>
<td align="right">0.0329 ns</td>
<td align="right">11.296 ns</td>
</tr>
<tr>
<td>BoyerMooreIndexOf</td>
<td>100</td>
<td>Middle</td>
<td align="right">152.590 ns</td>
<td align="right">3.0697 ns</td>
<td align="right">7.9786 ns</td>
<td align="right">150.171 ns</td>
</tr>
<tr>
<td>KMPIndexOf</td>
<td>100</td>
<td>Middle</td>
<td align="right">4.900 ns</td>
<td align="right">0.0791 ns</td>
<td align="right">0.0661 ns</td>
<td align="right">4.907 ns</td>
</tr>
<tr>
<td><strong>IndexOf</strong></td>
<td><strong>100</strong></td>
<td><strong>End</strong></td>
<td align="right"><strong>1,911.385 ns</strong></td>
<td align="right"><strong>12.0498 ns</strong></td>
<td align="right"><strong>11.2714 ns</strong></td>
<td align="right"><strong>1,908.234 ns</strong></td>
</tr>
<tr>
<td>IndexOfOrdinal</td>
<td>100</td>
<td>End</td>
<td align="right">10.713 ns</td>
<td align="right">0.1678 ns</td>
<td align="right">0.1401 ns</td>
<td align="right">10.653 ns</td>
</tr>
<tr>
<td>SpanIndexOf</td>
<td>100</td>
<td>End</td>
<td align="right">6.891 ns</td>
<td align="right">0.1039 ns</td>
<td align="right">0.0972 ns</td>
<td align="right">6.849 ns</td>
</tr>
<tr>
<td>SpanIndexOfOrdinal</td>
<td>100</td>
<td>End</td>
<td align="right">11.380 ns</td>
<td align="right">0.0908 ns</td>
<td align="right">0.0805 ns</td>
<td align="right">11.378 ns</td>
</tr>
<tr>
<td>BoyerMooreIndexOf</td>
<td>100</td>
<td>End</td>
<td align="right">149.144 ns</td>
<td align="right">2.7001 ns</td>
<td align="right">2.3936 ns</td>
<td align="right">148.958 ns</td>
</tr>
<tr>
<td>KMPIndexOf</td>
<td>100</td>
<td>End</td>
<td align="right">4.750 ns</td>
<td align="right">0.0201 ns</td>
<td align="right">0.0188 ns</td>
<td align="right">4.753 ns</td>
</tr>
<tr>
<td><strong>IndexOf</strong></td>
<td><strong>100</strong></td>
<td><strong>Random</strong></td>
<td align="right"><strong>1,926.007 ns</strong></td>
<td align="right"><strong>37.7531 ns</strong></td>
<td align="right"><strong>35.3143 ns</strong></td>
<td align="right"><strong>1,925.254 ns</strong></td>
</tr>
<tr>
<td>IndexOfOrdinal</td>
<td>100</td>
<td>Random</td>
<td align="right">10.446 ns</td>
<td align="right">0.1609 ns</td>
<td align="right">0.1427 ns</td>
<td align="right">10.404 ns</td>
</tr>
<tr>
<td>SpanIndexOf</td>
<td>100</td>
<td>Random</td>
<td align="right">6.384 ns</td>
<td align="right">0.0295 ns</td>
<td align="right">0.0261 ns</td>
<td align="right">6.383 ns</td>
</tr>
<tr>
<td>SpanIndexOfOrdinal</td>
<td>100</td>
<td>Random</td>
<td align="right">11.130 ns</td>
<td align="right">0.0977 ns</td>
<td align="right">0.0816 ns</td>
<td align="right">11.109 ns</td>
</tr>
<tr>
<td>BoyerMooreIndexOf</td>
<td>100</td>
<td>Random</td>
<td align="right">145.757 ns</td>
<td align="right">1.7552 ns</td>
<td align="right">1.4656 ns</td>
<td align="right">145.716 ns</td>
</tr>
<tr>
<td>KMPIndexOf</td>
<td>100</td>
<td>Random</td>
<td align="right">4.769 ns</td>
<td align="right">0.0271 ns</td>
<td align="right">0.0253 ns</td>
<td align="right">4.770 ns</td>
</tr>
<tr>
<td><strong>IndexOf</strong></td>
<td><strong>10000</strong></td>
<td><strong>Start</strong></td>
<td align="right"><strong>1,889.613 ns</strong></td>
<td align="right"><strong>30.0781 ns</strong></td>
<td align="right"><strong>28.1351 ns</strong></td>
<td align="right"><strong>1,876.613 ns</strong></td>
</tr>
<tr>
<td>IndexOfOrdinal</td>
<td>10000</td>
<td>Start</td>
<td align="right">10.447 ns</td>
<td align="right">0.1852 ns</td>
<td align="right">0.1641 ns</td>
<td align="right">10.433 ns</td>
</tr>
<tr>
<td>SpanIndexOf</td>
<td>10000</td>
<td>Start</td>
<td align="right">6.631 ns</td>
<td align="right">0.0485 ns</td>
<td align="right">0.0453 ns</td>
<td align="right">6.612 ns</td>
</tr>
<tr>
<td>SpanIndexOfOrdinal</td>
<td>10000</td>
<td>Start</td>
<td align="right">11.409 ns</td>
<td align="right">0.0353 ns</td>
<td align="right">0.0331 ns</td>
<td align="right">11.413 ns</td>
</tr>
<tr>
<td>BoyerMooreIndexOf</td>
<td>10000</td>
<td>Start</td>
<td align="right">149.268 ns</td>
<td align="right">2.6223 ns</td>
<td align="right">6.3331 ns</td>
<td align="right">146.790 ns</td>
</tr>
<tr>
<td>KMPIndexOf</td>
<td>10000</td>
<td>Start</td>
<td align="right">4.882 ns</td>
<td align="right">0.0362 ns</td>
<td align="right">0.0282 ns</td>
<td align="right">4.874 ns</td>
</tr>
<tr>
<td><strong>IndexOf</strong></td>
<td><strong>10000</strong></td>
<td><strong>Middle</strong></td>
<td align="right"><strong>1,925.414 ns</strong></td>
<td align="right"><strong>14.1439 ns</strong></td>
<td align="right"><strong>13.2303 ns</strong></td>
<td align="right"><strong>1,924.021 ns</strong></td>
</tr>
<tr>
<td>IndexOfOrdinal</td>
<td>10000</td>
<td>Middle</td>
<td align="right">10.617 ns</td>
<td align="right">0.0675 ns</td>
<td align="right">0.0598 ns</td>
<td align="right">10.599 ns</td>
</tr>
<tr>
<td>SpanIndexOf</td>
<td>10000</td>
<td>Middle</td>
<td align="right">6.610 ns</td>
<td align="right">0.0871 ns</td>
<td align="right">0.0772 ns</td>
<td align="right">6.610 ns</td>
</tr>
<tr>
<td>SpanIndexOfOrdinal</td>
<td>10000</td>
<td>Middle</td>
<td align="right">11.441 ns</td>
<td align="right">0.0652 ns</td>
<td align="right">0.0610 ns</td>
<td align="right">11.437 ns</td>
</tr>
<tr>
<td>BoyerMooreIndexOf</td>
<td>10000</td>
<td>Middle</td>
<td align="right">161.190 ns</td>
<td align="right">3.1946 ns</td>
<td align="right">3.2806 ns</td>
<td align="right">161.188 ns</td>
</tr>
<tr>
<td>KMPIndexOf</td>
<td>10000</td>
<td>Middle</td>
<td align="right">4.930 ns</td>
<td align="right">0.0398 ns</td>
<td align="right">0.0372 ns</td>
<td align="right">4.934 ns</td>
</tr>
<tr>
<td><strong>IndexOf</strong></td>
<td><strong>10000</strong></td>
<td><strong>End</strong></td>
<td align="right"><strong>1,924.827 ns</strong></td>
<td align="right"><strong>13.6193 ns</strong></td>
<td align="right"><strong>12.7395 ns</strong></td>
<td align="right"><strong>1,922.824 ns</strong></td>
</tr>
<tr>
<td>IndexOfOrdinal</td>
<td>10000</td>
<td>End</td>
<td align="right">10.900 ns</td>
<td align="right">0.1292 ns</td>
<td align="right">0.1209 ns</td>
<td align="right">10.893 ns</td>
</tr>
<tr>
<td>SpanIndexOf</td>
<td>10000</td>
<td>End</td>
<td align="right">6.816 ns</td>
<td align="right">0.0734 ns</td>
<td align="right">0.0651 ns</td>
<td align="right">6.825 ns</td>
</tr>
<tr>
<td>SpanIndexOfOrdinal</td>
<td>10000</td>
<td>End</td>
<td align="right">11.402 ns</td>
<td align="right">0.0474 ns</td>
<td align="right">0.0396 ns</td>
<td align="right">11.387 ns</td>
</tr>
<tr>
<td>BoyerMooreIndexOf</td>
<td>10000</td>
<td>End</td>
<td align="right">163.459 ns</td>
<td align="right">3.1810 ns</td>
<td align="right">3.6632 ns</td>
<td align="right">162.601 ns</td>
</tr>
<tr>
<td>KMPIndexOf</td>
<td>10000</td>
<td>End</td>
<td align="right">5.143 ns</td>
<td align="right">0.0412 ns</td>
<td align="right">0.0385 ns</td>
<td align="right">5.145 ns</td>
</tr>
<tr>
<td><strong>IndexOf</strong></td>
<td><strong>10000</strong></td>
<td><strong>Random</strong></td>
<td align="right"><strong>2,000.571 ns</strong></td>
<td align="right"><strong>39.6725 ns</strong></td>
<td align="right"><strong>38.9637 ns</strong></td>
<td align="right"><strong>2,004.035 ns</strong></td>
</tr>
<tr>
<td>IndexOfOrdinal</td>
<td>10000</td>
<td>Random</td>
<td align="right">10.909 ns</td>
<td align="right">0.2449 ns</td>
<td align="right">0.5723 ns</td>
<td align="right">10.663 ns</td>
</tr>
<tr>
<td>SpanIndexOf</td>
<td>10000</td>
<td>Random</td>
<td align="right">6.673 ns</td>
<td align="right">0.0237 ns</td>
<td align="right">0.0222 ns</td>
<td align="right">6.666 ns</td>
</tr>
<tr>
<td>SpanIndexOfOrdinal</td>
<td>10000</td>
<td>Random</td>
<td align="right">10.826 ns</td>
<td align="right">0.1216 ns</td>
<td align="right">0.1078 ns</td>
<td align="right">10.797 ns</td>
</tr>
<tr>
<td>BoyerMooreIndexOf</td>
<td>10000</td>
<td>Random</td>
<td align="right">163.361 ns</td>
<td align="right">3.6494 ns</td>
<td align="right">10.3528 ns</td>
<td align="right">161.226 ns</td>
</tr>
<tr>
<td>KMPIndexOf</td>
<td>10000</td>
<td>Random</td>
<td align="right">4.882 ns</td>
<td align="right">0.0330 ns</td>
<td align="right">0.0309 ns</td>
<td align="right">4.872 ns</td>
</tr>
<tr>
<td><strong>IndexOf</strong></td>
<td><strong>1000000</strong></td>
<td><strong>Start</strong></td>
<td align="right"><strong>1,917.655 ns</strong></td>
<td align="right"><strong>5.6120 ns</strong></td>
<td align="right"><strong>5.2495 ns</strong></td>
<td align="right"><strong>1,917.252 ns</strong></td>
</tr>
<tr>
<td>IndexOfOrdinal</td>
<td>1000000</td>
<td>Start</td>
<td align="right">10.716 ns</td>
<td align="right">0.1213 ns</td>
<td align="right">0.1135 ns</td>
<td align="right">10.709 ns</td>
</tr>
<tr>
<td>SpanIndexOf</td>
<td>1000000</td>
<td>Start</td>
<td align="right">6.572 ns</td>
<td align="right">0.0252 ns</td>
<td align="right">0.0197 ns</td>
<td align="right">6.572 ns</td>
</tr>
<tr>
<td>SpanIndexOfOrdinal</td>
<td>1000000</td>
<td>Start</td>
<td align="right">11.066 ns</td>
<td align="right">0.0776 ns</td>
<td align="right">0.0726 ns</td>
<td align="right">11.066 ns</td>
</tr>
<tr>
<td>BoyerMooreIndexOf</td>
<td>1000000</td>
<td>Start</td>
<td align="right">155.307 ns</td>
<td align="right">3.1059 ns</td>
<td align="right">3.6974 ns</td>
<td align="right">156.110 ns</td>
</tr>
<tr>
<td>KMPIndexOf</td>
<td>1000000</td>
<td>Start</td>
<td align="right">4.843 ns</td>
<td align="right">0.0137 ns</td>
<td align="right">0.0122 ns</td>
<td align="right">4.846 ns</td>
</tr>
<tr>
<td><strong>IndexOf</strong></td>
<td><strong>1000000</strong></td>
<td><strong>Middle</strong></td>
<td align="right"><strong>1,920.323 ns</strong></td>
<td align="right"><strong>18.2098 ns</strong></td>
<td align="right"><strong>17.0335 ns</strong></td>
<td align="right"><strong>1,922.634 ns</strong></td>
</tr>
<tr>
<td>IndexOfOrdinal</td>
<td>1000000</td>
<td>Middle</td>
<td align="right">10.683 ns</td>
<td align="right">0.0894 ns</td>
<td align="right">0.0836 ns</td>
<td align="right">10.660 ns</td>
</tr>
<tr>
<td>SpanIndexOf</td>
<td>1000000</td>
<td>Middle</td>
<td align="right">6.569 ns</td>
<td align="right">0.0653 ns</td>
<td align="right">0.0579 ns</td>
<td align="right">6.570 ns</td>
</tr>
<tr>
<td>SpanIndexOfOrdinal</td>
<td>1000000</td>
<td>Middle</td>
<td align="right">11.046 ns</td>
<td align="right">0.0928 ns</td>
<td align="right">0.0868 ns</td>
<td align="right">11.040 ns</td>
</tr>
<tr>
<td>BoyerMooreIndexOf</td>
<td>1000000</td>
<td>Middle</td>
<td align="right">153.735 ns</td>
<td align="right">3.0260 ns</td>
<td align="right">7.9716 ns</td>
<td align="right">149.605 ns</td>
</tr>
<tr>
<td>KMPIndexOf</td>
<td>1000000</td>
<td>Middle</td>
<td align="right">4.948 ns</td>
<td align="right">0.0780 ns</td>
<td align="right">0.0730 ns</td>
<td align="right">4.944 ns</td>
</tr>
<tr>
<td><strong>IndexOf</strong></td>
<td><strong>1000000</strong></td>
<td><strong>End</strong></td>
<td align="right"><strong>1,922.367 ns</strong></td>
<td align="right"><strong>15.6553 ns</strong></td>
<td align="right"><strong>13.8780 ns</strong></td>
<td align="right"><strong>1,920.379 ns</strong></td>
</tr>
<tr>
<td>IndexOfOrdinal</td>
<td>1000000</td>
<td>End</td>
<td align="right">18.310 ns</td>
<td align="right">0.2918 ns</td>
<td align="right">0.2730 ns</td>
<td align="right">18.192 ns</td>
</tr>
<tr>
<td>SpanIndexOf</td>
<td>1000000</td>
<td>End</td>
<td align="right">6.586 ns</td>
<td align="right">0.0560 ns</td>
<td align="right">0.0523 ns</td>
<td align="right">6.580 ns</td>
</tr>
<tr>
<td>SpanIndexOfOrdinal</td>
<td>1000000</td>
<td>End</td>
<td align="right">10.961 ns</td>
<td align="right">0.0885 ns</td>
<td align="right">0.0785 ns</td>
<td align="right">10.963 ns</td>
</tr>
<tr>
<td>BoyerMooreIndexOf</td>
<td>1000000</td>
<td>End</td>
<td align="right">152.627 ns</td>
<td align="right">2.9601 ns</td>
<td align="right">7.1490 ns</td>
<td align="right">151.619 ns</td>
</tr>
<tr>
<td>KMPIndexOf</td>
<td>1000000</td>
<td>End</td>
<td align="right">4.875 ns</td>
<td align="right">0.0351 ns</td>
<td align="right">0.0328 ns</td>
<td align="right">4.859 ns</td>
</tr>
<tr>
<td><strong>IndexOf</strong></td>
<td><strong>1000000</strong></td>
<td><strong>Random</strong></td>
<td align="right"><strong>1,911.500 ns</strong></td>
<td align="right"><strong>6.8142 ns</strong></td>
<td align="right"><strong>6.3740 ns</strong></td>
<td align="right"><strong>1,912.532 ns</strong></td>
</tr>
<tr>
<td>IndexOfOrdinal</td>
<td>1000000</td>
<td>Random</td>
<td align="right">10.602 ns</td>
<td align="right">0.0849 ns</td>
<td align="right">0.0752 ns</td>
<td align="right">10.602 ns</td>
</tr>
<tr>
<td>SpanIndexOf</td>
<td>1000000</td>
<td>Random</td>
<td align="right">6.673 ns</td>
<td align="right">0.0511 ns</td>
<td align="right">0.0478 ns</td>
<td align="right">6.673 ns</td>
</tr>
<tr>
<td>SpanIndexOfOrdinal</td>
<td>1000000</td>
<td>Random</td>
<td align="right">11.070 ns</td>
<td align="right">0.1190 ns</td>
<td align="right">0.1113 ns</td>
<td align="right">11.049 ns</td>
</tr>
<tr>
<td>BoyerMooreIndexOf</td>
<td>1000000</td>
<td>Random</td>
<td align="right">149.230 ns</td>
<td align="right">3.0118 ns</td>
<td align="right">5.0320 ns</td>
<td align="right">147.710 ns</td>
</tr>
<tr>
<td>KMPIndexOf</td>
<td>1000000</td>
<td>Random</td>
<td align="right">4.858 ns</td>
<td align="right">0.0327 ns</td>
<td align="right">0.0290 ns</td>
<td align="right">4.859 ns</td>
</tr>
<tr>
<td><strong>IndexOf</strong></td>
<td><strong>100000000</strong></td>
<td><strong>Start</strong></td>
<td align="right"><strong>1,915.633 ns</strong></td>
<td align="right"><strong>14.4868 ns</strong></td>
<td align="right"><strong>13.5510 ns</strong></td>
<td align="right"><strong>1,917.496 ns</strong></td>
</tr>
<tr>
<td>IndexOfOrdinal</td>
<td>100000000</td>
<td>Start</td>
<td align="right">10.772 ns</td>
<td align="right">0.1435 ns</td>
<td align="right">0.1342 ns</td>
<td align="right">10.764 ns</td>
</tr>
<tr>
<td>SpanIndexOf</td>
<td>100000000</td>
<td>Start</td>
<td align="right">6.827 ns</td>
<td align="right">0.0666 ns</td>
<td align="right">0.0623 ns</td>
<td align="right">6.806 ns</td>
</tr>
<tr>
<td>SpanIndexOfOrdinal</td>
<td>100000000</td>
<td>Start</td>
<td align="right">10.977 ns</td>
<td align="right">0.0593 ns</td>
<td align="right">0.0526 ns</td>
<td align="right">10.989 ns</td>
</tr>
<tr>
<td>BoyerMooreIndexOf</td>
<td>100000000</td>
<td>Start</td>
<td align="right">146.921 ns</td>
<td align="right">2.9779 ns</td>
<td align="right">2.6398 ns</td>
<td align="right">147.245 ns</td>
</tr>
<tr>
<td>KMPIndexOf</td>
<td>100000000</td>
<td>Start</td>
<td align="right">4.833 ns</td>
<td align="right">0.0151 ns</td>
<td align="right">0.0134 ns</td>
<td align="right">4.832 ns</td>
</tr>
<tr>
<td><strong>IndexOf</strong></td>
<td><strong>100000000</strong></td>
<td><strong>Middle</strong></td>
<td align="right"><strong>1,906.318 ns</strong></td>
<td align="right"><strong>5.4295 ns</strong></td>
<td align="right"><strong>5.0788 ns</strong></td>
<td align="right"><strong>1,905.934 ns</strong></td>
</tr>
<tr>
<td>IndexOfOrdinal</td>
<td>100000000</td>
<td>Middle</td>
<td align="right">10.725 ns</td>
<td align="right">0.2305 ns</td>
<td align="right">0.2467 ns</td>
<td align="right">10.689 ns</td>
</tr>
<tr>
<td>SpanIndexOf</td>
<td>100000000</td>
<td>Middle</td>
<td align="right">6.862 ns</td>
<td align="right">0.0724 ns</td>
<td align="right">0.0642 ns</td>
<td align="right">6.851 ns</td>
</tr>
<tr>
<td>SpanIndexOfOrdinal</td>
<td>100000000</td>
<td>Middle</td>
<td align="right">11.001 ns</td>
<td align="right">0.0903 ns</td>
<td align="right">0.0845 ns</td>
<td align="right">11.019 ns</td>
</tr>
<tr>
<td>BoyerMooreIndexOf</td>
<td>100000000</td>
<td>Middle</td>
<td align="right">152.705 ns</td>
<td align="right">2.4382 ns</td>
<td align="right">2.2807 ns</td>
<td align="right">152.401 ns</td>
</tr>
<tr>
<td>KMPIndexOf</td>
<td>100000000</td>
<td>Middle</td>
<td align="right">4.850 ns</td>
<td align="right">0.0262 ns</td>
<td align="right">0.0245 ns</td>
<td align="right">4.846 ns</td>
</tr>
<tr>
<td><strong>IndexOf</strong></td>
<td><strong>100000000</strong></td>
<td><strong>End</strong></td>
<td align="right"><strong>1,923.149 ns</strong></td>
<td align="right"><strong>9.6492 ns</strong></td>
<td align="right"><strong>9.0258 ns</strong></td>
<td align="right"><strong>1,921.531 ns</strong></td>
</tr>
<tr>
<td>IndexOfOrdinal</td>
<td>100000000</td>
<td>End</td>
<td align="right">10.718 ns</td>
<td align="right">0.1682 ns</td>
<td align="right">0.1491 ns</td>
<td align="right">10.759 ns</td>
</tr>
<tr>
<td>SpanIndexOf</td>
<td>100000000</td>
<td>End</td>
<td align="right">6.807 ns</td>
<td align="right">0.0234 ns</td>
<td align="right">0.0207 ns</td>
<td align="right">6.804 ns</td>
</tr>
<tr>
<td>SpanIndexOfOrdinal</td>
<td>100000000</td>
<td>End</td>
<td align="right">11.071 ns</td>
<td align="right">0.1070 ns</td>
<td align="right">0.1001 ns</td>
<td align="right">11.076 ns</td>
</tr>
<tr>
<td>BoyerMooreIndexOf</td>
<td>100000000</td>
<td>End</td>
<td align="right">147.044 ns</td>
<td align="right">2.9552 ns</td>
<td align="right">2.7643 ns</td>
<td align="right">147.472 ns</td>
</tr>
<tr>
<td>KMPIndexOf</td>
<td>100000000</td>
<td>End</td>
<td align="right">4.966 ns</td>
<td align="right">0.1067 ns</td>
<td align="right">0.0891 ns</td>
<td align="right">4.949 ns</td>
</tr>
<tr>
<td><strong>IndexOf</strong></td>
<td><strong>100000000</strong></td>
<td><strong>Random</strong></td>
<td align="right"><strong>1,925.095 ns</strong></td>
<td align="right"><strong>30.9030 ns</strong></td>
<td align="right"><strong>28.9067 ns</strong></td>
<td align="right"><strong>1,923.878 ns</strong></td>
</tr>
<tr>
<td>IndexOfOrdinal</td>
<td>100000000</td>
<td>Random</td>
<td align="right">10.486 ns</td>
<td align="right">0.0910 ns</td>
<td align="right">0.0806 ns</td>
<td align="right">10.498 ns</td>
</tr>
<tr>
<td>SpanIndexOf</td>
<td>100000000</td>
<td>Random</td>
<td align="right">7.009 ns</td>
<td align="right">0.1658 ns</td>
<td align="right">0.1628 ns</td>
<td align="right">7.015 ns</td>
</tr>
<tr>
<td>SpanIndexOfOrdinal</td>
<td>100000000</td>
<td>Random</td>
<td align="right">11.080 ns</td>
<td align="right">0.0898 ns</td>
<td align="right">0.0840 ns</td>
<td align="right">11.112 ns</td>
</tr>
<tr>
<td>BoyerMooreIndexOf</td>
<td>100000000</td>
<td>Random</td>
<td align="right">155.551 ns</td>
<td align="right">3.1132 ns</td>
<td align="right">4.2614 ns</td>
<td align="right">155.335 ns</td>
</tr>
<tr>
<td>KMPIndexOf</td>
<td>100000000</td>
<td>Random</td>
<td align="right">4.887 ns</td>
<td align="right">0.0573 ns</td>
<td align="right">0.0536 ns</td>
<td align="right">4.871 ns</td>
</tr>
</tbody></table>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ol>
<li>不同算法在数据集大小不同和关键字符串位置不同的情况下，表现都很稳定。</li>
<li>默认的 IndexOf 最好使用 StringComparison.Ordinal ，比默认的 StringComparison.CurrentCulture 快两个数量级，平均大约是 20 倍的差距。</li>
<li>算法效率由快到慢排序为 KMPIndexOf SpanIndexOf IndexOfOrdinal SpanIndexOfOrdinal BoyerMooreIndexOf IndexOf，效率比率大约为：</li>
</ol>
<table>
<thead>
<tr>
<th align="center">KMPIndexOf</th>
<th align="center">SpanIndexOf</th>
<th align="center">IndexOfOrdinal</th>
<th align="center">SpanIndexOfOrdinal</th>
<th align="center">BoyerMooreIndexOf</th>
<th align="center">IndexOf</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td align="center">2</td>
<td align="center">2.5</td>
<td align="center">3</td>
<td align="center">35</td>
<td align="center">200</td>
</tr>
</tbody></table>
<p><strong>PS：以上结果仅为本人测试所得，供本人日后编程参考，不排除有代码 BUG 的可能，欢迎斧正。</strong></p>
]]></content>
      <categories>
        <category>偶有所得</category>
      </categories>
      <tags>
        <tag>字符串查找</tag>
        <tag>IndexOf</tag>
        <tag>Span</tag>
        <tag>BM</tag>
        <tag>KMP</tag>
      </tags>
  </entry>
  <entry>
    <title>关于租房到期离职纠结</title>
    <url>/posts/18742.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="缘起"><a href="#缘起" class="headerlink" title="缘起"></a>缘起</h2><p>　　去年4月8日换工作时租的 Loft 公寓即将到期，而决定续租与否或是租在哪里的最重要的因素无疑就是要不要换工作，遂写一篇博客辅助分析。</p>
<span id="more"></span>
<h2 id="换"><a href="#换" class="headerlink" title="换 ~"></a>换 ~</h2><h3 id="租房合同即将到期"><a href="#租房合同即将到期" class="headerlink" title="租房合同即将到期"></a>租房合同即将到期</h3><p>　　我现在租住的是一间复式的 Loft 公寓，去年 4月8日 签了为期一年的合同，月租1850。到今天已经询问过续租价格为2400，涨幅30%。</p>
<h3 id="995-确实是对人性的很大磨损。"><a href="#995-确实是对人性的很大磨损。" class="headerlink" title="995 确实是对人性的很大磨损。"></a>995 确实是对人性的很大磨损。</h3><p>　　现在的作息基本就是周日晚上到周五晚上每天九点半以后到家，看会儿电视，逛逛论坛，再翻几页书，基本就到了十二点，再坐一些杂七杂八的事，到洗漱完成睡觉大约就是一点到两点了，八点左右起床，洗漱、喝咖啡，上班。如此往复，到周末确实是极累的，周末作息基本就是中午起床，晚上依然是一两点睡觉。<br>这套作息带来的问题有：</p>
<ol>
<li>自我提升的时间较少。</li>
<li>厌恶社交，越来越宅。（租住地偏远，外出社交成本至少是一小时以上的地铁）</li>
</ol>
<h3 id="工作内容重复，温水煮青蛙"><a href="#工作内容重复，温水煮青蛙" class="headerlink" title="工作内容重复，温水煮青蛙"></a>工作内容重复，温水煮青蛙</h3><ol>
<li>我所在的项目组属于公司里支撑部门，用于内部培训，各种内部考核、人才培训相关的需求都会转到组里，需求迭代非常快，经常有紧急需求需要处理，所以大部分时间都是各种重复度很高的业务接口，很多技术框架的调整一直想要做，却没有足够的时间。</li>
<li>项目到现在已经经历了两年多，底层框架是较为成熟的老框架，有些问题需要更换框架才能解决，但是时间不足。</li>
<li>现在的工作模式是前后端分离，我作为后端开发的主要工作就是约定、完成接口，重复度极高。</li>
</ol>
<h3 id="起薪低带来的未来不可期"><a href="#起薪低带来的未来不可期" class="headerlink" title="起薪低带来的未来不可期"></a>起薪低带来的未来不可期</h3><p>　　之前所在的公司是从实习期起一直就职的，故而没有积累到这方面的经验。去年四月跳槽到现在的公司属于技术转型，因为刚开始从事后端工作，没有足够的经验，故而起薪很低。<br>　　到年底统一调薪之后暗示直系领导无果之后，我才意识到，起薪真的是非常重要。<br>　　有资格上调薪资的领导和我中间隔了一层，一般没办法直接接触到，故而领导主动注意到我的成绩并且我调整薪水基本不可能，剩下的机会就只有统一调薪，而统一调薪基本就属于“侮辱性普调”。<br>　　我现在是组里的主程序员，我带着一位去年入职的校招生。虽然没有主动去了解过校招的工资，但是也大概知道他们的薪资范围，就目前的统一调薪频率来看，如果他们薪资一直不变，我大约再过两年才能有他们现在的工资。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>　　995虽然是很累，不过在行业里也不算压力最大的，工作重复也其实是大部分工作的特点，或许凑巧遇到合适的工作，这两点也能够有改进，但现在的情况也不是完全不能忍受。我也在主动调整作息，用一些碎片时间进行自我提升。目前房租的剧烈变化和薪水的不可期是我想要换工作最重要的原因。</p>
<h2 id="不换"><a href="#不换" class="headerlink" title="不换 ~"></a>不换 ~</h2><h3 id="主程的技术自由"><a href="#主程的技术自由" class="headerlink" title="主程的技术自由"></a>主程的技术自由</h3><p>　　去年下半年做了项目组的主程，技术上有很大的自由性，虽然现在的业务压力确实很忙，但未来的一段时间内应该也有一些机会对我私下抽空研究的一些技术做一些时间。</p>
<h3 id="工作年限不高就业自由度低"><a href="#工作年限不高就业自由度低" class="headerlink" title="工作年限不高就业自由度低"></a>工作年限不高就业自由度低</h3><p>　　工作年限较低，很多工作对年限的要求都未能达到。</p>
<h2 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h2><p>　　目前的打算是，先租一间便宜一些的公寓，未来半年内裸辞寻觅新的工作。</p>
]]></content>
      <categories>
        <category>闹着玩儿</category>
      </categories>
      <tags>
        <tag>租房</tag>
        <tag>离职</tag>
      </tags>
  </entry>
  <entry>
    <title>Git 和 GitFolw 的一些总结</title>
    <url>/posts/40738.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>总结一下 Git 日常开发使用常用指令，以及一个常见的 GitFlow 实践模型。</p>
<span id="more"></span>
<h1 id="工具准备-Chocolatey"><a href="#工具准备-Chocolatey" class="headerlink" title="工具准备 - Chocolatey"></a>工具准备 - Chocolatey</h1><p>因为日常主要在 Windows 平台做开发，本文又设计了一些软件工具，故而先行引入一个 Windows 平台的包管理工具，<span class="exturl" data-url="aHR0cHM6Ly9jaG9jb2xhdGV5Lm9yZy8=">Chocolatey<i class="fa fa-external-link-alt"></i></span>，使用Powershell运行以下脚本即可成功安装 Chocolatey 的开源免费版本：</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Set-ExecutionPolicy</span> Bypass <span class="literal">-Scope</span> <span class="keyword">Process</span> <span class="literal">-Force</span>; <span class="built_in">iex</span> ((<span class="built_in">New-Object</span> System.Net.WebClient).DownloadString(<span class="string">&#x27;https://chocolatey.org/install.ps1&#x27;</span>))</span><br></pre></td></tr></table></figure>
<p>之后用的的软件工具都会直接以 Chocolatey 的方式安装，当然也可以Google搜索直接下载安装软件包。<br>没装 Git 环境的可以直接使用 Chocolatey 安装：</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">choco install <span class="literal">-y</span> git</span><br></pre></td></tr></table></figure>
<h1 id="Git-常用命令"><a href="#Git-常用命令" class="headerlink" title="Git 常用命令"></a>Git 常用命令</h1><p>一般来说，日常使用只要记住下图6个命令，就可以了。但是熟练使用，恐怕要记住60～100个命令。<br><img data-src="https://qiniucdn.wayneshao.com/%E5%85%B3%E4%BA%8EGit%E7%9A%84%E6%96%B9%E6%96%B9%E9%9D%A2%E9%9D%A2/20191219054013913.png"></p>
<h2 id="新建代码库"><a href="#新建代码库" class="headerlink" title="新建代码库"></a>新建代码库</h2><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 在当前目录新建一个Git代码库</span></span><br><span class="line"><span class="variable">$</span> git init</span><br><span class="line"></span><br><span class="line"><span class="comment"># 新建一个目录，将其初始化为Git代码库</span></span><br><span class="line"><span class="variable">$</span> git init [<span class="type">project</span>-<span class="type">name</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载一个项目和它的整个代码历史</span></span><br><span class="line"><span class="variable">$</span> git clone [<span class="type">url</span>]</span><br></pre></td></tr></table></figure>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>Git的设置文件为.gitconfig，它可以在用户主目录下（全局配置），也可以在项目目录下（项目配置）。</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 显示当前的Git配置</span></span><br><span class="line"><span class="variable">$</span> git config <span class="literal">--list</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编辑Git配置文件</span></span><br><span class="line"><span class="variable">$</span> git config <span class="literal">-e</span> [--<span class="type">global</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置提交代码时的用户信息</span></span><br><span class="line"><span class="variable">$</span> git config [--<span class="type">global</span>] user.name <span class="string">&quot;[name]&quot;</span></span><br><span class="line"><span class="variable">$</span> git config [--<span class="type">global</span>] user.email <span class="string">&quot;[email address]&quot;</span></span><br></pre></td></tr></table></figure>
<h2 id="增加-删除文件"><a href="#增加-删除文件" class="headerlink" title="增加/删除文件"></a>增加/删除文件</h2><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 添加指定文件到暂存区</span></span><br><span class="line"><span class="variable">$</span> git add [<span class="type">file1</span>] [<span class="type">file2</span>] ...</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加指定目录到暂存区，包括子目录</span></span><br><span class="line"><span class="variable">$</span> git add [<span class="type">dir</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加当前目录的所有文件到暂存区</span></span><br><span class="line"><span class="variable">$</span> git add .</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加每个变化前，都会要求确认</span></span><br><span class="line"><span class="comment"># 对于同一个文件的多处变化，可以实现分次提交</span></span><br><span class="line"><span class="variable">$</span> git add <span class="literal">-p</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除工作区文件，并且将这次删除放入暂存区</span></span><br><span class="line"><span class="variable">$</span> git <span class="built_in">rm</span> [<span class="type">file1</span>] [<span class="type">file2</span>] ...</span><br><span class="line"></span><br><span class="line"><span class="comment"># 停止追踪指定文件，但该文件会保留在工作区</span></span><br><span class="line"><span class="variable">$</span> git <span class="built_in">rm</span> <span class="literal">--cached</span> [<span class="type">file</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 改名文件，并且将这个改名放入暂存区</span></span><br><span class="line"><span class="variable">$</span> git <span class="built_in">mv</span> [<span class="type">file</span>-<span class="type">original</span>] [<span class="type">file</span>-<span class="type">renamed</span>]</span><br></pre></td></tr></table></figure>
<h2 id="代码提交"><a href="#代码提交" class="headerlink" title="代码提交"></a>代码提交</h2><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 提交暂存区到仓库区</span></span><br><span class="line"><span class="variable">$</span> git commit <span class="literal">-m</span> [<span class="type">message</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提交暂存区的指定文件到仓库区</span></span><br><span class="line"><span class="variable">$</span> git commit [<span class="type">file1</span>] [<span class="type">file2</span>] ... <span class="literal">-m</span> [<span class="type">message</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提交工作区自上次commit之后的变化，直接到仓库区</span></span><br><span class="line"><span class="variable">$</span> git commit <span class="literal">-a</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提交时显示所有diff信息</span></span><br><span class="line"><span class="variable">$</span> git commit <span class="literal">-v</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用一次新的commit，替代上一次提交</span></span><br><span class="line"><span class="comment"># 如果代码没有任何新变化，则用来改写上一次commit的提交信息</span></span><br><span class="line"><span class="variable">$</span> git commit <span class="literal">--amend</span> <span class="literal">-m</span> [<span class="type">message</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重做上一次commit，并包括指定文件的新变化</span></span><br><span class="line"><span class="variable">$</span> git commit <span class="literal">--amend</span> [<span class="type">file1</span>] [<span class="type">file2</span>] ...</span><br></pre></td></tr></table></figure>
<h2 id="分支"><a href="#分支" class="headerlink" title="分支"></a>分支</h2><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 列出所有本地分支</span></span><br><span class="line"><span class="variable">$</span> git branch</span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出所有远程分支</span></span><br><span class="line"><span class="variable">$</span> git branch <span class="literal">-r</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出所有本地分支和远程分支</span></span><br><span class="line"><span class="variable">$</span> git branch <span class="literal">-a</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 新建一个分支，但依然停留在当前分支</span></span><br><span class="line"><span class="variable">$</span> git branch [<span class="type">branch</span>-<span class="type">name</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 新建一个分支，并切换到该分支</span></span><br><span class="line"><span class="variable">$</span> git checkout <span class="literal">-b</span> [<span class="type">branch</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 新建一个分支，指向指定commit</span></span><br><span class="line"><span class="variable">$</span> git branch [<span class="type">branch</span>] [<span class="type">commit</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 新建一个分支，与指定的远程分支建立追踪关系</span></span><br><span class="line"><span class="variable">$</span> git branch <span class="literal">--track</span> [<span class="type">branch</span>] [<span class="type">remote</span>-<span class="type">branch</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换到指定分支，并更新工作区</span></span><br><span class="line"><span class="variable">$</span> git checkout [<span class="type">branch</span>-<span class="type">name</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换到上一个分支</span></span><br><span class="line"><span class="variable">$</span> git checkout -</span><br><span class="line"></span><br><span class="line"><span class="comment"># 建立追踪关系，在现有分支与指定的远程分支之间</span></span><br><span class="line"><span class="variable">$</span> git branch <span class="literal">--set-upstream</span> [<span class="type">branch</span>] [<span class="type">remote</span>-<span class="type">branch</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 合并指定分支到当前分支</span></span><br><span class="line"><span class="variable">$</span> git merge [<span class="type">branch</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 选择一个commit，合并进当前分支</span></span><br><span class="line"><span class="variable">$</span> git cherry<span class="literal">-pick</span> [<span class="type">commit</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除分支</span></span><br><span class="line"><span class="variable">$</span> git branch <span class="literal">-d</span> [<span class="type">branch</span>-<span class="type">name</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除远程分支</span></span><br><span class="line"><span class="variable">$</span> git push origin <span class="literal">--delete</span> [<span class="type">branch</span>-<span class="type">name</span>]</span><br><span class="line"><span class="variable">$</span> git branch <span class="literal">-dr</span> [<span class="type">remote</span>/<span class="type">branch</span>]</span><br></pre></td></tr></table></figure>
<h2 id="标签"><a href="#标签" class="headerlink" title="标签"></a>标签</h2><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 列出所有tag</span></span><br><span class="line"><span class="variable">$</span> git tag</span><br><span class="line"></span><br><span class="line"><span class="comment"># 新建一个tag在当前commit</span></span><br><span class="line"><span class="variable">$</span> git tag [<span class="type">tag</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 新建一个tag在指定commit</span></span><br><span class="line"><span class="variable">$</span> git tag [<span class="type">tag</span>] [<span class="type">commit</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除本地tag</span></span><br><span class="line"><span class="variable">$</span> git tag <span class="literal">-d</span> [<span class="type">tag</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除远程tag</span></span><br><span class="line"><span class="variable">$</span> git push origin :refs/tags/[<span class="type">tagName</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看tag信息</span></span><br><span class="line"><span class="variable">$</span> git show [<span class="type">tag</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提交指定tag</span></span><br><span class="line"><span class="variable">$</span> git push [<span class="type">remote</span>] [<span class="type">tag</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提交所有tag</span></span><br><span class="line"><span class="variable">$</span> git push [<span class="type">remote</span>] <span class="literal">--tags</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 新建一个分支，指向某个tag</span></span><br><span class="line"><span class="variable">$</span> git checkout <span class="literal">-b</span> [<span class="type">branch</span>] [<span class="type">tag</span>]</span><br></pre></td></tr></table></figure>
<h2 id="查看信息"><a href="#查看信息" class="headerlink" title="查看信息"></a>查看信息</h2><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 显示有变更的文件</span></span><br><span class="line"><span class="variable">$</span> git status</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示当前分支的版本历史</span></span><br><span class="line"><span class="variable">$</span> git log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示commit历史，以及每次commit发生变更的文件</span></span><br><span class="line"><span class="variable">$</span> git log <span class="literal">--stat</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 搜索提交历史，根据关键词</span></span><br><span class="line"><span class="variable">$</span> git log <span class="literal">-S</span> [<span class="type">keyword</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示某个commit之后的所有变动，每个commit占据一行</span></span><br><span class="line"><span class="variable">$</span> git log [<span class="type">tag</span>] HEAD <span class="literal">--pretty</span>=format:%s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示某个commit之后的所有变动，其&quot;提交说明&quot;必须符合搜索条件</span></span><br><span class="line"><span class="variable">$</span> git log [<span class="type">tag</span>] HEAD <span class="literal">--grep</span> feature</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示某个文件的版本历史，包括文件改名</span></span><br><span class="line"><span class="variable">$</span> git log <span class="literal">--follow</span> [<span class="type">file</span>]</span><br><span class="line"><span class="variable">$</span> git whatchanged [<span class="type">file</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示指定文件相关的每一次diff</span></span><br><span class="line"><span class="variable">$</span> git log <span class="literal">-p</span> [<span class="type">file</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示过去5次提交</span></span><br><span class="line"><span class="variable">$</span> git log <span class="literal">-5</span> <span class="literal">--pretty</span> <span class="literal">--oneline</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示所有提交过的用户，按提交次数排序</span></span><br><span class="line"><span class="variable">$</span> git shortlog <span class="literal">-sn</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示指定文件是什么人在什么时间修改过</span></span><br><span class="line"><span class="variable">$</span> git blame [<span class="type">file</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示暂存区和工作区的差异</span></span><br><span class="line"><span class="variable">$</span> git <span class="built_in">diff</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示暂存区和上一个commit的差异</span></span><br><span class="line"><span class="variable">$</span> git <span class="built_in">diff</span> <span class="literal">--cached</span> [<span class="type">file</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示工作区与当前分支最新commit之间的差异</span></span><br><span class="line"><span class="variable">$</span> git <span class="built_in">diff</span> HEAD</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示两次提交之间的差异</span></span><br><span class="line"><span class="variable">$</span> git <span class="built_in">diff</span> [<span class="type">first</span>-<span class="type">branch</span>]...[<span class="type">second</span>-<span class="type">branch</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示今天你写了多少行代码</span></span><br><span class="line"><span class="variable">$</span> git <span class="built_in">diff</span> <span class="literal">--shortstat</span> <span class="string">&quot;@&#123;0 day ago&#125;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示某次提交的元数据和内容变化</span></span><br><span class="line"><span class="variable">$</span> git show [<span class="type">commit</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示某次提交发生变化的文件</span></span><br><span class="line"><span class="variable">$</span> git show <span class="literal">--name-only</span> [<span class="type">commit</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示某次提交时，某个文件的内容</span></span><br><span class="line"><span class="variable">$</span> git show [<span class="type">commit</span>]:[<span class="type">filename</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示当前分支的最近几次提交</span></span><br><span class="line"><span class="variable">$</span> git reflog</span><br></pre></td></tr></table></figure>
<h2 id="远程同步"><a href="#远程同步" class="headerlink" title="远程同步"></a>远程同步</h2><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 下载远程仓库的所有变动</span></span><br><span class="line"><span class="variable">$</span> git fetch [<span class="type">remote</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示所有远程仓库</span></span><br><span class="line"><span class="variable">$</span> git remote <span class="literal">-v</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示某个远程仓库的信息</span></span><br><span class="line"><span class="variable">$</span> git remote show [<span class="type">remote</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 增加一个新的远程仓库，并命名</span></span><br><span class="line"><span class="variable">$</span> git remote add [<span class="type">shortname</span>] [<span class="type">url</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 取回远程仓库的变化，并与本地分支合并</span></span><br><span class="line"><span class="variable">$</span> git pull [<span class="type">remote</span>] [<span class="type">branch</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 上传本地指定分支到远程仓库</span></span><br><span class="line"><span class="variable">$</span> git push [<span class="type">remote</span>] [<span class="type">branch</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 强行推送当前分支到远程仓库，即使有冲突</span></span><br><span class="line"><span class="variable">$</span> git push [<span class="type">remote</span>] <span class="literal">--force</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 推送所有分支到远程仓库</span></span><br><span class="line"><span class="variable">$</span> git push [<span class="type">remote</span>] <span class="literal">--all</span></span><br></pre></td></tr></table></figure>
<h2 id="撤销"><a href="#撤销" class="headerlink" title="撤销"></a>撤销</h2><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 恢复暂存区的指定文件到工作区</span></span><br><span class="line"><span class="variable">$</span> git checkout [<span class="type">file</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 恢复某个commit的指定文件到暂存区和工作区</span></span><br><span class="line"><span class="variable">$</span> git checkout [<span class="type">commit</span>] [<span class="type">file</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 恢复暂存区的所有文件到工作区</span></span><br><span class="line"><span class="variable">$</span> git checkout .</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重置暂存区的指定文件，与上一次commit保持一致，但工作区不变</span></span><br><span class="line"><span class="variable">$</span> git reset [<span class="type">file</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重置暂存区与工作区，与上一次commit保持一致</span></span><br><span class="line"><span class="variable">$</span> git reset <span class="literal">--hard</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 重置当前分支的指针为指定commit，同时重置暂存区，但工作区不变</span></span><br><span class="line"><span class="variable">$</span> git reset [<span class="type">commit</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重置当前分支的HEAD为指定commit，同时重置暂存区和工作区，与指定commit一致</span></span><br><span class="line"><span class="variable">$</span> git reset <span class="literal">--hard</span> [<span class="type">commit</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重置当前HEAD为指定commit，但保持暂存区和工作区不变</span></span><br><span class="line"><span class="variable">$</span> git reset <span class="literal">--keep</span> [<span class="type">commit</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 新建一个commit，用来撤销指定commit</span></span><br><span class="line"><span class="comment"># 后者的所有变化都将被前者抵消，并且应用到当前分支</span></span><br><span class="line"><span class="variable">$</span> git revert [<span class="type">commit</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 暂时将未提交的变化移除，稍后再移入</span></span><br><span class="line"><span class="variable">$</span> git stash</span><br><span class="line"><span class="variable">$</span> git stash pop</span><br></pre></td></tr></table></figure>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 生成一个可供发布的压缩包</span></span><br><span class="line"><span class="variable">$</span> git archive</span><br></pre></td></tr></table></figure>
<h1 id="GitFlow（Git分支管理策略）"><a href="#GitFlow（Git分支管理策略）" class="headerlink" title="GitFlow（Git分支管理策略）"></a>GitFlow（Git分支管理策略）</h1><p><img data-src="https://qiniucdn.wayneshao.com/%E5%85%B3%E4%BA%8EGit%E7%9A%84%E6%96%B9%E6%96%B9%E9%9D%A2%E9%9D%A2/20191219055349496.png"><br>本文描述的是 <span class="exturl" data-url="aHR0cHM6Ly9udmllLmNvbS9hYm91dC8=">Vincent Driessen<i class="fa fa-external-link-alt"></i></span> 提出的一种比较成功的<span class="exturl" data-url="aHR0cHM6Ly9udmllLmNvbS9wb3N0cy9hLXN1Y2Nlc3NmdWwtZ2l0LWJyYW5jaGluZy1tb2RlbC8=">分支管理模型<i class="fa fa-external-link-alt"></i></span>，非常适合借鉴甚至直接拿来使用。</p>
<h2 id="两条主要分支"><a href="#两条主要分支" class="headerlink" title="两条主要分支"></a>两条主要分支</h2><p><img data-src="https://qiniucdn.wayneshao.com/%E5%85%B3%E4%BA%8EGit%E7%9A%84%E6%96%B9%E6%96%B9%E9%9D%A2%E9%9D%A2/20191219055444447.png"></p>
<h3 id="主分支-master"><a href="#主分支-master" class="headerlink" title="主分支 master"></a>主分支 master</h3><p>首先，代码库应该有一个、且仅有一个主分支。所有提供给用户使用的正式版本，都在这个主分支上发布。<br>Git版本库初始化以后，自动建立的默认分支叫做 master，我们通常把它作为主分支。</p>
<h3 id="开发分支-develop"><a href="#开发分支-develop" class="headerlink" title="开发分支 develop"></a>开发分支 develop</h3><p>主分支只用来分布重大版本，日常开发应该在另一条分支上完成。我们把开发用的分支，叫做 develop。<br>这个分支可以用来生成代码的最新隔夜版本（nightly）。如果想正式对外发布，就在 master 分支上，对 develop 分支进行”合并”（merge）。<br>由 master 分支创建 develop 分支：</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">git checkout <span class="literal">-b</span> develop master</span><br></pre></td></tr></table></figure>
<p>将 develop 分支发布到 master分支：</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 切换到 master 分支</span></span><br><span class="line">git checkout master</span><br><span class="line"></span><br><span class="line"><span class="comment"># 对 develop 分支进行合并</span></span><br><span class="line">git merge <span class="literal">--no-ff</span> develop</span><br></pre></td></tr></table></figure>

<p>这里稍微解释一下，上一条命令中的–no-ff参数是什么意思。<br>默认情况下，Git执行”快进式合并”（fast-farward merge），会直接将 master 分支指向 develop 分支。<br><img data-src="https://qiniucdn.wayneshao.com/%E5%85%B3%E4%BA%8EGit%E7%9A%84%E6%96%B9%E6%96%B9%E9%9D%A2%E9%9D%A2/20191219060532991.png"><br>使用 –no-ff 参数后，会在合并时在 master 分支上生成一个新节点。<br><img data-src="https://qiniucdn.wayneshao.com/%E5%85%B3%E4%BA%8EGit%E7%9A%84%E6%96%B9%E6%96%B9%E9%9D%A2%E9%9D%A2/20191219062956530.png"><br>为了保证版本演进的清晰，我们希望采用这种做法。<br>关于合并的更多解释，请参考Benjamin Sandofsky的《<span class="exturl" data-url="aHR0cDovL3NhbmRvZnNreS5jb20vYmxvZy9naXQtd29ya2Zsb3cuaHRtbA==">Understanding the Git Workflow<i class="fa fa-external-link-alt"></i></span>》。</p>
<h2 id="三条辅助分支"><a href="#三条辅助分支" class="headerlink" title="三条辅助分支"></a>三条辅助分支</h2><p>在主要分支 master 和 develop 之外，我们的开发模型使用各种辅助分支来帮助团队成员之间的并行开发，简化特性的跟踪，为生产版本做准备，并协助快速解决生产问题。<br>临时性分支主要有三种：</p>
<ul>
<li>特性（feature）分支</li>
<li>预发布（release）分支</li>
<li>热修复（hotfix）分支</li>
</ul>
<p>与主要分支不同，这些辅助分支总是有一个有限的生命期，使用完以后，应该马上删除，使得代码库的常设分支始终只有 master 和develop。</p>
<h3 id="特性分支（feature）"><a href="#特性分支（feature）" class="headerlink" title="特性分支（feature）"></a>特性分支（feature）</h3><p>特性分支是为了开发某种特定功能，从 develop 分支上面分离出来，开发完成后，要再并入 develop。<br><img data-src="https://qiniucdn.wayneshao.com/%E5%85%B3%E4%BA%8EGit%E7%9A%84%E6%96%B9%E6%96%B9%E9%9D%A2%E9%9D%A2/20191219062016929.png"><br>特性分支(主题分支/功能分支)用于开发新的功能。<br>当开始开发一个功能时，包含这个功能的正式版本发布时间是不确定的。<br>特性分支的本质是，只要特性还在开发中，它就一直存在，最终会被合并回到 develop 中或者被删除。<br>特性分支的名字，可以采用feature-*的形式命名。</p>
<h4 id="创建"><a href="#创建" class="headerlink" title="创建"></a>创建</h4><p>创建一个特性分支：</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 由 develop 分支 检出新的特性分支 &quot;feature-x&quot;</span></span><br><span class="line"><span class="variable">$</span> git checkout <span class="literal">-b</span> feature<span class="literal">-x</span> develop</span><br></pre></td></tr></table></figure>
<h4 id="完成"><a href="#完成" class="headerlink" title="完成"></a>完成</h4><p>开发完成后，将特性分支合并到develop分支：</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 切换到分支 &#x27;develop&#x27;</span></span><br><span class="line"><span class="variable">$</span> git checkout develop</span><br><span class="line"><span class="comment"># 非直进式合并</span></span><br><span class="line"><span class="variable">$</span> git merge <span class="literal">--no-ff</span> feature<span class="literal">-x</span></span><br></pre></td></tr></table></figure>
<h4 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h4><p>删除特性分支</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 删除分支</span></span><br><span class="line"><span class="variable">$</span> git branch <span class="literal">-d</span> feature<span class="literal">-x</span></span><br><span class="line">Deleted branch feature<span class="literal">-x</span> (was <span class="number">05</span>e9557).</span><br><span class="line"><span class="comment"># 推送源码到服务器</span></span><br><span class="line"><span class="variable">$</span> git push origin develop</span><br></pre></td></tr></table></figure>
<p>– no-ff 标志使 merge 即使可以通过快进执行 merge也始终创建一个新的提交对象。 这样可以避免丢失关于特性分支和特性组合在一起的历史存在的信息，这些特性组合在一起添加了特性。<br><img data-src="https://qiniucdn.wayneshao.com/%E5%85%B3%E4%BA%8EGit%E7%9A%84%E6%96%B9%E6%96%B9%E9%9D%A2%E9%9D%A2/20191219062831705.png"><br>直进式合并下不可能从 Git 历史记录中看到哪些提交对象一起实现了某个特性，如果一定需要，那就必须手动读取所有的日志消息，还原整个特性(即一组提交)是一件真正令人头疼的事情，而如果使用 – no-ff 标志，则很容易实现。<br>虽然它会创建更额外的空的提交对象，但是收益比成本大得多。</p>
<h3 id="预发布分支（release）"><a href="#预发布分支（release）" class="headerlink" title="预发布分支（release）"></a>预发布分支（release）</h3><p>预发布分支用来完成正式版本发布的准备工作。 可以在预发布分支上修复较小的错误，并为发行版准备元数据(版本号、构建日期等)。<br>当 develop (几乎)反映了新版本的期望状态，即针对即将构建的发行版的所有特性都已经合并到 develop 时，从 develop 分支检出一个预发布分支。<br>从发布分支的开始，即将发布的版本才会被分配一个版本号。<br>在此之前，开发分支反映了“下一个版本”的变化，但是在发布分支启动之前，还不清楚“下一个版本”最终会变成0.3还是1.0。<br>这个决定是在发布分支的开始时做出的，并根据项目中关于版本号碰撞的规则执行。<br>预发布分支是 develop 分支上面分出来的，预发布结束以后，必须合并进 develop 和 master分支。<br>它的命名，可以采用release-*的形式。</p>
<h4 id="创建-1"><a href="#创建-1" class="headerlink" title="创建"></a>创建</h4><p>假设1.1.5版本是当前的产品版本，我们即将发布一个大的版本。<br>开发的状态已经为“下一个版本”做好了准备，我们已经决定这将成为1.2版本(而不是1.1.6或2.0)。<br>PS：假设存在脚本 bump-version.sh 接收一个版本号参数，功能是修改项目的版本号相关文件以切换最终发布产品的版本。</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 由 develop 分支 检出新的预发布分支 &quot;release-1.2&quot;</span></span><br><span class="line"><span class="variable">$</span> git checkout <span class="literal">-b</span> release<span class="literal">-1</span>.<span class="number">2</span> develop</span><br><span class="line"><span class="comment"># 版本升级到 1.2</span></span><br><span class="line"><span class="variable">$</span> ./bump<span class="literal">-version</span>.sh <span class="number">1.2</span></span><br><span class="line"><span class="comment"># 提交</span></span><br><span class="line"><span class="variable">$</span> git commit <span class="literal">-a</span> <span class="literal">-m</span> <span class="string">&quot;Bumped version number to 1.2&quot;</span></span><br><span class="line"></span><br><span class="line">[<span class="type">release</span>-<span class="number">1.2</span> <span class="number">74</span><span class="type">d9424</span>] Bumped version number to <span class="number">1.2</span></span><br><span class="line"><span class="number">1</span> files changed, <span class="number">1</span> insertions(+), <span class="number">1</span> deletions(-)</span><br></pre></td></tr></table></figure>
<p>预发布分支存在的时间区间为：从完成下一个版本所有特性开发，到正式发布版本。<br>在此期间，可以在这个分支(而不是在 develop 分支)中提交 bug 修复。<br>这里严禁添加大型的新特性，大型新特性必须合并到 develop，已经在预发布阶段的情况下，新的大型新特性最好归入下一个版本。 </p>
<h4 id="完成-1"><a href="#完成-1" class="headerlink" title="完成"></a>完成</h4><p>当发布分支的状态准备好成为真正的发布时，需要执行一些操作。<br>首先，将发布分支合并到 master 中(<strong>根据定义，master 上的每个提交都是一个新版本，请牢记这一点</strong>)。<br>接下来，必须对 master 上的提交进行标记（tip），以便将来参考这个历史版本。<br>最后，需要将在发行版分支上所做的更改合并回到 develop 中，以便将来的发行版也包含这些错误修复。</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 切换到分支 &#x27;master&#x27;</span></span><br><span class="line"><span class="variable">$</span> git checkout master</span><br><span class="line"><span class="comment"># 非直进式合并</span></span><br><span class="line"><span class="variable">$</span> git merge <span class="literal">--no-ff</span> release<span class="literal">-1</span>.<span class="number">2</span></span><br><span class="line">(Summary of changes)</span><br><span class="line"><span class="comment"># 打上标记</span></span><br><span class="line"><span class="variable">$</span> git tag <span class="literal">-a</span> <span class="number">1.2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换到分支 &#x27;develop&#x27;</span></span><br><span class="line"><span class="variable">$</span> git checkout develop</span><br><span class="line"><span class="comment"># 将预发布分支合并回分支 &#x27;develop&#x27;</span></span><br><span class="line"><span class="variable">$</span> git merge <span class="literal">--no-ff</span> release<span class="literal">-1</span>.<span class="number">2</span></span><br><span class="line">(Summary of changes)</span><br></pre></td></tr></table></figure>
<p>这一步很可能导致合并冲突，毕竟我们已经更改了版本号。 需要修复并提交。<br>到这里我们完成了预发布流程，发布分支可以直接删除:</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$</span> git branch <span class="literal">-d</span> release<span class="literal">-1</span>.<span class="number">2</span></span><br><span class="line">Deleted branch release<span class="literal">-1</span>.<span class="number">2</span> (was ff452fe).</span><br></pre></td></tr></table></figure>
<h3 id="热修复分支（hotfix）"><a href="#热修复分支（hotfix）" class="headerlink" title="热修复分支（hotfix）"></a>热修复分支（hotfix）</h3><p>热修复分支非常类似于预发布分支，因为它们也意味着为新的产品发布做准备，尽管是计划外的。<br>它们产生于生产版本发现的问题有立即采取行动的必要性时。<br>当生产版本中的关键错误必须立即解决时，从标记生产版本的主分支上的相应标记分检出新的热修复分支。<br>通常修复不会涉及所有团队成员，团队成员在开发分支上的工作可以继续，bug 涉及的成员在热修复分支上做快速修复。<br>修补bug分支是从 master 分支上面分出来的。修补结束以后，再合并进 master 和 develop 分支。<br>它的命名，可以采用hotfix-*的形式。</p>
<h4 id="创建-2"><a href="#创建-2" class="headerlink" title="创建"></a>创建</h4><p>假设版本1.2是当前正在运行的生产版本，并且由于一个严重的 bug 而导致了问题。<br>但是 develop 分支上的变化仍然是不稳定的。<br>这时我们可以由 master 分支检出一个 hotfix 分支并开始修复问题:<br>** 热修复通常意味着需要发布生产版本，所以同样需要更改版本号 **</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 检出热修复分支 &quot;hotfix-1.2.1&quot;</span></span><br><span class="line"><span class="variable">$</span> git checkout <span class="literal">-b</span> hotfix<span class="literal">-1</span>.<span class="number">2.1</span> master</span><br><span class="line"><span class="comment"># 版本升级到 1.2.1</span></span><br><span class="line"><span class="variable">$</span> ./bump<span class="literal">-version</span>.sh <span class="number">1.2</span>.<span class="number">1</span></span><br><span class="line"><span class="comment"># 提交</span></span><br><span class="line"><span class="variable">$</span> git commit <span class="literal">-a</span> <span class="literal">-m</span> <span class="string">&quot;Bumped version number to 1.2.1&quot;</span></span><br><span class="line">[<span class="type">hotfix</span>-<span class="number">1.2</span><span class="type">.1</span> <span class="number">41</span><span class="type">e61bb</span>] Bumped version number to <span class="number">1.2</span>.<span class="number">1</span></span><br><span class="line"><span class="number">1</span> files changed, <span class="number">1</span> insertions(+), <span class="number">1</span> deletions(-)</span><br></pre></td></tr></table></figure>
<p>接下来，经过紧锣密鼓的排查，我们找到了错误点并做出了修复：</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$</span> git commit <span class="literal">-m</span> <span class="string">&quot;Fixed severe production problem&quot;</span></span><br><span class="line">[<span class="type">hotfix</span>-<span class="number">1.2</span><span class="type">.1</span> <span class="type">abbe5d6</span>] Fixed severe production problem</span><br><span class="line"><span class="number">5</span> files changed, <span class="number">32</span> insertions(+), <span class="number">17</span> deletions(-)</span><br></pre></td></tr></table></figure>
<h4 id="完成-2"><a href="#完成-2" class="headerlink" title="完成"></a>完成</h4><p>当修复完成时，bug 修复合并回 master 中的同时也需要合并回 develop 中，以保证 bug 修复也包含在下一个版本中。<br>这与发布分支的完成方式完全相似。</p>
<p>首先，更新主版本并标记发布版本。</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 切换到分支 &#x27;master&#x27;</span></span><br><span class="line"><span class="variable">$</span> git checkout master</span><br><span class="line"><span class="comment"># 非直进式合并</span></span><br><span class="line"><span class="variable">$</span> git merge <span class="literal">--no-ff</span> hotfix<span class="literal">-1</span>.<span class="number">2.1</span></span><br><span class="line">Merge made by recursive.</span><br><span class="line">(Summary of changes)</span><br><span class="line"><span class="comment"># 打上标记</span></span><br><span class="line"><span class="variable">$</span> git tag <span class="literal">-a</span> <span class="number">1.2</span>.<span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>接下来，更新开发版本:</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 切换到分支 &#x27;develop&#x27;</span></span><br><span class="line"><span class="variable">$</span> git checkout develop</span><br><span class="line"><span class="comment"># 非直进式合并</span></span><br><span class="line"><span class="variable">$</span> git merge <span class="literal">--no-ff</span> hotfix<span class="literal">-1</span>.<span class="number">2.1</span></span><br><span class="line">Merge made by recursive.</span><br><span class="line">(Summary of changes)</span><br></pre></td></tr></table></figure>
<p>这里还存在一种特殊情况，就是<strong>当预发布分支存在时，热修复应当合并到热修复分支而不是开发分支</strong>。</p>
<p>最后，删除临时分支:</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$</span> git branch <span class="literal">-d</span> hotfix<span class="literal">-1</span>.<span class="number">2.1</span></span><br><span class="line">Deleted branch hotfix<span class="literal">-1</span>.<span class="number">2.1</span> (was abbe5d6).</span><br></pre></td></tr></table></figure>

<h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><h3 id="1-使用非直进式合并（git-merge-–no-ff）"><a href="#1-使用非直进式合并（git-merge-–no-ff）" class="headerlink" title="1. 使用非直进式合并（git merge –no-ff）"></a>1. 使用非直进式合并（git merge –no-ff）</h3><p>默认情况下，Git执行”快进式合并”（fast-farward merge），会直接将 master 分支指向 develop 分支。<br><img data-src="https://qiniucdn.wayneshao.com/%E5%85%B3%E4%BA%8EGit%E7%9A%84%E6%96%B9%E6%96%B9%E9%9D%A2%E9%9D%A2/20191219060532991.png"><br>使用 –no-ff 参数后，会在合并时在 master 分支上生成一个新节点。<br><img data-src="https://qiniucdn.wayneshao.com/%E5%85%B3%E4%BA%8EGit%E7%9A%84%E6%96%B9%E6%96%B9%E9%9D%A2%E9%9D%A2/20191219062956530.png"><br>非直进式合并始终创建一个新的提交对象。 这样可以避免丢失关于特性分支和特性组合在一起的历史存在的信息，这些特性组合在一起添加了特性。<br>直进式合并下不可能从 Git 历史记录中看到哪些提交对象一起实现了某个特性，如果一定需要，那就必须手动读取所有的日志消息，还原整个特性(即一组提交)是一件真正令人头疼的事情，而如果使用 –no-ff 标志，则很容易实现。<br>虽然它会创建更额外的空的提交对象，但是收益比成本大得多。<br>为了保证版本演进的清晰，我们希望采用这种做法。</p>
<p>Tips：可以通过修改全局配置实现</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># pull操作时禁止 --no-ff</span></span><br><span class="line">git config <span class="literal">--global</span> pull.ff only</span><br><span class="line"><span class="comment"># merge操作时配置为 --no-ff</span></span><br><span class="line">git config <span class="literal">--global</span> merge.ff false</span><br></pre></td></tr></table></figure>
<h3 id="2-使用变基式拉取（git-pull-–rebase）"><a href="#2-使用变基式拉取（git-pull-–rebase）" class="headerlink" title="2. 使用变基式拉取（git pull –rebase）"></a>2. 使用变基式拉取（git pull –rebase）</h3><p>多人同时在同一分支开发的情况下，推荐在拉取代码时使用 –rebase,<br>这是因为默认的 git pull 操作相当于<strong>git fetch + git merge FETCH_HEAD</strong>，会经过一次合并，生成一个新的节点，之前的提交分开显示。<br>而 git pull –rebase 则相当于 <strong>git fetch + git rebase FETCH_HEAD</strong>，不会生成新的节点，是将两个分支融合成一个线性的提交。<br>想要更好的提交树，使用rebase操作会更好一点。<br>这样可以线性的看到每一次提交，并且没有增加提交节点。</p>
<p>merge 操作遇到冲突的时候，当前merge不能继续进行下去。手动修改冲突内容后，add 修改，commit 就可以了。</p>
<p>而rebase 操作的话，会中断rebase,同时会提示去解决冲突。<br>解决冲突后,将修改add后执行git rebase –continue继续操作，或者git rebase –skip忽略冲突。</p>
<p>Tips: 可以配置为总是使用 pull-rebase</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 配置 pull 操作时总是使用 -rebase</span></span><br><span class="line">git config <span class="literal">--global</span> pull.rebase true</span><br></pre></td></tr></table></figure>

<h1 id="常用工具"><a href="#常用工具" class="headerlink" title="常用工具"></a>常用工具</h1><h2 id="TortoiseGit"><a href="#TortoiseGit" class="headerlink" title="TortoiseGit"></a>TortoiseGit</h2><p><span class="exturl" data-url="aHR0cHM6Ly90b3J0b2lzZWdpdC5vcmcv">TortoiseGit<i class="fa fa-external-link-alt"></i></span> 是一个提供给 Git的 Windows Shell 界面程序，基于 TortoiseSVN。它是开源的，可以完全免费使用。</p>
<h3 id="界面"><a href="#界面" class="headerlink" title="界面"></a>界面</h3><p><img data-src="https://tortoisegit.org/docs/tortoisegit/images/ContextMenuDirControl.png"><br><img data-src="https://tortoisegit.org/about/screenshots/sendmail.png"><br><img data-src="https://tortoisegit.org/docs/tortoisegit/images/Overlays.png"><br><img data-src="https://tortoisegit.org/docs/tortoisegit/images/Commit.png"><br><img data-src="https://tortoisegit.org/docs/tortoisegit/images/LogMessages.png"><br>……</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p><span class="exturl" data-url="aHR0cHM6Ly9kb3dubG9hZC50b3J0b2lzZWdpdC5vcmcvdGdpdC8yLjkuMC4wL1RvcnRvaXNlR2l0LTIuOS4wLjAtNjRiaXQubXNp">TortoiseGit-2.9.0.0-64bit.msi<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly9kb3dubG9hZC50b3J0b2lzZWdpdC5vcmcvdGdpdC8yLjkuMC4wL1RvcnRvaXNlR2l0LUxhbmd1YWdlUGFjay0yLjkuMC4wLTY0Yml0LXpoX0NOLm1zaQ==">TortoiseGit-LanguagePack-2.9.0.0-64bit-zh_CN.msi<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">choco install <span class="literal">-y</span> TortoiseGit</span><br></pre></td></tr></table></figure>
<h2 id="Sourcetree"><a href="#Sourcetree" class="headerlink" title="Sourcetree"></a>Sourcetree</h2><p><span class="exturl" data-url="aHR0cHM6Ly93d3cuc291cmNldHJlZWFwcC5jb20v">https://www.sourcetreeapp.com/<i class="fa fa-external-link-alt"></i></span><br>Sourcetree 是一个针对 Windows 和 Mac 的免费 Git 客户端，简化了与 Git 仓库的交互，这样你就可以专注于编码。<br>通过 Sourcetree 的 Git GUI 可以可视化和管理存储库。</p>
<h3 id="界面-1"><a href="#界面-1" class="headerlink" title="界面"></a>界面</h3><p><img data-src="https://www.sourcetreeapp.com/dam/jcr:580c367b-c240-453d-aa18-c7ced44324f9/hero-mac-screenshot.png?cdnVersion=731"><br><img data-src="https://www.sourcetreeapp.com/dam/jcr:c7337d19-a8c3-4a4b-a810-91ff5c6b035d/left_image.png?cdnVersion=731"><br><img data-src="https://www.sourcetreeapp.com/dam/jcr:b6ec8a39-5a98-4e28-842b-f9198824fe74/commit_with_confidence.png?cdnVersion=731"></p>
<h3 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h3><p><span class="exturl" data-url="aHR0cHM6Ly9wcm9kdWN0LWRvd25sb2Fkcy5hdGxhc3NpYW4uY29tL3NvZnR3YXJlL3NvdXJjZXRyZWUvd2luZG93cy9nYS9Tb3VyY2VUcmVlU2V0dXAtMy4zLjYuZXhl">SourceTreeSetup-3.3.6.exe<i class="fa fa-external-link-alt"></i></span></p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">choco install <span class="literal">-y</span> SourceTree</span><br></pre></td></tr></table></figure>
<h1 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h1><p><span class="exturl" data-url="aHR0cHM6Ly9udmllLmNvbS9wb3N0cy9hLXN1Y2Nlc3NmdWwtZ2l0LWJyYW5jaGluZy1tb2RlbC8=">［1］Vincent Driessen.A successful Git branching model［OL］.nvie.com，2010.<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cDovL3d3dy5ydWFueWlmZW5nLmNvbS9ibG9nLzIwMTUvMTIvZ2l0LXdvcmtmbG93Lmh0bWw=">［2］阮一峰.Git 工作流程［OL］.www.ruanyifeng.com，2015.<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cDovL3d3dy5ydWFueWlmZW5nLmNvbS9ibG9nLzIwMTIvMDcvZ2l0Lmh0bWw=">［3］阮一峰.Git分支管理策略［OL］.www.ruanyifeng.com，2012.<i class="fa fa-external-link-alt"></i></span></p>
]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
      <tags>
        <tag>Git</tag>
        <tag>GitFlow</tag>
      </tags>
  </entry>
  <entry>
    <title>如何修改 .NET Core Kestrel 下的端口</title>
    <url>/posts/15088.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>　　今天在尝试 Consul 的时候需要动态改变 .NET Core Kestrel 下的端口以方便测试，故而查了查，发现原来除了最常使用的 UseUrls 之外，还有许多其他方法，故而总结一下。<br>  <span id="more"></span></p>
<h1 id="实现方法"><a href="#实现方法" class="headerlink" title="实现方法"></a>实现方法</h1><h2 id="ASPNETCORE-URLS-环境变量"><a href="#ASPNETCORE-URLS-环境变量" class="headerlink" title="ASPNETCORE_URLS 环境变量"></a>ASPNETCORE_URLS 环境变量</h2><p>使用环境变量可以配置 Kestrel 使用的端口<br><strong>CODE</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">set</span> ASPNETCORE_URLS=http://127.0.0.1:5008;http://0.0.0.0:5009</span><br></pre></td></tr></table></figure>
<p><strong>RESULT</strong><br><img data-src="https://qiniucdn.wayneshao.com/%E5%A6%82%E4%BD%95%E4%BF%AE%E6%94%B9-.NET-Core/20190220123000050.png"></p>
<h2 id="–urls-命令行参数"><a href="#–urls-命令行参数" class="headerlink" title="–urls 命令行参数"></a>–urls 命令行参数</h2><p>使用 –urls 命令行参数可以配置 Kestrel 使用的端口<br><strong>CODE</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">set</span> dotnet EndpointConfigurationTest2.0.dll --urls http://0.0.0.0:5698;https://127.0.0.1:6936</span><br></pre></td></tr></table></figure>
<p><strong>RESULT</strong><br><img data-src="https://qiniucdn.wayneshao.com/%E5%A6%82%E4%BD%95%E4%BF%AE%E6%94%B9-.NET-Core/20190220123329442.png"></p>
<h2 id="UseUrls"><a href="#UseUrls" class="headerlink" title="UseUrls"></a>UseUrls</h2><p>使用 <strong>IWebHostBuilder</strong> 的扩展方法 UseUrls() 可以为 Kestrel 绑定一个或者多个 url ，支持 http 与 https，支持多个 string 参数或者单个 string 中使用分号分割。</p>
<p><strong>CODE</strong></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IWebHostBuilder <span class="title">CreateWebHostBuilder</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span> =&gt;</span><br><span class="line">    WebHost.CreateDefaultBuilder(args)</span><br><span class="line">        .UseUrls(<span class="string">&quot;http://localhost:4411&quot;</span>,<span class="string">&quot;https://localhost:4412&quot;</span>,<span class="string">&quot;http://0.0.0.0:4413;https://localhost:4414&quot;</span>)</span><br><span class="line">        .UseStartup&lt;Startup&gt;();</span><br></pre></td></tr></table></figure>
<p><strong>RESULT</strong><br><img data-src="https://qiniucdn.wayneshao.com/%E5%A6%82%E4%BD%95%E4%BF%AE%E6%94%B9-.NET-Core/20190219113830792.png"></p>
<h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><p>在配置文件中增加 Kestrel 节点来配置 Kestrel 使用的端口<br><strong>CODE</strong></p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;Logging&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;LogLevel&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Default&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Warning&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;AllowedHosts&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;Kestrel&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;EndPoints&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Http&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;Url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://localhost:5000&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Https&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;Url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://localhost:5006&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p><strong>RESULT</strong><br><img data-src="https://qiniucdn.wayneshao.com/%E5%A6%82%E4%BD%95%E4%BF%AE%E6%94%B9-.NET-Core/20190220124242947.png"></p>
<h2 id="UseKestrel-或者-ConfigureKestrel"><a href="#UseKestrel-或者-ConfigureKestrel" class="headerlink" title="UseKestrel 或者 ConfigureKestrel"></a>UseKestrel 或者 ConfigureKestrel</h2><p>使用 <strong>IWebHostBuilder</strong> 的扩展方法 UseKestrel() 可以更精确的设置 Kestrel 的更多配置信息 ，在 .NET Core 2.1 版本以上也可以为 ConfigureKestrel()。</p>
<p><strong>CODE</strong></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IWebHostBuilder <span class="title">CreateWebHostBuilder</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span> =&gt;</span><br><span class="line">    WebHost.CreateDefaultBuilder(args)</span><br><span class="line">        .UseUrls(<span class="string">&quot;http://localhost:4411&quot;</span>,<span class="string">&quot;https://localhost:4412&quot;</span>,<span class="string">&quot;http://0.0.0.0:4413;https://localhost:4414&quot;</span>)</span><br><span class="line">        .UseStartup&lt;Startup&gt;()</span><br><span class="line">        .UseKestrel((context, options) =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            options.Listen(IPAddress.Any, <span class="number">5620</span>);</span><br><span class="line">            options.Listen(IPAddress.Loopback, <span class="number">5588</span>, listenOptions =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                listenOptions.UseHttps();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>
<p><strong>RESULT</strong><br><img data-src="https://qiniucdn.wayneshao.com/%E5%A6%82%E4%BD%95%E4%BF%AE%E6%94%B9-.NET-Core/20190220121433663.png"></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>　　以上几种方法就是我根据官方文档整理的修改 Kestrel 端口的方法，实测优先级由上到下依次增高，使用优先级更高的方式可以覆盖掉优先级低的方式。<br>　　综上，需要测试 Consul 服务治理时，更合适的方式是使用命令行 –urls 方式.</p>
]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
      <tags>
        <tag>Kestrel</tag>
        <tag>端口修改</tag>
        <tag>终结点配置</tag>
        <tag>Endpoint</tag>
      </tags>
  </entry>
  <entry>
    <title>多益大学技术简单总结</title>
    <url>/posts/31741.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>距离离职也有了大半个月，决定对整个大学项目开发的方方面面做一个简要总结。</p>
<span id="more"></span>
<h2 id="架构图"><a href="#架构图" class="headerlink" title="架构图"></a>架构图</h2><p><img data-src="https://qiniucdn.wayneshao.com/%E5%A4%9A%E7%9B%8A%E5%A4%A7%E5%AD%A6%E6%8A%80%E6%9C%AF%E6%80%BB%E7%BB%93/20191015083234133.png"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>大学的整体结构采用单体架构，整套架构是从传统三层架构+MVC扩展演进而来的，目前大部分页面都已经完成了前后端分离，目前大部分的业务代码都集中在BLL层。</p>
<h3 id="待解决的问题"><a href="#待解决的问题" class="headerlink" title="待解决的问题"></a>待解决的问题</h3><h4 id="前后端分离不彻底"><a href="#前后端分离不彻底" class="headerlink" title="前后端分离不彻底"></a>前后端分离不彻底</h4><h5 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h5><p>系统已经做了前后端分离，现在的情况是，所有的模块都是SPA，但是SPA本身还是通过 MVC 渲染模式，Router由后端完成， View 进行渲染。</p>
<h5 id="拟解决"><a href="#拟解决" class="headerlink" title="拟解决"></a>拟解决</h5><ol>
<li>把所有的单页整合到一个更大的单页里，把所有交互跳转都交给前端来做。</li>
<li>将整个前端代码分离到另一个库，前端的发版交由前端自行完成，不再由后端统一维护。</li>
</ol>
<h4 id="后端服务层耦合严重"><a href="#后端服务层耦合严重" class="headerlink" title="后端服务层耦合严重"></a>后端服务层耦合严重</h4><h5 id="描述-1"><a href="#描述-1" class="headerlink" title="描述"></a>描述</h5><p>系统经历了两年，多代程序员的维护，业务层各个Service中代码耦合严重，导致维护难度很大，也几乎不可能直接向微服务架构迁移。</p>
<h5 id="拟解决-1"><a href="#拟解决-1" class="headerlink" title="拟解决"></a>拟解决</h5><p>把各个Service里的引用收束到服务实体本身，所有需要跟其他业务实体交互的部分，部封装一层聚合服务来解决，将整个程序的架构演进到“面向微服务的单体应用架构”。（截止到离职前用户部分已经完成）</p>
<p>Wait…</p>
]]></content>
      <categories>
        <category>偶有所得</category>
      </categories>
      <tags>
        <tag>某某大学</tag>
        <tag>工作经历</tag>
      </tags>
  </entry>
  <entry>
    <title>如何判定一个类型支不支持 await 异步等待(代码)</title>
    <url>/posts/8777.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>最近由于一些业务上的需求,需要在 OnActionExcutionAsync 和 OnActionExcuted 中判断当前请求的接口是否是异步的接口，刚好前几天看过<span class="exturl" data-url="aHR0cHM6Ly93YWx0ZXJsdi5jb20v">吕毅大佬<i class="fa fa-external-link-alt"></i></span>的文章《<span class="exturl" data-url="aHR0cHM6Ly93YWx0ZXJsdi5jb20vcG9zdC93aGF0LWlzLWFuLWF3YWl0ZXIuaHRtbA==">.NET 中什么样的类是可使用 await 异步等待的？<i class="fa fa-external-link-alt"></i></span>》，遂封装实现一下判断类型是否为可等待类型的方法。</p>
<span id="more"></span>
<h2 id="理论"><a href="#理论" class="headerlink" title="理论"></a>理论</h2><blockquote>
<p>总结起来，要想使一个方法可被 <code>await</code> 等待，必须具备以下条件：</p>
</blockquote>
<ol>
<li>这个方法返回一个类 A 的实例，这个类 A 必须满足后面的条件。</li>
<li>此类 A 有一个可被访问到的 <code>GetAwaiter</code> 方法（扩展方法也行，这算是黑科技吗？），方法返回类 B 的实例，这个类 B 必须满足后面的条件；</li>
<li>此类 B 实现 <code>INotifyCompletion</code> 接口，且拥有 <code>bool IsCompleted &#123; get; &#125; </code>属性、<code>GetResult()</code> 方法、<code>void OnCompleted(Action continuation) </code>方法。</li>
</ol>
<p>第三点中，<code>OnCompleted</code>方法本身就是 <code>INotifyCompletion</code> 接口要求实现的，所以只需要校验前三点即可。</p>
<h2 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h2><p>按照要求封装以下扩展方法：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Reflection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">System</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">ReflectionExtension</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">IsAsyncType</span>(<span class="params"><span class="keyword">this</span> Type type</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> awaiter = type.GetMethod(<span class="string">&quot;GetAwaiter&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (awaiter == <span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">var</span> retType = awaiter.ReturnType;</span><br><span class="line">            <span class="comment">//.NET Core 1.1及以下版本中没有 GetInterface 方法，为了兼容性使用 GetInterfaces</span></span><br><span class="line">            <span class="keyword">if</span> (retType.GetInterfaces().All(i =&gt; i.Name != <span class="string">&quot;INotifyCompletion&quot;</span>))</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (retType.GetProperty(<span class="string">&quot;IsCompleted&quot;</span>) == <span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (retType.GetMethod(<span class="string">&quot;GetResult&quot;</span>) == <span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>借用大佬博客中的测试类：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(<span class="keyword">typeof</span>(Test).IsAsyncType());</span><br><span class="line">        Console.ReadLine();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Test</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Test2 <span class="title">GetAwaiter</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Test2();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Test2</span> : <span class="title">INotifyCompletion</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> IsCompleted &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">GetResult</span>()</span> &#123; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnCompleted</span>(<span class="params">Action continuation</span>)</span> &#123; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img data-src="https://qiniucdn.wayneshao.com/%E5%A6%82%E4%BD%95%E5%88%A4%E5%AE%9A%E4%B8%80%E4%B8%AA%E6%96%B9%E6%B3%95%E6%94%AF%E4%B8%8D%E6%94%AF%E6%8C%81%E5%BC%82%E6%AD%A5/20190320032022556.png"></p>
<h2 id="在-OnActionExcutionAsync-和-OnActionExcuted-中的使用"><a href="#在-OnActionExcutionAsync-和-OnActionExcuted-中的使用" class="headerlink" title="在 OnActionExcutionAsync 和 OnActionExcuted 中的使用"></a>在 <code>OnActionExcutionAsync</code> 和 <code>OnActionExcuted</code> 中的使用</h2><p>在 <code>OnActionExcutionAsync</code> 和 <code>OnActionExcuted</code> 中使用时，可以再封装一层扩展方法，方便直接使用事件中的上下文实例调用。</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">IsAsyncAction</span>(<span class="params"><span class="keyword">this</span> FilterContext context</span>)</span> </span><br><span class="line">    =&gt; ((ControllerActionDescriptor) context.ActionDescriptor).MethodInfo.ReturnType.IsAsyncType();</span><br></pre></td></tr></table></figure>
<p>调用方式：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnActionExecuted</span>(<span class="params">ActionExecutedContext context</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (context.IsAsyncAction())</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Current action is support async.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnActionExecuting</span>(<span class="params">ActionExecutingContext context</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (context.IsAsyncAction())</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Current action is support async.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> Task <span class="title">OnActionExecutionAsync</span>(<span class="params">ActionExecutingContext context, ActionExecutionDelegate next</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (context.IsAsyncAction())</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Current action is support async.&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">base</span>.OnActionExecutionAsync(context, next);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>以上↑</strong></p>
]]></content>
      <categories>
        <category>踩坑笔记</category>
      </categories>
      <tags>
        <tag>.NET</tag>
        <tag>反射</tag>
        <tag>await</tag>
        <tag>异步等待</tag>
      </tags>
  </entry>
  <entry>
    <title>如何在IIS中托管.NET Core应用</title>
    <url>/posts/19877.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>Asp.NET Core 应用如果需要托管在IIS下，需要为IIS<span class="exturl" data-url="aHR0cHM6Ly93d3cubWljcm9zb2Z0LmNvbS9uZXQvZG93bmxvYWQvYWxs">下载<i class="fa fa-external-link-alt"></i></span>安装 AspNetCoreModule 模块。</p>
<span id="more"></span>
<p>下面以最新的.NET Core Runtime 2.1.0-preview1版本为例：</p>
<h2 id="安装-Server-Hosting-Installer"><a href="#安装-Server-Hosting-Installer" class="headerlink" title="安装 Server Hosting Installer"></a>安装 Server Hosting Installer</h2><p>首先访问微软的<span class="exturl" data-url="aHR0cHM6Ly93d3cubWljcm9zb2Z0LmNvbS9uZXQvZG93bmxvYWQvYWxs">.Net下载中心<i class="fa fa-external-link-alt"></i></span><br>，并找到我们要下载的版本。<br><img data-src="https://qiniucdn.wayneshao.com/20180305013606660/20180305014343191.png"><br>点击进入详情页后，找到 Windows 分类下的 <strong>Server Hosting Installer</strong> 链接，并点击下载<br><img data-src="https://qiniucdn.wayneshao.com/20180305013606660/20180305014516178.png"><br>下载安装完成以后即可在IIS的模块中找到托管.NET Core 应用所需的 AspNetCoreModule 模块。<br><img data-src="https://qiniucdn.wayneshao.com/20180305013606660/20180305014647982.png"></p>
<h2 id="发布程序"><a href="#发布程序" class="headerlink" title="发布程序"></a>发布程序</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">dotnet publish -o D:\Web\aspnetcoredemo</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>踩坑笔记</category>
      </categories>
      <tags>
        <tag>.NET</tag>
        <tag>IIS</tag>
      </tags>
  </entry>
  <entry>
    <title>安装DotNetCore.1.0.1-VS2015Tools.Preview2.0.2出现0x80072f8a未指定的错误</title>
    <url>/posts/35658.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>最近DotNetCore更新到了1.0.1，Azure tools也更新到了2.9.5，尝试更新时发现，DotNetCore更新失败，提示：0x80072f8a未指定的错误，而Azure Tools中也包含了DotNetCore的更新，0x80072f8a问题，导致两个软件都不能成功地完成更新。</p>
<p>研究安装的错误日志后才发现，原来使因为证书过期导致的无法下载微软在线资源，所以无法成功安装，解决证书问题之后就顺利的成功安装啦！</p>
<span id="more"></span>
<p>和大家分享一下解决的方法：</p>
<h3 id="方案一，修改IE选项，取消选项-“检查服务器证书是否已吊销”"><a href="#方案一，修改IE选项，取消选项-“检查服务器证书是否已吊销”" class="headerlink" title="方案一，修改IE选项，取消选项 “检查服务器证书是否已吊销”"></a>方案一，修改IE选项，取消选项 “检查服务器证书是否已吊销”</h3><p><img data-src="https://qiniucdn.wayneshao.com/20180218224858/20180218104959569.png"></p>
<h3 id="方案二，修改时间到证书有效期内即可"><a href="#方案二，修改时间到证书有效期内即可" class="headerlink" title="方案二，修改时间到证书有效期内即可"></a>方案二，修改时间到证书有效期内即可</h3><p>具体证书有效期是什么范围我也不太清楚，不过经我测试直接把年修改为2015即可成功安装<br><img data-src="https://qiniucdn.wayneshao.com/20180218224858/20180218105022336.png"></p>
]]></content>
      <categories>
        <category>踩坑笔记</category>
      </categories>
      <tags>
        <tag>软件心得</tag>
      </tags>
  </entry>
  <entry>
    <title>MVP——最小可行化产品</title>
    <url>/posts/13416.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="最简可行产品："><a href="#最简可行产品：" class="headerlink" title="最简可行产品："></a>最简可行产品：</h1><h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p><a href="https://zh.wikipedia.org/zh-cn/%E6%9C%80%E7%B0%A1%E5%8F%AF%E8%A1%8C%E7%94%A2%E5%93%81"><strong>最简可行产品</strong></a>（<em><strong>minimum viable product</strong></em>，简称<strong>MVP</strong>）是<strong>新产品开发</strong>中的名词，是指有部分机能，恰好可以让设计者表达其<strong>核心设计概念</strong>的产品。<br>设计者可以进行<strong>验证式学习</strong>，根据使用者的<strong>回馈</strong>，进一步<strong>了解使用情形</strong>，并且<strong>继续开发</strong>此产品 。<br>由最简可行产品来搜集相关想法常常会比开发有更多机能的产品要<strong>便宜</strong>。开发更多机能产品的的费用较高，也会有产品失败的风险（例如产品基本假设有误的情形）。<br>最简可行产品一词是由<strong>法兰克·罗宾生</strong>（<em><strong>Frank Robinson</strong></em>）创建，因<strong>史蒂夫·布兰克</strong>及<strong>埃里克·莱斯</strong>的使用而流行。</p>
<blockquote>
<p><em><strong>“要贩售愿景及提供最简可行产品给有远见的人，不是给所有的人。”</strong></em><br>——<strong>史蒂夫·布兰克</strong></p>
</blockquote>
<span id="more"></span>
<p><strong>MVP具有以下三个特点：</strong></p>
<ol>
<li>是一种避免开发出客户并不真正需要的产品的开发策略。</li>
<li>快速地构建出符合产品预期功能的最小功能集合，通过迭代来完善。</li>
<li>是让开发团队用最小的代价实现一个产品，以此最大程度上了解和验证对用户问题的解决程度。</li>
</ol>
<h2 id="设计技巧"><a href="#设计技巧" class="headerlink" title="设计技巧"></a>设计技巧</h2><ol>
<li>定位一致，满足<strong>核心需求</strong></li>
<li>体现<strong>核心竞争力/亮点</strong><br>只做核心功能（人无我有，人有我精）<br>快速试验亮点功能并获得第一批用户<br>例：支付宝初期核心功能为支付和担保交易</li>
<li><strong>成本尽可能低</strong><br>使用“轮子”，尽可能套用现有方案以快速实现</li>
</ol>
<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><p><strong>假设客户需要一辆汽车，我们应该使用什么样的流程完成骑车的开发呢？</strong></p>
<ol>
<li>传统软件开发流程中如上半部分图片的流程，我们会慢慢的将汽车的每一个部件按顺序制造出来，最终得到整个骑车。</li>
<li>MVP最小可行化产品设计流程中，我们应该意识到，客户需要一辆汽车的本质其实是需要一个出行工具，应该用最小的可以满足客户需求的方式实现用户出行的需求，然后再不断对工具进行迭代，最终得到一辆汽车。</li>
</ol>
<p>图示如下：</p>
<p><img data-src="https://qiniucdn.wayneshao.com/20181029225554434/20181030120041552.png"></p>
<p>最小可行化，即，不断获取可行化与最小化交集：<br><img data-src="https://qiniucdn.wayneshao.com/20181029225554434/20181030121542129.png"></p>
<h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><ul>
<li><strong>避免粗糙</strong>造成印象分扣减（注重MVP的体验，而不只是功能）</li>
<li><strong>避免切分范围太小</strong>达不到验证效果（需要完整的表达出需求）</li>
<li>保持<strong>与主要定位一致</strong>避免影响核心理念（体现出正确的价值）</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol>
<li>以用户问题为中心，而不是以解决方案为中心。</li>
<li>首先着眼于基本的客户需求，通过客户反馈，逐步修正产品设计和实现。</li>
<li>在各个迭代过程中，做出来的产品始终是可为客户所用的产品。</li>
</ol>
<p><img data-src="https://qiniucdn.wayneshao.com/20181029225554434/20181030121949833.png"></p>
]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
      <tags>
        <tag>产品</tag>
        <tag>MVP</tag>
        <tag>最小可行化</tag>
        <tag>最简可行</tag>
      </tags>
  </entry>
  <entry>
    <title>时隔两个月的B站宕机分析</title>
    <url>/posts/46313.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>　　本次的描述的主体是指发生在 2021 年 7 月 13 日晚上 23 点左右的，无响应时间持续约半小时左右，完全恢复时间约8小时的宕机事件。<br>　　<strong>本文内容是作者依据网上公开信息和个人在当时的体验综合分析而来，精确的时间线可能存在一定程度的错漏，仅代表作者本人的观点，如有雷同，纯属巧合。</strong><br> <span id="more"></span></p>
<h2 id="事件还原"><a href="#事件还原" class="headerlink" title="事件还原"></a>事件还原</h2><p>　　惭愧，当时就想写来着，结果一忙又忘了，刚刚才突然想起这回事儿，赶紧仔细回忆了下当晚的亲身经历，结合<span class="exturl" data-url="aHR0cHM6Ly93d3cuYmlsaWJpbGkuY29tL3JlYWQvY3YxMjE0MzI1OQ==">B站一位网友的总结<i class="fa fa-external-link-alt"></i></span>，拉出了我自己感知到的时间线，下面我们先来还原一下整个过程：</p>
<ul>
<li><strong>22:40</strong> 上传服务 502 ，主站访问正常。</li>
<li><strong>22:53</strong> 主站 502 。</li>
<li><strong>23:01</strong> 主站 404 ，此时网友发现，豆瓣、A站也疑似挂掉。</li>
<li><strong>23:05</strong> 有过短暂的恢复，很快又挂掉。</li>
<li><strong>23:14</strong> 主站页面可以显示，但是视频仍然无法加载。</li>
<li><strong>23:31</strong> B站主站基本恢复，并且大部分视频已经可以正常播放，推荐功能还未回复，首页不符合日常习惯。</li>
<li><strong>00:12</strong> 除了个人中心、投稿、直播等功能无法使用外，其余功能基本已经恢复。</li>
<li><strong>00:31</strong> 第一次登入个人中心！可惜随后又出现 502 错误。</li>
<li><strong>00:45</strong> 测试发现网页端点击评论区里的时间轴跳转链接不会跳转，可能是换了旧版本。</li>
<li><strong>00:53</strong> 客户端依然显示数据格式错误，网页端依然 502 。</li>
<li><strong>00:57</strong> 个人中心大部分功能已基本恢复，但是投稿管理、粉丝勋章、钱包管理等功能仍然无法使用。</li>
<li><strong>02:20</strong> B站官方号 <strong>哔哩哔哩弹幕网</strong> 发布公告：<blockquote>
<p>昨晚，B站的部分服务器机房发生故障，造成无法访问。技术团队随即进行了问题排查和修复，现在服务已经陆续恢复正常。<br>耽误大家看视频了，对不起！</p>
</blockquote>
</li>
<li><strong>06:48</strong> 此时B站功能已经彻底全部恢复正常。本次服务器宕机事件结束。</li>
</ul>
<h2 id="迟来两个月的分析"><a href="#迟来两个月的分析" class="headerlink" title="迟来两个月的分析"></a>迟来两个月的分析</h2><h2 id="事件分析"><a href="#事件分析" class="headerlink" title="事件分析"></a>事件分析</h2><p>　　实际看来，紧张的处理集中在 22:40 到 23:14 ，后续的就属于已经走上正轨了，所以我们重点分析这段时间。</p>
<ul>
<li><code>22:40 上传服务 502 ，主站访问正常。</code><br>根据实际宕机的情况来看，这个时间点应该是部分服务挂掉，这里应该就是官方公告所说的“机房故障”导致的。</li>
<li><code>22:53 主站 502 。</code><br>服务逐步的挂（这种表现来看，可能是火灾？脑补服务器一片一片的被点着），主站服务也挂了，这时候主站也变现为 502。</li>
<li><code>23:01 主站 404 ，此时网友发现，豆瓣、A站也疑似挂掉。</code><br>负载均衡也挂了，主站 404，同时间豆瓣和A站也挂掉了，网友戏称是B站宕机，巨大的流量降级压挂了友商，实际这个可能性不大，目前看来最靠谱的解释是，三家公司租用了同一家机房，一损俱损。</li>
<li><code>23:05 有过短暂的恢复，很快又挂掉。</code><br>短时间的恢复又挂掉，如果机房的问题是物理损坏，那这里启动的应该是冷备，如果只是断电且无UPS或者UPS状态异常，那可能就是启动了原服务，之所以恢复又挂掉，合理的推测是缓存没有准备好，用户又在不断地刷新，人工DDOS，服务刚起来，整个又给打挂了。</li>
<li><code>23:14 主站页面可以显示，但是视频仍然无法加载。</code><br>推测是重启之后又进行了一些流量重放来预热，再慢慢调整负载把真实流量放进来。</li>
</ul>
<h3 id="事件后看来十分打脸的分享"><a href="#事件后看来十分打脸的分享" class="headerlink" title="事件后看来十分打脸的分享"></a>事件后看来十分打脸的分享</h3><p>　　bilibili 的技术总监毛剑曾在腾讯云做过一次分享：<span class="exturl" data-url="aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9kZXZlbG9wZXIvYXJ0aWNsZS8xNjI1NDQx">bilibili技术总监毛剑：B站高可用架构实践<i class="fa fa-external-link-alt"></i></span>，阐述了B站的高可用架构实践，为我们本次宕机分析提供了部分素材。<br>　　通过分享的内容我们可以抓住 bilibili 架构的几个关键词：<strong>多集群</strong>、<strong>多层负载均衡</strong>、<strong>分布式限流</strong>、<strong>超时控制</strong>、<strong>重试退避</strong>。<br>　　PS：根据分享中提到的架构和实际对B站规模的感知，分析B站应该是有四位数以上服务器的集群。</p>
<h3 id="问题复盘"><a href="#问题复盘" class="headerlink" title="问题复盘"></a>问题复盘</h3><p>　　从毛剑的分享来看，bilibili 的高可用架构已经比较完善了，但是这次事件反映出一个很大的问题就是，<strong>有高可用，无容灾</strong>，他的所谓高可用都是在基础设施服务正常的前提下的，私以为直接归类到高性能也很合适，缺乏真正的高可用。遇到了这种针对硬件的物理不可抗力，在 bilibili 很明显是没有做异地多活和多机房的情况下，发生了停机半小时，无法正常提供服务接近八小时的严重事故。如果按八小时来算，今年别说4个9了，3个9都有点危险。</p>
<p>　　就 bilibili 事件来老生常谈一下业务系统高可用问题，当前实施高可用的经典方法依然是冗余，冗余越多，越能抵抗不可抗力。但是冗余往往代表着巨大的成本，系统可用性指数每增加一个9，需要的成本都是指数级的。<br>　　根据 bilibili 3 月 31 日发布的财报，2021 年依旧净亏损了 11.218 亿元人民币。<br>　　或许这才是 bilibili 此次宕机的真正元凶？</p>
]]></content>
      <categories>
        <category>偶有所得</category>
      </categories>
      <tags>
        <tag>B站</tag>
        <tag>宕机</tag>
        <tag>高可用</tag>
      </tags>
  </entry>
  <entry>
    <title>将可执行文件加入环境变量Path的新姿势——ShimGen</title>
    <url>/posts/46312.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>　　日常使用 Windows 系统时，如果需要在命令行中直接使用程序，则需要把程序的目录加到环境变量 Path 中，而很多时候，程序目录其实会包含很多程序的依赖文件，或者其他不适合在 Path 中的文件，每当有这种需求的时候都添加一条新的路径到 Path 中也不大友好，那么，如何操作，才能优雅又简单呢？<br><img data-src="https://qiniucdn.wayneshao.com/%E5%B0%86%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6%E5%8A%A0%E5%85%A5%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E7%9A%84%E6%96%B0%E5%A7%BF%E5%8A%BF%E2%80%94%E2%80%94/20210908101041646.png"><br>　　下面我借鉴 Windows 平台的老牌包管理工具 <span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmNob2NvbGF0ZXkub3JnL2VuLXVzLw==">Chocolatey<i class="fa fa-external-link-alt"></i></span> ，使用其内置的工具 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2Nob2NvbGF0ZXkvc2hpbWdlbg==">ShimGen<i class="fa fa-external-link-alt"></i></span> 来解决这个问题。</p>
<span id="more"></span>

<p><em><strong>计算机科学领域的任何问题都可以通过增加一个间接的中间层来解决</strong></em></p>
<h2 id="Chocolaty-添加环境变量原理分析"><a href="#Chocolaty-添加环境变量原理分析" class="headerlink" title="Chocolaty 添加环境变量原理分析"></a>Chocolaty 添加环境变量原理分析</h2><p>首先我们看一下 Chocolaty 是如何处理安装的不同包的可执行文件的环境变量操作的呢？<br>查看环境变量中 PATH 变量，可以很容易的找到其中 Chocolatey 的条目：<br><img data-src="https://qiniucdn.wayneshao.com/%E5%B0%86%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6%E5%8A%A0%E5%85%A5%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E7%9A%84%E6%96%B0%E5%A7%BF%E5%8A%BF%E2%80%94%E2%80%94/20210908032115525.png"><br>打开变量指向的目录查看（<code>C:\ProgramData\chocolatey\bin</code>）<br><img data-src="https://qiniucdn.wayneshao.com/%E5%B0%86%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6%E5%8A%A0%E5%85%A5%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E7%9A%84%E6%96%B0%E5%A7%BF%E5%8A%BF%E2%80%94%E2%80%94/20210908032359763.png"><br>发现都是各种 exe 可执行文件。<br>PS：此时文件夹中还没有 wget.exe 的执行文件。</p>
<p>下面我们安装常用 HttpGet 请求工具 wget<br><img data-src="https://qiniucdn.wayneshao.com/%E5%B0%86%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6%E5%8A%A0%E5%85%A5%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E7%9A%84%E6%96%B0%E5%A7%BF%E5%8A%BF%E2%80%94%E2%80%94/20210908030935170.png"><br>通过 Chocolatey 的日志，可以简单推断出，针对 wget 这种压缩包为程序包的程序，整个安装过程如下：</p>
<ol>
<li>下载程序的压缩包。</li>
<li>解压到 Chocolatey Tools 目录（可以配置，当前为 <code>C:\ProgramData\chocolatey\lib\</code>）。</li>
<li>使用 ShimGen 创建 wget.exe 到已配置环境变量的目录（C:\ProgramData\chocolatey\bin）</li>
</ol>
<h2 id="ShimGen？ShimGen！"><a href="#ShimGen？ShimGen！" class="headerlink" title="ShimGen？ShimGen！"></a>ShimGen？ShimGen！</h2><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2Nob2NvbGF0ZXkvc2hpbWdlbg==">ShimGen<i class="fa fa-external-link-alt"></i></span> 是 Chocolatey 曾经开源的一个工具，虽然按照协议，它只能被用于 Chocolatey，或者如果是开源项目，可以申请获取许可，但我是自己使用，而且我同时使用了Chocolatey，<em>暂时就就不管那么多了，后期我考虑自己重写一个类似的程序。</em></p>
<blockquote>
<p><strong>请不要商业使用 ShimGen，防止法律风险。</strong></p>
</blockquote>
<h3 id="ShimGen-是什么？"><a href="#ShimGen-是什么？" class="headerlink" title="ShimGen 是什么？"></a>ShimGen 是什么？</h3><p>详细介绍可以看<span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmNob2NvbGF0ZXkub3JnL2VuLXVzL2ZlYXR1cmVzL3NoaW0=">这里<i class="fa fa-external-link-alt"></i></span>，这里截取部分。<br><img data-src="https://qiniucdn.wayneshao.com/%E5%B0%86%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6%E5%8A%A0%E5%85%A5%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E7%9A%84%E6%96%B0%E5%A7%BF%E5%8A%BF%E2%80%94%E2%80%94/20210908052539719.png"><br>简而言之，就是可以用 ShimGen 来创建一个代理一样的链接可执行程序文件，完美满足我们的需求。<br>为了便于称呼，下文里我们会把生成后的文件称为<strong>代理可执行文件</strong>。</p>
<h3 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h3><p>找到 shimgen.exe 对应的文件夹，即 Chocolatey 安装目录下的 tools 文件夹。</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">.\shimgen.exe <span class="literal">--help</span></span><br></pre></td></tr></table></figure>
<p><img data-src="https://qiniucdn.wayneshao.com/%E5%B0%86%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6%E5%8A%A0%E5%85%A5%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E7%9A%84%E6%96%B0%E5%A7%BF%E5%8A%BF%E2%80%94%E2%80%94/20210908052939773.png"></p>
<h2 id="模仿游戏"><a href="#模仿游戏" class="headerlink" title="模仿游戏"></a>模仿游戏</h2><p>对于 Chocolatey 没有的软件包，或者我们希望自定义安装路径的包（Chocolatey 免费版本不支持自定义安装路径），我们也可以模仿 Chocolatey 的模式。</p>
<h3 id="建立环境变量文件夹"><a href="#建立环境变量文件夹" class="headerlink" title="建立环境变量文件夹"></a>建立环境变量文件夹</h3><p>首先，自己建立一个环境变量文件夹，用来安放 ShimGen 生成的代理可执行文件。我选择了目录 <code>D:\ProgramData\Bin</code>。<br><img data-src="https://qiniucdn.wayneshao.com/%E5%B0%86%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6%E5%8A%A0%E5%85%A5%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E7%9A%84%E6%96%B0%E5%A7%BF%E5%8A%BF%E2%80%94%E2%80%94/20210908053404536.png"></p>
<h3 id="使用-ShimGen-生成-ShimGen-的代理可执行文件"><a href="#使用-ShimGen-生成-ShimGen-的代理可执行文件" class="headerlink" title="使用 ShimGen 生成 ShimGen 的代理可执行文件"></a>使用 ShimGen 生成 ShimGen 的代理可执行文件</h3><p>注意：<strong>源文件路径请使用绝对路径</strong></p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> C:\ProgramData\chocolatey\tools\</span><br><span class="line">.\shimgen.exe <span class="literal">-p</span> C:\ProgramData\chocolatey\tools\shimgen.exe <span class="literal">-o</span> D:\ProgramData\Bin\shimgen.exe <span class="literal">--debug</span></span><br></pre></td></tr></table></figure>
<p><img data-src="https://qiniucdn.wayneshao.com/%E5%B0%86%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6%E5%8A%A0%E5%85%A5%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E7%9A%84%E6%96%B0%E5%A7%BF%E5%8A%BF%E2%80%94%E2%80%94/20210908055047821.png"></p>
<h3 id="测试效果"><a href="#测试效果" class="headerlink" title="测试效果"></a>测试效果</h3><p>新开一个控制台，这时候运行命令</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">shimgen <span class="literal">--help</span></span><br></pre></td></tr></table></figure>
<p><img data-src="https://qiniucdn.wayneshao.com/%E5%B0%86%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6%E5%8A%A0%E5%85%A5%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E7%9A%84%E6%96%B0%E5%A7%BF%E5%8A%BF%E2%80%94%E2%80%94/20210908055255914.png"></p>
<p>成功！</p>
]]></content>
      <categories>
        <category>偶有所得</category>
      </categories>
      <tags>
        <tag>ShimGen</tag>
        <tag>环境变量</tag>
      </tags>
  </entry>
  <entry>
    <title>新手正式入驻博客园</title>
    <url>/posts/63944.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="本人是计算机专业大二狗一枚，目前在学习C-，今天突发奇想，打算开一个博客，定期记录一些自己学习期间的心得，希望各位大牛能多多提点。"><a href="#本人是计算机专业大二狗一枚，目前在学习C-，今天突发奇想，打算开一个博客，定期记录一些自己学习期间的心得，希望各位大牛能多多提点。" class="headerlink" title="本人是计算机专业大二狗一枚，目前在学习C#，今天突发奇想，打算开一个博客，定期记录一些自己学习期间的心得，希望各位大牛能多多提点。"></a>本人是计算机专业大二狗一枚，目前在学习C#，今天突发奇想，打算开一个博客，定期记录一些自己学习期间的心得，希望各位大牛能多多提点。</h3><p><img data-src="https://qiniucdn.wayneshao.com/20180218125523/20180218125653974.png"></p>
]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
  </entry>
  <entry>
    <title>查看当前IP和归属地的方法</title>
    <url>/posts/2316.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>可以通过http协议进行get请求来获得当前IP及归属地信息。</p>
<span id="more"></span>
<h2 id="IPV4"><a href="#IPV4" class="headerlink" title="IPV4"></a>IPV4</h2><h3 id="ip138"><a href="#ip138" class="headerlink" title="ip138"></a><span class="exturl" data-url="aHR0cHM6Ly8yMDIxLmlwMTM4LmNvbS8=">ip138<i class="fa fa-external-link-alt"></i></span></h3><p>Xpath获取文字信息</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">//center</span><br></pre></td></tr></table></figure>
<p><img data-src="https://qiniucdn.wayneshao.com/20180219214549906/20180219095338344.png"></p>
<h3 id="whatismyip"><a href="#whatismyip" class="headerlink" title="whatismyip"></a><span class="exturl" data-url="aHR0cDovL3d3dy53aGF0aXNteWlwLmNvbS50dy8=">whatismyip<i class="fa fa-external-link-alt"></i></span></h3><p>Xpath获取信息:</p>
<ol>
<li>IP地址<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">//body/span[1]</span><br></pre></td></tr></table></figure></li>
<li>来源地区<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">//body/span[2]</span><br></pre></td></tr></table></figure>
<img data-src="https://qiniucdn.wayneshao.com/20180219214549906/20180219095925145.png"><h3 id="3322"><a href="#3322" class="headerlink" title="3322"></a><span class="exturl" data-url="aHR0cDovL21lbWJlcnMuMzMyMi5vcmcvZHluZG5zL2dldGlw">3322<i class="fa fa-external-link-alt"></i></span></h3>直接访问域名会跳转到pubyun（公云）服务商，推测可能是该云的用户搭建的服务。<h3 id="ZX"><a href="#ZX" class="headerlink" title="ZX"></a><span class="exturl" data-url="aHR0cDovL2lwLnp4aW5jLm9yZy9nZXRpcA==">ZX<i class="fa fa-external-link-alt"></i></span></h3>访问内容为ZX的个人网站，提供各种行政区划等数据，根据内容分析，站长可能是复旦的学生或者校友。<h3 id="CIP"><a href="#CIP" class="headerlink" title="CIP"></a><span class="exturl" data-url="aHR0cDovL2lwLmNpcC5jYy8=">CIP<i class="fa fa-external-link-alt"></i></span></h3>闽ICP备13019094号，根据备案信息来看，是一位名叫 林小波 的人的个人网站。<h3 id="DDNSPod"><a href="#DDNSPod" class="headerlink" title="DDNSPod"></a><span class="exturl" data-url="aHR0cDovL2lwdjQuZGRuc3BvZC5jb20v">DDNSPod<i class="fa fa-external-link-alt"></i></span></h3><span class="exturl" data-url="aHR0cHM6Ly93d3cuZGRuc3BvZC5jb20v">DDNSPod<i class="fa fa-external-link-alt"></i></span> 提供的服务。<h3 id="ifcfg"><a href="#ifcfg" class="headerlink" title="ifcfg"></a><a href="ifcfg.cn/echo">ifcfg</a></h3>ifcfg.cn 提供 Json 格式的数据<h3 id="东北大学"><a href="#东北大学" class="headerlink" title="东北大学"></a><span class="exturl" data-url="aHR0cDovL3NwZWVkLm5ldS5lZHUuY24vZ2V0SVAucGhw">东北大学<i class="fa fa-external-link-alt"></i></span></h3>东北大学提供的接口，稳定性一般。<h3 id="花生壳"><a href="#花生壳" class="headerlink" title="花生壳"></a><span class="exturl" data-url="aHR0cDovL2RkbnMub3JheS5jb20vY2hlY2tpcA==">花生壳<i class="fa fa-external-link-alt"></i></span></h3>花生壳的服务。<h3 id="万网"><a href="#万网" class="headerlink" title="万网"></a><span class="exturl" data-url="aHR0cDovL3d3dy5uZXQuY24vc3RhdGljL2N1c3RvbWVyY2FyZS95b3VyaXAuYXNw">万网<i class="fa fa-external-link-alt"></i></span></h3>万网的服务，现在是阿里系了。返回的是HTML，需要自己解析。</li>
</ol>
<p>###<span class="exturl" data-url="aHR0cHM6Ly9hcGkubXlpcC5sYS8=">MyIP<i class="fa fa-external-link-alt"></i></span><br>MyIP的服务。</p>
<h2 id="IPV6"><a href="#IPV6" class="headerlink" title="IPV6"></a>IPV6</h2><h3 id="ZX-1"><a href="#ZX-1" class="headerlink" title="ZX)"></a><span class="exturl" data-url="aHR0cDovL3Y2LmlwLnp4aW5jLm9yZy9nZXRpcA==">ZX<i class="fa fa-external-link-alt"></i></span>)</h3><p>同样是ZX个人网站提供的服务。</p>
<h3 id="ip-sb"><a href="#ip-sb" class="headerlink" title="ip.sb"></a><span class="exturl" data-url="aHR0cDovL2lwLnNiLw==">ip.sb<i class="fa fa-external-link-alt"></i></span></h3><p>SB Professional Services, LLC，还可以用<span class="exturl" data-url="aHR0cDovL2FwaS1pcHY2LmlwLnNiL2lw">这个地址<i class="fa fa-external-link-alt"></i></span></p>
<h3 id="DDNSPod-1"><a href="#DDNSPod-1" class="headerlink" title="DDNSPod"></a><span class="exturl" data-url="aHR0cHM6Ly9pcHY2LmRkbnNwb2QuY29tLw==">DDNSPod<i class="fa fa-external-link-alt"></i></span></h3><p><span class="exturl" data-url="aHR0cHM6Ly93d3cuZGRuc3BvZC5jb20v">DDNSPod<i class="fa fa-external-link-alt"></i></span> 提供的服务。</p>
<h3 id="东北大学-1"><a href="#东北大学-1" class="headerlink" title="东北大学"></a><span class="exturl" data-url="aHR0cHM6Ly9zcGVlZC5uZXU2LmVkdS5jbi9nZXRJUC5waHA=">东北大学<i class="fa fa-external-link-alt"></i></span></h3><p>东北大学提供的接口，稳定性一般。</p>
<h3 id="MyIP"><a href="#MyIP" class="headerlink" title="MyIP"></a><span class="exturl" data-url="aHR0cHM6Ly92Ni5teWlwLmxhL2pzb24=">MyIP<i class="fa fa-external-link-alt"></i></span></h3><p>返回的是 Json 格式</p>
]]></content>
      <categories>
        <category>踩坑笔记</category>
      </categories>
      <tags>
        <tag>爬虫</tag>
        <tag>软件心得</tag>
        <tag>IP</tag>
      </tags>
  </entry>
  <entry>
    <title>用户无感知更新</title>
    <url>/posts/9411.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>公司目前的整个CI体系都是使用了GitLab的全家桶，基本已经趋于完善，目前最大的问题是每次发版都需要停机处理，用户感知明显，所以多数时候发版的时间都集中在晚上十点以后，故而决定设法解决这个问题。</p>
<span id="more"></span>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>目前整套服务里，部分环境单体，部分环境负载均衡，均使用原生部署，K8S的滚动更新可以解决这个问题，但是目前的状况和K8S无疑还有很大的距离，负载均衡环境中可以一台台逐步更新，但因为实际情况中还涉及到了单体的情况，所以思路就分成了两条：</p>
<ol>
<li>所有的服务都采用负载均衡部署，即使是只有单个API服务，单个API服务在发版时，启动一个新的API服务并加入负载，健康检查合格后，杀死旧的API进程，让服务无痕切换。多个API服务跟以上类似，只不过无需杀死服务，而可以直接将待操作服务的负载全部转到其他服务，直接停掉待操作服务操作。</li>
<li>保持原有整个架构不变，但是在原本的 负载均衡/反向代理 和 API服务 中间加一层端口转发，端口转发服务监听和 负载均衡/反向代理 交互的 端口，API服务采用不固定端口模式，在启用且健康检查合格后才通知端口转发服务将通讯端口转发到新服务的端口上。<br>基于现有情况考虑，决定采用第二种思路，为了保证统一性，端口转发依然采用nginx。</li>
</ol>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>整理整个过程为：<br>获取随机可用端口 -&gt; 使用端口启动服务 -&gt; 健康检查 -&gt; 切换端口</p>
<h3 id="获取随机可用端口"><a href="#获取随机可用端口" class="headerlink" title="获取随机可用端口"></a>获取随机可用端口</h3><p>这里我是用Shell脚本做了对应的处理，具体脚本如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># portRange=&quot;80-81&quot; 	# 可用于读取配置文件</span></span><br><span class="line"><span class="comment"># rangeStart=$(echo $&#123;portRange&#125; | awk -F &#x27;-&#x27; &#x27;&#123;print $1&#125;&#x27;)</span></span><br><span class="line"><span class="comment"># rangeEnd=$(echo $&#123;portRange&#125; | awk -F &#x27;-&#x27; &#x27;&#123;print $2&#125;&#x27;)</span></span><br><span class="line"></span><br><span class="line">rangeStart=<span class="variable">$1</span></span><br><span class="line">rangeEnd=<span class="variable">$2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$1</span> -le <span class="variable">$2</span> ]; <span class="keyword">then</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;123&quot;</span> &gt;/dev/null</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;error: please check port range&quot;</span></span><br><span class="line">	<span class="built_in">exit</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">PORT=0</span><br><span class="line"><span class="comment"># 判断当前端口是否被占用，没被占用返回0，反之1</span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">Listening</span></span>() &#123;</span><br><span class="line">	TCPListeningnum=$(netstat -an | grep <span class="string">&quot;:<span class="variable">$1</span> &quot;</span> | awk <span class="string">&#x27;$1 == &quot;tcp&quot; &amp;&amp; $NF == &quot;LISTEN&quot; &#123;print $0&#125;&#x27;</span> | <span class="built_in">wc</span> -l)</span><br><span class="line">	UDPListeningnum=$(netstat -an | grep <span class="string">&quot;:<span class="variable">$1</span> &quot;</span> | awk <span class="string">&#x27;$1 == &quot;udp&quot; &amp;&amp; $NF == &quot;0.0.0.0:*&quot; &#123;print $0&#125;&#x27;</span> | <span class="built_in">wc</span> -l)</span><br><span class="line">	((Listeningnum = TCPListeningnum + UDPListeningnum))</span><br><span class="line">	<span class="keyword">if</span> [ <span class="variable">$Listeningnum</span> == 0 ]; <span class="keyword">then</span></span><br><span class="line">		<span class="built_in">echo</span> <span class="string">&quot;0&quot;</span></span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="built_in">echo</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定区间随机数</span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">random_range</span></span>() &#123;</span><br><span class="line">	<span class="built_in">shuf</span> -i <span class="variable">$1</span>-<span class="variable">$2</span> -n1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 得到随机端口</span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">get_random_port</span></span>() &#123;</span><br><span class="line">	templ=0</span><br><span class="line">	<span class="keyword">while</span> [ <span class="variable">$PORT</span> == 0 ]; <span class="keyword">do</span></span><br><span class="line">		temp1=$(random_range <span class="variable">$1</span> <span class="variable">$2</span>)</span><br><span class="line">		<span class="keyword">if</span> [ $(Listening <span class="variable">$temp1</span>) == 0 ]; <span class="keyword">then</span></span><br><span class="line">			PORT=<span class="variable">$temp1</span></span><br><span class="line">		<span class="keyword">fi</span></span><br><span class="line">	<span class="keyword">done</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$PORT</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># main</span></span><br><span class="line">get_random_port <span class="variable">$&#123;rangeStart&#125;</span> <span class="variable">$&#123;rangeEnd&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>注意：依赖了指令netstat，需要安装对应的包</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Debian/Ubuntu</span></span><br><span class="line">apt install -y net-tools</span><br><span class="line"><span class="comment"># CentOS/Redhat</span></span><br><span class="line">yum install -y net-tools</span><br></pre></td></tr></table></figure>
<p>调用逻辑：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> AVAILABLE_PORT=$(/opt/script/check/available_port.sh 8000 9000)</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$AVAILABLE_PORT</span></span><br></pre></td></tr></table></figure>
<h2 id="使用对应端口启动服务"><a href="#使用对应端口启动服务" class="headerlink" title="使用对应端口启动服务"></a>使用对应端口启动服务</h2><p>因为已经使用了PM2作为 Daemon ，所以无法使用启动参数的形式以命令行把口传给服务了，有些服务器上不止放了一个服务，故而全局环境变量的思路也可能不行，最终选择了使用Shell命令修改配置文件中的绑定地址</p>
<p>此处用到了健康检查的脚本 api_health_check.sh ，具体实现如下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">url=<span class="variable">$1</span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"><span class="comment">#定义函数check_http：</span></span><br><span class="line"><span class="comment">#使用curl命令检查http服务器的状态</span></span><br><span class="line"><span class="comment">#-m设置curl不管访问成功或失败，最大消耗的时间为5秒，5秒连接服务为相应则视为无法连接</span></span><br><span class="line"><span class="comment">#-s设置静默连接，不显示连接时的连接速度、时间消耗等信息</span></span><br><span class="line"><span class="comment">#-o将curl下载的页面内容导出到/dev/null(默认会在屏幕显示页面内容)</span></span><br><span class="line"><span class="comment">#-w设置curl命令需要显示的内容%&#123;http_code&#125;，指定curl返回服务器的状态码</span></span><br><span class="line"><span class="function"><span class="title">check_http</span></span>()&#123;</span><br><span class="line">    status_code=$(curl -m 5 -s -o /dev/null -w %&#123;http_code&#125; <span class="variable">$url</span>)</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">for</span> varible1 <span class="keyword">in</span> &#123;1..25&#125;</span><br><span class="line"><span class="comment">#for varible1 in 1 2 3 4 5</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">     check_http</span><br><span class="line">       <span class="built_in">date</span>=$(<span class="built_in">date</span> +%Y%m%d-%H:%M:%S) </span><br><span class="line">        <span class="comment">#生成报警邮件的内容</span></span><br><span class="line">       <span class="built_in">echo</span> <span class="string">&quot;当前时间为:<span class="variable">$date</span></span></span><br><span class="line"><span class="string">       <span class="variable">$url</span>服务器异常,状态码为<span class="variable">$&#123;status_code&#125;</span>.</span></span><br><span class="line"><span class="string">       请尽快排查异常.&quot;</span> &gt; /tmp/http$$.pid</span><br><span class="line">        <span class="comment">#指定测试服务器状态的函数，并根据返回码决定是发送邮件报警还是将正常信息写入日志</span></span><br><span class="line">       <span class="keyword">if</span> [ <span class="variable">$status_code</span> -ne 200 ];<span class="keyword">then</span></span><br><span class="line">            <span class="keyword">if</span> [ <span class="variable">$&#123;varible1&#125;</span> -lt 20 ];<span class="keyword">then</span></span><br><span class="line">                <span class="built_in">echo</span> 1</span><br><span class="line">                <span class="built_in">sleep</span> 1</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="built_in">echo</span> <span class="variable">$varible1</span></span><br><span class="line">                <span class="built_in">sleep</span> <span class="variable">$varible1</span></span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">       <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$url</span>连接正常&quot;</span></span><br><span class="line">            <span class="built_in">exit</span> 0</span><br><span class="line">       <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">exit</span> 1</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 获取版本 自增版本号</span></span><br><span class="line"><span class="keyword">if</span> [ ! -f <span class="string">&quot;/opt/rolling-update/ShortUrl.current&quot;</span> ]; <span class="keyword">then</span> <span class="built_in">echo</span> 0 &gt; /opt/rolling-update/ShortUrl.current; <span class="built_in">export</span> CURRENT_VERSION=A; <span class="built_in">export</span> NEXT_VERSION=0; <span class="keyword">else</span> <span class="built_in">export</span> CURRENT_VERSION=$(<span class="built_in">cat</span> /opt/rolling-update/ShortUrl.current); (<span class="built_in">echo</span> <span class="variable">$CURRENT_VERSION</span>| awk <span class="string">&#x27;&#123;print (int($0)+1)%5&#125;&#x27;</span>)  &gt; /opt/rolling-update/ShortUrl.current; <span class="built_in">export</span> NEXT_VERSION=$(<span class="built_in">cat</span> /opt/rolling-update/ShortUrl.current); <span class="keyword">fi</span></span><br><span class="line"><span class="comment"># 新建新版本文件夹</span></span><br><span class="line"><span class="built_in">mkdir</span> ~/ShortUrl<span class="variable">$NEXT_VERSION</span></span><br><span class="line"><span class="comment"># 发布</span></span><br><span class="line">dotnet publish -c Release --output bin/publish</span><br><span class="line"><span class="built_in">cd</span> bin/publish</span><br><span class="line">zip -r <span class="variable">$COMMIT_TIME_STR</span>.zip ./</span><br><span class="line"><span class="comment"># PUSH文件</span></span><br><span class="line">lftp sftp://<span class="variable">$DEV_URL</span> -e <span class="string">&quot;user <span class="variable">$PUB_USER</span> <span class="variable">$DEV_PASS</span>; cd /~/ShortUrl<span class="variable">$NEXT_VERSION</span>; put <span class="variable">$COMMIT_TIME_STR</span>.zip; bye&quot;</span></span><br><span class="line"><span class="comment"># 替换配置文件中的端口</span></span><br><span class="line"><span class="built_in">cd</span> ~/ShortUrl<span class="variable">$NEXT_VERSION</span></span><br><span class="line">sed -E <span class="string">&quot;s|http[^\&quot;^\&#x27;]*:8750|http://*:<span class="variable">$AVAILABLE_PORT</span>|g&quot;</span> appsettings.json -i.bak</span><br><span class="line"><span class="comment"># 启动 Daemon 监听</span></span><br><span class="line">pm2 start <span class="string">&quot;dotnet ShortUrl.dll&quot;</span> --name ShortUrl<span class="variable">$NEXT_VERSION</span> --<span class="built_in">env</span>=&#123;<span class="string">&quot;ASPNETCORE_ENVIRONMENT&quot;</span>:<span class="string">&quot;Development&quot;</span>&#125;</span><br><span class="line"><span class="comment"># 健康检查</span></span><br><span class="line">/opt/script/check/api_health.sh http://127.0.0.1:<span class="variable">$AVAILABLE_PORT</span>/healthz</span><br><span class="line"><span class="comment"># 切换代理</span></span><br><span class="line"><span class="built_in">rm</span> -Rf /etc/nginx/port_transfer/stm/short_url.stm;</span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;upstream short-url&#123; server 127.0.0.1:<span class="variable">$AVAILABLE_PORT</span>; &#125;&quot;</span> &gt;&gt; /etc/nginx/port_transfer/stm/short_url.stm;</span><br><span class="line">nginx -t;</span><br><span class="line">nginx -s reload;</span><br><span class="line"><span class="comment"># 等待时间</span></span><br><span class="line"><span class="built_in">sleep</span> 5</span><br><span class="line"><span class="comment"># 杀死旧进程</span></span><br><span class="line">pm2 stop ShortUrl<span class="variable">$CURRENT_VERSION</span></span><br><span class="line">pm2 del ShortUrl<span class="variable">$CURRENT_VERSION</span></span><br><span class="line">pm2 save</span><br><span class="line"><span class="comment"># 清除旧版文件</span></span><br><span class="line"><span class="built_in">rm</span> -Rf ~/ShortUrl<span class="variable">$CURRENT_VERSION</span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>踩坑笔记</category>
      </categories>
      <tags>
        <tag>GitLab</tag>
        <tag>SRE</tag>
        <tag>持续集成</tag>
      </tags>
  </entry>
  <entry>
    <title>模块化InnoSetup依赖项安装</title>
    <url>/posts/24425.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>原文在这里:<span class="exturl" data-url="aHR0cDovL3d3dy5jb2RlcHJvamVjdC5jb20vQXJ0aWNsZXMvMjA4NjgvTkVULUZyYW1ld29yay1JbnN0YWxsZXItZm9yLUlubm9TZXR1cA==">http://www.codeproject.com/Articles/20868/NET-Framework-Installer-for-InnoSetup<i class="fa fa-external-link-alt"></i></span></p>
<p>源文件地址:<span class="exturl" data-url="aHR0cDovL3d3dy5jb2RlcHJvamVjdC5jb20vS0IvaW5zdGFsbC9kb3RuZXRmeF9pbm5vc2V0dXBfaW5zdGFsL2lubm9kZXBlbmRlbmN5aW5zdGFsbGVyLnppcA==">http://www.codeproject.com/KB/install/dotnetfx_innosetup_instal/innodependencyinstaller.zip<i class="fa fa-external-link-alt"></i></span></p>
<p>源文件需要注册登录CodeProject才能下载</p>
<span id="more"></span>
<p><img data-src="https://qiniucdn.wayneshao.com/20180218232333/20180218112438669.png"><br><img data-src="https://qiniucdn.wayneshao.com/20180218232333/20180218112442373.png"></p>
<p><strong>说明:<br>通过添加模块化innosetup脚本来自动下载和安装各种依赖项 如.NET Framework 、VC++运行环境等。</strong></p>
<p>源代码是模块化的，结构如下：<br><img data-src="https://qiniucdn.wayneshao.com/20180218232333/20180218112524045.png"></p>
<ul>
<li><p>setup.iss - 包含基本设置，其中包含所需的模块（产品）。<br> 你需要把所需的模块在顶部使用#include命令包含在源代码中,例如：<br> #include “scripts\products\dotnetfx11.iss”<br> 然后你只需要在[Code]段调用它们的main函数,如：<br> dotnetfx11();</p>
</li>
<li><p>bin - 包含安装程序的最终输出</p>
</li>
<li><p>src - 包含您的程序的应用程序文件</p>
</li>
<li><p>scripts</p>
<ul>
<li>products.iss - 包含产品脚本的共享代码。 您只需要更改[CustomMessages]部分和[Files]部分（包括isxdl语言文件）</li>
<li>isxdl - 包含用于设置（如果有要下载的内容）及其语言文件（例如german.ini）的下载器DLL。 这是您可以放置​​isxdldownloader的语言文件的地方。</li>
<li>products - 包含应用程序所需的产品的脚本（例如.NET Framework 2.0）<ul>
<li>dotnetfx11.iss - .NET Framework 1.1</li>
<li>dotnetfx11lp.iss - .NET Framework 1.1 Language Pack</li>
<li>dotnetfx11sp1.iss - .NET Framework 1.1 + Service Pack 1</li>
<li>dotnetfx20.iss - .NET Framework 2.0</li>
<li>dotnetfx20lp.iss - .NET Framework 2.0 Language Pack</li>
<li>dotnetfx20sp1.iss - .NET Framework 2.0 + Service Pack 1</li>
<li>dotnetfx20sp1lp.iss - .NET Framework 2.0 Service Pack 1 Language Pack</li>
<li>dotnetfx20sp2.iss - .NET Framework 2.0 + Service Pack 2</li>
<li>dotnetfx20sp2lp.iss - .NET Framework 2.0 Service Pack 2 Language Pack</li>
<li>dotnetfx35.iss - .NET Framework 3.5</li>
<li>dotnetfx35lp.iss - .NET Framework 3.5 Language Pack</li>
<li>dotnetfx35sp1.iss - .NET Framework 3.5 + Service Pack 1</li>
<li>dotnetfx35sp1lp.iss - .NET Framework 3.5 Service Pack 1 Language Pack</li>
<li>dotnetfx40client.iss - .NET Framework 4.0 Client Profile</li>
<li>dotnetfx40full.iss - .NET Framework 4.0 Full</li>
<li>dotnetfx46.iss - .NET Framework 4.6</li>
<li>ie6.iss - Internet Explorer 6</li>
<li>iis.iss - Internet Information Services (just a check if it is installed)</li>
<li>jet4sp8.iss - Jet 4 + Service Pack 8</li>
<li>kb835732.iss - Security Update (KB835732) which is required by .NET Framework 2.0 Service Pack 1 on Windows 2000 Service Pack 4</li>
<li>mdac28.iss - Microsoft Data Access Components (MDAC) 2.8</li>
<li>msi20.iss - Windows Installer 2.0</li>
<li>msi31.iss - Windows Installer 3.1</li>
<li>msi45.iss - Windows Installer 4.5</li>
<li>sql2005express.iss - SQL Server 2005 Express + Service Pack 3</li>
<li>sql2008express.iss - SQL Server 2008 Express R2</li>
<li>sqlcompact35sp2.iss - SQL Server Compact 3.5 + Service Pack 2</li>
<li>vcredist2005.iss - Visual C++ 2005 Redistributable</li>
<li>vcredist2008.iss - Visual C++ 2008 Redistributable</li>
<li>vcredist2010.iss - Visual C++ 2010 Redistributable</li>
<li>vcredist2012.iss - Visual C++ 2012 Redistributable</li>
<li>vcredist2013.iss - Visual C++ 2013 Redistributable</li>
<li>vcredist2015.iss - Visual C++ 2015 Redistributable</li>
<li>wic.iss - Windows Imaging Component</li>
<li>winversion.iss - helper functions to determine the installed Windows version</li>
<li>fileversion.iss - helper functions to determine the version of a file</li>
<li>stringversion.iss - helper functions to correctly parse a version string</li>
<li>dotnetfxversion.iss - helper functions to determine the installed .NET Framework version including service packs</li>
<li>msiproduct.iss - helper functions to check for installed msi products</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>你很可能需要调整setup.iss，以适应不同Windows版本所需的依赖项。</p>
<p>如果依赖项没有安装，安装过程会检查相关依赖项的安装文件是否存在于.\MyProgramDependencies.文件夹下。如果不存在那么程序将会自动下载。<br><img data-src="https://qiniucdn.wayneshao.com/20180218232333/20180218112911329.png"><br><img data-src="https://qiniucdn.wayneshao.com/20180218232333/20180218112917754.png"><br>用于脚本的应用程序包括：</p>
<ul>
<li><span class="exturl" data-url="aHR0cDovL3d3dy5qcnNvZnR3YXJlLm9yZy9pc2luZm8ucGhw">Inno Setup<i class="fa fa-external-link-alt"></i></span> - (版本5.5.5)</li>
<li><span class="exturl" data-url="aHR0cDovL3d3dy5pc3Rvb2wub3JnL2RlZmF1bHQuYXNweA==">ISTool<i class="fa fa-external-link-alt"></i></span> -  Inno Setup的扩展组件。但是我只需要 isxdl.dll downloader (版本5.3.0)</li>
</ul>
]]></content>
      <categories>
        <category>踩坑笔记</category>
      </categories>
      <tags>
        <tag>InnoSetup</tag>
        <tag>安装包</tag>
      </tags>
  </entry>
  <entry>
    <title>汇总一下 Visual Studio 各个版本的 Key</title>
    <url>/posts/28460.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>方便日后查用，汇总一下 Visual Studio 各个版本的 Key。如果侵犯了您或您公司的权益，请<span class="exturl" data-url="bWFpbHRvOi8vb3duZXJAd2F5bmVzaGFvLmNvbQ==">联系我<i class="fa fa-external-link-alt"></i></span>删除。</p>
<span id="more"></span>
<h2 id="Visual-Studio-2022"><a href="#Visual-Studio-2022" class="headerlink" title="Visual Studio 2022"></a>Visual Studio 2022</h2><p>Visual Studio 2019 Enterprise:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">VHF9H-NXBBB-638P6-6JHCY-88JWH</span><br></pre></td></tr></table></figure>
<p>Visual Studio 2022 Professional:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">TD244-P4NB7-YQ6XK-Y8MMM-YWV2J</span><br></pre></td></tr></table></figure>
<h2 id="Visual-Studio-2019"><a href="#Visual-Studio-2019" class="headerlink" title="Visual Studio 2019"></a>Visual Studio 2019</h2><p>Visual Studio 2019 Enterprise:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">BF8Y8-GN2QH-T84XB-QVY3B-RC4DF</span><br></pre></td></tr></table></figure>
<p>Visual Studio 2019 Professional:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">NYWVH-HT4XC-R2WYW-9Y3CM-X4V3Y</span><br></pre></td></tr></table></figure>

<h2 id="Visual-Studio-2017"><a href="#Visual-Studio-2017" class="headerlink" title="Visual Studio 2017"></a>Visual Studio 2017</h2><p>Visual Studio 2017 Professional:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">KBJFW-NXHK6-W4WJM-CRMQB-G3CDH</span><br><span class="line">HMGNV-WCYXV-X7G9W-YCX63-B98R2</span><br><span class="line">HFDVM-KS3K9-OKYN1-N1ZS7-PVSQ8</span><br><span class="line">96OLO-CXFRC-16CKR-Y1933-04MX6</span><br><span class="line">7VMX9-TI69C-NXRG0-S4T89-9ABS4</span><br><span class="line">70I9S-MIZ6L-RPH8Q-Q9C70-XQPRT</span><br></pre></td></tr></table></figure>

<p>Visual Studio 2017 Enterprise:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">NJVYC-BMHX2-G77MM-4XJMR-6Q8QF</span><br><span class="line">IOX0M-LAVBL-FPHQY-N0ROK-9K3MD</span><br><span class="line">4SB42-1Q0ZT-CMBDT-TN2XI-FIET1</span><br><span class="line">7Z16L-372ES-M15YD-O8QM7-V6C25</span><br><span class="line">EBVI7-26CXQ-3CQD4-ZS3IR-6Q3K5</span><br><span class="line">7BHBQ-3NNHM-I4ROB-R7L02-ZOSFM</span><br></pre></td></tr></table></figure>

<p>Visual Studio 2017 Enterprise:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">NJVYC-BMHX2-G77MM-4XJMR-6Q8QF</span><br><span class="line">CXP3Q-XKCIN-GXDTX-O369X-ALFPK</span><br><span class="line">AF7CS-PO8AZ-YL4GI-C95BV-9QXCN</span><br><span class="line">643OA-ACK9A-8N2NH-6YB8R-1OM0X</span><br><span class="line">328DP-Y1I77-DXNCM-L3XVT-7M89B</span><br><span class="line">BNZLP-XK60H-MT0SG-2L790-Q87Z7</span><br></pre></td></tr></table></figure>

<h2 id="Visual-Studio-2015"><a href="#Visual-Studio-2015" class="headerlink" title="Visual Studio 2015"></a>Visual Studio 2015</h2><p>Visual Studio 2015 Enterprise:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">2XNFG-KFHR8-QV3CP-3W6HT-683CH</span><br></pre></td></tr></table></figure>

<p>Visual Studio 2015 Professional:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">HMGNV-WCYXV-X7G9W-YCX63-B98R2</span><br></pre></td></tr></table></figure>

<h2 id="Visual-Studio-2013"><a href="#Visual-Studio-2013" class="headerlink" title="Visual Studio 2013"></a>Visual Studio 2013</h2><p>Visual Studio 2013 Ultimate:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">BWG7X-J98B3-W34RT-33B3R-JVYW9</span><br><span class="line">87DQC-G8CYR-CRPJ4-QX9K8-RFV2B</span><br></pre></td></tr></table></figure>

<p>Visual Studio 2013 Team Foundation Server:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">6T3MC-YX8XF-7CWXW-462TQ-8G2B4</span><br></pre></td></tr></table></figure>

<p>Visual Studio 2013 Premium:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">FBJVC-3CMTX-D8DVP-RTQCT-92494</span><br></pre></td></tr></table></figure>

<p>Visual Studio 2013 Professional:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">KCQWK-Q43V3-M3F2T-83VGV-Y6VTX</span><br></pre></td></tr></table></figure>

<p>Visual Studio 2013 Test Professional:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">TTDB9-9YPYH-7FBVY-X2CTQ-D8F2H</span><br></pre></td></tr></table></figure>

<p>Visual Studio 2013 Premium &amp; Express:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">P27TG-XXX2W-XK8TK-QD9FK-V36W4</span><br></pre></td></tr></table></figure>

<h2 id="Visual-Studio-2012"><a href="#Visual-Studio-2012" class="headerlink" title="Visual Studio 2012"></a>Visual Studio 2012</h2><p>Visual Studio 2012 Ultimate:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">RBCXF-CVBGR-382MK-DFHJ4-C69G8</span><br></pre></td></tr></table></figure>

<p>Visual Studio 2012 Professional:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">4D974-9QX42-9Y43G-YJ7JG-JDYBP</span><br></pre></td></tr></table></figure>

<p>Visual Studio 2012 Premium:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">MH2FR-BC9R2-84433-47M63-KQVWC</span><br></pre></td></tr></table></figure>

<h2 id="Visual-Studio-2010"><a href="#Visual-Studio-2010" class="headerlink" title="Visual Studio 2010"></a>Visual Studio 2010</h2><p>Visual Studio 2010 Ultimate:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">YCFHQ-9DWCY-DKV88-T2TMH-G7BHP</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>闹着玩儿</category>
      </categories>
      <tags>
        <tag>VS</tag>
        <tag>VisualStudio</tag>
        <tag>Key</tag>
      </tags>
  </entry>
  <entry>
    <title>编写高质量C#程序的建议（1-5）</title>
    <url>/posts/61676.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>　　最近开始阅读<span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vbHVtaW5qaS8=">陆敏技先生<i class="fa fa-external-link-alt"></i></span>在<span class="exturl" data-url="aHR0cDovL3d3dy5jbXBlZHUuY29tLw==">机械工业出版社<i class="fa fa-external-link-alt"></i></span>出版的<span class="exturl" data-url="aHR0cHM6Ly9pdGVtLmpkLmNvbS8xMDg2MDI4NC5odG1s">《编写高质量代码：改善C#程序的157个建议》<i class="fa fa-external-link-alt"></i></span>一书，打算把其中涉及的所有的观点做一下总结和分析，用于总结和事后翻阅，如果有侵权请联系我删除。</p>
<h2 id="建议一：正确操作字符串"><a href="#建议一：正确操作字符串" class="headerlink" title="建议一：正确操作字符串"></a>建议一：正确操作字符串</h2><h3 id="确保尽量小的装箱"><a href="#确保尽量小的装箱" class="headerlink" title="确保尽量小的装箱"></a>确保尽量小的装箱</h3><p>　　在自己编写的代码中，应当尽可能地避免编写不必要的装箱代码。</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> str1 = <span class="string">&quot;str1&quot;</span> + <span class="number">9</span>;</span><br><span class="line"><span class="keyword">var</span> str2 = <span class="string">&quot;str2&quot;</span> + <span class="number">9.</span>ToString();</span><br></pre></td></tr></table></figure>
<p>　　第一句代码中，+ 连接时是将 值类型 int 转换为 引用类型 string 之后在进行 Concat 操作，故而性能更差。</p>
<p>　　装箱之所以带来性能损耗的原因是，装箱需要以下三个步骤：</p>
<ol>
<li>首先，会为值类型在托管堆中分配内存。除了值类型本身所分配的内存外，内存总量还要加上类型对象指针和同步块索引所占用的内存。</li>
<li>将值类型的值复制到新分配的堆内存中。</li>
<li>返回已经成为引用类型的对象的地址。</li>
</ol>
<h3 id="避免分配额外的内存空间"><a href="#避免分配额外的内存空间" class="headerlink" title="避免分配额外的内存空间"></a>避免分配额外的内存空间</h3><p>　　频繁的进行字符串的拼接操作时，最好使用 StringBuilder，字符串的任何方法或者进行任何运算都会在内存中创建一个新的字符串对象。</p>
<h2 id="建议二：使用默认转型方法"><a href="#建议二：使用默认转型方法" class="headerlink" title="建议二：使用默认转型方法"></a>建议二：使用默认转型方法</h2><ol>
<li>使用类型的转换运算符。</li>
<li>使用类型内置的 Parse、TryParse，或者如 ToString、ToDouble 和 ToDateTime 等方法。</li>
<li>使用帮助类提供的方法。</li>
<li>使用 CLR 支持的转型</li>
</ol>
<h2 id="建议三：区别对待强制转型与-as-和-is"><a href="#建议三：区别对待强制转型与-as-和-is" class="headerlink" title="建议三：区别对待强制转型与 as 和 is"></a>建议三：区别对待强制转型与 as 和 is</h2><ol>
<li>如果类型之间都上溯到了某个共同的基类，那么根据此基类进行的转型（即基类转型为子类本身）应该使用 as。子类与子类之间的转型，则应该提供转换操作符，以便进行强制转型。</li>
<li>as 操作符永远不会抛出异常，如果类型不匹配则会返回 null。</li>
<li>as 不能操作基元类型，如果涉及基元类型的算法，就需要通过 is 转型前的类型进行判断，以避免转型失败。</li>
<li>C# 7.0 中提供了 is 的新语法，以下两个方法其实是完全等价的：<figure class="highlight cs"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">A2</span>(<span class="params"><span class="built_in">object</span> obj</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> str = obj <span class="keyword">as</span> <span class="built_in">string</span>;</span><br><span class="line">    <span class="keyword">if</span> (str != <span class="literal">null</span>)</span><br><span class="line">        Console.WriteLine(str);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">A3</span>(<span class="params"><span class="built_in">object</span> obj</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (obj <span class="keyword">is</span> <span class="built_in">string</span> str)</span><br><span class="line">        Console.WriteLine(str);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="建议四：-TryParse-比-Parse-好"><a href="#建议四：-TryParse-比-Parse-好" class="headerlink" title="建议四： TryParse 比 Parse 好"></a>建议四： TryParse 比 Parse 好</h2><p>Parse 和 TryParse 如果执行成功，他们的效率在一个数量级上，但如果执行失败，Parse 方法在转化失败的时候会引发异常，极大地消耗效率，而 TryParse 并不会。</p>
<h2 id="建议五：-使用-int-来确保值类型也可以为-null"><a href="#建议五：-使用-int-来确保值类型也可以为-null" class="headerlink" title="建议五： 使用 int? 来确保值类型也可以为 null"></a>建议五： 使用 int? 来确保值类型也可以为 null</h2><p>　　业务需求中，int 类型的字段在无意义时在业务上为 null 比它的默认值 0 更为合适。</p>
]]></content>
      <categories>
        <category>读书笔记</category>
      </categories>
      <tags>
        <tag>C#</tag>
        <tag>高质量代码</tag>
      </tags>
  </entry>
  <entry>
    <title>编写高质量C#程序的建议（6-10）</title>
    <url>/posts/2345.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p><a href="#%E5%BB%BA%E8%AE%AE%E5%85%AD%EF%BC%9A%E5%8C%BA%E5%88%AB-readonly-%E5%92%8C-const-%E7%9A%84%E5%8C%BA%E5%88%AB">建议六：区别 readonly 和 const 的区别</a><br><a href="#%E5%BB%BA%E8%AE%AE%E4%B8%83%EF%BC%9A%E5%B0%86-0-%E4%BD%9C%E4%B8%BA%E6%9E%9A%E4%B8%BE%E7%9A%84%E9%BB%98%E8%AE%A4%E5%80%BC">建议七：将 0 作为枚举的默认值</a><br><a href="#%E5%BB%BA%E8%AE%AE%E5%85%AB%EF%BC%9A%E9%81%BF%E5%85%8D%E7%BB%99%E6%9E%9A%E4%B8%BE%E7%B1%BB%E5%9E%8B%E7%9A%84%E5%85%83%E7%B4%A0%E6%8F%90%E4%BE%9B%E6%98%BE%E5%BC%8F%E7%9A%84%E5%80%BC">建议八：避免给枚举类型的元素提供显式的值</a><br><a href="#%E5%BB%BA%E8%AE%AE%E4%B9%9D%EF%BC%9A%E4%B9%A0%E6%83%AF%E9%87%8D%E8%BD%BD%E8%BF%90%E7%AE%97%E7%AC%A6">建议九：习惯重载运算符</a><br><a href="#%E5%BB%BA%E8%AE%AE%E5%8D%81%EF%BC%9A%E5%88%9B%E5%BB%BA%E5%AF%B9%E8%B1%A1%E6%97%B6%E9%9C%80%E8%A6%81%E8%80%83%E8%99%91%E6%98%AF%E5%90%A6%E5%AE%9E%E7%8E%B0%E6%AF%94%E8%BE%83%E5%99%A8">建议十：创建对象时需要考虑是否实现比较器</a></p>
<span id="more"></span>

<h2 id="建议六：区别-readonly-和-const-的区别"><a href="#建议六：区别-readonly-和-const-的区别" class="headerlink" title="建议六：区别 readonly 和 const 的区别"></a>建议六：区别 readonly 和 const 的区别</h2><h3 id="const"><a href="#const" class="headerlink" title="const"></a>const</h3><p>const 是一个编译期常亮，用使用 const 的理由只有一个，那就是效率。const只能修饰基元类型、枚举类型或字符串类型。经过编译器编译后，我们在代码中引用 const 变量的地方会用 const 变量 所对应的实际值来代替，如，以下两句 WriteLine 语句的 IL 代码是一致的：</p>
<figure class="highlight cs"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="built_in">int</span> ConstValue = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">Console.WriteLine(ConstValue);</span><br><span class="line">Console.WriteLine(<span class="number">100</span>);</span><br></pre></td></tr></table></figure>

<h3 id="readonly"><a href="#readonly" class="headerlink" title="readonly"></a>readonly</h3><p>readonly 是运行时常量，修饰类型没有限制。readonly 常量的复制行为发生在运行时，它在运行时第一次被赋值后将不可改变。</p>
<ol>
<li>对于值类型，之本身不可改变。</li>
<li>对于引用类型，引用本身（指针）不可改变。</li>
</ol>
<h2 id="建议七：将-0-作为枚举的默认值"><a href="#建议七：将-0-作为枚举的默认值" class="headerlink" title="建议七：将 0 作为枚举的默认值"></a>建议七：将 0 作为枚举的默认值</h2><p>这里的主要原因是出于0作为默认值时所具有的工程上的意义。<br>原因参见以下代码：</p>
<figure class="highlight cs"><table><tr><td class="code"><pre><span class="line"><span class="built_in">enum</span> Week</span><br><span class="line">&#123;</span><br><span class="line">    Monday = <span class="number">1</span>,</span><br><span class="line">    Tuesday,</span><br><span class="line">    Wednesday,</span><br><span class="line">    Thursday,</span><br><span class="line">    Friday,</span><br><span class="line">    Saturday,</span><br><span class="line">    Sunday</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">static</span> Week week;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(week);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出值会是超出枚举定义范围的 0。</p>
<h2 id="建议八：避免给枚举类型的元素提供显式的值"><a href="#建议八：避免给枚举类型的元素提供显式的值" class="headerlink" title="建议八：避免给枚举类型的元素提供显式的值"></a>建议八：避免给枚举类型的元素提供显式的值</h2><p>一般情况下，没有必要给枚举类型的元素提供显式的值。创建枚举的理由之一，就是为了代替使用实际的数值。不正确的为枚举类型设定显式的值，会带来意想不到的错误。</p>
<figure class="highlight cs"><table><tr><td class="code"><pre><span class="line"><span class="built_in">enum</span> Week</span><br><span class="line">&#123;</span><br><span class="line">    Monday = <span class="number">1</span>,</span><br><span class="line">    Tuesday = <span class="number">2</span>,</span><br><span class="line">    TempValue，</span><br><span class="line">    Wednesday = <span class="number">3</span>,</span><br><span class="line">    Thursday = <span class="number">4</span>,</span><br><span class="line">    Friday = <span class="number">5</span>,</span><br><span class="line">    Saturday = <span class="number">6</span>,</span><br><span class="line">    Sunday = <span class="number">7</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>枚举中，未显式指定的值会自动等于上一个值 +1，所以在这个枚举类型 Week 中，TempValue 和 Wednesday 的值均为 3 ，这会在实际业务中带来毁灭性的问题。</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">Week week= Week.TempValue；</span><br><span class="line">Console.WriteLine(week);</span><br><span class="line">Console.WriteLine(week == Week.Wednesday);</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Wednesday</span><br><span class="line">True</span><br></pre></td></tr></table></figure>
<h2 id="建议九：习惯重载运算符"><a href="#建议九：习惯重载运算符" class="headerlink" title="建议九：习惯重载运算符"></a>建议九：习惯重载运算符</h2><p>如果业务意义上的加减乘除复制等运算，应该习惯于重载运算符，而不是使用普通方法。</p>
<h2 id="建议十：创建对象时需要考虑是否实现比较器"><a href="#建议十：创建对象时需要考虑是否实现比较器" class="headerlink" title="建议十：创建对象时需要考虑是否实现比较器"></a>建议十：创建对象时需要考虑是否实现比较器</h2><p>有对象的地方就会存在比较，在 .NET 的世界中也一样。创建类型时需要根据业务上的可能性，考虑为类型实现 ICompareable 接口。</p>
]]></content>
      <categories>
        <category>读书笔记</category>
      </categories>
      <tags>
        <tag>C#</tag>
        <tag>高质量代码</tag>
      </tags>
  </entry>
  <entry>
    <title>.Net 百度语音Demo(语音识别、语音合成）</title>
    <url>/posts/628.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote>
<p>百度语音，面向广大开发者永久免费开放语音合成技术。所采用的离在线融合技术，根据当前网络状况，自动判断使用本地引擎或者云端引擎，进行语音合成，再也不用担心流量消耗了！</p>
</blockquote>
<p>本Demo将使用官方提供的C#版本RestApi SDK制作一个Winfrom软件，实现以下两个功能。</p>
<ul>
<li>TTS语音合成：可选择语速、音调、音量及发言人</li>
<li>ASR语音识别：使用NAudio进行语音录制并识别<span id="more"></span></li>
</ul>
<h2 id="Prepare"><a href="#Prepare" class="headerlink" title="Prepare"></a>Prepare</h2><p>在正式使用之前，我们需要在百度语音获取API key以及SDK文件。</p>
<h3 id="获取API-Key"><a href="#获取API-Key" class="headerlink" title="获取API Key"></a>获取API Key</h3><p>在百度语音<span class="exturl" data-url="aHR0cDovL3l1eWluLmJhaWR1LmNvbS9hcHAv">应用管理<i class="fa fa-external-link-alt"></i></span>页面创建新应用。<br>按照创建引导一步步来即可，注意在选择服务时同时勾选语音识别和语音合成，这样API Key就可以同时用于TTS和ASR了。</p>
<h3 id="下载离线SDK"><a href="#下载离线SDK" class="headerlink" title="下载离线SDK"></a>下载离线SDK</h3><p>下载<span class="exturl" data-url="aHR0cDovL2FpLmJhaWR1LmNvbS9kb3dubG9hZD9zZGtJZD0zNw==">C#版本<i class="fa fa-external-link-alt"></i></span>的RestApi SDK。<br><img data-src="https://qiniucdn.wayneshao.com/20180222133806577/20180222083859597.png"></p>
<h2 id="Coding"><a href="#Coding" class="headerlink" title="Coding"></a>Coding</h2><p>使用Nuget安装Newtonsoft.Json和NAudio、手动引用官方提供的ApiSdk.dll文件。</p>
<p>接下来查看官方Demo中有关语音的SpeechDemo.cs文件</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> Baidu.Aip.Speech;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Baidu.Aip.Demo</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">SpeechDemo</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> Asr _asrClient;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> Tts _ttsClient;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">SpeechDemo</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            _asrClient = <span class="keyword">new</span> Asr(<span class="string">&quot;Api Key&quot;</span>, <span class="string">&quot;Secret Key&quot;</span>);</span><br><span class="line">            _ttsClient = <span class="keyword">new</span> Tts(<span class="string">&quot;Api Key&quot;</span>, <span class="string">&quot;Secret Key&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 识别本地文件</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AsrData</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> data = File.ReadAllBytes(<span class="string">&quot;语音pcm文件地址&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> result = _asrClient.Recognize(data, <span class="string">&quot;pcm&quot;</span>, <span class="number">16000</span>);</span><br><span class="line">            Console.Write(result);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 识别URL中的语音文件</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AsrUrl</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> result = _asrClient.Recoginze(</span><br><span class="line">                <span class="string">&quot;http://xxx.com/待识别的pcm文件地址&quot;</span>, </span><br><span class="line">                <span class="string">&quot;http://xxx.com/识别结果回调地址&quot;</span>, </span><br><span class="line">                <span class="string">&quot;pcm&quot;</span>, </span><br><span class="line">                <span class="number">16000</span>);</span><br><span class="line">            Console.WriteLine(result);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 合成</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Tts</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 可选参数</span></span><br><span class="line">            <span class="keyword">var</span> option = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">object</span>&gt;()</span><br><span class="line">            &#123;</span><br><span class="line">                &#123;<span class="string">&quot;spd&quot;</span>, <span class="number">5</span>&#125;, <span class="comment">// 语速</span></span><br><span class="line">                &#123;<span class="string">&quot;vol&quot;</span>, <span class="number">7</span>&#125;, <span class="comment">// 音量</span></span><br><span class="line">                &#123;<span class="string">&quot;per&quot;</span>, <span class="number">4</span>&#125;  <span class="comment">// 发音人，4：情感度丫丫童声</span></span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">var</span> result = _ttsClient.Synthesis(<span class="string">&quot;众里寻他千百度&quot;</span>, option);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (result.ErrorCode == <span class="number">0</span>)  <span class="comment">// 或 result.Success</span></span><br><span class="line">            &#123;</span><br><span class="line">                File.WriteAllBytes(<span class="string">&quot;合成的语音文件本地存储地址.mp3&quot;</span>, result.Data);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从代码示例中，我们可以看出语音识别API需要的源语音文件为pcm格式，我们使用<a href="https://github.com/naudio/NAudio"><strong>NAudio</strong></a>来获取麦克风数据并保存为pcm格式以使用API，同样的也使用<a href="https://github.com/naudio/NAudio"><strong>NAudio</strong></a>实时预览录制的数据和播放TTS合成的数据。</p>
<h3 id="将官方Demo封装成SpeechHelper"><a href="#将官方Demo封装成SpeechHelper" class="headerlink" title="将官方Demo封装成SpeechHelper"></a>将官方Demo封装成SpeechHelper</h3><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> Baidu.Aip.Speech;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">BaiduSpeechDemo</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">SpeechHelper</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> Asr AsrClient;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> Tts TtsClient;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="title">SpeechHelper</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            AsrClient = <span class="keyword">new</span> Asr(<span class="string">&quot;BWf8AWrvS5h6Y45NAOP3zaGp&quot;</span>, <span class="string">&quot;490737eca7a6ff4d20375d1696c7e548&quot;</span>);</span><br><span class="line">            TtsClient = <span class="keyword">new</span> Tts(<span class="string">&quot;BWf8AWrvS5h6Y45NAOP3zaGp&quot;</span>, <span class="string">&quot;490737eca7a6ff4d20375d1696c7e548&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 识别本地文件</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AsrResult <span class="title">AsrData</span>(<span class="params"><span class="built_in">string</span> path</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> data = File.ReadAllBytes(path);</span><br><span class="line">            <span class="keyword">var</span> result = AsrClient.Recognize(data, <span class="string">&quot;pcm&quot;</span>, <span class="number">8000</span>);</span><br><span class="line">            <span class="keyword">return</span> result.ToObject&lt;AsrResult&gt;();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 识别URL中的语音文件</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AsrResult <span class="title">AsrUrl</span>(<span class="params"><span class="built_in">string</span> url, <span class="built_in">string</span> callback = <span class="string">&quot;&quot;</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> result = AsrClient.Recoginze(</span><br><span class="line">                url,</span><br><span class="line">                callback,</span><br><span class="line">                <span class="string">&quot;pcm&quot;</span>,</span><br><span class="line">                <span class="number">16000</span>);</span><br><span class="line">            <span class="keyword">return</span> result.ToObject&lt;AsrResult&gt;();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 合成</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">Tts</span>(<span class="params"><span class="built_in">string</span> input, <span class="built_in">string</span> path, <span class="built_in">int</span> spd = <span class="number">5</span>, <span class="built_in">int</span> pit = <span class="number">5</span>, <span class="built_in">int</span> vol = <span class="number">6</span>, <span class="built_in">int</span> per = <span class="number">4</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 可选参数</span></span><br><span class="line">            <span class="keyword">var</span> option = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">object</span>&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                &#123;<span class="string">&quot;spd&quot;</span>, spd&#125;, <span class="comment">// 语速，取值0-9，默认为5中语速</span></span><br><span class="line">                &#123;<span class="string">&quot;pit&quot;</span>, pit&#125;, <span class="comment">// 音调，取值0-9，默认为5中语调</span></span><br><span class="line">                &#123;<span class="string">&quot;vol&quot;</span>, vol&#125;, <span class="comment">// 音量，取值0-15，默认为5中音量</span></span><br><span class="line">                &#123;<span class="string">&quot;per&quot;</span>, per&#125;  <span class="comment">// 发音人选择, 0为普通女声，1为普通男生，3为情感合成-度逍遥，4为情感合成-度丫丫，默认为普通女声</span></span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">var</span> result = TtsClient.Synthesis(input, option);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (result.Success) File.WriteAllBytes(path, result.Data);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//Console.WriteLine(result.Serialize());</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> result.Success;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="NAudio录制麦克风数据为pcm格式并实时预览"><a href="#NAudio录制麦克风数据为pcm格式并实时预览" class="headerlink" title="NAudio录制麦克风数据为pcm格式并实时预览"></a><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL25hdWRpby9OQXVkaW8=">NAudio<i class="fa fa-external-link-alt"></i></span>录制麦克风数据为pcm格式并实时预览</h3><p>NAudio提供了<span class="exturl" data-url="aHR0cDovL21hcmtoZWF0aC5uZXQvcG9zdC9ob3ctdG8tcmVjb3JkLWFuZC1wbGF5LWF1ZGlvLWF0LXNhbWUw">同时进行录制和播放的Demo<i class="fa fa-external-link-alt"></i></span>，其中的SavingWaveProvider可以直接拿来使用，只要传入合适的参数即可将保存文件的格式由示例中的wav改为pcm，下面是修改后的调用代码。<br>具体则是修改WaveIn的声明：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 设置记录器</span></span><br><span class="line"><span class="comment">// WaveFormat.CreateCustomFormat 参数依次为 格式\采样率\声道\每秒平均码率\单位采样点的字节数\采样位数</span></span><br><span class="line">_recorder = <span class="keyword">new</span> WaveIn &#123; WaveFormat = WaveFormat.CreateCustomFormat(WaveFormatEncoding.Pcm, <span class="number">8000</span>, <span class="number">1</span>, <span class="number">16000</span>, <span class="number">2</span>, <span class="number">16</span>) &#125;;</span><br></pre></td></tr></table></figure>
<p>下面给出修改后的开始录制和结束录制的代码</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> WaveIn _recorder;</span><br><span class="line"><span class="keyword">private</span> BufferedWaveProvider _bufferedWaveProvider;</span><br><span class="line"><span class="keyword">private</span> SavingWaveProvider _savingWaveProvider;</span><br><span class="line"><span class="keyword">private</span> WaveOut _player;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnStartRecordingClick</span>(<span class="params"><span class="built_in">object</span> sender, EventArgs e</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 设置记录器</span></span><br><span class="line">    <span class="comment">// 参数依次为 格式\采样率\声道\每秒平均码率\单位采样点的字节数\采样位数</span></span><br><span class="line">    _recorder = <span class="keyword">new</span> WaveIn &#123; WaveFormat = WaveFormat.CreateCustomFormat(WaveFormatEncoding.Pcm, <span class="number">8000</span>, <span class="number">1</span>, <span class="number">16000</span>, <span class="number">2</span>, <span class="number">16</span>) &#125;;</span><br><span class="line">    _recorder.DataAvailable += RecorderOnDataAvailable;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 建立我们的信号链</span></span><br><span class="line">    _bufferedWaveProvider = <span class="keyword">new</span> BufferedWaveProvider(_recorder.WaveFormat);</span><br><span class="line"></span><br><span class="line">    _fileName = Path.Combine(<span class="string">&quot;temp&quot;</span>, Guid.NewGuid() + <span class="string">&quot;.pcm&quot;</span>);</span><br><span class="line">    _savingWaveProvider = <span class="keyword">new</span> SavingWaveProvider(_bufferedWaveProvider, _fileName);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置播放</span></span><br><span class="line">    _player = <span class="keyword">new</span> WaveOut();</span><br><span class="line">    _player.Init(_savingWaveProvider);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 开始播放和录制</span></span><br><span class="line">    _player.Play();</span><br><span class="line">    _recorder.StartRecording();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">RecorderOnDataAvailable</span>(<span class="params"><span class="built_in">object</span> sender, WaveInEventArgs waveInEventArgs</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    _bufferedWaveProvider.AddSamples(waveInEventArgs.Buffer, <span class="number">0</span>, waveInEventArgs.BytesRecorded);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">OnStopRecordingClick</span>(<span class="params"><span class="built_in">object</span> sender, EventArgs e</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 停止录制</span></span><br><span class="line">    _recorder.StopRecording();</span><br><span class="line">    <span class="comment">// 停止播放</span></span><br><span class="line">    _player.Stop();</span><br><span class="line">    <span class="comment">// 最终完成 WAV 文件</span></span><br><span class="line">    _savingWaveProvider.Dispose();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 请求百度ASR API</span></span><br><span class="line">    <span class="keyword">var</span> a = SpeechHelper.AsrData(_fileName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="TTS完成"><a href="#TTS完成" class="headerlink" title="TTS完成"></a>TTS完成</h3><p>窗体界面拖好TTS选项的布局<br><img data-src="https://qiniucdn.wayneshao.com/20180222133806577/20180222094352273.png"><br>完成按钮点击事件的逻辑</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">btnTts_Click</span>(<span class="params"><span class="built_in">object</span> sender, EventArgs e</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 临时保存路径</span></span><br><span class="line">    <span class="keyword">var</span> musicPath = Path.Combine(<span class="string">&quot;temp&quot;</span>, Guid.NewGuid() + <span class="string">&quot;.mp3&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发言人</span></span><br><span class="line">    <span class="keyword">var</span> per = cbPer.SelectedIndex &gt;= <span class="number">2</span> ? cbPer.SelectedIndex + <span class="number">1</span> : cbPer.SelectedIndex;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//调用Baidu TTS Api</span></span><br><span class="line">    <span class="keyword">if</span> (!SpeechHelper.Tts(tbContext.Text, musicPath, (<span class="built_in">int</span>)nudSpd.Value, (<span class="built_in">int</span>)nudPit.Value, (<span class="built_in">int</span>)nudVol.Value, per)) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//播放请求得到的结果</span></span><br><span class="line">    IWavePlayer waveOutDevice = <span class="keyword">new</span> WaveOut();</span><br><span class="line">    <span class="keyword">var</span> audioFileReader = <span class="keyword">new</span> AudioFileReader(musicPath);</span><br><span class="line">    waveOutDevice.Init(audioFileReader);</span><br><span class="line">    waveOutDevice.Play();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//播放结束后销毁播放对象</span></span><br><span class="line">    waveOutDevice.PlaybackStopped += <span class="built_in">delegate</span></span><br><span class="line">    &#123;</span><br><span class="line">        waveOutDevice?.Stop();</span><br><span class="line">        waveOutDevice?.Dispose();</span><br><span class="line">        waveOutDevice = <span class="literal">null</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Complete"><a href="#Complete" class="headerlink" title="Complete"></a>Complete</h2><p>最终成品如下：<br><img data-src="https://qiniucdn.wayneshao.com/20180222133806577/20180222094601387.png"><br><strong>完整代码托管在<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL1dheW5lU2hhby9CYWlkdVNwZWVjaERlbW8=">GitHub<i class="fa fa-external-link-alt"></i></span></strong></p>
<p><strong>代码中我自己的Api Key并没有删除，望手下留情，别给我搞封了。</strong></p>
]]></content>
      <categories>
        <category>踩坑笔记</category>
      </categories>
      <tags>
        <tag>语音识别</tag>
        <tag>ASR</tag>
        <tag>TTS</tag>
        <tag>NAudio</tag>
      </tags>
  </entry>
  <entry>
    <title>缺少google api密钥,因此chromium的部分功能将无法使用”的解决办法</title>
    <url>/posts/37840.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p> 使用Chromium时会遇到 “缺少google api密钥,因此chromium的部分功能将无法使用”提示，google了一下 setx Google_API_KEY 和 chromium portable google api keys are missing 找到了解决办法。<br> <span id="more"></span><br> 打开windows的cmd命令提示符，依次输入以下命令： </p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">setx GOOGLE_API_KEY &quot;no&quot; </span><br><span class="line">setx GOOGLE_DEFAULT_CLIENT_ID &quot;no&quot; </span><br><span class="line">setx GOOGLE_DEFAULT_CLIENT_SECRET &quot;no&quot;</span><br></pre></td></tr></table></figure>

<p><img data-src="https://qiniucdn.wayneshao.com/20180218230720/20180218110847654.png"><br>当然,这样只是可以去掉chromium开启时的提示,如果需要使用Google API 服务,还是推荐去谷歌申请,然后重新setx为真实api key。</p>
]]></content>
      <categories>
        <category>踩坑笔记</category>
      </categories>
      <tags>
        <tag>软件心得</tag>
      </tags>
  </entry>
  <entry>
    <title>离职总结及未来一段时间的计划</title>
    <url>/posts/12390.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>2019 年 9 月 20 日 15 时 58 分，我签下了离职证明和放行条，为我在广州多益网络股份有限公司 530 天的工作画上了句号。</p>
<span id="more"></span>

<h2 id="离职"><a href="#离职" class="headerlink" title="离职"></a>离职</h2><p>说实话，到现在我自己都还没有想清楚离职的准确原因，<br>或许是因为察觉到自己在过去一年的反复又繁复的业务中并没有很大的长进却又不得不囿于加班文化，也没有足够的自学时间，<br>或许是因为明明意识到系统架构的系统性问题，整体结构很需要重新划分，模块需要使用更合适的技术重构，却又在各种急促繁复的需求压迫下不得不无限妥协的无奈，<br>或许是因为今年年中连续几个月平均加班到十一点的加班，<br>或许是因为我和身边同事相比缩水一半的工资，<br>也或许是前半年我跟领导提出了工资倒挂的情况希望能调整工资，却在几个月后，已经处于离职的边缘时才告诉我保证留下来才可以加薪，  </p>
<p>总之，我在听到加薪消息的隔天（2019 年 8 月 21 日 17 时 58 分）按下了辞职信的发送键，为这场旅途画下了句号。</p>
<p>回顾过去的一年半，非常感谢廖总和蔡总能给我机会，让我这个后端门外汉以1.5年经验（实习一年 + 工作半年）的流媒体开发攻城师菜鸟的身份成功入职多益网络信息技术中心的 Web 后端开发一职，在多益的一年半里，我从一个后端菜鸟成功晋级为一个熟练码农，从原本一手全包的开发模式晋升到了前后端分离的团队开发模式，又从一个只管实现需求的人偶码农晋升为了能推敲需求，和策划为了我认为不合理的需求吵得脸红脖子粗的主程序员。</p>
<p>我负责公司内部培训系统 “多益大学” 的后端开发工作，前半段和组里的同事一起完成了系统几个大模块的重构和新模块的开发，并于今年开始成功进一步接手多益大学全部后端工作后主导系统的开发，而后完成了统一考试、训练营重构、职级晋升等模块的开发，在职级晋升模块成功上限使用之后提出了离职，经历了半个月的继续开发之后交接离开。</p>
<p>总结这段经历，总体来讲还是觉得受益匪浅，当初因为喜欢后端开发，喜欢比较新的技术，遂从上家公司的“流媒体/Windows桌面开发”岗位辞职，转而从事后端开发。说实话当时面试表现得确实比较差，非常感谢面试官能给我这个机会，也非常欣喜能在公司学习并实践喜欢的技术，总结离开的原因，同样也是因为较长的工作时间下没有足够的时间学习新的技术，急促反复的需求下也没有空间实践新的技能，我对此非常遗憾，但是也并不会感到后悔。</p>
<h2 id="接下来的计划"><a href="#接下来的计划" class="headerlink" title="接下来的计划"></a>接下来的计划</h2><p>接下来我打算先修整一段时间，预计 1-2 个月，然后对已有技能进行整合，结合就业市场需求的方向对一些新技术进行学习实践，经过深思熟虑之后再寻找新的就业机会。</p>
<ol>
<li>技能<ul>
<li>微服务</li>
<li>读完《CLR via C#》、《C# 7.0 本质论》</li>
<li>参与 NCC 的开源项目</li>
</ul>
</li>
<li>习惯<ul>
<li>按时进行睡眠洗漱等习惯的养成</li>
<li>指定奖惩规则，记录执行情况</li>
</ul>
</li>
<li>减肥<ul>
<li>控制脂肪、糖类的摄入</li>
<li>记录每天摄入的卡路里</li>
<li>自己做减肥餐吃</li>
<li>每天完成一定时长的健身</li>
</ul>
</li>
<li>理财<ul>
<li>记账</li>
<li>理论学习</li>
</ul>
</li>
<li>读书<ul>
<li>列书单，记录读书情况</li>
<li>大约保持每天半小时到一小时的阅读时长</li>
</ul>
</li>
</ol>
]]></content>
      <categories>
        <category>偶有所得</category>
      </categories>
      <tags>
        <tag>离职总结</tag>
        <tag>计划</tag>
      </tags>
  </entry>
  <entry>
    <title>聚会合租选点：计算距离多个地铁站点综合时间最少的聚会地点</title>
    <url>/posts/63564.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="缘起"><a href="#缘起" class="headerlink" title="缘起"></a>缘起</h2><p>　　五人小组的聚会由于最初不知为何定在了体育中心、体育西一带，之后一直延续这个传统，鉴于前几次的聚会高度重复，<span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNoY2F0eS5jbi8yMDE5LzAyLzI0LyVFOCU4MSU5QSVFNCVCQyU5QSVFOSU5QSU4RiVFNiU4MyVCMy8jJUU1JTg1JUIzJUU0JUJBJThFJUU4JTgxJTlBJUU0JUJDJTlB">聚会体验越来越差<i class="fa fa-external-link-alt"></i></span>，便起了一个想法：</p>
<blockquote>
<p>为什么不做一个小工具来计算相对几位参与人居住地点最划算的聚会地点呢？</p>
</blockquote>
<span id="more"></span>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>　　在各大地图APP上都有提供各种行程规划的功能，但是利用这个功能来完成预期的业务希望是相当繁琐的，而这个功能如果要自己实现，需要得到的数据就是地铁路线图上任意两个点之间所需要的时间、购票费用等数据。<br>　　经过在网上的搜寻，我最终决定的数据来源方案为百度开放平台中的<span class="exturl" data-url="aHR0cDovL2xic3l1bi5iYWlkdS5jb20vanNkZW1vLmh0bSNzdWJ3YXk0XzE=">地铁图JS API<i class="fa fa-external-link-alt"></i></span></p>
<h2 id="抓取关键数据"><a href="#抓取关键数据" class="headerlink" title="抓取关键数据"></a>抓取关键数据</h2><pre><code>在源代码编辑器中将调试的城市名称改为＇广州＇，点击编辑器右上角的运行按钮，在调试窗口中就能找到相关的API请求，所有地铁站数据都可以在这次请求中获得。
</code></pre>
<p>　　<img data-src="https://qiniucdn.wayneshao.com/%E8%81%9A%E4%BC%9A%E5%90%88%E7%A7%9F%E9%80%89%E7%82%B9%EF%BC%9A%E8%AE%A1%E7%AE%97%E8%B7%9D%E7%A6%BB%E5%A4%9A%E4%B8%AA%E5%9C%B0%E7%82%B9%E7%BB%BC%E5%90%88%E6%97%B6%E9%97%B4%E6%9C%80%E5%B0%91%E7%9A%84%E8%81%9A%E4%BC%9A%E5%9C%B0%E7%82%B9/20190317105515992.png"></p>
<p>实体类:</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Line</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> List&lt;Station&gt; Stations &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; = <span class="keyword">new</span> List&lt;Station&gt;();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Station</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> UId &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;<span class="built_in">string</span>&gt; Lines &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将Json数据解析转换为实体类型并保存到文件中</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> jobject = JsonHelper.DeserializeObject(json);</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> l <span class="keyword">in</span> jobject[<span class="string">&quot;subways&quot;</span>][<span class="string">&quot;l&quot;</span>])</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> line = <span class="keyword">new</span> Line &#123; Name = l[<span class="string">&quot;l_xmlattr&quot;</span>][<span class="string">&quot;lb&quot;</span>].Value&lt;<span class="built_in">string</span>&gt;() &#125;;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">var</span> p <span class="keyword">in</span> l[<span class="string">&quot;p&quot;</span>])</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> pname = p[<span class="string">&quot;p_xmlattr&quot;</span>][<span class="string">&quot;lb&quot;</span>].Value&lt;<span class="built_in">string</span>&gt;();</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrWhiteSpace(pname) &amp;&amp; p[<span class="string">&quot;p_xmlattr&quot;</span>][<span class="string">&quot;uid&quot;</span>] != <span class="literal">null</span>)</span><br><span class="line">            line.Stations.Add(<span class="keyword">new</span> Station</span><br><span class="line">            &#123;</span><br><span class="line">                Name = pname,</span><br><span class="line">                Lines = p[<span class="string">&quot;p_xmlattr&quot;</span>][<span class="string">&quot;lb&quot;</span>].Value&lt;<span class="built_in">string</span>&gt;().Split(<span class="string">&#x27;,&#x27;</span>).Select(s =&gt; s.Substring(s.IndexOf(<span class="string">&quot;|&quot;</span>) + <span class="number">1</span>)).ToList(),</span><br><span class="line">                UId = p[<span class="string">&quot;p_xmlattr&quot;</span>][<span class="string">&quot;uid&quot;</span>].Value&lt;<span class="built_in">string</span>&gt;()</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    Lines.Add(line);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">File.WriteAllText(<span class="string">&quot;Data/line.json&quot;</span>, Lines.ToFormatedJsonString());</span><br></pre></td></tr></table></figure>

<p><img data-src="https://qiniucdn.wayneshao.com/%E8%81%9A%E4%BC%9A%E5%90%88%E7%A7%9F%E9%80%89%E7%82%B9%EF%BC%9A%E8%AE%A1%E7%AE%97%E8%B7%9D%E7%A6%BB%E5%A4%9A%E4%B8%AA%E5%9C%B0%E7%82%B9%E7%BB%BC%E5%90%88%E6%97%B6%E9%97%B4%E6%9C%80%E5%B0%91%E7%9A%84%E8%81%9A%E4%BC%9A%E5%9C%B0%E7%82%B9/20190317110105885.png"></p>
<p>那么接下来我们就要获取两点之前的数据的方法：<br><img data-src="https://qiniucdn.wayneshao.com/%E8%81%9A%E4%BC%9A%E5%90%88%E7%A7%9F%E9%80%89%E7%82%B9%EF%BC%9A%E8%AE%A1%E7%AE%97%E8%B7%9D%E7%A6%BB%E5%A4%9A%E4%B8%AA%E5%9C%B0%E7%82%B9%E7%BB%BC%E5%90%88%E6%97%B6%E9%97%B4%E6%9C%80%E5%B0%91%E7%9A%84%E8%81%9A%E4%BC%9A%E5%9C%B0%E7%82%B9/20190317110533303.png"></p>
<p>同样，我们找到了页面请求这个数据的API<br><img data-src="https://qiniucdn.wayneshao.com/%E8%81%9A%E4%BC%9A%E5%90%88%E7%A7%9F%E9%80%89%E7%82%B9%EF%BC%9A%E8%AE%A1%E7%AE%97%E8%B7%9D%E7%A6%BB%E5%A4%9A%E4%B8%AA%E5%9C%B0%E7%82%B9%E7%BB%BC%E5%90%88%E6%97%B6%E9%97%B4%E6%9C%80%E5%B0%91%E7%9A%84%E8%81%9A%E4%BC%9A%E5%9C%B0%E7%82%B9/20190317110619477.png"><br><img data-src="https://qiniucdn.wayneshao.com/%E8%81%9A%E4%BC%9A%E5%90%88%E7%A7%9F%E9%80%89%E7%82%B9%EF%BC%9A%E8%AE%A1%E7%AE%97%E8%B7%9D%E7%A6%BB%E5%A4%9A%E4%B8%AA%E5%9C%B0%E7%82%B9%E7%BB%BC%E5%90%88%E6%97%B6%E9%97%B4%E6%9C%80%E5%B0%91%E7%9A%84%E8%81%9A%E4%BC%9A%E5%9C%B0%E7%82%B9/20190317110804123.png"><br>经测试，只要将圈中的数据替换为响应站点的UID和Name，即可获取到相应的数据。</p>
<p>实体类:</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TwoStationInfo</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span>[] TwoStationNames &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Distance &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Price &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> SubwayPrice &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Time &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> WalkDistance &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> WalkTime &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>抓取:</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> stationsList = Lines.Select(l =&gt; l.Stations);</span><br><span class="line"><span class="keyword">var</span> stations = <span class="keyword">new</span> List&lt;Station&gt;();</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> ss <span class="keyword">in</span> stationsList)</span><br><span class="line">    stations.AddRange(ss);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> client = <span class="keyword">new</span> HttpClient();</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; stations.Count; i++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; stations.Count; j++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (i == j) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">if</span> (TwoStationInfos.Any(ts =&gt; ts.TwoStationNames.Contains(stations[i].Name) &amp;&amp; ts.TwoStationNames.Contains(stations[j].Name))) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">var</span> result = <span class="keyword">await</span> client.GetStringAsync(</span><br><span class="line">            <span class="string">$&quot;https://api.map.baidu.com/?qt=bt2&amp;newmap=1&amp;ie=utf-8&amp;f=%5B1,12,13,14%5D&amp;c=257&amp;sn=0$$<span class="subst">&#123;stations[i].UId&#125;</span>$$undefined,undefined$$<span class="subst">&#123;stations[i].Name&#125;</span>$$&amp;en=0$$<span class="subst">&#123;stations[j].UId&#125;</span>$$undefined,undefined$$<span class="subst">&#123;stations[j].Name&#125;</span>$$&amp;m=sbw&amp;ccode=257&amp;from=dtzt&amp;sy=0&amp;t=1552814046118&amp;callback=BMapSub._rd._cbk22197&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> index = result.IndexOf(<span class="string">&#x27;&#123;&#x27;</span>);</span><br><span class="line">        result = result.Substring(index, result.Length - index - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> jResult = JsonHelper.DeserializeObject(result);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (jResult[<span class="string">&quot;content&quot;</span>] == <span class="literal">null</span>) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">var</span> two = <span class="keyword">new</span> TwoStationInfo</span><br><span class="line">        &#123;</span><br><span class="line">            Time = jResult[<span class="string">&quot;content&quot;</span>][<span class="number">0</span>][<span class="string">&quot;exts&quot;</span>][<span class="number">0</span>][<span class="string">&quot;time&quot;</span>].Value&lt;<span class="built_in">int</span>&gt;(),</span><br><span class="line">            Distance = jResult[<span class="string">&quot;content&quot;</span>][<span class="number">0</span>][<span class="string">&quot;exts&quot;</span>][<span class="number">0</span>][<span class="string">&quot;distance&quot;</span>].Value&lt;<span class="built_in">int</span>&gt;(),</span><br><span class="line">            Price = jResult[<span class="string">&quot;content&quot;</span>][<span class="number">0</span>][<span class="string">&quot;exts&quot;</span>][<span class="number">0</span>][<span class="string">&quot;price&quot;</span>].Value&lt;<span class="built_in">int</span>&gt;(),</span><br><span class="line">            SubwayPrice = jResult[<span class="string">&quot;content&quot;</span>][<span class="number">0</span>][<span class="string">&quot;exts&quot;</span>][<span class="number">0</span>][<span class="string">&quot;subway_price&quot;</span>].Value&lt;<span class="built_in">int</span>&gt;(),</span><br><span class="line">            WalkDistance = jResult[<span class="string">&quot;content&quot;</span>][<span class="number">0</span>][<span class="string">&quot;exts&quot;</span>][<span class="number">0</span>][<span class="string">&quot;walk_distance&quot;</span>].Value&lt;<span class="built_in">int</span>&gt;(),</span><br><span class="line">            WalkTime = jResult[<span class="string">&quot;content&quot;</span>][<span class="number">0</span>][<span class="string">&quot;exts&quot;</span>][<span class="number">0</span>][<span class="string">&quot;walk_time&quot;</span>].Value&lt;<span class="built_in">int</span>&gt;(),</span><br><span class="line">            TwoStationNames = <span class="keyword">new</span>[] &#123; stations[i].Name, stations[j].Name &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        TwoStationInfos.Add(two);</span><br><span class="line"></span><br><span class="line">        Console.WriteLine(<span class="string">$@&quot;<span class="subst">&#123;stations[i].Name&#125;</span> =&gt; <span class="subst">&#123;stations[j].Name&#125;</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">File.WriteAllText(<span class="string">&quot;Data/info.json&quot;</span>, TwoStationInfos.ToFormatedJsonString());</span><br></pre></td></tr></table></figure>
<p>最终得到了所有数据，$C_{224}^2$ 大约25000条：<br><img data-src="https://qiniucdn.wayneshao.com/%E8%81%9A%E4%BC%9A%E5%90%88%E7%A7%9F%E9%80%89%E7%82%B9%EF%BC%9A%E8%AE%A1%E7%AE%97%E8%B7%9D%E7%A6%BB%E5%A4%9A%E4%B8%AA%E5%9C%B0%E7%82%B9%E7%BB%BC%E5%90%88%E6%97%B6%E9%97%B4%E6%9C%80%E5%B0%91%E7%9A%84%E8%81%9A%E4%BC%9A%E5%9C%B0%E7%82%B9/20190317111150999.png"></p>
<h2 id="计算"><a href="#计算" class="headerlink" title="计算"></a>计算</h2><p>得到了数据，那计算就只是体力活了，计算代码如下：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> strs = listBox1.Items.Cast&lt;<span class="built_in">string</span>&gt;().ToList();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> routeInfos = StationNames.Select(n =&gt; GetRouteInfo(strs, n)).ToList();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> minTime = routeInfos.Min(r =&gt; r.Routes.Sum(rr =&gt; rr.Time + rr.WalkTime));</span><br><span class="line"><span class="keyword">var</span> minTimeRoute = routeInfos.First(r =&gt; r.Routes.Sum(rr =&gt; rr.Time + rr.WalkTime) == minTime);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> minPrice = routeInfos.Min(r =&gt; r.Routes.Sum(rr =&gt; rr.Price));</span><br><span class="line"><span class="keyword">var</span> minPriceRoute = routeInfos.First(r =&gt; r.Routes.Sum(rr =&gt; rr.Price) == minPrice);</span><br><span class="line"></span><br><span class="line">textBox3.Clear();</span><br><span class="line"></span><br><span class="line">textBox3.AppendText(<span class="string">$&quot;综合耗时最短：<span class="subst">&#123;minTimeRoute.DestStation&#125;</span> 耗时: <span class="subst">&#123;Second2Chs(minTime)&#125;</span> \r\n其中地铁时间: <span class="subst">&#123;Second2Chs(minTimeRoute.Routes.Sum(rr =&gt; rr.Time))&#125;</span> 步行时间:<span class="subst">&#123;Second2Chs(minTimeRoute.Routes.Sum(rr =&gt; rr.WalkTime))&#125;</span>\r\n\r\n&quot;</span>);</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> info <span class="keyword">in</span> minTimeRoute.Routes)</span><br><span class="line">    textBox3.AppendText(</span><br><span class="line">        <span class="string">$&quot;<span class="subst">&#123;info.TwoStationNames[<span class="number">1</span>]&#125;</span>=&gt;<span class="subst">&#123;info.TwoStationNames[<span class="number">0</span>]&#125;</span> 耗时: <span class="subst">&#123;Second2Chs(info.Time + info.WalkTime)&#125;</span> \r\n其中地铁时间: <span class="subst">&#123;Second2Chs(info.Time)&#125;</span> 步行时间:<span class="subst">&#123;Second2Chs(info.WalkTime)&#125;</span> \r\n&quot;</span>);</span><br><span class="line">textBox3.AppendText(<span class="string">$&quot;\r\n\r\n&quot;</span>);</span><br><span class="line">textBox3.AppendText(<span class="string">$&quot;综合花费最少：<span class="subst">&#123;minPriceRoute.DestStation&#125;</span> 花费：<span class="subst">&#123;minPrice/<span class="number">100.0</span>&#125;</span> \r\n\r\n&quot;</span>);</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> info <span class="keyword">in</span> minPriceRoute.Routes)</span><br><span class="line">    textBox3.AppendText(</span><br><span class="line">        <span class="string">$&quot;<span class="subst">&#123;info.TwoStationNames[<span class="number">1</span>]&#125;</span>=&gt;<span class="subst">&#123;info.TwoStationNames[<span class="number">0</span>]&#125;</span> 花费: <span class="subst">&#123;info.Price / <span class="number">100.0</span>&#125;</span> \r\n&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>运行结果截图:<br><img data-src="https://qiniucdn.wayneshao.com/%E8%81%9A%E4%BC%9A%E5%90%88%E7%A7%9F%E9%80%89%E7%82%B9%EF%BC%9A%E8%AE%A1%E7%AE%97%E8%B7%9D%E7%A6%BB%E5%A4%9A%E4%B8%AA%E5%9C%B0%E7%82%B9%E7%BB%BC%E5%90%88%E6%97%B6%E9%97%B4%E6%9C%80%E5%B0%91%E7%9A%84%E8%81%9A%E4%BC%9A%E5%9C%B0%E7%82%B9/20190317112034374.png"></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL1dheW5lU2hhby9QYXJ0eVN1YndheVNhdGlvbkRlbW8=">代码：包含已抓取到的数据<i class="fa fa-external-link-alt"></i></span></p>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><ol>
<li>首先，软件还比较粗糙，只是简单地数据计算筛选，结果只能做参考。</li>
<li>同样也可以用于在不同地点工作的人寻找合租的地点，但在这个应用中缺少权值计算，而且往往时间最短的地点都坐落于两条或者多条线的交界处，通勤时的等待时间往往也比较长。</li>
<li>以后考虑为每个地点增加一些美食指数之类的多维度权值，可以按照不同需求求出最优解。</li>
</ol>
]]></content>
      <categories>
        <category>闹着玩儿</category>
      </categories>
      <tags>
        <tag>C#</tag>
        <tag>广州地铁</tag>
        <tag>聚会</tag>
        <tag>合租</tag>
      </tags>
  </entry>
  <entry>
    <title>记一次失败平衡车破解提速之旅</title>
    <url>/posts/15092.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>　　记录为期一天的失败破解之旅．</p>
<h2 id="缘起"><a href="#缘起" class="headerlink" title="缘起"></a>缘起</h2><p>　　最近突然觉得手头的 Ninebot 平衡车速度是确实有几分慢了，想起了刚买到手的时候似乎在论坛看到过一篇帖子是讲如何破解速度上限的，拼着几丝印象找到了当时的帖子：<span class="exturl" data-url="aHR0cDovL2Jicy5uaW5lYm90LmNuL3RocmVhZC0xOTczMDEtMS0xLmh0bWw=">传送门<i class="fa fa-external-link-alt"></i></span></p>
<span id="more"></span>
<p>　　<img data-src="https://qiniucdn.wayneshao.com/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%A4%B1%E8%B4%A5%E7%9A%84%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91%E4%B9%8B%E6%97%85/20190310121120037.png"><br>　　帖子里描述的方法是使用 JLink V8 之类的 ARM模拟器把网友编写的固件刷入主板，对于我一个手残来说，首先是硬件成本，从 JLink ，到铜线、引脚，再到电烙铁和焊锡全都要新买，另外虽然不用担心刷固件把车子搞坏，但是万一手残把主板焊坏，那就死定了。<br>　　向下翻打算借鉴一下经验看要买哪一款模拟器的时候，发现了一位坛友的分享：<br><img data-src="https://qiniucdn.wayneshao.com/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%A4%B1%E8%B4%A5%E7%9A%84%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91%E4%B9%8B%E6%97%85/20190310121953854.png"><br>　　咦，居然还有这么清真的方式？虽然不算便宜，但是两百以内也完全可以接受，关键是，不用拆机，省了不少事儿，就顺着这条线继续往下查，找到了[这篇帖子：](<span class="exturl" data-url="aHR0cHM6Ly9mb3J1bS5lbGVjdHJpY3VuaWN5Y2xlLm9yZy90b3BpYy8xMTk3Ni1uaW5ldG9vbC1pbmNyZWFzZQ==">https://forum.electricunicycle.org/topic/11976-ninetool-increase<i class="fa fa-external-link-alt"></i></span>﻿-max-﻿﻿﻿speed﻿-ninebot-and-change-model)<br><img data-src="https://qiniucdn.wayneshao.com/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%A4%B1%E8%B4%A5%E7%9A%84%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91%E4%B9%8B%E6%97%85/20190310122324594.png"><br>　　简单看了一下，安卓软件，需要购买 License ，三十刀，界面相当简洁。</p>
<blockquote>
<p>To change the model, you need an activation code, you can get it from me, you need to send a screenshot of the program screen on the example as in the screenshot below.</p>
</blockquote>
<p>　　看来 License 是根据读取了设备的三个 key 和 Sn 经由某种算法计算出来的，一台设备对应一个 License。<br>遂安装到手机试了试，交互十分简单，点击 Set Model 的时候会触发授权码校验。</p>
<p>　　至此，突然萌生了一丝侥幸，这么简陋，我是不是可以自学一下安卓逆向，把它破解掉呢？<br><img data-src="https://qiniucdn.wayneshao.com/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%A4%B1%E8%B4%A5%E7%9A%84%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91%E4%B9%8B%E6%97%85/20190310122856503.png"></p>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>　　首先测试了一下交互，校验失败会直接弹出提示，内容里会包含文本框里的内容。<br><img data-src="https://qiniucdn.wayneshao.com/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%A4%B1%E8%B4%A5%E7%9A%84%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91%E4%B9%8B%E6%97%85/20190310122710140.png"><br>　　然后抓包尝试了一下，发现校验完全是本地操作，并无在线校验。</p>
<h2 id="学习"><a href="#学习" class="headerlink" title="学习"></a>学习</h2><p>　　之前在学校的时候简单研究过一些逆向分析的知识，对 .NET 的逆向分析研究多一些，当时学习主要是在吾爱破解，现在想要学安卓逆向，同样也是到吾爱找了一套教程，大佬为兄弟写的一套教程<span class="exturl" data-url="aHR0cHM6Ly93d3cuNTJwb2ppZS5jbi90aHJlYWQtNjQ4NTMwLTEtMS5odG1s">《教我兄弟学Android逆向》<i class="fa fa-external-link-alt"></i></span>。</p>
<h2 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h2><p>祭出 Android Killer :<br><img data-src="https://qiniucdn.wayneshao.com/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%A4%B1%E8%B4%A5%E7%9A%84%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91%E4%B9%8B%E6%97%85/20190310124045297.png"><br>分析主界面的代码 FMXNativeActivity.smali :</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.field private mStartupGCM:Landroid/os/Bundle;</span><br><span class="line"></span><br><span class="line">.field private mTextView:Lcom/embarcadero/firemonkey/text/FMXTextEditorProxy;</span><br><span class="line"></span><br><span class="line">.field private mViewGroup:Landroid/view/ViewGroup;</span><br><span class="line"></span><br><span class="line">.field private mViewStack:Lcom/embarcadero/firemonkey/ViewStack;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.method public surfaceCreated(Landroid/view/SurfaceHolder;)V</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.method public surfaceDestroyed(Landroid/view/SurfaceHolder;)V</span><br></pre></td></tr></table></figure>

<p>噗~~~</p>
<p><img data-src="https://qiniucdn.wayneshao.com/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%A4%B1%E8%B4%A5%E7%9A%84%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91%E4%B9%8B%E6%97%85/20190310124531125.png"></p>
<p>我的天。。。<br>界面的代码里根本没有控件的渲染和事件，有种不祥的预感，再一看 lib 文件夹下：<br><img data-src="https://qiniucdn.wayneshao.com/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%A4%B1%E8%B4%A5%E7%9A%84%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91%E4%B9%8B%E6%97%85/20190310124721318.png"></p>
<p>祭出 IDA ：<br><img data-src="https://qiniucdn.wayneshao.com/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%A4%B1%E8%B4%A5%E7%9A%84%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91%E4%B9%8B%E6%97%85/20190310125105181.png"></p>
<p>字符串窗口来看，控件逻辑果然是在 so 文件中，再看到处窗口：<br><img data-src="https://qiniucdn.wayneshao.com/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%A4%B1%E8%B4%A5%E7%9A%84%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91%E4%B9%8B%E6%97%85/20190310125231743.png"></p>
<p>只有两个校验失败的方法。。。</p>
<p>至此。。我大概意识到我的半吊子功夫是搞不定了，也意识到看似简单的界面，实则是作者早有防备。</p>
<p><img data-src="https://qiniucdn.wayneshao.com/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%A4%B1%E8%B4%A5%E7%9A%84%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91%E4%B9%8B%E6%97%85/20190310125514608.png"></p>
]]></content>
      <categories>
        <category>闹着玩儿</category>
      </categories>
      <tags>
        <tag>安卓</tag>
        <tag>逆向</tag>
        <tag>破解</tag>
        <tag>Ninebot</tag>
      </tags>
  </entry>
  <entry>
    <title>腾讯面试题：40 亿 QQ 号问题</title>
    <url>/posts/46319.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>这是一道来自前同事腾讯一面的面试题，题面如下：<br>有一个 Excel 文档，只有一个 Sheet，只有一列，这一列的内容是 QQ 号，一共 40 亿行。</p>
<ol>
<li>请问这个文档有多大？</li>
<li>如果是一个40亿行的 txt 文档呢？</li>
<li>请设计算法对 QQ 号码去重，相同的 QQ 号码仅保留一个，内存限制为 1G。<span id="more"></span></li>
</ol>
<h2 id="问题一"><a href="#问题一" class="headerlink" title="问题一"></a>问题一</h2><p>第一个问题其实是有坑的，Excel 是没办法存下这么大数据的，题面就是错的：<br>07 之前版本的 Excel 单 Sheet 最多可以有 65536 行，即 2^16<br>07 之后的版本单 Sheet 最多可以有 1048576 行，即 2^20<br><strong>40 亿行在最新版 Excel 下需要 3815 个 Sheet 才放得下。</strong></p>
<h2 id="问题二"><a href="#问题二" class="headerlink" title="问题二"></a>问题二</h2><p>第二个问题，如果是 txt 文档，那文件大小和编码有关，UTF8 和 ASCII 在内容只有数字的情况下占用是一致的，每个数字八位二进制，按照现在的 QQ 号长度，每个 QQ 号最长为 11 位，最低 5 位，那么，</p>
<p>如果是 <strong>LF</strong> 换行编码，则大小为<br>$(5+1) * 2 * 4,000,000,000 &lt;= x &lt;= (11 + 1) *  2 * 4,000,000,000$</p>
<p><strong>44.7 GB</strong> ~ <strong>89.4 GB</strong></p>
<p>如果是 <strong>CRLF</strong> 换行编码，则为<br>$(5+2) * 2 * 4,000,000,000 &lt;= x &lt;= (11 + 2) *  2 * 4,000,000,000$</p>
<p><strong>52.2 GB</strong> ~ <strong>96.9 GB</strong></p>
<h2 id="问题三"><a href="#问题三" class="headerlink" title="问题三"></a>问题三</h2><p>根据上个问题，这个文档最大为 100 GB 级别，限制内存为 1GB 的情况下，全部读取到内存再操作当然不可能实现，网传的正确的思路为使用 BitMap，参考这篇文章 <span class="exturl" data-url="aHR0cHM6Ly9tcC53ZWl4aW4ucXEuY29tL3MvMW8tTTN5MjZGZk1WQkdMM3FleWtrUQ==">腾讯三面：40 亿个 QQ 号码如何去重？<i class="fa fa-external-link-alt"></i></span>。BitMap 的确是最为妥当的方法，但是依然存在一些问题。</p>
<h3 id="字典？不行…"><a href="#字典？不行…" class="headerlink" title="字典？不行…"></a>字典？不行…</h3><p>$2^{32} -1 = 4,294,967,295$</p>
<p>$\frac{1GB}{4B} = 2^{30-2} = 2^{28} = 268,435,456$</p>
<p>根据第一个算式，如果采用&lt;uint32,bit&gt;字典标记，使用无符号32位数字作为 Key，那 QQ 号的范围只能 &lt;= 4,294,967,295 。<br>在这个情况下，根据第二个算式，先不考虑 value 的那一个 bit，光考虑 key，1GB 内存也只能存得下 268,435,456 个 key。<br>所以即使是使用 BitMap，在只有 1GB 内存的情况下，根据当前 QQ 的实际规格，也很难成立，故而只在内存中处理时，完全不够保存 key。</p>
<h3 id="BitMap？一样不够"><a href="#BitMap？一样不够" class="headerlink" title="BitMap？一样不够"></a>BitMap？一样不够</h3><p>$\frac{1GB}{1bit} = 2^{33} = 8,589,934,592$</p>
<p>既然存不下 key，那么就只能不对 key 做储存，直接用 BitMap，优点是极大的节省了内存，缺点也有，就是最终必然得对全部数据做一次遍历。<br>在这种情况下，整个 BitMap 作为一个大的 bit 数组，数组下标就是 key，最大能标记的 QQ 号就是数组的长度。<br>根据以上算式，1GB 内存完全用来储存字节数组，一共可以建立一个长度为 8,589,934,592 的数组，即使不考虑这个长度超过了uint32最大值的数组带来的额外问题，在当下最多 11 位 QQ 号的情况下，这个十位数依然是略有不足。</p>
<h1 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h1><p>目前看来，在符合实际QQ号规范且完全不做限制的情况下使用BitMap也大概率无法在1G内存下解决40亿QQ的去重问题。<br>猜测题面缺少一些条件，当然也有可能是故意这样以测试候选人的反应，合理的补充条件是，对 QQ 号的位数做限制。</p>
]]></content>
      <categories>
        <category>面试问题</category>
      </categories>
      <tags>
        <tag>面试题</tag>
      </tags>
  </entry>
  <entry>
    <title>.Net 讯飞语音识别Demo</title>
    <url>/posts/43271.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p><span class="exturl" data-url="aHR0cDovL3d3dy54Znl1bi5jbi9zZXJ2aWNlcy92b2ljZWRpY3RhdGlvbg==">讯飞语音识别<i class="fa fa-external-link-alt"></i></span>官方号称具有以下六个优势：</p>
<ol>
<li>超过95%的准确率</li>
<li>支持多种语种和方言</li>
<li>方便快捷的信息沟通</li>
<li>个性的语音识别</li>
<li>中文标点智能预测</li>
<li>支持垂直领域和应用级听写</li>
</ol>
<p><img data-src="https://qiniucdn.wayneshao.com/20180302113535116/20180302114420073.png"></p>
<span id="more"></span>
<h2 id="获得APPID和调用Dll"><a href="#获得APPID和调用Dll" class="headerlink" title="获得APPID和调用Dll"></a>获得APPID和调用Dll</h2><p>在讯飞开放平台的<span class="exturl" data-url="aHR0cDovL2NvbnNvbGUueGZ5dW4uY24vYXBwL215YXBw">控制台<i class="fa fa-external-link-alt"></i></span>新建一个应用，平台选择Windows，新建完成后为应用添加语音听写服务。<br><img data-src="https://qiniucdn.wayneshao.com/20180302113535116/20180302114712451.png"><br>下载SDK<br><img data-src="https://qiniucdn.wayneshao.com/20180302113535116/20180302114758665.png"></p>
<p>解压出你下载的压缩包bin目录中的msc.dll等待使用<br><img data-src="https://qiniucdn.wayneshao.com/20180302113535116/20180302114914214.png"><br><strong>注意：下面步骤里的Dll必须使用自行下载的版本，此Dll并不通用</strong></p>
<h2 id="Coding"><a href="#Coding" class="headerlink" title="Coding"></a>Coding</h2><h3 id="识别文件实现"><a href="#识别文件实现" class="headerlink" title="识别文件实现"></a>识别文件实现</h3><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 执行语音识别的异步方法</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;inFile&quot;&gt;</span>音频文件，pcm无文件头，采样率16k，数据16位，单声道<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;outFile&quot;&gt;</span>输出识别结果到文件<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Audio2TxtAsync</span>(<span class="params"><span class="built_in">string</span> inFile, <span class="built_in">string</span> outFile = <span class="literal">null</span></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> dlt = <span class="keyword">new</span> DltSpeek(Audio2Txt);</span><br><span class="line">    dlt.BeginInvoke(inFile, outFile, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 进行声音识别</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;inFile&quot;&gt;</span>音频文件，pcm无文件头，采样率16k，数据16位，单声道<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;outFile&quot;&gt;</span>输出识别结果到文件<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Audio2Txt</span>(<span class="params"><span class="built_in">string</span> inFile, <span class="built_in">string</span> outFile = <span class="literal">null</span></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> ret = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">var</span> result = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//模拟录音，输入音频</span></span><br><span class="line">        <span class="keyword">if</span> (!File.Exists(inFile)) <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;文件&quot;</span> + inFile + <span class="string">&quot;不存在！&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (inFile.Substring(inFile.Length - <span class="number">3</span>, <span class="number">3</span>).ToUpper() != <span class="string">&quot;WAV&quot;</span> &amp;&amp; inFile.Substring(inFile.Length - <span class="number">3</span>, <span class="number">3</span>).ToUpper() != <span class="string">&quot;PCM&quot;</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;音频文件格式不对！&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> fp = <span class="keyword">new</span> FileStream(inFile, FileMode.Open);</span><br><span class="line">        <span class="keyword">if</span> (inFile.Substring(inFile.Length - <span class="number">3</span>, <span class="number">3</span>).ToUpper() == <span class="string">&quot;WAV&quot;</span>) fp.Position = <span class="number">44</span>;</span><br><span class="line">        <span class="keyword">var</span> buff = <span class="keyword">new</span> <span class="built_in">byte</span>[BufferNum];</span><br><span class="line">        <span class="keyword">var</span> bp = Marshal.AllocHGlobal(BufferNum);</span><br><span class="line">        <span class="built_in">int</span> len;</span><br><span class="line">        <span class="keyword">var</span> status = AudioStatus.IsrAudioSampleContinue;</span><br><span class="line">        <span class="keyword">var</span> epStatus = EpStatus.IsrEpNull;</span><br><span class="line">        <span class="keyword">var</span> recStatus = RecogStatus.IsrRecNull;</span><br><span class="line">        <span class="keyword">var</span> rsltStatus = RecogStatus.IsrRecNull;</span><br><span class="line">        <span class="comment">//ep_status        端点检测（End-point detected）器所处的状态</span></span><br><span class="line">        <span class="comment">//rec_status       识别器所处的状态</span></span><br><span class="line">        <span class="comment">//rslt_status      识别器所处的状态</span></span><br><span class="line">        <span class="keyword">while</span> (fp.Position != fp.Length)</span><br><span class="line">        &#123;</span><br><span class="line">            len = fp.Read(buff, <span class="number">0</span>, BufferNum);</span><br><span class="line">            Marshal.Copy(buff, <span class="number">0</span>, bp, buff.Length);</span><br><span class="line">            <span class="comment">//开始向服务器发送音频数据</span></span><br><span class="line">            ret = AsrDll.QISRAudioWrite(_sessID, bp, (<span class="built_in">uint</span>)len, status, <span class="keyword">ref</span> epStatus, <span class="keyword">ref</span> recStatus);</span><br><span class="line">            <span class="keyword">if</span> (ret != <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                fp.Close();</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;QISRAudioWrite err,errCode=&quot;</span> + ((ErrorCode)ret).ToString(<span class="string">&quot;G&quot;</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//服务器返回部分结果</span></span><br><span class="line">            <span class="keyword">if</span> (recStatus == RecogStatus.IsrRecStatusSuccess)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> p = AsrDll.QISRGetResult(_sessID, <span class="keyword">ref</span> rsltStatus, WaitTime, <span class="keyword">ref</span> ret);</span><br><span class="line">                <span class="keyword">if</span> (p != IntPtr.Zero)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">var</span> tmp = FlyTts.Ptr2Str(p);</span><br><span class="line">                    DataArrived?.Invoke(<span class="keyword">this</span>, <span class="keyword">new</span> DataArrivedEventArgs(tmp));</span><br><span class="line">                    result += tmp;</span><br><span class="line">                    Console.WriteLine(<span class="string">@&quot;返回部分结果！:&quot;</span> + tmp);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            Thread.Sleep(<span class="number">500</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        fp.Close();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//最后一块数据</span></span><br><span class="line">        status = AudioStatus.IsrAudioSampleLast;</span><br><span class="line"></span><br><span class="line">        ret = AsrDll.QISRAudioWrite(_sessID, bp, <span class="number">1</span>, status, <span class="keyword">ref</span> epStatus, <span class="keyword">ref</span> recStatus);</span><br><span class="line">        <span class="keyword">if</span> (ret != <span class="number">0</span>) <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;QISRAudioWrite write last audio err,errCode=&quot;</span> + ((ErrorCode)ret).ToString(<span class="string">&quot;G&quot;</span>));</span><br><span class="line">        Marshal.FreeHGlobal(bp);</span><br><span class="line">        <span class="keyword">var</span> loopCount = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//最后一块数据发完之后，循环从服务器端获取结果</span></span><br><span class="line">        <span class="comment">//考虑到网络环境不好的情况下，需要对循环次数作限定</span></span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> p = AsrDll.QISRGetResult(_sessID, <span class="keyword">ref</span> rsltStatus, WaitTime, <span class="keyword">ref</span> ret);</span><br><span class="line">            <span class="keyword">if</span> (p != IntPtr.Zero)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> tmp = FlyTts.Ptr2Str(p);</span><br><span class="line">                DataArrived?.Invoke(<span class="keyword">this</span>, <span class="keyword">new</span> DataArrivedEventArgs(tmp)); <span class="comment">//激发识别数据到达事件</span></span><br><span class="line">                result += tmp;</span><br><span class="line">                Console.WriteLine(<span class="string">@&quot;传完音频后返回结果！:&quot;</span> + tmp);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (ret != <span class="number">0</span>) <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;QISRGetResult err,errCode=&quot;</span> + ((ErrorCode)ret).ToString(<span class="string">&quot;G&quot;</span>));</span><br><span class="line">            Thread.Sleep(<span class="number">200</span>);</span><br><span class="line">        &#125; <span class="keyword">while</span> (rsltStatus != RecogStatus.IsrRecStatusSpeechComplete &amp;&amp; loopCount++ &lt; <span class="number">30</span>);</span><br><span class="line">        <span class="keyword">if</span> (outFile != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> fout = <span class="keyword">new</span> FileStream(outFile, FileMode.OpenOrCreate);</span><br><span class="line">            fout.Write(Encoding.Default.GetBytes(result), <span class="number">0</span>, Encoding.Default.GetByteCount(result));</span><br><span class="line">            fout.Close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Exception ex)</span><br><span class="line">    &#123;</span><br><span class="line">        Console.WriteLine(ex.Message);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span></span><br><span class="line">    &#123;</span><br><span class="line">        ret = AsrDll.QISRSessionEnd(_sessID, <span class="built_in">string</span>.Empty);</span><br><span class="line">        ret = AsrDll.MSPLogout();</span><br><span class="line">        IsrEnd?.Invoke(<span class="keyword">this</span>, <span class="keyword">new</span> EventArgs()); <span class="comment">//通知识别结束</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="录音实现"><a href="#录音实现" class="headerlink" title="录音实现"></a>录音实现</h3><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">StartRecoding</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    WaveMonitor = <span class="keyword">new</span> WaveInEvent &#123; WaveFormat = <span class="keyword">new</span> WaveFormat(<span class="number">16000</span>, <span class="number">16</span>, <span class="number">1</span>) &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!Directory.Exists(<span class="string">&quot;temp&quot;</span>))</span><br><span class="line">        Directory.CreateDirectory(<span class="string">&quot;temp&quot;</span>);</span><br><span class="line">    _fileName = Path.Combine(<span class="string">&quot;temp&quot;</span>, Guid.NewGuid() + <span class="string">&quot;.wav&quot;</span>);</span><br><span class="line"></span><br><span class="line">    Writer = <span class="keyword">new</span> WaveFileWriter(_fileName, WaveMonitor.WaveFormat);</span><br><span class="line"></span><br><span class="line">    WaveMonitor.DataAvailable += (s, a) =&gt; Writer.Write(a.Buffer, <span class="number">0</span>, a.BytesRecorded);</span><br><span class="line">    WaveMonitor.RecordingStopped += (s, a) =&gt; &#123; Writer?.Dispose(); WaveMonitor?.Dispose(); &#125;;</span><br><span class="line"></span><br><span class="line">    WaveMonitor.StartRecording();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">StopRecoding</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    WaveMonitor.StopRecording();</span><br><span class="line">    Writer?.Close();</span><br><span class="line"></span><br><span class="line">    Audio2Txt(_fileName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="完整源码"><a href="#完整源码" class="headerlink" title="完整源码"></a>完整源码</h3><p>托管在<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL1dheW5lU2hhby9pRmx5RG90TmV0">GitHub<i class="fa fa-external-link-alt"></i></span></p>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>讯飞语音识别实测识别率其实并没有比百度好多少，准确率在服务提供商看来是越精确越好，但在实际应用中90%和95%差距并不大，故虽然讯飞看起来在数据上更好一些，但是API易用性实在比较差，还是更推荐百度一些。</p>
]]></content>
      <categories>
        <category>踩坑笔记</category>
      </categories>
      <tags>
        <tag>语音识别</tag>
        <tag>ASR</tag>
        <tag>TTS</tag>
        <tag>NAudio</tag>
      </tags>
  </entry>
  <entry>
    <title>阿铺工作经历总结及未来规划</title>
    <url>/posts/46318.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>2021 年 10 月 30 日 17 时 42 分，我签下了交接证明和离职证明，为我在深圳市阿铺科技有限公司 690 天的工作画上了句号。<br>如今距离离职已经两月有余，今日为这段经历做一个注脚。</p>
<span id="more"></span>
<h2 id="工作经历总结"><a href="#工作经历总结" class="headerlink" title="工作经历总结"></a>工作经历总结</h2><p>　　入职阿铺的时候差不多处于技术的一个转折点，按照腾飞的<span class="exturl" data-url="aHR0cHM6Ly9zaGltby5pbS9kb2NzL0hkZ1locERLdEhLeXQ5UjkvcmVhZA==">开发人员Level体系<i class="fa fa-external-link-alt"></i></span>，大约处于 L2 到 L3 的交界处，语言方面熟练 CRUD ，读过《CLR via C#》，做过一些 IL 方面和软件逆向的研究，有过一些比较业务层的开源代码贡献，熟悉各种常见的框架和工具的使用。<br><img data-src="https://qiniucdn.wayneshao.com/%E9%98%BF%E9%93%BA%E5%B7%A5%E4%BD%9C%E7%BB%8F%E5%8E%86%E6%80%BB%E7%BB%93/20220103110112431.png"><br>　　入职后领导对我颇为器重。<br>　　在技术方面，我在框架设计方面有了很大话语权，同时得益于领导对新技术的拥抱，得以主导引入各种开源框架和辅助工具，到我离职的时候，已经建成了代码规范明确、GitFlow清晰、DevOps便捷的整套开发体系。这期间我对 .NET Core 的源码有了一定的研究，DevOps 落地经验丰富，云原生方面的技术栈也有了一点实践，在这接近两年的时间，技术能力大约进阶到了L3和L4的交界处。<br><img data-src="https://qiniucdn.wayneshao.com/%E9%98%BF%E9%93%BA%E5%B7%A5%E4%BD%9C%E7%BB%8F%E5%8E%86%E6%80%BB%E7%BB%93/20220103114839617.png"><br>　　管理方面，2020 年 8 月被派遣驻扎在深圳主持深圳的招聘和项目开发工作，手下有六人的开发小团队，并于 2021 年 2 月 25日被任命为“增长项目组负责人”，统筹组织增长类项目的开发。<br><img data-src="https://qiniucdn.wayneshao.com/appointment.jpg"><br>　　2021 年 10 月底因为各种原因，最终选择离开阿铺科技。这接近两年的时间，很感激公司和作哥的信任，让我在完成了公司各项任务的同时也获得了个人能力长足进步。</p>
<h2 id="技术框架总结"><a href="#技术框架总结" class="headerlink" title="技术框架总结"></a>技术框架总结</h2><h3 id="现状"><a href="#现状" class="headerlink" title="现状"></a>现状</h3><p>　　阿铺使用的后端框架采用的是一套吸取了部分 DDD 思想的精简架构模型，，包含代码规范、框架和各种工具等已经封装为基础库，开箱即用，同时采用了开源项目管理常用的主维护人员 commit 贡献者 PR 的方式来维护。<br>　　部署发布方面使用 GitLab 构建了一套颇为清真的、Git 驱动的 DevOps 体系，结合 GitFlow 管理，做到各个环境的自动化发布和部署。后期已经尝试在测试环境引入 Kubernetes ，完美整合到了之前一直使用的流程中。</p>
<h3 id="待解决的问题"><a href="#待解决的问题" class="headerlink" title="待解决的问题"></a>待解决的问题</h3><h4 id="数据库版本管理"><a href="#数据库版本管理" class="headerlink" title="数据库版本管理"></a>数据库版本管理</h4><p>　　整套发布流程和 Git 整合到一起后，程序二进制文件可以方便的回到之前的某个提交版本，但是数据库版本却没有这种能力，而且介于数据的重要性，也很难信任自动化的操作，我的想法是倾向于严格审核 EFCore 的数据迁移操作的前提下，把数据库版本管理直接也和迁移代码的版本绑定在一起，通过迁移直接管理数据库版本。</p>
<h4 id="Kubernetes"><a href="#Kubernetes" class="headerlink" title="Kubernetes"></a>Kubernetes</h4><p>　　如何基于 Kubernetes 来发布程序其实早已实践成功，但是由于业务量不大，程序属于单体架构并未拆分微服务，基础设施需要的服务器暂时没办法满足等原因，一直没能将其运用到正式服务。<br>　　现状是正式服还是原始的 dotnet publish 发布加上 nginx 提供反向代理和负载均衡能力，测试服却已经精进到了直接发布到 Kubernetes。步子不适合一步迈得太大，考虑先把正式服上 Docker，然后再迁移到 Kubernetes。</p>
<h4 id="灰度环境"><a href="#灰度环境" class="headerlink" title="灰度环境"></a>灰度环境</h4><p>　　待解决的问题首先就是一直在考虑增加的灰度环境，对于到底是基于数据脱敏构建的仿真灰度环境，还是基于 A/B 测试的功能灰度环境到最后也没能决定到底选用哪一个，前者就是相当于多了一个仿真环境，数据为正式服务数据的脱敏数据。后者则是在功能上直接对不同用户开放不同版本的功能。</p>
<h4 id="代码风格统一问题"><a href="#代码风格统一问题" class="headerlink" title="代码风格统一问题"></a>代码风格统一问题</h4><p>　　拟使用 EditorConfig 解决。</p>
]]></content>
      <categories>
        <category>偶有所得</category>
      </categories>
      <tags>
        <tag>工作经历</tag>
        <tag>阿铺科技</tag>
      </tags>
  </entry>
  <entry>
    <title>【群友笔记】int[] 如何强转为 byte[]</title>
    <url>/posts/15145.html</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>今天群友提出了以下问题<br><img data-src="/images/20250102151052013/20250102034128988.png"></p>
<span id="more"></span>
<h2 id="直接强制转换为Span-lt-byte-gt-避免复制"><a href="#直接强制转换为Span-lt-byte-gt-避免复制" class="headerlink" title="直接强制转换为Span&lt;byte&gt;避免复制"></a>直接强制转换为<code>Span&lt;byte&gt;</code>避免复制</h2><p>在 C# 中，由于类型安全的设计，不能直接将 <code>int[]</code> 强制转换为 <code>byte[]</code>。即使在 <code>unsafe</code> 代码块中，<code>int[]</code> 和 <code>byte[]</code> 是不同的类型，内存布局也不同。<br>如果可以接受使用 <code>Span&lt;byte&gt;</code>，则可以直接强制转换避免复制。<br>因为是直接访问不复制，所以默认会是本机的字节序，不考虑大小端问题。<br>也可以再此基础上使用 <code>ToArray()</code> 方法，把<code>Span&lt;byte&gt;</code> 转为 <code>byte[]</code>（会有复制）。</p>
<p><strong>除非不用 <code>byte[]</code>，而是用 <code>Span&lt;byte&gt;</code></strong></p>
<h3 id="使用-MemoryMarshal-和-Span-lt-T-gt"><a href="#使用-MemoryMarshal-和-Span-lt-T-gt" class="headerlink" title="使用 MemoryMarshal 和 Span&lt;T&gt;"></a>使用 <code>MemoryMarshal</code> 和 <code>Span&lt;T&gt;</code></h3><p>使用 <code>MemoryMarshal.Cast&lt;TFrom, TTo&gt;</code> 方法，可以在不复制数据的情况下，将 <code>int[]</code> 转换为 <code>Span&lt;byte&gt;</code>，直接访问其底层字节。</p>
<p><strong>注意：</strong></p>
<ul>
<li>这种方法不复制数据，直接创建一个新的 <code>Span&lt;byte&gt;</code> 来表示原始数组的字节视图。</li>
<li>返回的是 <code>Span&lt;byte&gt;</code>，不能直接转换为 <code>byte[]</code>，但可以根据需要复制到 <code>byte[]</code> 中（直接调用.ToArray()方法）。</li>
</ul>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.InteropServices;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">IntArrayExtensions</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Span&lt;<span class="built_in">byte</span>&gt; <span class="title">AsByteSpan</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">int</span>[] intArray</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (intArray == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(intArray));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> MemoryMarshal.Cast&lt;<span class="built_in">int</span>, <span class="built_in">byte</span>&gt;(intArray);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="使用-unsafe-和指针"><a href="#使用-unsafe-和指针" class="headerlink" title="使用 unsafe 和指针"></a>使用 <code>unsafe</code> 和指针</h3><p>在 <code>unsafe</code> 代码块中，可以使用指针直接访问数组的内存：</p>
<p><strong>注意：</strong></p>
<ul>
<li>通过指针转换，直接获取 <code>int[]</code> 的字节视图。</li>
<li>需要在项目设置中启用不安全代码（Allow unsafe code）。<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">unsafe</span> Span&lt;<span class="built_in">byte</span>&gt; <span class="title">AsByteSpanUnsafe</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">int</span>[] intArray</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (intArray == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(intArray));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">fixed</span> (<span class="built_in">int</span>* pIntArray = intArray)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">byte</span>* pByteArray = (<span class="built_in">byte</span>*)pIntArray;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Span&lt;<span class="built_in">byte</span>&gt;(pByteArray, intArray.Length * <span class="keyword">sizeof</span>(<span class="built_in">int</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="复制为-byte"><a href="#复制为-byte" class="headerlink" title="复制为 byte[]"></a>复制为 <code>byte[]</code></h2><p>因为是复制，所以增加对于字节序的考虑</p>
<h3 id="使用-Buffer-BlockCopy"><a href="#使用-Buffer-BlockCopy" class="headerlink" title="使用 Buffer.BlockCopy"></a>使用 <code>Buffer.BlockCopy</code></h3><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">byte</span>[] <span class="title">ToByteArray</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">int</span>[] intArray, <span class="built_in">bool</span> asLittleEndian = <span class="literal">true</span></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (intArray == <span class="literal">null</span>)</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(intArray));</span><br><span class="line"></span><br><span class="line">	<span class="built_in">byte</span>[] byteArray = <span class="keyword">new</span> <span class="built_in">byte</span>[intArray.Length * <span class="keyword">sizeof</span>(<span class="built_in">int</span>)];</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (BitConverter.IsLittleEndian == asLittleEndian)</span><br><span class="line">	&#123;</span><br><span class="line">		Buffer.BlockCopy(intArray, <span class="number">0</span>, byteArray, <span class="number">0</span>, byteArray.Length);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; intArray.Length; i++)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">byte</span>[] bytes = BitConverter.GetBytes(intArray[i]);</span><br><span class="line">			Array.Reverse(bytes);</span><br><span class="line">			Buffer.BlockCopy(bytes, <span class="number">0</span>, byteArray, i * <span class="keyword">sizeof</span>(<span class="built_in">int</span>), <span class="keyword">sizeof</span>(<span class="built_in">int</span>));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> byteArray;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="使用Span"><a href="#使用Span" class="headerlink" title="使用Span"></a>使用<code>Span</code></h3><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">byte</span>[] <span class="title">ToByteArrayUseSpan</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">int</span>[] intArray, <span class="built_in">bool</span> asLittleEndian = <span class="literal">true</span></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (intArray == <span class="literal">null</span>)</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(intArray));</span><br><span class="line"></span><br><span class="line">	<span class="built_in">byte</span>[] byteArray = <span class="keyword">new</span> <span class="built_in">byte</span>[intArray.Length * <span class="keyword">sizeof</span>(<span class="built_in">int</span>)];</span><br><span class="line">	Span&lt;<span class="built_in">byte</span>&gt; byteSpan = byteArray.AsSpan();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; intArray.Length; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">int</span> <span class="keyword">value</span> = intArray[i];</span><br><span class="line">		<span class="built_in">int</span> offset = i * <span class="keyword">sizeof</span>(<span class="built_in">int</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (asLittleEndian)</span><br><span class="line">		&#123;</span><br><span class="line">			BinaryPrimitives.WriteInt32LittleEndian(byteSpan.Slice(offset, <span class="keyword">sizeof</span>(<span class="built_in">int</span>)), <span class="keyword">value</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			BinaryPrimitives.WriteInt32BigEndian(byteSpan.Slice(offset, <span class="keyword">sizeof</span>(<span class="built_in">int</span>)), <span class="keyword">value</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> byteArray;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="使用-unsafe"><a href="#使用-unsafe" class="headerlink" title="使用 unsafe"></a>使用 <code>unsafe</code></h3><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">unsafe</span> <span class="built_in">byte</span>[] <span class="title">ToByteArrayUnsafe</span>(<span class="params"><span class="keyword">this</span> <span class="built_in">int</span>[] intArray, <span class="built_in">bool</span> asLittleEndian = <span class="literal">true</span></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (intArray == <span class="literal">null</span>)</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(intArray));</span><br><span class="line"></span><br><span class="line">	<span class="built_in">int</span> length = intArray.Length * <span class="keyword">sizeof</span>(<span class="built_in">int</span>);</span><br><span class="line">	<span class="built_in">byte</span>[] byteArray = <span class="keyword">new</span> <span class="built_in">byte</span>[length];</span><br><span class="line"></span><br><span class="line">	<span class="keyword">fixed</span> (<span class="built_in">int</span>* pIntArray = intArray)</span><br><span class="line">	<span class="keyword">fixed</span> (<span class="built_in">byte</span>* pByteArray = byteArray)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">int</span>* pInt = pIntArray;</span><br><span class="line">		<span class="built_in">byte</span>* pByte = pByteArray;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; intArray.Length; i++, pInt++, pByte += <span class="keyword">sizeof</span>(<span class="built_in">int</span>))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">int</span> <span class="keyword">value</span> = *pInt;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 根据需要调整字节序</span></span><br><span class="line">			<span class="keyword">if</span> (BitConverter.IsLittleEndian != asLittleEndian)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">value</span> = SwapEndianness(<span class="keyword">value</span>);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 将值写入字节数组</span></span><br><span class="line">			*(<span class="built_in">int</span>*)pByte = <span class="keyword">value</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> byteArray;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 辅助方法：交换字节序</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">int</span> <span class="title">SwapEndianness</span>(<span class="params"><span class="built_in">int</span> <span class="keyword">value</span></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> ((<span class="keyword">value</span> &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0x000000FF</span>) |</span><br><span class="line">		   ((<span class="keyword">value</span> &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0x0000FF00</span>) |</span><br><span class="line">		   ((<span class="keyword">value</span> &lt;&lt; <span class="number">8</span>) &amp; <span class="number">0x00FF0000</span>) |</span><br><span class="line">		   ((<span class="keyword">value</span> &lt;&lt; <span class="number">24</span>) &amp; <span class="keyword">unchecked</span>((<span class="built_in">int</span>)<span class="number">0xFF000000</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>偶有所得</category>
      </categories>
      <tags>
        <tag>代码片段</tag>
      </tags>
  </entry>
</search>
